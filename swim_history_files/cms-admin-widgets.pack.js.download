
if (window && !window.__currentScriptPath) window.__currentScriptPath = null;


if (window) window.__currentScriptPath = "/framework/common/bluebird.min.js";

/* @preserve
 * The MIT License (MIT)
 * 
 * Copyright (c) 2013-2017 Petka Antonov
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 */
/**
 * bluebird build version 3.5.0
 * Features enabled: core, race, call_get, generators, map, nodeify, promisify, props, reduce, settle, some, using, timers, filter, any, each
*/
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.Promise=t()}}(function(){var t,e,n;return function r(t,e,n){function i(s,a){if(!e[s]){if(!t[s]){var c="function"==typeof _dereq_&&_dereq_;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var u=e[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return i(n?n:e)},u,u.exports,r,t,e,n)}return e[s].exports}for(var o="function"==typeof _dereq_&&_dereq_,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e,n){"use strict";e.exports=function(t){function e(t){var e=new n(t),r=e.promise();return e.setHowMany(1),e.setUnwrap(),e.init(),r}var n=t._SomePromiseArray;t.any=function(t){return e(t)},t.prototype.any=function(){return e(this)}}},{}],2:[function(t,e,n){"use strict";function r(){this._customScheduler=!1,this._isTickUsed=!1,this._lateQueue=new u(16),this._normalQueue=new u(16),this._haveDrainedQueues=!1,this._trampolineEnabled=!0;var t=this;this.drainQueues=function(){t._drainQueues()},this._schedule=l}function i(t,e,n){this._lateQueue.push(t,e,n),this._queueTick()}function o(t,e,n){this._normalQueue.push(t,e,n),this._queueTick()}function s(t){this._normalQueue._pushOne(t),this._queueTick()}var a;try{throw new Error}catch(c){a=c}var l=t("./schedule"),u=t("./queue"),p=t("./util");r.prototype.setScheduler=function(t){var e=this._schedule;return this._schedule=t,this._customScheduler=!0,e},r.prototype.hasCustomScheduler=function(){return this._customScheduler},r.prototype.enableTrampoline=function(){this._trampolineEnabled=!0},r.prototype.disableTrampolineIfNecessary=function(){p.hasDevTools&&(this._trampolineEnabled=!1)},r.prototype.haveItemsQueued=function(){return this._isTickUsed||this._haveDrainedQueues},r.prototype.fatalError=function(t,e){e?(process.stderr.write("Fatal "+(t instanceof Error?t.stack:t)+"\n"),process.exit(2)):this.throwLater(t)},r.prototype.throwLater=function(t,e){if(1===arguments.length&&(e=t,t=function(){throw e}),"undefined"!=typeof setTimeout)setTimeout(function(){t(e)},0);else try{this._schedule(function(){t(e)})}catch(n){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n")}},p.hasDevTools?(r.prototype.invokeLater=function(t,e,n){this._trampolineEnabled?i.call(this,t,e,n):this._schedule(function(){setTimeout(function(){t.call(e,n)},100)})},r.prototype.invoke=function(t,e,n){this._trampolineEnabled?o.call(this,t,e,n):this._schedule(function(){t.call(e,n)})},r.prototype.settlePromises=function(t){this._trampolineEnabled?s.call(this,t):this._schedule(function(){t._settlePromises()})}):(r.prototype.invokeLater=i,r.prototype.invoke=o,r.prototype.settlePromises=s),r.prototype._drainQueue=function(t){for(;t.length()>0;){var e=t.shift();if("function"==typeof e){var n=t.shift(),r=t.shift();e.call(n,r)}else e._settlePromises()}},r.prototype._drainQueues=function(){this._drainQueue(this._normalQueue),this._reset(),this._haveDrainedQueues=!0,this._drainQueue(this._lateQueue)},r.prototype._queueTick=function(){this._isTickUsed||(this._isTickUsed=!0,this._schedule(this.drainQueues))},r.prototype._reset=function(){this._isTickUsed=!1},e.exports=r,e.exports.firstLineError=a},{"./queue":26,"./schedule":29,"./util":36}],3:[function(t,e,n){"use strict";e.exports=function(t,e,n,r){var i=!1,o=function(t,e){this._reject(e)},s=function(t,e){e.promiseRejectionQueued=!0,e.bindingPromise._then(o,o,null,this,t)},a=function(t,e){0===(50397184&this._bitField)&&this._resolveCallback(e.target)},c=function(t,e){e.promiseRejectionQueued||this._reject(t)};t.prototype.bind=function(o){i||(i=!0,t.prototype._propagateFrom=r.propagateFromFunction(),t.prototype._boundValue=r.boundValueFunction());var l=n(o),u=new t(e);u._propagateFrom(this,1);var p=this._target();if(u._setBoundTo(l),l instanceof t){var h={promiseRejectionQueued:!1,promise:u,target:p,bindingPromise:l};p._then(e,s,void 0,u,h),l._then(a,c,void 0,u,h),u._setOnCancel(l)}else u._resolveCallback(p);return u},t.prototype._setBoundTo=function(t){void 0!==t?(this._bitField=2097152|this._bitField,this._boundTo=t):this._bitField=-2097153&this._bitField},t.prototype._isBound=function(){return 2097152===(2097152&this._bitField)},t.bind=function(e,n){return t.resolve(n).bind(e)}}},{}],4:[function(t,e,n){"use strict";function r(){try{Promise===o&&(Promise=i)}catch(t){}return o}var i;"undefined"!=typeof Promise&&(i=Promise);var o=t("./promise")();o.noConflict=r,e.exports=o},{"./promise":22}],5:[function(t,e,n){"use strict";var r=Object.create;if(r){var i=r(null),o=r(null);i[" size"]=o[" size"]=0}e.exports=function(e){function n(t,n){var r;if(null!=t&&(r=t[n]),"function"!=typeof r){var i="Object "+a.classString(t)+" has no method '"+a.toString(n)+"'";throw new e.TypeError(i)}return r}function r(t){var e=this.pop(),r=n(t,e);return r.apply(t,this)}function i(t){return t[this]}function o(t){var e=+this;return 0>e&&(e=Math.max(0,e+t.length)),t[e]}var s,a=t("./util"),c=a.canEvaluate;a.isIdentifier;e.prototype.call=function(t){var e=[].slice.call(arguments,1);return e.push(t),this._then(r,void 0,void 0,e,void 0)},e.prototype.get=function(t){var e,n="number"==typeof t;if(n)e=o;else if(c){var r=s(t);e=null!==r?r:i}else e=i;return this._then(e,void 0,void 0,t,void 0)}}},{"./util":36}],6:[function(t,e,n){"use strict";e.exports=function(e,n,r,i){var o=t("./util"),s=o.tryCatch,a=o.errorObj,c=e._async;e.prototype["break"]=e.prototype.cancel=function(){if(!i.cancellation())return this._warn("cancellation is disabled");for(var t=this,e=t;t._isCancellable();){if(!t._cancelBy(e)){e._isFollowing()?e._followee().cancel():e._cancelBranched();break}var n=t._cancellationParent;if(null==n||!n._isCancellable()){t._isFollowing()?t._followee().cancel():t._cancelBranched();break}t._isFollowing()&&t._followee().cancel(),t._setWillBeCancelled(),e=t,t=n}},e.prototype._branchHasCancelled=function(){this._branchesRemainingToCancel--},e.prototype._enoughBranchesHaveCancelled=function(){return void 0===this._branchesRemainingToCancel||this._branchesRemainingToCancel<=0},e.prototype._cancelBy=function(t){return t===this?(this._branchesRemainingToCancel=0,this._invokeOnCancel(),!0):(this._branchHasCancelled(),this._enoughBranchesHaveCancelled()?(this._invokeOnCancel(),!0):!1)},e.prototype._cancelBranched=function(){this._enoughBranchesHaveCancelled()&&this._cancel()},e.prototype._cancel=function(){this._isCancellable()&&(this._setCancelled(),c.invoke(this._cancelPromises,this,void 0))},e.prototype._cancelPromises=function(){this._length()>0&&this._settlePromises()},e.prototype._unsetOnCancel=function(){this._onCancelField=void 0},e.prototype._isCancellable=function(){return this.isPending()&&!this._isCancelled()},e.prototype.isCancellable=function(){return this.isPending()&&!this.isCancelled()},e.prototype._doInvokeOnCancel=function(t,e){if(o.isArray(t))for(var n=0;n<t.length;++n)this._doInvokeOnCancel(t[n],e);else if(void 0!==t)if("function"==typeof t){if(!e){var r=s(t).call(this._boundValue());r===a&&(this._attachExtraTrace(r.e),c.throwLater(r.e))}}else t._resultCancelled(this)},e.prototype._invokeOnCancel=function(){var t=this._onCancel();this._unsetOnCancel(),c.invoke(this._doInvokeOnCancel,this,t)},e.prototype._invokeInternalOnCancel=function(){this._isCancellable()&&(this._doInvokeOnCancel(this._onCancel(),!0),this._unsetOnCancel())},e.prototype._resultCancelled=function(){this.cancel()}}},{"./util":36}],7:[function(t,e,n){"use strict";e.exports=function(e){function n(t,n,a){return function(c){var l=a._boundValue();t:for(var u=0;u<t.length;++u){var p=t[u];if(p===Error||null!=p&&p.prototype instanceof Error){if(c instanceof p)return o(n).call(l,c)}else if("function"==typeof p){var h=o(p).call(l,c);if(h===s)return h;if(h)return o(n).call(l,c)}else if(r.isObject(c)){for(var f=i(p),_=0;_<f.length;++_){var d=f[_];if(p[d]!=c[d])continue t}return o(n).call(l,c)}}return e}}var r=t("./util"),i=t("./es5").keys,o=r.tryCatch,s=r.errorObj;return n}},{"./es5":13,"./util":36}],8:[function(t,e,n){"use strict";e.exports=function(t){function e(){this._trace=new e.CapturedTrace(r())}function n(){return i?new e:void 0}function r(){var t=o.length-1;return t>=0?o[t]:void 0}var i=!1,o=[];return t.prototype._promiseCreated=function(){},t.prototype._pushContext=function(){},t.prototype._popContext=function(){return null},t._peekContext=t.prototype._peekContext=function(){},e.prototype._pushContext=function(){void 0!==this._trace&&(this._trace._promiseCreated=null,o.push(this._trace))},e.prototype._popContext=function(){if(void 0!==this._trace){var t=o.pop(),e=t._promiseCreated;return t._promiseCreated=null,e}return null},e.CapturedTrace=null,e.create=n,e.deactivateLongStackTraces=function(){},e.activateLongStackTraces=function(){var n=t.prototype._pushContext,o=t.prototype._popContext,s=t._peekContext,a=t.prototype._peekContext,c=t.prototype._promiseCreated;e.deactivateLongStackTraces=function(){t.prototype._pushContext=n,t.prototype._popContext=o,t._peekContext=s,t.prototype._peekContext=a,t.prototype._promiseCreated=c,i=!1},i=!0,t.prototype._pushContext=e.prototype._pushContext,t.prototype._popContext=e.prototype._popContext,t._peekContext=t.prototype._peekContext=r,t.prototype._promiseCreated=function(){var t=this._peekContext();t&&null==t._promiseCreated&&(t._promiseCreated=this)}},e}},{}],9:[function(t,e,n){"use strict";e.exports=function(e,n){function r(t,e){return{promise:e}}function i(){return!1}function o(t,e,n){var r=this;try{t(e,n,function(t){if("function"!=typeof t)throw new TypeError("onCancel must be a function, got: "+H.toString(t));r._attachCancellationCallback(t)})}catch(i){return i}}function s(t){if(!this._isCancellable())return this;var e=this._onCancel();void 0!==e?H.isArray(e)?e.push(t):this._setOnCancel([e,t]):this._setOnCancel(t)}function a(){return this._onCancelField}function c(t){this._onCancelField=t}function l(){this._cancellationParent=void 0,this._onCancelField=void 0}function u(t,e){if(0!==(1&e)){this._cancellationParent=t;var n=t._branchesRemainingToCancel;void 0===n&&(n=0),t._branchesRemainingToCancel=n+1}0!==(2&e)&&t._isBound()&&this._setBoundTo(t._boundTo)}function p(t,e){0!==(2&e)&&t._isBound()&&this._setBoundTo(t._boundTo)}function h(){var t=this._boundTo;return void 0!==t&&t instanceof e?t.isFulfilled()?t.value():void 0:t}function f(){this._trace=new S(this._peekContext())}function _(t,e){if(N(t)){var n=this._trace;if(void 0!==n&&e&&(n=n._parent),void 0!==n)n.attachExtraTrace(t);else if(!t.__stackCleaned__){var r=j(t);H.notEnumerableProp(t,"stack",r.message+"\n"+r.stack.join("\n")),H.notEnumerableProp(t,"__stackCleaned__",!0)}}}function d(t,e,n,r,i){if(void 0===t&&null!==e&&W){if(void 0!==i&&i._returnedNonUndefined())return;if(0===(65535&r._bitField))return;n&&(n+=" ");var o="",s="";if(e._trace){for(var a=e._trace.stack.split("\n"),c=w(a),l=c.length-1;l>=0;--l){var u=c[l];if(!U.test(u)){var p=u.match(M);p&&(o="at "+p[1]+":"+p[2]+":"+p[3]+" ");break}}if(c.length>0)for(var h=c[0],l=0;l<a.length;++l)if(a[l]===h){l>0&&(s="\n"+a[l-1]);break}}var f="a promise was created in a "+n+"handler "+o+"but was not returned from it, see http://goo.gl/rRqMUw"+s;r._warn(f,!0,e)}}function v(t,e){var n=t+" is deprecated and will be removed in a future version.";return e&&(n+=" Use "+e+" instead."),y(n)}function y(t,n,r){if(ot.warnings){var i,o=new L(t);if(n)r._attachExtraTrace(o);else if(ot.longStackTraces&&(i=e._peekContext()))i.attachExtraTrace(o);else{var s=j(o);o.stack=s.message+"\n"+s.stack.join("\n")}tt("warning",o)||E(o,"",!0)}}function m(t,e){for(var n=0;n<e.length-1;++n)e[n].push("From previous event:"),e[n]=e[n].join("\n");return n<e.length&&(e[n]=e[n].join("\n")),t+"\n"+e.join("\n")}function g(t){for(var e=0;e<t.length;++e)(0===t[e].length||e+1<t.length&&t[e][0]===t[e+1][0])&&(t.splice(e,1),e--)}function b(t){for(var e=t[0],n=1;n<t.length;++n){for(var r=t[n],i=e.length-1,o=e[i],s=-1,a=r.length-1;a>=0;--a)if(r[a]===o){s=a;break}for(var a=s;a>=0;--a){var c=r[a];if(e[i]!==c)break;e.pop(),i--}e=r}}function w(t){for(var e=[],n=0;n<t.length;++n){var r=t[n],i="    (No stack trace)"===r||q.test(r),o=i&&nt(r);i&&!o&&($&&" "!==r.charAt(0)&&(r="    "+r),e.push(r))}return e}function C(t){for(var e=t.stack.replace(/\s+$/g,"").split("\n"),n=0;n<e.length;++n){var r=e[n];if("    (No stack trace)"===r||q.test(r))break}return n>0&&"SyntaxError"!=t.name&&(e=e.slice(n)),e}function j(t){var e=t.stack,n=t.toString();return e="string"==typeof e&&e.length>0?C(t):["    (No stack trace)"],{message:n,stack:"SyntaxError"==t.name?e:w(e)}}function E(t,e,n){if("undefined"!=typeof console){var r;if(H.isObject(t)){var i=t.stack;r=e+Q(i,t)}else r=e+String(t);"function"==typeof D?D(r,n):("function"==typeof console.log||"object"==typeof console.log)&&console.log(r)}}function k(t,e,n,r){var i=!1;try{"function"==typeof e&&(i=!0,"rejectionHandled"===t?e(r):e(n,r))}catch(o){I.throwLater(o)}"unhandledRejection"===t?tt(t,n,r)||i||E(n,"Unhandled rejection "):tt(t,r)}function F(t){var e;if("function"==typeof t)e="[function "+(t.name||"anonymous")+"]";else{e=t&&"function"==typeof t.toString?t.toString():H.toString(t);var n=/\[object [a-zA-Z0-9$_]+\]/;if(n.test(e))try{var r=JSON.stringify(t);e=r}catch(i){}0===e.length&&(e="(empty array)")}return"(<"+x(e)+">, no stack trace)"}function x(t){var e=41;return t.length<e?t:t.substr(0,e-3)+"..."}function T(){return"function"==typeof it}function P(t){var e=t.match(rt);return e?{fileName:e[1],line:parseInt(e[2],10)}:void 0}function R(t,e){if(T()){for(var n,r,i=t.stack.split("\n"),o=e.stack.split("\n"),s=-1,a=-1,c=0;c<i.length;++c){var l=P(i[c]);if(l){n=l.fileName,s=l.line;break}}for(var c=0;c<o.length;++c){var l=P(o[c]);if(l){r=l.fileName,a=l.line;break}}0>s||0>a||!n||!r||n!==r||s>=a||(nt=function(t){if(B.test(t))return!0;var e=P(t);return e&&e.fileName===n&&s<=e.line&&e.line<=a?!0:!1})}}function S(t){this._parent=t,this._promisesCreated=0;var e=this._length=1+(void 0===t?0:t._length);it(this,S),e>32&&this.uncycle()}var O,A,D,V=e._getDomain,I=e._async,L=t("./errors").Warning,H=t("./util"),N=H.canAttachTrace,B=/[\\\/]bluebird[\\\/]js[\\\/](release|debug|instrumented)/,U=/\((?:timers\.js):\d+:\d+\)/,M=/[\/<\(](.+?):(\d+):(\d+)\)?\s*$/,q=null,Q=null,$=!1,G=!(0==H.env("BLUEBIRD_DEBUG")||!H.env("BLUEBIRD_DEBUG")&&"development"!==H.env("NODE_ENV")),z=!(0==H.env("BLUEBIRD_WARNINGS")||!G&&!H.env("BLUEBIRD_WARNINGS")),X=!(0==H.env("BLUEBIRD_LONG_STACK_TRACES")||!G&&!H.env("BLUEBIRD_LONG_STACK_TRACES")),W=0!=H.env("BLUEBIRD_W_FORGOTTEN_RETURN")&&(z||!!H.env("BLUEBIRD_W_FORGOTTEN_RETURN"));e.prototype.suppressUnhandledRejections=function(){var t=this._target();t._bitField=-1048577&t._bitField|524288},e.prototype._ensurePossibleRejectionHandled=function(){0===(524288&this._bitField)&&(this._setRejectionIsUnhandled(),I.invokeLater(this._notifyUnhandledRejection,this,void 0))},e.prototype._notifyUnhandledRejectionIsHandled=function(){k("rejectionHandled",O,void 0,this)},e.prototype._setReturnedNonUndefined=function(){this._bitField=268435456|this._bitField},e.prototype._returnedNonUndefined=function(){return 0!==(268435456&this._bitField)},e.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var t=this._settledValue();this._setUnhandledRejectionIsNotified(),k("unhandledRejection",A,t,this)}},e.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=262144|this._bitField},e.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=-262145&this._bitField},e.prototype._isUnhandledRejectionNotified=function(){return(262144&this._bitField)>0},e.prototype._setRejectionIsUnhandled=function(){this._bitField=1048576|this._bitField},e.prototype._unsetRejectionIsUnhandled=function(){this._bitField=-1048577&this._bitField,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},e.prototype._isRejectionUnhandled=function(){return(1048576&this._bitField)>0},e.prototype._warn=function(t,e,n){return y(t,e,n||this)},e.onPossiblyUnhandledRejection=function(t){var e=V();A="function"==typeof t?null===e?t:H.domainBind(e,t):void 0},e.onUnhandledRejectionHandled=function(t){var e=V();O="function"==typeof t?null===e?t:H.domainBind(e,t):void 0};var K=function(){};e.longStackTraces=function(){if(I.haveItemsQueued()&&!ot.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");if(!ot.longStackTraces&&T()){var t=e.prototype._captureStackTrace,r=e.prototype._attachExtraTrace;ot.longStackTraces=!0,K=function(){if(I.haveItemsQueued()&&!ot.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");e.prototype._captureStackTrace=t,e.prototype._attachExtraTrace=r,n.deactivateLongStackTraces(),I.enableTrampoline(),ot.longStackTraces=!1},e.prototype._captureStackTrace=f,e.prototype._attachExtraTrace=_,n.activateLongStackTraces(),I.disableTrampolineIfNecessary()}},e.hasLongStackTraces=function(){return ot.longStackTraces&&T()};var J=function(){try{if("function"==typeof CustomEvent){var t=new CustomEvent("CustomEvent");return H.global.dispatchEvent(t),function(t,e){var n=new CustomEvent(t.toLowerCase(),{detail:e,cancelable:!0});return!H.global.dispatchEvent(n)}}if("function"==typeof Event){var t=new Event("CustomEvent");return H.global.dispatchEvent(t),function(t,e){var n=new Event(t.toLowerCase(),{cancelable:!0});return n.detail=e,!H.global.dispatchEvent(n)}}var t=document.createEvent("CustomEvent");return t.initCustomEvent("testingtheevent",!1,!0,{}),H.global.dispatchEvent(t),function(t,e){var n=document.createEvent("CustomEvent");return n.initCustomEvent(t.toLowerCase(),!1,!0,e),!H.global.dispatchEvent(n)}}catch(e){}return function(){return!1}}(),Y=function(){return H.isNode?function(){return process.emit.apply(process,arguments)}:H.global?function(t){var e="on"+t.toLowerCase(),n=H.global[e];return n?(n.apply(H.global,[].slice.call(arguments,1)),!0):!1}:function(){return!1}}(),Z={promiseCreated:r,promiseFulfilled:r,promiseRejected:r,promiseResolved:r,promiseCancelled:r,promiseChained:function(t,e,n){return{promise:e,child:n}},warning:function(t,e){return{warning:e}},unhandledRejection:function(t,e,n){return{reason:e,promise:n}},rejectionHandled:r},tt=function(t){var e=!1;try{e=Y.apply(null,arguments)}catch(n){I.throwLater(n),e=!0}var r=!1;try{r=J(t,Z[t].apply(null,arguments))}catch(n){I.throwLater(n),r=!0}return r||e};e.config=function(t){if(t=Object(t),"longStackTraces"in t&&(t.longStackTraces?e.longStackTraces():!t.longStackTraces&&e.hasLongStackTraces()&&K()),"warnings"in t){var n=t.warnings;ot.warnings=!!n,W=ot.warnings,H.isObject(n)&&"wForgottenReturn"in n&&(W=!!n.wForgottenReturn)}if("cancellation"in t&&t.cancellation&&!ot.cancellation){if(I.haveItemsQueued())throw new Error("cannot enable cancellation after promises are in use");e.prototype._clearCancellationData=l,e.prototype._propagateFrom=u,e.prototype._onCancel=a,e.prototype._setOnCancel=c,e.prototype._attachCancellationCallback=s,e.prototype._execute=o,et=u,ot.cancellation=!0}return"monitoring"in t&&(t.monitoring&&!ot.monitoring?(ot.monitoring=!0,e.prototype._fireEvent=tt):!t.monitoring&&ot.monitoring&&(ot.monitoring=!1,e.prototype._fireEvent=i)),e},e.prototype._fireEvent=i,e.prototype._execute=function(t,e,n){try{t(e,n)}catch(r){return r}},e.prototype._onCancel=function(){},e.prototype._setOnCancel=function(t){},e.prototype._attachCancellationCallback=function(t){},e.prototype._captureStackTrace=function(){},e.prototype._attachExtraTrace=function(){},e.prototype._clearCancellationData=function(){},e.prototype._propagateFrom=function(t,e){};var et=p,nt=function(){return!1},rt=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;H.inherits(S,Error),n.CapturedTrace=S,S.prototype.uncycle=function(){var t=this._length;if(!(2>t)){for(var e=[],n={},r=0,i=this;void 0!==i;++r)e.push(i),i=i._parent;t=this._length=r;for(var r=t-1;r>=0;--r){var o=e[r].stack;void 0===n[o]&&(n[o]=r)}for(var r=0;t>r;++r){var s=e[r].stack,a=n[s];if(void 0!==a&&a!==r){a>0&&(e[a-1]._parent=void 0,e[a-1]._length=1),e[r]._parent=void 0,e[r]._length=1;var c=r>0?e[r-1]:this;t-1>a?(c._parent=e[a+1],c._parent.uncycle(),c._length=c._parent._length+1):(c._parent=void 0,c._length=1);for(var l=c._length+1,u=r-2;u>=0;--u)e[u]._length=l,l++;return}}}},S.prototype.attachExtraTrace=function(t){if(!t.__stackCleaned__){this.uncycle();for(var e=j(t),n=e.message,r=[e.stack],i=this;void 0!==i;)r.push(w(i.stack.split("\n"))),i=i._parent;b(r),g(r),H.notEnumerableProp(t,"stack",m(n,r)),H.notEnumerableProp(t,"__stackCleaned__",!0)}};var it=function(){var t=/^\s*at\s*/,e=function(t,e){return"string"==typeof t?t:void 0!==e.name&&void 0!==e.message?e.toString():F(e)};if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){Error.stackTraceLimit+=6,q=t,Q=e;var n=Error.captureStackTrace;return nt=function(t){return B.test(t)},function(t,e){Error.stackTraceLimit+=6,n(t,e),Error.stackTraceLimit-=6}}var r=new Error;if("string"==typeof r.stack&&r.stack.split("\n")[0].indexOf("stackDetection@")>=0)return q=/@/,Q=e,$=!0,function(t){t.stack=(new Error).stack};var i;try{throw new Error}catch(o){i="stack"in o}return"stack"in r||!i||"number"!=typeof Error.stackTraceLimit?(Q=function(t,e){return"string"==typeof t?t:"object"!=typeof e&&"function"!=typeof e||void 0===e.name||void 0===e.message?F(e):e.toString()},null):(q=t,Q=e,function(t){Error.stackTraceLimit+=6;try{throw new Error}catch(e){t.stack=e.stack}Error.stackTraceLimit-=6})}([]);"undefined"!=typeof console&&"undefined"!=typeof console.warn&&(D=function(t){console.warn(t)},H.isNode&&process.stderr.isTTY?D=function(t,e){var n=e?"[33m":"[31m";console.warn(n+t+"[0m\n")}:H.isNode||"string"!=typeof(new Error).stack||(D=function(t,e){console.warn("%c"+t,e?"color: darkorange":"color: red")}));var ot={warnings:z,longStackTraces:!1,cancellation:!1,monitoring:!1};return X&&e.longStackTraces(),{longStackTraces:function(){return ot.longStackTraces},warnings:function(){return ot.warnings},cancellation:function(){return ot.cancellation},monitoring:function(){return ot.monitoring},propagateFromFunction:function(){return et},boundValueFunction:function(){return h},checkForgottenReturns:d,setBounds:R,warn:y,deprecated:v,CapturedTrace:S,fireDomEvent:J,fireGlobalEvent:Y}}},{"./errors":12,"./util":36}],10:[function(t,e,n){"use strict";e.exports=function(t){function e(){return this.value}function n(){throw this.reason}t.prototype["return"]=t.prototype.thenReturn=function(n){return n instanceof t&&n.suppressUnhandledRejections(),this._then(e,void 0,void 0,{value:n},void 0)},t.prototype["throw"]=t.prototype.thenThrow=function(t){return this._then(n,void 0,void 0,{reason:t},void 0)},t.prototype.catchThrow=function(t){if(arguments.length<=1)return this._then(void 0,n,void 0,{reason:t},void 0);var e=arguments[1],r=function(){throw e};return this.caught(t,r)},t.prototype.catchReturn=function(n){if(arguments.length<=1)return n instanceof t&&n.suppressUnhandledRejections(),this._then(void 0,e,void 0,{value:n},void 0);var r=arguments[1];r instanceof t&&r.suppressUnhandledRejections();var i=function(){return r};return this.caught(n,i)}}},{}],11:[function(t,e,n){"use strict";e.exports=function(t,e){function n(){return o(this)}function r(t,n){return i(t,n,e,e)}var i=t.reduce,o=t.all;t.prototype.each=function(t){return i(this,t,e,0)._then(n,void 0,void 0,this,void 0)},t.prototype.mapSeries=function(t){return i(this,t,e,e)},t.each=function(t,r){return i(t,r,e,0)._then(n,void 0,void 0,t,void 0)},t.mapSeries=r}},{}],12:[function(t,e,n){"use strict";function r(t,e){function n(r){return this instanceof n?(p(this,"message","string"==typeof r?r:e),p(this,"name",t),void(Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):Error.call(this))):new n(r)}return u(n,Error),n}function i(t){return this instanceof i?(p(this,"name","OperationalError"),p(this,"message",t),this.cause=t,this.isOperational=!0,void(t instanceof Error?(p(this,"message",t.message),p(this,"stack",t.stack)):Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor))):new i(t)}var o,s,a=t("./es5"),c=a.freeze,l=t("./util"),u=l.inherits,p=l.notEnumerableProp,h=r("Warning","warning"),f=r("CancellationError","cancellation error"),_=r("TimeoutError","timeout error"),d=r("AggregateError","aggregate error");try{o=TypeError,s=RangeError}catch(v){o=r("TypeError","type error"),s=r("RangeError","range error")}for(var y="join pop push shift unshift slice filter forEach some every map indexOf lastIndexOf reduce reduceRight sort reverse".split(" "),m=0;m<y.length;++m)"function"==typeof Array.prototype[y[m]]&&(d.prototype[y[m]]=Array.prototype[y[m]]);a.defineProperty(d.prototype,"length",{value:0,configurable:!1,writable:!0,enumerable:!0}),d.prototype.isOperational=!0;var g=0;d.prototype.toString=function(){var t=Array(4*g+1).join(" "),e="\n"+t+"AggregateError of:\n";g++,t=Array(4*g+1).join(" ");for(var n=0;n<this.length;++n){for(var r=this[n]===this?"[Circular AggregateError]":this[n]+"",i=r.split("\n"),o=0;o<i.length;++o)i[o]=t+i[o];r=i.join("\n"),e+=r+"\n"}return g--,e},u(i,Error);var b=Error.__BluebirdErrorTypes__;b||(b=c({CancellationError:f,TimeoutError:_,OperationalError:i,RejectionError:i,AggregateError:d}),a.defineProperty(Error,"__BluebirdErrorTypes__",{value:b,writable:!1,enumerable:!1,configurable:!1})),e.exports={Error:Error,TypeError:o,RangeError:s,CancellationError:b.CancellationError,OperationalError:b.OperationalError,TimeoutError:b.TimeoutError,AggregateError:b.AggregateError,Warning:h}},{"./es5":13,"./util":36}],13:[function(t,e,n){var r=function(){"use strict";return void 0===this}();if(r)e.exports={freeze:Object.freeze,defineProperty:Object.defineProperty,getDescriptor:Object.getOwnPropertyDescriptor,keys:Object.keys,names:Object.getOwnPropertyNames,getPrototypeOf:Object.getPrototypeOf,isArray:Array.isArray,isES5:r,propertyIsWritable:function(t,e){var n=Object.getOwnPropertyDescriptor(t,e);return!(n&&!n.writable&&!n.set)}};else{var i={}.hasOwnProperty,o={}.toString,s={}.constructor.prototype,a=function(t){var e=[];for(var n in t)i.call(t,n)&&e.push(n);return e},c=function(t,e){return{value:t[e]}},l=function(t,e,n){return t[e]=n.value,t},u=function(t){return t},p=function(t){try{return Object(t).constructor.prototype}catch(e){return s}},h=function(t){try{return"[object Array]"===o.call(t)}catch(e){return!1}};e.exports={isArray:h,keys:a,names:a,defineProperty:l,getDescriptor:c,freeze:u,getPrototypeOf:p,isES5:r,propertyIsWritable:function(){return!0}}}},{}],14:[function(t,e,n){"use strict";e.exports=function(t,e){var n=t.map;t.prototype.filter=function(t,r){return n(this,t,r,e)},t.filter=function(t,r,i){return n(t,r,i,e)}}},{}],15:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t,e,n){this.promise=t,this.type=e,this.handler=n,this.called=!1,this.cancelPromise=null}function o(t){this.finallyHandler=t}function s(t,e){return null!=t.cancelPromise?(arguments.length>1?t.cancelPromise._reject(e):t.cancelPromise._cancel(),t.cancelPromise=null,!0):!1}function a(){return l.call(this,this.promise._target()._settledValue())}function c(t){return s(this,t)?void 0:(h.e=t,h)}function l(t){var i=this.promise,l=this.handler;if(!this.called){this.called=!0;var u=this.isFinallyHandler()?l.call(i._boundValue()):l.call(i._boundValue(),t);if(u===r)return u;if(void 0!==u){i._setReturnedNonUndefined();var f=n(u,i);if(f instanceof e){if(null!=this.cancelPromise){if(f._isCancelled()){var _=new p("late cancellation observer");return i._attachExtraTrace(_),h.e=_,h}f.isPending()&&f._attachCancellationCallback(new o(this))}return f._then(a,c,void 0,this,void 0)}}}return i.isRejected()?(s(this),h.e=t,h):(s(this),t)}var u=t("./util"),p=e.CancellationError,h=u.errorObj,f=t("./catch_filter")(r);return i.prototype.isFinallyHandler=function(){return 0===this.type},o.prototype._resultCancelled=function(){s(this.finallyHandler)},e.prototype._passThrough=function(t,e,n,r){return"function"!=typeof t?this.then():this._then(n,r,void 0,new i(this,e,t),void 0)},e.prototype.lastly=e.prototype["finally"]=function(t){return this._passThrough(t,0,l,l)},e.prototype.tap=function(t){return this._passThrough(t,1,l)},e.prototype.tapCatch=function(t){var n=arguments.length;if(1===n)return this._passThrough(t,1,void 0,l);var r,i=new Array(n-1),o=0;for(r=0;n-1>r;++r){var s=arguments[r];if(!u.isObject(s))return e.reject(new TypeError("tapCatch statement predicate: expecting an object but got "+u.classString(s)));i[o++]=s}i.length=o;var a=arguments[r];return this._passThrough(f(i,a,this),1,void 0,l)},i}},{"./catch_filter":7,"./util":36}],16:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t,n,r){for(var o=0;o<n.length;++o){r._pushContext();var s=f(n[o])(t);if(r._popContext(),s===h){r._pushContext();var a=e.reject(h.e);return r._popContext(),a}var c=i(s,r);if(c instanceof e)return c}return null}function c(t,n,i,o){if(s.cancellation()){var a=new e(r),c=this._finallyPromise=new e(r);this._promise=a.lastly(function(){return c}),a._captureStackTrace(),a._setOnCancel(this)}else{var l=this._promise=new e(r);l._captureStackTrace()}this._stack=o,this._generatorFunction=t,this._receiver=n,this._generator=void 0,this._yieldHandlers="function"==typeof i?[i].concat(_):_,this._yieldedPromise=null,this._cancellationPhase=!1}var l=t("./errors"),u=l.TypeError,p=t("./util"),h=p.errorObj,f=p.tryCatch,_=[];p.inherits(c,o),c.prototype._isResolved=function(){return null===this._promise},c.prototype._cleanup=function(){this._promise=this._generator=null,s.cancellation()&&null!==this._finallyPromise&&(this._finallyPromise._fulfill(),this._finallyPromise=null)},c.prototype._promiseCancelled=function(){if(!this._isResolved()){var t,n="undefined"!=typeof this._generator["return"];if(n)this._promise._pushContext(),t=f(this._generator["return"]).call(this._generator,void 0),this._promise._popContext();else{var r=new e.CancellationError("generator .return() sentinel");e.coroutine.returnSentinel=r,this._promise._attachExtraTrace(r),this._promise._pushContext(),t=f(this._generator["throw"]).call(this._generator,r),this._promise._popContext()}this._cancellationPhase=!0,this._yieldedPromise=null,this._continue(t)}},c.prototype._promiseFulfilled=function(t){this._yieldedPromise=null,this._promise._pushContext();var e=f(this._generator.next).call(this._generator,t);this._promise._popContext(),this._continue(e)},c.prototype._promiseRejected=function(t){this._yieldedPromise=null,this._promise._attachExtraTrace(t),this._promise._pushContext();var e=f(this._generator["throw"]).call(this._generator,t);this._promise._popContext(),this._continue(e)},c.prototype._resultCancelled=function(){if(this._yieldedPromise instanceof e){var t=this._yieldedPromise;this._yieldedPromise=null,t.cancel()}},c.prototype.promise=function(){return this._promise},c.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver),this._receiver=this._generatorFunction=void 0,this._promiseFulfilled(void 0)},c.prototype._continue=function(t){var n=this._promise;if(t===h)return this._cleanup(),this._cancellationPhase?n.cancel():n._rejectCallback(t.e,!1);var r=t.value;if(t.done===!0)return this._cleanup(),this._cancellationPhase?n.cancel():n._resolveCallback(r);var o=i(r,this._promise);if(!(o instanceof e)&&(o=a(o,this._yieldHandlers,this._promise),null===o))return void this._promiseRejected(new u("A value %s was yielded that could not be treated as a promise\n\n    See http://goo.gl/MqrFmX\n\n".replace("%s",String(r))+"From coroutine:\n"+this._stack.split("\n").slice(1,-7).join("\n")));o=o._target();var s=o._bitField;0===(50397184&s)?(this._yieldedPromise=o,o._proxy(this,null)):0!==(33554432&s)?e._async.invoke(this._promiseFulfilled,this,o._value()):0!==(16777216&s)?e._async.invoke(this._promiseRejected,this,o._reason()):this._promiseCancelled();
},e.coroutine=function(t,e){if("function"!=typeof t)throw new u("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var n=Object(e).yieldHandler,r=c,i=(new Error).stack;return function(){var e=t.apply(this,arguments),o=new r(void 0,void 0,n,i),s=o.promise();return o._generator=e,o._promiseFulfilled(void 0),s}},e.coroutine.addYieldHandler=function(t){if("function"!=typeof t)throw new u("expecting a function but got "+p.classString(t));_.push(t)},e.spawn=function(t){if(s.deprecated("Promise.spawn()","Promise.coroutine()"),"function"!=typeof t)return n("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var r=new c(t,this),i=r.promise();return r._run(e.spawn),i}}},{"./errors":12,"./util":36}],17:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){var a=t("./util");a.canEvaluate,a.tryCatch,a.errorObj;e.join=function(){var t,e=arguments.length-1;if(e>0&&"function"==typeof arguments[e]){t=arguments[e];var r}var i=[].slice.call(arguments);t&&i.pop();var r=new n(i).promise();return void 0!==t?r.spread(t):r}}},{"./util":36}],18:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t,e,n,r){this.constructor$(t),this._promise._captureStackTrace();var i=l();this._callback=null===i?e:u.domainBind(i,e),this._preservedValues=r===o?new Array(this.length()):null,this._limit=n,this._inFlight=0,this._queue=[],f.invoke(this._asyncInit,this,void 0)}function c(t,n,i,o){if("function"!=typeof n)return r("expecting a function but got "+u.classString(n));var s=0;if(void 0!==i){if("object"!=typeof i||null===i)return e.reject(new TypeError("options argument must be an object but it is "+u.classString(i)));if("number"!=typeof i.concurrency)return e.reject(new TypeError("'concurrency' must be a number but it is "+u.classString(i.concurrency)));s=i.concurrency}return s="number"==typeof s&&isFinite(s)&&s>=1?s:0,new a(t,n,s,o).promise()}var l=e._getDomain,u=t("./util"),p=u.tryCatch,h=u.errorObj,f=e._async;u.inherits(a,n),a.prototype._asyncInit=function(){this._init$(void 0,-2)},a.prototype._init=function(){},a.prototype._promiseFulfilled=function(t,n){var r=this._values,o=this.length(),a=this._preservedValues,c=this._limit;if(0>n){if(n=-1*n-1,r[n]=t,c>=1&&(this._inFlight--,this._drainQueue(),this._isResolved()))return!0}else{if(c>=1&&this._inFlight>=c)return r[n]=t,this._queue.push(n),!1;null!==a&&(a[n]=t);var l=this._promise,u=this._callback,f=l._boundValue();l._pushContext();var _=p(u).call(f,t,n,o),d=l._popContext();if(s.checkForgottenReturns(_,d,null!==a?"Promise.filter":"Promise.map",l),_===h)return this._reject(_.e),!0;var v=i(_,this._promise);if(v instanceof e){v=v._target();var y=v._bitField;if(0===(50397184&y))return c>=1&&this._inFlight++,r[n]=v,v._proxy(this,-1*(n+1)),!1;if(0===(33554432&y))return 0!==(16777216&y)?(this._reject(v._reason()),!0):(this._cancel(),!0);_=v._value()}r[n]=_}var m=++this._totalResolved;return m>=o?(null!==a?this._filter(r,a):this._resolve(r),!0):!1},a.prototype._drainQueue=function(){for(var t=this._queue,e=this._limit,n=this._values;t.length>0&&this._inFlight<e;){if(this._isResolved())return;var r=t.pop();this._promiseFulfilled(n[r],r)}},a.prototype._filter=function(t,e){for(var n=e.length,r=new Array(n),i=0,o=0;n>o;++o)t[o]&&(r[i++]=e[o]);r.length=i,this._resolve(r)},a.prototype.preservedValues=function(){return this._preservedValues},e.prototype.map=function(t,e){return c(this,t,e,null)},e.map=function(t,e,n,r){return c(t,e,n,r)}}},{"./util":36}],19:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o){var s=t("./util"),a=s.tryCatch;e.method=function(t){if("function"!=typeof t)throw new e.TypeError("expecting a function but got "+s.classString(t));return function(){var r=new e(n);r._captureStackTrace(),r._pushContext();var i=a(t).apply(this,arguments),s=r._popContext();return o.checkForgottenReturns(i,s,"Promise.method",r),r._resolveFromSyncValue(i),r}},e.attempt=e["try"]=function(t){if("function"!=typeof t)return i("expecting a function but got "+s.classString(t));var r=new e(n);r._captureStackTrace(),r._pushContext();var c;if(arguments.length>1){o.deprecated("calling Promise.try with more than 1 argument");var l=arguments[1],u=arguments[2];c=s.isArray(l)?a(t).apply(u,l):a(t).call(u,l)}else c=a(t)();var p=r._popContext();return o.checkForgottenReturns(c,p,"Promise.try",r),r._resolveFromSyncValue(c),r},e.prototype._resolveFromSyncValue=function(t){t===s.errorObj?this._rejectCallback(t.e,!1):this._resolveCallback(t,!0)}}},{"./util":36}],20:[function(t,e,n){"use strict";function r(t){return t instanceof Error&&u.getPrototypeOf(t)===Error.prototype}function i(t){var e;if(r(t)){e=new l(t),e.name=t.name,e.message=t.message,e.stack=t.stack;for(var n=u.keys(t),i=0;i<n.length;++i){var o=n[i];p.test(o)||(e[o]=t[o])}return e}return s.markAsOriginatingFromRejection(t),t}function o(t,e){return function(n,r){if(null!==t){if(n){var o=i(a(n));t._attachExtraTrace(o),t._reject(o)}else if(e){var s=[].slice.call(arguments,1);t._fulfill(s)}else t._fulfill(r);t=null}}}var s=t("./util"),a=s.maybeWrapAsError,c=t("./errors"),l=c.OperationalError,u=t("./es5"),p=/^(?:name|message|stack|cause)$/;e.exports=o},{"./errors":12,"./es5":13,"./util":36}],21:[function(t,e,n){"use strict";e.exports=function(e){function n(t,e){var n=this;if(!o.isArray(t))return r.call(n,t,e);var i=a(e).apply(n._boundValue(),[null].concat(t));i===c&&s.throwLater(i.e)}function r(t,e){var n=this,r=n._boundValue(),i=void 0===t?a(e).call(r,null):a(e).call(r,null,t);i===c&&s.throwLater(i.e)}function i(t,e){var n=this;if(!t){var r=new Error(t+"");r.cause=t,t=r}var i=a(e).call(n._boundValue(),t);i===c&&s.throwLater(i.e)}var o=t("./util"),s=e._async,a=o.tryCatch,c=o.errorObj;e.prototype.asCallback=e.prototype.nodeify=function(t,e){if("function"==typeof t){var o=r;void 0!==e&&Object(e).spread&&(o=n),this._then(o,i,void 0,this,t)}return this}}},{"./util":36}],22:[function(t,e,n){"use strict";e.exports=function(){function n(){}function r(t,e){if(null==t||t.constructor!==i)throw new m("the promise constructor cannot be invoked directly\n\n    See http://goo.gl/MqrFmX\n");if("function"!=typeof e)throw new m("expecting a function but got "+f.classString(e))}function i(t){t!==b&&r(this,t),this._bitField=0,this._fulfillmentHandler0=void 0,this._rejectionHandler0=void 0,this._promise0=void 0,this._receiver0=void 0,this._resolveFromExecutor(t),this._promiseCreated(),this._fireEvent("promiseCreated",this)}function o(t){this.promise._resolveCallback(t)}function s(t){this.promise._rejectCallback(t,!1)}function a(t){var e=new i(b);e._fulfillmentHandler0=t,e._rejectionHandler0=t,e._promise0=t,e._receiver0=t}var c,l=function(){return new m("circular promise resolution chain\n\n    See http://goo.gl/MqrFmX\n")},u=function(){return new i.PromiseInspection(this._target())},p=function(t){return i.reject(new m(t))},h={},f=t("./util");c=f.isNode?function(){var t=process.domain;return void 0===t&&(t=null),t}:function(){return null},f.notEnumerableProp(i,"_getDomain",c);var _=t("./es5"),d=t("./async"),v=new d;_.defineProperty(i,"_async",{value:v});var y=t("./errors"),m=i.TypeError=y.TypeError;i.RangeError=y.RangeError;var g=i.CancellationError=y.CancellationError;i.TimeoutError=y.TimeoutError,i.OperationalError=y.OperationalError,i.RejectionError=y.OperationalError,i.AggregateError=y.AggregateError;var b=function(){},w={},C={},j=t("./thenables")(i,b),E=t("./promise_array")(i,b,j,p,n),k=t("./context")(i),F=k.create,x=t("./debuggability")(i,k),T=(x.CapturedTrace,t("./finally")(i,j,C)),P=t("./catch_filter")(C),R=t("./nodeback"),S=f.errorObj,O=f.tryCatch;return i.prototype.toString=function(){return"[object Promise]"},i.prototype.caught=i.prototype["catch"]=function(t){var e=arguments.length;if(e>1){var n,r=new Array(e-1),i=0;for(n=0;e-1>n;++n){var o=arguments[n];if(!f.isObject(o))return p("Catch statement predicate: expecting an object but got "+f.classString(o));r[i++]=o}return r.length=i,t=arguments[n],this.then(void 0,P(r,t,this))}return this.then(void 0,t)},i.prototype.reflect=function(){return this._then(u,u,void 0,this,void 0)},i.prototype.then=function(t,e){if(x.warnings()&&arguments.length>0&&"function"!=typeof t&&"function"!=typeof e){var n=".then() only accepts functions but was passed: "+f.classString(t);arguments.length>1&&(n+=", "+f.classString(e)),this._warn(n)}return this._then(t,e,void 0,void 0,void 0)},i.prototype.done=function(t,e){var n=this._then(t,e,void 0,void 0,void 0);n._setIsFinal()},i.prototype.spread=function(t){return"function"!=typeof t?p("expecting a function but got "+f.classString(t)):this.all()._then(t,void 0,void 0,w,void 0)},i.prototype.toJSON=function(){var t={isFulfilled:!1,isRejected:!1,fulfillmentValue:void 0,rejectionReason:void 0};return this.isFulfilled()?(t.fulfillmentValue=this.value(),t.isFulfilled=!0):this.isRejected()&&(t.rejectionReason=this.reason(),t.isRejected=!0),t},i.prototype.all=function(){return arguments.length>0&&this._warn(".all() was passed arguments but it does not take any"),new E(this).promise()},i.prototype.error=function(t){return this.caught(f.originatesFromRejection,t)},i.getNewLibraryCopy=e.exports,i.is=function(t){return t instanceof i},i.fromNode=i.fromCallback=function(t){var e=new i(b);e._captureStackTrace();var n=arguments.length>1?!!Object(arguments[1]).multiArgs:!1,r=O(t)(R(e,n));return r===S&&e._rejectCallback(r.e,!0),e._isFateSealed()||e._setAsyncGuaranteed(),e},i.all=function(t){return new E(t).promise()},i.cast=function(t){var e=j(t);return e instanceof i||(e=new i(b),e._captureStackTrace(),e._setFulfilled(),e._rejectionHandler0=t),e},i.resolve=i.fulfilled=i.cast,i.reject=i.rejected=function(t){var e=new i(b);return e._captureStackTrace(),e._rejectCallback(t,!0),e},i.setScheduler=function(t){if("function"!=typeof t)throw new m("expecting a function but got "+f.classString(t));return v.setScheduler(t)},i.prototype._then=function(t,e,n,r,o){var s=void 0!==o,a=s?o:new i(b),l=this._target(),u=l._bitField;s||(a._propagateFrom(this,3),a._captureStackTrace(),void 0===r&&0!==(2097152&this._bitField)&&(r=0!==(50397184&u)?this._boundValue():l===this?void 0:this._boundTo),this._fireEvent("promiseChained",this,a));var p=c();if(0!==(50397184&u)){var h,_,d=l._settlePromiseCtx;0!==(33554432&u)?(_=l._rejectionHandler0,h=t):0!==(16777216&u)?(_=l._fulfillmentHandler0,h=e,l._unsetRejectionIsUnhandled()):(d=l._settlePromiseLateCancellationObserver,_=new g("late cancellation observer"),l._attachExtraTrace(_),h=e),v.invoke(d,l,{handler:null===p?h:"function"==typeof h&&f.domainBind(p,h),promise:a,receiver:r,value:_})}else l._addCallbacks(t,e,a,r,p);return a},i.prototype._length=function(){return 65535&this._bitField},i.prototype._isFateSealed=function(){return 0!==(117506048&this._bitField)},i.prototype._isFollowing=function(){return 67108864===(67108864&this._bitField)},i.prototype._setLength=function(t){this._bitField=-65536&this._bitField|65535&t},i.prototype._setFulfilled=function(){this._bitField=33554432|this._bitField,this._fireEvent("promiseFulfilled",this)},i.prototype._setRejected=function(){this._bitField=16777216|this._bitField,this._fireEvent("promiseRejected",this)},i.prototype._setFollowing=function(){this._bitField=67108864|this._bitField,this._fireEvent("promiseResolved",this)},i.prototype._setIsFinal=function(){this._bitField=4194304|this._bitField},i.prototype._isFinal=function(){return(4194304&this._bitField)>0},i.prototype._unsetCancelled=function(){this._bitField=-65537&this._bitField},i.prototype._setCancelled=function(){this._bitField=65536|this._bitField,this._fireEvent("promiseCancelled",this)},i.prototype._setWillBeCancelled=function(){this._bitField=8388608|this._bitField},i.prototype._setAsyncGuaranteed=function(){v.hasCustomScheduler()||(this._bitField=134217728|this._bitField)},i.prototype._receiverAt=function(t){var e=0===t?this._receiver0:this[4*t-4+3];return e===h?void 0:void 0===e&&this._isBound()?this._boundValue():e},i.prototype._promiseAt=function(t){return this[4*t-4+2]},i.prototype._fulfillmentHandlerAt=function(t){return this[4*t-4+0]},i.prototype._rejectionHandlerAt=function(t){return this[4*t-4+1]},i.prototype._boundValue=function(){},i.prototype._migrateCallback0=function(t){var e=(t._bitField,t._fulfillmentHandler0),n=t._rejectionHandler0,r=t._promise0,i=t._receiverAt(0);void 0===i&&(i=h),this._addCallbacks(e,n,r,i,null)},i.prototype._migrateCallbackAt=function(t,e){var n=t._fulfillmentHandlerAt(e),r=t._rejectionHandlerAt(e),i=t._promiseAt(e),o=t._receiverAt(e);void 0===o&&(o=h),this._addCallbacks(n,r,i,o,null)},i.prototype._addCallbacks=function(t,e,n,r,i){var o=this._length();if(o>=65531&&(o=0,this._setLength(0)),0===o)this._promise0=n,this._receiver0=r,"function"==typeof t&&(this._fulfillmentHandler0=null===i?t:f.domainBind(i,t)),"function"==typeof e&&(this._rejectionHandler0=null===i?e:f.domainBind(i,e));else{var s=4*o-4;this[s+2]=n,this[s+3]=r,"function"==typeof t&&(this[s+0]=null===i?t:f.domainBind(i,t)),"function"==typeof e&&(this[s+1]=null===i?e:f.domainBind(i,e))}return this._setLength(o+1),o},i.prototype._proxy=function(t,e){this._addCallbacks(void 0,void 0,e,t,null)},i.prototype._resolveCallback=function(t,e){if(0===(117506048&this._bitField)){if(t===this)return this._rejectCallback(l(),!1);var n=j(t,this);if(!(n instanceof i))return this._fulfill(t);e&&this._propagateFrom(n,2);var r=n._target();if(r===this)return void this._reject(l());var o=r._bitField;if(0===(50397184&o)){var s=this._length();s>0&&r._migrateCallback0(this);for(var a=1;s>a;++a)r._migrateCallbackAt(this,a);this._setFollowing(),this._setLength(0),this._setFollowee(r)}else if(0!==(33554432&o))this._fulfill(r._value());else if(0!==(16777216&o))this._reject(r._reason());else{var c=new g("late cancellation observer");r._attachExtraTrace(c),this._reject(c)}}},i.prototype._rejectCallback=function(t,e,n){var r=f.ensureErrorObject(t),i=r===t;if(!i&&!n&&x.warnings()){var o="a promise was rejected with a non-error: "+f.classString(t);this._warn(o,!0)}this._attachExtraTrace(r,e?i:!1),this._reject(t)},i.prototype._resolveFromExecutor=function(t){if(t!==b){var e=this;this._captureStackTrace(),this._pushContext();var n=!0,r=this._execute(t,function(t){e._resolveCallback(t)},function(t){e._rejectCallback(t,n)});n=!1,this._popContext(),void 0!==r&&e._rejectCallback(r,!0)}},i.prototype._settlePromiseFromHandler=function(t,e,n,r){var i=r._bitField;if(0===(65536&i)){r._pushContext();var o;e===w?n&&"number"==typeof n.length?o=O(t).apply(this._boundValue(),n):(o=S,o.e=new m("cannot .spread() a non-array: "+f.classString(n))):o=O(t).call(e,n);var s=r._popContext();i=r._bitField,0===(65536&i)&&(o===C?r._reject(n):o===S?r._rejectCallback(o.e,!1):(x.checkForgottenReturns(o,s,"",r,this),r._resolveCallback(o)))}},i.prototype._target=function(){for(var t=this;t._isFollowing();)t=t._followee();return t},i.prototype._followee=function(){return this._rejectionHandler0},i.prototype._setFollowee=function(t){this._rejectionHandler0=t},i.prototype._settlePromise=function(t,e,r,o){var s=t instanceof i,a=this._bitField,c=0!==(134217728&a);0!==(65536&a)?(s&&t._invokeInternalOnCancel(),r instanceof T&&r.isFinallyHandler()?(r.cancelPromise=t,O(e).call(r,o)===S&&t._reject(S.e)):e===u?t._fulfill(u.call(r)):r instanceof n?r._promiseCancelled(t):s||t instanceof E?t._cancel():r.cancel()):"function"==typeof e?s?(c&&t._setAsyncGuaranteed(),this._settlePromiseFromHandler(e,r,o,t)):e.call(r,o,t):r instanceof n?r._isResolved()||(0!==(33554432&a)?r._promiseFulfilled(o,t):r._promiseRejected(o,t)):s&&(c&&t._setAsyncGuaranteed(),0!==(33554432&a)?t._fulfill(o):t._reject(o))},i.prototype._settlePromiseLateCancellationObserver=function(t){var e=t.handler,n=t.promise,r=t.receiver,o=t.value;"function"==typeof e?n instanceof i?this._settlePromiseFromHandler(e,r,o,n):e.call(r,o,n):n instanceof i&&n._reject(o)},i.prototype._settlePromiseCtx=function(t){this._settlePromise(t.promise,t.handler,t.receiver,t.value)},i.prototype._settlePromise0=function(t,e,n){var r=this._promise0,i=this._receiverAt(0);this._promise0=void 0,this._receiver0=void 0,this._settlePromise(r,t,i,e)},i.prototype._clearCallbackDataAtIndex=function(t){var e=4*t-4;this[e+2]=this[e+3]=this[e+0]=this[e+1]=void 0},i.prototype._fulfill=function(t){var e=this._bitField;if(!((117506048&e)>>>16)){if(t===this){var n=l();return this._attachExtraTrace(n),this._reject(n)}this._setFulfilled(),this._rejectionHandler0=t,(65535&e)>0&&(0!==(134217728&e)?this._settlePromises():v.settlePromises(this))}},i.prototype._reject=function(t){var e=this._bitField;if(!((117506048&e)>>>16))return this._setRejected(),this._fulfillmentHandler0=t,this._isFinal()?v.fatalError(t,f.isNode):void((65535&e)>0?v.settlePromises(this):this._ensurePossibleRejectionHandled())},i.prototype._fulfillPromises=function(t,e){for(var n=1;t>n;n++){var r=this._fulfillmentHandlerAt(n),i=this._promiseAt(n),o=this._receiverAt(n);this._clearCallbackDataAtIndex(n),this._settlePromise(i,r,o,e)}},i.prototype._rejectPromises=function(t,e){for(var n=1;t>n;n++){var r=this._rejectionHandlerAt(n),i=this._promiseAt(n),o=this._receiverAt(n);this._clearCallbackDataAtIndex(n),this._settlePromise(i,r,o,e)}},i.prototype._settlePromises=function(){var t=this._bitField,e=65535&t;if(e>0){if(0!==(16842752&t)){var n=this._fulfillmentHandler0;this._settlePromise0(this._rejectionHandler0,n,t),this._rejectPromises(e,n)}else{var r=this._rejectionHandler0;this._settlePromise0(this._fulfillmentHandler0,r,t),this._fulfillPromises(e,r)}this._setLength(0)}this._clearCancellationData()},i.prototype._settledValue=function(){var t=this._bitField;return 0!==(33554432&t)?this._rejectionHandler0:0!==(16777216&t)?this._fulfillmentHandler0:void 0},i.defer=i.pending=function(){x.deprecated("Promise.defer","new Promise");var t=new i(b);return{promise:t,resolve:o,reject:s}},f.notEnumerableProp(i,"_makeSelfResolutionError",l),t("./method")(i,b,j,p,x),t("./bind")(i,b,j,x),t("./cancel")(i,E,p,x),t("./direct_resolve")(i),t("./synchronous_inspection")(i),t("./join")(i,E,j,b,v,c),i.Promise=i,i.version="3.5.0",t("./map.js")(i,E,p,j,b,x),t("./call_get.js")(i),t("./using.js")(i,p,j,F,b,x),t("./timers.js")(i,b,x),t("./generators.js")(i,p,b,j,n,x),t("./nodeify.js")(i),t("./promisify.js")(i,b),t("./props.js")(i,E,j,p),t("./race.js")(i,b,j,p),t("./reduce.js")(i,E,p,j,b,x),t("./settle.js")(i,E,x),t("./some.js")(i,E,p),t("./filter.js")(i,b),t("./each.js")(i,b),t("./any.js")(i),f.toFastProperties(i),f.toFastProperties(i.prototype),a({a:1}),a({b:2}),a({c:3}),a(1),a(function(){}),a(void 0),a(!1),a(new i(b)),x.setBounds(d.firstLineError,f.lastLineError),i}},{"./any.js":1,"./async":2,"./bind":3,"./call_get.js":5,"./cancel":6,"./catch_filter":7,"./context":8,"./debuggability":9,"./direct_resolve":10,"./each.js":11,"./errors":12,"./es5":13,"./filter.js":14,"./finally":15,"./generators.js":16,"./join":17,"./map.js":18,"./method":19,"./nodeback":20,"./nodeify.js":21,"./promise_array":23,"./promisify.js":24,"./props.js":25,"./race.js":27,"./reduce.js":28,"./settle.js":30,"./some.js":31,"./synchronous_inspection":32,"./thenables":33,"./timers.js":34,"./using.js":35,"./util":36}],23:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o){function s(t){switch(t){case-2:return[];case-3:return{};case-6:return new Map}}function a(t){var r=this._promise=new e(n);t instanceof e&&r._propagateFrom(t,3),r._setOnCancel(this),this._values=t,this._length=0,this._totalResolved=0,this._init(void 0,-2)}var c=t("./util");c.isArray;return c.inherits(a,o),a.prototype.length=function(){return this._length},a.prototype.promise=function(){return this._promise},a.prototype._init=function l(t,n){var o=r(this._values,this._promise);if(o instanceof e){o=o._target();var a=o._bitField;if(this._values=o,0===(50397184&a))return this._promise._setAsyncGuaranteed(),o._then(l,this._reject,void 0,this,n);if(0===(33554432&a))return 0!==(16777216&a)?this._reject(o._reason()):this._cancel();o=o._value()}if(o=c.asArray(o),null===o){var u=i("expecting an array or an iterable object but got "+c.classString(o)).reason();return void this._promise._rejectCallback(u,!1)}return 0===o.length?void(-5===n?this._resolveEmptyArray():this._resolve(s(n))):void this._iterate(o)},a.prototype._iterate=function(t){var n=this.getActualLength(t.length);this._length=n,this._values=this.shouldCopyValues()?new Array(n):this._values;for(var i=this._promise,o=!1,s=null,a=0;n>a;++a){var c=r(t[a],i);c instanceof e?(c=c._target(),s=c._bitField):s=null,o?null!==s&&c.suppressUnhandledRejections():null!==s?0===(50397184&s)?(c._proxy(this,a),this._values[a]=c):o=0!==(33554432&s)?this._promiseFulfilled(c._value(),a):0!==(16777216&s)?this._promiseRejected(c._reason(),a):this._promiseCancelled(a):o=this._promiseFulfilled(c,a)}o||i._setAsyncGuaranteed()},a.prototype._isResolved=function(){return null===this._values},a.prototype._resolve=function(t){this._values=null,this._promise._fulfill(t)},a.prototype._cancel=function(){!this._isResolved()&&this._promise._isCancellable()&&(this._values=null,this._promise._cancel())},a.prototype._reject=function(t){this._values=null,this._promise._rejectCallback(t,!1)},a.prototype._promiseFulfilled=function(t,e){this._values[e]=t;var n=++this._totalResolved;return n>=this._length?(this._resolve(this._values),!0):!1},a.prototype._promiseCancelled=function(){return this._cancel(),!0},a.prototype._promiseRejected=function(t){return this._totalResolved++,this._reject(t),!0},a.prototype._resultCancelled=function(){if(!this._isResolved()){var t=this._values;if(this._cancel(),t instanceof e)t.cancel();else for(var n=0;n<t.length;++n)t[n]instanceof e&&t[n].cancel()}},a.prototype.shouldCopyValues=function(){return!0},a.prototype.getActualLength=function(t){return t},a}},{"./util":36}],24:[function(t,e,n){"use strict";e.exports=function(e,n){function r(t){return!C.test(t)}function i(t){try{return t.__isPromisified__===!0}catch(e){return!1}}function o(t,e,n){var r=f.getDataPropertyOrDefault(t,e+n,b);return r?i(r):!1}function s(t,e,n){for(var r=0;r<t.length;r+=2){var i=t[r];if(n.test(i))for(var o=i.replace(n,""),s=0;s<t.length;s+=2)if(t[s]===o)throw new m("Cannot promisify an API that has normal methods with '%s'-suffix\n\n    See http://goo.gl/MqrFmX\n".replace("%s",e))}}function a(t,e,n,r){for(var a=f.inheritedDataKeys(t),c=[],l=0;l<a.length;++l){var u=a[l],p=t[u],h=r===j?!0:j(u,p,t);"function"!=typeof p||i(p)||o(t,u,e)||!r(u,p,t,h)||c.push(u,p)}return s(c,e,n),c}function c(t,r,i,o,s,a){function c(){var i=r;r===h&&(i=this);var o=new e(n);o._captureStackTrace();var s="string"==typeof u&&this!==l?this[u]:t,c=_(o,a);try{s.apply(i,d(arguments,c))}catch(p){o._rejectCallback(v(p),!0,!0)}return o._isFateSealed()||o._setAsyncGuaranteed(),o}var l=function(){return this}(),u=t;return"string"==typeof u&&(t=o),f.notEnumerableProp(c,"__isPromisified__",!0),c}function l(t,e,n,r,i){for(var o=new RegExp(E(e)+"$"),s=a(t,e,o,n),c=0,l=s.length;l>c;c+=2){var u=s[c],p=s[c+1],_=u+e;if(r===k)t[_]=k(u,h,u,p,e,i);else{var d=r(p,function(){return k(u,h,u,p,e,i)});f.notEnumerableProp(d,"__isPromisified__",!0),t[_]=d}}return f.toFastProperties(t),t}function u(t,e,n){return k(t,e,void 0,t,null,n)}var p,h={},f=t("./util"),_=t("./nodeback"),d=f.withAppended,v=f.maybeWrapAsError,y=f.canEvaluate,m=t("./errors").TypeError,g="Async",b={__isPromisified__:!0},w=["arity","length","name","arguments","caller","callee","prototype","__isPromisified__"],C=new RegExp("^(?:"+w.join("|")+")$"),j=function(t){return f.isIdentifier(t)&&"_"!==t.charAt(0)&&"constructor"!==t},E=function(t){return t.replace(/([$])/,"\\$")},k=y?p:c;e.promisify=function(t,e){if("function"!=typeof t)throw new m("expecting a function but got "+f.classString(t));if(i(t))return t;e=Object(e);var n=void 0===e.context?h:e.context,o=!!e.multiArgs,s=u(t,n,o);return f.copyDescriptors(t,s,r),s},e.promisifyAll=function(t,e){if("function"!=typeof t&&"object"!=typeof t)throw new m("the target of promisifyAll must be an object or a function\n\n    See http://goo.gl/MqrFmX\n");e=Object(e);var n=!!e.multiArgs,r=e.suffix;"string"!=typeof r&&(r=g);var i=e.filter;"function"!=typeof i&&(i=j);var o=e.promisifier;if("function"!=typeof o&&(o=k),!f.isIdentifier(r))throw new RangeError("suffix must be a valid identifier\n\n    See http://goo.gl/MqrFmX\n");for(var s=f.inheritedDataKeys(t),a=0;a<s.length;++a){var c=t[s[a]];"constructor"!==s[a]&&f.isClass(c)&&(l(c.prototype,r,i,o,n),l(c,r,i,o,n))}return l(t,r,i,o,n)}}},{"./errors":12,"./nodeback":20,"./util":36}],25:[function(t,e,n){"use strict";e.exports=function(e,n,r,i){function o(t){var e,n=!1;if(void 0!==a&&t instanceof a)e=p(t),n=!0;else{var r=u.keys(t),i=r.length;e=new Array(2*i);for(var o=0;i>o;++o){var s=r[o];e[o]=t[s],e[o+i]=s}}this.constructor$(e),this._isMap=n,this._init$(void 0,n?-6:-3)}function s(t){var n,s=r(t);return l(s)?(n=s instanceof e?s._then(e.props,void 0,void 0,void 0,void 0):new o(s).promise(),s instanceof e&&n._propagateFrom(s,2),n):i("cannot await properties of a non-object\n\n    See http://goo.gl/MqrFmX\n")}var a,c=t("./util"),l=c.isObject,u=t("./es5");"function"==typeof Map&&(a=Map);var p=function(){function t(t,r){this[e]=t,this[e+n]=r,e++}var e=0,n=0;return function(r){n=r.size,e=0;var i=new Array(2*r.size);return r.forEach(t,i),i}}(),h=function(t){for(var e=new a,n=t.length/2|0,r=0;n>r;++r){var i=t[n+r],o=t[r];e.set(i,o)}return e};c.inherits(o,n),o.prototype._init=function(){},o.prototype._promiseFulfilled=function(t,e){this._values[e]=t;var n=++this._totalResolved;if(n>=this._length){var r;if(this._isMap)r=h(this._values);else{r={};for(var i=this.length(),o=0,s=this.length();s>o;++o)r[this._values[o+i]]=this._values[o]}return this._resolve(r),!0}return!1},o.prototype.shouldCopyValues=function(){return!1},o.prototype.getActualLength=function(t){return t>>1},e.prototype.props=function(){return s(this)},e.props=function(t){return s(t)}}},{"./es5":13,"./util":36}],26:[function(t,e,n){"use strict";function r(t,e,n,r,i){for(var o=0;i>o;++o)n[o+r]=t[o+e],t[o+e]=void 0}function i(t){this._capacity=t,this._length=0,this._front=0}i.prototype._willBeOverCapacity=function(t){return this._capacity<t},i.prototype._pushOne=function(t){var e=this.length();this._checkCapacity(e+1);var n=this._front+e&this._capacity-1;this[n]=t,this._length=e+1},i.prototype.push=function(t,e,n){var r=this.length()+3;if(this._willBeOverCapacity(r))return this._pushOne(t),this._pushOne(e),void this._pushOne(n);var i=this._front+r-3;this._checkCapacity(r);var o=this._capacity-1;this[i+0&o]=t,this[i+1&o]=e,this[i+2&o]=n,this._length=r},i.prototype.shift=function(){var t=this._front,e=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length--,e},i.prototype.length=function(){return this._length},i.prototype._checkCapacity=function(t){this._capacity<t&&this._resizeTo(this._capacity<<1)},i.prototype._resizeTo=function(t){var e=this._capacity;this._capacity=t;var n=this._front,i=this._length,o=n+i&e-1;r(this,0,this,e,o)},e.exports=i},{}],27:[function(t,e,n){"use strict";e.exports=function(e,n,r,i){function o(t,o){var c=r(t);if(c instanceof e)return a(c);if(t=s.asArray(t),null===t)return i("expecting an array or an iterable object but got "+s.classString(t));var l=new e(n);void 0!==o&&l._propagateFrom(o,3);for(var u=l._fulfill,p=l._reject,h=0,f=t.length;f>h;++h){var _=t[h];(void 0!==_||h in t)&&e.cast(_)._then(u,p,void 0,l,null)}return l}var s=t("./util"),a=function(t){return t.then(function(e){return o(e,t)})};e.race=function(t){return o(t,void 0)},e.prototype.race=function(){return o(this,void 0)}}},{"./util":36}],28:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t,n,r,i){this.constructor$(t);var s=h();this._fn=null===s?n:f.domainBind(s,n),void 0!==r&&(r=e.resolve(r),r._attachCancellationCallback(this)),this._initialValue=r,this._currentCancellable=null,i===o?this._eachValues=Array(this._length):0===i?this._eachValues=null:this._eachValues=void 0,this._promise._captureStackTrace(),this._init$(void 0,-5)}function c(t,e){this.isFulfilled()?e._resolve(t):e._reject(t)}function l(t,e,n,i){if("function"!=typeof e)return r("expecting a function but got "+f.classString(e));var o=new a(t,e,n,i);return o.promise()}function u(t){this.accum=t,this.array._gotAccum(t);var n=i(this.value,this.array._promise);return n instanceof e?(this.array._currentCancellable=n,n._then(p,void 0,void 0,this,void 0)):p.call(this,n)}function p(t){var n=this.array,r=n._promise,i=_(n._fn);r._pushContext();var o;o=void 0!==n._eachValues?i.call(r._boundValue(),t,this.index,this.length):i.call(r._boundValue(),this.accum,t,this.index,this.length),o instanceof e&&(n._currentCancellable=o);var a=r._popContext();return s.checkForgottenReturns(o,a,void 0!==n._eachValues?"Promise.each":"Promise.reduce",r),o}var h=e._getDomain,f=t("./util"),_=f.tryCatch;f.inherits(a,n),a.prototype._gotAccum=function(t){void 0!==this._eachValues&&null!==this._eachValues&&t!==o&&this._eachValues.push(t)},a.prototype._eachComplete=function(t){return null!==this._eachValues&&this._eachValues.push(t),this._eachValues},a.prototype._init=function(){},a.prototype._resolveEmptyArray=function(){this._resolve(void 0!==this._eachValues?this._eachValues:this._initialValue)},a.prototype.shouldCopyValues=function(){return!1},a.prototype._resolve=function(t){this._promise._resolveCallback(t),this._values=null},a.prototype._resultCancelled=function(t){return t===this._initialValue?this._cancel():void(this._isResolved()||(this._resultCancelled$(),this._currentCancellable instanceof e&&this._currentCancellable.cancel(),this._initialValue instanceof e&&this._initialValue.cancel()))},a.prototype._iterate=function(t){this._values=t;var n,r,i=t.length;if(void 0!==this._initialValue?(n=this._initialValue,r=0):(n=e.resolve(t[0]),r=1),this._currentCancellable=n,!n.isRejected())for(;i>r;++r){var o={accum:null,value:t[r],index:r,length:i,array:this};n=n._then(u,void 0,void 0,o,void 0)}void 0!==this._eachValues&&(n=n._then(this._eachComplete,void 0,void 0,this,void 0)),n._then(c,c,void 0,n,this)},e.prototype.reduce=function(t,e){return l(this,t,e,null)},e.reduce=function(t,e,n,r){return l(t,e,n,r)}}},{"./util":36}],29:[function(t,e,n){"use strict";var r,i=t("./util"),o=function(){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n")},s=i.getNativePromise();if(i.isNode&&"undefined"==typeof MutationObserver){var a=global.setImmediate,c=process.nextTick;r=i.isRecentNode?function(t){a.call(global,t)}:function(t){c.call(process,t)}}else if("function"==typeof s&&"function"==typeof s.resolve){var l=s.resolve();r=function(t){l.then(t)}}else r="undefined"==typeof MutationObserver||"undefined"!=typeof window&&window.navigator&&(window.navigator.standalone||window.cordova)?"undefined"!=typeof setImmediate?function(t){setImmediate(t)}:"undefined"!=typeof setTimeout?function(t){setTimeout(t,0)}:o:function(){var t=document.createElement("div"),e={attributes:!0},n=!1,r=document.createElement("div"),i=new MutationObserver(function(){t.classList.toggle("foo"),n=!1});i.observe(r,e);var o=function(){n||(n=!0,r.classList.toggle("foo"))};return function(n){var r=new MutationObserver(function(){r.disconnect(),n()});r.observe(t,e),o()}}();e.exports=r},{"./util":36}],30:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t){this.constructor$(t)}var o=e.PromiseInspection,s=t("./util");s.inherits(i,n),i.prototype._promiseResolved=function(t,e){this._values[t]=e;var n=++this._totalResolved;return n>=this._length?(this._resolve(this._values),!0):!1},i.prototype._promiseFulfilled=function(t,e){var n=new o;return n._bitField=33554432,n._settledValueField=t,this._promiseResolved(e,n)},i.prototype._promiseRejected=function(t,e){var n=new o;return n._bitField=16777216,n._settledValueField=t,this._promiseResolved(e,n)},e.settle=function(t){return r.deprecated(".settle()",".reflect()"),new i(t).promise()},e.prototype.settle=function(){return e.settle(this)}}},{"./util":36}],31:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t){this.constructor$(t),
this._howMany=0,this._unwrap=!1,this._initialized=!1}function o(t,e){if((0|e)!==e||0>e)return r("expecting a positive integer\n\n    See http://goo.gl/MqrFmX\n");var n=new i(t),o=n.promise();return n.setHowMany(e),n.init(),o}var s=t("./util"),a=t("./errors").RangeError,c=t("./errors").AggregateError,l=s.isArray,u={};s.inherits(i,n),i.prototype._init=function(){if(this._initialized){if(0===this._howMany)return void this._resolve([]);this._init$(void 0,-5);var t=l(this._values);!this._isResolved()&&t&&this._howMany>this._canPossiblyFulfill()&&this._reject(this._getRangeError(this.length()))}},i.prototype.init=function(){this._initialized=!0,this._init()},i.prototype.setUnwrap=function(){this._unwrap=!0},i.prototype.howMany=function(){return this._howMany},i.prototype.setHowMany=function(t){this._howMany=t},i.prototype._promiseFulfilled=function(t){return this._addFulfilled(t),this._fulfilled()===this.howMany()?(this._values.length=this.howMany(),1===this.howMany()&&this._unwrap?this._resolve(this._values[0]):this._resolve(this._values),!0):!1},i.prototype._promiseRejected=function(t){return this._addRejected(t),this._checkOutcome()},i.prototype._promiseCancelled=function(){return this._values instanceof e||null==this._values?this._cancel():(this._addRejected(u),this._checkOutcome())},i.prototype._checkOutcome=function(){if(this.howMany()>this._canPossiblyFulfill()){for(var t=new c,e=this.length();e<this._values.length;++e)this._values[e]!==u&&t.push(this._values[e]);return t.length>0?this._reject(t):this._cancel(),!0}return!1},i.prototype._fulfilled=function(){return this._totalResolved},i.prototype._rejected=function(){return this._values.length-this.length()},i.prototype._addRejected=function(t){this._values.push(t)},i.prototype._addFulfilled=function(t){this._values[this._totalResolved++]=t},i.prototype._canPossiblyFulfill=function(){return this.length()-this._rejected()},i.prototype._getRangeError=function(t){var e="Input array must contain at least "+this._howMany+" items but contains only "+t+" items";return new a(e)},i.prototype._resolveEmptyArray=function(){this._reject(this._getRangeError(0))},e.some=function(t,e){return o(t,e)},e.prototype.some=function(t){return o(this,t)},e._SomePromiseArray=i}},{"./errors":12,"./util":36}],32:[function(t,e,n){"use strict";e.exports=function(t){function e(t){void 0!==t?(t=t._target(),this._bitField=t._bitField,this._settledValueField=t._isFateSealed()?t._settledValue():void 0):(this._bitField=0,this._settledValueField=void 0)}e.prototype._settledValue=function(){return this._settledValueField};var n=e.prototype.value=function(){if(!this.isFulfilled())throw new TypeError("cannot get fulfillment value of a non-fulfilled promise\n\n    See http://goo.gl/MqrFmX\n");return this._settledValue()},r=e.prototype.error=e.prototype.reason=function(){if(!this.isRejected())throw new TypeError("cannot get rejection reason of a non-rejected promise\n\n    See http://goo.gl/MqrFmX\n");return this._settledValue()},i=e.prototype.isFulfilled=function(){return 0!==(33554432&this._bitField)},o=e.prototype.isRejected=function(){return 0!==(16777216&this._bitField)},s=e.prototype.isPending=function(){return 0===(50397184&this._bitField)},a=e.prototype.isResolved=function(){return 0!==(50331648&this._bitField)};e.prototype.isCancelled=function(){return 0!==(8454144&this._bitField)},t.prototype.__isCancelled=function(){return 65536===(65536&this._bitField)},t.prototype._isCancelled=function(){return this._target().__isCancelled()},t.prototype.isCancelled=function(){return 0!==(8454144&this._target()._bitField)},t.prototype.isPending=function(){return s.call(this._target())},t.prototype.isRejected=function(){return o.call(this._target())},t.prototype.isFulfilled=function(){return i.call(this._target())},t.prototype.isResolved=function(){return a.call(this._target())},t.prototype.value=function(){return n.call(this._target())},t.prototype.reason=function(){var t=this._target();return t._unsetRejectionIsUnhandled(),r.call(t)},t.prototype._value=function(){return this._settledValue()},t.prototype._reason=function(){return this._unsetRejectionIsUnhandled(),this._settledValue()},t.PromiseInspection=e}},{}],33:[function(t,e,n){"use strict";e.exports=function(e,n){function r(t,r){if(u(t)){if(t instanceof e)return t;var i=o(t);if(i===l){r&&r._pushContext();var c=e.reject(i.e);return r&&r._popContext(),c}if("function"==typeof i){if(s(t)){var c=new e(n);return t._then(c._fulfill,c._reject,void 0,c,null),c}return a(t,i,r)}}return t}function i(t){return t.then}function o(t){try{return i(t)}catch(e){return l.e=e,l}}function s(t){try{return p.call(t,"_promise0")}catch(e){return!1}}function a(t,r,i){function o(t){a&&(a._resolveCallback(t),a=null)}function s(t){a&&(a._rejectCallback(t,p,!0),a=null)}var a=new e(n),u=a;i&&i._pushContext(),a._captureStackTrace(),i&&i._popContext();var p=!0,h=c.tryCatch(r).call(t,o,s);return p=!1,a&&h===l&&(a._rejectCallback(h.e,!0,!0),a=null),u}var c=t("./util"),l=c.errorObj,u=c.isObject,p={}.hasOwnProperty;return r}},{"./util":36}],34:[function(t,e,n){"use strict";e.exports=function(e,n,r){function i(t){this.handle=t}function o(t){return clearTimeout(this.handle),t}function s(t){throw clearTimeout(this.handle),t}var a=t("./util"),c=e.TimeoutError;i.prototype._resultCancelled=function(){clearTimeout(this.handle)};var l=function(t){return u(+this).thenReturn(t)},u=e.delay=function(t,o){var s,a;return void 0!==o?(s=e.resolve(o)._then(l,null,null,t,void 0),r.cancellation()&&o instanceof e&&s._setOnCancel(o)):(s=new e(n),a=setTimeout(function(){s._fulfill()},+t),r.cancellation()&&s._setOnCancel(new i(a)),s._captureStackTrace()),s._setAsyncGuaranteed(),s};e.prototype.delay=function(t){return u(t,this)};var p=function(t,e,n){var r;r="string"!=typeof e?e instanceof Error?e:new c("operation timed out"):new c(e),a.markAsOriginatingFromRejection(r),t._attachExtraTrace(r),t._reject(r),null!=n&&n.cancel()};e.prototype.timeout=function(t,e){t=+t;var n,a,c=new i(setTimeout(function(){n.isPending()&&p(n,e,a)},t));return r.cancellation()?(a=this.then(),n=a._then(o,s,void 0,c,void 0),n._setOnCancel(c)):n=this._then(o,s,void 0,c,void 0),n}}},{"./util":36}],35:[function(t,e,n){"use strict";e.exports=function(e,n,r,i,o,s){function a(t){setTimeout(function(){throw t},0)}function c(t){var e=r(t);return e!==t&&"function"==typeof t._isDisposable&&"function"==typeof t._getDisposer&&t._isDisposable()&&e._setDisposable(t._getDisposer()),e}function l(t,n){function i(){if(s>=l)return u._fulfill();var o=c(t[s++]);if(o instanceof e&&o._isDisposable()){try{o=r(o._getDisposer().tryDispose(n),t.promise)}catch(p){return a(p)}if(o instanceof e)return o._then(i,a,null,null,null)}i()}var s=0,l=t.length,u=new e(o);return i(),u}function u(t,e,n){this._data=t,this._promise=e,this._context=n}function p(t,e,n){this.constructor$(t,e,n)}function h(t){return u.isDisposer(t)?(this.resources[this.index]._setDisposable(t),t.promise()):t}function f(t){this.length=t,this.promise=null,this[t-1]=null}var _=t("./util"),d=t("./errors").TypeError,v=t("./util").inherits,y=_.errorObj,m=_.tryCatch,g={};u.prototype.data=function(){return this._data},u.prototype.promise=function(){return this._promise},u.prototype.resource=function(){return this.promise().isFulfilled()?this.promise().value():g},u.prototype.tryDispose=function(t){var e=this.resource(),n=this._context;void 0!==n&&n._pushContext();var r=e!==g?this.doDispose(e,t):null;return void 0!==n&&n._popContext(),this._promise._unsetDisposable(),this._data=null,r},u.isDisposer=function(t){return null!=t&&"function"==typeof t.resource&&"function"==typeof t.tryDispose},v(p,u),p.prototype.doDispose=function(t,e){var n=this.data();return n.call(t,t,e)},f.prototype._resultCancelled=function(){for(var t=this.length,n=0;t>n;++n){var r=this[n];r instanceof e&&r.cancel()}},e.using=function(){var t=arguments.length;if(2>t)return n("you must pass at least 2 arguments to Promise.using");var i=arguments[t-1];if("function"!=typeof i)return n("expecting a function but got "+_.classString(i));var o,a=!0;2===t&&Array.isArray(arguments[0])?(o=arguments[0],t=o.length,a=!1):(o=arguments,t--);for(var c=new f(t),p=0;t>p;++p){var d=o[p];if(u.isDisposer(d)){var v=d;d=d.promise(),d._setDisposable(v)}else{var g=r(d);g instanceof e&&(d=g._then(h,null,null,{resources:c,index:p},void 0))}c[p]=d}for(var b=new Array(c.length),p=0;p<b.length;++p)b[p]=e.resolve(c[p]).reflect();var w=e.all(b).then(function(t){for(var e=0;e<t.length;++e){var n=t[e];if(n.isRejected())return y.e=n.error(),y;if(!n.isFulfilled())return void w.cancel();t[e]=n.value()}C._pushContext(),i=m(i);var r=a?i.apply(void 0,t):i(t),o=C._popContext();return s.checkForgottenReturns(r,o,"Promise.using",C),r}),C=w.lastly(function(){var t=new e.PromiseInspection(w);return l(c,t)});return c.promise=C,C._setOnCancel(c),C},e.prototype._setDisposable=function(t){this._bitField=131072|this._bitField,this._disposer=t},e.prototype._isDisposable=function(){return(131072&this._bitField)>0},e.prototype._getDisposer=function(){return this._disposer},e.prototype._unsetDisposable=function(){this._bitField=-131073&this._bitField,this._disposer=void 0},e.prototype.disposer=function(t){if("function"==typeof t)return new p(t,this,i());throw new d}}},{"./errors":12,"./util":36}],36:[function(t,e,n){"use strict";function r(){try{var t=P;return P=null,t.apply(this,arguments)}catch(e){return T.e=e,T}}function i(t){return P=t,r}function o(t){return null==t||t===!0||t===!1||"string"==typeof t||"number"==typeof t}function s(t){return"function"==typeof t||"object"==typeof t&&null!==t}function a(t){return o(t)?new Error(v(t)):t}function c(t,e){var n,r=t.length,i=new Array(r+1);for(n=0;r>n;++n)i[n]=t[n];return i[n]=e,i}function l(t,e,n){if(!F.isES5)return{}.hasOwnProperty.call(t,e)?t[e]:void 0;var r=Object.getOwnPropertyDescriptor(t,e);return null!=r?null==r.get&&null==r.set?r.value:n:void 0}function u(t,e,n){if(o(t))return t;var r={value:n,configurable:!0,enumerable:!1,writable:!0};return F.defineProperty(t,e,r),t}function p(t){throw t}function h(t){try{if("function"==typeof t){var e=F.names(t.prototype),n=F.isES5&&e.length>1,r=e.length>0&&!(1===e.length&&"constructor"===e[0]),i=A.test(t+"")&&F.names(t).length>0;if(n||r||i)return!0}return!1}catch(o){return!1}}function f(t){function e(){}e.prototype=t;for(var n=8;n--;)new e;return t}function _(t){return D.test(t)}function d(t,e,n){for(var r=new Array(t),i=0;t>i;++i)r[i]=e+i+n;return r}function v(t){try{return t+""}catch(e){return"[no string representation]"}}function y(t){return null!==t&&"object"==typeof t&&"string"==typeof t.message&&"string"==typeof t.name}function m(t){try{u(t,"isOperational",!0)}catch(e){}}function g(t){return null==t?!1:t instanceof Error.__BluebirdErrorTypes__.OperationalError||t.isOperational===!0}function b(t){return y(t)&&F.propertyIsWritable(t,"stack")}function w(t){return{}.toString.call(t)}function C(t,e,n){for(var r=F.names(t),i=0;i<r.length;++i){var o=r[i];if(n(o))try{F.defineProperty(e,o,F.getDescriptor(t,o))}catch(s){}}}function j(t){return N?process.env[t]:void 0}function E(){if("function"==typeof Promise)try{var t=new Promise(function(){});if("[object Promise]"==={}.toString.call(t))return Promise}catch(e){}}function k(t,e){return t.bind(e)}var F=t("./es5"),x="undefined"==typeof navigator,T={e:{}},P,R="undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0!==this?this:null,S=function(t,e){function n(){this.constructor=t,this.constructor$=e;for(var n in e.prototype)r.call(e.prototype,n)&&"$"!==n.charAt(n.length-1)&&(this[n+"$"]=e.prototype[n])}var r={}.hasOwnProperty;return n.prototype=e.prototype,t.prototype=new n,t.prototype},O=function(){var t=[Array.prototype,Object.prototype,Function.prototype],e=function(e){for(var n=0;n<t.length;++n)if(t[n]===e)return!0;return!1};if(F.isES5){var n=Object.getOwnPropertyNames;return function(t){for(var r=[],i=Object.create(null);null!=t&&!e(t);){var o;try{o=n(t)}catch(s){return r}for(var a=0;a<o.length;++a){var c=o[a];if(!i[c]){i[c]=!0;var l=Object.getOwnPropertyDescriptor(t,c);null!=l&&null==l.get&&null==l.set&&r.push(c)}}t=F.getPrototypeOf(t)}return r}}var r={}.hasOwnProperty;return function(n){if(e(n))return[];var i=[];t:for(var o in n)if(r.call(n,o))i.push(o);else{for(var s=0;s<t.length;++s)if(r.call(t[s],o))continue t;i.push(o)}return i}}(),A=/this\s*\.\s*\S+\s*=/,D=/^[a-z$_][a-z$_0-9]*$/i,V=function(){return"stack"in new Error?function(t){return b(t)?t:new Error(v(t))}:function(t){if(b(t))return t;try{throw new Error(v(t))}catch(e){return e}}}(),I=function(t){return F.isArray(t)?t:null};if("undefined"!=typeof Symbol&&Symbol.iterator){var L="function"==typeof Array.from?function(t){return Array.from(t)}:function(t){for(var e,n=[],r=t[Symbol.iterator]();!(e=r.next()).done;)n.push(e.value);return n};I=function(t){return F.isArray(t)?t:null!=t&&"function"==typeof t[Symbol.iterator]?L(t):null}}var H="undefined"!=typeof process&&"[object process]"===w(process).toLowerCase(),N="undefined"!=typeof process&&"undefined"!=typeof process.env,B={isClass:h,isIdentifier:_,inheritedDataKeys:O,getDataPropertyOrDefault:l,thrower:p,isArray:F.isArray,asArray:I,notEnumerableProp:u,isPrimitive:o,isObject:s,isError:y,canEvaluate:x,errorObj:T,tryCatch:i,inherits:S,withAppended:c,maybeWrapAsError:a,toFastProperties:f,filledRange:d,toString:v,canAttachTrace:b,ensureErrorObject:V,originatesFromRejection:g,markAsOriginatingFromRejection:m,classString:w,copyDescriptors:C,hasDevTools:"undefined"!=typeof chrome&&chrome&&"function"==typeof chrome.loadTimes,isNode:H,hasEnvVariables:N,env:j,global:R,getNativePromise:E,domainBind:k};B.isRecentNode=B.isNode&&function(){var t=process.versions.node.split(".").map(Number);return 0===t[0]&&t[1]>10||t[0]>0}(),B.isNode&&B.toFastProperties(process);try{throw new Error}catch(U){B.lastLineError=U}e.exports=B},{"./es5":13}]},{},[4])(4)}),"undefined"!=typeof window&&null!==window?window.P=window.Promise:"undefined"!=typeof self&&null!==self&&(self.P=self.Promise);

if (window) window.__currentScriptPath = "/framework/common/codemirror/lib/codemirror.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

// This is CodeMirror (http://codemirror.net), a code editor
// implemented in JavaScript on top of the browser's DOM.
//
// You can find some technical background for some of the code below
// at http://marijnhaverbeke.nl/blog/#cm-internals .

(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
  typeof define === 'function' && define.amd ? define(factory) :
  (global.CodeMirror = factory());
}(this, (function () { 'use strict';

// Kludges for bugs and behavior differences that can't be feature
// detected are enabled based on userAgent etc sniffing.
var userAgent = navigator.userAgent
var platform = navigator.platform

var gecko = /gecko\/\d/i.test(userAgent)
var ie_upto10 = /MSIE \d/.test(userAgent)
var ie_11up = /Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(userAgent)
var edge = /Edge\/(\d+)/.exec(userAgent)
var ie = ie_upto10 || ie_11up || edge
var ie_version = ie && (ie_upto10 ? document.documentMode || 6 : +(edge || ie_11up)[1])
var webkit = !edge && /WebKit\//.test(userAgent)
var qtwebkit = webkit && /Qt\/\d+\.\d+/.test(userAgent)
var chrome = !edge && /Chrome\//.test(userAgent)
var presto = /Opera\//.test(userAgent)
var safari = /Apple Computer/.test(navigator.vendor)
var mac_geMountainLion = /Mac OS X 1\d\D([8-9]|\d\d)\D/.test(userAgent)
var phantom = /PhantomJS/.test(userAgent)

var ios = !edge && /AppleWebKit/.test(userAgent) && /Mobile\/\w+/.test(userAgent)
var android = /Android/.test(userAgent)
// This is woefully incomplete. Suggestions for alternative methods welcome.
var mobile = ios || android || /webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(userAgent)
var mac = ios || /Mac/.test(platform)
var chromeOS = /\bCrOS\b/.test(userAgent)
var windows = /win/i.test(platform)

var presto_version = presto && userAgent.match(/Version\/(\d*\.\d*)/)
if (presto_version) { presto_version = Number(presto_version[1]) }
if (presto_version && presto_version >= 15) { presto = false; webkit = true }
// Some browsers use the wrong event properties to signal cmd/ctrl on OS X
var flipCtrlCmd = mac && (qtwebkit || presto && (presto_version == null || presto_version < 12.11))
var captureRightClick = gecko || (ie && ie_version >= 9)

function classTest(cls) { return new RegExp("(^|\\s)" + cls + "(?:$|\\s)\\s*") }

var rmClass = function(node, cls) {
  var current = node.className
  var match = classTest(cls).exec(current)
  if (match) {
    var after = current.slice(match.index + match[0].length)
    node.className = current.slice(0, match.index) + (after ? match[1] + after : "")
  }
}

function removeChildren(e) {
  for (var count = e.childNodes.length; count > 0; --count)
    { e.removeChild(e.firstChild) }
  return e
}

function removeChildrenAndAdd(parent, e) {
  return removeChildren(parent).appendChild(e)
}

function elt(tag, content, className, style) {
  var e = document.createElement(tag)
  if (className) { e.className = className }
  if (style) { e.style.cssText = style }
  if (typeof content == "string") { e.appendChild(document.createTextNode(content)) }
  else if (content) { for (var i = 0; i < content.length; ++i) { e.appendChild(content[i]) } }
  return e
}
// wrapper for elt, which removes the elt from the accessibility tree
function eltP(tag, content, className, style) {
  var e = elt(tag, content, className, style)
  e.setAttribute("role", "presentation")
  return e
}

var range
if (document.createRange) { range = function(node, start, end, endNode) {
  var r = document.createRange()
  r.setEnd(endNode || node, end)
  r.setStart(node, start)
  return r
} }
else { range = function(node, start, end) {
  var r = document.body.createTextRange()
  try { r.moveToElementText(node.parentNode) }
  catch(e) { return r }
  r.collapse(true)
  r.moveEnd("character", end)
  r.moveStart("character", start)
  return r
} }

function contains(parent, child) {
  if (child.nodeType == 3) // Android browser always returns false when child is a textnode
    { child = child.parentNode }
  if (parent.contains)
    { return parent.contains(child) }
  do {
    if (child.nodeType == 11) { child = child.host }
    if (child == parent) { return true }
  } while (child = child.parentNode)
}

function activeElt() {
  // IE and Edge may throw an "Unspecified Error" when accessing document.activeElement.
  // IE < 10 will throw when accessed while the page is loading or in an iframe.
  // IE > 9 and Edge will throw when accessed in an iframe if document.body is unavailable.
  var activeElement
  try {
    activeElement = document.activeElement
  } catch(e) {
    activeElement = document.body || null
  }
  while (activeElement && activeElement.shadowRoot && activeElement.shadowRoot.activeElement)
    { activeElement = activeElement.shadowRoot.activeElement }
  return activeElement
}

function addClass(node, cls) {
  var current = node.className
  if (!classTest(cls).test(current)) { node.className += (current ? " " : "") + cls }
}
function joinClasses(a, b) {
  var as = a.split(" ")
  for (var i = 0; i < as.length; i++)
    { if (as[i] && !classTest(as[i]).test(b)) { b += " " + as[i] } }
  return b
}

var selectInput = function(node) { node.select() }
if (ios) // Mobile Safari apparently has a bug where select() is broken.
  { selectInput = function(node) { node.selectionStart = 0; node.selectionEnd = node.value.length } }
else if (ie) // Suppress mysterious IE10 errors
  { selectInput = function(node) { try { node.select() } catch(_e) {} } }

function bind(f) {
  var args = Array.prototype.slice.call(arguments, 1)
  return function(){return f.apply(null, args)}
}

function copyObj(obj, target, overwrite) {
  if (!target) { target = {} }
  for (var prop in obj)
    { if (obj.hasOwnProperty(prop) && (overwrite !== false || !target.hasOwnProperty(prop)))
      { target[prop] = obj[prop] } }
  return target
}

// Counts the column offset in a string, taking tabs into account.
// Used mostly to find indentation.
function countColumn(string, end, tabSize, startIndex, startValue) {
  if (end == null) {
    end = string.search(/[^\s\u00a0]/)
    if (end == -1) { end = string.length }
  }
  for (var i = startIndex || 0, n = startValue || 0;;) {
    var nextTab = string.indexOf("\t", i)
    if (nextTab < 0 || nextTab >= end)
      { return n + (end - i) }
    n += nextTab - i
    n += tabSize - (n % tabSize)
    i = nextTab + 1
  }
}

var Delayed = function() {this.id = null};
Delayed.prototype.set = function (ms, f) {
  clearTimeout(this.id)
  this.id = setTimeout(f, ms)
};

function indexOf(array, elt) {
  for (var i = 0; i < array.length; ++i)
    { if (array[i] == elt) { return i } }
  return -1
}

// Number of pixels added to scroller and sizer to hide scrollbar
var scrollerGap = 30

// Returned or thrown by various protocols to signal 'I'm not
// handling this'.
var Pass = {toString: function(){return "CodeMirror.Pass"}}

// Reused option objects for setSelection & friends
var sel_dontScroll = {scroll: false};
var sel_mouse = {origin: "*mouse"};
var sel_move = {origin: "+move"};
// The inverse of countColumn -- find the offset that corresponds to
// a particular column.
function findColumn(string, goal, tabSize) {
  for (var pos = 0, col = 0;;) {
    var nextTab = string.indexOf("\t", pos)
    if (nextTab == -1) { nextTab = string.length }
    var skipped = nextTab - pos
    if (nextTab == string.length || col + skipped >= goal)
      { return pos + Math.min(skipped, goal - col) }
    col += nextTab - pos
    col += tabSize - (col % tabSize)
    pos = nextTab + 1
    if (col >= goal) { return pos }
  }
}

var spaceStrs = [""]
function spaceStr(n) {
  while (spaceStrs.length <= n)
    { spaceStrs.push(lst(spaceStrs) + " ") }
  return spaceStrs[n]
}

function lst(arr) { return arr[arr.length-1] }

function map(array, f) {
  var out = []
  for (var i = 0; i < array.length; i++) { out[i] = f(array[i], i) }
  return out
}

function insertSorted(array, value, score) {
  var pos = 0, priority = score(value)
  while (pos < array.length && score(array[pos]) <= priority) { pos++ }
  array.splice(pos, 0, value)
}

function nothing() {}

function createObj(base, props) {
  var inst
  if (Object.create) {
    inst = Object.create(base)
  } else {
    nothing.prototype = base
    inst = new nothing()
  }
  if (props) { copyObj(props, inst) }
  return inst
}

var nonASCIISingleCaseWordChar = /[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/
function isWordCharBasic(ch) {
  return /\w/.test(ch) || ch > "\x80" &&
    (ch.toUpperCase() != ch.toLowerCase() || nonASCIISingleCaseWordChar.test(ch))
}
function isWordChar(ch, helper) {
  if (!helper) { return isWordCharBasic(ch) }
  if (helper.source.indexOf("\\w") > -1 && isWordCharBasic(ch)) { return true }
  return helper.test(ch)
}

function isEmpty(obj) {
  for (var n in obj) { if (obj.hasOwnProperty(n) && obj[n]) { return false } }
  return true
}

// Extending unicode characters. A series of a non-extending char +
// any number of extending chars is treated as a single unit as far
// as editing and measuring is concerned. This is not fully correct,
// since some scripts/fonts/browsers also treat other configurations
// of code points as a group.
var extendingChars = /[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/
function isExtendingChar(ch) { return ch.charCodeAt(0) >= 768 && extendingChars.test(ch) }

// Returns a number from the range [`0`; `str.length`] unless `pos` is outside that range.
function skipExtendingChars(str, pos, dir) {
  while ((dir < 0 ? pos > 0 : pos < str.length) && isExtendingChar(str.charAt(pos))) { pos += dir }
  return pos
}

// Returns the value from the range [`from`; `to`] that satisfies
// `pred` and is closest to `from`. Assumes that at least `to`
// satisfies `pred`. Supports `from` being greater than `to`.
function findFirst(pred, from, to) {
  // At any point we are certain `to` satisfies `pred`, don't know
  // whether `from` does.
  var dir = from > to ? -1 : 1
  for (;;) {
    if (from == to) { return from }
    var midF = (from + to) / 2, mid = dir < 0 ? Math.ceil(midF) : Math.floor(midF)
    if (mid == from) { return pred(mid) ? from : to }
    if (pred(mid)) { to = mid }
    else { from = mid + dir }
  }
}

// The display handles the DOM integration, both for input reading
// and content drawing. It holds references to DOM nodes and
// display-related state.

function Display(place, doc, input) {
  var d = this
  this.input = input

  // Covers bottom-right square when both scrollbars are present.
  d.scrollbarFiller = elt("div", null, "CodeMirror-scrollbar-filler")
  d.scrollbarFiller.setAttribute("cm-not-content", "true")
  // Covers bottom of gutter when coverGutterNextToScrollbar is on
  // and h scrollbar is present.
  d.gutterFiller = elt("div", null, "CodeMirror-gutter-filler")
  d.gutterFiller.setAttribute("cm-not-content", "true")
  // Will contain the actual code, positioned to cover the viewport.
  d.lineDiv = eltP("div", null, "CodeMirror-code")
  // Elements are added to these to represent selection and cursors.
  d.selectionDiv = elt("div", null, null, "position: relative; z-index: 1")
  d.cursorDiv = elt("div", null, "CodeMirror-cursors")
  // A visibility: hidden element used to find the size of things.
  d.measure = elt("div", null, "CodeMirror-measure")
  // When lines outside of the viewport are measured, they are drawn in this.
  d.lineMeasure = elt("div", null, "CodeMirror-measure")
  // Wraps everything that needs to exist inside the vertically-padded coordinate system
  d.lineSpace = eltP("div", [d.measure, d.lineMeasure, d.selectionDiv, d.cursorDiv, d.lineDiv],
                    null, "position: relative; outline: none")
  var lines = eltP("div", [d.lineSpace], "CodeMirror-lines")
  // Moved around its parent to cover visible view.
  d.mover = elt("div", [lines], null, "position: relative")
  // Set to the height of the document, allowing scrolling.
  d.sizer = elt("div", [d.mover], "CodeMirror-sizer")
  d.sizerWidth = null
  // Behavior of elts with overflow: auto and padding is
  // inconsistent across browsers. This is used to ensure the
  // scrollable area is big enough.
  d.heightForcer = elt("div", null, null, "position: absolute; height: " + scrollerGap + "px; width: 1px;")
  // Will contain the gutters, if any.
  d.gutters = elt("div", null, "CodeMirror-gutters")
  d.lineGutter = null
  // Actual scrollable element.
  d.scroller = elt("div", [d.sizer, d.heightForcer, d.gutters], "CodeMirror-scroll")
  d.scroller.setAttribute("tabIndex", "-1")
  // The element in which the editor lives.
  d.wrapper = elt("div", [d.scrollbarFiller, d.gutterFiller, d.scroller], "CodeMirror")

  // Work around IE7 z-index bug (not perfect, hence IE7 not really being supported)
  if (ie && ie_version < 8) { d.gutters.style.zIndex = -1; d.scroller.style.paddingRight = 0 }
  if (!webkit && !(gecko && mobile)) { d.scroller.draggable = true }

  if (place) {
    if (place.appendChild) { place.appendChild(d.wrapper) }
    else { place(d.wrapper) }
  }

  // Current rendered range (may be bigger than the view window).
  d.viewFrom = d.viewTo = doc.first
  d.reportedViewFrom = d.reportedViewTo = doc.first
  // Information about the rendered lines.
  d.view = []
  d.renderedView = null
  // Holds info about a single rendered line when it was rendered
  // for measurement, while not in view.
  d.externalMeasured = null
  // Empty space (in pixels) above the view
  d.viewOffset = 0
  d.lastWrapHeight = d.lastWrapWidth = 0
  d.updateLineNumbers = null

  d.nativeBarWidth = d.barHeight = d.barWidth = 0
  d.scrollbarsClipped = false

  // Used to only resize the line number gutter when necessary (when
  // the amount of lines crosses a boundary that makes its width change)
  d.lineNumWidth = d.lineNumInnerWidth = d.lineNumChars = null
  // Set to true when a non-horizontal-scrolling line widget is
  // added. As an optimization, line widget aligning is skipped when
  // this is false.
  d.alignWidgets = false

  d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null

  // Tracks the maximum line length so that the horizontal scrollbar
  // can be kept static when scrolling.
  d.maxLine = null
  d.maxLineLength = 0
  d.maxLineChanged = false

  // Used for measuring wheel scrolling granularity
  d.wheelDX = d.wheelDY = d.wheelStartX = d.wheelStartY = null

  // True when shift is held down.
  d.shift = false

  // Used to track whether anything happened since the context menu
  // was opened.
  d.selForContextMenu = null

  d.activeTouch = null

  input.init(d)
}

// Find the line object corresponding to the given line number.
function getLine(doc, n) {
  n -= doc.first
  if (n < 0 || n >= doc.size) { throw new Error("There is no line " + (n + doc.first) + " in the document.") }
  var chunk = doc
  while (!chunk.lines) {
    for (var i = 0;; ++i) {
      var child = chunk.children[i], sz = child.chunkSize()
      if (n < sz) { chunk = child; break }
      n -= sz
    }
  }
  return chunk.lines[n]
}

// Get the part of a document between two positions, as an array of
// strings.
function getBetween(doc, start, end) {
  var out = [], n = start.line
  doc.iter(start.line, end.line + 1, function (line) {
    var text = line.text
    if (n == end.line) { text = text.slice(0, end.ch) }
    if (n == start.line) { text = text.slice(start.ch) }
    out.push(text)
    ++n
  })
  return out
}
// Get the lines between from and to, as array of strings.
function getLines(doc, from, to) {
  var out = []
  doc.iter(from, to, function (line) { out.push(line.text) }) // iter aborts when callback returns truthy value
  return out
}

// Update the height of a line, propagating the height change
// upwards to parent nodes.
function updateLineHeight(line, height) {
  var diff = height - line.height
  if (diff) { for (var n = line; n; n = n.parent) { n.height += diff } }
}

// Given a line object, find its line number by walking up through
// its parent links.
function lineNo(line) {
  if (line.parent == null) { return null }
  var cur = line.parent, no = indexOf(cur.lines, line)
  for (var chunk = cur.parent; chunk; cur = chunk, chunk = chunk.parent) {
    for (var i = 0;; ++i) {
      if (chunk.children[i] == cur) { break }
      no += chunk.children[i].chunkSize()
    }
  }
  return no + cur.first
}

// Find the line at the given vertical position, using the height
// information in the document tree.
function lineAtHeight(chunk, h) {
  var n = chunk.first
  outer: do {
    for (var i$1 = 0; i$1 < chunk.children.length; ++i$1) {
      var child = chunk.children[i$1], ch = child.height
      if (h < ch) { chunk = child; continue outer }
      h -= ch
      n += child.chunkSize()
    }
    return n
  } while (!chunk.lines)
  var i = 0
  for (; i < chunk.lines.length; ++i) {
    var line = chunk.lines[i], lh = line.height
    if (h < lh) { break }
    h -= lh
  }
  return n + i
}

function isLine(doc, l) {return l >= doc.first && l < doc.first + doc.size}

function lineNumberFor(options, i) {
  return String(options.lineNumberFormatter(i + options.firstLineNumber))
}

// A Pos instance represents a position within the text.
function Pos(line, ch, sticky) {
  if ( sticky === void 0 ) sticky = null;

  if (!(this instanceof Pos)) { return new Pos(line, ch, sticky) }
  this.line = line
  this.ch = ch
  this.sticky = sticky
}

// Compare two positions, return 0 if they are the same, a negative
// number when a is less, and a positive number otherwise.
function cmp(a, b) { return a.line - b.line || a.ch - b.ch }

function equalCursorPos(a, b) { return a.sticky == b.sticky && cmp(a, b) == 0 }

function copyPos(x) {return Pos(x.line, x.ch)}
function maxPos(a, b) { return cmp(a, b) < 0 ? b : a }
function minPos(a, b) { return cmp(a, b) < 0 ? a : b }

// Most of the external API clips given positions to make sure they
// actually exist within the document.
function clipLine(doc, n) {return Math.max(doc.first, Math.min(n, doc.first + doc.size - 1))}
function clipPos(doc, pos) {
  if (pos.line < doc.first) { return Pos(doc.first, 0) }
  var last = doc.first + doc.size - 1
  if (pos.line > last) { return Pos(last, getLine(doc, last).text.length) }
  return clipToLen(pos, getLine(doc, pos.line).text.length)
}
function clipToLen(pos, linelen) {
  var ch = pos.ch
  if (ch == null || ch > linelen) { return Pos(pos.line, linelen) }
  else if (ch < 0) { return Pos(pos.line, 0) }
  else { return pos }
}
function clipPosArray(doc, array) {
  var out = []
  for (var i = 0; i < array.length; i++) { out[i] = clipPos(doc, array[i]) }
  return out
}

// Optimize some code when these features are not used.
var sawReadOnlySpans = false;
var sawCollapsedSpans = false;
function seeReadOnlySpans() {
  sawReadOnlySpans = true
}

function seeCollapsedSpans() {
  sawCollapsedSpans = true
}

// TEXTMARKER SPANS

function MarkedSpan(marker, from, to) {
  this.marker = marker
  this.from = from; this.to = to
}

// Search an array of spans for a span matching the given marker.
function getMarkedSpanFor(spans, marker) {
  if (spans) { for (var i = 0; i < spans.length; ++i) {
    var span = spans[i]
    if (span.marker == marker) { return span }
  } }
}
// Remove a span from an array, returning undefined if no spans are
// left (we don't store arrays for lines without spans).
function removeMarkedSpan(spans, span) {
  var r
  for (var i = 0; i < spans.length; ++i)
    { if (spans[i] != span) { (r || (r = [])).push(spans[i]) } }
  return r
}
// Add a span to a line.
function addMarkedSpan(line, span) {
  line.markedSpans = line.markedSpans ? line.markedSpans.concat([span]) : [span]
  span.marker.attachLine(line)
}

// Used for the algorithm that adjusts markers for a change in the
// document. These functions cut an array of spans at a given
// character position, returning an array of remaining chunks (or
// undefined if nothing remains).
function markedSpansBefore(old, startCh, isInsert) {
  var nw
  if (old) { for (var i = 0; i < old.length; ++i) {
    var span = old[i], marker = span.marker
    var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= startCh : span.from < startCh)
    if (startsBefore || span.from == startCh && marker.type == "bookmark" && (!isInsert || !span.marker.insertLeft)) {
      var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= startCh : span.to > startCh)
      ;(nw || (nw = [])).push(new MarkedSpan(marker, span.from, endsAfter ? null : span.to))
    }
  } }
  return nw
}
function markedSpansAfter(old, endCh, isInsert) {
  var nw
  if (old) { for (var i = 0; i < old.length; ++i) {
    var span = old[i], marker = span.marker
    var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= endCh : span.to > endCh)
    if (endsAfter || span.from == endCh && marker.type == "bookmark" && (!isInsert || span.marker.insertLeft)) {
      var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= endCh : span.from < endCh)
      ;(nw || (nw = [])).push(new MarkedSpan(marker, startsBefore ? null : span.from - endCh,
                                            span.to == null ? null : span.to - endCh))
    }
  } }
  return nw
}

// Given a change object, compute the new set of marker spans that
// cover the line in which the change took place. Removes spans
// entirely within the change, reconnects spans belonging to the
// same marker that appear on both sides of the change, and cuts off
// spans partially within the change. Returns an array of span
// arrays with one element for each line in (after) the change.
function stretchSpansOverChange(doc, change) {
  if (change.full) { return null }
  var oldFirst = isLine(doc, change.from.line) && getLine(doc, change.from.line).markedSpans
  var oldLast = isLine(doc, change.to.line) && getLine(doc, change.to.line).markedSpans
  if (!oldFirst && !oldLast) { return null }

  var startCh = change.from.ch, endCh = change.to.ch, isInsert = cmp(change.from, change.to) == 0
  // Get the spans that 'stick out' on both sides
  var first = markedSpansBefore(oldFirst, startCh, isInsert)
  var last = markedSpansAfter(oldLast, endCh, isInsert)

  // Next, merge those two ends
  var sameLine = change.text.length == 1, offset = lst(change.text).length + (sameLine ? startCh : 0)
  if (first) {
    // Fix up .to properties of first
    for (var i = 0; i < first.length; ++i) {
      var span = first[i]
      if (span.to == null) {
        var found = getMarkedSpanFor(last, span.marker)
        if (!found) { span.to = startCh }
        else if (sameLine) { span.to = found.to == null ? null : found.to + offset }
      }
    }
  }
  if (last) {
    // Fix up .from in last (or move them into first in case of sameLine)
    for (var i$1 = 0; i$1 < last.length; ++i$1) {
      var span$1 = last[i$1]
      if (span$1.to != null) { span$1.to += offset }
      if (span$1.from == null) {
        var found$1 = getMarkedSpanFor(first, span$1.marker)
        if (!found$1) {
          span$1.from = offset
          if (sameLine) { (first || (first = [])).push(span$1) }
        }
      } else {
        span$1.from += offset
        if (sameLine) { (first || (first = [])).push(span$1) }
      }
    }
  }
  // Make sure we didn't create any zero-length spans
  if (first) { first = clearEmptySpans(first) }
  if (last && last != first) { last = clearEmptySpans(last) }

  var newMarkers = [first]
  if (!sameLine) {
    // Fill gap with whole-line-spans
    var gap = change.text.length - 2, gapMarkers
    if (gap > 0 && first)
      { for (var i$2 = 0; i$2 < first.length; ++i$2)
        { if (first[i$2].to == null)
          { (gapMarkers || (gapMarkers = [])).push(new MarkedSpan(first[i$2].marker, null, null)) } } }
    for (var i$3 = 0; i$3 < gap; ++i$3)
      { newMarkers.push(gapMarkers) }
    newMarkers.push(last)
  }
  return newMarkers
}

// Remove spans that are empty and don't have a clearWhenEmpty
// option of false.
function clearEmptySpans(spans) {
  for (var i = 0; i < spans.length; ++i) {
    var span = spans[i]
    if (span.from != null && span.from == span.to && span.marker.clearWhenEmpty !== false)
      { spans.splice(i--, 1) }
  }
  if (!spans.length) { return null }
  return spans
}

// Used to 'clip' out readOnly ranges when making a change.
function removeReadOnlyRanges(doc, from, to) {
  var markers = null
  doc.iter(from.line, to.line + 1, function (line) {
    if (line.markedSpans) { for (var i = 0; i < line.markedSpans.length; ++i) {
      var mark = line.markedSpans[i].marker
      if (mark.readOnly && (!markers || indexOf(markers, mark) == -1))
        { (markers || (markers = [])).push(mark) }
    } }
  })
  if (!markers) { return null }
  var parts = [{from: from, to: to}]
  for (var i = 0; i < markers.length; ++i) {
    var mk = markers[i], m = mk.find(0)
    for (var j = 0; j < parts.length; ++j) {
      var p = parts[j]
      if (cmp(p.to, m.from) < 0 || cmp(p.from, m.to) > 0) { continue }
      var newParts = [j, 1], dfrom = cmp(p.from, m.from), dto = cmp(p.to, m.to)
      if (dfrom < 0 || !mk.inclusiveLeft && !dfrom)
        { newParts.push({from: p.from, to: m.from}) }
      if (dto > 0 || !mk.inclusiveRight && !dto)
        { newParts.push({from: m.to, to: p.to}) }
      parts.splice.apply(parts, newParts)
      j += newParts.length - 3
    }
  }
  return parts
}

// Connect or disconnect spans from a line.
function detachMarkedSpans(line) {
  var spans = line.markedSpans
  if (!spans) { return }
  for (var i = 0; i < spans.length; ++i)
    { spans[i].marker.detachLine(line) }
  line.markedSpans = null
}
function attachMarkedSpans(line, spans) {
  if (!spans) { return }
  for (var i = 0; i < spans.length; ++i)
    { spans[i].marker.attachLine(line) }
  line.markedSpans = spans
}

// Helpers used when computing which overlapping collapsed span
// counts as the larger one.
function extraLeft(marker) { return marker.inclusiveLeft ? -1 : 0 }
function extraRight(marker) { return marker.inclusiveRight ? 1 : 0 }

// Returns a number indicating which of two overlapping collapsed
// spans is larger (and thus includes the other). Falls back to
// comparing ids when the spans cover exactly the same range.
function compareCollapsedMarkers(a, b) {
  var lenDiff = a.lines.length - b.lines.length
  if (lenDiff != 0) { return lenDiff }
  var aPos = a.find(), bPos = b.find()
  var fromCmp = cmp(aPos.from, bPos.from) || extraLeft(a) - extraLeft(b)
  if (fromCmp) { return -fromCmp }
  var toCmp = cmp(aPos.to, bPos.to) || extraRight(a) - extraRight(b)
  if (toCmp) { return toCmp }
  return b.id - a.id
}

// Find out whether a line ends or starts in a collapsed span. If
// so, return the marker for that span.
function collapsedSpanAtSide(line, start) {
  var sps = sawCollapsedSpans && line.markedSpans, found
  if (sps) { for (var sp = (void 0), i = 0; i < sps.length; ++i) {
    sp = sps[i]
    if (sp.marker.collapsed && (start ? sp.from : sp.to) == null &&
        (!found || compareCollapsedMarkers(found, sp.marker) < 0))
      { found = sp.marker }
  } }
  return found
}
function collapsedSpanAtStart(line) { return collapsedSpanAtSide(line, true) }
function collapsedSpanAtEnd(line) { return collapsedSpanAtSide(line, false) }

// Test whether there exists a collapsed span that partially
// overlaps (covers the start or end, but not both) of a new span.
// Such overlap is not allowed.
function conflictingCollapsedRange(doc, lineNo, from, to, marker) {
  var line = getLine(doc, lineNo)
  var sps = sawCollapsedSpans && line.markedSpans
  if (sps) { for (var i = 0; i < sps.length; ++i) {
    var sp = sps[i]
    if (!sp.marker.collapsed) { continue }
    var found = sp.marker.find(0)
    var fromCmp = cmp(found.from, from) || extraLeft(sp.marker) - extraLeft(marker)
    var toCmp = cmp(found.to, to) || extraRight(sp.marker) - extraRight(marker)
    if (fromCmp >= 0 && toCmp <= 0 || fromCmp <= 0 && toCmp >= 0) { continue }
    if (fromCmp <= 0 && (sp.marker.inclusiveRight && marker.inclusiveLeft ? cmp(found.to, from) >= 0 : cmp(found.to, from) > 0) ||
        fromCmp >= 0 && (sp.marker.inclusiveRight && marker.inclusiveLeft ? cmp(found.from, to) <= 0 : cmp(found.from, to) < 0))
      { return true }
  } }
}

// A visual line is a line as drawn on the screen. Folding, for
// example, can cause multiple logical lines to appear on the same
// visual line. This finds the start of the visual line that the
// given line is part of (usually that is the line itself).
function visualLine(line) {
  var merged
  while (merged = collapsedSpanAtStart(line))
    { line = merged.find(-1, true).line }
  return line
}

function visualLineEnd(line) {
  var merged
  while (merged = collapsedSpanAtEnd(line))
    { line = merged.find(1, true).line }
  return line
}

// Returns an array of logical lines that continue the visual line
// started by the argument, or undefined if there are no such lines.
function visualLineContinued(line) {
  var merged, lines
  while (merged = collapsedSpanAtEnd(line)) {
    line = merged.find(1, true).line
    ;(lines || (lines = [])).push(line)
  }
  return lines
}

// Get the line number of the start of the visual line that the
// given line number is part of.
function visualLineNo(doc, lineN) {
  var line = getLine(doc, lineN), vis = visualLine(line)
  if (line == vis) { return lineN }
  return lineNo(vis)
}

// Get the line number of the start of the next visual line after
// the given line.
function visualLineEndNo(doc, lineN) {
  if (lineN > doc.lastLine()) { return lineN }
  var line = getLine(doc, lineN), merged
  if (!lineIsHidden(doc, line)) { return lineN }
  while (merged = collapsedSpanAtEnd(line))
    { line = merged.find(1, true).line }
  return lineNo(line) + 1
}

// Compute whether a line is hidden. Lines count as hidden when they
// are part of a visual line that starts with another line, or when
// they are entirely covered by collapsed, non-widget span.
function lineIsHidden(doc, line) {
  var sps = sawCollapsedSpans && line.markedSpans
  if (sps) { for (var sp = (void 0), i = 0; i < sps.length; ++i) {
    sp = sps[i]
    if (!sp.marker.collapsed) { continue }
    if (sp.from == null) { return true }
    if (sp.marker.widgetNode) { continue }
    if (sp.from == 0 && sp.marker.inclusiveLeft && lineIsHiddenInner(doc, line, sp))
      { return true }
  } }
}
function lineIsHiddenInner(doc, line, span) {
  if (span.to == null) {
    var end = span.marker.find(1, true)
    return lineIsHiddenInner(doc, end.line, getMarkedSpanFor(end.line.markedSpans, span.marker))
  }
  if (span.marker.inclusiveRight && span.to == line.text.length)
    { return true }
  for (var sp = (void 0), i = 0; i < line.markedSpans.length; ++i) {
    sp = line.markedSpans[i]
    if (sp.marker.collapsed && !sp.marker.widgetNode && sp.from == span.to &&
        (sp.to == null || sp.to != span.from) &&
        (sp.marker.inclusiveLeft || span.marker.inclusiveRight) &&
        lineIsHiddenInner(doc, line, sp)) { return true }
  }
}

// Find the height above the given line.
function heightAtLine(lineObj) {
  lineObj = visualLine(lineObj)

  var h = 0, chunk = lineObj.parent
  for (var i = 0; i < chunk.lines.length; ++i) {
    var line = chunk.lines[i]
    if (line == lineObj) { break }
    else { h += line.height }
  }
  for (var p = chunk.parent; p; chunk = p, p = chunk.parent) {
    for (var i$1 = 0; i$1 < p.children.length; ++i$1) {
      var cur = p.children[i$1]
      if (cur == chunk) { break }
      else { h += cur.height }
    }
  }
  return h
}

// Compute the character length of a line, taking into account
// collapsed ranges (see markText) that might hide parts, and join
// other lines onto it.
function lineLength(line) {
  if (line.height == 0) { return 0 }
  var len = line.text.length, merged, cur = line
  while (merged = collapsedSpanAtStart(cur)) {
    var found = merged.find(0, true)
    cur = found.from.line
    len += found.from.ch - found.to.ch
  }
  cur = line
  while (merged = collapsedSpanAtEnd(cur)) {
    var found$1 = merged.find(0, true)
    len -= cur.text.length - found$1.from.ch
    cur = found$1.to.line
    len += cur.text.length - found$1.to.ch
  }
  return len
}

// Find the longest line in the document.
function findMaxLine(cm) {
  var d = cm.display, doc = cm.doc
  d.maxLine = getLine(doc, doc.first)
  d.maxLineLength = lineLength(d.maxLine)
  d.maxLineChanged = true
  doc.iter(function (line) {
    var len = lineLength(line)
    if (len > d.maxLineLength) {
      d.maxLineLength = len
      d.maxLine = line
    }
  })
}

// BIDI HELPERS

function iterateBidiSections(order, from, to, f) {
  if (!order) { return f(from, to, "ltr", 0) }
  var found = false
  for (var i = 0; i < order.length; ++i) {
    var part = order[i]
    if (part.from < to && part.to > from || from == to && part.to == from) {
      f(Math.max(part.from, from), Math.min(part.to, to), part.level == 1 ? "rtl" : "ltr", i)
      found = true
    }
  }
  if (!found) { f(from, to, "ltr") }
}

var bidiOther = null
function getBidiPartAt(order, ch, sticky) {
  var found
  bidiOther = null
  for (var i = 0; i < order.length; ++i) {
    var cur = order[i]
    if (cur.from < ch && cur.to > ch) { return i }
    if (cur.to == ch) {
      if (cur.from != cur.to && sticky == "before") { found = i }
      else { bidiOther = i }
    }
    if (cur.from == ch) {
      if (cur.from != cur.to && sticky != "before") { found = i }
      else { bidiOther = i }
    }
  }
  return found != null ? found : bidiOther
}

// Bidirectional ordering algorithm
// See http://unicode.org/reports/tr9/tr9-13.html for the algorithm
// that this (partially) implements.

// One-char codes used for character types:
// L (L):   Left-to-Right
// R (R):   Right-to-Left
// r (AL):  Right-to-Left Arabic
// 1 (EN):  European Number
// + (ES):  European Number Separator
// % (ET):  European Number Terminator
// n (AN):  Arabic Number
// , (CS):  Common Number Separator
// m (NSM): Non-Spacing Mark
// b (BN):  Boundary Neutral
// s (B):   Paragraph Separator
// t (S):   Segment Separator
// w (WS):  Whitespace
// N (ON):  Other Neutrals

// Returns null if characters are ordered as they appear
// (left-to-right), or an array of sections ({from, to, level}
// objects) in the order in which they occur visually.
var bidiOrdering = (function() {
  // Character types for codepoints 0 to 0xff
  var lowTypes = "bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN"
  // Character types for codepoints 0x600 to 0x6f9
  var arabicTypes = "nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111"
  function charType(code) {
    if (code <= 0xf7) { return lowTypes.charAt(code) }
    else if (0x590 <= code && code <= 0x5f4) { return "R" }
    else if (0x600 <= code && code <= 0x6f9) { return arabicTypes.charAt(code - 0x600) }
    else if (0x6ee <= code && code <= 0x8ac) { return "r" }
    else if (0x2000 <= code && code <= 0x200b) { return "w" }
    else if (code == 0x200c) { return "b" }
    else { return "L" }
  }

  var bidiRE = /[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/
  var isNeutral = /[stwN]/, isStrong = /[LRr]/, countsAsLeft = /[Lb1n]/, countsAsNum = /[1n]/

  function BidiSpan(level, from, to) {
    this.level = level
    this.from = from; this.to = to
  }

  return function(str, direction) {
    var outerType = direction == "ltr" ? "L" : "R"

    if (str.length == 0 || direction == "ltr" && !bidiRE.test(str)) { return false }
    var len = str.length, types = []
    for (var i = 0; i < len; ++i)
      { types.push(charType(str.charCodeAt(i))) }

    // W1. Examine each non-spacing mark (NSM) in the level run, and
    // change the type of the NSM to the type of the previous
    // character. If the NSM is at the start of the level run, it will
    // get the type of sor.
    for (var i$1 = 0, prev = outerType; i$1 < len; ++i$1) {
      var type = types[i$1]
      if (type == "m") { types[i$1] = prev }
      else { prev = type }
    }

    // W2. Search backwards from each instance of a European number
    // until the first strong type (R, L, AL, or sor) is found. If an
    // AL is found, change the type of the European number to Arabic
    // number.
    // W3. Change all ALs to R.
    for (var i$2 = 0, cur = outerType; i$2 < len; ++i$2) {
      var type$1 = types[i$2]
      if (type$1 == "1" && cur == "r") { types[i$2] = "n" }
      else if (isStrong.test(type$1)) { cur = type$1; if (type$1 == "r") { types[i$2] = "R" } }
    }

    // W4. A single European separator between two European numbers
    // changes to a European number. A single common separator between
    // two numbers of the same type changes to that type.
    for (var i$3 = 1, prev$1 = types[0]; i$3 < len - 1; ++i$3) {
      var type$2 = types[i$3]
      if (type$2 == "+" && prev$1 == "1" && types[i$3+1] == "1") { types[i$3] = "1" }
      else if (type$2 == "," && prev$1 == types[i$3+1] &&
               (prev$1 == "1" || prev$1 == "n")) { types[i$3] = prev$1 }
      prev$1 = type$2
    }

    // W5. A sequence of European terminators adjacent to European
    // numbers changes to all European numbers.
    // W6. Otherwise, separators and terminators change to Other
    // Neutral.
    for (var i$4 = 0; i$4 < len; ++i$4) {
      var type$3 = types[i$4]
      if (type$3 == ",") { types[i$4] = "N" }
      else if (type$3 == "%") {
        var end = (void 0)
        for (end = i$4 + 1; end < len && types[end] == "%"; ++end) {}
        var replace = (i$4 && types[i$4-1] == "!") || (end < len && types[end] == "1") ? "1" : "N"
        for (var j = i$4; j < end; ++j) { types[j] = replace }
        i$4 = end - 1
      }
    }

    // W7. Search backwards from each instance of a European number
    // until the first strong type (R, L, or sor) is found. If an L is
    // found, then change the type of the European number to L.
    for (var i$5 = 0, cur$1 = outerType; i$5 < len; ++i$5) {
      var type$4 = types[i$5]
      if (cur$1 == "L" && type$4 == "1") { types[i$5] = "L" }
      else if (isStrong.test(type$4)) { cur$1 = type$4 }
    }

    // N1. A sequence of neutrals takes the direction of the
    // surrounding strong text if the text on both sides has the same
    // direction. European and Arabic numbers act as if they were R in
    // terms of their influence on neutrals. Start-of-level-run (sor)
    // and end-of-level-run (eor) are used at level run boundaries.
    // N2. Any remaining neutrals take the embedding direction.
    for (var i$6 = 0; i$6 < len; ++i$6) {
      if (isNeutral.test(types[i$6])) {
        var end$1 = (void 0)
        for (end$1 = i$6 + 1; end$1 < len && isNeutral.test(types[end$1]); ++end$1) {}
        var before = (i$6 ? types[i$6-1] : outerType) == "L"
        var after = (end$1 < len ? types[end$1] : outerType) == "L"
        var replace$1 = before == after ? (before ? "L" : "R") : outerType
        for (var j$1 = i$6; j$1 < end$1; ++j$1) { types[j$1] = replace$1 }
        i$6 = end$1 - 1
      }
    }

    // Here we depart from the documented algorithm, in order to avoid
    // building up an actual levels array. Since there are only three
    // levels (0, 1, 2) in an implementation that doesn't take
    // explicit embedding into account, we can build up the order on
    // the fly, without following the level-based algorithm.
    var order = [], m
    for (var i$7 = 0; i$7 < len;) {
      if (countsAsLeft.test(types[i$7])) {
        var start = i$7
        for (++i$7; i$7 < len && countsAsLeft.test(types[i$7]); ++i$7) {}
        order.push(new BidiSpan(0, start, i$7))
      } else {
        var pos = i$7, at = order.length
        for (++i$7; i$7 < len && types[i$7] != "L"; ++i$7) {}
        for (var j$2 = pos; j$2 < i$7;) {
          if (countsAsNum.test(types[j$2])) {
            if (pos < j$2) { order.splice(at, 0, new BidiSpan(1, pos, j$2)) }
            var nstart = j$2
            for (++j$2; j$2 < i$7 && countsAsNum.test(types[j$2]); ++j$2) {}
            order.splice(at, 0, new BidiSpan(2, nstart, j$2))
            pos = j$2
          } else { ++j$2 }
        }
        if (pos < i$7) { order.splice(at, 0, new BidiSpan(1, pos, i$7)) }
      }
    }
    if (direction == "ltr") {
      if (order[0].level == 1 && (m = str.match(/^\s+/))) {
        order[0].from = m[0].length
        order.unshift(new BidiSpan(0, 0, m[0].length))
      }
      if (lst(order).level == 1 && (m = str.match(/\s+$/))) {
        lst(order).to -= m[0].length
        order.push(new BidiSpan(0, len - m[0].length, len))
      }
    }

    return direction == "rtl" ? order.reverse() : order
  }
})()

// Get the bidi ordering for the given line (and cache it). Returns
// false for lines that are fully left-to-right, and an array of
// BidiSpan objects otherwise.
function getOrder(line, direction) {
  var order = line.order
  if (order == null) { order = line.order = bidiOrdering(line.text, direction) }
  return order
}

// EVENT HANDLING

// Lightweight event framework. on/off also work on DOM nodes,
// registering native DOM handlers.

var noHandlers = []

var on = function(emitter, type, f) {
  if (emitter.addEventListener) {
    emitter.addEventListener(type, f, false)
  } else if (emitter.attachEvent) {
    emitter.attachEvent("on" + type, f)
  } else {
    var map = emitter._handlers || (emitter._handlers = {})
    map[type] = (map[type] || noHandlers).concat(f)
  }
}

function getHandlers(emitter, type) {
  return emitter._handlers && emitter._handlers[type] || noHandlers
}

function off(emitter, type, f) {
  if (emitter.removeEventListener) {
    emitter.removeEventListener(type, f, false)
  } else if (emitter.detachEvent) {
    emitter.detachEvent("on" + type, f)
  } else {
    var map = emitter._handlers, arr = map && map[type]
    if (arr) {
      var index = indexOf(arr, f)
      if (index > -1)
        { map[type] = arr.slice(0, index).concat(arr.slice(index + 1)) }
    }
  }
}

function signal(emitter, type /*, values...*/) {
  var handlers = getHandlers(emitter, type)
  if (!handlers.length) { return }
  var args = Array.prototype.slice.call(arguments, 2)
  for (var i = 0; i < handlers.length; ++i) { handlers[i].apply(null, args) }
}

// The DOM events that CodeMirror handles can be overridden by
// registering a (non-DOM) handler on the editor for the event name,
// and preventDefault-ing the event in that handler.
function signalDOMEvent(cm, e, override) {
  if (typeof e == "string")
    { e = {type: e, preventDefault: function() { this.defaultPrevented = true }} }
  signal(cm, override || e.type, cm, e)
  return e_defaultPrevented(e) || e.codemirrorIgnore
}

function signalCursorActivity(cm) {
  var arr = cm._handlers && cm._handlers.cursorActivity
  if (!arr) { return }
  var set = cm.curOp.cursorActivityHandlers || (cm.curOp.cursorActivityHandlers = [])
  for (var i = 0; i < arr.length; ++i) { if (indexOf(set, arr[i]) == -1)
    { set.push(arr[i]) } }
}

function hasHandler(emitter, type) {
  return getHandlers(emitter, type).length > 0
}

// Add on and off methods to a constructor's prototype, to make
// registering events on such objects more convenient.
function eventMixin(ctor) {
  ctor.prototype.on = function(type, f) {on(this, type, f)}
  ctor.prototype.off = function(type, f) {off(this, type, f)}
}

// Due to the fact that we still support jurassic IE versions, some
// compatibility wrappers are needed.

function e_preventDefault(e) {
  if (e.preventDefault) { e.preventDefault() }
  else { e.returnValue = false }
}
function e_stopPropagation(e) {
  if (e.stopPropagation) { e.stopPropagation() }
  else { e.cancelBubble = true }
}
function e_defaultPrevented(e) {
  return e.defaultPrevented != null ? e.defaultPrevented : e.returnValue == false
}
function e_stop(e) {e_preventDefault(e); e_stopPropagation(e)}

function e_target(e) {return e.target || e.srcElement}
function e_button(e) {
  var b = e.which
  if (b == null) {
    if (e.button & 1) { b = 1 }
    else if (e.button & 2) { b = 3 }
    else if (e.button & 4) { b = 2 }
  }
  if (mac && e.ctrlKey && b == 1) { b = 3 }
  return b
}

// Detect drag-and-drop
var dragAndDrop = function() {
  // There is *some* kind of drag-and-drop support in IE6-8, but I
  // couldn't get it to work yet.
  if (ie && ie_version < 9) { return false }
  var div = elt('div')
  return "draggable" in div || "dragDrop" in div
}()

var zwspSupported
function zeroWidthElement(measure) {
  if (zwspSupported == null) {
    var test = elt("span", "\u200b")
    removeChildrenAndAdd(measure, elt("span", [test, document.createTextNode("x")]))
    if (measure.firstChild.offsetHeight != 0)
      { zwspSupported = test.offsetWidth <= 1 && test.offsetHeight > 2 && !(ie && ie_version < 8) }
  }
  var node = zwspSupported ? elt("span", "\u200b") :
    elt("span", "\u00a0", null, "display: inline-block; width: 1px; margin-right: -1px")
  node.setAttribute("cm-text", "")
  return node
}

// Feature-detect IE's crummy client rect reporting for bidi text
var badBidiRects
function hasBadBidiRects(measure) {
  if (badBidiRects != null) { return badBidiRects }
  var txt = removeChildrenAndAdd(measure, document.createTextNode("A\u062eA"))
  var r0 = range(txt, 0, 1).getBoundingClientRect()
  var r1 = range(txt, 1, 2).getBoundingClientRect()
  removeChildren(measure)
  if (!r0 || r0.left == r0.right) { return false } // Safari returns null in some cases (#2780)
  return badBidiRects = (r1.right - r0.right < 3)
}

// See if "".split is the broken IE version, if so, provide an
// alternative way to split lines.
var splitLinesAuto = "\n\nb".split(/\n/).length != 3 ? function (string) {
  var pos = 0, result = [], l = string.length
  while (pos <= l) {
    var nl = string.indexOf("\n", pos)
    if (nl == -1) { nl = string.length }
    var line = string.slice(pos, string.charAt(nl - 1) == "\r" ? nl - 1 : nl)
    var rt = line.indexOf("\r")
    if (rt != -1) {
      result.push(line.slice(0, rt))
      pos += rt + 1
    } else {
      result.push(line)
      pos = nl + 1
    }
  }
  return result
} : function (string) { return string.split(/\r\n?|\n/); }

var hasSelection = window.getSelection ? function (te) {
  try { return te.selectionStart != te.selectionEnd }
  catch(e) { return false }
} : function (te) {
  var range
  try {range = te.ownerDocument.selection.createRange()}
  catch(e) {}
  if (!range || range.parentElement() != te) { return false }
  return range.compareEndPoints("StartToEnd", range) != 0
}

var hasCopyEvent = (function () {
  var e = elt("div")
  if ("oncopy" in e) { return true }
  e.setAttribute("oncopy", "return;")
  return typeof e.oncopy == "function"
})()

var badZoomedRects = null
function hasBadZoomedRects(measure) {
  if (badZoomedRects != null) { return badZoomedRects }
  var node = removeChildrenAndAdd(measure, elt("span", "x"))
  var normal = node.getBoundingClientRect()
  var fromRange = range(node, 0, 1).getBoundingClientRect()
  return badZoomedRects = Math.abs(normal.left - fromRange.left) > 1
}

var modes = {};
var mimeModes = {};
// Extra arguments are stored as the mode's dependencies, which is
// used by (legacy) mechanisms like loadmode.js to automatically
// load a mode. (Preferred mechanism is the require/define calls.)
function defineMode(name, mode) {
  if (arguments.length > 2)
    { mode.dependencies = Array.prototype.slice.call(arguments, 2) }
  modes[name] = mode
}

function defineMIME(mime, spec) {
  mimeModes[mime] = spec
}

// Given a MIME type, a {name, ...options} config object, or a name
// string, return a mode config object.
function resolveMode(spec) {
  if (typeof spec == "string" && mimeModes.hasOwnProperty(spec)) {
    spec = mimeModes[spec]
  } else if (spec && typeof spec.name == "string" && mimeModes.hasOwnProperty(spec.name)) {
    var found = mimeModes[spec.name]
    if (typeof found == "string") { found = {name: found} }
    spec = createObj(found, spec)
    spec.name = found.name
  } else if (typeof spec == "string" && /^[\w\-]+\/[\w\-]+\+xml$/.test(spec)) {
    return resolveMode("application/xml")
  } else if (typeof spec == "string" && /^[\w\-]+\/[\w\-]+\+json$/.test(spec)) {
    return resolveMode("application/json")
  }
  if (typeof spec == "string") { return {name: spec} }
  else { return spec || {name: "null"} }
}

// Given a mode spec (anything that resolveMode accepts), find and
// initialize an actual mode object.
function getMode(options, spec) {
  spec = resolveMode(spec)
  var mfactory = modes[spec.name]
  if (!mfactory) { return getMode(options, "text/plain") }
  var modeObj = mfactory(options, spec)
  if (modeExtensions.hasOwnProperty(spec.name)) {
    var exts = modeExtensions[spec.name]
    for (var prop in exts) {
      if (!exts.hasOwnProperty(prop)) { continue }
      if (modeObj.hasOwnProperty(prop)) { modeObj["_" + prop] = modeObj[prop] }
      modeObj[prop] = exts[prop]
    }
  }
  modeObj.name = spec.name
  if (spec.helperType) { modeObj.helperType = spec.helperType }
  if (spec.modeProps) { for (var prop$1 in spec.modeProps)
    { modeObj[prop$1] = spec.modeProps[prop$1] } }

  return modeObj
}

// This can be used to attach properties to mode objects from
// outside the actual mode definition.
var modeExtensions = {}
function extendMode(mode, properties) {
  var exts = modeExtensions.hasOwnProperty(mode) ? modeExtensions[mode] : (modeExtensions[mode] = {})
  copyObj(properties, exts)
}

function copyState(mode, state) {
  if (state === true) { return state }
  if (mode.copyState) { return mode.copyState(state) }
  var nstate = {}
  for (var n in state) {
    var val = state[n]
    if (val instanceof Array) { val = val.concat([]) }
    nstate[n] = val
  }
  return nstate
}

// Given a mode and a state (for that mode), find the inner mode and
// state at the position that the state refers to.
function innerMode(mode, state) {
  var info
  while (mode.innerMode) {
    info = mode.innerMode(state)
    if (!info || info.mode == mode) { break }
    state = info.state
    mode = info.mode
  }
  return info || {mode: mode, state: state}
}

function startState(mode, a1, a2) {
  return mode.startState ? mode.startState(a1, a2) : true
}

// STRING STREAM

// Fed to the mode parsers, provides helper functions to make
// parsers more succinct.

var StringStream = function(string, tabSize, lineOracle) {
  this.pos = this.start = 0
  this.string = string
  this.tabSize = tabSize || 8
  this.lastColumnPos = this.lastColumnValue = 0
  this.lineStart = 0
  this.lineOracle = lineOracle
};

StringStream.prototype.eol = function () {return this.pos >= this.string.length};
StringStream.prototype.sol = function () {return this.pos == this.lineStart};
StringStream.prototype.peek = function () {return this.string.charAt(this.pos) || undefined};
StringStream.prototype.next = function () {
  if (this.pos < this.string.length)
    { return this.string.charAt(this.pos++) }
};
StringStream.prototype.eat = function (match) {
  var ch = this.string.charAt(this.pos)
  var ok
  if (typeof match == "string") { ok = ch == match }
  else { ok = ch && (match.test ? match.test(ch) : match(ch)) }
  if (ok) {++this.pos; return ch}
};
StringStream.prototype.eatWhile = function (match) {
  var start = this.pos
  while (this.eat(match)){}
  return this.pos > start
};
StringStream.prototype.eatSpace = function () {
    var this$1 = this;

  var start = this.pos
  while (/[\s\u00a0]/.test(this.string.charAt(this.pos))) { ++this$1.pos }
  return this.pos > start
};
StringStream.prototype.skipToEnd = function () {this.pos = this.string.length};
StringStream.prototype.skipTo = function (ch) {
  var found = this.string.indexOf(ch, this.pos)
  if (found > -1) {this.pos = found; return true}
};
StringStream.prototype.backUp = function (n) {this.pos -= n};
StringStream.prototype.column = function () {
  if (this.lastColumnPos < this.start) {
    this.lastColumnValue = countColumn(this.string, this.start, this.tabSize, this.lastColumnPos, this.lastColumnValue)
    this.lastColumnPos = this.start
  }
  return this.lastColumnValue - (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0)
};
StringStream.prototype.indentation = function () {
  return countColumn(this.string, null, this.tabSize) -
    (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0)
};
StringStream.prototype.match = function (pattern, consume, caseInsensitive) {
  if (typeof pattern == "string") {
    var cased = function (str) { return caseInsensitive ? str.toLowerCase() : str; }
    var substr = this.string.substr(this.pos, pattern.length)
    if (cased(substr) == cased(pattern)) {
      if (consume !== false) { this.pos += pattern.length }
      return true
    }
  } else {
    var match = this.string.slice(this.pos).match(pattern)
    if (match && match.index > 0) { return null }
    if (match && consume !== false) { this.pos += match[0].length }
    return match
  }
};
StringStream.prototype.current = function (){return this.string.slice(this.start, this.pos)};
StringStream.prototype.hideFirstChars = function (n, inner) {
  this.lineStart += n
  try { return inner() }
  finally { this.lineStart -= n }
};
StringStream.prototype.lookAhead = function (n) {
  var oracle = this.lineOracle
  return oracle && oracle.lookAhead(n)
};
StringStream.prototype.baseToken = function () {
  var oracle = this.lineOracle
  return oracle && oracle.baseToken(this.pos)
};

var SavedContext = function(state, lookAhead) {
  this.state = state
  this.lookAhead = lookAhead
};

var Context = function(doc, state, line, lookAhead) {
  this.state = state
  this.doc = doc
  this.line = line
  this.maxLookAhead = lookAhead || 0
  this.baseTokens = null
  this.baseTokenPos = 1
};

Context.prototype.lookAhead = function (n) {
  var line = this.doc.getLine(this.line + n)
  if (line != null && n > this.maxLookAhead) { this.maxLookAhead = n }
  return line
};

Context.prototype.baseToken = function (n) {
    var this$1 = this;

  if (!this.baseTokens) { return null }
  while (this.baseTokens[this.baseTokenPos] <= n)
    { this$1.baseTokenPos += 2 }
  var type = this.baseTokens[this.baseTokenPos + 1]
  return {type: type && type.replace(/( |^)overlay .*/, ""),
          size: this.baseTokens[this.baseTokenPos] - n}
};

Context.prototype.nextLine = function () {
  this.line++
  if (this.maxLookAhead > 0) { this.maxLookAhead-- }
};

Context.fromSaved = function (doc, saved, line) {
  if (saved instanceof SavedContext)
    { return new Context(doc, copyState(doc.mode, saved.state), line, saved.lookAhead) }
  else
    { return new Context(doc, copyState(doc.mode, saved), line) }
};

Context.prototype.save = function (copy) {
  var state = copy !== false ? copyState(this.doc.mode, this.state) : this.state
  return this.maxLookAhead > 0 ? new SavedContext(state, this.maxLookAhead) : state
};


// Compute a style array (an array starting with a mode generation
// -- for invalidation -- followed by pairs of end positions and
// style strings), which is used to highlight the tokens on the
// line.
function highlightLine(cm, line, context, forceToEnd) {
  // A styles array always starts with a number identifying the
  // mode/overlays that it is based on (for easy invalidation).
  var st = [cm.state.modeGen], lineClasses = {}
  // Compute the base array of styles
  runMode(cm, line.text, cm.doc.mode, context, function (end, style) { return st.push(end, style); },
          lineClasses, forceToEnd)
  var state = context.state

  // Run overlays, adjust style array.
  var loop = function ( o ) {
    context.baseTokens = st
    var overlay = cm.state.overlays[o], i = 1, at = 0
    context.state = true
    runMode(cm, line.text, overlay.mode, context, function (end, style) {
      var start = i
      // Ensure there's a token end at the current position, and that i points at it
      while (at < end) {
        var i_end = st[i]
        if (i_end > end)
          { st.splice(i, 1, end, st[i+1], i_end) }
        i += 2
        at = Math.min(end, i_end)
      }
      if (!style) { return }
      if (overlay.opaque) {
        st.splice(start, i - start, end, "overlay " + style)
        i = start + 2
      } else {
        for (; start < i; start += 2) {
          var cur = st[start+1]
          st[start+1] = (cur ? cur + " " : "") + "overlay " + style
        }
      }
    }, lineClasses)
    context.state = state
    context.baseTokens = null
    context.baseTokenPos = 1
  };

  for (var o = 0; o < cm.state.overlays.length; ++o) loop( o );

  return {styles: st, classes: lineClasses.bgClass || lineClasses.textClass ? lineClasses : null}
}

function getLineStyles(cm, line, updateFrontier) {
  if (!line.styles || line.styles[0] != cm.state.modeGen) {
    var context = getContextBefore(cm, lineNo(line))
    var resetState = line.text.length > cm.options.maxHighlightLength && copyState(cm.doc.mode, context.state)
    var result = highlightLine(cm, line, context)
    if (resetState) { context.state = resetState }
    line.stateAfter = context.save(!resetState)
    line.styles = result.styles
    if (result.classes) { line.styleClasses = result.classes }
    else if (line.styleClasses) { line.styleClasses = null }
    if (updateFrontier === cm.doc.highlightFrontier)
      { cm.doc.modeFrontier = Math.max(cm.doc.modeFrontier, ++cm.doc.highlightFrontier) }
  }
  return line.styles
}

function getContextBefore(cm, n, precise) {
  var doc = cm.doc, display = cm.display
  if (!doc.mode.startState) { return new Context(doc, true, n) }
  var start = findStartLine(cm, n, precise)
  var saved = start > doc.first && getLine(doc, start - 1).stateAfter
  var context = saved ? Context.fromSaved(doc, saved, start) : new Context(doc, startState(doc.mode), start)

  doc.iter(start, n, function (line) {
    processLine(cm, line.text, context)
    var pos = context.line
    line.stateAfter = pos == n - 1 || pos % 5 == 0 || pos >= display.viewFrom && pos < display.viewTo ? context.save() : null
    context.nextLine()
  })
  if (precise) { doc.modeFrontier = context.line }
  return context
}

// Lightweight form of highlight -- proceed over this line and
// update state, but don't save a style array. Used for lines that
// aren't currently visible.
function processLine(cm, text, context, startAt) {
  var mode = cm.doc.mode
  var stream = new StringStream(text, cm.options.tabSize, context)
  stream.start = stream.pos = startAt || 0
  if (text == "") { callBlankLine(mode, context.state) }
  while (!stream.eol()) {
    readToken(mode, stream, context.state)
    stream.start = stream.pos
  }
}

function callBlankLine(mode, state) {
  if (mode.blankLine) { return mode.blankLine(state) }
  if (!mode.innerMode) { return }
  var inner = innerMode(mode, state)
  if (inner.mode.blankLine) { return inner.mode.blankLine(inner.state) }
}

function readToken(mode, stream, state, inner) {
  for (var i = 0; i < 10; i++) {
    if (inner) { inner[0] = innerMode(mode, state).mode }
    var style = mode.token(stream, state)
    if (stream.pos > stream.start) { return style }
  }
  throw new Error("Mode " + mode.name + " failed to advance stream.")
}

var Token = function(stream, type, state) {
  this.start = stream.start; this.end = stream.pos
  this.string = stream.current()
  this.type = type || null
  this.state = state
};

// Utility for getTokenAt and getLineTokens
function takeToken(cm, pos, precise, asArray) {
  var doc = cm.doc, mode = doc.mode, style
  pos = clipPos(doc, pos)
  var line = getLine(doc, pos.line), context = getContextBefore(cm, pos.line, precise)
  var stream = new StringStream(line.text, cm.options.tabSize, context), tokens
  if (asArray) { tokens = [] }
  while ((asArray || stream.pos < pos.ch) && !stream.eol()) {
    stream.start = stream.pos
    style = readToken(mode, stream, context.state)
    if (asArray) { tokens.push(new Token(stream, style, copyState(doc.mode, context.state))) }
  }
  return asArray ? tokens : new Token(stream, style, context.state)
}

function extractLineClasses(type, output) {
  if (type) { for (;;) {
    var lineClass = type.match(/(?:^|\s+)line-(background-)?(\S+)/)
    if (!lineClass) { break }
    type = type.slice(0, lineClass.index) + type.slice(lineClass.index + lineClass[0].length)
    var prop = lineClass[1] ? "bgClass" : "textClass"
    if (output[prop] == null)
      { output[prop] = lineClass[2] }
    else if (!(new RegExp("(?:^|\s)" + lineClass[2] + "(?:$|\s)")).test(output[prop]))
      { output[prop] += " " + lineClass[2] }
  } }
  return type
}

// Run the given mode's parser over a line, calling f for each token.
function runMode(cm, text, mode, context, f, lineClasses, forceToEnd) {
  var flattenSpans = mode.flattenSpans
  if (flattenSpans == null) { flattenSpans = cm.options.flattenSpans }
  var curStart = 0, curStyle = null
  var stream = new StringStream(text, cm.options.tabSize, context), style
  var inner = cm.options.addModeClass && [null]
  if (text == "") { extractLineClasses(callBlankLine(mode, context.state), lineClasses) }
  while (!stream.eol()) {
    if (stream.pos > cm.options.maxHighlightLength) {
      flattenSpans = false
      if (forceToEnd) { processLine(cm, text, context, stream.pos) }
      stream.pos = text.length
      style = null
    } else {
      style = extractLineClasses(readToken(mode, stream, context.state, inner), lineClasses)
    }
    if (inner) {
      var mName = inner[0].name
      if (mName) { style = "m-" + (style ? mName + " " + style : mName) }
    }
    if (!flattenSpans || curStyle != style) {
      while (curStart < stream.start) {
        curStart = Math.min(stream.start, curStart + 5000)
        f(curStart, curStyle)
      }
      curStyle = style
    }
    stream.start = stream.pos
  }
  while (curStart < stream.pos) {
    // Webkit seems to refuse to render text nodes longer than 57444
    // characters, and returns inaccurate measurements in nodes
    // starting around 5000 chars.
    var pos = Math.min(stream.pos, curStart + 5000)
    f(pos, curStyle)
    curStart = pos
  }
}

// Finds the line to start with when starting a parse. Tries to
// find a line with a stateAfter, so that it can start with a
// valid state. If that fails, it returns the line with the
// smallest indentation, which tends to need the least context to
// parse correctly.
function findStartLine(cm, n, precise) {
  var minindent, minline, doc = cm.doc
  var lim = precise ? -1 : n - (cm.doc.mode.innerMode ? 1000 : 100)
  for (var search = n; search > lim; --search) {
    if (search <= doc.first) { return doc.first }
    var line = getLine(doc, search - 1), after = line.stateAfter
    if (after && (!precise || search + (after instanceof SavedContext ? after.lookAhead : 0) <= doc.modeFrontier))
      { return search }
    var indented = countColumn(line.text, null, cm.options.tabSize)
    if (minline == null || minindent > indented) {
      minline = search - 1
      minindent = indented
    }
  }
  return minline
}

function retreatFrontier(doc, n) {
  doc.modeFrontier = Math.min(doc.modeFrontier, n)
  if (doc.highlightFrontier < n - 10) { return }
  var start = doc.first
  for (var line = n - 1; line > start; line--) {
    var saved = getLine(doc, line).stateAfter
    // change is on 3
    // state on line 1 looked ahead 2 -- so saw 3
    // test 1 + 2 < 3 should cover this
    if (saved && (!(saved instanceof SavedContext) || line + saved.lookAhead < n)) {
      start = line + 1
      break
    }
  }
  doc.highlightFrontier = Math.min(doc.highlightFrontier, start)
}

// LINE DATA STRUCTURE

// Line objects. These hold state related to a line, including
// highlighting info (the styles array).
var Line = function(text, markedSpans, estimateHeight) {
  this.text = text
  attachMarkedSpans(this, markedSpans)
  this.height = estimateHeight ? estimateHeight(this) : 1
};

Line.prototype.lineNo = function () { return lineNo(this) };
eventMixin(Line)

// Change the content (text, markers) of a line. Automatically
// invalidates cached information and tries to re-estimate the
// line's height.
function updateLine(line, text, markedSpans, estimateHeight) {
  line.text = text
  if (line.stateAfter) { line.stateAfter = null }
  if (line.styles) { line.styles = null }
  if (line.order != null) { line.order = null }
  detachMarkedSpans(line)
  attachMarkedSpans(line, markedSpans)
  var estHeight = estimateHeight ? estimateHeight(line) : 1
  if (estHeight != line.height) { updateLineHeight(line, estHeight) }
}

// Detach a line from the document tree and its markers.
function cleanUpLine(line) {
  line.parent = null
  detachMarkedSpans(line)
}

// Convert a style as returned by a mode (either null, or a string
// containing one or more styles) to a CSS style. This is cached,
// and also looks for line-wide styles.
var styleToClassCache = {};
var styleToClassCacheWithMode = {};
function interpretTokenStyle(style, options) {
  if (!style || /^\s*$/.test(style)) { return null }
  var cache = options.addModeClass ? styleToClassCacheWithMode : styleToClassCache
  return cache[style] ||
    (cache[style] = style.replace(/\S+/g, "cm-$&"))
}

// Render the DOM representation of the text of a line. Also builds
// up a 'line map', which points at the DOM nodes that represent
// specific stretches of text, and is used by the measuring code.
// The returned object contains the DOM node, this map, and
// information about line-wide styles that were set by the mode.
function buildLineContent(cm, lineView) {
  // The padding-right forces the element to have a 'border', which
  // is needed on Webkit to be able to get line-level bounding
  // rectangles for it (in measureChar).
  var content = eltP("span", null, null, webkit ? "padding-right: .1px" : null)
  var builder = {pre: eltP("pre", [content], "CodeMirror-line"), content: content,
                 col: 0, pos: 0, cm: cm,
                 trailingSpace: false,
                 splitSpaces: (ie || webkit) && cm.getOption("lineWrapping")}
  lineView.measure = {}

  // Iterate over the logical lines that make up this visual line.
  for (var i = 0; i <= (lineView.rest ? lineView.rest.length : 0); i++) {
    var line = i ? lineView.rest[i - 1] : lineView.line, order = (void 0)
    builder.pos = 0
    builder.addToken = buildToken
    // Optionally wire in some hacks into the token-rendering
    // algorithm, to deal with browser quirks.
    if (hasBadBidiRects(cm.display.measure) && (order = getOrder(line, cm.doc.direction)))
      { builder.addToken = buildTokenBadBidi(builder.addToken, order) }
    builder.map = []
    var allowFrontierUpdate = lineView != cm.display.externalMeasured && lineNo(line)
    insertLineContent(line, builder, getLineStyles(cm, line, allowFrontierUpdate))
    if (line.styleClasses) {
      if (line.styleClasses.bgClass)
        { builder.bgClass = joinClasses(line.styleClasses.bgClass, builder.bgClass || "") }
      if (line.styleClasses.textClass)
        { builder.textClass = joinClasses(line.styleClasses.textClass, builder.textClass || "") }
    }

    // Ensure at least a single node is present, for measuring.
    if (builder.map.length == 0)
      { builder.map.push(0, 0, builder.content.appendChild(zeroWidthElement(cm.display.measure))) }

    // Store the map and a cache object for the current logical line
    if (i == 0) {
      lineView.measure.map = builder.map
      lineView.measure.cache = {}
    } else {
      ;(lineView.measure.maps || (lineView.measure.maps = [])).push(builder.map)
      ;(lineView.measure.caches || (lineView.measure.caches = [])).push({})
    }
  }

  // See issue #2901
  if (webkit) {
    var last = builder.content.lastChild
    if (/\bcm-tab\b/.test(last.className) || (last.querySelector && last.querySelector(".cm-tab")))
      { builder.content.className = "cm-tab-wrap-hack" }
  }

  signal(cm, "renderLine", cm, lineView.line, builder.pre)
  if (builder.pre.className)
    { builder.textClass = joinClasses(builder.pre.className, builder.textClass || "") }

  return builder
}

function defaultSpecialCharPlaceholder(ch) {
  var token = elt("span", "\u2022", "cm-invalidchar")
  token.title = "\\u" + ch.charCodeAt(0).toString(16)
  token.setAttribute("aria-label", token.title)
  return token
}

// Build up the DOM representation for a single token, and add it to
// the line map. Takes care to render special characters separately.
function buildToken(builder, text, style, startStyle, endStyle, title, css) {
  if (!text) { return }
  var displayText = builder.splitSpaces ? splitSpaces(text, builder.trailingSpace) : text
  var special = builder.cm.state.specialChars, mustWrap = false
  var content
  if (!special.test(text)) {
    builder.col += text.length
    content = document.createTextNode(displayText)
    builder.map.push(builder.pos, builder.pos + text.length, content)
    if (ie && ie_version < 9) { mustWrap = true }
    builder.pos += text.length
  } else {
    content = document.createDocumentFragment()
    var pos = 0
    while (true) {
      special.lastIndex = pos
      var m = special.exec(text)
      var skipped = m ? m.index - pos : text.length - pos
      if (skipped) {
        var txt = document.createTextNode(displayText.slice(pos, pos + skipped))
        if (ie && ie_version < 9) { content.appendChild(elt("span", [txt])) }
        else { content.appendChild(txt) }
        builder.map.push(builder.pos, builder.pos + skipped, txt)
        builder.col += skipped
        builder.pos += skipped
      }
      if (!m) { break }
      pos += skipped + 1
      var txt$1 = (void 0)
      if (m[0] == "\t") {
        var tabSize = builder.cm.options.tabSize, tabWidth = tabSize - builder.col % tabSize
        txt$1 = content.appendChild(elt("span", spaceStr(tabWidth), "cm-tab"))
        txt$1.setAttribute("role", "presentation")
        txt$1.setAttribute("cm-text", "\t")
        builder.col += tabWidth
      } else if (m[0] == "\r" || m[0] == "\n") {
        txt$1 = content.appendChild(elt("span", m[0] == "\r" ? "\u240d" : "\u2424", "cm-invalidchar"))
        txt$1.setAttribute("cm-text", m[0])
        builder.col += 1
      } else {
        txt$1 = builder.cm.options.specialCharPlaceholder(m[0])
        txt$1.setAttribute("cm-text", m[0])
        if (ie && ie_version < 9) { content.appendChild(elt("span", [txt$1])) }
        else { content.appendChild(txt$1) }
        builder.col += 1
      }
      builder.map.push(builder.pos, builder.pos + 1, txt$1)
      builder.pos++
    }
  }
  builder.trailingSpace = displayText.charCodeAt(text.length - 1) == 32
  if (style || startStyle || endStyle || mustWrap || css) {
    var fullStyle = style || ""
    if (startStyle) { fullStyle += startStyle }
    if (endStyle) { fullStyle += endStyle }
    var token = elt("span", [content], fullStyle, css)
    if (title) { token.title = title }
    return builder.content.appendChild(token)
  }
  builder.content.appendChild(content)
}

function splitSpaces(text, trailingBefore) {
  if (text.length > 1 && !/  /.test(text)) { return text }
  var spaceBefore = trailingBefore, result = ""
  for (var i = 0; i < text.length; i++) {
    var ch = text.charAt(i)
    if (ch == " " && spaceBefore && (i == text.length - 1 || text.charCodeAt(i + 1) == 32))
      { ch = "\u00a0" }
    result += ch
    spaceBefore = ch == " "
  }
  return result
}

// Work around nonsense dimensions being reported for stretches of
// right-to-left text.
function buildTokenBadBidi(inner, order) {
  return function (builder, text, style, startStyle, endStyle, title, css) {
    style = style ? style + " cm-force-border" : "cm-force-border"
    var start = builder.pos, end = start + text.length
    for (;;) {
      // Find the part that overlaps with the start of this text
      var part = (void 0)
      for (var i = 0; i < order.length; i++) {
        part = order[i]
        if (part.to > start && part.from <= start) { break }
      }
      if (part.to >= end) { return inner(builder, text, style, startStyle, endStyle, title, css) }
      inner(builder, text.slice(0, part.to - start), style, startStyle, null, title, css)
      startStyle = null
      text = text.slice(part.to - start)
      start = part.to
    }
  }
}

function buildCollapsedSpan(builder, size, marker, ignoreWidget) {
  var widget = !ignoreWidget && marker.widgetNode
  if (widget) { builder.map.push(builder.pos, builder.pos + size, widget) }
  if (!ignoreWidget && builder.cm.display.input.needsContentAttribute) {
    if (!widget)
      { widget = builder.content.appendChild(document.createElement("span")) }
    widget.setAttribute("cm-marker", marker.id)
  }
  if (widget) {
    builder.cm.display.input.setUneditable(widget)
    builder.content.appendChild(widget)
  }
  builder.pos += size
  builder.trailingSpace = false
}

// Outputs a number of spans to make up a line, taking highlighting
// and marked text into account.
function insertLineContent(line, builder, styles) {
  var spans = line.markedSpans, allText = line.text, at = 0
  if (!spans) {
    for (var i$1 = 1; i$1 < styles.length; i$1+=2)
      { builder.addToken(builder, allText.slice(at, at = styles[i$1]), interpretTokenStyle(styles[i$1+1], builder.cm.options)) }
    return
  }

  var len = allText.length, pos = 0, i = 1, text = "", style, css
  var nextChange = 0, spanStyle, spanEndStyle, spanStartStyle, title, collapsed
  for (;;) {
    if (nextChange == pos) { // Update current marker set
      spanStyle = spanEndStyle = spanStartStyle = title = css = ""
      collapsed = null; nextChange = Infinity
      var foundBookmarks = [], endStyles = (void 0)
      for (var j = 0; j < spans.length; ++j) {
        var sp = spans[j], m = sp.marker
        if (m.type == "bookmark" && sp.from == pos && m.widgetNode) {
          foundBookmarks.push(m)
        } else if (sp.from <= pos && (sp.to == null || sp.to > pos || m.collapsed && sp.to == pos && sp.from == pos)) {
          if (sp.to != null && sp.to != pos && nextChange > sp.to) {
            nextChange = sp.to
            spanEndStyle = ""
          }
          if (m.className) { spanStyle += " " + m.className }
          if (m.css) { css = (css ? css + ";" : "") + m.css }
          if (m.startStyle && sp.from == pos) { spanStartStyle += " " + m.startStyle }
          if (m.endStyle && sp.to == nextChange) { (endStyles || (endStyles = [])).push(m.endStyle, sp.to) }
          if (m.title && !title) { title = m.title }
          if (m.collapsed && (!collapsed || compareCollapsedMarkers(collapsed.marker, m) < 0))
            { collapsed = sp }
        } else if (sp.from > pos && nextChange > sp.from) {
          nextChange = sp.from
        }
      }
      if (endStyles) { for (var j$1 = 0; j$1 < endStyles.length; j$1 += 2)
        { if (endStyles[j$1 + 1] == nextChange) { spanEndStyle += " " + endStyles[j$1] } } }

      if (!collapsed || collapsed.from == pos) { for (var j$2 = 0; j$2 < foundBookmarks.length; ++j$2)
        { buildCollapsedSpan(builder, 0, foundBookmarks[j$2]) } }
      if (collapsed && (collapsed.from || 0) == pos) {
        buildCollapsedSpan(builder, (collapsed.to == null ? len + 1 : collapsed.to) - pos,
                           collapsed.marker, collapsed.from == null)
        if (collapsed.to == null) { return }
        if (collapsed.to == pos) { collapsed = false }
      }
    }
    if (pos >= len) { break }

    var upto = Math.min(len, nextChange)
    while (true) {
      if (text) {
        var end = pos + text.length
        if (!collapsed) {
          var tokenText = end > upto ? text.slice(0, upto - pos) : text
          builder.addToken(builder, tokenText, style ? style + spanStyle : spanStyle,
                           spanStartStyle, pos + tokenText.length == nextChange ? spanEndStyle : "", title, css)
        }
        if (end >= upto) {text = text.slice(upto - pos); pos = upto; break}
        pos = end
        spanStartStyle = ""
      }
      text = allText.slice(at, at = styles[i++])
      style = interpretTokenStyle(styles[i++], builder.cm.options)
    }
  }
}


// These objects are used to represent the visible (currently drawn)
// part of the document. A LineView may correspond to multiple
// logical lines, if those are connected by collapsed ranges.
function LineView(doc, line, lineN) {
  // The starting line
  this.line = line
  // Continuing lines, if any
  this.rest = visualLineContinued(line)
  // Number of logical lines in this visual line
  this.size = this.rest ? lineNo(lst(this.rest)) - lineN + 1 : 1
  this.node = this.text = null
  this.hidden = lineIsHidden(doc, line)
}

// Create a range of LineView objects for the given lines.
function buildViewArray(cm, from, to) {
  var array = [], nextPos
  for (var pos = from; pos < to; pos = nextPos) {
    var view = new LineView(cm.doc, getLine(cm.doc, pos), pos)
    nextPos = pos + view.size
    array.push(view)
  }
  return array
}

var operationGroup = null

function pushOperation(op) {
  if (operationGroup) {
    operationGroup.ops.push(op)
  } else {
    op.ownsGroup = operationGroup = {
      ops: [op],
      delayedCallbacks: []
    }
  }
}

function fireCallbacksForOps(group) {
  // Calls delayed callbacks and cursorActivity handlers until no
  // new ones appear
  var callbacks = group.delayedCallbacks, i = 0
  do {
    for (; i < callbacks.length; i++)
      { callbacks[i].call(null) }
    for (var j = 0; j < group.ops.length; j++) {
      var op = group.ops[j]
      if (op.cursorActivityHandlers)
        { while (op.cursorActivityCalled < op.cursorActivityHandlers.length)
          { op.cursorActivityHandlers[op.cursorActivityCalled++].call(null, op.cm) } }
    }
  } while (i < callbacks.length)
}

function finishOperation(op, endCb) {
  var group = op.ownsGroup
  if (!group) { return }

  try { fireCallbacksForOps(group) }
  finally {
    operationGroup = null
    endCb(group)
  }
}

var orphanDelayedCallbacks = null

// Often, we want to signal events at a point where we are in the
// middle of some work, but don't want the handler to start calling
// other methods on the editor, which might be in an inconsistent
// state or simply not expect any other events to happen.
// signalLater looks whether there are any handlers, and schedules
// them to be executed when the last operation ends, or, if no
// operation is active, when a timeout fires.
function signalLater(emitter, type /*, values...*/) {
  var arr = getHandlers(emitter, type)
  if (!arr.length) { return }
  var args = Array.prototype.slice.call(arguments, 2), list
  if (operationGroup) {
    list = operationGroup.delayedCallbacks
  } else if (orphanDelayedCallbacks) {
    list = orphanDelayedCallbacks
  } else {
    list = orphanDelayedCallbacks = []
    setTimeout(fireOrphanDelayed, 0)
  }
  var loop = function ( i ) {
    list.push(function () { return arr[i].apply(null, args); })
  };

  for (var i = 0; i < arr.length; ++i)
    loop( i );
}

function fireOrphanDelayed() {
  var delayed = orphanDelayedCallbacks
  orphanDelayedCallbacks = null
  for (var i = 0; i < delayed.length; ++i) { delayed[i]() }
}

// When an aspect of a line changes, a string is added to
// lineView.changes. This updates the relevant part of the line's
// DOM structure.
function updateLineForChanges(cm, lineView, lineN, dims) {
  for (var j = 0; j < lineView.changes.length; j++) {
    var type = lineView.changes[j]
    if (type == "text") { updateLineText(cm, lineView) }
    else if (type == "gutter") { updateLineGutter(cm, lineView, lineN, dims) }
    else if (type == "class") { updateLineClasses(cm, lineView) }
    else if (type == "widget") { updateLineWidgets(cm, lineView, dims) }
  }
  lineView.changes = null
}

// Lines with gutter elements, widgets or a background class need to
// be wrapped, and have the extra elements added to the wrapper div
function ensureLineWrapped(lineView) {
  if (lineView.node == lineView.text) {
    lineView.node = elt("div", null, null, "position: relative")
    if (lineView.text.parentNode)
      { lineView.text.parentNode.replaceChild(lineView.node, lineView.text) }
    lineView.node.appendChild(lineView.text)
    if (ie && ie_version < 8) { lineView.node.style.zIndex = 2 }
  }
  return lineView.node
}

function updateLineBackground(cm, lineView) {
  var cls = lineView.bgClass ? lineView.bgClass + " " + (lineView.line.bgClass || "") : lineView.line.bgClass
  if (cls) { cls += " CodeMirror-linebackground" }
  if (lineView.background) {
    if (cls) { lineView.background.className = cls }
    else { lineView.background.parentNode.removeChild(lineView.background); lineView.background = null }
  } else if (cls) {
    var wrap = ensureLineWrapped(lineView)
    lineView.background = wrap.insertBefore(elt("div", null, cls), wrap.firstChild)
    cm.display.input.setUneditable(lineView.background)
  }
}

// Wrapper around buildLineContent which will reuse the structure
// in display.externalMeasured when possible.
function getLineContent(cm, lineView) {
  var ext = cm.display.externalMeasured
  if (ext && ext.line == lineView.line) {
    cm.display.externalMeasured = null
    lineView.measure = ext.measure
    return ext.built
  }
  return buildLineContent(cm, lineView)
}

// Redraw the line's text. Interacts with the background and text
// classes because the mode may output tokens that influence these
// classes.
function updateLineText(cm, lineView) {
  var cls = lineView.text.className
  var built = getLineContent(cm, lineView)
  if (lineView.text == lineView.node) { lineView.node = built.pre }
  lineView.text.parentNode.replaceChild(built.pre, lineView.text)
  lineView.text = built.pre
  if (built.bgClass != lineView.bgClass || built.textClass != lineView.textClass) {
    lineView.bgClass = built.bgClass
    lineView.textClass = built.textClass
    updateLineClasses(cm, lineView)
  } else if (cls) {
    lineView.text.className = cls
  }
}

function updateLineClasses(cm, lineView) {
  updateLineBackground(cm, lineView)
  if (lineView.line.wrapClass)
    { ensureLineWrapped(lineView).className = lineView.line.wrapClass }
  else if (lineView.node != lineView.text)
    { lineView.node.className = "" }
  var textClass = lineView.textClass ? lineView.textClass + " " + (lineView.line.textClass || "") : lineView.line.textClass
  lineView.text.className = textClass || ""
}

function updateLineGutter(cm, lineView, lineN, dims) {
  if (lineView.gutter) {
    lineView.node.removeChild(lineView.gutter)
    lineView.gutter = null
  }
  if (lineView.gutterBackground) {
    lineView.node.removeChild(lineView.gutterBackground)
    lineView.gutterBackground = null
  }
  if (lineView.line.gutterClass) {
    var wrap = ensureLineWrapped(lineView)
    lineView.gutterBackground = elt("div", null, "CodeMirror-gutter-background " + lineView.line.gutterClass,
                                    ("left: " + (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px; width: " + (dims.gutterTotalWidth) + "px"))
    cm.display.input.setUneditable(lineView.gutterBackground)
    wrap.insertBefore(lineView.gutterBackground, lineView.text)
  }
  var markers = lineView.line.gutterMarkers
  if (cm.options.lineNumbers || markers) {
    var wrap$1 = ensureLineWrapped(lineView)
    var gutterWrap = lineView.gutter = elt("div", null, "CodeMirror-gutter-wrapper", ("left: " + (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px"))
    cm.display.input.setUneditable(gutterWrap)
    wrap$1.insertBefore(gutterWrap, lineView.text)
    if (lineView.line.gutterClass)
      { gutterWrap.className += " " + lineView.line.gutterClass }
    if (cm.options.lineNumbers && (!markers || !markers["CodeMirror-linenumbers"]))
      { lineView.lineNumber = gutterWrap.appendChild(
        elt("div", lineNumberFor(cm.options, lineN),
            "CodeMirror-linenumber CodeMirror-gutter-elt",
            ("left: " + (dims.gutterLeft["CodeMirror-linenumbers"]) + "px; width: " + (cm.display.lineNumInnerWidth) + "px"))) }
    if (markers) { for (var k = 0; k < cm.options.gutters.length; ++k) {
      var id = cm.options.gutters[k], found = markers.hasOwnProperty(id) && markers[id]
      if (found)
        { gutterWrap.appendChild(elt("div", [found], "CodeMirror-gutter-elt",
                                   ("left: " + (dims.gutterLeft[id]) + "px; width: " + (dims.gutterWidth[id]) + "px"))) }
    } }
  }
}

function updateLineWidgets(cm, lineView, dims) {
  if (lineView.alignable) { lineView.alignable = null }
  for (var node = lineView.node.firstChild, next = (void 0); node; node = next) {
    next = node.nextSibling
    if (node.className == "CodeMirror-linewidget")
      { lineView.node.removeChild(node) }
  }
  insertLineWidgets(cm, lineView, dims)
}

// Build a line's DOM representation from scratch
function buildLineElement(cm, lineView, lineN, dims) {
  var built = getLineContent(cm, lineView)
  lineView.text = lineView.node = built.pre
  if (built.bgClass) { lineView.bgClass = built.bgClass }
  if (built.textClass) { lineView.textClass = built.textClass }

  updateLineClasses(cm, lineView)
  updateLineGutter(cm, lineView, lineN, dims)
  insertLineWidgets(cm, lineView, dims)
  return lineView.node
}

// A lineView may contain multiple logical lines (when merged by
// collapsed spans). The widgets for all of them need to be drawn.
function insertLineWidgets(cm, lineView, dims) {
  insertLineWidgetsFor(cm, lineView.line, lineView, dims, true)
  if (lineView.rest) { for (var i = 0; i < lineView.rest.length; i++)
    { insertLineWidgetsFor(cm, lineView.rest[i], lineView, dims, false) } }
}

function insertLineWidgetsFor(cm, line, lineView, dims, allowAbove) {
  if (!line.widgets) { return }
  var wrap = ensureLineWrapped(lineView)
  for (var i = 0, ws = line.widgets; i < ws.length; ++i) {
    var widget = ws[i], node = elt("div", [widget.node], "CodeMirror-linewidget")
    if (!widget.handleMouseEvents) { node.setAttribute("cm-ignore-events", "true") }
    positionLineWidget(widget, node, lineView, dims)
    cm.display.input.setUneditable(node)
    if (allowAbove && widget.above)
      { wrap.insertBefore(node, lineView.gutter || lineView.text) }
    else
      { wrap.appendChild(node) }
    signalLater(widget, "redraw")
  }
}

function positionLineWidget(widget, node, lineView, dims) {
  if (widget.noHScroll) {
    ;(lineView.alignable || (lineView.alignable = [])).push(node)
    var width = dims.wrapperWidth
    node.style.left = dims.fixedPos + "px"
    if (!widget.coverGutter) {
      width -= dims.gutterTotalWidth
      node.style.paddingLeft = dims.gutterTotalWidth + "px"
    }
    node.style.width = width + "px"
  }
  if (widget.coverGutter) {
    node.style.zIndex = 5
    node.style.position = "relative"
    if (!widget.noHScroll) { node.style.marginLeft = -dims.gutterTotalWidth + "px" }
  }
}

function widgetHeight(widget) {
  if (widget.height != null) { return widget.height }
  var cm = widget.doc.cm
  if (!cm) { return 0 }
  if (!contains(document.body, widget.node)) {
    var parentStyle = "position: relative;"
    if (widget.coverGutter)
      { parentStyle += "margin-left: -" + cm.display.gutters.offsetWidth + "px;" }
    if (widget.noHScroll)
      { parentStyle += "width: " + cm.display.wrapper.clientWidth + "px;" }
    removeChildrenAndAdd(cm.display.measure, elt("div", [widget.node], null, parentStyle))
  }
  return widget.height = widget.node.parentNode.offsetHeight
}

// Return true when the given mouse event happened in a widget
function eventInWidget(display, e) {
  for (var n = e_target(e); n != display.wrapper; n = n.parentNode) {
    if (!n || (n.nodeType == 1 && n.getAttribute("cm-ignore-events") == "true") ||
        (n.parentNode == display.sizer && n != display.mover))
      { return true }
  }
}

// POSITION MEASUREMENT

function paddingTop(display) {return display.lineSpace.offsetTop}
function paddingVert(display) {return display.mover.offsetHeight - display.lineSpace.offsetHeight}
function paddingH(display) {
  if (display.cachedPaddingH) { return display.cachedPaddingH }
  var e = removeChildrenAndAdd(display.measure, elt("pre", "x"))
  var style = window.getComputedStyle ? window.getComputedStyle(e) : e.currentStyle
  var data = {left: parseInt(style.paddingLeft), right: parseInt(style.paddingRight)}
  if (!isNaN(data.left) && !isNaN(data.right)) { display.cachedPaddingH = data }
  return data
}

function scrollGap(cm) { return scrollerGap - cm.display.nativeBarWidth }
function displayWidth(cm) {
  return cm.display.scroller.clientWidth - scrollGap(cm) - cm.display.barWidth
}
function displayHeight(cm) {
  return cm.display.scroller.clientHeight - scrollGap(cm) - cm.display.barHeight
}

// Ensure the lineView.wrapping.heights array is populated. This is
// an array of bottom offsets for the lines that make up a drawn
// line. When lineWrapping is on, there might be more than one
// height.
function ensureLineHeights(cm, lineView, rect) {
  var wrapping = cm.options.lineWrapping
  var curWidth = wrapping && displayWidth(cm)
  if (!lineView.measure.heights || wrapping && lineView.measure.width != curWidth) {
    var heights = lineView.measure.heights = []
    if (wrapping) {
      lineView.measure.width = curWidth
      var rects = lineView.text.firstChild.getClientRects()
      for (var i = 0; i < rects.length - 1; i++) {
        var cur = rects[i], next = rects[i + 1]
        if (Math.abs(cur.bottom - next.bottom) > 2)
          { heights.push((cur.bottom + next.top) / 2 - rect.top) }
      }
    }
    heights.push(rect.bottom - rect.top)
  }
}

// Find a line map (mapping character offsets to text nodes) and a
// measurement cache for the given line number. (A line view might
// contain multiple lines when collapsed ranges are present.)
function mapFromLineView(lineView, line, lineN) {
  if (lineView.line == line)
    { return {map: lineView.measure.map, cache: lineView.measure.cache} }
  for (var i = 0; i < lineView.rest.length; i++)
    { if (lineView.rest[i] == line)
      { return {map: lineView.measure.maps[i], cache: lineView.measure.caches[i]} } }
  for (var i$1 = 0; i$1 < lineView.rest.length; i$1++)
    { if (lineNo(lineView.rest[i$1]) > lineN)
      { return {map: lineView.measure.maps[i$1], cache: lineView.measure.caches[i$1], before: true} } }
}

// Render a line into the hidden node display.externalMeasured. Used
// when measurement is needed for a line that's not in the viewport.
function updateExternalMeasurement(cm, line) {
  line = visualLine(line)
  var lineN = lineNo(line)
  var view = cm.display.externalMeasured = new LineView(cm.doc, line, lineN)
  view.lineN = lineN
  var built = view.built = buildLineContent(cm, view)
  view.text = built.pre
  removeChildrenAndAdd(cm.display.lineMeasure, built.pre)
  return view
}

// Get a {top, bottom, left, right} box (in line-local coordinates)
// for a given character.
function measureChar(cm, line, ch, bias) {
  return measureCharPrepared(cm, prepareMeasureForLine(cm, line), ch, bias)
}

// Find a line view that corresponds to the given line number.
function findViewForLine(cm, lineN) {
  if (lineN >= cm.display.viewFrom && lineN < cm.display.viewTo)
    { return cm.display.view[findViewIndex(cm, lineN)] }
  var ext = cm.display.externalMeasured
  if (ext && lineN >= ext.lineN && lineN < ext.lineN + ext.size)
    { return ext }
}

// Measurement can be split in two steps, the set-up work that
// applies to the whole line, and the measurement of the actual
// character. Functions like coordsChar, that need to do a lot of
// measurements in a row, can thus ensure that the set-up work is
// only done once.
function prepareMeasureForLine(cm, line) {
  var lineN = lineNo(line)
  var view = findViewForLine(cm, lineN)
  if (view && !view.text) {
    view = null
  } else if (view && view.changes) {
    updateLineForChanges(cm, view, lineN, getDimensions(cm))
    cm.curOp.forceUpdate = true
  }
  if (!view)
    { view = updateExternalMeasurement(cm, line) }

  var info = mapFromLineView(view, line, lineN)
  return {
    line: line, view: view, rect: null,
    map: info.map, cache: info.cache, before: info.before,
    hasHeights: false
  }
}

// Given a prepared measurement object, measures the position of an
// actual character (or fetches it from the cache).
function measureCharPrepared(cm, prepared, ch, bias, varHeight) {
  if (prepared.before) { ch = -1 }
  var key = ch + (bias || ""), found
  if (prepared.cache.hasOwnProperty(key)) {
    found = prepared.cache[key]
  } else {
    if (!prepared.rect)
      { prepared.rect = prepared.view.text.getBoundingClientRect() }
    if (!prepared.hasHeights) {
      ensureLineHeights(cm, prepared.view, prepared.rect)
      prepared.hasHeights = true
    }
    found = measureCharInner(cm, prepared, ch, bias)
    if (!found.bogus) { prepared.cache[key] = found }
  }
  return {left: found.left, right: found.right,
          top: varHeight ? found.rtop : found.top,
          bottom: varHeight ? found.rbottom : found.bottom}
}

var nullRect = {left: 0, right: 0, top: 0, bottom: 0}

function nodeAndOffsetInLineMap(map, ch, bias) {
  var node, start, end, collapse, mStart, mEnd
  // First, search the line map for the text node corresponding to,
  // or closest to, the target character.
  for (var i = 0; i < map.length; i += 3) {
    mStart = map[i]
    mEnd = map[i + 1]
    if (ch < mStart) {
      start = 0; end = 1
      collapse = "left"
    } else if (ch < mEnd) {
      start = ch - mStart
      end = start + 1
    } else if (i == map.length - 3 || ch == mEnd && map[i + 3] > ch) {
      end = mEnd - mStart
      start = end - 1
      if (ch >= mEnd) { collapse = "right" }
    }
    if (start != null) {
      node = map[i + 2]
      if (mStart == mEnd && bias == (node.insertLeft ? "left" : "right"))
        { collapse = bias }
      if (bias == "left" && start == 0)
        { while (i && map[i - 2] == map[i - 3] && map[i - 1].insertLeft) {
          node = map[(i -= 3) + 2]
          collapse = "left"
        } }
      if (bias == "right" && start == mEnd - mStart)
        { while (i < map.length - 3 && map[i + 3] == map[i + 4] && !map[i + 5].insertLeft) {
          node = map[(i += 3) + 2]
          collapse = "right"
        } }
      break
    }
  }
  return {node: node, start: start, end: end, collapse: collapse, coverStart: mStart, coverEnd: mEnd}
}

function getUsefulRect(rects, bias) {
  var rect = nullRect
  if (bias == "left") { for (var i = 0; i < rects.length; i++) {
    if ((rect = rects[i]).left != rect.right) { break }
  } } else { for (var i$1 = rects.length - 1; i$1 >= 0; i$1--) {
    if ((rect = rects[i$1]).left != rect.right) { break }
  } }
  return rect
}

function measureCharInner(cm, prepared, ch, bias) {
  var place = nodeAndOffsetInLineMap(prepared.map, ch, bias)
  var node = place.node, start = place.start, end = place.end, collapse = place.collapse

  var rect
  if (node.nodeType == 3) { // If it is a text node, use a range to retrieve the coordinates.
    for (var i$1 = 0; i$1 < 4; i$1++) { // Retry a maximum of 4 times when nonsense rectangles are returned
      while (start && isExtendingChar(prepared.line.text.charAt(place.coverStart + start))) { --start }
      while (place.coverStart + end < place.coverEnd && isExtendingChar(prepared.line.text.charAt(place.coverStart + end))) { ++end }
      if (ie && ie_version < 9 && start == 0 && end == place.coverEnd - place.coverStart)
        { rect = node.parentNode.getBoundingClientRect() }
      else
        { rect = getUsefulRect(range(node, start, end).getClientRects(), bias) }
      if (rect.left || rect.right || start == 0) { break }
      end = start
      start = start - 1
      collapse = "right"
    }
    if (ie && ie_version < 11) { rect = maybeUpdateRectForZooming(cm.display.measure, rect) }
  } else { // If it is a widget, simply get the box for the whole widget.
    if (start > 0) { collapse = bias = "right" }
    var rects
    if (cm.options.lineWrapping && (rects = node.getClientRects()).length > 1)
      { rect = rects[bias == "right" ? rects.length - 1 : 0] }
    else
      { rect = node.getBoundingClientRect() }
  }
  if (ie && ie_version < 9 && !start && (!rect || !rect.left && !rect.right)) {
    var rSpan = node.parentNode.getClientRects()[0]
    if (rSpan)
      { rect = {left: rSpan.left, right: rSpan.left + charWidth(cm.display), top: rSpan.top, bottom: rSpan.bottom} }
    else
      { rect = nullRect }
  }

  var rtop = rect.top - prepared.rect.top, rbot = rect.bottom - prepared.rect.top
  var mid = (rtop + rbot) / 2
  var heights = prepared.view.measure.heights
  var i = 0
  for (; i < heights.length - 1; i++)
    { if (mid < heights[i]) { break } }
  var top = i ? heights[i - 1] : 0, bot = heights[i]
  var result = {left: (collapse == "right" ? rect.right : rect.left) - prepared.rect.left,
                right: (collapse == "left" ? rect.left : rect.right) - prepared.rect.left,
                top: top, bottom: bot}
  if (!rect.left && !rect.right) { result.bogus = true }
  if (!cm.options.singleCursorHeightPerLine) { result.rtop = rtop; result.rbottom = rbot }

  return result
}

// Work around problem with bounding client rects on ranges being
// returned incorrectly when zoomed on IE10 and below.
function maybeUpdateRectForZooming(measure, rect) {
  if (!window.screen || screen.logicalXDPI == null ||
      screen.logicalXDPI == screen.deviceXDPI || !hasBadZoomedRects(measure))
    { return rect }
  var scaleX = screen.logicalXDPI / screen.deviceXDPI
  var scaleY = screen.logicalYDPI / screen.deviceYDPI
  return {left: rect.left * scaleX, right: rect.right * scaleX,
          top: rect.top * scaleY, bottom: rect.bottom * scaleY}
}

function clearLineMeasurementCacheFor(lineView) {
  if (lineView.measure) {
    lineView.measure.cache = {}
    lineView.measure.heights = null
    if (lineView.rest) { for (var i = 0; i < lineView.rest.length; i++)
      { lineView.measure.caches[i] = {} } }
  }
}

function clearLineMeasurementCache(cm) {
  cm.display.externalMeasure = null
  removeChildren(cm.display.lineMeasure)
  for (var i = 0; i < cm.display.view.length; i++)
    { clearLineMeasurementCacheFor(cm.display.view[i]) }
}

function clearCaches(cm) {
  clearLineMeasurementCache(cm)
  cm.display.cachedCharWidth = cm.display.cachedTextHeight = cm.display.cachedPaddingH = null
  if (!cm.options.lineWrapping) { cm.display.maxLineChanged = true }
  cm.display.lineNumChars = null
}

function pageScrollX() {
  // Work around https://bugs.chromium.org/p/chromium/issues/detail?id=489206
  // which causes page_Offset and bounding client rects to use
  // different reference viewports and invalidate our calculations.
  if (chrome && android) { return -(document.body.getBoundingClientRect().left - parseInt(getComputedStyle(document.body).marginLeft)) }
  return window.pageXOffset || (document.documentElement || document.body).scrollLeft
}
function pageScrollY() {
  if (chrome && android) { return -(document.body.getBoundingClientRect().top - parseInt(getComputedStyle(document.body).marginTop)) }
  return window.pageYOffset || (document.documentElement || document.body).scrollTop
}

function widgetTopHeight(lineObj) {
  var height = 0
  if (lineObj.widgets) { for (var i = 0; i < lineObj.widgets.length; ++i) { if (lineObj.widgets[i].above)
    { height += widgetHeight(lineObj.widgets[i]) } } }
  return height
}

// Converts a {top, bottom, left, right} box from line-local
// coordinates into another coordinate system. Context may be one of
// "line", "div" (display.lineDiv), "local"./null (editor), "window",
// or "page".
function intoCoordSystem(cm, lineObj, rect, context, includeWidgets) {
  if (!includeWidgets) {
    var height = widgetTopHeight(lineObj)
    rect.top += height; rect.bottom += height
  }
  if (context == "line") { return rect }
  if (!context) { context = "local" }
  var yOff = heightAtLine(lineObj)
  if (context == "local") { yOff += paddingTop(cm.display) }
  else { yOff -= cm.display.viewOffset }
  if (context == "page" || context == "window") {
    var lOff = cm.display.lineSpace.getBoundingClientRect()
    yOff += lOff.top + (context == "window" ? 0 : pageScrollY())
    var xOff = lOff.left + (context == "window" ? 0 : pageScrollX())
    rect.left += xOff; rect.right += xOff
  }
  rect.top += yOff; rect.bottom += yOff
  return rect
}

// Coverts a box from "div" coords to another coordinate system.
// Context may be "window", "page", "div", or "local"./null.
function fromCoordSystem(cm, coords, context) {
  if (context == "div") { return coords }
  var left = coords.left, top = coords.top
  // First move into "page" coordinate system
  if (context == "page") {
    left -= pageScrollX()
    top -= pageScrollY()
  } else if (context == "local" || !context) {
    var localBox = cm.display.sizer.getBoundingClientRect()
    left += localBox.left
    top += localBox.top
  }

  var lineSpaceBox = cm.display.lineSpace.getBoundingClientRect()
  return {left: left - lineSpaceBox.left, top: top - lineSpaceBox.top}
}

function charCoords(cm, pos, context, lineObj, bias) {
  if (!lineObj) { lineObj = getLine(cm.doc, pos.line) }
  return intoCoordSystem(cm, lineObj, measureChar(cm, lineObj, pos.ch, bias), context)
}

// Returns a box for a given cursor position, which may have an
// 'other' property containing the position of the secondary cursor
// on a bidi boundary.
// A cursor Pos(line, char, "before") is on the same visual line as `char - 1`
// and after `char - 1` in writing order of `char - 1`
// A cursor Pos(line, char, "after") is on the same visual line as `char`
// and before `char` in writing order of `char`
// Examples (upper-case letters are RTL, lower-case are LTR):
//     Pos(0, 1, ...)
//     before   after
// ab     a|b     a|b
// aB     a|B     aB|
// Ab     |Ab     A|b
// AB     B|A     B|A
// Every position after the last character on a line is considered to stick
// to the last character on the line.
function cursorCoords(cm, pos, context, lineObj, preparedMeasure, varHeight) {
  lineObj = lineObj || getLine(cm.doc, pos.line)
  if (!preparedMeasure) { preparedMeasure = prepareMeasureForLine(cm, lineObj) }
  function get(ch, right) {
    var m = measureCharPrepared(cm, preparedMeasure, ch, right ? "right" : "left", varHeight)
    if (right) { m.left = m.right; } else { m.right = m.left }
    return intoCoordSystem(cm, lineObj, m, context)
  }
  var order = getOrder(lineObj, cm.doc.direction), ch = pos.ch, sticky = pos.sticky
  if (ch >= lineObj.text.length) {
    ch = lineObj.text.length
    sticky = "before"
  } else if (ch <= 0) {
    ch = 0
    sticky = "after"
  }
  if (!order) { return get(sticky == "before" ? ch - 1 : ch, sticky == "before") }

  function getBidi(ch, partPos, invert) {
    var part = order[partPos], right = part.level == 1
    return get(invert ? ch - 1 : ch, right != invert)
  }
  var partPos = getBidiPartAt(order, ch, sticky)
  var other = bidiOther
  var val = getBidi(ch, partPos, sticky == "before")
  if (other != null) { val.other = getBidi(ch, other, sticky != "before") }
  return val
}

// Used to cheaply estimate the coordinates for a position. Used for
// intermediate scroll updates.
function estimateCoords(cm, pos) {
  var left = 0
  pos = clipPos(cm.doc, pos)
  if (!cm.options.lineWrapping) { left = charWidth(cm.display) * pos.ch }
  var lineObj = getLine(cm.doc, pos.line)
  var top = heightAtLine(lineObj) + paddingTop(cm.display)
  return {left: left, right: left, top: top, bottom: top + lineObj.height}
}

// Positions returned by coordsChar contain some extra information.
// xRel is the relative x position of the input coordinates compared
// to the found position (so xRel > 0 means the coordinates are to
// the right of the character position, for example). When outside
// is true, that means the coordinates lie outside the line's
// vertical range.
function PosWithInfo(line, ch, sticky, outside, xRel) {
  var pos = Pos(line, ch, sticky)
  pos.xRel = xRel
  if (outside) { pos.outside = true }
  return pos
}

// Compute the character position closest to the given coordinates.
// Input must be lineSpace-local ("div" coordinate system).
function coordsChar(cm, x, y) {
  var doc = cm.doc
  y += cm.display.viewOffset
  if (y < 0) { return PosWithInfo(doc.first, 0, null, true, -1) }
  var lineN = lineAtHeight(doc, y), last = doc.first + doc.size - 1
  if (lineN > last)
    { return PosWithInfo(doc.first + doc.size - 1, getLine(doc, last).text.length, null, true, 1) }
  if (x < 0) { x = 0 }

  var lineObj = getLine(doc, lineN)
  for (;;) {
    var found = coordsCharInner(cm, lineObj, lineN, x, y)
    var merged = collapsedSpanAtEnd(lineObj)
    var mergedPos = merged && merged.find(0, true)
    if (merged && (found.ch > mergedPos.from.ch || found.ch == mergedPos.from.ch && found.xRel > 0))
      { lineN = lineNo(lineObj = mergedPos.to.line) }
    else
      { return found }
  }
}

function wrappedLineExtent(cm, lineObj, preparedMeasure, y) {
  y -= widgetTopHeight(lineObj)
  var end = lineObj.text.length
  var begin = findFirst(function (ch) { return measureCharPrepared(cm, preparedMeasure, ch - 1).bottom <= y; }, end, 0)
  end = findFirst(function (ch) { return measureCharPrepared(cm, preparedMeasure, ch).top > y; }, begin, end)
  return {begin: begin, end: end}
}

function wrappedLineExtentChar(cm, lineObj, preparedMeasure, target) {
  if (!preparedMeasure) { preparedMeasure = prepareMeasureForLine(cm, lineObj) }
  var targetTop = intoCoordSystem(cm, lineObj, measureCharPrepared(cm, preparedMeasure, target), "line").top
  return wrappedLineExtent(cm, lineObj, preparedMeasure, targetTop)
}

// Returns true if the given side of a box is after the given
// coordinates, in top-to-bottom, left-to-right order.
function boxIsAfter(box, x, y, left) {
  return box.bottom <= y ? false : box.top > y ? true : (left ? box.left : box.right) > x
}

function coordsCharInner(cm, lineObj, lineNo, x, y) {
  // Move y into line-local coordinate space
  y -= heightAtLine(lineObj)
  var preparedMeasure = prepareMeasureForLine(cm, lineObj)
  // When directly calling `measureCharPrepared`, we have to adjust
  // for the widgets at this line.
  var widgetHeight = widgetTopHeight(lineObj)
  var begin = 0, end = lineObj.text.length, ltr = true

  var order = getOrder(lineObj, cm.doc.direction)
  // If the line isn't plain left-to-right text, first figure out
  // which bidi section the coordinates fall into.
  if (order) {
    var part = (cm.options.lineWrapping ? coordsBidiPartWrapped : coordsBidiPart)
                 (cm, lineObj, lineNo, preparedMeasure, order, x, y)
    ltr = part.level != 1
    // The awkward -1 offsets are needed because findFirst (called
    // on these below) will treat its first bound as inclusive,
    // second as exclusive, but we want to actually address the
    // characters in the part's range
    begin = ltr ? part.from : part.to - 1
    end = ltr ? part.to : part.from - 1
  }

  // A binary search to find the first character whose bounding box
  // starts after the coordinates. If we run across any whose box wrap
  // the coordinates, store that.
  var chAround = null, boxAround = null
  var ch = findFirst(function (ch) {
    var box = measureCharPrepared(cm, preparedMeasure, ch)
    box.top += widgetHeight; box.bottom += widgetHeight
    if (!boxIsAfter(box, x, y, false)) { return false }
    if (box.top <= y && box.left <= x) {
      chAround = ch
      boxAround = box
    }
    return true
  }, begin, end)

  var baseX, sticky, outside = false
  // If a box around the coordinates was found, use that
  if (boxAround) {
    // Distinguish coordinates nearer to the left or right side of the box
    var atLeft = x - boxAround.left < boxAround.right - x, atStart = atLeft == ltr
    ch = chAround + (atStart ? 0 : 1)
    sticky = atStart ? "after" : "before"
    baseX = atLeft ? boxAround.left : boxAround.right
  } else {
    // (Adjust for extended bound, if necessary.)
    if (!ltr && (ch == end || ch == begin)) { ch++ }
    // To determine which side to associate with, get the box to the
    // left of the character and compare it's vertical position to the
    // coordinates
    sticky = ch == 0 ? "after" : ch == lineObj.text.length ? "before" :
      (measureCharPrepared(cm, preparedMeasure, ch - (ltr ? 1 : 0)).bottom + widgetHeight <= y) == ltr ?
      "after" : "before"
    // Now get accurate coordinates for this place, in order to get a
    // base X position
    var coords = cursorCoords(cm, Pos(lineNo, ch, sticky), "line", lineObj, preparedMeasure)
    baseX = coords.left
    outside = y < coords.top || y >= coords.bottom
  }

  ch = skipExtendingChars(lineObj.text, ch, 1)
  return PosWithInfo(lineNo, ch, sticky, outside, x - baseX)
}

function coordsBidiPart(cm, lineObj, lineNo, preparedMeasure, order, x, y) {
  // Bidi parts are sorted left-to-right, and in a non-line-wrapping
  // situation, we can take this ordering to correspond to the visual
  // ordering. This finds the first part whose end is after the given
  // coordinates.
  var index = findFirst(function (i) {
    var part = order[i], ltr = part.level != 1
    return boxIsAfter(cursorCoords(cm, Pos(lineNo, ltr ? part.to : part.from, ltr ? "before" : "after"),
                                   "line", lineObj, preparedMeasure), x, y, true)
  }, 0, order.length - 1)
  var part = order[index]
  // If this isn't the first part, the part's start is also after
  // the coordinates, and the coordinates aren't on the same line as
  // that start, move one part back.
  if (index > 0) {
    var ltr = part.level != 1
    var start = cursorCoords(cm, Pos(lineNo, ltr ? part.from : part.to, ltr ? "after" : "before"),
                             "line", lineObj, preparedMeasure)
    if (boxIsAfter(start, x, y, true) && start.top > y)
      { part = order[index - 1] }
  }
  return part
}

function coordsBidiPartWrapped(cm, lineObj, _lineNo, preparedMeasure, order, x, y) {
  // In a wrapped line, rtl text on wrapping boundaries can do things
  // that don't correspond to the ordering in our `order` array at
  // all, so a binary search doesn't work, and we want to return a
  // part that only spans one line so that the binary search in
  // coordsCharInner is safe. As such, we first find the extent of the
  // wrapped line, and then do a flat search in which we discard any
  // spans that aren't on the line.
  var ref = wrappedLineExtent(cm, lineObj, preparedMeasure, y);
  var begin = ref.begin;
  var end = ref.end;
  if (/\s/.test(lineObj.text.charAt(end - 1))) { end-- }
  var part = null, closestDist = null
  for (var i = 0; i < order.length; i++) {
    var p = order[i]
    if (p.from >= end || p.to <= begin) { continue }
    var ltr = p.level != 1
    var endX = measureCharPrepared(cm, preparedMeasure, ltr ? Math.min(end, p.to) - 1 : Math.max(begin, p.from)).right
    // Weigh against spans ending before this, so that they are only
    // picked if nothing ends after
    var dist = endX < x ? x - endX + 1e9 : endX - x
    if (!part || closestDist > dist) {
      part = p
      closestDist = dist
    }
  }
  if (!part) { part = order[order.length - 1] }
  // Clip the part to the wrapped line.
  if (part.from < begin) { part = {from: begin, to: part.to, level: part.level} }
  if (part.to > end) { part = {from: part.from, to: end, level: part.level} }
  return part
}

var measureText
// Compute the default text height.
function textHeight(display) {
  if (display.cachedTextHeight != null) { return display.cachedTextHeight }
  if (measureText == null) {
    measureText = elt("pre")
    // Measure a bunch of lines, for browsers that compute
    // fractional heights.
    for (var i = 0; i < 49; ++i) {
      measureText.appendChild(document.createTextNode("x"))
      measureText.appendChild(elt("br"))
    }
    measureText.appendChild(document.createTextNode("x"))
  }
  removeChildrenAndAdd(display.measure, measureText)
  var height = measureText.offsetHeight / 50
  if (height > 3) { display.cachedTextHeight = height }
  removeChildren(display.measure)
  return height || 1
}

// Compute the default character width.
function charWidth(display) {
  if (display.cachedCharWidth != null) { return display.cachedCharWidth }
  var anchor = elt("span", "xxxxxxxxxx")
  var pre = elt("pre", [anchor])
  removeChildrenAndAdd(display.measure, pre)
  var rect = anchor.getBoundingClientRect(), width = (rect.right - rect.left) / 10
  if (width > 2) { display.cachedCharWidth = width }
  return width || 10
}

// Do a bulk-read of the DOM positions and sizes needed to draw the
// view, so that we don't interleave reading and writing to the DOM.
function getDimensions(cm) {
  var d = cm.display, left = {}, width = {}
  var gutterLeft = d.gutters.clientLeft
  for (var n = d.gutters.firstChild, i = 0; n; n = n.nextSibling, ++i) {
    left[cm.options.gutters[i]] = n.offsetLeft + n.clientLeft + gutterLeft
    width[cm.options.gutters[i]] = n.clientWidth
  }
  return {fixedPos: compensateForHScroll(d),
          gutterTotalWidth: d.gutters.offsetWidth,
          gutterLeft: left,
          gutterWidth: width,
          wrapperWidth: d.wrapper.clientWidth}
}

// Computes display.scroller.scrollLeft + display.gutters.offsetWidth,
// but using getBoundingClientRect to get a sub-pixel-accurate
// result.
function compensateForHScroll(display) {
  return display.scroller.getBoundingClientRect().left - display.sizer.getBoundingClientRect().left
}

// Returns a function that estimates the height of a line, to use as
// first approximation until the line becomes visible (and is thus
// properly measurable).
function estimateHeight(cm) {
  var th = textHeight(cm.display), wrapping = cm.options.lineWrapping
  var perLine = wrapping && Math.max(5, cm.display.scroller.clientWidth / charWidth(cm.display) - 3)
  return function (line) {
    if (lineIsHidden(cm.doc, line)) { return 0 }

    var widgetsHeight = 0
    if (line.widgets) { for (var i = 0; i < line.widgets.length; i++) {
      if (line.widgets[i].height) { widgetsHeight += line.widgets[i].height }
    } }

    if (wrapping)
      { return widgetsHeight + (Math.ceil(line.text.length / perLine) || 1) * th }
    else
      { return widgetsHeight + th }
  }
}

function estimateLineHeights(cm) {
  var doc = cm.doc, est = estimateHeight(cm)
  doc.iter(function (line) {
    var estHeight = est(line)
    if (estHeight != line.height) { updateLineHeight(line, estHeight) }
  })
}

// Given a mouse event, find the corresponding position. If liberal
// is false, it checks whether a gutter or scrollbar was clicked,
// and returns null if it was. forRect is used by rectangular
// selections, and tries to estimate a character position even for
// coordinates beyond the right of the text.
function posFromMouse(cm, e, liberal, forRect) {
  var display = cm.display
  if (!liberal && e_target(e).getAttribute("cm-not-content") == "true") { return null }

  var x, y, space = display.lineSpace.getBoundingClientRect()
  // Fails unpredictably on IE[67] when mouse is dragged around quickly.
  try { x = e.clientX - space.left; y = e.clientY - space.top }
  catch (e) { return null }
  var coords = coordsChar(cm, x, y), line
  if (forRect && coords.xRel == 1 && (line = getLine(cm.doc, coords.line).text).length == coords.ch) {
    var colDiff = countColumn(line, line.length, cm.options.tabSize) - line.length
    coords = Pos(coords.line, Math.max(0, Math.round((x - paddingH(cm.display).left) / charWidth(cm.display)) - colDiff))
  }
  return coords
}

// Find the view element corresponding to a given line. Return null
// when the line isn't visible.
function findViewIndex(cm, n) {
  if (n >= cm.display.viewTo) { return null }
  n -= cm.display.viewFrom
  if (n < 0) { return null }
  var view = cm.display.view
  for (var i = 0; i < view.length; i++) {
    n -= view[i].size
    if (n < 0) { return i }
  }
}

function updateSelection(cm) {
  cm.display.input.showSelection(cm.display.input.prepareSelection())
}

function prepareSelection(cm, primary) {
  if ( primary === void 0 ) primary = true;

  var doc = cm.doc, result = {}
  var curFragment = result.cursors = document.createDocumentFragment()
  var selFragment = result.selection = document.createDocumentFragment()

  for (var i = 0; i < doc.sel.ranges.length; i++) {
    if (!primary && i == doc.sel.primIndex) { continue }
    var range = doc.sel.ranges[i]
    if (range.from().line >= cm.display.viewTo || range.to().line < cm.display.viewFrom) { continue }
    var collapsed = range.empty()
    if (collapsed || cm.options.showCursorWhenSelecting)
      { drawSelectionCursor(cm, range.head, curFragment) }
    if (!collapsed)
      { drawSelectionRange(cm, range, selFragment) }
  }
  return result
}

// Draws a cursor for the given range
function drawSelectionCursor(cm, head, output) {
  var pos = cursorCoords(cm, head, "div", null, null, !cm.options.singleCursorHeightPerLine)

  var cursor = output.appendChild(elt("div", "\u00a0", "CodeMirror-cursor"))
  cursor.style.left = pos.left + "px"
  cursor.style.top = pos.top + "px"
  cursor.style.height = Math.max(0, pos.bottom - pos.top) * cm.options.cursorHeight + "px"

  if (pos.other) {
    // Secondary cursor, shown when on a 'jump' in bi-directional text
    var otherCursor = output.appendChild(elt("div", "\u00a0", "CodeMirror-cursor CodeMirror-secondarycursor"))
    otherCursor.style.display = ""
    otherCursor.style.left = pos.other.left + "px"
    otherCursor.style.top = pos.other.top + "px"
    otherCursor.style.height = (pos.other.bottom - pos.other.top) * .85 + "px"
  }
}

function cmpCoords(a, b) { return a.top - b.top || a.left - b.left }

// Draws the given range as a highlighted selection
function drawSelectionRange(cm, range, output) {
  var display = cm.display, doc = cm.doc
  var fragment = document.createDocumentFragment()
  var padding = paddingH(cm.display), leftSide = padding.left
  var rightSide = Math.max(display.sizerWidth, displayWidth(cm) - display.sizer.offsetLeft) - padding.right
  var docLTR = doc.direction == "ltr"

  function add(left, top, width, bottom) {
    if (top < 0) { top = 0 }
    top = Math.round(top)
    bottom = Math.round(bottom)
    fragment.appendChild(elt("div", null, "CodeMirror-selected", ("position: absolute; left: " + left + "px;\n                             top: " + top + "px; width: " + (width == null ? rightSide - left : width) + "px;\n                             height: " + (bottom - top) + "px")))
  }

  function drawForLine(line, fromArg, toArg) {
    var lineObj = getLine(doc, line)
    var lineLen = lineObj.text.length
    var start, end
    function coords(ch, bias) {
      return charCoords(cm, Pos(line, ch), "div", lineObj, bias)
    }

    function wrapX(pos, dir, side) {
      var extent = wrappedLineExtentChar(cm, lineObj, null, pos)
      var prop = (dir == "ltr") == (side == "after") ? "left" : "right"
      var ch = side == "after" ? extent.begin : extent.end - (/\s/.test(lineObj.text.charAt(extent.end - 1)) ? 2 : 1)
      return coords(ch, prop)[prop]
    }

    var order = getOrder(lineObj, doc.direction)
    iterateBidiSections(order, fromArg || 0, toArg == null ? lineLen : toArg, function (from, to, dir, i) {
      var ltr = dir == "ltr"
      var fromPos = coords(from, ltr ? "left" : "right")
      var toPos = coords(to - 1, ltr ? "right" : "left")

      var openStart = fromArg == null && from == 0, openEnd = toArg == null && to == lineLen
      var first = i == 0, last = !order || i == order.length - 1
      if (toPos.top - fromPos.top <= 3) { // Single line
        var openLeft = (docLTR ? openStart : openEnd) && first
        var openRight = (docLTR ? openEnd : openStart) && last
        var left = openLeft ? leftSide : (ltr ? fromPos : toPos).left
        var right = openRight ? rightSide : (ltr ? toPos : fromPos).right
        add(left, fromPos.top, right - left, fromPos.bottom)
      } else { // Multiple lines
        var topLeft, topRight, botLeft, botRight
        if (ltr) {
          topLeft = docLTR && openStart && first ? leftSide : fromPos.left
          topRight = docLTR ? rightSide : wrapX(from, dir, "before")
          botLeft = docLTR ? leftSide : wrapX(to, dir, "after")
          botRight = docLTR && openEnd && last ? rightSide : toPos.right
        } else {
          topLeft = !docLTR ? leftSide : wrapX(from, dir, "before")
          topRight = !docLTR && openStart && first ? rightSide : fromPos.right
          botLeft = !docLTR && openEnd && last ? leftSide : toPos.left
          botRight = !docLTR ? rightSide : wrapX(to, dir, "after")
        }
        add(topLeft, fromPos.top, topRight - topLeft, fromPos.bottom)
        if (fromPos.bottom < toPos.top) { add(leftSide, fromPos.bottom, null, toPos.top) }
        add(botLeft, toPos.top, botRight - botLeft, toPos.bottom)
      }

      if (!start || cmpCoords(fromPos, start) < 0) { start = fromPos }
      if (cmpCoords(toPos, start) < 0) { start = toPos }
      if (!end || cmpCoords(fromPos, end) < 0) { end = fromPos }
      if (cmpCoords(toPos, end) < 0) { end = toPos }
    })
    return {start: start, end: end}
  }

  var sFrom = range.from(), sTo = range.to()
  if (sFrom.line == sTo.line) {
    drawForLine(sFrom.line, sFrom.ch, sTo.ch)
  } else {
    var fromLine = getLine(doc, sFrom.line), toLine = getLine(doc, sTo.line)
    var singleVLine = visualLine(fromLine) == visualLine(toLine)
    var leftEnd = drawForLine(sFrom.line, sFrom.ch, singleVLine ? fromLine.text.length + 1 : null).end
    var rightStart = drawForLine(sTo.line, singleVLine ? 0 : null, sTo.ch).start
    if (singleVLine) {
      if (leftEnd.top < rightStart.top - 2) {
        add(leftEnd.right, leftEnd.top, null, leftEnd.bottom)
        add(leftSide, rightStart.top, rightStart.left, rightStart.bottom)
      } else {
        add(leftEnd.right, leftEnd.top, rightStart.left - leftEnd.right, leftEnd.bottom)
      }
    }
    if (leftEnd.bottom < rightStart.top)
      { add(leftSide, leftEnd.bottom, null, rightStart.top) }
  }

  output.appendChild(fragment)
}

// Cursor-blinking
function restartBlink(cm) {
  if (!cm.state.focused) { return }
  var display = cm.display
  clearInterval(display.blinker)
  var on = true
  display.cursorDiv.style.visibility = ""
  if (cm.options.cursorBlinkRate > 0)
    { display.blinker = setInterval(function () { return display.cursorDiv.style.visibility = (on = !on) ? "" : "hidden"; },
      cm.options.cursorBlinkRate) }
  else if (cm.options.cursorBlinkRate < 0)
    { display.cursorDiv.style.visibility = "hidden" }
}

function ensureFocus(cm) {
  if (!cm.state.focused) { cm.display.input.focus(); onFocus(cm) }
}

function delayBlurEvent(cm) {
  cm.state.delayingBlurEvent = true
  setTimeout(function () { if (cm.state.delayingBlurEvent) {
    cm.state.delayingBlurEvent = false
    onBlur(cm)
  } }, 100)
}

function onFocus(cm, e) {
  if (cm.state.delayingBlurEvent) { cm.state.delayingBlurEvent = false }

  if (cm.options.readOnly == "nocursor") { return }
  if (!cm.state.focused) {
    signal(cm, "focus", cm, e)
    cm.state.focused = true
    addClass(cm.display.wrapper, "CodeMirror-focused")
    // This test prevents this from firing when a context
    // menu is closed (since the input reset would kill the
    // select-all detection hack)
    if (!cm.curOp && cm.display.selForContextMenu != cm.doc.sel) {
      cm.display.input.reset()
      if (webkit) { setTimeout(function () { return cm.display.input.reset(true); }, 20) } // Issue #1730
    }
    cm.display.input.receivedFocus()
  }
  restartBlink(cm)
}
function onBlur(cm, e) {
  if (cm.state.delayingBlurEvent) { return }

  if (cm.state.focused) {
    signal(cm, "blur", cm, e)
    cm.state.focused = false
    rmClass(cm.display.wrapper, "CodeMirror-focused")
  }
  clearInterval(cm.display.blinker)
  setTimeout(function () { if (!cm.state.focused) { cm.display.shift = false } }, 150)
}

// Read the actual heights of the rendered lines, and update their
// stored heights to match.
function updateHeightsInViewport(cm) {
  var display = cm.display
  var prevBottom = display.lineDiv.offsetTop
  for (var i = 0; i < display.view.length; i++) {
    var cur = display.view[i], height = (void 0)
    if (cur.hidden) { continue }
    if (ie && ie_version < 8) {
      var bot = cur.node.offsetTop + cur.node.offsetHeight
      height = bot - prevBottom
      prevBottom = bot
    } else {
      var box = cur.node.getBoundingClientRect()
      height = box.bottom - box.top
    }
    var diff = cur.line.height - height
    if (height < 2) { height = textHeight(display) }
    if (diff > .005 || diff < -.005) {
      updateLineHeight(cur.line, height)
      updateWidgetHeight(cur.line)
      if (cur.rest) { for (var j = 0; j < cur.rest.length; j++)
        { updateWidgetHeight(cur.rest[j]) } }
    }
  }
}

// Read and store the height of line widgets associated with the
// given line.
function updateWidgetHeight(line) {
  if (line.widgets) { for (var i = 0; i < line.widgets.length; ++i) {
    var w = line.widgets[i], parent = w.node.parentNode
    if (parent) { w.height = parent.offsetHeight }
  } }
}

// Compute the lines that are visible in a given viewport (defaults
// the the current scroll position). viewport may contain top,
// height, and ensure (see op.scrollToPos) properties.
function visibleLines(display, doc, viewport) {
  var top = viewport && viewport.top != null ? Math.max(0, viewport.top) : display.scroller.scrollTop
  top = Math.floor(top - paddingTop(display))
  var bottom = viewport && viewport.bottom != null ? viewport.bottom : top + display.wrapper.clientHeight

  var from = lineAtHeight(doc, top), to = lineAtHeight(doc, bottom)
  // Ensure is a {from: {line, ch}, to: {line, ch}} object, and
  // forces those lines into the viewport (if possible).
  if (viewport && viewport.ensure) {
    var ensureFrom = viewport.ensure.from.line, ensureTo = viewport.ensure.to.line
    if (ensureFrom < from) {
      from = ensureFrom
      to = lineAtHeight(doc, heightAtLine(getLine(doc, ensureFrom)) + display.wrapper.clientHeight)
    } else if (Math.min(ensureTo, doc.lastLine()) >= to) {
      from = lineAtHeight(doc, heightAtLine(getLine(doc, ensureTo)) - display.wrapper.clientHeight)
      to = ensureTo
    }
  }
  return {from: from, to: Math.max(to, from + 1)}
}

// Re-align line numbers and gutter marks to compensate for
// horizontal scrolling.
function alignHorizontally(cm) {
  var display = cm.display, view = display.view
  if (!display.alignWidgets && (!display.gutters.firstChild || !cm.options.fixedGutter)) { return }
  var comp = compensateForHScroll(display) - display.scroller.scrollLeft + cm.doc.scrollLeft
  var gutterW = display.gutters.offsetWidth, left = comp + "px"
  for (var i = 0; i < view.length; i++) { if (!view[i].hidden) {
    if (cm.options.fixedGutter) {
      if (view[i].gutter)
        { view[i].gutter.style.left = left }
      if (view[i].gutterBackground)
        { view[i].gutterBackground.style.left = left }
    }
    var align = view[i].alignable
    if (align) { for (var j = 0; j < align.length; j++)
      { align[j].style.left = left } }
  } }
  if (cm.options.fixedGutter)
    { display.gutters.style.left = (comp + gutterW) + "px" }
}

// Used to ensure that the line number gutter is still the right
// size for the current document size. Returns true when an update
// is needed.
function maybeUpdateLineNumberWidth(cm) {
  if (!cm.options.lineNumbers) { return false }
  var doc = cm.doc, last = lineNumberFor(cm.options, doc.first + doc.size - 1), display = cm.display
  if (last.length != display.lineNumChars) {
    var test = display.measure.appendChild(elt("div", [elt("div", last)],
                                               "CodeMirror-linenumber CodeMirror-gutter-elt"))
    var innerW = test.firstChild.offsetWidth, padding = test.offsetWidth - innerW
    display.lineGutter.style.width = ""
    display.lineNumInnerWidth = Math.max(innerW, display.lineGutter.offsetWidth - padding) + 1
    display.lineNumWidth = display.lineNumInnerWidth + padding
    display.lineNumChars = display.lineNumInnerWidth ? last.length : -1
    display.lineGutter.style.width = display.lineNumWidth + "px"
    updateGutterSpace(cm)
    return true
  }
  return false
}

// SCROLLING THINGS INTO VIEW

// If an editor sits on the top or bottom of the window, partially
// scrolled out of view, this ensures that the cursor is visible.
function maybeScrollWindow(cm, rect) {
  if (signalDOMEvent(cm, "scrollCursorIntoView")) { return }

  var display = cm.display, box = display.sizer.getBoundingClientRect(), doScroll = null
  if (rect.top + box.top < 0) { doScroll = true }
  else if (rect.bottom + box.top > (window.innerHeight || document.documentElement.clientHeight)) { doScroll = false }
  if (doScroll != null && !phantom) {
    var scrollNode = elt("div", "\u200b", null, ("position: absolute;\n                         top: " + (rect.top - display.viewOffset - paddingTop(cm.display)) + "px;\n                         height: " + (rect.bottom - rect.top + scrollGap(cm) + display.barHeight) + "px;\n                         left: " + (rect.left) + "px; width: " + (Math.max(2, rect.right - rect.left)) + "px;"))
    cm.display.lineSpace.appendChild(scrollNode)
    scrollNode.scrollIntoView(doScroll)
    cm.display.lineSpace.removeChild(scrollNode)
  }
}

// Scroll a given position into view (immediately), verifying that
// it actually became visible (as line heights are accurately
// measured, the position of something may 'drift' during drawing).
function scrollPosIntoView(cm, pos, end, margin) {
  if (margin == null) { margin = 0 }
  var rect
  if (!cm.options.lineWrapping && pos == end) {
    // Set pos and end to the cursor positions around the character pos sticks to
    // If pos.sticky == "before", that is around pos.ch - 1, otherwise around pos.ch
    // If pos == Pos(_, 0, "before"), pos and end are unchanged
    pos = pos.ch ? Pos(pos.line, pos.sticky == "before" ? pos.ch - 1 : pos.ch, "after") : pos
    end = pos.sticky == "before" ? Pos(pos.line, pos.ch + 1, "before") : pos
  }
  for (var limit = 0; limit < 5; limit++) {
    var changed = false
    var coords = cursorCoords(cm, pos)
    var endCoords = !end || end == pos ? coords : cursorCoords(cm, end)
    rect = {left: Math.min(coords.left, endCoords.left),
            top: Math.min(coords.top, endCoords.top) - margin,
            right: Math.max(coords.left, endCoords.left),
            bottom: Math.max(coords.bottom, endCoords.bottom) + margin}
    var scrollPos = calculateScrollPos(cm, rect)
    var startTop = cm.doc.scrollTop, startLeft = cm.doc.scrollLeft
    if (scrollPos.scrollTop != null) {
      updateScrollTop(cm, scrollPos.scrollTop)
      if (Math.abs(cm.doc.scrollTop - startTop) > 1) { changed = true }
    }
    if (scrollPos.scrollLeft != null) {
      setScrollLeft(cm, scrollPos.scrollLeft)
      if (Math.abs(cm.doc.scrollLeft - startLeft) > 1) { changed = true }
    }
    if (!changed) { break }
  }
  return rect
}

// Scroll a given set of coordinates into view (immediately).
function scrollIntoView(cm, rect) {
  var scrollPos = calculateScrollPos(cm, rect)
  if (scrollPos.scrollTop != null) { updateScrollTop(cm, scrollPos.scrollTop) }
  if (scrollPos.scrollLeft != null) { setScrollLeft(cm, scrollPos.scrollLeft) }
}

// Calculate a new scroll position needed to scroll the given
// rectangle into view. Returns an object with scrollTop and
// scrollLeft properties. When these are undefined, the
// vertical/horizontal position does not need to be adjusted.
function calculateScrollPos(cm, rect) {
  var display = cm.display, snapMargin = textHeight(cm.display)
  if (rect.top < 0) { rect.top = 0 }
  var screentop = cm.curOp && cm.curOp.scrollTop != null ? cm.curOp.scrollTop : display.scroller.scrollTop
  var screen = displayHeight(cm), result = {}
  if (rect.bottom - rect.top > screen) { rect.bottom = rect.top + screen }
  var docBottom = cm.doc.height + paddingVert(display)
  var atTop = rect.top < snapMargin, atBottom = rect.bottom > docBottom - snapMargin
  if (rect.top < screentop) {
    result.scrollTop = atTop ? 0 : rect.top
  } else if (rect.bottom > screentop + screen) {
    var newTop = Math.min(rect.top, (atBottom ? docBottom : rect.bottom) - screen)
    if (newTop != screentop) { result.scrollTop = newTop }
  }

  var screenleft = cm.curOp && cm.curOp.scrollLeft != null ? cm.curOp.scrollLeft : display.scroller.scrollLeft
  var screenw = displayWidth(cm) - (cm.options.fixedGutter ? display.gutters.offsetWidth : 0)
  var tooWide = rect.right - rect.left > screenw
  if (tooWide) { rect.right = rect.left + screenw }
  if (rect.left < 10)
    { result.scrollLeft = 0 }
  else if (rect.left < screenleft)
    { result.scrollLeft = Math.max(0, rect.left - (tooWide ? 0 : 10)) }
  else if (rect.right > screenw + screenleft - 3)
    { result.scrollLeft = rect.right + (tooWide ? 0 : 10) - screenw }
  return result
}

// Store a relative adjustment to the scroll position in the current
// operation (to be applied when the operation finishes).
function addToScrollTop(cm, top) {
  if (top == null) { return }
  resolveScrollToPos(cm)
  cm.curOp.scrollTop = (cm.curOp.scrollTop == null ? cm.doc.scrollTop : cm.curOp.scrollTop) + top
}

// Make sure that at the end of the operation the current cursor is
// shown.
function ensureCursorVisible(cm) {
  resolveScrollToPos(cm)
  var cur = cm.getCursor()
  cm.curOp.scrollToPos = {from: cur, to: cur, margin: cm.options.cursorScrollMargin}
}

function scrollToCoords(cm, x, y) {
  if (x != null || y != null) { resolveScrollToPos(cm) }
  if (x != null) { cm.curOp.scrollLeft = x }
  if (y != null) { cm.curOp.scrollTop = y }
}

function scrollToRange(cm, range) {
  resolveScrollToPos(cm)
  cm.curOp.scrollToPos = range
}

// When an operation has its scrollToPos property set, and another
// scroll action is applied before the end of the operation, this
// 'simulates' scrolling that position into view in a cheap way, so
// that the effect of intermediate scroll commands is not ignored.
function resolveScrollToPos(cm) {
  var range = cm.curOp.scrollToPos
  if (range) {
    cm.curOp.scrollToPos = null
    var from = estimateCoords(cm, range.from), to = estimateCoords(cm, range.to)
    scrollToCoordsRange(cm, from, to, range.margin)
  }
}

function scrollToCoordsRange(cm, from, to, margin) {
  var sPos = calculateScrollPos(cm, {
    left: Math.min(from.left, to.left),
    top: Math.min(from.top, to.top) - margin,
    right: Math.max(from.right, to.right),
    bottom: Math.max(from.bottom, to.bottom) + margin
  })
  scrollToCoords(cm, sPos.scrollLeft, sPos.scrollTop)
}

// Sync the scrollable area and scrollbars, ensure the viewport
// covers the visible area.
function updateScrollTop(cm, val) {
  if (Math.abs(cm.doc.scrollTop - val) < 2) { return }
  if (!gecko) { updateDisplaySimple(cm, {top: val}) }
  setScrollTop(cm, val, true)
  if (gecko) { updateDisplaySimple(cm) }
  startWorker(cm, 100)
}

function setScrollTop(cm, val, forceScroll) {
  val = Math.min(cm.display.scroller.scrollHeight - cm.display.scroller.clientHeight, val)
  if (cm.display.scroller.scrollTop == val && !forceScroll) { return }
  cm.doc.scrollTop = val
  cm.display.scrollbars.setScrollTop(val)
  if (cm.display.scroller.scrollTop != val) { cm.display.scroller.scrollTop = val }
}

// Sync scroller and scrollbar, ensure the gutter elements are
// aligned.
function setScrollLeft(cm, val, isScroller, forceScroll) {
  val = Math.min(val, cm.display.scroller.scrollWidth - cm.display.scroller.clientWidth)
  if ((isScroller ? val == cm.doc.scrollLeft : Math.abs(cm.doc.scrollLeft - val) < 2) && !forceScroll) { return }
  cm.doc.scrollLeft = val
  alignHorizontally(cm)
  if (cm.display.scroller.scrollLeft != val) { cm.display.scroller.scrollLeft = val }
  cm.display.scrollbars.setScrollLeft(val)
}

// SCROLLBARS

// Prepare DOM reads needed to update the scrollbars. Done in one
// shot to minimize update/measure roundtrips.
function measureForScrollbars(cm) {
  var d = cm.display, gutterW = d.gutters.offsetWidth
  var docH = Math.round(cm.doc.height + paddingVert(cm.display))
  return {
    clientHeight: d.scroller.clientHeight,
    viewHeight: d.wrapper.clientHeight,
    scrollWidth: d.scroller.scrollWidth, clientWidth: d.scroller.clientWidth,
    viewWidth: d.wrapper.clientWidth,
    barLeft: cm.options.fixedGutter ? gutterW : 0,
    docHeight: docH,
    scrollHeight: docH + scrollGap(cm) + d.barHeight,
    nativeBarWidth: d.nativeBarWidth,
    gutterWidth: gutterW
  }
}

var NativeScrollbars = function(place, scroll, cm) {
  this.cm = cm
  var vert = this.vert = elt("div", [elt("div", null, null, "min-width: 1px")], "CodeMirror-vscrollbar")
  var horiz = this.horiz = elt("div", [elt("div", null, null, "height: 100%; min-height: 1px")], "CodeMirror-hscrollbar")
  place(vert); place(horiz)

  on(vert, "scroll", function () {
    if (vert.clientHeight) { scroll(vert.scrollTop, "vertical") }
  })
  on(horiz, "scroll", function () {
    if (horiz.clientWidth) { scroll(horiz.scrollLeft, "horizontal") }
  })

  this.checkedZeroWidth = false
  // Need to set a minimum width to see the scrollbar on IE7 (but must not set it on IE8).
  if (ie && ie_version < 8) { this.horiz.style.minHeight = this.vert.style.minWidth = "18px" }
};

NativeScrollbars.prototype.update = function (measure) {
  var needsH = measure.scrollWidth > measure.clientWidth + 1
  var needsV = measure.scrollHeight > measure.clientHeight + 1
  var sWidth = measure.nativeBarWidth

  if (needsV) {
    this.vert.style.display = "block"
    this.vert.style.bottom = needsH ? sWidth + "px" : "0"
    var totalHeight = measure.viewHeight - (needsH ? sWidth : 0)
    // A bug in IE8 can cause this value to be negative, so guard it.
    this.vert.firstChild.style.height =
      Math.max(0, measure.scrollHeight - measure.clientHeight + totalHeight) + "px"
  } else {
    this.vert.style.display = ""
    this.vert.firstChild.style.height = "0"
  }

  if (needsH) {
    this.horiz.style.display = "block"
    this.horiz.style.right = needsV ? sWidth + "px" : "0"
    this.horiz.style.left = measure.barLeft + "px"
    var totalWidth = measure.viewWidth - measure.barLeft - (needsV ? sWidth : 0)
    this.horiz.firstChild.style.width =
      Math.max(0, measure.scrollWidth - measure.clientWidth + totalWidth) + "px"
  } else {
    this.horiz.style.display = ""
    this.horiz.firstChild.style.width = "0"
  }

  if (!this.checkedZeroWidth && measure.clientHeight > 0) {
    if (sWidth == 0) { this.zeroWidthHack() }
    this.checkedZeroWidth = true
  }

  return {right: needsV ? sWidth : 0, bottom: needsH ? sWidth : 0}
};

NativeScrollbars.prototype.setScrollLeft = function (pos) {
  if (this.horiz.scrollLeft != pos) { this.horiz.scrollLeft = pos }
  if (this.disableHoriz) { this.enableZeroWidthBar(this.horiz, this.disableHoriz, "horiz") }
};

NativeScrollbars.prototype.setScrollTop = function (pos) {
  if (this.vert.scrollTop != pos) { this.vert.scrollTop = pos }
  if (this.disableVert) { this.enableZeroWidthBar(this.vert, this.disableVert, "vert") }
};

NativeScrollbars.prototype.zeroWidthHack = function () {
  var w = mac && !mac_geMountainLion ? "12px" : "18px"
  this.horiz.style.height = this.vert.style.width = w
  this.horiz.style.pointerEvents = this.vert.style.pointerEvents = "none"
  this.disableHoriz = new Delayed
  this.disableVert = new Delayed
};

NativeScrollbars.prototype.enableZeroWidthBar = function (bar, delay, type) {
  bar.style.pointerEvents = "auto"
  function maybeDisable() {
    // To find out whether the scrollbar is still visible, we
    // check whether the element under the pixel in the bottom
    // right corner of the scrollbar box is the scrollbar box
    // itself (when the bar is still visible) or its filler child
    // (when the bar is hidden). If it is still visible, we keep
    // it enabled, if it's hidden, we disable pointer events.
    var box = bar.getBoundingClientRect()
    var elt = type == "vert" ? document.elementFromPoint(box.right - 1, (box.top + box.bottom) / 2)
        : document.elementFromPoint((box.right + box.left) / 2, box.bottom - 1)
    if (elt != bar) { bar.style.pointerEvents = "none" }
    else { delay.set(1000, maybeDisable) }
  }
  delay.set(1000, maybeDisable)
};

NativeScrollbars.prototype.clear = function () {
  var parent = this.horiz.parentNode
  parent.removeChild(this.horiz)
  parent.removeChild(this.vert)
};

var NullScrollbars = function () {};

NullScrollbars.prototype.update = function () { return {bottom: 0, right: 0} };
NullScrollbars.prototype.setScrollLeft = function () {};
NullScrollbars.prototype.setScrollTop = function () {};
NullScrollbars.prototype.clear = function () {};

function updateScrollbars(cm, measure) {
  if (!measure) { measure = measureForScrollbars(cm) }
  var startWidth = cm.display.barWidth, startHeight = cm.display.barHeight
  updateScrollbarsInner(cm, measure)
  for (var i = 0; i < 4 && startWidth != cm.display.barWidth || startHeight != cm.display.barHeight; i++) {
    if (startWidth != cm.display.barWidth && cm.options.lineWrapping)
      { updateHeightsInViewport(cm) }
    updateScrollbarsInner(cm, measureForScrollbars(cm))
    startWidth = cm.display.barWidth; startHeight = cm.display.barHeight
  }
}

// Re-synchronize the fake scrollbars with the actual size of the
// content.
function updateScrollbarsInner(cm, measure) {
  var d = cm.display
  var sizes = d.scrollbars.update(measure)

  d.sizer.style.paddingRight = (d.barWidth = sizes.right) + "px"
  d.sizer.style.paddingBottom = (d.barHeight = sizes.bottom) + "px"
  d.heightForcer.style.borderBottom = sizes.bottom + "px solid transparent"

  if (sizes.right && sizes.bottom) {
    d.scrollbarFiller.style.display = "block"
    d.scrollbarFiller.style.height = sizes.bottom + "px"
    d.scrollbarFiller.style.width = sizes.right + "px"
  } else { d.scrollbarFiller.style.display = "" }
  if (sizes.bottom && cm.options.coverGutterNextToScrollbar && cm.options.fixedGutter) {
    d.gutterFiller.style.display = "block"
    d.gutterFiller.style.height = sizes.bottom + "px"
    d.gutterFiller.style.width = measure.gutterWidth + "px"
  } else { d.gutterFiller.style.display = "" }
}

var scrollbarModel = {"native": NativeScrollbars, "null": NullScrollbars}

function initScrollbars(cm) {
  if (cm.display.scrollbars) {
    cm.display.scrollbars.clear()
    if (cm.display.scrollbars.addClass)
      { rmClass(cm.display.wrapper, cm.display.scrollbars.addClass) }
  }

  cm.display.scrollbars = new scrollbarModel[cm.options.scrollbarStyle](function (node) {
    cm.display.wrapper.insertBefore(node, cm.display.scrollbarFiller)
    // Prevent clicks in the scrollbars from killing focus
    on(node, "mousedown", function () {
      if (cm.state.focused) { setTimeout(function () { return cm.display.input.focus(); }, 0) }
    })
    node.setAttribute("cm-not-content", "true")
  }, function (pos, axis) {
    if (axis == "horizontal") { setScrollLeft(cm, pos) }
    else { updateScrollTop(cm, pos) }
  }, cm)
  if (cm.display.scrollbars.addClass)
    { addClass(cm.display.wrapper, cm.display.scrollbars.addClass) }
}

// Operations are used to wrap a series of changes to the editor
// state in such a way that each change won't have to update the
// cursor and display (which would be awkward, slow, and
// error-prone). Instead, display updates are batched and then all
// combined and executed at once.

var nextOpId = 0
// Start a new operation.
function startOperation(cm) {
  cm.curOp = {
    cm: cm,
    viewChanged: false,      // Flag that indicates that lines might need to be redrawn
    startHeight: cm.doc.height, // Used to detect need to update scrollbar
    forceUpdate: false,      // Used to force a redraw
    updateInput: null,       // Whether to reset the input textarea
    typing: false,           // Whether this reset should be careful to leave existing text (for compositing)
    changeObjs: null,        // Accumulated changes, for firing change events
    cursorActivityHandlers: null, // Set of handlers to fire cursorActivity on
    cursorActivityCalled: 0, // Tracks which cursorActivity handlers have been called already
    selectionChanged: false, // Whether the selection needs to be redrawn
    updateMaxLine: false,    // Set when the widest line needs to be determined anew
    scrollLeft: null, scrollTop: null, // Intermediate scroll position, not pushed to DOM yet
    scrollToPos: null,       // Used to scroll to a specific position
    focus: false,
    id: ++nextOpId           // Unique ID
  }
  pushOperation(cm.curOp)
}

// Finish an operation, updating the display and signalling delayed events
function endOperation(cm) {
  var op = cm.curOp
  finishOperation(op, function (group) {
    for (var i = 0; i < group.ops.length; i++)
      { group.ops[i].cm.curOp = null }
    endOperations(group)
  })
}

// The DOM updates done when an operation finishes are batched so
// that the minimum number of relayouts are required.
function endOperations(group) {
  var ops = group.ops
  for (var i = 0; i < ops.length; i++) // Read DOM
    { endOperation_R1(ops[i]) }
  for (var i$1 = 0; i$1 < ops.length; i$1++) // Write DOM (maybe)
    { endOperation_W1(ops[i$1]) }
  for (var i$2 = 0; i$2 < ops.length; i$2++) // Read DOM
    { endOperation_R2(ops[i$2]) }
  for (var i$3 = 0; i$3 < ops.length; i$3++) // Write DOM (maybe)
    { endOperation_W2(ops[i$3]) }
  for (var i$4 = 0; i$4 < ops.length; i$4++) // Read DOM
    { endOperation_finish(ops[i$4]) }
}

function endOperation_R1(op) {
  var cm = op.cm, display = cm.display
  maybeClipScrollbars(cm)
  if (op.updateMaxLine) { findMaxLine(cm) }

  op.mustUpdate = op.viewChanged || op.forceUpdate || op.scrollTop != null ||
    op.scrollToPos && (op.scrollToPos.from.line < display.viewFrom ||
                       op.scrollToPos.to.line >= display.viewTo) ||
    display.maxLineChanged && cm.options.lineWrapping
  op.update = op.mustUpdate &&
    new DisplayUpdate(cm, op.mustUpdate && {top: op.scrollTop, ensure: op.scrollToPos}, op.forceUpdate)
}

function endOperation_W1(op) {
  op.updatedDisplay = op.mustUpdate && updateDisplayIfNeeded(op.cm, op.update)
}

function endOperation_R2(op) {
  var cm = op.cm, display = cm.display
  if (op.updatedDisplay) { updateHeightsInViewport(cm) }

  op.barMeasure = measureForScrollbars(cm)

  // If the max line changed since it was last measured, measure it,
  // and ensure the document's width matches it.
  // updateDisplay_W2 will use these properties to do the actual resizing
  if (display.maxLineChanged && !cm.options.lineWrapping) {
    op.adjustWidthTo = measureChar(cm, display.maxLine, display.maxLine.text.length).left + 3
    cm.display.sizerWidth = op.adjustWidthTo
    op.barMeasure.scrollWidth =
      Math.max(display.scroller.clientWidth, display.sizer.offsetLeft + op.adjustWidthTo + scrollGap(cm) + cm.display.barWidth)
    op.maxScrollLeft = Math.max(0, display.sizer.offsetLeft + op.adjustWidthTo - displayWidth(cm))
  }

  if (op.updatedDisplay || op.selectionChanged)
    { op.preparedSelection = display.input.prepareSelection() }
}

function endOperation_W2(op) {
  var cm = op.cm

  if (op.adjustWidthTo != null) {
    cm.display.sizer.style.minWidth = op.adjustWidthTo + "px"
    if (op.maxScrollLeft < cm.doc.scrollLeft)
      { setScrollLeft(cm, Math.min(cm.display.scroller.scrollLeft, op.maxScrollLeft), true) }
    cm.display.maxLineChanged = false
  }

  var takeFocus = op.focus && op.focus == activeElt()
  if (op.preparedSelection)
    { cm.display.input.showSelection(op.preparedSelection, takeFocus) }
  if (op.updatedDisplay || op.startHeight != cm.doc.height)
    { updateScrollbars(cm, op.barMeasure) }
  if (op.updatedDisplay)
    { setDocumentHeight(cm, op.barMeasure) }

  if (op.selectionChanged) { restartBlink(cm) }

  if (cm.state.focused && op.updateInput)
    { cm.display.input.reset(op.typing) }
  if (takeFocus) { ensureFocus(op.cm) }
}

function endOperation_finish(op) {
  var cm = op.cm, display = cm.display, doc = cm.doc

  if (op.updatedDisplay) { postUpdateDisplay(cm, op.update) }

  // Abort mouse wheel delta measurement, when scrolling explicitly
  if (display.wheelStartX != null && (op.scrollTop != null || op.scrollLeft != null || op.scrollToPos))
    { display.wheelStartX = display.wheelStartY = null }

  // Propagate the scroll position to the actual DOM scroller
  if (op.scrollTop != null) { setScrollTop(cm, op.scrollTop, op.forceScroll) }

  if (op.scrollLeft != null) { setScrollLeft(cm, op.scrollLeft, true, true) }
  // If we need to scroll a specific position into view, do so.
  if (op.scrollToPos) {
    var rect = scrollPosIntoView(cm, clipPos(doc, op.scrollToPos.from),
                                 clipPos(doc, op.scrollToPos.to), op.scrollToPos.margin)
    maybeScrollWindow(cm, rect)
  }

  // Fire events for markers that are hidden/unidden by editing or
  // undoing
  var hidden = op.maybeHiddenMarkers, unhidden = op.maybeUnhiddenMarkers
  if (hidden) { for (var i = 0; i < hidden.length; ++i)
    { if (!hidden[i].lines.length) { signal(hidden[i], "hide") } } }
  if (unhidden) { for (var i$1 = 0; i$1 < unhidden.length; ++i$1)
    { if (unhidden[i$1].lines.length) { signal(unhidden[i$1], "unhide") } } }

  if (display.wrapper.offsetHeight)
    { doc.scrollTop = cm.display.scroller.scrollTop }

  // Fire change events, and delayed event handlers
  if (op.changeObjs)
    { signal(cm, "changes", cm, op.changeObjs) }
  if (op.update)
    { op.update.finish() }
}

// Run the given function in an operation
function runInOp(cm, f) {
  if (cm.curOp) { return f() }
  startOperation(cm)
  try { return f() }
  finally { endOperation(cm) }
}
// Wraps a function in an operation. Returns the wrapped function.
function operation(cm, f) {
  return function() {
    if (cm.curOp) { return f.apply(cm, arguments) }
    startOperation(cm)
    try { return f.apply(cm, arguments) }
    finally { endOperation(cm) }
  }
}
// Used to add methods to editor and doc instances, wrapping them in
// operations.
function methodOp(f) {
  return function() {
    if (this.curOp) { return f.apply(this, arguments) }
    startOperation(this)
    try { return f.apply(this, arguments) }
    finally { endOperation(this) }
  }
}
function docMethodOp(f) {
  return function() {
    var cm = this.cm
    if (!cm || cm.curOp) { return f.apply(this, arguments) }
    startOperation(cm)
    try { return f.apply(this, arguments) }
    finally { endOperation(cm) }
  }
}

// Updates the display.view data structure for a given change to the
// document. From and to are in pre-change coordinates. Lendiff is
// the amount of lines added or subtracted by the change. This is
// used for changes that span multiple lines, or change the way
// lines are divided into visual lines. regLineChange (below)
// registers single-line changes.
function regChange(cm, from, to, lendiff) {
  if (from == null) { from = cm.doc.first }
  if (to == null) { to = cm.doc.first + cm.doc.size }
  if (!lendiff) { lendiff = 0 }

  var display = cm.display
  if (lendiff && to < display.viewTo &&
      (display.updateLineNumbers == null || display.updateLineNumbers > from))
    { display.updateLineNumbers = from }

  cm.curOp.viewChanged = true

  if (from >= display.viewTo) { // Change after
    if (sawCollapsedSpans && visualLineNo(cm.doc, from) < display.viewTo)
      { resetView(cm) }
  } else if (to <= display.viewFrom) { // Change before
    if (sawCollapsedSpans && visualLineEndNo(cm.doc, to + lendiff) > display.viewFrom) {
      resetView(cm)
    } else {
      display.viewFrom += lendiff
      display.viewTo += lendiff
    }
  } else if (from <= display.viewFrom && to >= display.viewTo) { // Full overlap
    resetView(cm)
  } else if (from <= display.viewFrom) { // Top overlap
    var cut = viewCuttingPoint(cm, to, to + lendiff, 1)
    if (cut) {
      display.view = display.view.slice(cut.index)
      display.viewFrom = cut.lineN
      display.viewTo += lendiff
    } else {
      resetView(cm)
    }
  } else if (to >= display.viewTo) { // Bottom overlap
    var cut$1 = viewCuttingPoint(cm, from, from, -1)
    if (cut$1) {
      display.view = display.view.slice(0, cut$1.index)
      display.viewTo = cut$1.lineN
    } else {
      resetView(cm)
    }
  } else { // Gap in the middle
    var cutTop = viewCuttingPoint(cm, from, from, -1)
    var cutBot = viewCuttingPoint(cm, to, to + lendiff, 1)
    if (cutTop && cutBot) {
      display.view = display.view.slice(0, cutTop.index)
        .concat(buildViewArray(cm, cutTop.lineN, cutBot.lineN))
        .concat(display.view.slice(cutBot.index))
      display.viewTo += lendiff
    } else {
      resetView(cm)
    }
  }

  var ext = display.externalMeasured
  if (ext) {
    if (to < ext.lineN)
      { ext.lineN += lendiff }
    else if (from < ext.lineN + ext.size)
      { display.externalMeasured = null }
  }
}

// Register a change to a single line. Type must be one of "text",
// "gutter", "class", "widget"
function regLineChange(cm, line, type) {
  cm.curOp.viewChanged = true
  var display = cm.display, ext = cm.display.externalMeasured
  if (ext && line >= ext.lineN && line < ext.lineN + ext.size)
    { display.externalMeasured = null }

  if (line < display.viewFrom || line >= display.viewTo) { return }
  var lineView = display.view[findViewIndex(cm, line)]
  if (lineView.node == null) { return }
  var arr = lineView.changes || (lineView.changes = [])
  if (indexOf(arr, type) == -1) { arr.push(type) }
}

// Clear the view.
function resetView(cm) {
  cm.display.viewFrom = cm.display.viewTo = cm.doc.first
  cm.display.view = []
  cm.display.viewOffset = 0
}

function viewCuttingPoint(cm, oldN, newN, dir) {
  var index = findViewIndex(cm, oldN), diff, view = cm.display.view
  if (!sawCollapsedSpans || newN == cm.doc.first + cm.doc.size)
    { return {index: index, lineN: newN} }
  var n = cm.display.viewFrom
  for (var i = 0; i < index; i++)
    { n += view[i].size }
  if (n != oldN) {
    if (dir > 0) {
      if (index == view.length - 1) { return null }
      diff = (n + view[index].size) - oldN
      index++
    } else {
      diff = n - oldN
    }
    oldN += diff; newN += diff
  }
  while (visualLineNo(cm.doc, newN) != newN) {
    if (index == (dir < 0 ? 0 : view.length - 1)) { return null }
    newN += dir * view[index - (dir < 0 ? 1 : 0)].size
    index += dir
  }
  return {index: index, lineN: newN}
}

// Force the view to cover a given range, adding empty view element
// or clipping off existing ones as needed.
function adjustView(cm, from, to) {
  var display = cm.display, view = display.view
  if (view.length == 0 || from >= display.viewTo || to <= display.viewFrom) {
    display.view = buildViewArray(cm, from, to)
    display.viewFrom = from
  } else {
    if (display.viewFrom > from)
      { display.view = buildViewArray(cm, from, display.viewFrom).concat(display.view) }
    else if (display.viewFrom < from)
      { display.view = display.view.slice(findViewIndex(cm, from)) }
    display.viewFrom = from
    if (display.viewTo < to)
      { display.view = display.view.concat(buildViewArray(cm, display.viewTo, to)) }
    else if (display.viewTo > to)
      { display.view = display.view.slice(0, findViewIndex(cm, to)) }
  }
  display.viewTo = to
}

// Count the number of lines in the view whose DOM representation is
// out of date (or nonexistent).
function countDirtyView(cm) {
  var view = cm.display.view, dirty = 0
  for (var i = 0; i < view.length; i++) {
    var lineView = view[i]
    if (!lineView.hidden && (!lineView.node || lineView.changes)) { ++dirty }
  }
  return dirty
}

// HIGHLIGHT WORKER

function startWorker(cm, time) {
  if (cm.doc.highlightFrontier < cm.display.viewTo)
    { cm.state.highlight.set(time, bind(highlightWorker, cm)) }
}

function highlightWorker(cm) {
  var doc = cm.doc
  if (doc.highlightFrontier >= cm.display.viewTo) { return }
  var end = +new Date + cm.options.workTime
  var context = getContextBefore(cm, doc.highlightFrontier)
  var changedLines = []

  doc.iter(context.line, Math.min(doc.first + doc.size, cm.display.viewTo + 500), function (line) {
    if (context.line >= cm.display.viewFrom) { // Visible
      var oldStyles = line.styles
      var resetState = line.text.length > cm.options.maxHighlightLength ? copyState(doc.mode, context.state) : null
      var highlighted = highlightLine(cm, line, context, true)
      if (resetState) { context.state = resetState }
      line.styles = highlighted.styles
      var oldCls = line.styleClasses, newCls = highlighted.classes
      if (newCls) { line.styleClasses = newCls }
      else if (oldCls) { line.styleClasses = null }
      var ischange = !oldStyles || oldStyles.length != line.styles.length ||
        oldCls != newCls && (!oldCls || !newCls || oldCls.bgClass != newCls.bgClass || oldCls.textClass != newCls.textClass)
      for (var i = 0; !ischange && i < oldStyles.length; ++i) { ischange = oldStyles[i] != line.styles[i] }
      if (ischange) { changedLines.push(context.line) }
      line.stateAfter = context.save()
      context.nextLine()
    } else {
      if (line.text.length <= cm.options.maxHighlightLength)
        { processLine(cm, line.text, context) }
      line.stateAfter = context.line % 5 == 0 ? context.save() : null
      context.nextLine()
    }
    if (+new Date > end) {
      startWorker(cm, cm.options.workDelay)
      return true
    }
  })
  doc.highlightFrontier = context.line
  doc.modeFrontier = Math.max(doc.modeFrontier, context.line)
  if (changedLines.length) { runInOp(cm, function () {
    for (var i = 0; i < changedLines.length; i++)
      { regLineChange(cm, changedLines[i], "text") }
  }) }
}

// DISPLAY DRAWING

var DisplayUpdate = function(cm, viewport, force) {
  var display = cm.display

  this.viewport = viewport
  // Store some values that we'll need later (but don't want to force a relayout for)
  this.visible = visibleLines(display, cm.doc, viewport)
  this.editorIsHidden = !display.wrapper.offsetWidth
  this.wrapperHeight = display.wrapper.clientHeight
  this.wrapperWidth = display.wrapper.clientWidth
  this.oldDisplayWidth = displayWidth(cm)
  this.force = force
  this.dims = getDimensions(cm)
  this.events = []
};

DisplayUpdate.prototype.signal = function (emitter, type) {
  if (hasHandler(emitter, type))
    { this.events.push(arguments) }
};
DisplayUpdate.prototype.finish = function () {
    var this$1 = this;

  for (var i = 0; i < this.events.length; i++)
    { signal.apply(null, this$1.events[i]) }
};

function maybeClipScrollbars(cm) {
  var display = cm.display
  if (!display.scrollbarsClipped && display.scroller.offsetWidth) {
    display.nativeBarWidth = display.scroller.offsetWidth - display.scroller.clientWidth
    display.heightForcer.style.height = scrollGap(cm) + "px"
    display.sizer.style.marginBottom = -display.nativeBarWidth + "px"
    display.sizer.style.borderRightWidth = scrollGap(cm) + "px"
    display.scrollbarsClipped = true
  }
}

function selectionSnapshot(cm) {
  if (cm.hasFocus()) { return null }
  var active = activeElt()
  if (!active || !contains(cm.display.lineDiv, active)) { return null }
  var result = {activeElt: active}
  if (window.getSelection) {
    var sel = window.getSelection()
    if (sel.anchorNode && sel.extend && contains(cm.display.lineDiv, sel.anchorNode)) {
      result.anchorNode = sel.anchorNode
      result.anchorOffset = sel.anchorOffset
      result.focusNode = sel.focusNode
      result.focusOffset = sel.focusOffset
    }
  }
  return result
}

function restoreSelection(snapshot) {
  if (!snapshot || !snapshot.activeElt || snapshot.activeElt == activeElt()) { return }
  snapshot.activeElt.focus()
  if (snapshot.anchorNode && contains(document.body, snapshot.anchorNode) && contains(document.body, snapshot.focusNode)) {
    var sel = window.getSelection(), range = document.createRange()
    range.setEnd(snapshot.anchorNode, snapshot.anchorOffset)
    range.collapse(false)
    sel.removeAllRanges()
    sel.addRange(range)
    sel.extend(snapshot.focusNode, snapshot.focusOffset)
  }
}

// Does the actual updating of the line display. Bails out
// (returning false) when there is nothing to be done and forced is
// false.
function updateDisplayIfNeeded(cm, update) {
  var display = cm.display, doc = cm.doc

  if (update.editorIsHidden) {
    resetView(cm)
    return false
  }

  // Bail out if the visible area is already rendered and nothing changed.
  if (!update.force &&
      update.visible.from >= display.viewFrom && update.visible.to <= display.viewTo &&
      (display.updateLineNumbers == null || display.updateLineNumbers >= display.viewTo) &&
      display.renderedView == display.view && countDirtyView(cm) == 0)
    { return false }

  if (maybeUpdateLineNumberWidth(cm)) {
    resetView(cm)
    update.dims = getDimensions(cm)
  }

  // Compute a suitable new viewport (from & to)
  var end = doc.first + doc.size
  var from = Math.max(update.visible.from - cm.options.viewportMargin, doc.first)
  var to = Math.min(end, update.visible.to + cm.options.viewportMargin)
  if (display.viewFrom < from && from - display.viewFrom < 20) { from = Math.max(doc.first, display.viewFrom) }
  if (display.viewTo > to && display.viewTo - to < 20) { to = Math.min(end, display.viewTo) }
  if (sawCollapsedSpans) {
    from = visualLineNo(cm.doc, from)
    to = visualLineEndNo(cm.doc, to)
  }

  var different = from != display.viewFrom || to != display.viewTo ||
    display.lastWrapHeight != update.wrapperHeight || display.lastWrapWidth != update.wrapperWidth
  adjustView(cm, from, to)

  display.viewOffset = heightAtLine(getLine(cm.doc, display.viewFrom))
  // Position the mover div to align with the current scroll position
  cm.display.mover.style.top = display.viewOffset + "px"

  var toUpdate = countDirtyView(cm)
  if (!different && toUpdate == 0 && !update.force && display.renderedView == display.view &&
      (display.updateLineNumbers == null || display.updateLineNumbers >= display.viewTo))
    { return false }

  // For big changes, we hide the enclosing element during the
  // update, since that speeds up the operations on most browsers.
  var selSnapshot = selectionSnapshot(cm)
  if (toUpdate > 4) { display.lineDiv.style.display = "none" }
  patchDisplay(cm, display.updateLineNumbers, update.dims)
  if (toUpdate > 4) { display.lineDiv.style.display = "" }
  display.renderedView = display.view
  // There might have been a widget with a focused element that got
  // hidden or updated, if so re-focus it.
  restoreSelection(selSnapshot)

  // Prevent selection and cursors from interfering with the scroll
  // width and height.
  removeChildren(display.cursorDiv)
  removeChildren(display.selectionDiv)
  display.gutters.style.height = display.sizer.style.minHeight = 0

  if (different) {
    display.lastWrapHeight = update.wrapperHeight
    display.lastWrapWidth = update.wrapperWidth
    startWorker(cm, 400)
  }

  display.updateLineNumbers = null

  return true
}

function postUpdateDisplay(cm, update) {
  var viewport = update.viewport

  for (var first = true;; first = false) {
    if (!first || !cm.options.lineWrapping || update.oldDisplayWidth == displayWidth(cm)) {
      // Clip forced viewport to actual scrollable area.
      if (viewport && viewport.top != null)
        { viewport = {top: Math.min(cm.doc.height + paddingVert(cm.display) - displayHeight(cm), viewport.top)} }
      // Updated line heights might result in the drawn area not
      // actually covering the viewport. Keep looping until it does.
      update.visible = visibleLines(cm.display, cm.doc, viewport)
      if (update.visible.from >= cm.display.viewFrom && update.visible.to <= cm.display.viewTo)
        { break }
    }
    if (!updateDisplayIfNeeded(cm, update)) { break }
    updateHeightsInViewport(cm)
    var barMeasure = measureForScrollbars(cm)
    updateSelection(cm)
    updateScrollbars(cm, barMeasure)
    setDocumentHeight(cm, barMeasure)
    update.force = false
  }

  update.signal(cm, "update", cm)
  if (cm.display.viewFrom != cm.display.reportedViewFrom || cm.display.viewTo != cm.display.reportedViewTo) {
    update.signal(cm, "viewportChange", cm, cm.display.viewFrom, cm.display.viewTo)
    cm.display.reportedViewFrom = cm.display.viewFrom; cm.display.reportedViewTo = cm.display.viewTo
  }
}

function updateDisplaySimple(cm, viewport) {
  var update = new DisplayUpdate(cm, viewport)
  if (updateDisplayIfNeeded(cm, update)) {
    updateHeightsInViewport(cm)
    postUpdateDisplay(cm, update)
    var barMeasure = measureForScrollbars(cm)
    updateSelection(cm)
    updateScrollbars(cm, barMeasure)
    setDocumentHeight(cm, barMeasure)
    update.finish()
  }
}

// Sync the actual display DOM structure with display.view, removing
// nodes for lines that are no longer in view, and creating the ones
// that are not there yet, and updating the ones that are out of
// date.
function patchDisplay(cm, updateNumbersFrom, dims) {
  var display = cm.display, lineNumbers = cm.options.lineNumbers
  var container = display.lineDiv, cur = container.firstChild

  function rm(node) {
    var next = node.nextSibling
    // Works around a throw-scroll bug in OS X Webkit
    if (webkit && mac && cm.display.currentWheelTarget == node)
      { node.style.display = "none" }
    else
      { node.parentNode.removeChild(node) }
    return next
  }

  var view = display.view, lineN = display.viewFrom
  // Loop over the elements in the view, syncing cur (the DOM nodes
  // in display.lineDiv) with the view as we go.
  for (var i = 0; i < view.length; i++) {
    var lineView = view[i]
    if (lineView.hidden) {
    } else if (!lineView.node || lineView.node.parentNode != container) { // Not drawn yet
      var node = buildLineElement(cm, lineView, lineN, dims)
      container.insertBefore(node, cur)
    } else { // Already drawn
      while (cur != lineView.node) { cur = rm(cur) }
      var updateNumber = lineNumbers && updateNumbersFrom != null &&
        updateNumbersFrom <= lineN && lineView.lineNumber
      if (lineView.changes) {
        if (indexOf(lineView.changes, "gutter") > -1) { updateNumber = false }
        updateLineForChanges(cm, lineView, lineN, dims)
      }
      if (updateNumber) {
        removeChildren(lineView.lineNumber)
        lineView.lineNumber.appendChild(document.createTextNode(lineNumberFor(cm.options, lineN)))
      }
      cur = lineView.node.nextSibling
    }
    lineN += lineView.size
  }
  while (cur) { cur = rm(cur) }
}

function updateGutterSpace(cm) {
  var width = cm.display.gutters.offsetWidth
  cm.display.sizer.style.marginLeft = width + "px"
}

function setDocumentHeight(cm, measure) {
  cm.display.sizer.style.minHeight = measure.docHeight + "px"
  cm.display.heightForcer.style.top = measure.docHeight + "px"
  cm.display.gutters.style.height = (measure.docHeight + cm.display.barHeight + scrollGap(cm)) + "px"
}

// Rebuild the gutter elements, ensure the margin to the left of the
// code matches their width.
function updateGutters(cm) {
  var gutters = cm.display.gutters, specs = cm.options.gutters
  removeChildren(gutters)
  var i = 0
  for (; i < specs.length; ++i) {
    var gutterClass = specs[i]
    var gElt = gutters.appendChild(elt("div", null, "CodeMirror-gutter " + gutterClass))
    if (gutterClass == "CodeMirror-linenumbers") {
      cm.display.lineGutter = gElt
      gElt.style.width = (cm.display.lineNumWidth || 1) + "px"
    }
  }
  gutters.style.display = i ? "" : "none"
  updateGutterSpace(cm)
}

// Make sure the gutters options contains the element
// "CodeMirror-linenumbers" when the lineNumbers option is true.
function setGuttersForLineNumbers(options) {
  var found = indexOf(options.gutters, "CodeMirror-linenumbers")
  if (found == -1 && options.lineNumbers) {
    options.gutters = options.gutters.concat(["CodeMirror-linenumbers"])
  } else if (found > -1 && !options.lineNumbers) {
    options.gutters = options.gutters.slice(0)
    options.gutters.splice(found, 1)
  }
}

var wheelSamples = 0;
var wheelPixelsPerUnit = null;
// Fill in a browser-detected starting value on browsers where we
// know one. These don't have to be accurate -- the result of them
// being wrong would just be a slight flicker on the first wheel
// scroll (if it is large enough).
if (ie) { wheelPixelsPerUnit = -.53 }
else if (gecko) { wheelPixelsPerUnit = 15 }
else if (chrome) { wheelPixelsPerUnit = -.7 }
else if (safari) { wheelPixelsPerUnit = -1/3 }

function wheelEventDelta(e) {
  var dx = e.wheelDeltaX, dy = e.wheelDeltaY
  if (dx == null && e.detail && e.axis == e.HORIZONTAL_AXIS) { dx = e.detail }
  if (dy == null && e.detail && e.axis == e.VERTICAL_AXIS) { dy = e.detail }
  else if (dy == null) { dy = e.wheelDelta }
  return {x: dx, y: dy}
}
function wheelEventPixels(e) {
  var delta = wheelEventDelta(e)
  delta.x *= wheelPixelsPerUnit
  delta.y *= wheelPixelsPerUnit
  return delta
}

function onScrollWheel(cm, e) {
  var delta = wheelEventDelta(e), dx = delta.x, dy = delta.y

  var display = cm.display, scroll = display.scroller
  // Quit if there's nothing to scroll here
  var canScrollX = scroll.scrollWidth > scroll.clientWidth
  var canScrollY = scroll.scrollHeight > scroll.clientHeight
  if (!(dx && canScrollX || dy && canScrollY)) { return }

  // Webkit browsers on OS X abort momentum scrolls when the target
  // of the scroll event is removed from the scrollable element.
  // This hack (see related code in patchDisplay) makes sure the
  // element is kept around.
  if (dy && mac && webkit) {
    outer: for (var cur = e.target, view = display.view; cur != scroll; cur = cur.parentNode) {
      for (var i = 0; i < view.length; i++) {
        if (view[i].node == cur) {
          cm.display.currentWheelTarget = cur
          break outer
        }
      }
    }
  }

  // On some browsers, horizontal scrolling will cause redraws to
  // happen before the gutter has been realigned, causing it to
  // wriggle around in a most unseemly way. When we have an
  // estimated pixels/delta value, we just handle horizontal
  // scrolling entirely here. It'll be slightly off from native, but
  // better than glitching out.
  if (dx && !gecko && !presto && wheelPixelsPerUnit != null) {
    if (dy && canScrollY)
      { updateScrollTop(cm, Math.max(0, scroll.scrollTop + dy * wheelPixelsPerUnit)) }
    setScrollLeft(cm, Math.max(0, scroll.scrollLeft + dx * wheelPixelsPerUnit))
    // Only prevent default scrolling if vertical scrolling is
    // actually possible. Otherwise, it causes vertical scroll
    // jitter on OSX trackpads when deltaX is small and deltaY
    // is large (issue #3579)
    if (!dy || (dy && canScrollY))
      { e_preventDefault(e) }
    display.wheelStartX = null // Abort measurement, if in progress
    return
  }

  // 'Project' the visible viewport to cover the area that is being
  // scrolled into view (if we know enough to estimate it).
  if (dy && wheelPixelsPerUnit != null) {
    var pixels = dy * wheelPixelsPerUnit
    var top = cm.doc.scrollTop, bot = top + display.wrapper.clientHeight
    if (pixels < 0) { top = Math.max(0, top + pixels - 50) }
    else { bot = Math.min(cm.doc.height, bot + pixels + 50) }
    updateDisplaySimple(cm, {top: top, bottom: bot})
  }

  if (wheelSamples < 20) {
    if (display.wheelStartX == null) {
      display.wheelStartX = scroll.scrollLeft; display.wheelStartY = scroll.scrollTop
      display.wheelDX = dx; display.wheelDY = dy
      setTimeout(function () {
        if (display.wheelStartX == null) { return }
        var movedX = scroll.scrollLeft - display.wheelStartX
        var movedY = scroll.scrollTop - display.wheelStartY
        var sample = (movedY && display.wheelDY && movedY / display.wheelDY) ||
          (movedX && display.wheelDX && movedX / display.wheelDX)
        display.wheelStartX = display.wheelStartY = null
        if (!sample) { return }
        wheelPixelsPerUnit = (wheelPixelsPerUnit * wheelSamples + sample) / (wheelSamples + 1)
        ++wheelSamples
      }, 200)
    } else {
      display.wheelDX += dx; display.wheelDY += dy
    }
  }
}

// Selection objects are immutable. A new one is created every time
// the selection changes. A selection is one or more non-overlapping
// (and non-touching) ranges, sorted, and an integer that indicates
// which one is the primary selection (the one that's scrolled into
// view, that getCursor returns, etc).
var Selection = function(ranges, primIndex) {
  this.ranges = ranges
  this.primIndex = primIndex
};

Selection.prototype.primary = function () { return this.ranges[this.primIndex] };

Selection.prototype.equals = function (other) {
    var this$1 = this;

  if (other == this) { return true }
  if (other.primIndex != this.primIndex || other.ranges.length != this.ranges.length) { return false }
  for (var i = 0; i < this.ranges.length; i++) {
    var here = this$1.ranges[i], there = other.ranges[i]
    if (!equalCursorPos(here.anchor, there.anchor) || !equalCursorPos(here.head, there.head)) { return false }
  }
  return true
};

Selection.prototype.deepCopy = function () {
    var this$1 = this;

  var out = []
  for (var i = 0; i < this.ranges.length; i++)
    { out[i] = new Range(copyPos(this$1.ranges[i].anchor), copyPos(this$1.ranges[i].head)) }
  return new Selection(out, this.primIndex)
};

Selection.prototype.somethingSelected = function () {
    var this$1 = this;

  for (var i = 0; i < this.ranges.length; i++)
    { if (!this$1.ranges[i].empty()) { return true } }
  return false
};

Selection.prototype.contains = function (pos, end) {
    var this$1 = this;

  if (!end) { end = pos }
  for (var i = 0; i < this.ranges.length; i++) {
    var range = this$1.ranges[i]
    if (cmp(end, range.from()) >= 0 && cmp(pos, range.to()) <= 0)
      { return i }
  }
  return -1
};

var Range = function(anchor, head) {
  this.anchor = anchor; this.head = head
};

Range.prototype.from = function () { return minPos(this.anchor, this.head) };
Range.prototype.to = function () { return maxPos(this.anchor, this.head) };
Range.prototype.empty = function () { return this.head.line == this.anchor.line && this.head.ch == this.anchor.ch };

// Take an unsorted, potentially overlapping set of ranges, and
// build a selection out of it. 'Consumes' ranges array (modifying
// it).
function normalizeSelection(ranges, primIndex) {
  var prim = ranges[primIndex]
  ranges.sort(function (a, b) { return cmp(a.from(), b.from()); })
  primIndex = indexOf(ranges, prim)
  for (var i = 1; i < ranges.length; i++) {
    var cur = ranges[i], prev = ranges[i - 1]
    if (cmp(prev.to(), cur.from()) >= 0) {
      var from = minPos(prev.from(), cur.from()), to = maxPos(prev.to(), cur.to())
      var inv = prev.empty() ? cur.from() == cur.head : prev.from() == prev.head
      if (i <= primIndex) { --primIndex }
      ranges.splice(--i, 2, new Range(inv ? to : from, inv ? from : to))
    }
  }
  return new Selection(ranges, primIndex)
}

function simpleSelection(anchor, head) {
  return new Selection([new Range(anchor, head || anchor)], 0)
}

// Compute the position of the end of a change (its 'to' property
// refers to the pre-change end).
function changeEnd(change) {
  if (!change.text) { return change.to }
  return Pos(change.from.line + change.text.length - 1,
             lst(change.text).length + (change.text.length == 1 ? change.from.ch : 0))
}

// Adjust a position to refer to the post-change position of the
// same text, or the end of the change if the change covers it.
function adjustForChange(pos, change) {
  if (cmp(pos, change.from) < 0) { return pos }
  if (cmp(pos, change.to) <= 0) { return changeEnd(change) }

  var line = pos.line + change.text.length - (change.to.line - change.from.line) - 1, ch = pos.ch
  if (pos.line == change.to.line) { ch += changeEnd(change).ch - change.to.ch }
  return Pos(line, ch)
}

function computeSelAfterChange(doc, change) {
  var out = []
  for (var i = 0; i < doc.sel.ranges.length; i++) {
    var range = doc.sel.ranges[i]
    out.push(new Range(adjustForChange(range.anchor, change),
                       adjustForChange(range.head, change)))
  }
  return normalizeSelection(out, doc.sel.primIndex)
}

function offsetPos(pos, old, nw) {
  if (pos.line == old.line)
    { return Pos(nw.line, pos.ch - old.ch + nw.ch) }
  else
    { return Pos(nw.line + (pos.line - old.line), pos.ch) }
}

// Used by replaceSelections to allow moving the selection to the
// start or around the replaced test. Hint may be "start" or "around".
function computeReplacedSel(doc, changes, hint) {
  var out = []
  var oldPrev = Pos(doc.first, 0), newPrev = oldPrev
  for (var i = 0; i < changes.length; i++) {
    var change = changes[i]
    var from = offsetPos(change.from, oldPrev, newPrev)
    var to = offsetPos(changeEnd(change), oldPrev, newPrev)
    oldPrev = change.to
    newPrev = to
    if (hint == "around") {
      var range = doc.sel.ranges[i], inv = cmp(range.head, range.anchor) < 0
      out[i] = new Range(inv ? to : from, inv ? from : to)
    } else {
      out[i] = new Range(from, from)
    }
  }
  return new Selection(out, doc.sel.primIndex)
}

// Used to get the editor into a consistent state again when options change.

function loadMode(cm) {
  cm.doc.mode = getMode(cm.options, cm.doc.modeOption)
  resetModeState(cm)
}

function resetModeState(cm) {
  cm.doc.iter(function (line) {
    if (line.stateAfter) { line.stateAfter = null }
    if (line.styles) { line.styles = null }
  })
  cm.doc.modeFrontier = cm.doc.highlightFrontier = cm.doc.first
  startWorker(cm, 100)
  cm.state.modeGen++
  if (cm.curOp) { regChange(cm) }
}

// DOCUMENT DATA STRUCTURE

// By default, updates that start and end at the beginning of a line
// are treated specially, in order to make the association of line
// widgets and marker elements with the text behave more intuitive.
function isWholeLineUpdate(doc, change) {
  return change.from.ch == 0 && change.to.ch == 0 && lst(change.text) == "" &&
    (!doc.cm || doc.cm.options.wholeLineUpdateBefore)
}

// Perform a change on the document data structure.
function updateDoc(doc, change, markedSpans, estimateHeight) {
  function spansFor(n) {return markedSpans ? markedSpans[n] : null}
  function update(line, text, spans) {
    updateLine(line, text, spans, estimateHeight)
    signalLater(line, "change", line, change)
  }
  function linesFor(start, end) {
    var result = []
    for (var i = start; i < end; ++i)
      { result.push(new Line(text[i], spansFor(i), estimateHeight)) }
    return result
  }

  var from = change.from, to = change.to, text = change.text
  var firstLine = getLine(doc, from.line), lastLine = getLine(doc, to.line)
  var lastText = lst(text), lastSpans = spansFor(text.length - 1), nlines = to.line - from.line

  // Adjust the line structure
  if (change.full) {
    doc.insert(0, linesFor(0, text.length))
    doc.remove(text.length, doc.size - text.length)
  } else if (isWholeLineUpdate(doc, change)) {
    // This is a whole-line replace. Treated specially to make
    // sure line objects move the way they are supposed to.
    var added = linesFor(0, text.length - 1)
    update(lastLine, lastLine.text, lastSpans)
    if (nlines) { doc.remove(from.line, nlines) }
    if (added.length) { doc.insert(from.line, added) }
  } else if (firstLine == lastLine) {
    if (text.length == 1) {
      update(firstLine, firstLine.text.slice(0, from.ch) + lastText + firstLine.text.slice(to.ch), lastSpans)
    } else {
      var added$1 = linesFor(1, text.length - 1)
      added$1.push(new Line(lastText + firstLine.text.slice(to.ch), lastSpans, estimateHeight))
      update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0))
      doc.insert(from.line + 1, added$1)
    }
  } else if (text.length == 1) {
    update(firstLine, firstLine.text.slice(0, from.ch) + text[0] + lastLine.text.slice(to.ch), spansFor(0))
    doc.remove(from.line + 1, nlines)
  } else {
    update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0))
    update(lastLine, lastText + lastLine.text.slice(to.ch), lastSpans)
    var added$2 = linesFor(1, text.length - 1)
    if (nlines > 1) { doc.remove(from.line + 1, nlines - 1) }
    doc.insert(from.line + 1, added$2)
  }

  signalLater(doc, "change", doc, change)
}

// Call f for all linked documents.
function linkedDocs(doc, f, sharedHistOnly) {
  function propagate(doc, skip, sharedHist) {
    if (doc.linked) { for (var i = 0; i < doc.linked.length; ++i) {
      var rel = doc.linked[i]
      if (rel.doc == skip) { continue }
      var shared = sharedHist && rel.sharedHist
      if (sharedHistOnly && !shared) { continue }
      f(rel.doc, shared)
      propagate(rel.doc, doc, shared)
    } }
  }
  propagate(doc, null, true)
}

// Attach a document to an editor.
function attachDoc(cm, doc) {
  if (doc.cm) { throw new Error("This document is already in use.") }
  cm.doc = doc
  doc.cm = cm
  estimateLineHeights(cm)
  loadMode(cm)
  setDirectionClass(cm)
  if (!cm.options.lineWrapping) { findMaxLine(cm) }
  cm.options.mode = doc.modeOption
  regChange(cm)
}

function setDirectionClass(cm) {
  ;(cm.doc.direction == "rtl" ? addClass : rmClass)(cm.display.lineDiv, "CodeMirror-rtl")
}

function directionChanged(cm) {
  runInOp(cm, function () {
    setDirectionClass(cm)
    regChange(cm)
  })
}

function History(startGen) {
  // Arrays of change events and selections. Doing something adds an
  // event to done and clears undo. Undoing moves events from done
  // to undone, redoing moves them in the other direction.
  this.done = []; this.undone = []
  this.undoDepth = Infinity
  // Used to track when changes can be merged into a single undo
  // event
  this.lastModTime = this.lastSelTime = 0
  this.lastOp = this.lastSelOp = null
  this.lastOrigin = this.lastSelOrigin = null
  // Used by the isClean() method
  this.generation = this.maxGeneration = startGen || 1
}

// Create a history change event from an updateDoc-style change
// object.
function historyChangeFromChange(doc, change) {
  var histChange = {from: copyPos(change.from), to: changeEnd(change), text: getBetween(doc, change.from, change.to)}
  attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1)
  linkedDocs(doc, function (doc) { return attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1); }, true)
  return histChange
}

// Pop all selection events off the end of a history array. Stop at
// a change event.
function clearSelectionEvents(array) {
  while (array.length) {
    var last = lst(array)
    if (last.ranges) { array.pop() }
    else { break }
  }
}

// Find the top change event in the history. Pop off selection
// events that are in the way.
function lastChangeEvent(hist, force) {
  if (force) {
    clearSelectionEvents(hist.done)
    return lst(hist.done)
  } else if (hist.done.length && !lst(hist.done).ranges) {
    return lst(hist.done)
  } else if (hist.done.length > 1 && !hist.done[hist.done.length - 2].ranges) {
    hist.done.pop()
    return lst(hist.done)
  }
}

// Register a change in the history. Merges changes that are within
// a single operation, or are close together with an origin that
// allows merging (starting with "+") into a single event.
function addChangeToHistory(doc, change, selAfter, opId) {
  var hist = doc.history
  hist.undone.length = 0
  var time = +new Date, cur
  var last

  if ((hist.lastOp == opId ||
       hist.lastOrigin == change.origin && change.origin &&
       ((change.origin.charAt(0) == "+" && doc.cm && hist.lastModTime > time - doc.cm.options.historyEventDelay) ||
        change.origin.charAt(0) == "*")) &&
      (cur = lastChangeEvent(hist, hist.lastOp == opId))) {
    // Merge this change into the last event
    last = lst(cur.changes)
    if (cmp(change.from, change.to) == 0 && cmp(change.from, last.to) == 0) {
      // Optimized case for simple insertion -- don't want to add
      // new changesets for every character typed
      last.to = changeEnd(change)
    } else {
      // Add new sub-event
      cur.changes.push(historyChangeFromChange(doc, change))
    }
  } else {
    // Can not be merged, start a new event.
    var before = lst(hist.done)
    if (!before || !before.ranges)
      { pushSelectionToHistory(doc.sel, hist.done) }
    cur = {changes: [historyChangeFromChange(doc, change)],
           generation: hist.generation}
    hist.done.push(cur)
    while (hist.done.length > hist.undoDepth) {
      hist.done.shift()
      if (!hist.done[0].ranges) { hist.done.shift() }
    }
  }
  hist.done.push(selAfter)
  hist.generation = ++hist.maxGeneration
  hist.lastModTime = hist.lastSelTime = time
  hist.lastOp = hist.lastSelOp = opId
  hist.lastOrigin = hist.lastSelOrigin = change.origin

  if (!last) { signal(doc, "historyAdded") }
}

function selectionEventCanBeMerged(doc, origin, prev, sel) {
  var ch = origin.charAt(0)
  return ch == "*" ||
    ch == "+" &&
    prev.ranges.length == sel.ranges.length &&
    prev.somethingSelected() == sel.somethingSelected() &&
    new Date - doc.history.lastSelTime <= (doc.cm ? doc.cm.options.historyEventDelay : 500)
}

// Called whenever the selection changes, sets the new selection as
// the pending selection in the history, and pushes the old pending
// selection into the 'done' array when it was significantly
// different (in number of selected ranges, emptiness, or time).
function addSelectionToHistory(doc, sel, opId, options) {
  var hist = doc.history, origin = options && options.origin

  // A new event is started when the previous origin does not match
  // the current, or the origins don't allow matching. Origins
  // starting with * are always merged, those starting with + are
  // merged when similar and close together in time.
  if (opId == hist.lastSelOp ||
      (origin && hist.lastSelOrigin == origin &&
       (hist.lastModTime == hist.lastSelTime && hist.lastOrigin == origin ||
        selectionEventCanBeMerged(doc, origin, lst(hist.done), sel))))
    { hist.done[hist.done.length - 1] = sel }
  else
    { pushSelectionToHistory(sel, hist.done) }

  hist.lastSelTime = +new Date
  hist.lastSelOrigin = origin
  hist.lastSelOp = opId
  if (options && options.clearRedo !== false)
    { clearSelectionEvents(hist.undone) }
}

function pushSelectionToHistory(sel, dest) {
  var top = lst(dest)
  if (!(top && top.ranges && top.equals(sel)))
    { dest.push(sel) }
}

// Used to store marked span information in the history.
function attachLocalSpans(doc, change, from, to) {
  var existing = change["spans_" + doc.id], n = 0
  doc.iter(Math.max(doc.first, from), Math.min(doc.first + doc.size, to), function (line) {
    if (line.markedSpans)
      { (existing || (existing = change["spans_" + doc.id] = {}))[n] = line.markedSpans }
    ++n
  })
}

// When un/re-doing restores text containing marked spans, those
// that have been explicitly cleared should not be restored.
function removeClearedSpans(spans) {
  if (!spans) { return null }
  var out
  for (var i = 0; i < spans.length; ++i) {
    if (spans[i].marker.explicitlyCleared) { if (!out) { out = spans.slice(0, i) } }
    else if (out) { out.push(spans[i]) }
  }
  return !out ? spans : out.length ? out : null
}

// Retrieve and filter the old marked spans stored in a change event.
function getOldSpans(doc, change) {
  var found = change["spans_" + doc.id]
  if (!found) { return null }
  var nw = []
  for (var i = 0; i < change.text.length; ++i)
    { nw.push(removeClearedSpans(found[i])) }
  return nw
}

// Used for un/re-doing changes from the history. Combines the
// result of computing the existing spans with the set of spans that
// existed in the history (so that deleting around a span and then
// undoing brings back the span).
function mergeOldSpans(doc, change) {
  var old = getOldSpans(doc, change)
  var stretched = stretchSpansOverChange(doc, change)
  if (!old) { return stretched }
  if (!stretched) { return old }

  for (var i = 0; i < old.length; ++i) {
    var oldCur = old[i], stretchCur = stretched[i]
    if (oldCur && stretchCur) {
      spans: for (var j = 0; j < stretchCur.length; ++j) {
        var span = stretchCur[j]
        for (var k = 0; k < oldCur.length; ++k)
          { if (oldCur[k].marker == span.marker) { continue spans } }
        oldCur.push(span)
      }
    } else if (stretchCur) {
      old[i] = stretchCur
    }
  }
  return old
}

// Used both to provide a JSON-safe object in .getHistory, and, when
// detaching a document, to split the history in two
function copyHistoryArray(events, newGroup, instantiateSel) {
  var copy = []
  for (var i = 0; i < events.length; ++i) {
    var event = events[i]
    if (event.ranges) {
      copy.push(instantiateSel ? Selection.prototype.deepCopy.call(event) : event)
      continue
    }
    var changes = event.changes, newChanges = []
    copy.push({changes: newChanges})
    for (var j = 0; j < changes.length; ++j) {
      var change = changes[j], m = (void 0)
      newChanges.push({from: change.from, to: change.to, text: change.text})
      if (newGroup) { for (var prop in change) { if (m = prop.match(/^spans_(\d+)$/)) {
        if (indexOf(newGroup, Number(m[1])) > -1) {
          lst(newChanges)[prop] = change[prop]
          delete change[prop]
        }
      } } }
    }
  }
  return copy
}

// The 'scroll' parameter given to many of these indicated whether
// the new cursor position should be scrolled into view after
// modifying the selection.

// If shift is held or the extend flag is set, extends a range to
// include a given position (and optionally a second position).
// Otherwise, simply returns the range between the given positions.
// Used for cursor motion and such.
function extendRange(range, head, other, extend) {
  if (extend) {
    var anchor = range.anchor
    if (other) {
      var posBefore = cmp(head, anchor) < 0
      if (posBefore != (cmp(other, anchor) < 0)) {
        anchor = head
        head = other
      } else if (posBefore != (cmp(head, other) < 0)) {
        head = other
      }
    }
    return new Range(anchor, head)
  } else {
    return new Range(other || head, head)
  }
}

// Extend the primary selection range, discard the rest.
function extendSelection(doc, head, other, options, extend) {
  if (extend == null) { extend = doc.cm && (doc.cm.display.shift || doc.extend) }
  setSelection(doc, new Selection([extendRange(doc.sel.primary(), head, other, extend)], 0), options)
}

// Extend all selections (pos is an array of selections with length
// equal the number of selections)
function extendSelections(doc, heads, options) {
  var out = []
  var extend = doc.cm && (doc.cm.display.shift || doc.extend)
  for (var i = 0; i < doc.sel.ranges.length; i++)
    { out[i] = extendRange(doc.sel.ranges[i], heads[i], null, extend) }
  var newSel = normalizeSelection(out, doc.sel.primIndex)
  setSelection(doc, newSel, options)
}

// Updates a single range in the selection.
function replaceOneSelection(doc, i, range, options) {
  var ranges = doc.sel.ranges.slice(0)
  ranges[i] = range
  setSelection(doc, normalizeSelection(ranges, doc.sel.primIndex), options)
}

// Reset the selection to a single range.
function setSimpleSelection(doc, anchor, head, options) {
  setSelection(doc, simpleSelection(anchor, head), options)
}

// Give beforeSelectionChange handlers a change to influence a
// selection update.
function filterSelectionChange(doc, sel, options) {
  var obj = {
    ranges: sel.ranges,
    update: function(ranges) {
      var this$1 = this;

      this.ranges = []
      for (var i = 0; i < ranges.length; i++)
        { this$1.ranges[i] = new Range(clipPos(doc, ranges[i].anchor),
                                   clipPos(doc, ranges[i].head)) }
    },
    origin: options && options.origin
  }
  signal(doc, "beforeSelectionChange", doc, obj)
  if (doc.cm) { signal(doc.cm, "beforeSelectionChange", doc.cm, obj) }
  if (obj.ranges != sel.ranges) { return normalizeSelection(obj.ranges, obj.ranges.length - 1) }
  else { return sel }
}

function setSelectionReplaceHistory(doc, sel, options) {
  var done = doc.history.done, last = lst(done)
  if (last && last.ranges) {
    done[done.length - 1] = sel
    setSelectionNoUndo(doc, sel, options)
  } else {
    setSelection(doc, sel, options)
  }
}

// Set a new selection.
function setSelection(doc, sel, options) {
  setSelectionNoUndo(doc, sel, options)
  addSelectionToHistory(doc, doc.sel, doc.cm ? doc.cm.curOp.id : NaN, options)
}

function setSelectionNoUndo(doc, sel, options) {
  if (hasHandler(doc, "beforeSelectionChange") || doc.cm && hasHandler(doc.cm, "beforeSelectionChange"))
    { sel = filterSelectionChange(doc, sel, options) }

  var bias = options && options.bias ||
    (cmp(sel.primary().head, doc.sel.primary().head) < 0 ? -1 : 1)
  setSelectionInner(doc, skipAtomicInSelection(doc, sel, bias, true))

  if (!(options && options.scroll === false) && doc.cm)
    { ensureCursorVisible(doc.cm) }
}

function setSelectionInner(doc, sel) {
  if (sel.equals(doc.sel)) { return }

  doc.sel = sel

  if (doc.cm) {
    doc.cm.curOp.updateInput = doc.cm.curOp.selectionChanged = true
    signalCursorActivity(doc.cm)
  }
  signalLater(doc, "cursorActivity", doc)
}

// Verify that the selection does not partially select any atomic
// marked ranges.
function reCheckSelection(doc) {
  setSelectionInner(doc, skipAtomicInSelection(doc, doc.sel, null, false))
}

// Return a selection that does not partially select any atomic
// ranges.
function skipAtomicInSelection(doc, sel, bias, mayClear) {
  var out
  for (var i = 0; i < sel.ranges.length; i++) {
    var range = sel.ranges[i]
    var old = sel.ranges.length == doc.sel.ranges.length && doc.sel.ranges[i]
    var newAnchor = skipAtomic(doc, range.anchor, old && old.anchor, bias, mayClear)
    var newHead = skipAtomic(doc, range.head, old && old.head, bias, mayClear)
    if (out || newAnchor != range.anchor || newHead != range.head) {
      if (!out) { out = sel.ranges.slice(0, i) }
      out[i] = new Range(newAnchor, newHead)
    }
  }
  return out ? normalizeSelection(out, sel.primIndex) : sel
}

function skipAtomicInner(doc, pos, oldPos, dir, mayClear) {
  var line = getLine(doc, pos.line)
  if (line.markedSpans) { for (var i = 0; i < line.markedSpans.length; ++i) {
    var sp = line.markedSpans[i], m = sp.marker
    if ((sp.from == null || (m.inclusiveLeft ? sp.from <= pos.ch : sp.from < pos.ch)) &&
        (sp.to == null || (m.inclusiveRight ? sp.to >= pos.ch : sp.to > pos.ch))) {
      if (mayClear) {
        signal(m, "beforeCursorEnter")
        if (m.explicitlyCleared) {
          if (!line.markedSpans) { break }
          else {--i; continue}
        }
      }
      if (!m.atomic) { continue }

      if (oldPos) {
        var near = m.find(dir < 0 ? 1 : -1), diff = (void 0)
        if (dir < 0 ? m.inclusiveRight : m.inclusiveLeft)
          { near = movePos(doc, near, -dir, near && near.line == pos.line ? line : null) }
        if (near && near.line == pos.line && (diff = cmp(near, oldPos)) && (dir < 0 ? diff < 0 : diff > 0))
          { return skipAtomicInner(doc, near, pos, dir, mayClear) }
      }

      var far = m.find(dir < 0 ? -1 : 1)
      if (dir < 0 ? m.inclusiveLeft : m.inclusiveRight)
        { far = movePos(doc, far, dir, far.line == pos.line ? line : null) }
      return far ? skipAtomicInner(doc, far, pos, dir, mayClear) : null
    }
  } }
  return pos
}

// Ensure a given position is not inside an atomic range.
function skipAtomic(doc, pos, oldPos, bias, mayClear) {
  var dir = bias || 1
  var found = skipAtomicInner(doc, pos, oldPos, dir, mayClear) ||
      (!mayClear && skipAtomicInner(doc, pos, oldPos, dir, true)) ||
      skipAtomicInner(doc, pos, oldPos, -dir, mayClear) ||
      (!mayClear && skipAtomicInner(doc, pos, oldPos, -dir, true))
  if (!found) {
    doc.cantEdit = true
    return Pos(doc.first, 0)
  }
  return found
}

function movePos(doc, pos, dir, line) {
  if (dir < 0 && pos.ch == 0) {
    if (pos.line > doc.first) { return clipPos(doc, Pos(pos.line - 1)) }
    else { return null }
  } else if (dir > 0 && pos.ch == (line || getLine(doc, pos.line)).text.length) {
    if (pos.line < doc.first + doc.size - 1) { return Pos(pos.line + 1, 0) }
    else { return null }
  } else {
    return new Pos(pos.line, pos.ch + dir)
  }
}

function selectAll(cm) {
  cm.setSelection(Pos(cm.firstLine(), 0), Pos(cm.lastLine()), sel_dontScroll)
}

// UPDATING

// Allow "beforeChange" event handlers to influence a change
function filterChange(doc, change, update) {
  var obj = {
    canceled: false,
    from: change.from,
    to: change.to,
    text: change.text,
    origin: change.origin,
    cancel: function () { return obj.canceled = true; }
  }
  if (update) { obj.update = function (from, to, text, origin) {
    if (from) { obj.from = clipPos(doc, from) }
    if (to) { obj.to = clipPos(doc, to) }
    if (text) { obj.text = text }
    if (origin !== undefined) { obj.origin = origin }
  } }
  signal(doc, "beforeChange", doc, obj)
  if (doc.cm) { signal(doc.cm, "beforeChange", doc.cm, obj) }

  if (obj.canceled) { return null }
  return {from: obj.from, to: obj.to, text: obj.text, origin: obj.origin}
}

// Apply a change to a document, and add it to the document's
// history, and propagating it to all linked documents.
function makeChange(doc, change, ignoreReadOnly) {
  if (doc.cm) {
    if (!doc.cm.curOp) { return operation(doc.cm, makeChange)(doc, change, ignoreReadOnly) }
    if (doc.cm.state.suppressEdits) { return }
  }

  if (hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange")) {
    change = filterChange(doc, change, true)
    if (!change) { return }
  }

  // Possibly split or suppress the update based on the presence
  // of read-only spans in its range.
  var split = sawReadOnlySpans && !ignoreReadOnly && removeReadOnlyRanges(doc, change.from, change.to)
  if (split) {
    for (var i = split.length - 1; i >= 0; --i)
      { makeChangeInner(doc, {from: split[i].from, to: split[i].to, text: i ? [""] : change.text, origin: change.origin}) }
  } else {
    makeChangeInner(doc, change)
  }
}

function makeChangeInner(doc, change) {
  if (change.text.length == 1 && change.text[0] == "" && cmp(change.from, change.to) == 0) { return }
  var selAfter = computeSelAfterChange(doc, change)
  addChangeToHistory(doc, change, selAfter, doc.cm ? doc.cm.curOp.id : NaN)

  makeChangeSingleDoc(doc, change, selAfter, stretchSpansOverChange(doc, change))
  var rebased = []

  linkedDocs(doc, function (doc, sharedHist) {
    if (!sharedHist && indexOf(rebased, doc.history) == -1) {
      rebaseHist(doc.history, change)
      rebased.push(doc.history)
    }
    makeChangeSingleDoc(doc, change, null, stretchSpansOverChange(doc, change))
  })
}

// Revert a change stored in a document's history.
function makeChangeFromHistory(doc, type, allowSelectionOnly) {
  if (doc.cm && doc.cm.state.suppressEdits && !allowSelectionOnly) { return }

  var hist = doc.history, event, selAfter = doc.sel
  var source = type == "undo" ? hist.done : hist.undone, dest = type == "undo" ? hist.undone : hist.done

  // Verify that there is a useable event (so that ctrl-z won't
  // needlessly clear selection events)
  var i = 0
  for (; i < source.length; i++) {
    event = source[i]
    if (allowSelectionOnly ? event.ranges && !event.equals(doc.sel) : !event.ranges)
      { break }
  }
  if (i == source.length) { return }
  hist.lastOrigin = hist.lastSelOrigin = null

  for (;;) {
    event = source.pop()
    if (event.ranges) {
      pushSelectionToHistory(event, dest)
      if (allowSelectionOnly && !event.equals(doc.sel)) {
        setSelection(doc, event, {clearRedo: false})
        return
      }
      selAfter = event
    }
    else { break }
  }

  // Build up a reverse change object to add to the opposite history
  // stack (redo when undoing, and vice versa).
  var antiChanges = []
  pushSelectionToHistory(selAfter, dest)
  dest.push({changes: antiChanges, generation: hist.generation})
  hist.generation = event.generation || ++hist.maxGeneration

  var filter = hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange")

  var loop = function ( i ) {
    var change = event.changes[i]
    change.origin = type
    if (filter && !filterChange(doc, change, false)) {
      source.length = 0
      return {}
    }

    antiChanges.push(historyChangeFromChange(doc, change))

    var after = i ? computeSelAfterChange(doc, change) : lst(source)
    makeChangeSingleDoc(doc, change, after, mergeOldSpans(doc, change))
    if (!i && doc.cm) { doc.cm.scrollIntoView({from: change.from, to: changeEnd(change)}) }
    var rebased = []

    // Propagate to the linked documents
    linkedDocs(doc, function (doc, sharedHist) {
      if (!sharedHist && indexOf(rebased, doc.history) == -1) {
        rebaseHist(doc.history, change)
        rebased.push(doc.history)
      }
      makeChangeSingleDoc(doc, change, null, mergeOldSpans(doc, change))
    })
  };

  for (var i$1 = event.changes.length - 1; i$1 >= 0; --i$1) {
    var returned = loop( i$1 );

    if ( returned ) return returned.v;
  }
}

// Sub-views need their line numbers shifted when text is added
// above or below them in the parent document.
function shiftDoc(doc, distance) {
  if (distance == 0) { return }
  doc.first += distance
  doc.sel = new Selection(map(doc.sel.ranges, function (range) { return new Range(
    Pos(range.anchor.line + distance, range.anchor.ch),
    Pos(range.head.line + distance, range.head.ch)
  ); }), doc.sel.primIndex)
  if (doc.cm) {
    regChange(doc.cm, doc.first, doc.first - distance, distance)
    for (var d = doc.cm.display, l = d.viewFrom; l < d.viewTo; l++)
      { regLineChange(doc.cm, l, "gutter") }
  }
}

// More lower-level change function, handling only a single document
// (not linked ones).
function makeChangeSingleDoc(doc, change, selAfter, spans) {
  if (doc.cm && !doc.cm.curOp)
    { return operation(doc.cm, makeChangeSingleDoc)(doc, change, selAfter, spans) }

  if (change.to.line < doc.first) {
    shiftDoc(doc, change.text.length - 1 - (change.to.line - change.from.line))
    return
  }
  if (change.from.line > doc.lastLine()) { return }

  // Clip the change to the size of this doc
  if (change.from.line < doc.first) {
    var shift = change.text.length - 1 - (doc.first - change.from.line)
    shiftDoc(doc, shift)
    change = {from: Pos(doc.first, 0), to: Pos(change.to.line + shift, change.to.ch),
              text: [lst(change.text)], origin: change.origin}
  }
  var last = doc.lastLine()
  if (change.to.line > last) {
    change = {from: change.from, to: Pos(last, getLine(doc, last).text.length),
              text: [change.text[0]], origin: change.origin}
  }

  change.removed = getBetween(doc, change.from, change.to)

  if (!selAfter) { selAfter = computeSelAfterChange(doc, change) }
  if (doc.cm) { makeChangeSingleDocInEditor(doc.cm, change, spans) }
  else { updateDoc(doc, change, spans) }
  setSelectionNoUndo(doc, selAfter, sel_dontScroll)
}

// Handle the interaction of a change to a document with the editor
// that this document is part of.
function makeChangeSingleDocInEditor(cm, change, spans) {
  var doc = cm.doc, display = cm.display, from = change.from, to = change.to

  var recomputeMaxLength = false, checkWidthStart = from.line
  if (!cm.options.lineWrapping) {
    checkWidthStart = lineNo(visualLine(getLine(doc, from.line)))
    doc.iter(checkWidthStart, to.line + 1, function (line) {
      if (line == display.maxLine) {
        recomputeMaxLength = true
        return true
      }
    })
  }

  if (doc.sel.contains(change.from, change.to) > -1)
    { signalCursorActivity(cm) }

  updateDoc(doc, change, spans, estimateHeight(cm))

  if (!cm.options.lineWrapping) {
    doc.iter(checkWidthStart, from.line + change.text.length, function (line) {
      var len = lineLength(line)
      if (len > display.maxLineLength) {
        display.maxLine = line
        display.maxLineLength = len
        display.maxLineChanged = true
        recomputeMaxLength = false
      }
    })
    if (recomputeMaxLength) { cm.curOp.updateMaxLine = true }
  }

  retreatFrontier(doc, from.line)
  startWorker(cm, 400)

  var lendiff = change.text.length - (to.line - from.line) - 1
  // Remember that these lines changed, for updating the display
  if (change.full)
    { regChange(cm) }
  else if (from.line == to.line && change.text.length == 1 && !isWholeLineUpdate(cm.doc, change))
    { regLineChange(cm, from.line, "text") }
  else
    { regChange(cm, from.line, to.line + 1, lendiff) }

  var changesHandler = hasHandler(cm, "changes"), changeHandler = hasHandler(cm, "change")
  if (changeHandler || changesHandler) {
    var obj = {
      from: from, to: to,
      text: change.text,
      removed: change.removed,
      origin: change.origin
    }
    if (changeHandler) { signalLater(cm, "change", cm, obj) }
    if (changesHandler) { (cm.curOp.changeObjs || (cm.curOp.changeObjs = [])).push(obj) }
  }
  cm.display.selForContextMenu = null
}

function replaceRange(doc, code, from, to, origin) {
  if (!to) { to = from }
  if (cmp(to, from) < 0) { var assign;
    (assign = [to, from], from = assign[0], to = assign[1], assign) }
  if (typeof code == "string") { code = doc.splitLines(code) }
  makeChange(doc, {from: from, to: to, text: code, origin: origin})
}

// Rebasing/resetting history to deal with externally-sourced changes

function rebaseHistSelSingle(pos, from, to, diff) {
  if (to < pos.line) {
    pos.line += diff
  } else if (from < pos.line) {
    pos.line = from
    pos.ch = 0
  }
}

// Tries to rebase an array of history events given a change in the
// document. If the change touches the same lines as the event, the
// event, and everything 'behind' it, is discarded. If the change is
// before the event, the event's positions are updated. Uses a
// copy-on-write scheme for the positions, to avoid having to
// reallocate them all on every rebase, but also avoid problems with
// shared position objects being unsafely updated.
function rebaseHistArray(array, from, to, diff) {
  for (var i = 0; i < array.length; ++i) {
    var sub = array[i], ok = true
    if (sub.ranges) {
      if (!sub.copied) { sub = array[i] = sub.deepCopy(); sub.copied = true }
      for (var j = 0; j < sub.ranges.length; j++) {
        rebaseHistSelSingle(sub.ranges[j].anchor, from, to, diff)
        rebaseHistSelSingle(sub.ranges[j].head, from, to, diff)
      }
      continue
    }
    for (var j$1 = 0; j$1 < sub.changes.length; ++j$1) {
      var cur = sub.changes[j$1]
      if (to < cur.from.line) {
        cur.from = Pos(cur.from.line + diff, cur.from.ch)
        cur.to = Pos(cur.to.line + diff, cur.to.ch)
      } else if (from <= cur.to.line) {
        ok = false
        break
      }
    }
    if (!ok) {
      array.splice(0, i + 1)
      i = 0
    }
  }
}

function rebaseHist(hist, change) {
  var from = change.from.line, to = change.to.line, diff = change.text.length - (to - from) - 1
  rebaseHistArray(hist.done, from, to, diff)
  rebaseHistArray(hist.undone, from, to, diff)
}

// Utility for applying a change to a line by handle or number,
// returning the number and optionally registering the line as
// changed.
function changeLine(doc, handle, changeType, op) {
  var no = handle, line = handle
  if (typeof handle == "number") { line = getLine(doc, clipLine(doc, handle)) }
  else { no = lineNo(handle) }
  if (no == null) { return null }
  if (op(line, no) && doc.cm) { regLineChange(doc.cm, no, changeType) }
  return line
}

// The document is represented as a BTree consisting of leaves, with
// chunk of lines in them, and branches, with up to ten leaves or
// other branch nodes below them. The top node is always a branch
// node, and is the document object itself (meaning it has
// additional methods and properties).
//
// All nodes have parent links. The tree is used both to go from
// line numbers to line objects, and to go from objects to numbers.
// It also indexes by height, and is used to convert between height
// and line object, and to find the total height of the document.
//
// See also http://marijnhaverbeke.nl/blog/codemirror-line-tree.html

function LeafChunk(lines) {
  var this$1 = this;

  this.lines = lines
  this.parent = null
  var height = 0
  for (var i = 0; i < lines.length; ++i) {
    lines[i].parent = this$1
    height += lines[i].height
  }
  this.height = height
}

LeafChunk.prototype = {
  chunkSize: function chunkSize() { return this.lines.length },

  // Remove the n lines at offset 'at'.
  removeInner: function removeInner(at, n) {
    var this$1 = this;

    for (var i = at, e = at + n; i < e; ++i) {
      var line = this$1.lines[i]
      this$1.height -= line.height
      cleanUpLine(line)
      signalLater(line, "delete")
    }
    this.lines.splice(at, n)
  },

  // Helper used to collapse a small branch into a single leaf.
  collapse: function collapse(lines) {
    lines.push.apply(lines, this.lines)
  },

  // Insert the given array of lines at offset 'at', count them as
  // having the given height.
  insertInner: function insertInner(at, lines, height) {
    var this$1 = this;

    this.height += height
    this.lines = this.lines.slice(0, at).concat(lines).concat(this.lines.slice(at))
    for (var i = 0; i < lines.length; ++i) { lines[i].parent = this$1 }
  },

  // Used to iterate over a part of the tree.
  iterN: function iterN(at, n, op) {
    var this$1 = this;

    for (var e = at + n; at < e; ++at)
      { if (op(this$1.lines[at])) { return true } }
  }
}

function BranchChunk(children) {
  var this$1 = this;

  this.children = children
  var size = 0, height = 0
  for (var i = 0; i < children.length; ++i) {
    var ch = children[i]
    size += ch.chunkSize(); height += ch.height
    ch.parent = this$1
  }
  this.size = size
  this.height = height
  this.parent = null
}

BranchChunk.prototype = {
  chunkSize: function chunkSize() { return this.size },

  removeInner: function removeInner(at, n) {
    var this$1 = this;

    this.size -= n
    for (var i = 0; i < this.children.length; ++i) {
      var child = this$1.children[i], sz = child.chunkSize()
      if (at < sz) {
        var rm = Math.min(n, sz - at), oldHeight = child.height
        child.removeInner(at, rm)
        this$1.height -= oldHeight - child.height
        if (sz == rm) { this$1.children.splice(i--, 1); child.parent = null }
        if ((n -= rm) == 0) { break }
        at = 0
      } else { at -= sz }
    }
    // If the result is smaller than 25 lines, ensure that it is a
    // single leaf node.
    if (this.size - n < 25 &&
        (this.children.length > 1 || !(this.children[0] instanceof LeafChunk))) {
      var lines = []
      this.collapse(lines)
      this.children = [new LeafChunk(lines)]
      this.children[0].parent = this
    }
  },

  collapse: function collapse(lines) {
    var this$1 = this;

    for (var i = 0; i < this.children.length; ++i) { this$1.children[i].collapse(lines) }
  },

  insertInner: function insertInner(at, lines, height) {
    var this$1 = this;

    this.size += lines.length
    this.height += height
    for (var i = 0; i < this.children.length; ++i) {
      var child = this$1.children[i], sz = child.chunkSize()
      if (at <= sz) {
        child.insertInner(at, lines, height)
        if (child.lines && child.lines.length > 50) {
          // To avoid memory thrashing when child.lines is huge (e.g. first view of a large file), it's never spliced.
          // Instead, small slices are taken. They're taken in order because sequential memory accesses are fastest.
          var remaining = child.lines.length % 25 + 25
          for (var pos = remaining; pos < child.lines.length;) {
            var leaf = new LeafChunk(child.lines.slice(pos, pos += 25))
            child.height -= leaf.height
            this$1.children.splice(++i, 0, leaf)
            leaf.parent = this$1
          }
          child.lines = child.lines.slice(0, remaining)
          this$1.maybeSpill()
        }
        break
      }
      at -= sz
    }
  },

  // When a node has grown, check whether it should be split.
  maybeSpill: function maybeSpill() {
    if (this.children.length <= 10) { return }
    var me = this
    do {
      var spilled = me.children.splice(me.children.length - 5, 5)
      var sibling = new BranchChunk(spilled)
      if (!me.parent) { // Become the parent node
        var copy = new BranchChunk(me.children)
        copy.parent = me
        me.children = [copy, sibling]
        me = copy
     } else {
        me.size -= sibling.size
        me.height -= sibling.height
        var myIndex = indexOf(me.parent.children, me)
        me.parent.children.splice(myIndex + 1, 0, sibling)
      }
      sibling.parent = me.parent
    } while (me.children.length > 10)
    me.parent.maybeSpill()
  },

  iterN: function iterN(at, n, op) {
    var this$1 = this;

    for (var i = 0; i < this.children.length; ++i) {
      var child = this$1.children[i], sz = child.chunkSize()
      if (at < sz) {
        var used = Math.min(n, sz - at)
        if (child.iterN(at, used, op)) { return true }
        if ((n -= used) == 0) { break }
        at = 0
      } else { at -= sz }
    }
  }
}

// Line widgets are block elements displayed above or below a line.

var LineWidget = function(doc, node, options) {
  var this$1 = this;

  if (options) { for (var opt in options) { if (options.hasOwnProperty(opt))
    { this$1[opt] = options[opt] } } }
  this.doc = doc
  this.node = node
};

LineWidget.prototype.clear = function () {
    var this$1 = this;

  var cm = this.doc.cm, ws = this.line.widgets, line = this.line, no = lineNo(line)
  if (no == null || !ws) { return }
  for (var i = 0; i < ws.length; ++i) { if (ws[i] == this$1) { ws.splice(i--, 1) } }
  if (!ws.length) { line.widgets = null }
  var height = widgetHeight(this)
  updateLineHeight(line, Math.max(0, line.height - height))
  if (cm) {
    runInOp(cm, function () {
      adjustScrollWhenAboveVisible(cm, line, -height)
      regLineChange(cm, no, "widget")
    })
    signalLater(cm, "lineWidgetCleared", cm, this, no)
  }
};

LineWidget.prototype.changed = function () {
    var this$1 = this;

  var oldH = this.height, cm = this.doc.cm, line = this.line
  this.height = null
  var diff = widgetHeight(this) - oldH
  if (!diff) { return }
  updateLineHeight(line, line.height + diff)
  if (cm) {
    runInOp(cm, function () {
      cm.curOp.forceUpdate = true
      adjustScrollWhenAboveVisible(cm, line, diff)
      signalLater(cm, "lineWidgetChanged", cm, this$1, lineNo(line))
    })
  }
};
eventMixin(LineWidget)

function adjustScrollWhenAboveVisible(cm, line, diff) {
  if (heightAtLine(line) < ((cm.curOp && cm.curOp.scrollTop) || cm.doc.scrollTop))
    { addToScrollTop(cm, diff) }
}

function addLineWidget(doc, handle, node, options) {
  var widget = new LineWidget(doc, node, options)
  var cm = doc.cm
  if (cm && widget.noHScroll) { cm.display.alignWidgets = true }
  changeLine(doc, handle, "widget", function (line) {
    var widgets = line.widgets || (line.widgets = [])
    if (widget.insertAt == null) { widgets.push(widget) }
    else { widgets.splice(Math.min(widgets.length - 1, Math.max(0, widget.insertAt)), 0, widget) }
    widget.line = line
    if (cm && !lineIsHidden(doc, line)) {
      var aboveVisible = heightAtLine(line) < doc.scrollTop
      updateLineHeight(line, line.height + widgetHeight(widget))
      if (aboveVisible) { addToScrollTop(cm, widget.height) }
      cm.curOp.forceUpdate = true
    }
    return true
  })
  signalLater(cm, "lineWidgetAdded", cm, widget, typeof handle == "number" ? handle : lineNo(handle))
  return widget
}

// TEXTMARKERS

// Created with markText and setBookmark methods. A TextMarker is a
// handle that can be used to clear or find a marked position in the
// document. Line objects hold arrays (markedSpans) containing
// {from, to, marker} object pointing to such marker objects, and
// indicating that such a marker is present on that line. Multiple
// lines may point to the same marker when it spans across lines.
// The spans will have null for their from/to properties when the
// marker continues beyond the start/end of the line. Markers have
// links back to the lines they currently touch.

// Collapsed markers have unique ids, in order to be able to order
// them, which is needed for uniquely determining an outer marker
// when they overlap (they may nest, but not partially overlap).
var nextMarkerId = 0

var TextMarker = function(doc, type) {
  this.lines = []
  this.type = type
  this.doc = doc
  this.id = ++nextMarkerId
};

// Clear the marker.
TextMarker.prototype.clear = function () {
    var this$1 = this;

  if (this.explicitlyCleared) { return }
  var cm = this.doc.cm, withOp = cm && !cm.curOp
  if (withOp) { startOperation(cm) }
  if (hasHandler(this, "clear")) {
    var found = this.find()
    if (found) { signalLater(this, "clear", found.from, found.to) }
  }
  var min = null, max = null
  for (var i = 0; i < this.lines.length; ++i) {
    var line = this$1.lines[i]
    var span = getMarkedSpanFor(line.markedSpans, this$1)
    if (cm && !this$1.collapsed) { regLineChange(cm, lineNo(line), "text") }
    else if (cm) {
      if (span.to != null) { max = lineNo(line) }
      if (span.from != null) { min = lineNo(line) }
    }
    line.markedSpans = removeMarkedSpan(line.markedSpans, span)
    if (span.from == null && this$1.collapsed && !lineIsHidden(this$1.doc, line) && cm)
      { updateLineHeight(line, textHeight(cm.display)) }
  }
  if (cm && this.collapsed && !cm.options.lineWrapping) { for (var i$1 = 0; i$1 < this.lines.length; ++i$1) {
    var visual = visualLine(this$1.lines[i$1]), len = lineLength(visual)
    if (len > cm.display.maxLineLength) {
      cm.display.maxLine = visual
      cm.display.maxLineLength = len
      cm.display.maxLineChanged = true
    }
  } }

  if (min != null && cm && this.collapsed) { regChange(cm, min, max + 1) }
  this.lines.length = 0
  this.explicitlyCleared = true
  if (this.atomic && this.doc.cantEdit) {
    this.doc.cantEdit = false
    if (cm) { reCheckSelection(cm.doc) }
  }
  if (cm) { signalLater(cm, "markerCleared", cm, this, min, max) }
  if (withOp) { endOperation(cm) }
  if (this.parent) { this.parent.clear() }
};

// Find the position of the marker in the document. Returns a {from,
// to} object by default. Side can be passed to get a specific side
// -- 0 (both), -1 (left), or 1 (right). When lineObj is true, the
// Pos objects returned contain a line object, rather than a line
// number (used to prevent looking up the same line twice).
TextMarker.prototype.find = function (side, lineObj) {
    var this$1 = this;

  if (side == null && this.type == "bookmark") { side = 1 }
  var from, to
  for (var i = 0; i < this.lines.length; ++i) {
    var line = this$1.lines[i]
    var span = getMarkedSpanFor(line.markedSpans, this$1)
    if (span.from != null) {
      from = Pos(lineObj ? line : lineNo(line), span.from)
      if (side == -1) { return from }
    }
    if (span.to != null) {
      to = Pos(lineObj ? line : lineNo(line), span.to)
      if (side == 1) { return to }
    }
  }
  return from && {from: from, to: to}
};

// Signals that the marker's widget changed, and surrounding layout
// should be recomputed.
TextMarker.prototype.changed = function () {
    var this$1 = this;

  var pos = this.find(-1, true), widget = this, cm = this.doc.cm
  if (!pos || !cm) { return }
  runInOp(cm, function () {
    var line = pos.line, lineN = lineNo(pos.line)
    var view = findViewForLine(cm, lineN)
    if (view) {
      clearLineMeasurementCacheFor(view)
      cm.curOp.selectionChanged = cm.curOp.forceUpdate = true
    }
    cm.curOp.updateMaxLine = true
    if (!lineIsHidden(widget.doc, line) && widget.height != null) {
      var oldHeight = widget.height
      widget.height = null
      var dHeight = widgetHeight(widget) - oldHeight
      if (dHeight)
        { updateLineHeight(line, line.height + dHeight) }
    }
    signalLater(cm, "markerChanged", cm, this$1)
  })
};

TextMarker.prototype.attachLine = function (line) {
  if (!this.lines.length && this.doc.cm) {
    var op = this.doc.cm.curOp
    if (!op.maybeHiddenMarkers || indexOf(op.maybeHiddenMarkers, this) == -1)
      { (op.maybeUnhiddenMarkers || (op.maybeUnhiddenMarkers = [])).push(this) }
  }
  this.lines.push(line)
};

TextMarker.prototype.detachLine = function (line) {
  this.lines.splice(indexOf(this.lines, line), 1)
  if (!this.lines.length && this.doc.cm) {
    var op = this.doc.cm.curOp
    ;(op.maybeHiddenMarkers || (op.maybeHiddenMarkers = [])).push(this)
  }
};
eventMixin(TextMarker)

// Create a marker, wire it up to the right lines, and
function markText(doc, from, to, options, type) {
  // Shared markers (across linked documents) are handled separately
  // (markTextShared will call out to this again, once per
  // document).
  if (options && options.shared) { return markTextShared(doc, from, to, options, type) }
  // Ensure we are in an operation.
  if (doc.cm && !doc.cm.curOp) { return operation(doc.cm, markText)(doc, from, to, options, type) }

  var marker = new TextMarker(doc, type), diff = cmp(from, to)
  if (options) { copyObj(options, marker, false) }
  // Don't connect empty markers unless clearWhenEmpty is false
  if (diff > 0 || diff == 0 && marker.clearWhenEmpty !== false)
    { return marker }
  if (marker.replacedWith) {
    // Showing up as a widget implies collapsed (widget replaces text)
    marker.collapsed = true
    marker.widgetNode = eltP("span", [marker.replacedWith], "CodeMirror-widget")
    if (!options.handleMouseEvents) { marker.widgetNode.setAttribute("cm-ignore-events", "true") }
    if (options.insertLeft) { marker.widgetNode.insertLeft = true }
  }
  if (marker.collapsed) {
    if (conflictingCollapsedRange(doc, from.line, from, to, marker) ||
        from.line != to.line && conflictingCollapsedRange(doc, to.line, from, to, marker))
      { throw new Error("Inserting collapsed marker partially overlapping an existing one") }
    seeCollapsedSpans()
  }

  if (marker.addToHistory)
    { addChangeToHistory(doc, {from: from, to: to, origin: "markText"}, doc.sel, NaN) }

  var curLine = from.line, cm = doc.cm, updateMaxLine
  doc.iter(curLine, to.line + 1, function (line) {
    if (cm && marker.collapsed && !cm.options.lineWrapping && visualLine(line) == cm.display.maxLine)
      { updateMaxLine = true }
    if (marker.collapsed && curLine != from.line) { updateLineHeight(line, 0) }
    addMarkedSpan(line, new MarkedSpan(marker,
                                       curLine == from.line ? from.ch : null,
                                       curLine == to.line ? to.ch : null))
    ++curLine
  })
  // lineIsHidden depends on the presence of the spans, so needs a second pass
  if (marker.collapsed) { doc.iter(from.line, to.line + 1, function (line) {
    if (lineIsHidden(doc, line)) { updateLineHeight(line, 0) }
  }) }

  if (marker.clearOnEnter) { on(marker, "beforeCursorEnter", function () { return marker.clear(); }) }

  if (marker.readOnly) {
    seeReadOnlySpans()
    if (doc.history.done.length || doc.history.undone.length)
      { doc.clearHistory() }
  }
  if (marker.collapsed) {
    marker.id = ++nextMarkerId
    marker.atomic = true
  }
  if (cm) {
    // Sync editor state
    if (updateMaxLine) { cm.curOp.updateMaxLine = true }
    if (marker.collapsed)
      { regChange(cm, from.line, to.line + 1) }
    else if (marker.className || marker.title || marker.startStyle || marker.endStyle || marker.css)
      { for (var i = from.line; i <= to.line; i++) { regLineChange(cm, i, "text") } }
    if (marker.atomic) { reCheckSelection(cm.doc) }
    signalLater(cm, "markerAdded", cm, marker)
  }
  return marker
}

// SHARED TEXTMARKERS

// A shared marker spans multiple linked documents. It is
// implemented as a meta-marker-object controlling multiple normal
// markers.
var SharedTextMarker = function(markers, primary) {
  var this$1 = this;

  this.markers = markers
  this.primary = primary
  for (var i = 0; i < markers.length; ++i)
    { markers[i].parent = this$1 }
};

SharedTextMarker.prototype.clear = function () {
    var this$1 = this;

  if (this.explicitlyCleared) { return }
  this.explicitlyCleared = true
  for (var i = 0; i < this.markers.length; ++i)
    { this$1.markers[i].clear() }
  signalLater(this, "clear")
};

SharedTextMarker.prototype.find = function (side, lineObj) {
  return this.primary.find(side, lineObj)
};
eventMixin(SharedTextMarker)

function markTextShared(doc, from, to, options, type) {
  options = copyObj(options)
  options.shared = false
  var markers = [markText(doc, from, to, options, type)], primary = markers[0]
  var widget = options.widgetNode
  linkedDocs(doc, function (doc) {
    if (widget) { options.widgetNode = widget.cloneNode(true) }
    markers.push(markText(doc, clipPos(doc, from), clipPos(doc, to), options, type))
    for (var i = 0; i < doc.linked.length; ++i)
      { if (doc.linked[i].isParent) { return } }
    primary = lst(markers)
  })
  return new SharedTextMarker(markers, primary)
}

function findSharedMarkers(doc) {
  return doc.findMarks(Pos(doc.first, 0), doc.clipPos(Pos(doc.lastLine())), function (m) { return m.parent; })
}

function copySharedMarkers(doc, markers) {
  for (var i = 0; i < markers.length; i++) {
    var marker = markers[i], pos = marker.find()
    var mFrom = doc.clipPos(pos.from), mTo = doc.clipPos(pos.to)
    if (cmp(mFrom, mTo)) {
      var subMark = markText(doc, mFrom, mTo, marker.primary, marker.primary.type)
      marker.markers.push(subMark)
      subMark.parent = marker
    }
  }
}

function detachSharedMarkers(markers) {
  var loop = function ( i ) {
    var marker = markers[i], linked = [marker.primary.doc]
    linkedDocs(marker.primary.doc, function (d) { return linked.push(d); })
    for (var j = 0; j < marker.markers.length; j++) {
      var subMarker = marker.markers[j]
      if (indexOf(linked, subMarker.doc) == -1) {
        subMarker.parent = null
        marker.markers.splice(j--, 1)
      }
    }
  };

  for (var i = 0; i < markers.length; i++) loop( i );
}

var nextDocId = 0
var Doc = function(text, mode, firstLine, lineSep, direction) {
  if (!(this instanceof Doc)) { return new Doc(text, mode, firstLine, lineSep, direction) }
  if (firstLine == null) { firstLine = 0 }

  BranchChunk.call(this, [new LeafChunk([new Line("", null)])])
  this.first = firstLine
  this.scrollTop = this.scrollLeft = 0
  this.cantEdit = false
  this.cleanGeneration = 1
  this.modeFrontier = this.highlightFrontier = firstLine
  var start = Pos(firstLine, 0)
  this.sel = simpleSelection(start)
  this.history = new History(null)
  this.id = ++nextDocId
  this.modeOption = mode
  this.lineSep = lineSep
  this.direction = (direction == "rtl") ? "rtl" : "ltr"
  this.extend = false

  if (typeof text == "string") { text = this.splitLines(text) }
  updateDoc(this, {from: start, to: start, text: text})
  setSelection(this, simpleSelection(start), sel_dontScroll)
}

Doc.prototype = createObj(BranchChunk.prototype, {
  constructor: Doc,
  // Iterate over the document. Supports two forms -- with only one
  // argument, it calls that for each line in the document. With
  // three, it iterates over the range given by the first two (with
  // the second being non-inclusive).
  iter: function(from, to, op) {
    if (op) { this.iterN(from - this.first, to - from, op) }
    else { this.iterN(this.first, this.first + this.size, from) }
  },

  // Non-public interface for adding and removing lines.
  insert: function(at, lines) {
    var height = 0
    for (var i = 0; i < lines.length; ++i) { height += lines[i].height }
    this.insertInner(at - this.first, lines, height)
  },
  remove: function(at, n) { this.removeInner(at - this.first, n) },

  // From here, the methods are part of the public interface. Most
  // are also available from CodeMirror (editor) instances.

  getValue: function(lineSep) {
    var lines = getLines(this, this.first, this.first + this.size)
    if (lineSep === false) { return lines }
    return lines.join(lineSep || this.lineSeparator())
  },
  setValue: docMethodOp(function(code) {
    var top = Pos(this.first, 0), last = this.first + this.size - 1
    makeChange(this, {from: top, to: Pos(last, getLine(this, last).text.length),
                      text: this.splitLines(code), origin: "setValue", full: true}, true)
    if (this.cm) { scrollToCoords(this.cm, 0, 0) }
    setSelection(this, simpleSelection(top), sel_dontScroll)
  }),
  replaceRange: function(code, from, to, origin) {
    from = clipPos(this, from)
    to = to ? clipPos(this, to) : from
    replaceRange(this, code, from, to, origin)
  },
  getRange: function(from, to, lineSep) {
    var lines = getBetween(this, clipPos(this, from), clipPos(this, to))
    if (lineSep === false) { return lines }
    return lines.join(lineSep || this.lineSeparator())
  },

  getLine: function(line) {var l = this.getLineHandle(line); return l && l.text},

  getLineHandle: function(line) {if (isLine(this, line)) { return getLine(this, line) }},
  getLineNumber: function(line) {return lineNo(line)},

  getLineHandleVisualStart: function(line) {
    if (typeof line == "number") { line = getLine(this, line) }
    return visualLine(line)
  },

  lineCount: function() {return this.size},
  firstLine: function() {return this.first},
  lastLine: function() {return this.first + this.size - 1},

  clipPos: function(pos) {return clipPos(this, pos)},

  getCursor: function(start) {
    var range = this.sel.primary(), pos
    if (start == null || start == "head") { pos = range.head }
    else if (start == "anchor") { pos = range.anchor }
    else if (start == "end" || start == "to" || start === false) { pos = range.to() }
    else { pos = range.from() }
    return pos
  },
  listSelections: function() { return this.sel.ranges },
  somethingSelected: function() {return this.sel.somethingSelected()},

  setCursor: docMethodOp(function(line, ch, options) {
    setSimpleSelection(this, clipPos(this, typeof line == "number" ? Pos(line, ch || 0) : line), null, options)
  }),
  setSelection: docMethodOp(function(anchor, head, options) {
    setSimpleSelection(this, clipPos(this, anchor), clipPos(this, head || anchor), options)
  }),
  extendSelection: docMethodOp(function(head, other, options) {
    extendSelection(this, clipPos(this, head), other && clipPos(this, other), options)
  }),
  extendSelections: docMethodOp(function(heads, options) {
    extendSelections(this, clipPosArray(this, heads), options)
  }),
  extendSelectionsBy: docMethodOp(function(f, options) {
    var heads = map(this.sel.ranges, f)
    extendSelections(this, clipPosArray(this, heads), options)
  }),
  setSelections: docMethodOp(function(ranges, primary, options) {
    var this$1 = this;

    if (!ranges.length) { return }
    var out = []
    for (var i = 0; i < ranges.length; i++)
      { out[i] = new Range(clipPos(this$1, ranges[i].anchor),
                         clipPos(this$1, ranges[i].head)) }
    if (primary == null) { primary = Math.min(ranges.length - 1, this.sel.primIndex) }
    setSelection(this, normalizeSelection(out, primary), options)
  }),
  addSelection: docMethodOp(function(anchor, head, options) {
    var ranges = this.sel.ranges.slice(0)
    ranges.push(new Range(clipPos(this, anchor), clipPos(this, head || anchor)))
    setSelection(this, normalizeSelection(ranges, ranges.length - 1), options)
  }),

  getSelection: function(lineSep) {
    var this$1 = this;

    var ranges = this.sel.ranges, lines
    for (var i = 0; i < ranges.length; i++) {
      var sel = getBetween(this$1, ranges[i].from(), ranges[i].to())
      lines = lines ? lines.concat(sel) : sel
    }
    if (lineSep === false) { return lines }
    else { return lines.join(lineSep || this.lineSeparator()) }
  },
  getSelections: function(lineSep) {
    var this$1 = this;

    var parts = [], ranges = this.sel.ranges
    for (var i = 0; i < ranges.length; i++) {
      var sel = getBetween(this$1, ranges[i].from(), ranges[i].to())
      if (lineSep !== false) { sel = sel.join(lineSep || this$1.lineSeparator()) }
      parts[i] = sel
    }
    return parts
  },
  replaceSelection: function(code, collapse, origin) {
    var dup = []
    for (var i = 0; i < this.sel.ranges.length; i++)
      { dup[i] = code }
    this.replaceSelections(dup, collapse, origin || "+input")
  },
  replaceSelections: docMethodOp(function(code, collapse, origin) {
    var this$1 = this;

    var changes = [], sel = this.sel
    for (var i = 0; i < sel.ranges.length; i++) {
      var range = sel.ranges[i]
      changes[i] = {from: range.from(), to: range.to(), text: this$1.splitLines(code[i]), origin: origin}
    }
    var newSel = collapse && collapse != "end" && computeReplacedSel(this, changes, collapse)
    for (var i$1 = changes.length - 1; i$1 >= 0; i$1--)
      { makeChange(this$1, changes[i$1]) }
    if (newSel) { setSelectionReplaceHistory(this, newSel) }
    else if (this.cm) { ensureCursorVisible(this.cm) }
  }),
  undo: docMethodOp(function() {makeChangeFromHistory(this, "undo")}),
  redo: docMethodOp(function() {makeChangeFromHistory(this, "redo")}),
  undoSelection: docMethodOp(function() {makeChangeFromHistory(this, "undo", true)}),
  redoSelection: docMethodOp(function() {makeChangeFromHistory(this, "redo", true)}),

  setExtending: function(val) {this.extend = val},
  getExtending: function() {return this.extend},

  historySize: function() {
    var hist = this.history, done = 0, undone = 0
    for (var i = 0; i < hist.done.length; i++) { if (!hist.done[i].ranges) { ++done } }
    for (var i$1 = 0; i$1 < hist.undone.length; i$1++) { if (!hist.undone[i$1].ranges) { ++undone } }
    return {undo: done, redo: undone}
  },
  clearHistory: function() {this.history = new History(this.history.maxGeneration)},

  markClean: function() {
    this.cleanGeneration = this.changeGeneration(true)
  },
  changeGeneration: function(forceSplit) {
    if (forceSplit)
      { this.history.lastOp = this.history.lastSelOp = this.history.lastOrigin = null }
    return this.history.generation
  },
  isClean: function (gen) {
    return this.history.generation == (gen || this.cleanGeneration)
  },

  getHistory: function() {
    return {done: copyHistoryArray(this.history.done),
            undone: copyHistoryArray(this.history.undone)}
  },
  setHistory: function(histData) {
    var hist = this.history = new History(this.history.maxGeneration)
    hist.done = copyHistoryArray(histData.done.slice(0), null, true)
    hist.undone = copyHistoryArray(histData.undone.slice(0), null, true)
  },

  setGutterMarker: docMethodOp(function(line, gutterID, value) {
    return changeLine(this, line, "gutter", function (line) {
      var markers = line.gutterMarkers || (line.gutterMarkers = {})
      markers[gutterID] = value
      if (!value && isEmpty(markers)) { line.gutterMarkers = null }
      return true
    })
  }),

  clearGutter: docMethodOp(function(gutterID) {
    var this$1 = this;

    this.iter(function (line) {
      if (line.gutterMarkers && line.gutterMarkers[gutterID]) {
        changeLine(this$1, line, "gutter", function () {
          line.gutterMarkers[gutterID] = null
          if (isEmpty(line.gutterMarkers)) { line.gutterMarkers = null }
          return true
        })
      }
    })
  }),

  lineInfo: function(line) {
    var n
    if (typeof line == "number") {
      if (!isLine(this, line)) { return null }
      n = line
      line = getLine(this, line)
      if (!line) { return null }
    } else {
      n = lineNo(line)
      if (n == null) { return null }
    }
    return {line: n, handle: line, text: line.text, gutterMarkers: line.gutterMarkers,
            textClass: line.textClass, bgClass: line.bgClass, wrapClass: line.wrapClass,
            widgets: line.widgets}
  },

  addLineClass: docMethodOp(function(handle, where, cls) {
    return changeLine(this, handle, where == "gutter" ? "gutter" : "class", function (line) {
      var prop = where == "text" ? "textClass"
               : where == "background" ? "bgClass"
               : where == "gutter" ? "gutterClass" : "wrapClass"
      if (!line[prop]) { line[prop] = cls }
      else if (classTest(cls).test(line[prop])) { return false }
      else { line[prop] += " " + cls }
      return true
    })
  }),
  removeLineClass: docMethodOp(function(handle, where, cls) {
    return changeLine(this, handle, where == "gutter" ? "gutter" : "class", function (line) {
      var prop = where == "text" ? "textClass"
               : where == "background" ? "bgClass"
               : where == "gutter" ? "gutterClass" : "wrapClass"
      var cur = line[prop]
      if (!cur) { return false }
      else if (cls == null) { line[prop] = null }
      else {
        var found = cur.match(classTest(cls))
        if (!found) { return false }
        var end = found.index + found[0].length
        line[prop] = cur.slice(0, found.index) + (!found.index || end == cur.length ? "" : " ") + cur.slice(end) || null
      }
      return true
    })
  }),

  addLineWidget: docMethodOp(function(handle, node, options) {
    return addLineWidget(this, handle, node, options)
  }),
  removeLineWidget: function(widget) { widget.clear() },

  markText: function(from, to, options) {
    return markText(this, clipPos(this, from), clipPos(this, to), options, options && options.type || "range")
  },
  setBookmark: function(pos, options) {
    var realOpts = {replacedWith: options && (options.nodeType == null ? options.widget : options),
                    insertLeft: options && options.insertLeft,
                    clearWhenEmpty: false, shared: options && options.shared,
                    handleMouseEvents: options && options.handleMouseEvents}
    pos = clipPos(this, pos)
    return markText(this, pos, pos, realOpts, "bookmark")
  },
  findMarksAt: function(pos) {
    pos = clipPos(this, pos)
    var markers = [], spans = getLine(this, pos.line).markedSpans
    if (spans) { for (var i = 0; i < spans.length; ++i) {
      var span = spans[i]
      if ((span.from == null || span.from <= pos.ch) &&
          (span.to == null || span.to >= pos.ch))
        { markers.push(span.marker.parent || span.marker) }
    } }
    return markers
  },
  findMarks: function(from, to, filter) {
    from = clipPos(this, from); to = clipPos(this, to)
    var found = [], lineNo = from.line
    this.iter(from.line, to.line + 1, function (line) {
      var spans = line.markedSpans
      if (spans) { for (var i = 0; i < spans.length; i++) {
        var span = spans[i]
        if (!(span.to != null && lineNo == from.line && from.ch >= span.to ||
              span.from == null && lineNo != from.line ||
              span.from != null && lineNo == to.line && span.from >= to.ch) &&
            (!filter || filter(span.marker)))
          { found.push(span.marker.parent || span.marker) }
      } }
      ++lineNo
    })
    return found
  },
  getAllMarks: function() {
    var markers = []
    this.iter(function (line) {
      var sps = line.markedSpans
      if (sps) { for (var i = 0; i < sps.length; ++i)
        { if (sps[i].from != null) { markers.push(sps[i].marker) } } }
    })
    return markers
  },

  posFromIndex: function(off) {
    var ch, lineNo = this.first, sepSize = this.lineSeparator().length
    this.iter(function (line) {
      var sz = line.text.length + sepSize
      if (sz > off) { ch = off; return true }
      off -= sz
      ++lineNo
    })
    return clipPos(this, Pos(lineNo, ch))
  },
  indexFromPos: function (coords) {
    coords = clipPos(this, coords)
    var index = coords.ch
    if (coords.line < this.first || coords.ch < 0) { return 0 }
    var sepSize = this.lineSeparator().length
    this.iter(this.first, coords.line, function (line) { // iter aborts when callback returns a truthy value
      index += line.text.length + sepSize
    })
    return index
  },

  copy: function(copyHistory) {
    var doc = new Doc(getLines(this, this.first, this.first + this.size),
                      this.modeOption, this.first, this.lineSep, this.direction)
    doc.scrollTop = this.scrollTop; doc.scrollLeft = this.scrollLeft
    doc.sel = this.sel
    doc.extend = false
    if (copyHistory) {
      doc.history.undoDepth = this.history.undoDepth
      doc.setHistory(this.getHistory())
    }
    return doc
  },

  linkedDoc: function(options) {
    if (!options) { options = {} }
    var from = this.first, to = this.first + this.size
    if (options.from != null && options.from > from) { from = options.from }
    if (options.to != null && options.to < to) { to = options.to }
    var copy = new Doc(getLines(this, from, to), options.mode || this.modeOption, from, this.lineSep, this.direction)
    if (options.sharedHist) { copy.history = this.history
    ; }(this.linked || (this.linked = [])).push({doc: copy, sharedHist: options.sharedHist})
    copy.linked = [{doc: this, isParent: true, sharedHist: options.sharedHist}]
    copySharedMarkers(copy, findSharedMarkers(this))
    return copy
  },
  unlinkDoc: function(other) {
    var this$1 = this;

    if (other instanceof CodeMirror) { other = other.doc }
    if (this.linked) { for (var i = 0; i < this.linked.length; ++i) {
      var link = this$1.linked[i]
      if (link.doc != other) { continue }
      this$1.linked.splice(i, 1)
      other.unlinkDoc(this$1)
      detachSharedMarkers(findSharedMarkers(this$1))
      break
    } }
    // If the histories were shared, split them again
    if (other.history == this.history) {
      var splitIds = [other.id]
      linkedDocs(other, function (doc) { return splitIds.push(doc.id); }, true)
      other.history = new History(null)
      other.history.done = copyHistoryArray(this.history.done, splitIds)
      other.history.undone = copyHistoryArray(this.history.undone, splitIds)
    }
  },
  iterLinkedDocs: function(f) {linkedDocs(this, f)},

  getMode: function() {return this.mode},
  getEditor: function() {return this.cm},

  splitLines: function(str) {
    if (this.lineSep) { return str.split(this.lineSep) }
    return splitLinesAuto(str)
  },
  lineSeparator: function() { return this.lineSep || "\n" },

  setDirection: docMethodOp(function (dir) {
    if (dir != "rtl") { dir = "ltr" }
    if (dir == this.direction) { return }
    this.direction = dir
    this.iter(function (line) { return line.order = null; })
    if (this.cm) { directionChanged(this.cm) }
  })
})

// Public alias.
Doc.prototype.eachLine = Doc.prototype.iter

// Kludge to work around strange IE behavior where it'll sometimes
// re-fire a series of drag-related events right after the drop (#1551)
var lastDrop = 0

function onDrop(e) {
  var cm = this
  clearDragCursor(cm)
  if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e))
    { return }
  e_preventDefault(e)
  if (ie) { lastDrop = +new Date }
  var pos = posFromMouse(cm, e, true), files = e.dataTransfer.files
  if (!pos || cm.isReadOnly()) { return }
  // Might be a file drop, in which case we simply extract the text
  // and insert it.
  if (files && files.length && window.FileReader && window.File) {
    var n = files.length, text = Array(n), read = 0
    var loadFile = function (file, i) {
      if (cm.options.allowDropFileTypes &&
          indexOf(cm.options.allowDropFileTypes, file.type) == -1)
        { return }

      var reader = new FileReader
      reader.onload = operation(cm, function () {
        var content = reader.result
        if (/[\x00-\x08\x0e-\x1f]{2}/.test(content)) { content = "" }
        text[i] = content
        if (++read == n) {
          pos = clipPos(cm.doc, pos)
          var change = {from: pos, to: pos,
                        text: cm.doc.splitLines(text.join(cm.doc.lineSeparator())),
                        origin: "paste"}
          makeChange(cm.doc, change)
          setSelectionReplaceHistory(cm.doc, simpleSelection(pos, changeEnd(change)))
        }
      })
      reader.readAsText(file)
    }
    for (var i = 0; i < n; ++i) { loadFile(files[i], i) }
  } else { // Normal drop
    // Don't do a replace if the drop happened inside of the selected text.
    if (cm.state.draggingText && cm.doc.sel.contains(pos) > -1) {
      cm.state.draggingText(e)
      // Ensure the editor is re-focused
      setTimeout(function () { return cm.display.input.focus(); }, 20)
      return
    }
    try {
      var text$1 = e.dataTransfer.getData("Text")
      if (text$1) {
        var selected
        if (cm.state.draggingText && !cm.state.draggingText.copy)
          { selected = cm.listSelections() }
        setSelectionNoUndo(cm.doc, simpleSelection(pos, pos))
        if (selected) { for (var i$1 = 0; i$1 < selected.length; ++i$1)
          { replaceRange(cm.doc, "", selected[i$1].anchor, selected[i$1].head, "drag") } }
        cm.replaceSelection(text$1, "around", "paste")
        cm.display.input.focus()
      }
    }
    catch(e){}
  }
}

function onDragStart(cm, e) {
  if (ie && (!cm.state.draggingText || +new Date - lastDrop < 100)) { e_stop(e); return }
  if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) { return }

  e.dataTransfer.setData("Text", cm.getSelection())
  e.dataTransfer.effectAllowed = "copyMove"

  // Use dummy image instead of default browsers image.
  // Recent Safari (~6.0.2) have a tendency to segfault when this happens, so we don't do it there.
  if (e.dataTransfer.setDragImage && !safari) {
    var img = elt("img", null, null, "position: fixed; left: 0; top: 0;")
    img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="
    if (presto) {
      img.width = img.height = 1
      cm.display.wrapper.appendChild(img)
      // Force a relayout, or Opera won't use our image for some obscure reason
      img._top = img.offsetTop
    }
    e.dataTransfer.setDragImage(img, 0, 0)
    if (presto) { img.parentNode.removeChild(img) }
  }
}

function onDragOver(cm, e) {
  var pos = posFromMouse(cm, e)
  if (!pos) { return }
  var frag = document.createDocumentFragment()
  drawSelectionCursor(cm, pos, frag)
  if (!cm.display.dragCursor) {
    cm.display.dragCursor = elt("div", null, "CodeMirror-cursors CodeMirror-dragcursors")
    cm.display.lineSpace.insertBefore(cm.display.dragCursor, cm.display.cursorDiv)
  }
  removeChildrenAndAdd(cm.display.dragCursor, frag)
}

function clearDragCursor(cm) {
  if (cm.display.dragCursor) {
    cm.display.lineSpace.removeChild(cm.display.dragCursor)
    cm.display.dragCursor = null
  }
}

// These must be handled carefully, because naively registering a
// handler for each editor will cause the editors to never be
// garbage collected.

function forEachCodeMirror(f) {
  if (!document.getElementsByClassName) { return }
  var byClass = document.getElementsByClassName("CodeMirror")
  for (var i = 0; i < byClass.length; i++) {
    var cm = byClass[i].CodeMirror
    if (cm) { f(cm) }
  }
}

var globalsRegistered = false
function ensureGlobalHandlers() {
  if (globalsRegistered) { return }
  registerGlobalHandlers()
  globalsRegistered = true
}
function registerGlobalHandlers() {
  // When the window resizes, we need to refresh active editors.
  var resizeTimer
  on(window, "resize", function () {
    if (resizeTimer == null) { resizeTimer = setTimeout(function () {
      resizeTimer = null
      forEachCodeMirror(onResize)
    }, 100) }
  })
  // When the window loses focus, we want to show the editor as blurred
  on(window, "blur", function () { return forEachCodeMirror(onBlur); })
}
// Called when the window resizes
function onResize(cm) {
  var d = cm.display
  if (d.lastWrapHeight == d.wrapper.clientHeight && d.lastWrapWidth == d.wrapper.clientWidth)
    { return }
  // Might be a text scaling operation, clear size caches.
  d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null
  d.scrollbarsClipped = false
  cm.setSize()
}

var keyNames = {
  3: "Pause", 8: "Backspace", 9: "Tab", 13: "Enter", 16: "Shift", 17: "Ctrl", 18: "Alt",
  19: "Pause", 20: "CapsLock", 27: "Esc", 32: "Space", 33: "PageUp", 34: "PageDown", 35: "End",
  36: "Home", 37: "Left", 38: "Up", 39: "Right", 40: "Down", 44: "PrintScrn", 45: "Insert",
  46: "Delete", 59: ";", 61: "=", 91: "Mod", 92: "Mod", 93: "Mod",
  106: "*", 107: "=", 109: "-", 110: ".", 111: "/", 127: "Delete", 145: "ScrollLock",
  173: "-", 186: ";", 187: "=", 188: ",", 189: "-", 190: ".", 191: "/", 192: "`", 219: "[", 220: "\\",
  221: "]", 222: "'", 63232: "Up", 63233: "Down", 63234: "Left", 63235: "Right", 63272: "Delete",
  63273: "Home", 63275: "End", 63276: "PageUp", 63277: "PageDown", 63302: "Insert"
}

// Number keys
for (var i = 0; i < 10; i++) { keyNames[i + 48] = keyNames[i + 96] = String(i) }
// Alphabetic keys
for (var i$1 = 65; i$1 <= 90; i$1++) { keyNames[i$1] = String.fromCharCode(i$1) }
// Function keys
for (var i$2 = 1; i$2 <= 12; i$2++) { keyNames[i$2 + 111] = keyNames[i$2 + 63235] = "F" + i$2 }

var keyMap = {}

keyMap.basic = {
  "Left": "goCharLeft", "Right": "goCharRight", "Up": "goLineUp", "Down": "goLineDown",
  "End": "goLineEnd", "Home": "goLineStartSmart", "PageUp": "goPageUp", "PageDown": "goPageDown",
  "Delete": "delCharAfter", "Backspace": "delCharBefore", "Shift-Backspace": "delCharBefore",
  "Tab": "defaultTab", "Shift-Tab": "indentAuto",
  "Enter": "newlineAndIndent", "Insert": "toggleOverwrite",
  "Esc": "singleSelection"
}
// Note that the save and find-related commands aren't defined by
// default. User code or addons can define them. Unknown commands
// are simply ignored.
keyMap.pcDefault = {
  "Ctrl-A": "selectAll", "Ctrl-D": "deleteLine", "Ctrl-Z": "undo", "Shift-Ctrl-Z": "redo", "Ctrl-Y": "redo",
  "Ctrl-Home": "goDocStart", "Ctrl-End": "goDocEnd", "Ctrl-Up": "goLineUp", "Ctrl-Down": "goLineDown",
  "Ctrl-Left": "goGroupLeft", "Ctrl-Right": "goGroupRight", "Alt-Left": "goLineStart", "Alt-Right": "goLineEnd",
  "Ctrl-Backspace": "delGroupBefore", "Ctrl-Delete": "delGroupAfter", "Ctrl-S": "save", "Ctrl-F": "find",
  "Ctrl-G": "findNext", "Shift-Ctrl-G": "findPrev", "Shift-Ctrl-F": "replace", "Shift-Ctrl-R": "replaceAll",
  "Ctrl-[": "indentLess", "Ctrl-]": "indentMore",
  "Ctrl-U": "undoSelection", "Shift-Ctrl-U": "redoSelection", "Alt-U": "redoSelection",
  fallthrough: "basic"
}
// Very basic readline/emacs-style bindings, which are standard on Mac.
keyMap.emacsy = {
  "Ctrl-F": "goCharRight", "Ctrl-B": "goCharLeft", "Ctrl-P": "goLineUp", "Ctrl-N": "goLineDown",
  "Alt-F": "goWordRight", "Alt-B": "goWordLeft", "Ctrl-A": "goLineStart", "Ctrl-E": "goLineEnd",
  "Ctrl-V": "goPageDown", "Shift-Ctrl-V": "goPageUp", "Ctrl-D": "delCharAfter", "Ctrl-H": "delCharBefore",
  "Alt-D": "delWordAfter", "Alt-Backspace": "delWordBefore", "Ctrl-K": "killLine", "Ctrl-T": "transposeChars",
  "Ctrl-O": "openLine"
}
keyMap.macDefault = {
  "Cmd-A": "selectAll", "Cmd-D": "deleteLine", "Cmd-Z": "undo", "Shift-Cmd-Z": "redo", "Cmd-Y": "redo",
  "Cmd-Home": "goDocStart", "Cmd-Up": "goDocStart", "Cmd-End": "goDocEnd", "Cmd-Down": "goDocEnd", "Alt-Left": "goGroupLeft",
  "Alt-Right": "goGroupRight", "Cmd-Left": "goLineLeft", "Cmd-Right": "goLineRight", "Alt-Backspace": "delGroupBefore",
  "Ctrl-Alt-Backspace": "delGroupAfter", "Alt-Delete": "delGroupAfter", "Cmd-S": "save", "Cmd-F": "find",
  "Cmd-G": "findNext", "Shift-Cmd-G": "findPrev", "Cmd-Alt-F": "replace", "Shift-Cmd-Alt-F": "replaceAll",
  "Cmd-[": "indentLess", "Cmd-]": "indentMore", "Cmd-Backspace": "delWrappedLineLeft", "Cmd-Delete": "delWrappedLineRight",
  "Cmd-U": "undoSelection", "Shift-Cmd-U": "redoSelection", "Ctrl-Up": "goDocStart", "Ctrl-Down": "goDocEnd",
  fallthrough: ["basic", "emacsy"]
}
keyMap["default"] = mac ? keyMap.macDefault : keyMap.pcDefault

// KEYMAP DISPATCH

function normalizeKeyName(name) {
  var parts = name.split(/-(?!$)/)
  name = parts[parts.length - 1]
  var alt, ctrl, shift, cmd
  for (var i = 0; i < parts.length - 1; i++) {
    var mod = parts[i]
    if (/^(cmd|meta|m)$/i.test(mod)) { cmd = true }
    else if (/^a(lt)?$/i.test(mod)) { alt = true }
    else if (/^(c|ctrl|control)$/i.test(mod)) { ctrl = true }
    else if (/^s(hift)?$/i.test(mod)) { shift = true }
    else { throw new Error("Unrecognized modifier name: " + mod) }
  }
  if (alt) { name = "Alt-" + name }
  if (ctrl) { name = "Ctrl-" + name }
  if (cmd) { name = "Cmd-" + name }
  if (shift) { name = "Shift-" + name }
  return name
}

// This is a kludge to keep keymaps mostly working as raw objects
// (backwards compatibility) while at the same time support features
// like normalization and multi-stroke key bindings. It compiles a
// new normalized keymap, and then updates the old object to reflect
// this.
function normalizeKeyMap(keymap) {
  var copy = {}
  for (var keyname in keymap) { if (keymap.hasOwnProperty(keyname)) {
    var value = keymap[keyname]
    if (/^(name|fallthrough|(de|at)tach)$/.test(keyname)) { continue }
    if (value == "...") { delete keymap[keyname]; continue }

    var keys = map(keyname.split(" "), normalizeKeyName)
    for (var i = 0; i < keys.length; i++) {
      var val = (void 0), name = (void 0)
      if (i == keys.length - 1) {
        name = keys.join(" ")
        val = value
      } else {
        name = keys.slice(0, i + 1).join(" ")
        val = "..."
      }
      var prev = copy[name]
      if (!prev) { copy[name] = val }
      else if (prev != val) { throw new Error("Inconsistent bindings for " + name) }
    }
    delete keymap[keyname]
  } }
  for (var prop in copy) { keymap[prop] = copy[prop] }
  return keymap
}

function lookupKey(key, map, handle, context) {
  map = getKeyMap(map)
  var found = map.call ? map.call(key, context) : map[key]
  if (found === false) { return "nothing" }
  if (found === "...") { return "multi" }
  if (found != null && handle(found)) { return "handled" }

  if (map.fallthrough) {
    if (Object.prototype.toString.call(map.fallthrough) != "[object Array]")
      { return lookupKey(key, map.fallthrough, handle, context) }
    for (var i = 0; i < map.fallthrough.length; i++) {
      var result = lookupKey(key, map.fallthrough[i], handle, context)
      if (result) { return result }
    }
  }
}

// Modifier key presses don't count as 'real' key presses for the
// purpose of keymap fallthrough.
function isModifierKey(value) {
  var name = typeof value == "string" ? value : keyNames[value.keyCode]
  return name == "Ctrl" || name == "Alt" || name == "Shift" || name == "Mod"
}

function addModifierNames(name, event, noShift) {
  var base = name
  if (event.altKey && base != "Alt") { name = "Alt-" + name }
  if ((flipCtrlCmd ? event.metaKey : event.ctrlKey) && base != "Ctrl") { name = "Ctrl-" + name }
  if ((flipCtrlCmd ? event.ctrlKey : event.metaKey) && base != "Cmd") { name = "Cmd-" + name }
  if (!noShift && event.shiftKey && base != "Shift") { name = "Shift-" + name }
  return name
}

// Look up the name of a key as indicated by an event object.
function keyName(event, noShift) {
  if (presto && event.keyCode == 34 && event["char"]) { return false }
  var name = keyNames[event.keyCode]
  if (name == null || event.altGraphKey) { return false }
  // Ctrl-ScrollLock has keyCode 3, same as Ctrl-Pause,
  // so we'll use event.code when available (Chrome 48+, FF 38+, Safari 10.1+)
  if (event.keyCode == 3 && event.code) { name = event.code }
  return addModifierNames(name, event, noShift)
}

function getKeyMap(val) {
  return typeof val == "string" ? keyMap[val] : val
}

// Helper for deleting text near the selection(s), used to implement
// backspace, delete, and similar functionality.
function deleteNearSelection(cm, compute) {
  var ranges = cm.doc.sel.ranges, kill = []
  // Build up a set of ranges to kill first, merging overlapping
  // ranges.
  for (var i = 0; i < ranges.length; i++) {
    var toKill = compute(ranges[i])
    while (kill.length && cmp(toKill.from, lst(kill).to) <= 0) {
      var replaced = kill.pop()
      if (cmp(replaced.from, toKill.from) < 0) {
        toKill.from = replaced.from
        break
      }
    }
    kill.push(toKill)
  }
  // Next, remove those actual ranges.
  runInOp(cm, function () {
    for (var i = kill.length - 1; i >= 0; i--)
      { replaceRange(cm.doc, "", kill[i].from, kill[i].to, "+delete") }
    ensureCursorVisible(cm)
  })
}

function moveCharLogically(line, ch, dir) {
  var target = skipExtendingChars(line.text, ch + dir, dir)
  return target < 0 || target > line.text.length ? null : target
}

function moveLogically(line, start, dir) {
  var ch = moveCharLogically(line, start.ch, dir)
  return ch == null ? null : new Pos(start.line, ch, dir < 0 ? "after" : "before")
}

function endOfLine(visually, cm, lineObj, lineNo, dir) {
  if (visually) {
    var order = getOrder(lineObj, cm.doc.direction)
    if (order) {
      var part = dir < 0 ? lst(order) : order[0]
      var moveInStorageOrder = (dir < 0) == (part.level == 1)
      var sticky = moveInStorageOrder ? "after" : "before"
      var ch
      // With a wrapped rtl chunk (possibly spanning multiple bidi parts),
      // it could be that the last bidi part is not on the last visual line,
      // since visual lines contain content order-consecutive chunks.
      // Thus, in rtl, we are looking for the first (content-order) character
      // in the rtl chunk that is on the last line (that is, the same line
      // as the last (content-order) character).
      if (part.level > 0 || cm.doc.direction == "rtl") {
        var prep = prepareMeasureForLine(cm, lineObj)
        ch = dir < 0 ? lineObj.text.length - 1 : 0
        var targetTop = measureCharPrepared(cm, prep, ch).top
        ch = findFirst(function (ch) { return measureCharPrepared(cm, prep, ch).top == targetTop; }, (dir < 0) == (part.level == 1) ? part.from : part.to - 1, ch)
        if (sticky == "before") { ch = moveCharLogically(lineObj, ch, 1) }
      } else { ch = dir < 0 ? part.to : part.from }
      return new Pos(lineNo, ch, sticky)
    }
  }
  return new Pos(lineNo, dir < 0 ? lineObj.text.length : 0, dir < 0 ? "before" : "after")
}

function moveVisually(cm, line, start, dir) {
  var bidi = getOrder(line, cm.doc.direction)
  if (!bidi) { return moveLogically(line, start, dir) }
  if (start.ch >= line.text.length) {
    start.ch = line.text.length
    start.sticky = "before"
  } else if (start.ch <= 0) {
    start.ch = 0
    start.sticky = "after"
  }
  var partPos = getBidiPartAt(bidi, start.ch, start.sticky), part = bidi[partPos]
  if (cm.doc.direction == "ltr" && part.level % 2 == 0 && (dir > 0 ? part.to > start.ch : part.from < start.ch)) {
    // Case 1: We move within an ltr part in an ltr editor. Even with wrapped lines,
    // nothing interesting happens.
    return moveLogically(line, start, dir)
  }

  var mv = function (pos, dir) { return moveCharLogically(line, pos instanceof Pos ? pos.ch : pos, dir); }
  var prep
  var getWrappedLineExtent = function (ch) {
    if (!cm.options.lineWrapping) { return {begin: 0, end: line.text.length} }
    prep = prep || prepareMeasureForLine(cm, line)
    return wrappedLineExtentChar(cm, line, prep, ch)
  }
  var wrappedLineExtent = getWrappedLineExtent(start.sticky == "before" ? mv(start, -1) : start.ch)

  if (cm.doc.direction == "rtl" || part.level == 1) {
    var moveInStorageOrder = (part.level == 1) == (dir < 0)
    var ch = mv(start, moveInStorageOrder ? 1 : -1)
    if (ch != null && (!moveInStorageOrder ? ch >= part.from && ch >= wrappedLineExtent.begin : ch <= part.to && ch <= wrappedLineExtent.end)) {
      // Case 2: We move within an rtl part or in an rtl editor on the same visual line
      var sticky = moveInStorageOrder ? "before" : "after"
      return new Pos(start.line, ch, sticky)
    }
  }

  // Case 3: Could not move within this bidi part in this visual line, so leave
  // the current bidi part

  var searchInVisualLine = function (partPos, dir, wrappedLineExtent) {
    var getRes = function (ch, moveInStorageOrder) { return moveInStorageOrder
      ? new Pos(start.line, mv(ch, 1), "before")
      : new Pos(start.line, ch, "after"); }

    for (; partPos >= 0 && partPos < bidi.length; partPos += dir) {
      var part = bidi[partPos]
      var moveInStorageOrder = (dir > 0) == (part.level != 1)
      var ch = moveInStorageOrder ? wrappedLineExtent.begin : mv(wrappedLineExtent.end, -1)
      if (part.from <= ch && ch < part.to) { return getRes(ch, moveInStorageOrder) }
      ch = moveInStorageOrder ? part.from : mv(part.to, -1)
      if (wrappedLineExtent.begin <= ch && ch < wrappedLineExtent.end) { return getRes(ch, moveInStorageOrder) }
    }
  }

  // Case 3a: Look for other bidi parts on the same visual line
  var res = searchInVisualLine(partPos + dir, dir, wrappedLineExtent)
  if (res) { return res }

  // Case 3b: Look for other bidi parts on the next visual line
  var nextCh = dir > 0 ? wrappedLineExtent.end : mv(wrappedLineExtent.begin, -1)
  if (nextCh != null && !(dir > 0 && nextCh == line.text.length)) {
    res = searchInVisualLine(dir > 0 ? 0 : bidi.length - 1, dir, getWrappedLineExtent(nextCh))
    if (res) { return res }
  }

  // Case 4: Nowhere to move
  return null
}

// Commands are parameter-less actions that can be performed on an
// editor, mostly used for keybindings.
var commands = {
  selectAll: selectAll,
  singleSelection: function (cm) { return cm.setSelection(cm.getCursor("anchor"), cm.getCursor("head"), sel_dontScroll); },
  killLine: function (cm) { return deleteNearSelection(cm, function (range) {
    if (range.empty()) {
      var len = getLine(cm.doc, range.head.line).text.length
      if (range.head.ch == len && range.head.line < cm.lastLine())
        { return {from: range.head, to: Pos(range.head.line + 1, 0)} }
      else
        { return {from: range.head, to: Pos(range.head.line, len)} }
    } else {
      return {from: range.from(), to: range.to()}
    }
  }); },
  deleteLine: function (cm) { return deleteNearSelection(cm, function (range) { return ({
    from: Pos(range.from().line, 0),
    to: clipPos(cm.doc, Pos(range.to().line + 1, 0))
  }); }); },
  delLineLeft: function (cm) { return deleteNearSelection(cm, function (range) { return ({
    from: Pos(range.from().line, 0), to: range.from()
  }); }); },
  delWrappedLineLeft: function (cm) { return deleteNearSelection(cm, function (range) {
    var top = cm.charCoords(range.head, "div").top + 5
    var leftPos = cm.coordsChar({left: 0, top: top}, "div")
    return {from: leftPos, to: range.from()}
  }); },
  delWrappedLineRight: function (cm) { return deleteNearSelection(cm, function (range) {
    var top = cm.charCoords(range.head, "div").top + 5
    var rightPos = cm.coordsChar({left: cm.display.lineDiv.offsetWidth + 100, top: top}, "div")
    return {from: range.from(), to: rightPos }
  }); },
  undo: function (cm) { return cm.undo(); },
  redo: function (cm) { return cm.redo(); },
  undoSelection: function (cm) { return cm.undoSelection(); },
  redoSelection: function (cm) { return cm.redoSelection(); },
  goDocStart: function (cm) { return cm.extendSelection(Pos(cm.firstLine(), 0)); },
  goDocEnd: function (cm) { return cm.extendSelection(Pos(cm.lastLine())); },
  goLineStart: function (cm) { return cm.extendSelectionsBy(function (range) { return lineStart(cm, range.head.line); },
    {origin: "+move", bias: 1}
  ); },
  goLineStartSmart: function (cm) { return cm.extendSelectionsBy(function (range) { return lineStartSmart(cm, range.head); },
    {origin: "+move", bias: 1}
  ); },
  goLineEnd: function (cm) { return cm.extendSelectionsBy(function (range) { return lineEnd(cm, range.head.line); },
    {origin: "+move", bias: -1}
  ); },
  goLineRight: function (cm) { return cm.extendSelectionsBy(function (range) {
    var top = cm.cursorCoords(range.head, "div").top + 5
    return cm.coordsChar({left: cm.display.lineDiv.offsetWidth + 100, top: top}, "div")
  }, sel_move); },
  goLineLeft: function (cm) { return cm.extendSelectionsBy(function (range) {
    var top = cm.cursorCoords(range.head, "div").top + 5
    return cm.coordsChar({left: 0, top: top}, "div")
  }, sel_move); },
  goLineLeftSmart: function (cm) { return cm.extendSelectionsBy(function (range) {
    var top = cm.cursorCoords(range.head, "div").top + 5
    var pos = cm.coordsChar({left: 0, top: top}, "div")
    if (pos.ch < cm.getLine(pos.line).search(/\S/)) { return lineStartSmart(cm, range.head) }
    return pos
  }, sel_move); },
  goLineUp: function (cm) { return cm.moveV(-1, "line"); },
  goLineDown: function (cm) { return cm.moveV(1, "line"); },
  goPageUp: function (cm) { return cm.moveV(-1, "page"); },
  goPageDown: function (cm) { return cm.moveV(1, "page"); },
  goCharLeft: function (cm) { return cm.moveH(-1, "char"); },
  goCharRight: function (cm) { return cm.moveH(1, "char"); },
  goColumnLeft: function (cm) { return cm.moveH(-1, "column"); },
  goColumnRight: function (cm) { return cm.moveH(1, "column"); },
  goWordLeft: function (cm) { return cm.moveH(-1, "word"); },
  goGroupRight: function (cm) { return cm.moveH(1, "group"); },
  goGroupLeft: function (cm) { return cm.moveH(-1, "group"); },
  goWordRight: function (cm) { return cm.moveH(1, "word"); },
  delCharBefore: function (cm) { return cm.deleteH(-1, "char"); },
  delCharAfter: function (cm) { return cm.deleteH(1, "char"); },
  delWordBefore: function (cm) { return cm.deleteH(-1, "word"); },
  delWordAfter: function (cm) { return cm.deleteH(1, "word"); },
  delGroupBefore: function (cm) { return cm.deleteH(-1, "group"); },
  delGroupAfter: function (cm) { return cm.deleteH(1, "group"); },
  indentAuto: function (cm) { return cm.indentSelection("smart"); },
  indentMore: function (cm) { return cm.indentSelection("add"); },
  indentLess: function (cm) { return cm.indentSelection("subtract"); },
  insertTab: function (cm) { return cm.replaceSelection("\t"); },
  insertSoftTab: function (cm) {
    var spaces = [], ranges = cm.listSelections(), tabSize = cm.options.tabSize
    for (var i = 0; i < ranges.length; i++) {
      var pos = ranges[i].from()
      var col = countColumn(cm.getLine(pos.line), pos.ch, tabSize)
      spaces.push(spaceStr(tabSize - col % tabSize))
    }
    cm.replaceSelections(spaces)
  },
  defaultTab: function (cm) {
    if (cm.somethingSelected()) { cm.indentSelection("add") }
    else { cm.execCommand("insertTab") }
  },
  // Swap the two chars left and right of each selection's head.
  // Move cursor behind the two swapped characters afterwards.
  //
  // Doesn't consider line feeds a character.
  // Doesn't scan more than one line above to find a character.
  // Doesn't do anything on an empty line.
  // Doesn't do anything with non-empty selections.
  transposeChars: function (cm) { return runInOp(cm, function () {
    var ranges = cm.listSelections(), newSel = []
    for (var i = 0; i < ranges.length; i++) {
      if (!ranges[i].empty()) { continue }
      var cur = ranges[i].head, line = getLine(cm.doc, cur.line).text
      if (line) {
        if (cur.ch == line.length) { cur = new Pos(cur.line, cur.ch - 1) }
        if (cur.ch > 0) {
          cur = new Pos(cur.line, cur.ch + 1)
          cm.replaceRange(line.charAt(cur.ch - 1) + line.charAt(cur.ch - 2),
                          Pos(cur.line, cur.ch - 2), cur, "+transpose")
        } else if (cur.line > cm.doc.first) {
          var prev = getLine(cm.doc, cur.line - 1).text
          if (prev) {
            cur = new Pos(cur.line, 1)
            cm.replaceRange(line.charAt(0) + cm.doc.lineSeparator() +
                            prev.charAt(prev.length - 1),
                            Pos(cur.line - 1, prev.length - 1), cur, "+transpose")
          }
        }
      }
      newSel.push(new Range(cur, cur))
    }
    cm.setSelections(newSel)
  }); },
  newlineAndIndent: function (cm) { return runInOp(cm, function () {
    var sels = cm.listSelections()
    for (var i = sels.length - 1; i >= 0; i--)
      { cm.replaceRange(cm.doc.lineSeparator(), sels[i].anchor, sels[i].head, "+input") }
    sels = cm.listSelections()
    for (var i$1 = 0; i$1 < sels.length; i$1++)
      { cm.indentLine(sels[i$1].from().line, null, true) }
    ensureCursorVisible(cm)
  }); },
  openLine: function (cm) { return cm.replaceSelection("\n", "start"); },
  toggleOverwrite: function (cm) { return cm.toggleOverwrite(); }
}


function lineStart(cm, lineN) {
  var line = getLine(cm.doc, lineN)
  var visual = visualLine(line)
  if (visual != line) { lineN = lineNo(visual) }
  return endOfLine(true, cm, visual, lineN, 1)
}
function lineEnd(cm, lineN) {
  var line = getLine(cm.doc, lineN)
  var visual = visualLineEnd(line)
  if (visual != line) { lineN = lineNo(visual) }
  return endOfLine(true, cm, line, lineN, -1)
}
function lineStartSmart(cm, pos) {
  var start = lineStart(cm, pos.line)
  var line = getLine(cm.doc, start.line)
  var order = getOrder(line, cm.doc.direction)
  if (!order || order[0].level == 0) {
    var firstNonWS = Math.max(0, line.text.search(/\S/))
    var inWS = pos.line == start.line && pos.ch <= firstNonWS && pos.ch
    return Pos(start.line, inWS ? 0 : firstNonWS, start.sticky)
  }
  return start
}

// Run a handler that was bound to a key.
function doHandleBinding(cm, bound, dropShift) {
  if (typeof bound == "string") {
    bound = commands[bound]
    if (!bound) { return false }
  }
  // Ensure previous input has been read, so that the handler sees a
  // consistent view of the document
  cm.display.input.ensurePolled()
  var prevShift = cm.display.shift, done = false
  try {
    if (cm.isReadOnly()) { cm.state.suppressEdits = true }
    if (dropShift) { cm.display.shift = false }
    done = bound(cm) != Pass
  } finally {
    cm.display.shift = prevShift
    cm.state.suppressEdits = false
  }
  return done
}

function lookupKeyForEditor(cm, name, handle) {
  for (var i = 0; i < cm.state.keyMaps.length; i++) {
    var result = lookupKey(name, cm.state.keyMaps[i], handle, cm)
    if (result) { return result }
  }
  return (cm.options.extraKeys && lookupKey(name, cm.options.extraKeys, handle, cm))
    || lookupKey(name, cm.options.keyMap, handle, cm)
}

// Note that, despite the name, this function is also used to check
// for bound mouse clicks.

var stopSeq = new Delayed

function dispatchKey(cm, name, e, handle) {
  var seq = cm.state.keySeq
  if (seq) {
    if (isModifierKey(name)) { return "handled" }
    if (/\'$/.test(name))
      { cm.state.keySeq = null }
    else
      { stopSeq.set(50, function () {
        if (cm.state.keySeq == seq) {
          cm.state.keySeq = null
          cm.display.input.reset()
        }
      }) }
    if (dispatchKeyInner(cm, seq + " " + name, e, handle)) { return true }
  }
  return dispatchKeyInner(cm, name, e, handle)
}

function dispatchKeyInner(cm, name, e, handle) {
  var result = lookupKeyForEditor(cm, name, handle)

  if (result == "multi")
    { cm.state.keySeq = name }
  if (result == "handled")
    { signalLater(cm, "keyHandled", cm, name, e) }

  if (result == "handled" || result == "multi") {
    e_preventDefault(e)
    restartBlink(cm)
  }

  return !!result
}

// Handle a key from the keydown event.
function handleKeyBinding(cm, e) {
  var name = keyName(e, true)
  if (!name) { return false }

  if (e.shiftKey && !cm.state.keySeq) {
    // First try to resolve full name (including 'Shift-'). Failing
    // that, see if there is a cursor-motion command (starting with
    // 'go') bound to the keyname without 'Shift-'.
    return dispatchKey(cm, "Shift-" + name, e, function (b) { return doHandleBinding(cm, b, true); })
        || dispatchKey(cm, name, e, function (b) {
             if (typeof b == "string" ? /^go[A-Z]/.test(b) : b.motion)
               { return doHandleBinding(cm, b) }
           })
  } else {
    return dispatchKey(cm, name, e, function (b) { return doHandleBinding(cm, b); })
  }
}

// Handle a key from the keypress event
function handleCharBinding(cm, e, ch) {
  return dispatchKey(cm, "'" + ch + "'", e, function (b) { return doHandleBinding(cm, b, true); })
}

var lastStoppedKey = null
function onKeyDown(e) {
  var cm = this
  cm.curOp.focus = activeElt()
  if (signalDOMEvent(cm, e)) { return }
  // IE does strange things with escape.
  if (ie && ie_version < 11 && e.keyCode == 27) { e.returnValue = false }
  var code = e.keyCode
  cm.display.shift = code == 16 || e.shiftKey
  var handled = handleKeyBinding(cm, e)
  if (presto) {
    lastStoppedKey = handled ? code : null
    // Opera has no cut event... we try to at least catch the key combo
    if (!handled && code == 88 && !hasCopyEvent && (mac ? e.metaKey : e.ctrlKey))
      { cm.replaceSelection("", null, "cut") }
  }

  // Turn mouse into crosshair when Alt is held on Mac.
  if (code == 18 && !/\bCodeMirror-crosshair\b/.test(cm.display.lineDiv.className))
    { showCrossHair(cm) }
}

function showCrossHair(cm) {
  var lineDiv = cm.display.lineDiv
  addClass(lineDiv, "CodeMirror-crosshair")

  function up(e) {
    if (e.keyCode == 18 || !e.altKey) {
      rmClass(lineDiv, "CodeMirror-crosshair")
      off(document, "keyup", up)
      off(document, "mouseover", up)
    }
  }
  on(document, "keyup", up)
  on(document, "mouseover", up)
}

function onKeyUp(e) {
  if (e.keyCode == 16) { this.doc.sel.shift = false }
  signalDOMEvent(this, e)
}

function onKeyPress(e) {
  var cm = this
  if (eventInWidget(cm.display, e) || signalDOMEvent(cm, e) || e.ctrlKey && !e.altKey || mac && e.metaKey) { return }
  var keyCode = e.keyCode, charCode = e.charCode
  if (presto && keyCode == lastStoppedKey) {lastStoppedKey = null; e_preventDefault(e); return}
  if ((presto && (!e.which || e.which < 10)) && handleKeyBinding(cm, e)) { return }
  var ch = String.fromCharCode(charCode == null ? keyCode : charCode)
  // Some browsers fire keypress events for backspace
  if (ch == "\x08") { return }
  if (handleCharBinding(cm, e, ch)) { return }
  cm.display.input.onKeyPress(e)
}

var DOUBLECLICK_DELAY = 400

var PastClick = function(time, pos, button) {
  this.time = time
  this.pos = pos
  this.button = button
};

PastClick.prototype.compare = function (time, pos, button) {
  return this.time + DOUBLECLICK_DELAY > time &&
    cmp(pos, this.pos) == 0 && button == this.button
};

var lastClick;
var lastDoubleClick;
function clickRepeat(pos, button) {
  var now = +new Date
  if (lastDoubleClick && lastDoubleClick.compare(now, pos, button)) {
    lastClick = lastDoubleClick = null
    return "triple"
  } else if (lastClick && lastClick.compare(now, pos, button)) {
    lastDoubleClick = new PastClick(now, pos, button)
    lastClick = null
    return "double"
  } else {
    lastClick = new PastClick(now, pos, button)
    lastDoubleClick = null
    return "single"
  }
}

// A mouse down can be a single click, double click, triple click,
// start of selection drag, start of text drag, new cursor
// (ctrl-click), rectangle drag (alt-drag), or xwin
// middle-click-paste. Or it might be a click on something we should
// not interfere with, such as a scrollbar or widget.
function onMouseDown(e) {
  var cm = this, display = cm.display
  if (signalDOMEvent(cm, e) || display.activeTouch && display.input.supportsTouch()) { return }
  display.input.ensurePolled()
  display.shift = e.shiftKey

  if (eventInWidget(display, e)) {
    if (!webkit) {
      // Briefly turn off draggability, to allow widgets to do
      // normal dragging things.
      display.scroller.draggable = false
      setTimeout(function () { return display.scroller.draggable = true; }, 100)
    }
    return
  }
  if (clickInGutter(cm, e)) { return }
  var pos = posFromMouse(cm, e), button = e_button(e), repeat = pos ? clickRepeat(pos, button) : "single"
  window.focus()

  // #3261: make sure, that we're not starting a second selection
  if (button == 1 && cm.state.selectingText)
    { cm.state.selectingText(e) }

  if (pos && handleMappedButton(cm, button, pos, repeat, e)) { return }

  if (button == 1) {
    if (pos) { leftButtonDown(cm, pos, repeat, e) }
    else if (e_target(e) == display.scroller) { e_preventDefault(e) }
  } else if (button == 2) {
    if (pos) { extendSelection(cm.doc, pos) }
    setTimeout(function () { return display.input.focus(); }, 20)
  } else if (button == 3) {
    if (captureRightClick) { onContextMenu(cm, e) }
    else { delayBlurEvent(cm) }
  }
}

function handleMappedButton(cm, button, pos, repeat, event) {
  var name = "Click"
  if (repeat == "double") { name = "Double" + name }
  else if (repeat == "triple") { name = "Triple" + name }
  name = (button == 1 ? "Left" : button == 2 ? "Middle" : "Right") + name

  return dispatchKey(cm,  addModifierNames(name, event), event, function (bound) {
    if (typeof bound == "string") { bound = commands[bound] }
    if (!bound) { return false }
    var done = false
    try {
      if (cm.isReadOnly()) { cm.state.suppressEdits = true }
      done = bound(cm, pos) != Pass
    } finally {
      cm.state.suppressEdits = false
    }
    return done
  })
}

function configureMouse(cm, repeat, event) {
  var option = cm.getOption("configureMouse")
  var value = option ? option(cm, repeat, event) : {}
  if (value.unit == null) {
    var rect = chromeOS ? event.shiftKey && event.metaKey : event.altKey
    value.unit = rect ? "rectangle" : repeat == "single" ? "char" : repeat == "double" ? "word" : "line"
  }
  if (value.extend == null || cm.doc.extend) { value.extend = cm.doc.extend || event.shiftKey }
  if (value.addNew == null) { value.addNew = mac ? event.metaKey : event.ctrlKey }
  if (value.moveOnDrag == null) { value.moveOnDrag = !(mac ? event.altKey : event.ctrlKey) }
  return value
}

function leftButtonDown(cm, pos, repeat, event) {
  if (ie) { setTimeout(bind(ensureFocus, cm), 0) }
  else { cm.curOp.focus = activeElt() }

  var behavior = configureMouse(cm, repeat, event)

  var sel = cm.doc.sel, contained
  if (cm.options.dragDrop && dragAndDrop && !cm.isReadOnly() &&
      repeat == "single" && (contained = sel.contains(pos)) > -1 &&
      (cmp((contained = sel.ranges[contained]).from(), pos) < 0 || pos.xRel > 0) &&
      (cmp(contained.to(), pos) > 0 || pos.xRel < 0))
    { leftButtonStartDrag(cm, event, pos, behavior) }
  else
    { leftButtonSelect(cm, event, pos, behavior) }
}

// Start a text drag. When it ends, see if any dragging actually
// happen, and treat as a click if it didn't.
function leftButtonStartDrag(cm, event, pos, behavior) {
  var display = cm.display, moved = false
  var dragEnd = operation(cm, function (e) {
    if (webkit) { display.scroller.draggable = false }
    cm.state.draggingText = false
    off(document, "mouseup", dragEnd)
    off(document, "mousemove", mouseMove)
    off(display.scroller, "dragstart", dragStart)
    off(display.scroller, "drop", dragEnd)
    if (!moved) {
      e_preventDefault(e)
      if (!behavior.addNew)
        { extendSelection(cm.doc, pos, null, null, behavior.extend) }
      // Work around unexplainable focus problem in IE9 (#2127) and Chrome (#3081)
      if (webkit || ie && ie_version == 9)
        { setTimeout(function () {document.body.focus(); display.input.focus()}, 20) }
      else
        { display.input.focus() }
    }
  })
  var mouseMove = function(e2) {
    moved = moved || Math.abs(event.clientX - e2.clientX) + Math.abs(event.clientY - e2.clientY) >= 10
  }
  var dragStart = function () { return moved = true; }
  // Let the drag handler handle this.
  if (webkit) { display.scroller.draggable = true }
  cm.state.draggingText = dragEnd
  dragEnd.copy = !behavior.moveOnDrag
  // IE's approach to draggable
  if (display.scroller.dragDrop) { display.scroller.dragDrop() }
  on(document, "mouseup", dragEnd)
  on(document, "mousemove", mouseMove)
  on(display.scroller, "dragstart", dragStart)
  on(display.scroller, "drop", dragEnd)

  delayBlurEvent(cm)
  setTimeout(function () { return display.input.focus(); }, 20)
}

function rangeForUnit(cm, pos, unit) {
  if (unit == "char") { return new Range(pos, pos) }
  if (unit == "word") { return cm.findWordAt(pos) }
  if (unit == "line") { return new Range(Pos(pos.line, 0), clipPos(cm.doc, Pos(pos.line + 1, 0))) }
  var result = unit(cm, pos)
  return new Range(result.from, result.to)
}

// Normal selection, as opposed to text dragging.
function leftButtonSelect(cm, event, start, behavior) {
  var display = cm.display, doc = cm.doc
  e_preventDefault(event)

  var ourRange, ourIndex, startSel = doc.sel, ranges = startSel.ranges
  if (behavior.addNew && !behavior.extend) {
    ourIndex = doc.sel.contains(start)
    if (ourIndex > -1)
      { ourRange = ranges[ourIndex] }
    else
      { ourRange = new Range(start, start) }
  } else {
    ourRange = doc.sel.primary()
    ourIndex = doc.sel.primIndex
  }

  if (behavior.unit == "rectangle") {
    if (!behavior.addNew) { ourRange = new Range(start, start) }
    start = posFromMouse(cm, event, true, true)
    ourIndex = -1
  } else {
    var range = rangeForUnit(cm, start, behavior.unit)
    if (behavior.extend)
      { ourRange = extendRange(ourRange, range.anchor, range.head, behavior.extend) }
    else
      { ourRange = range }
  }

  if (!behavior.addNew) {
    ourIndex = 0
    setSelection(doc, new Selection([ourRange], 0), sel_mouse)
    startSel = doc.sel
  } else if (ourIndex == -1) {
    ourIndex = ranges.length
    setSelection(doc, normalizeSelection(ranges.concat([ourRange]), ourIndex),
                 {scroll: false, origin: "*mouse"})
  } else if (ranges.length > 1 && ranges[ourIndex].empty() && behavior.unit == "char" && !behavior.extend) {
    setSelection(doc, normalizeSelection(ranges.slice(0, ourIndex).concat(ranges.slice(ourIndex + 1)), 0),
                 {scroll: false, origin: "*mouse"})
    startSel = doc.sel
  } else {
    replaceOneSelection(doc, ourIndex, ourRange, sel_mouse)
  }

  var lastPos = start
  function extendTo(pos) {
    if (cmp(lastPos, pos) == 0) { return }
    lastPos = pos

    if (behavior.unit == "rectangle") {
      var ranges = [], tabSize = cm.options.tabSize
      var startCol = countColumn(getLine(doc, start.line).text, start.ch, tabSize)
      var posCol = countColumn(getLine(doc, pos.line).text, pos.ch, tabSize)
      var left = Math.min(startCol, posCol), right = Math.max(startCol, posCol)
      for (var line = Math.min(start.line, pos.line), end = Math.min(cm.lastLine(), Math.max(start.line, pos.line));
           line <= end; line++) {
        var text = getLine(doc, line).text, leftPos = findColumn(text, left, tabSize)
        if (left == right)
          { ranges.push(new Range(Pos(line, leftPos), Pos(line, leftPos))) }
        else if (text.length > leftPos)
          { ranges.push(new Range(Pos(line, leftPos), Pos(line, findColumn(text, right, tabSize)))) }
      }
      if (!ranges.length) { ranges.push(new Range(start, start)) }
      setSelection(doc, normalizeSelection(startSel.ranges.slice(0, ourIndex).concat(ranges), ourIndex),
                   {origin: "*mouse", scroll: false})
      cm.scrollIntoView(pos)
    } else {
      var oldRange = ourRange
      var range = rangeForUnit(cm, pos, behavior.unit)
      var anchor = oldRange.anchor, head
      if (cmp(range.anchor, anchor) > 0) {
        head = range.head
        anchor = minPos(oldRange.from(), range.anchor)
      } else {
        head = range.anchor
        anchor = maxPos(oldRange.to(), range.head)
      }
      var ranges$1 = startSel.ranges.slice(0)
      ranges$1[ourIndex] = bidiSimplify(cm, new Range(clipPos(doc, anchor), head))
      setSelection(doc, normalizeSelection(ranges$1, ourIndex), sel_mouse)
    }
  }

  var editorSize = display.wrapper.getBoundingClientRect()
  // Used to ensure timeout re-tries don't fire when another extend
  // happened in the meantime (clearTimeout isn't reliable -- at
  // least on Chrome, the timeouts still happen even when cleared,
  // if the clear happens after their scheduled firing time).
  var counter = 0

  function extend(e) {
    var curCount = ++counter
    var cur = posFromMouse(cm, e, true, behavior.unit == "rectangle")
    if (!cur) { return }
    if (cmp(cur, lastPos) != 0) {
      cm.curOp.focus = activeElt()
      extendTo(cur)
      var visible = visibleLines(display, doc)
      if (cur.line >= visible.to || cur.line < visible.from)
        { setTimeout(operation(cm, function () {if (counter == curCount) { extend(e) }}), 150) }
    } else {
      var outside = e.clientY < editorSize.top ? -20 : e.clientY > editorSize.bottom ? 20 : 0
      if (outside) { setTimeout(operation(cm, function () {
        if (counter != curCount) { return }
        display.scroller.scrollTop += outside
        extend(e)
      }), 50) }
    }
  }

  function done(e) {
    cm.state.selectingText = false
    counter = Infinity
    e_preventDefault(e)
    display.input.focus()
    off(document, "mousemove", move)
    off(document, "mouseup", up)
    doc.history.lastSelOrigin = null
  }

  var move = operation(cm, function (e) {
    if (!e_button(e)) { done(e) }
    else { extend(e) }
  })
  var up = operation(cm, done)
  cm.state.selectingText = up
  on(document, "mousemove", move)
  on(document, "mouseup", up)
}

// Used when mouse-selecting to adjust the anchor to the proper side
// of a bidi jump depending on the visual position of the head.
function bidiSimplify(cm, range) {
  var anchor = range.anchor;
  var head = range.head;
  var anchorLine = getLine(cm.doc, anchor.line)
  if (cmp(anchor, head) == 0 && anchor.sticky == head.sticky) { return range }
  var order = getOrder(anchorLine)
  if (!order) { return range }
  var index = getBidiPartAt(order, anchor.ch, anchor.sticky), part = order[index]
  if (part.from != anchor.ch && part.to != anchor.ch) { return range }
  var boundary = index + ((part.from == anchor.ch) == (part.level != 1) ? 0 : 1)
  if (boundary == 0 || boundary == order.length) { return range }

  // Compute the relative visual position of the head compared to the
  // anchor (<0 is to the left, >0 to the right)
  var leftSide
  if (head.line != anchor.line) {
    leftSide = (head.line - anchor.line) * (cm.doc.direction == "ltr" ? 1 : -1) > 0
  } else {
    var headIndex = getBidiPartAt(order, head.ch, head.sticky)
    var dir = headIndex - index || (head.ch - anchor.ch) * (part.level == 1 ? -1 : 1)
    if (headIndex == boundary - 1 || headIndex == boundary)
      { leftSide = dir < 0 }
    else
      { leftSide = dir > 0 }
  }

  var usePart = order[boundary + (leftSide ? -1 : 0)]
  var from = leftSide == (usePart.level == 1)
  var ch = from ? usePart.from : usePart.to, sticky = from ? "after" : "before"
  return anchor.ch == ch && anchor.sticky == sticky ? range : new Range(new Pos(anchor.line, ch, sticky), head)
}


// Determines whether an event happened in the gutter, and fires the
// handlers for the corresponding event.
function gutterEvent(cm, e, type, prevent) {
  var mX, mY
  if (e.touches) {
    mX = e.touches[0].clientX
    mY = e.touches[0].clientY
  } else {
    try { mX = e.clientX; mY = e.clientY }
    catch(e) { return false }
  }
  if (mX >= Math.floor(cm.display.gutters.getBoundingClientRect().right)) { return false }
  if (prevent) { e_preventDefault(e) }

  var display = cm.display
  var lineBox = display.lineDiv.getBoundingClientRect()

  if (mY > lineBox.bottom || !hasHandler(cm, type)) { return e_defaultPrevented(e) }
  mY -= lineBox.top - display.viewOffset

  for (var i = 0; i < cm.options.gutters.length; ++i) {
    var g = display.gutters.childNodes[i]
    if (g && g.getBoundingClientRect().right >= mX) {
      var line = lineAtHeight(cm.doc, mY)
      var gutter = cm.options.gutters[i]
      signal(cm, type, cm, line, gutter, e)
      return e_defaultPrevented(e)
    }
  }
}

function clickInGutter(cm, e) {
  return gutterEvent(cm, e, "gutterClick", true)
}

// CONTEXT MENU HANDLING

// To make the context menu work, we need to briefly unhide the
// textarea (making it as unobtrusive as possible) to let the
// right-click take effect on it.
function onContextMenu(cm, e) {
  if (eventInWidget(cm.display, e) || contextMenuInGutter(cm, e)) { return }
  if (signalDOMEvent(cm, e, "contextmenu")) { return }
  cm.display.input.onContextMenu(e)
}

function contextMenuInGutter(cm, e) {
  if (!hasHandler(cm, "gutterContextMenu")) { return false }
  return gutterEvent(cm, e, "gutterContextMenu", false)
}

function themeChanged(cm) {
  cm.display.wrapper.className = cm.display.wrapper.className.replace(/\s*cm-s-\S+/g, "") +
    cm.options.theme.replace(/(^|\s)\s*/g, " cm-s-")
  clearCaches(cm)
}

var Init = {toString: function(){return "CodeMirror.Init"}}

var defaults = {}
var optionHandlers = {}

function defineOptions(CodeMirror) {
  var optionHandlers = CodeMirror.optionHandlers

  function option(name, deflt, handle, notOnInit) {
    CodeMirror.defaults[name] = deflt
    if (handle) { optionHandlers[name] =
      notOnInit ? function (cm, val, old) {if (old != Init) { handle(cm, val, old) }} : handle }
  }

  CodeMirror.defineOption = option

  // Passed to option handlers when there is no old value.
  CodeMirror.Init = Init

  // These two are, on init, called from the constructor because they
  // have to be initialized before the editor can start at all.
  option("value", "", function (cm, val) { return cm.setValue(val); }, true)
  option("mode", null, function (cm, val) {
    cm.doc.modeOption = val
    loadMode(cm)
  }, true)

  option("indentUnit", 2, loadMode, true)
  option("indentWithTabs", false)
  option("smartIndent", true)
  option("tabSize", 4, function (cm) {
    resetModeState(cm)
    clearCaches(cm)
    regChange(cm)
  }, true)

  option("lineSeparator", null, function (cm, val) {
    cm.doc.lineSep = val
    if (!val) { return }
    var newBreaks = [], lineNo = cm.doc.first
    cm.doc.iter(function (line) {
      for (var pos = 0;;) {
        var found = line.text.indexOf(val, pos)
        if (found == -1) { break }
        pos = found + val.length
        newBreaks.push(Pos(lineNo, found))
      }
      lineNo++
    })
    for (var i = newBreaks.length - 1; i >= 0; i--)
      { replaceRange(cm.doc, val, newBreaks[i], Pos(newBreaks[i].line, newBreaks[i].ch + val.length)) }
  })
  option("specialChars", /[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b-\u200f\u2028\u2029\ufeff]/g, function (cm, val, old) {
    cm.state.specialChars = new RegExp(val.source + (val.test("\t") ? "" : "|\t"), "g")
    if (old != Init) { cm.refresh() }
  })
  option("specialCharPlaceholder", defaultSpecialCharPlaceholder, function (cm) { return cm.refresh(); }, true)
  option("electricChars", true)
  option("inputStyle", mobile ? "contenteditable" : "textarea", function () {
    throw new Error("inputStyle can not (yet) be changed in a running editor") // FIXME
  }, true)
  option("spellcheck", false, function (cm, val) { return cm.getInputField().spellcheck = val; }, true)
  option("rtlMoveVisually", !windows)
  option("wholeLineUpdateBefore", true)

  option("theme", "default", function (cm) {
    themeChanged(cm)
    guttersChanged(cm)
  }, true)
  option("keyMap", "default", function (cm, val, old) {
    var next = getKeyMap(val)
    var prev = old != Init && getKeyMap(old)
    if (prev && prev.detach) { prev.detach(cm, next) }
    if (next.attach) { next.attach(cm, prev || null) }
  })
  option("extraKeys", null)
  option("configureMouse", null)

  option("lineWrapping", false, wrappingChanged, true)
  option("gutters", [], function (cm) {
    setGuttersForLineNumbers(cm.options)
    guttersChanged(cm)
  }, true)
  option("fixedGutter", true, function (cm, val) {
    cm.display.gutters.style.left = val ? compensateForHScroll(cm.display) + "px" : "0"
    cm.refresh()
  }, true)
  option("coverGutterNextToScrollbar", false, function (cm) { return updateScrollbars(cm); }, true)
  option("scrollbarStyle", "native", function (cm) {
    initScrollbars(cm)
    updateScrollbars(cm)
    cm.display.scrollbars.setScrollTop(cm.doc.scrollTop)
    cm.display.scrollbars.setScrollLeft(cm.doc.scrollLeft)
  }, true)
  option("lineNumbers", false, function (cm) {
    setGuttersForLineNumbers(cm.options)
    guttersChanged(cm)
  }, true)
  option("firstLineNumber", 1, guttersChanged, true)
  option("lineNumberFormatter", function (integer) { return integer; }, guttersChanged, true)
  option("showCursorWhenSelecting", false, updateSelection, true)

  option("resetSelectionOnContextMenu", true)
  option("lineWiseCopyCut", true)
  option("pasteLinesPerSelection", true)

  option("readOnly", false, function (cm, val) {
    if (val == "nocursor") {
      onBlur(cm)
      cm.display.input.blur()
    }
    cm.display.input.readOnlyChanged(val)
  })
  option("disableInput", false, function (cm, val) {if (!val) { cm.display.input.reset() }}, true)
  option("dragDrop", true, dragDropChanged)
  option("allowDropFileTypes", null)

  option("cursorBlinkRate", 530)
  option("cursorScrollMargin", 0)
  option("cursorHeight", 1, updateSelection, true)
  option("singleCursorHeightPerLine", true, updateSelection, true)
  option("workTime", 100)
  option("workDelay", 100)
  option("flattenSpans", true, resetModeState, true)
  option("addModeClass", false, resetModeState, true)
  option("pollInterval", 100)
  option("undoDepth", 200, function (cm, val) { return cm.doc.history.undoDepth = val; })
  option("historyEventDelay", 1250)
  option("viewportMargin", 10, function (cm) { return cm.refresh(); }, true)
  option("maxHighlightLength", 10000, resetModeState, true)
  option("moveInputWithCursor", true, function (cm, val) {
    if (!val) { cm.display.input.resetPosition() }
  })

  option("tabindex", null, function (cm, val) { return cm.display.input.getField().tabIndex = val || ""; })
  option("autofocus", null)
  option("direction", "ltr", function (cm, val) { return cm.doc.setDirection(val); }, true)
}

function guttersChanged(cm) {
  updateGutters(cm)
  regChange(cm)
  alignHorizontally(cm)
}

function dragDropChanged(cm, value, old) {
  var wasOn = old && old != Init
  if (!value != !wasOn) {
    var funcs = cm.display.dragFunctions
    var toggle = value ? on : off
    toggle(cm.display.scroller, "dragstart", funcs.start)
    toggle(cm.display.scroller, "dragenter", funcs.enter)
    toggle(cm.display.scroller, "dragover", funcs.over)
    toggle(cm.display.scroller, "dragleave", funcs.leave)
    toggle(cm.display.scroller, "drop", funcs.drop)
  }
}

function wrappingChanged(cm) {
  if (cm.options.lineWrapping) {
    addClass(cm.display.wrapper, "CodeMirror-wrap")
    cm.display.sizer.style.minWidth = ""
    cm.display.sizerWidth = null
  } else {
    rmClass(cm.display.wrapper, "CodeMirror-wrap")
    findMaxLine(cm)
  }
  estimateLineHeights(cm)
  regChange(cm)
  clearCaches(cm)
  setTimeout(function () { return updateScrollbars(cm); }, 100)
}

// A CodeMirror instance represents an editor. This is the object
// that user code is usually dealing with.

function CodeMirror(place, options) {
  var this$1 = this;

  if (!(this instanceof CodeMirror)) { return new CodeMirror(place, options) }

  this.options = options = options ? copyObj(options) : {}
  // Determine effective options based on given values and defaults.
  copyObj(defaults, options, false)
  setGuttersForLineNumbers(options)

  var doc = options.value
  if (typeof doc == "string") { doc = new Doc(doc, options.mode, null, options.lineSeparator, options.direction) }
  this.doc = doc

  var input = new CodeMirror.inputStyles[options.inputStyle](this)
  var display = this.display = new Display(place, doc, input)
  display.wrapper.CodeMirror = this
  updateGutters(this)
  themeChanged(this)
  if (options.lineWrapping)
    { this.display.wrapper.className += " CodeMirror-wrap" }
  initScrollbars(this)

  this.state = {
    keyMaps: [],  // stores maps added by addKeyMap
    overlays: [], // highlighting overlays, as added by addOverlay
    modeGen: 0,   // bumped when mode/overlay changes, used to invalidate highlighting info
    overwrite: false,
    delayingBlurEvent: false,
    focused: false,
    suppressEdits: false, // used to disable editing during key handlers when in readOnly mode
    pasteIncoming: false, cutIncoming: false, // help recognize paste/cut edits in input.poll
    selectingText: false,
    draggingText: false,
    highlight: new Delayed(), // stores highlight worker timeout
    keySeq: null,  // Unfinished key sequence
    specialChars: null
  }

  if (options.autofocus && !mobile) { display.input.focus() }

  // Override magic textarea content restore that IE sometimes does
  // on our hidden textarea on reload
  if (ie && ie_version < 11) { setTimeout(function () { return this$1.display.input.reset(true); }, 20) }

  registerEventHandlers(this)
  ensureGlobalHandlers()

  startOperation(this)
  this.curOp.forceUpdate = true
  attachDoc(this, doc)

  if ((options.autofocus && !mobile) || this.hasFocus())
    { setTimeout(bind(onFocus, this), 20) }
  else
    { onBlur(this) }

  for (var opt in optionHandlers) { if (optionHandlers.hasOwnProperty(opt))
    { optionHandlers[opt](this$1, options[opt], Init) } }
  maybeUpdateLineNumberWidth(this)
  if (options.finishInit) { options.finishInit(this) }
  for (var i = 0; i < initHooks.length; ++i) { initHooks[i](this$1) }
  endOperation(this)
  // Suppress optimizelegibility in Webkit, since it breaks text
  // measuring on line wrapping boundaries.
  if (webkit && options.lineWrapping &&
      getComputedStyle(display.lineDiv).textRendering == "optimizelegibility")
    { display.lineDiv.style.textRendering = "auto" }
}

// The default configuration options.
CodeMirror.defaults = defaults
// Functions to run when options are changed.
CodeMirror.optionHandlers = optionHandlers

// Attach the necessary event handlers when initializing the editor
function registerEventHandlers(cm) {
  var d = cm.display
  on(d.scroller, "mousedown", operation(cm, onMouseDown))
  // Older IE's will not fire a second mousedown for a double click
  if (ie && ie_version < 11)
    { on(d.scroller, "dblclick", operation(cm, function (e) {
      if (signalDOMEvent(cm, e)) { return }
      var pos = posFromMouse(cm, e)
      if (!pos || clickInGutter(cm, e) || eventInWidget(cm.display, e)) { return }
      e_preventDefault(e)
      var word = cm.findWordAt(pos)
      extendSelection(cm.doc, word.anchor, word.head)
    })) }
  else
    { on(d.scroller, "dblclick", function (e) { return signalDOMEvent(cm, e) || e_preventDefault(e); }) }
  // Some browsers fire contextmenu *after* opening the menu, at
  // which point we can't mess with it anymore. Context menu is
  // handled in onMouseDown for these browsers.
  if (!captureRightClick) { on(d.scroller, "contextmenu", function (e) { return onContextMenu(cm, e); }) }

  // Used to suppress mouse event handling when a touch happens
  var touchFinished, prevTouch = {end: 0}
  function finishTouch() {
    if (d.activeTouch) {
      touchFinished = setTimeout(function () { return d.activeTouch = null; }, 1000)
      prevTouch = d.activeTouch
      prevTouch.end = +new Date
    }
  }
  function isMouseLikeTouchEvent(e) {
    if (e.touches.length != 1) { return false }
    var touch = e.touches[0]
    return touch.radiusX <= 1 && touch.radiusY <= 1
  }
  function farAway(touch, other) {
    if (other.left == null) { return true }
    var dx = other.left - touch.left, dy = other.top - touch.top
    return dx * dx + dy * dy > 20 * 20
  }
  on(d.scroller, "touchstart", function (e) {
    if (!signalDOMEvent(cm, e) && !isMouseLikeTouchEvent(e) && !clickInGutter(cm, e)) {
      d.input.ensurePolled()
      clearTimeout(touchFinished)
      var now = +new Date
      d.activeTouch = {start: now, moved: false,
                       prev: now - prevTouch.end <= 300 ? prevTouch : null}
      if (e.touches.length == 1) {
        d.activeTouch.left = e.touches[0].pageX
        d.activeTouch.top = e.touches[0].pageY
      }
    }
  })
  on(d.scroller, "touchmove", function () {
    if (d.activeTouch) { d.activeTouch.moved = true }
  })
  on(d.scroller, "touchend", function (e) {
    var touch = d.activeTouch
    if (touch && !eventInWidget(d, e) && touch.left != null &&
        !touch.moved && new Date - touch.start < 300) {
      var pos = cm.coordsChar(d.activeTouch, "page"), range
      if (!touch.prev || farAway(touch, touch.prev)) // Single tap
        { range = new Range(pos, pos) }
      else if (!touch.prev.prev || farAway(touch, touch.prev.prev)) // Double tap
        { range = cm.findWordAt(pos) }
      else // Triple tap
        { range = new Range(Pos(pos.line, 0), clipPos(cm.doc, Pos(pos.line + 1, 0))) }
      cm.setSelection(range.anchor, range.head)
      cm.focus()
      e_preventDefault(e)
    }
    finishTouch()
  })
  on(d.scroller, "touchcancel", finishTouch)

  // Sync scrolling between fake scrollbars and real scrollable
  // area, ensure viewport is updated when scrolling.
  on(d.scroller, "scroll", function () {
    if (d.scroller.clientHeight) {
      updateScrollTop(cm, d.scroller.scrollTop)
      setScrollLeft(cm, d.scroller.scrollLeft, true)
      signal(cm, "scroll", cm)
    }
  })

  // Listen to wheel events in order to try and update the viewport on time.
  on(d.scroller, "mousewheel", function (e) { return onScrollWheel(cm, e); })
  on(d.scroller, "DOMMouseScroll", function (e) { return onScrollWheel(cm, e); })

  // Prevent wrapper from ever scrolling
  on(d.wrapper, "scroll", function () { return d.wrapper.scrollTop = d.wrapper.scrollLeft = 0; })

  d.dragFunctions = {
    enter: function (e) {if (!signalDOMEvent(cm, e)) { e_stop(e) }},
    over: function (e) {if (!signalDOMEvent(cm, e)) { onDragOver(cm, e); e_stop(e) }},
    start: function (e) { return onDragStart(cm, e); },
    drop: operation(cm, onDrop),
    leave: function (e) {if (!signalDOMEvent(cm, e)) { clearDragCursor(cm) }}
  }

  var inp = d.input.getField()
  on(inp, "keyup", function (e) { return onKeyUp.call(cm, e); })
  on(inp, "keydown", operation(cm, onKeyDown))
  on(inp, "keypress", operation(cm, onKeyPress))
  on(inp, "focus", function (e) { return onFocus(cm, e); })
  on(inp, "blur", function (e) { return onBlur(cm, e); })
}

var initHooks = []
CodeMirror.defineInitHook = function (f) { return initHooks.push(f); }

// Indent the given line. The how parameter can be "smart",
// "add"/null, "subtract", or "prev". When aggressive is false
// (typically set to true for forced single-line indents), empty
// lines are not indented, and places where the mode returns Pass
// are left alone.
function indentLine(cm, n, how, aggressive) {
  var doc = cm.doc, state
  if (how == null) { how = "add" }
  if (how == "smart") {
    // Fall back to "prev" when the mode doesn't have an indentation
    // method.
    if (!doc.mode.indent) { how = "prev" }
    else { state = getContextBefore(cm, n).state }
  }

  var tabSize = cm.options.tabSize
  var line = getLine(doc, n), curSpace = countColumn(line.text, null, tabSize)
  if (line.stateAfter) { line.stateAfter = null }
  var curSpaceString = line.text.match(/^\s*/)[0], indentation
  if (!aggressive && !/\S/.test(line.text)) {
    indentation = 0
    how = "not"
  } else if (how == "smart") {
    indentation = doc.mode.indent(state, line.text.slice(curSpaceString.length), line.text)
    if (indentation == Pass || indentation > 150) {
      if (!aggressive) { return }
      how = "prev"
    }
  }
  if (how == "prev") {
    if (n > doc.first) { indentation = countColumn(getLine(doc, n-1).text, null, tabSize) }
    else { indentation = 0 }
  } else if (how == "add") {
    indentation = curSpace + cm.options.indentUnit
  } else if (how == "subtract") {
    indentation = curSpace - cm.options.indentUnit
  } else if (typeof how == "number") {
    indentation = curSpace + how
  }
  indentation = Math.max(0, indentation)

  var indentString = "", pos = 0
  if (cm.options.indentWithTabs)
    { for (var i = Math.floor(indentation / tabSize); i; --i) {pos += tabSize; indentString += "\t"} }
  if (pos < indentation) { indentString += spaceStr(indentation - pos) }

  if (indentString != curSpaceString) {
    replaceRange(doc, indentString, Pos(n, 0), Pos(n, curSpaceString.length), "+input")
    line.stateAfter = null
    return true
  } else {
    // Ensure that, if the cursor was in the whitespace at the start
    // of the line, it is moved to the end of that space.
    for (var i$1 = 0; i$1 < doc.sel.ranges.length; i$1++) {
      var range = doc.sel.ranges[i$1]
      if (range.head.line == n && range.head.ch < curSpaceString.length) {
        var pos$1 = Pos(n, curSpaceString.length)
        replaceOneSelection(doc, i$1, new Range(pos$1, pos$1))
        break
      }
    }
  }
}

// This will be set to a {lineWise: bool, text: [string]} object, so
// that, when pasting, we know what kind of selections the copied
// text was made out of.
var lastCopied = null

function setLastCopied(newLastCopied) {
  lastCopied = newLastCopied
}

function applyTextInput(cm, inserted, deleted, sel, origin) {
  var doc = cm.doc
  cm.display.shift = false
  if (!sel) { sel = doc.sel }

  var paste = cm.state.pasteIncoming || origin == "paste"
  var textLines = splitLinesAuto(inserted), multiPaste = null
  // When pasting N lines into N selections, insert one line per selection
  if (paste && sel.ranges.length > 1) {
    if (lastCopied && lastCopied.text.join("\n") == inserted) {
      if (sel.ranges.length % lastCopied.text.length == 0) {
        multiPaste = []
        for (var i = 0; i < lastCopied.text.length; i++)
          { multiPaste.push(doc.splitLines(lastCopied.text[i])) }
      }
    } else if (textLines.length == sel.ranges.length && cm.options.pasteLinesPerSelection) {
      multiPaste = map(textLines, function (l) { return [l]; })
    }
  }

  var updateInput
  // Normal behavior is to insert the new text into every selection
  for (var i$1 = sel.ranges.length - 1; i$1 >= 0; i$1--) {
    var range = sel.ranges[i$1]
    var from = range.from(), to = range.to()
    if (range.empty()) {
      if (deleted && deleted > 0) // Handle deletion
        { from = Pos(from.line, from.ch - deleted) }
      else if (cm.state.overwrite && !paste) // Handle overwrite
        { to = Pos(to.line, Math.min(getLine(doc, to.line).text.length, to.ch + lst(textLines).length)) }
      else if (lastCopied && lastCopied.lineWise && lastCopied.text.join("\n") == inserted)
        { from = to = Pos(from.line, 0) }
    }
    updateInput = cm.curOp.updateInput
    var changeEvent = {from: from, to: to, text: multiPaste ? multiPaste[i$1 % multiPaste.length] : textLines,
                       origin: origin || (paste ? "paste" : cm.state.cutIncoming ? "cut" : "+input")}
    makeChange(cm.doc, changeEvent)
    signalLater(cm, "inputRead", cm, changeEvent)
  }
  if (inserted && !paste)
    { triggerElectric(cm, inserted) }

  ensureCursorVisible(cm)
  cm.curOp.updateInput = updateInput
  cm.curOp.typing = true
  cm.state.pasteIncoming = cm.state.cutIncoming = false
}

function handlePaste(e, cm) {
  var pasted = e.clipboardData && e.clipboardData.getData("Text")
  if (pasted) {
    e.preventDefault()
    if (!cm.isReadOnly() && !cm.options.disableInput)
      { runInOp(cm, function () { return applyTextInput(cm, pasted, 0, null, "paste"); }) }
    return true
  }
}

function triggerElectric(cm, inserted) {
  // When an 'electric' character is inserted, immediately trigger a reindent
  if (!cm.options.electricChars || !cm.options.smartIndent) { return }
  var sel = cm.doc.sel

  for (var i = sel.ranges.length - 1; i >= 0; i--) {
    var range = sel.ranges[i]
    if (range.head.ch > 100 || (i && sel.ranges[i - 1].head.line == range.head.line)) { continue }
    var mode = cm.getModeAt(range.head)
    var indented = false
    if (mode.electricChars) {
      for (var j = 0; j < mode.electricChars.length; j++)
        { if (inserted.indexOf(mode.electricChars.charAt(j)) > -1) {
          indented = indentLine(cm, range.head.line, "smart")
          break
        } }
    } else if (mode.electricInput) {
      if (mode.electricInput.test(getLine(cm.doc, range.head.line).text.slice(0, range.head.ch)))
        { indented = indentLine(cm, range.head.line, "smart") }
    }
    if (indented) { signalLater(cm, "electricInput", cm, range.head.line) }
  }
}

function copyableRanges(cm) {
  var text = [], ranges = []
  for (var i = 0; i < cm.doc.sel.ranges.length; i++) {
    var line = cm.doc.sel.ranges[i].head.line
    var lineRange = {anchor: Pos(line, 0), head: Pos(line + 1, 0)}
    ranges.push(lineRange)
    text.push(cm.getRange(lineRange.anchor, lineRange.head))
  }
  return {text: text, ranges: ranges}
}

function disableBrowserMagic(field, spellcheck) {
  field.setAttribute("autocorrect", "off")
  field.setAttribute("autocapitalize", "off")
  field.setAttribute("spellcheck", !!spellcheck)
}

function hiddenTextarea() {
  var te = elt("textarea", null, null, "position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; outline: none")
  var div = elt("div", [te], null, "overflow: hidden; position: relative; width: 3px; height: 0px;")
  // The textarea is kept positioned near the cursor to prevent the
  // fact that it'll be scrolled into view on input from scrolling
  // our fake cursor out of view. On webkit, when wrap=off, paste is
  // very slow. So make the area wide instead.
  if (webkit) { te.style.width = "1000px" }
  else { te.setAttribute("wrap", "off") }
  // If border: 0; -- iOS fails to open keyboard (issue #1287)
  if (ios) { te.style.border = "1px solid black" }
  disableBrowserMagic(te)
  return div
}

// The publicly visible API. Note that methodOp(f) means
// 'wrap f in an operation, performed on its `this` parameter'.

// This is not the complete set of editor methods. Most of the
// methods defined on the Doc type are also injected into
// CodeMirror.prototype, for backwards compatibility and
// convenience.

function addEditorMethods(CodeMirror) {
  var optionHandlers = CodeMirror.optionHandlers

  var helpers = CodeMirror.helpers = {}

  CodeMirror.prototype = {
    constructor: CodeMirror,
    focus: function(){window.focus(); this.display.input.focus()},

    setOption: function(option, value) {
      var options = this.options, old = options[option]
      if (options[option] == value && option != "mode") { return }
      options[option] = value
      if (optionHandlers.hasOwnProperty(option))
        { operation(this, optionHandlers[option])(this, value, old) }
      signal(this, "optionChange", this, option)
    },

    getOption: function(option) {return this.options[option]},
    getDoc: function() {return this.doc},

    addKeyMap: function(map, bottom) {
      this.state.keyMaps[bottom ? "push" : "unshift"](getKeyMap(map))
    },
    removeKeyMap: function(map) {
      var maps = this.state.keyMaps
      for (var i = 0; i < maps.length; ++i)
        { if (maps[i] == map || maps[i].name == map) {
          maps.splice(i, 1)
          return true
        } }
    },

    addOverlay: methodOp(function(spec, options) {
      var mode = spec.token ? spec : CodeMirror.getMode(this.options, spec)
      if (mode.startState) { throw new Error("Overlays may not be stateful.") }
      insertSorted(this.state.overlays,
                   {mode: mode, modeSpec: spec, opaque: options && options.opaque,
                    priority: (options && options.priority) || 0},
                   function (overlay) { return overlay.priority; })
      this.state.modeGen++
      regChange(this)
    }),
    removeOverlay: methodOp(function(spec) {
      var this$1 = this;

      var overlays = this.state.overlays
      for (var i = 0; i < overlays.length; ++i) {
        var cur = overlays[i].modeSpec
        if (cur == spec || typeof spec == "string" && cur.name == spec) {
          overlays.splice(i, 1)
          this$1.state.modeGen++
          regChange(this$1)
          return
        }
      }
    }),

    indentLine: methodOp(function(n, dir, aggressive) {
      if (typeof dir != "string" && typeof dir != "number") {
        if (dir == null) { dir = this.options.smartIndent ? "smart" : "prev" }
        else { dir = dir ? "add" : "subtract" }
      }
      if (isLine(this.doc, n)) { indentLine(this, n, dir, aggressive) }
    }),
    indentSelection: methodOp(function(how) {
      var this$1 = this;

      var ranges = this.doc.sel.ranges, end = -1
      for (var i = 0; i < ranges.length; i++) {
        var range = ranges[i]
        if (!range.empty()) {
          var from = range.from(), to = range.to()
          var start = Math.max(end, from.line)
          end = Math.min(this$1.lastLine(), to.line - (to.ch ? 0 : 1)) + 1
          for (var j = start; j < end; ++j)
            { indentLine(this$1, j, how) }
          var newRanges = this$1.doc.sel.ranges
          if (from.ch == 0 && ranges.length == newRanges.length && newRanges[i].from().ch > 0)
            { replaceOneSelection(this$1.doc, i, new Range(from, newRanges[i].to()), sel_dontScroll) }
        } else if (range.head.line > end) {
          indentLine(this$1, range.head.line, how, true)
          end = range.head.line
          if (i == this$1.doc.sel.primIndex) { ensureCursorVisible(this$1) }
        }
      }
    }),

    // Fetch the parser token for a given character. Useful for hacks
    // that want to inspect the mode state (say, for completion).
    getTokenAt: function(pos, precise) {
      return takeToken(this, pos, precise)
    },

    getLineTokens: function(line, precise) {
      return takeToken(this, Pos(line), precise, true)
    },

    getTokenTypeAt: function(pos) {
      pos = clipPos(this.doc, pos)
      var styles = getLineStyles(this, getLine(this.doc, pos.line))
      var before = 0, after = (styles.length - 1) / 2, ch = pos.ch
      var type
      if (ch == 0) { type = styles[2] }
      else { for (;;) {
        var mid = (before + after) >> 1
        if ((mid ? styles[mid * 2 - 1] : 0) >= ch) { after = mid }
        else if (styles[mid * 2 + 1] < ch) { before = mid + 1 }
        else { type = styles[mid * 2 + 2]; break }
      } }
      var cut = type ? type.indexOf("overlay ") : -1
      return cut < 0 ? type : cut == 0 ? null : type.slice(0, cut - 1)
    },

    getModeAt: function(pos) {
      var mode = this.doc.mode
      if (!mode.innerMode) { return mode }
      return CodeMirror.innerMode(mode, this.getTokenAt(pos).state).mode
    },

    getHelper: function(pos, type) {
      return this.getHelpers(pos, type)[0]
    },

    getHelpers: function(pos, type) {
      var this$1 = this;

      var found = []
      if (!helpers.hasOwnProperty(type)) { return found }
      var help = helpers[type], mode = this.getModeAt(pos)
      if (typeof mode[type] == "string") {
        if (help[mode[type]]) { found.push(help[mode[type]]) }
      } else if (mode[type]) {
        for (var i = 0; i < mode[type].length; i++) {
          var val = help[mode[type][i]]
          if (val) { found.push(val) }
        }
      } else if (mode.helperType && help[mode.helperType]) {
        found.push(help[mode.helperType])
      } else if (help[mode.name]) {
        found.push(help[mode.name])
      }
      for (var i$1 = 0; i$1 < help._global.length; i$1++) {
        var cur = help._global[i$1]
        if (cur.pred(mode, this$1) && indexOf(found, cur.val) == -1)
          { found.push(cur.val) }
      }
      return found
    },

    getStateAfter: function(line, precise) {
      var doc = this.doc
      line = clipLine(doc, line == null ? doc.first + doc.size - 1: line)
      return getContextBefore(this, line + 1, precise).state
    },

    cursorCoords: function(start, mode) {
      var pos, range = this.doc.sel.primary()
      if (start == null) { pos = range.head }
      else if (typeof start == "object") { pos = clipPos(this.doc, start) }
      else { pos = start ? range.from() : range.to() }
      return cursorCoords(this, pos, mode || "page")
    },

    charCoords: function(pos, mode) {
      return charCoords(this, clipPos(this.doc, pos), mode || "page")
    },

    coordsChar: function(coords, mode) {
      coords = fromCoordSystem(this, coords, mode || "page")
      return coordsChar(this, coords.left, coords.top)
    },

    lineAtHeight: function(height, mode) {
      height = fromCoordSystem(this, {top: height, left: 0}, mode || "page").top
      return lineAtHeight(this.doc, height + this.display.viewOffset)
    },
    heightAtLine: function(line, mode, includeWidgets) {
      var end = false, lineObj
      if (typeof line == "number") {
        var last = this.doc.first + this.doc.size - 1
        if (line < this.doc.first) { line = this.doc.first }
        else if (line > last) { line = last; end = true }
        lineObj = getLine(this.doc, line)
      } else {
        lineObj = line
      }
      return intoCoordSystem(this, lineObj, {top: 0, left: 0}, mode || "page", includeWidgets || end).top +
        (end ? this.doc.height - heightAtLine(lineObj) : 0)
    },

    defaultTextHeight: function() { return textHeight(this.display) },
    defaultCharWidth: function() { return charWidth(this.display) },

    getViewport: function() { return {from: this.display.viewFrom, to: this.display.viewTo}},

    addWidget: function(pos, node, scroll, vert, horiz) {
      var display = this.display
      pos = cursorCoords(this, clipPos(this.doc, pos))
      var top = pos.bottom, left = pos.left
      node.style.position = "absolute"
      node.setAttribute("cm-ignore-events", "true")
      this.display.input.setUneditable(node)
      display.sizer.appendChild(node)
      if (vert == "over") {
        top = pos.top
      } else if (vert == "above" || vert == "near") {
        var vspace = Math.max(display.wrapper.clientHeight, this.doc.height),
        hspace = Math.max(display.sizer.clientWidth, display.lineSpace.clientWidth)
        // Default to positioning above (if specified and possible); otherwise default to positioning below
        if ((vert == 'above' || pos.bottom + node.offsetHeight > vspace) && pos.top > node.offsetHeight)
          { top = pos.top - node.offsetHeight }
        else if (pos.bottom + node.offsetHeight <= vspace)
          { top = pos.bottom }
        if (left + node.offsetWidth > hspace)
          { left = hspace - node.offsetWidth }
      }
      node.style.top = top + "px"
      node.style.left = node.style.right = ""
      if (horiz == "right") {
        left = display.sizer.clientWidth - node.offsetWidth
        node.style.right = "0px"
      } else {
        if (horiz == "left") { left = 0 }
        else if (horiz == "middle") { left = (display.sizer.clientWidth - node.offsetWidth) / 2 }
        node.style.left = left + "px"
      }
      if (scroll)
        { scrollIntoView(this, {left: left, top: top, right: left + node.offsetWidth, bottom: top + node.offsetHeight}) }
    },

    triggerOnKeyDown: methodOp(onKeyDown),
    triggerOnKeyPress: methodOp(onKeyPress),
    triggerOnKeyUp: onKeyUp,
    triggerOnMouseDown: methodOp(onMouseDown),

    execCommand: function(cmd) {
      if (commands.hasOwnProperty(cmd))
        { return commands[cmd].call(null, this) }
    },

    triggerElectric: methodOp(function(text) { triggerElectric(this, text) }),

    findPosH: function(from, amount, unit, visually) {
      var this$1 = this;

      var dir = 1
      if (amount < 0) { dir = -1; amount = -amount }
      var cur = clipPos(this.doc, from)
      for (var i = 0; i < amount; ++i) {
        cur = findPosH(this$1.doc, cur, dir, unit, visually)
        if (cur.hitSide) { break }
      }
      return cur
    },

    moveH: methodOp(function(dir, unit) {
      var this$1 = this;

      this.extendSelectionsBy(function (range) {
        if (this$1.display.shift || this$1.doc.extend || range.empty())
          { return findPosH(this$1.doc, range.head, dir, unit, this$1.options.rtlMoveVisually) }
        else
          { return dir < 0 ? range.from() : range.to() }
      }, sel_move)
    }),

    deleteH: methodOp(function(dir, unit) {
      var sel = this.doc.sel, doc = this.doc
      if (sel.somethingSelected())
        { doc.replaceSelection("", null, "+delete") }
      else
        { deleteNearSelection(this, function (range) {
          var other = findPosH(doc, range.head, dir, unit, false)
          return dir < 0 ? {from: other, to: range.head} : {from: range.head, to: other}
        }) }
    }),

    findPosV: function(from, amount, unit, goalColumn) {
      var this$1 = this;

      var dir = 1, x = goalColumn
      if (amount < 0) { dir = -1; amount = -amount }
      var cur = clipPos(this.doc, from)
      for (var i = 0; i < amount; ++i) {
        var coords = cursorCoords(this$1, cur, "div")
        if (x == null) { x = coords.left }
        else { coords.left = x }
        cur = findPosV(this$1, coords, dir, unit)
        if (cur.hitSide) { break }
      }
      return cur
    },

    moveV: methodOp(function(dir, unit) {
      var this$1 = this;

      var doc = this.doc, goals = []
      var collapse = !this.display.shift && !doc.extend && doc.sel.somethingSelected()
      doc.extendSelectionsBy(function (range) {
        if (collapse)
          { return dir < 0 ? range.from() : range.to() }
        var headPos = cursorCoords(this$1, range.head, "div")
        if (range.goalColumn != null) { headPos.left = range.goalColumn }
        goals.push(headPos.left)
        var pos = findPosV(this$1, headPos, dir, unit)
        if (unit == "page" && range == doc.sel.primary())
          { addToScrollTop(this$1, charCoords(this$1, pos, "div").top - headPos.top) }
        return pos
      }, sel_move)
      if (goals.length) { for (var i = 0; i < doc.sel.ranges.length; i++)
        { doc.sel.ranges[i].goalColumn = goals[i] } }
    }),

    // Find the word at the given position (as returned by coordsChar).
    findWordAt: function(pos) {
      var doc = this.doc, line = getLine(doc, pos.line).text
      var start = pos.ch, end = pos.ch
      if (line) {
        var helper = this.getHelper(pos, "wordChars")
        if ((pos.sticky == "before" || end == line.length) && start) { --start; } else { ++end }
        var startChar = line.charAt(start)
        var check = isWordChar(startChar, helper)
          ? function (ch) { return isWordChar(ch, helper); }
          : /\s/.test(startChar) ? function (ch) { return /\s/.test(ch); }
          : function (ch) { return (!/\s/.test(ch) && !isWordChar(ch)); }
        while (start > 0 && check(line.charAt(start - 1))) { --start }
        while (end < line.length && check(line.charAt(end))) { ++end }
      }
      return new Range(Pos(pos.line, start), Pos(pos.line, end))
    },

    toggleOverwrite: function(value) {
      if (value != null && value == this.state.overwrite) { return }
      if (this.state.overwrite = !this.state.overwrite)
        { addClass(this.display.cursorDiv, "CodeMirror-overwrite") }
      else
        { rmClass(this.display.cursorDiv, "CodeMirror-overwrite") }

      signal(this, "overwriteToggle", this, this.state.overwrite)
    },
    hasFocus: function() { return this.display.input.getField() == activeElt() },
    isReadOnly: function() { return !!(this.options.readOnly || this.doc.cantEdit) },

    scrollTo: methodOp(function (x, y) { scrollToCoords(this, x, y) }),
    getScrollInfo: function() {
      var scroller = this.display.scroller
      return {left: scroller.scrollLeft, top: scroller.scrollTop,
              height: scroller.scrollHeight - scrollGap(this) - this.display.barHeight,
              width: scroller.scrollWidth - scrollGap(this) - this.display.barWidth,
              clientHeight: displayHeight(this), clientWidth: displayWidth(this)}
    },

    scrollIntoView: methodOp(function(range, margin) {
      if (range == null) {
        range = {from: this.doc.sel.primary().head, to: null}
        if (margin == null) { margin = this.options.cursorScrollMargin }
      } else if (typeof range == "number") {
        range = {from: Pos(range, 0), to: null}
      } else if (range.from == null) {
        range = {from: range, to: null}
      }
      if (!range.to) { range.to = range.from }
      range.margin = margin || 0

      if (range.from.line != null) {
        scrollToRange(this, range)
      } else {
        scrollToCoordsRange(this, range.from, range.to, range.margin)
      }
    }),

    setSize: methodOp(function(width, height) {
      var this$1 = this;

      var interpret = function (val) { return typeof val == "number" || /^\d+$/.test(String(val)) ? val + "px" : val; }
      if (width != null) { this.display.wrapper.style.width = interpret(width) }
      if (height != null) { this.display.wrapper.style.height = interpret(height) }
      if (this.options.lineWrapping) { clearLineMeasurementCache(this) }
      var lineNo = this.display.viewFrom
      this.doc.iter(lineNo, this.display.viewTo, function (line) {
        if (line.widgets) { for (var i = 0; i < line.widgets.length; i++)
          { if (line.widgets[i].noHScroll) { regLineChange(this$1, lineNo, "widget"); break } } }
        ++lineNo
      })
      this.curOp.forceUpdate = true
      signal(this, "refresh", this)
    }),

    operation: function(f){return runInOp(this, f)},
    startOperation: function(){return startOperation(this)},
    endOperation: function(){return endOperation(this)},

    refresh: methodOp(function() {
      var oldHeight = this.display.cachedTextHeight
      regChange(this)
      this.curOp.forceUpdate = true
      clearCaches(this)
      scrollToCoords(this, this.doc.scrollLeft, this.doc.scrollTop)
      updateGutterSpace(this)
      if (oldHeight == null || Math.abs(oldHeight - textHeight(this.display)) > .5)
        { estimateLineHeights(this) }
      signal(this, "refresh", this)
    }),

    swapDoc: methodOp(function(doc) {
      var old = this.doc
      old.cm = null
      attachDoc(this, doc)
      clearCaches(this)
      this.display.input.reset()
      scrollToCoords(this, doc.scrollLeft, doc.scrollTop)
      this.curOp.forceScroll = true
      signalLater(this, "swapDoc", this, old)
      return old
    }),

    getInputField: function(){return this.display.input.getField()},
    getWrapperElement: function(){return this.display.wrapper},
    getScrollerElement: function(){return this.display.scroller},
    getGutterElement: function(){return this.display.gutters}
  }
  eventMixin(CodeMirror)

  CodeMirror.registerHelper = function(type, name, value) {
    if (!helpers.hasOwnProperty(type)) { helpers[type] = CodeMirror[type] = {_global: []} }
    helpers[type][name] = value
  }
  CodeMirror.registerGlobalHelper = function(type, name, predicate, value) {
    CodeMirror.registerHelper(type, name, value)
    helpers[type]._global.push({pred: predicate, val: value})
  }
}

// Used for horizontal relative motion. Dir is -1 or 1 (left or
// right), unit can be "char", "column" (like char, but doesn't
// cross line boundaries), "word" (across next word), or "group" (to
// the start of next group of word or non-word-non-whitespace
// chars). The visually param controls whether, in right-to-left
// text, direction 1 means to move towards the next index in the
// string, or towards the character to the right of the current
// position. The resulting position will have a hitSide=true
// property if it reached the end of the document.
function findPosH(doc, pos, dir, unit, visually) {
  var oldPos = pos
  var origDir = dir
  var lineObj = getLine(doc, pos.line)
  function findNextLine() {
    var l = pos.line + dir
    if (l < doc.first || l >= doc.first + doc.size) { return false }
    pos = new Pos(l, pos.ch, pos.sticky)
    return lineObj = getLine(doc, l)
  }
  function moveOnce(boundToLine) {
    var next
    if (visually) {
      next = moveVisually(doc.cm, lineObj, pos, dir)
    } else {
      next = moveLogically(lineObj, pos, dir)
    }
    if (next == null) {
      if (!boundToLine && findNextLine())
        { pos = endOfLine(visually, doc.cm, lineObj, pos.line, dir) }
      else
        { return false }
    } else {
      pos = next
    }
    return true
  }

  if (unit == "char") {
    moveOnce()
  } else if (unit == "column") {
    moveOnce(true)
  } else if (unit == "word" || unit == "group") {
    var sawType = null, group = unit == "group"
    var helper = doc.cm && doc.cm.getHelper(pos, "wordChars")
    for (var first = true;; first = false) {
      if (dir < 0 && !moveOnce(!first)) { break }
      var cur = lineObj.text.charAt(pos.ch) || "\n"
      var type = isWordChar(cur, helper) ? "w"
        : group && cur == "\n" ? "n"
        : !group || /\s/.test(cur) ? null
        : "p"
      if (group && !first && !type) { type = "s" }
      if (sawType && sawType != type) {
        if (dir < 0) {dir = 1; moveOnce(); pos.sticky = "after"}
        break
      }

      if (type) { sawType = type }
      if (dir > 0 && !moveOnce(!first)) { break }
    }
  }
  var result = skipAtomic(doc, pos, oldPos, origDir, true)
  if (equalCursorPos(oldPos, result)) { result.hitSide = true }
  return result
}

// For relative vertical movement. Dir may be -1 or 1. Unit can be
// "page" or "line". The resulting position will have a hitSide=true
// property if it reached the end of the document.
function findPosV(cm, pos, dir, unit) {
  var doc = cm.doc, x = pos.left, y
  if (unit == "page") {
    var pageSize = Math.min(cm.display.wrapper.clientHeight, window.innerHeight || document.documentElement.clientHeight)
    var moveAmount = Math.max(pageSize - .5 * textHeight(cm.display), 3)
    y = (dir > 0 ? pos.bottom : pos.top) + dir * moveAmount

  } else if (unit == "line") {
    y = dir > 0 ? pos.bottom + 3 : pos.top - 3
  }
  var target
  for (;;) {
    target = coordsChar(cm, x, y)
    if (!target.outside) { break }
    if (dir < 0 ? y <= 0 : y >= doc.height) { target.hitSide = true; break }
    y += dir * 5
  }
  return target
}

// CONTENTEDITABLE INPUT STYLE

var ContentEditableInput = function(cm) {
  this.cm = cm
  this.lastAnchorNode = this.lastAnchorOffset = this.lastFocusNode = this.lastFocusOffset = null
  this.polling = new Delayed()
  this.composing = null
  this.gracePeriod = false
  this.readDOMTimeout = null
};

ContentEditableInput.prototype.init = function (display) {
    var this$1 = this;

  var input = this, cm = input.cm
  var div = input.div = display.lineDiv
  disableBrowserMagic(div, cm.options.spellcheck)

  on(div, "paste", function (e) {
    if (signalDOMEvent(cm, e) || handlePaste(e, cm)) { return }
    // IE doesn't fire input events, so we schedule a read for the pasted content in this way
    if (ie_version <= 11) { setTimeout(operation(cm, function () { return this$1.updateFromDOM(); }), 20) }
  })

  on(div, "compositionstart", function (e) {
    this$1.composing = {data: e.data, done: false}
  })
  on(div, "compositionupdate", function (e) {
    if (!this$1.composing) { this$1.composing = {data: e.data, done: false} }
  })
  on(div, "compositionend", function (e) {
    if (this$1.composing) {
      if (e.data != this$1.composing.data) { this$1.readFromDOMSoon() }
      this$1.composing.done = true
    }
  })

  on(div, "touchstart", function () { return input.forceCompositionEnd(); })

  on(div, "input", function () {
    if (!this$1.composing) { this$1.readFromDOMSoon() }
  })

  function onCopyCut(e) {
    if (signalDOMEvent(cm, e)) { return }
    if (cm.somethingSelected()) {
      setLastCopied({lineWise: false, text: cm.getSelections()})
      if (e.type == "cut") { cm.replaceSelection("", null, "cut") }
    } else if (!cm.options.lineWiseCopyCut) {
      return
    } else {
      var ranges = copyableRanges(cm)
      setLastCopied({lineWise: true, text: ranges.text})
      if (e.type == "cut") {
        cm.operation(function () {
          cm.setSelections(ranges.ranges, 0, sel_dontScroll)
          cm.replaceSelection("", null, "cut")
        })
      }
    }
    if (e.clipboardData) {
      e.clipboardData.clearData()
      var content = lastCopied.text.join("\n")
      // iOS exposes the clipboard API, but seems to discard content inserted into it
      e.clipboardData.setData("Text", content)
      if (e.clipboardData.getData("Text") == content) {
        e.preventDefault()
        return
      }
    }
    // Old-fashioned briefly-focus-a-textarea hack
    var kludge = hiddenTextarea(), te = kludge.firstChild
    cm.display.lineSpace.insertBefore(kludge, cm.display.lineSpace.firstChild)
    te.value = lastCopied.text.join("\n")
    var hadFocus = document.activeElement
    selectInput(te)
    setTimeout(function () {
      cm.display.lineSpace.removeChild(kludge)
      hadFocus.focus()
      if (hadFocus == div) { input.showPrimarySelection() }
    }, 50)
  }
  on(div, "copy", onCopyCut)
  on(div, "cut", onCopyCut)
};

ContentEditableInput.prototype.prepareSelection = function () {
  var result = prepareSelection(this.cm, false)
  result.focus = this.cm.state.focused
  return result
};

ContentEditableInput.prototype.showSelection = function (info, takeFocus) {
  if (!info || !this.cm.display.view.length) { return }
  if (info.focus || takeFocus) { this.showPrimarySelection() }
  this.showMultipleSelections(info)
};

ContentEditableInput.prototype.showPrimarySelection = function () {
  var sel = window.getSelection(), cm = this.cm, prim = cm.doc.sel.primary()
  var from = prim.from(), to = prim.to()

  if (cm.display.viewTo == cm.display.viewFrom || from.line >= cm.display.viewTo || to.line < cm.display.viewFrom) {
    sel.removeAllRanges()
    return
  }

  var curAnchor = domToPos(cm, sel.anchorNode, sel.anchorOffset)
  var curFocus = domToPos(cm, sel.focusNode, sel.focusOffset)
  if (curAnchor && !curAnchor.bad && curFocus && !curFocus.bad &&
      cmp(minPos(curAnchor, curFocus), from) == 0 &&
      cmp(maxPos(curAnchor, curFocus), to) == 0)
    { return }

  var view = cm.display.view
  var start = (from.line >= cm.display.viewFrom && posToDOM(cm, from)) ||
      {node: view[0].measure.map[2], offset: 0}
  var end = to.line < cm.display.viewTo && posToDOM(cm, to)
  if (!end) {
    var measure = view[view.length - 1].measure
    var map = measure.maps ? measure.maps[measure.maps.length - 1] : measure.map
    end = {node: map[map.length - 1], offset: map[map.length - 2] - map[map.length - 3]}
  }

  if (!start || !end) {
    sel.removeAllRanges()
    return
  }

  var old = sel.rangeCount && sel.getRangeAt(0), rng
  try { rng = range(start.node, start.offset, end.offset, end.node) }
  catch(e) {} // Our model of the DOM might be outdated, in which case the range we try to set can be impossible
  if (rng) {
    if (!gecko && cm.state.focused) {
      sel.collapse(start.node, start.offset)
      if (!rng.collapsed) {
        sel.removeAllRanges()
        sel.addRange(rng)
      }
    } else {
      sel.removeAllRanges()
      sel.addRange(rng)
    }
    if (old && sel.anchorNode == null) { sel.addRange(old) }
    else if (gecko) { this.startGracePeriod() }
  }
  this.rememberSelection()
};

ContentEditableInput.prototype.startGracePeriod = function () {
    var this$1 = this;

  clearTimeout(this.gracePeriod)
  this.gracePeriod = setTimeout(function () {
    this$1.gracePeriod = false
    if (this$1.selectionChanged())
      { this$1.cm.operation(function () { return this$1.cm.curOp.selectionChanged = true; }) }
  }, 20)
};

ContentEditableInput.prototype.showMultipleSelections = function (info) {
  removeChildrenAndAdd(this.cm.display.cursorDiv, info.cursors)
  removeChildrenAndAdd(this.cm.display.selectionDiv, info.selection)
};

ContentEditableInput.prototype.rememberSelection = function () {
  var sel = window.getSelection()
  this.lastAnchorNode = sel.anchorNode; this.lastAnchorOffset = sel.anchorOffset
  this.lastFocusNode = sel.focusNode; this.lastFocusOffset = sel.focusOffset
};

ContentEditableInput.prototype.selectionInEditor = function () {
  var sel = window.getSelection()
  if (!sel.rangeCount) { return false }
  var node = sel.getRangeAt(0).commonAncestorContainer
  return contains(this.div, node)
};

ContentEditableInput.prototype.focus = function () {
  if (this.cm.options.readOnly != "nocursor") {
    if (!this.selectionInEditor())
      { this.showSelection(this.prepareSelection(), true) }
    this.div.focus()
  }
};
ContentEditableInput.prototype.blur = function () { this.div.blur() };
ContentEditableInput.prototype.getField = function () { return this.div };

ContentEditableInput.prototype.supportsTouch = function () { return true };

ContentEditableInput.prototype.receivedFocus = function () {
  var input = this
  if (this.selectionInEditor())
    { this.pollSelection() }
  else
    { runInOp(this.cm, function () { return input.cm.curOp.selectionChanged = true; }) }

  function poll() {
    if (input.cm.state.focused) {
      input.pollSelection()
      input.polling.set(input.cm.options.pollInterval, poll)
    }
  }
  this.polling.set(this.cm.options.pollInterval, poll)
};

ContentEditableInput.prototype.selectionChanged = function () {
  var sel = window.getSelection()
  return sel.anchorNode != this.lastAnchorNode || sel.anchorOffset != this.lastAnchorOffset ||
    sel.focusNode != this.lastFocusNode || sel.focusOffset != this.lastFocusOffset
};

ContentEditableInput.prototype.pollSelection = function () {
  if (this.readDOMTimeout != null || this.gracePeriod || !this.selectionChanged()) { return }
  var sel = window.getSelection(), cm = this.cm
  // On Android Chrome (version 56, at least), backspacing into an
  // uneditable block element will put the cursor in that element,
  // and then, because it's not editable, hide the virtual keyboard.
  // Because Android doesn't allow us to actually detect backspace
  // presses in a sane way, this code checks for when that happens
  // and simulates a backspace press in this case.
  if (android && chrome && this.cm.options.gutters.length && isInGutter(sel.anchorNode)) {
    this.cm.triggerOnKeyDown({type: "keydown", keyCode: 8, preventDefault: Math.abs})
    this.blur()
    this.focus()
    return
  }
  if (this.composing) { return }
  this.rememberSelection()
  var anchor = domToPos(cm, sel.anchorNode, sel.anchorOffset)
  var head = domToPos(cm, sel.focusNode, sel.focusOffset)
  if (anchor && head) { runInOp(cm, function () {
    setSelection(cm.doc, simpleSelection(anchor, head), sel_dontScroll)
    if (anchor.bad || head.bad) { cm.curOp.selectionChanged = true }
  }) }
};

ContentEditableInput.prototype.pollContent = function () {
  if (this.readDOMTimeout != null) {
    clearTimeout(this.readDOMTimeout)
    this.readDOMTimeout = null
  }

  var cm = this.cm, display = cm.display, sel = cm.doc.sel.primary()
  var from = sel.from(), to = sel.to()
  if (from.ch == 0 && from.line > cm.firstLine())
    { from = Pos(from.line - 1, getLine(cm.doc, from.line - 1).length) }
  if (to.ch == getLine(cm.doc, to.line).text.length && to.line < cm.lastLine())
    { to = Pos(to.line + 1, 0) }
  if (from.line < display.viewFrom || to.line > display.viewTo - 1) { return false }

  var fromIndex, fromLine, fromNode
  if (from.line == display.viewFrom || (fromIndex = findViewIndex(cm, from.line)) == 0) {
    fromLine = lineNo(display.view[0].line)
    fromNode = display.view[0].node
  } else {
    fromLine = lineNo(display.view[fromIndex].line)
    fromNode = display.view[fromIndex - 1].node.nextSibling
  }
  var toIndex = findViewIndex(cm, to.line)
  var toLine, toNode
  if (toIndex == display.view.length - 1) {
    toLine = display.viewTo - 1
    toNode = display.lineDiv.lastChild
  } else {
    toLine = lineNo(display.view[toIndex + 1].line) - 1
    toNode = display.view[toIndex + 1].node.previousSibling
  }

  if (!fromNode) { return false }
  var newText = cm.doc.splitLines(domTextBetween(cm, fromNode, toNode, fromLine, toLine))
  var oldText = getBetween(cm.doc, Pos(fromLine, 0), Pos(toLine, getLine(cm.doc, toLine).text.length))
  while (newText.length > 1 && oldText.length > 1) {
    if (lst(newText) == lst(oldText)) { newText.pop(); oldText.pop(); toLine-- }
    else if (newText[0] == oldText[0]) { newText.shift(); oldText.shift(); fromLine++ }
    else { break }
  }

  var cutFront = 0, cutEnd = 0
  var newTop = newText[0], oldTop = oldText[0], maxCutFront = Math.min(newTop.length, oldTop.length)
  while (cutFront < maxCutFront && newTop.charCodeAt(cutFront) == oldTop.charCodeAt(cutFront))
    { ++cutFront }
  var newBot = lst(newText), oldBot = lst(oldText)
  var maxCutEnd = Math.min(newBot.length - (newText.length == 1 ? cutFront : 0),
                           oldBot.length - (oldText.length == 1 ? cutFront : 0))
  while (cutEnd < maxCutEnd &&
         newBot.charCodeAt(newBot.length - cutEnd - 1) == oldBot.charCodeAt(oldBot.length - cutEnd - 1))
    { ++cutEnd }
  // Try to move start of change to start of selection if ambiguous
  if (newText.length == 1 && oldText.length == 1 && fromLine == from.line) {
    while (cutFront && cutFront > from.ch &&
           newBot.charCodeAt(newBot.length - cutEnd - 1) == oldBot.charCodeAt(oldBot.length - cutEnd - 1)) {
      cutFront--
      cutEnd++
    }
  }

  newText[newText.length - 1] = newBot.slice(0, newBot.length - cutEnd).replace(/^\u200b+/, "")
  newText[0] = newText[0].slice(cutFront).replace(/\u200b+$/, "")

  var chFrom = Pos(fromLine, cutFront)
  var chTo = Pos(toLine, oldText.length ? lst(oldText).length - cutEnd : 0)
  if (newText.length > 1 || newText[0] || cmp(chFrom, chTo)) {
    replaceRange(cm.doc, newText, chFrom, chTo, "+input")
    return true
  }
};

ContentEditableInput.prototype.ensurePolled = function () {
  this.forceCompositionEnd()
};
ContentEditableInput.prototype.reset = function () {
  this.forceCompositionEnd()
};
ContentEditableInput.prototype.forceCompositionEnd = function () {
  if (!this.composing) { return }
  clearTimeout(this.readDOMTimeout)
  this.composing = null
  this.updateFromDOM()
  this.div.blur()
  this.div.focus()
};
ContentEditableInput.prototype.readFromDOMSoon = function () {
    var this$1 = this;

  if (this.readDOMTimeout != null) { return }
  this.readDOMTimeout = setTimeout(function () {
    this$1.readDOMTimeout = null
    if (this$1.composing) {
      if (this$1.composing.done) { this$1.composing = null }
      else { return }
    }
    this$1.updateFromDOM()
  }, 80)
};

ContentEditableInput.prototype.updateFromDOM = function () {
    var this$1 = this;

  if (this.cm.isReadOnly() || !this.pollContent())
    { runInOp(this.cm, function () { return regChange(this$1.cm); }) }
};

ContentEditableInput.prototype.setUneditable = function (node) {
  node.contentEditable = "false"
};

ContentEditableInput.prototype.onKeyPress = function (e) {
  if (e.charCode == 0) { return }
  e.preventDefault()
  if (!this.cm.isReadOnly())
    { operation(this.cm, applyTextInput)(this.cm, String.fromCharCode(e.charCode == null ? e.keyCode : e.charCode), 0) }
};

ContentEditableInput.prototype.readOnlyChanged = function (val) {
  this.div.contentEditable = String(val != "nocursor")
};

ContentEditableInput.prototype.onContextMenu = function () {};
ContentEditableInput.prototype.resetPosition = function () {};

ContentEditableInput.prototype.needsContentAttribute = true

function posToDOM(cm, pos) {
  var view = findViewForLine(cm, pos.line)
  if (!view || view.hidden) { return null }
  var line = getLine(cm.doc, pos.line)
  var info = mapFromLineView(view, line, pos.line)

  var order = getOrder(line, cm.doc.direction), side = "left"
  if (order) {
    var partPos = getBidiPartAt(order, pos.ch)
    side = partPos % 2 ? "right" : "left"
  }
  var result = nodeAndOffsetInLineMap(info.map, pos.ch, side)
  result.offset = result.collapse == "right" ? result.end : result.start
  return result
}

function isInGutter(node) {
  for (var scan = node; scan; scan = scan.parentNode)
    { if (/CodeMirror-gutter-wrapper/.test(scan.className)) { return true } }
  return false
}

function badPos(pos, bad) { if (bad) { pos.bad = true; } return pos }

function domTextBetween(cm, from, to, fromLine, toLine) {
  var text = "", closing = false, lineSep = cm.doc.lineSeparator()
  function recognizeMarker(id) { return function (marker) { return marker.id == id; } }
  function close() {
    if (closing) {
      text += lineSep
      closing = false
    }
  }
  function addText(str) {
    if (str) {
      close()
      text += str
    }
  }
  function walk(node) {
    if (node.nodeType == 1) {
      var cmText = node.getAttribute("cm-text")
      if (cmText != null) {
        addText(cmText || node.textContent.replace(/\u200b/g, ""))
        return
      }
      var markerID = node.getAttribute("cm-marker"), range
      if (markerID) {
        var found = cm.findMarks(Pos(fromLine, 0), Pos(toLine + 1, 0), recognizeMarker(+markerID))
        if (found.length && (range = found[0].find(0)))
          { addText(getBetween(cm.doc, range.from, range.to).join(lineSep)) }
        return
      }
      if (node.getAttribute("contenteditable") == "false") { return }
      var isBlock = /^(pre|div|p)$/i.test(node.nodeName)
      if (isBlock) { close() }
      for (var i = 0; i < node.childNodes.length; i++)
        { walk(node.childNodes[i]) }
      if (isBlock) { closing = true }
    } else if (node.nodeType == 3) {
      addText(node.nodeValue)
    }
  }
  for (;;) {
    walk(from)
    if (from == to) { break }
    from = from.nextSibling
  }
  return text
}

function domToPos(cm, node, offset) {
  var lineNode
  if (node == cm.display.lineDiv) {
    lineNode = cm.display.lineDiv.childNodes[offset]
    if (!lineNode) { return badPos(cm.clipPos(Pos(cm.display.viewTo - 1)), true) }
    node = null; offset = 0
  } else {
    for (lineNode = node;; lineNode = lineNode.parentNode) {
      if (!lineNode || lineNode == cm.display.lineDiv) { return null }
      if (lineNode.parentNode && lineNode.parentNode == cm.display.lineDiv) { break }
    }
  }
  for (var i = 0; i < cm.display.view.length; i++) {
    var lineView = cm.display.view[i]
    if (lineView.node == lineNode)
      { return locateNodeInLineView(lineView, node, offset) }
  }
}

function locateNodeInLineView(lineView, node, offset) {
  var wrapper = lineView.text.firstChild, bad = false
  if (!node || !contains(wrapper, node)) { return badPos(Pos(lineNo(lineView.line), 0), true) }
  if (node == wrapper) {
    bad = true
    node = wrapper.childNodes[offset]
    offset = 0
    if (!node) {
      var line = lineView.rest ? lst(lineView.rest) : lineView.line
      return badPos(Pos(lineNo(line), line.text.length), bad)
    }
  }

  var textNode = node.nodeType == 3 ? node : null, topNode = node
  if (!textNode && node.childNodes.length == 1 && node.firstChild.nodeType == 3) {
    textNode = node.firstChild
    if (offset) { offset = textNode.nodeValue.length }
  }
  while (topNode.parentNode != wrapper) { topNode = topNode.parentNode }
  var measure = lineView.measure, maps = measure.maps

  function find(textNode, topNode, offset) {
    for (var i = -1; i < (maps ? maps.length : 0); i++) {
      var map = i < 0 ? measure.map : maps[i]
      for (var j = 0; j < map.length; j += 3) {
        var curNode = map[j + 2]
        if (curNode == textNode || curNode == topNode) {
          var line = lineNo(i < 0 ? lineView.line : lineView.rest[i])
          var ch = map[j] + offset
          if (offset < 0 || curNode != textNode) { ch = map[j + (offset ? 1 : 0)] }
          return Pos(line, ch)
        }
      }
    }
  }
  var found = find(textNode, topNode, offset)
  if (found) { return badPos(found, bad) }

  // FIXME this is all really shaky. might handle the few cases it needs to handle, but likely to cause problems
  for (var after = topNode.nextSibling, dist = textNode ? textNode.nodeValue.length - offset : 0; after; after = after.nextSibling) {
    found = find(after, after.firstChild, 0)
    if (found)
      { return badPos(Pos(found.line, found.ch - dist), bad) }
    else
      { dist += after.textContent.length }
  }
  for (var before = topNode.previousSibling, dist$1 = offset; before; before = before.previousSibling) {
    found = find(before, before.firstChild, -1)
    if (found)
      { return badPos(Pos(found.line, found.ch + dist$1), bad) }
    else
      { dist$1 += before.textContent.length }
  }
}

// TEXTAREA INPUT STYLE

var TextareaInput = function(cm) {
  this.cm = cm
  // See input.poll and input.reset
  this.prevInput = ""

  // Flag that indicates whether we expect input to appear real soon
  // now (after some event like 'keypress' or 'input') and are
  // polling intensively.
  this.pollingFast = false
  // Self-resetting timeout for the poller
  this.polling = new Delayed()
  // Used to work around IE issue with selection being forgotten when focus moves away from textarea
  this.hasSelection = false
  this.composing = null
};

TextareaInput.prototype.init = function (display) {
    var this$1 = this;

  var input = this, cm = this.cm

  // Wraps and hides input textarea
  var div = this.wrapper = hiddenTextarea()
  // The semihidden textarea that is focused when the editor is
  // focused, and receives input.
  var te = this.textarea = div.firstChild
  display.wrapper.insertBefore(div, display.wrapper.firstChild)

  // Needed to hide big blue blinking cursor on Mobile Safari (doesn't seem to work in iOS 8 anymore)
  if (ios) { te.style.width = "0px" }

  on(te, "input", function () {
    if (ie && ie_version >= 9 && this$1.hasSelection) { this$1.hasSelection = null }
    input.poll()
  })

  on(te, "paste", function (e) {
    if (signalDOMEvent(cm, e) || handlePaste(e, cm)) { return }

    cm.state.pasteIncoming = true
    input.fastPoll()
  })

  function prepareCopyCut(e) {
    if (signalDOMEvent(cm, e)) { return }
    if (cm.somethingSelected()) {
      setLastCopied({lineWise: false, text: cm.getSelections()})
    } else if (!cm.options.lineWiseCopyCut) {
      return
    } else {
      var ranges = copyableRanges(cm)
      setLastCopied({lineWise: true, text: ranges.text})
      if (e.type == "cut") {
        cm.setSelections(ranges.ranges, null, sel_dontScroll)
      } else {
        input.prevInput = ""
        te.value = ranges.text.join("\n")
        selectInput(te)
      }
    }
    if (e.type == "cut") { cm.state.cutIncoming = true }
  }
  on(te, "cut", prepareCopyCut)
  on(te, "copy", prepareCopyCut)

  on(display.scroller, "paste", function (e) {
    if (eventInWidget(display, e) || signalDOMEvent(cm, e)) { return }
    cm.state.pasteIncoming = true
    input.focus()
  })

  // Prevent normal selection in the editor (we handle our own)
  on(display.lineSpace, "selectstart", function (e) {
    if (!eventInWidget(display, e)) { e_preventDefault(e) }
  })

  on(te, "compositionstart", function () {
    var start = cm.getCursor("from")
    if (input.composing) { input.composing.range.clear() }
    input.composing = {
      start: start,
      range: cm.markText(start, cm.getCursor("to"), {className: "CodeMirror-composing"})
    }
  })
  on(te, "compositionend", function () {
    if (input.composing) {
      input.poll()
      input.composing.range.clear()
      input.composing = null
    }
  })
};

TextareaInput.prototype.prepareSelection = function () {
  // Redraw the selection and/or cursor
  var cm = this.cm, display = cm.display, doc = cm.doc
  var result = prepareSelection(cm)

  // Move the hidden textarea near the cursor to prevent scrolling artifacts
  if (cm.options.moveInputWithCursor) {
    var headPos = cursorCoords(cm, doc.sel.primary().head, "div")
    var wrapOff = display.wrapper.getBoundingClientRect(), lineOff = display.lineDiv.getBoundingClientRect()
    result.teTop = Math.max(0, Math.min(display.wrapper.clientHeight - 10,
                                        headPos.top + lineOff.top - wrapOff.top))
    result.teLeft = Math.max(0, Math.min(display.wrapper.clientWidth - 10,
                                         headPos.left + lineOff.left - wrapOff.left))
  }

  return result
};

TextareaInput.prototype.showSelection = function (drawn) {
  var cm = this.cm, display = cm.display
  removeChildrenAndAdd(display.cursorDiv, drawn.cursors)
  removeChildrenAndAdd(display.selectionDiv, drawn.selection)
  if (drawn.teTop != null) {
    this.wrapper.style.top = drawn.teTop + "px"
    this.wrapper.style.left = drawn.teLeft + "px"
  }
};

// Reset the input to correspond to the selection (or to be empty,
// when not typing and nothing is selected)
TextareaInput.prototype.reset = function (typing) {
  if (this.contextMenuPending || this.composing) { return }
  var cm = this.cm
  if (cm.somethingSelected()) {
    this.prevInput = ""
    var content = cm.getSelection()
    this.textarea.value = content
    if (cm.state.focused) { selectInput(this.textarea) }
    if (ie && ie_version >= 9) { this.hasSelection = content }
  } else if (!typing) {
    this.prevInput = this.textarea.value = ""
    if (ie && ie_version >= 9) { this.hasSelection = null }
  }
};

TextareaInput.prototype.getField = function () { return this.textarea };

TextareaInput.prototype.supportsTouch = function () { return false };

TextareaInput.prototype.focus = function () {
  if (this.cm.options.readOnly != "nocursor" && (!mobile || activeElt() != this.textarea)) {
    try { this.textarea.focus() }
    catch (e) {} // IE8 will throw if the textarea is display: none or not in DOM
  }
};

TextareaInput.prototype.blur = function () { this.textarea.blur() };

TextareaInput.prototype.resetPosition = function () {
  this.wrapper.style.top = this.wrapper.style.left = 0
};

TextareaInput.prototype.receivedFocus = function () { this.slowPoll() };

// Poll for input changes, using the normal rate of polling. This
// runs as long as the editor is focused.
TextareaInput.prototype.slowPoll = function () {
    var this$1 = this;

  if (this.pollingFast) { return }
  this.polling.set(this.cm.options.pollInterval, function () {
    this$1.poll()
    if (this$1.cm.state.focused) { this$1.slowPoll() }
  })
};

// When an event has just come in that is likely to add or change
// something in the input textarea, we poll faster, to ensure that
// the change appears on the screen quickly.
TextareaInput.prototype.fastPoll = function () {
  var missed = false, input = this
  input.pollingFast = true
  function p() {
    var changed = input.poll()
    if (!changed && !missed) {missed = true; input.polling.set(60, p)}
    else {input.pollingFast = false; input.slowPoll()}
  }
  input.polling.set(20, p)
};

// Read input from the textarea, and update the document to match.
// When something is selected, it is present in the textarea, and
// selected (unless it is huge, in which case a placeholder is
// used). When nothing is selected, the cursor sits after previously
// seen text (can be empty), which is stored in prevInput (we must
// not reset the textarea when typing, because that breaks IME).
TextareaInput.prototype.poll = function () {
    var this$1 = this;

  var cm = this.cm, input = this.textarea, prevInput = this.prevInput
  // Since this is called a *lot*, try to bail out as cheaply as
  // possible when it is clear that nothing happened. hasSelection
  // will be the case when there is a lot of text in the textarea,
  // in which case reading its value would be expensive.
  if (this.contextMenuPending || !cm.state.focused ||
      (hasSelection(input) && !prevInput && !this.composing) ||
      cm.isReadOnly() || cm.options.disableInput || cm.state.keySeq)
    { return false }

  var text = input.value
  // If nothing changed, bail.
  if (text == prevInput && !cm.somethingSelected()) { return false }
  // Work around nonsensical selection resetting in IE9/10, and
  // inexplicable appearance of private area unicode characters on
  // some key combos in Mac (#2689).
  if (ie && ie_version >= 9 && this.hasSelection === text ||
      mac && /[\uf700-\uf7ff]/.test(text)) {
    cm.display.input.reset()
    return false
  }

  if (cm.doc.sel == cm.display.selForContextMenu) {
    var first = text.charCodeAt(0)
    if (first == 0x200b && !prevInput) { prevInput = "\u200b" }
    if (first == 0x21da) { this.reset(); return this.cm.execCommand("undo") }
  }
  // Find the part of the input that is actually new
  var same = 0, l = Math.min(prevInput.length, text.length)
  while (same < l && prevInput.charCodeAt(same) == text.charCodeAt(same)) { ++same }

  runInOp(cm, function () {
    applyTextInput(cm, text.slice(same), prevInput.length - same,
                   null, this$1.composing ? "*compose" : null)

    // Don't leave long text in the textarea, since it makes further polling slow
    if (text.length > 1000 || text.indexOf("\n") > -1) { input.value = this$1.prevInput = "" }
    else { this$1.prevInput = text }

    if (this$1.composing) {
      this$1.composing.range.clear()
      this$1.composing.range = cm.markText(this$1.composing.start, cm.getCursor("to"),
                                         {className: "CodeMirror-composing"})
    }
  })
  return true
};

TextareaInput.prototype.ensurePolled = function () {
  if (this.pollingFast && this.poll()) { this.pollingFast = false }
};

TextareaInput.prototype.onKeyPress = function () {
  if (ie && ie_version >= 9) { this.hasSelection = null }
  this.fastPoll()
};

TextareaInput.prototype.onContextMenu = function (e) {
  var input = this, cm = input.cm, display = cm.display, te = input.textarea
  var pos = posFromMouse(cm, e), scrollPos = display.scroller.scrollTop
  if (!pos || presto) { return } // Opera is difficult.

  // Reset the current text selection only if the click is done outside of the selection
  // and 'resetSelectionOnContextMenu' option is true.
  var reset = cm.options.resetSelectionOnContextMenu
  if (reset && cm.doc.sel.contains(pos) == -1)
    { operation(cm, setSelection)(cm.doc, simpleSelection(pos), sel_dontScroll) }

  var oldCSS = te.style.cssText, oldWrapperCSS = input.wrapper.style.cssText
  input.wrapper.style.cssText = "position: absolute"
  var wrapperBox = input.wrapper.getBoundingClientRect()
  te.style.cssText = "position: absolute; width: 30px; height: 30px;\n      top: " + (e.clientY - wrapperBox.top - 5) + "px; left: " + (e.clientX - wrapperBox.left - 5) + "px;\n      z-index: 1000; background: " + (ie ? "rgba(255, 255, 255, .05)" : "transparent") + ";\n      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);"
  var oldScrollY
  if (webkit) { oldScrollY = window.scrollY } // Work around Chrome issue (#2712)
  display.input.focus()
  if (webkit) { window.scrollTo(null, oldScrollY) }
  display.input.reset()
  // Adds "Select all" to context menu in FF
  if (!cm.somethingSelected()) { te.value = input.prevInput = " " }
  input.contextMenuPending = true
  display.selForContextMenu = cm.doc.sel
  clearTimeout(display.detectingSelectAll)

  // Select-all will be greyed out if there's nothing to select, so
  // this adds a zero-width space so that we can later check whether
  // it got selected.
  function prepareSelectAllHack() {
    if (te.selectionStart != null) {
      var selected = cm.somethingSelected()
      var extval = "\u200b" + (selected ? te.value : "")
      te.value = "\u21da" // Used to catch context-menu undo
      te.value = extval
      input.prevInput = selected ? "" : "\u200b"
      te.selectionStart = 1; te.selectionEnd = extval.length
      // Re-set this, in case some other handler touched the
      // selection in the meantime.
      display.selForContextMenu = cm.doc.sel
    }
  }
  function rehide() {
    input.contextMenuPending = false
    input.wrapper.style.cssText = oldWrapperCSS
    te.style.cssText = oldCSS
    if (ie && ie_version < 9) { display.scrollbars.setScrollTop(display.scroller.scrollTop = scrollPos) }

    // Try to detect the user choosing select-all
    if (te.selectionStart != null) {
      if (!ie || (ie && ie_version < 9)) { prepareSelectAllHack() }
      var i = 0, poll = function () {
        if (display.selForContextMenu == cm.doc.sel && te.selectionStart == 0 &&
            te.selectionEnd > 0 && input.prevInput == "\u200b") {
          operation(cm, selectAll)(cm)
        } else if (i++ < 10) {
          display.detectingSelectAll = setTimeout(poll, 500)
        } else {
          display.selForContextMenu = null
          display.input.reset()
        }
      }
      display.detectingSelectAll = setTimeout(poll, 200)
    }
  }

  if (ie && ie_version >= 9) { prepareSelectAllHack() }
  if (captureRightClick) {
    e_stop(e)
    var mouseup = function () {
      off(window, "mouseup", mouseup)
      setTimeout(rehide, 20)
    }
    on(window, "mouseup", mouseup)
  } else {
    setTimeout(rehide, 50)
  }
};

TextareaInput.prototype.readOnlyChanged = function (val) {
  if (!val) { this.reset() }
  this.textarea.disabled = val == "nocursor"
};

TextareaInput.prototype.setUneditable = function () {};

TextareaInput.prototype.needsContentAttribute = false

function fromTextArea(textarea, options) {
  options = options ? copyObj(options) : {}
  options.value = textarea.value
  if (!options.tabindex && textarea.tabIndex)
    { options.tabindex = textarea.tabIndex }
  if (!options.placeholder && textarea.placeholder)
    { options.placeholder = textarea.placeholder }
  // Set autofocus to true if this textarea is focused, or if it has
  // autofocus and no other element is focused.
  if (options.autofocus == null) {
    var hasFocus = activeElt()
    options.autofocus = hasFocus == textarea ||
      textarea.getAttribute("autofocus") != null && hasFocus == document.body
  }

  function save() {textarea.value = cm.getValue()}

  var realSubmit
  if (textarea.form) {
    on(textarea.form, "submit", save)
    // Deplorable hack to make the submit method do the right thing.
    if (!options.leaveSubmitMethodAlone) {
      var form = textarea.form
      realSubmit = form.submit
      try {
        var wrappedSubmit = form.submit = function () {
          save()
          form.submit = realSubmit
          form.submit()
          form.submit = wrappedSubmit
        }
      } catch(e) {}
    }
  }

  options.finishInit = function (cm) {
    cm.save = save
    cm.getTextArea = function () { return textarea; }
    cm.toTextArea = function () {
      cm.toTextArea = isNaN // Prevent this from being ran twice
      save()
      textarea.parentNode.removeChild(cm.getWrapperElement())
      textarea.style.display = ""
      if (textarea.form) {
        off(textarea.form, "submit", save)
        if (typeof textarea.form.submit == "function")
          { textarea.form.submit = realSubmit }
      }
    }
  }

  textarea.style.display = "none"
  var cm = CodeMirror(function (node) { return textarea.parentNode.insertBefore(node, textarea.nextSibling); },
    options)
  return cm
}

function addLegacyProps(CodeMirror) {
  CodeMirror.off = off
  CodeMirror.on = on
  CodeMirror.wheelEventPixels = wheelEventPixels
  CodeMirror.Doc = Doc
  CodeMirror.splitLines = splitLinesAuto
  CodeMirror.countColumn = countColumn
  CodeMirror.findColumn = findColumn
  CodeMirror.isWordChar = isWordCharBasic
  CodeMirror.Pass = Pass
  CodeMirror.signal = signal
  CodeMirror.Line = Line
  CodeMirror.changeEnd = changeEnd
  CodeMirror.scrollbarModel = scrollbarModel
  CodeMirror.Pos = Pos
  CodeMirror.cmpPos = cmp
  CodeMirror.modes = modes
  CodeMirror.mimeModes = mimeModes
  CodeMirror.resolveMode = resolveMode
  CodeMirror.getMode = getMode
  CodeMirror.modeExtensions = modeExtensions
  CodeMirror.extendMode = extendMode
  CodeMirror.copyState = copyState
  CodeMirror.startState = startState
  CodeMirror.innerMode = innerMode
  CodeMirror.commands = commands
  CodeMirror.keyMap = keyMap
  CodeMirror.keyName = keyName
  CodeMirror.isModifierKey = isModifierKey
  CodeMirror.lookupKey = lookupKey
  CodeMirror.normalizeKeyMap = normalizeKeyMap
  CodeMirror.StringStream = StringStream
  CodeMirror.SharedTextMarker = SharedTextMarker
  CodeMirror.TextMarker = TextMarker
  CodeMirror.LineWidget = LineWidget
  CodeMirror.e_preventDefault = e_preventDefault
  CodeMirror.e_stopPropagation = e_stopPropagation
  CodeMirror.e_stop = e_stop
  CodeMirror.addClass = addClass
  CodeMirror.contains = contains
  CodeMirror.rmClass = rmClass
  CodeMirror.keyNames = keyNames
}

// EDITOR CONSTRUCTOR

defineOptions(CodeMirror)

addEditorMethods(CodeMirror)

// Set up methods on CodeMirror's prototype to redirect to the editor's document.
var dontDelegate = "iter insert remove copy getEditor constructor".split(" ")
for (var prop in Doc.prototype) { if (Doc.prototype.hasOwnProperty(prop) && indexOf(dontDelegate, prop) < 0)
  { CodeMirror.prototype[prop] = (function(method) {
    return function() {return method.apply(this.doc, arguments)}
  })(Doc.prototype[prop]) } }

eventMixin(Doc)

// INPUT HANDLING

CodeMirror.inputStyles = {"textarea": TextareaInput, "contenteditable": ContentEditableInput}

// MODE DEFINITION AND QUERYING

// Extra arguments are stored as the mode's dependencies, which is
// used by (legacy) mechanisms like loadmode.js to automatically
// load a mode. (Preferred mechanism is the require/define calls.)
CodeMirror.defineMode = function(name/*, mode, …*/) {
  if (!CodeMirror.defaults.mode && name != "null") { CodeMirror.defaults.mode = name }
  defineMode.apply(this, arguments)
}

CodeMirror.defineMIME = defineMIME

// Minimal default mode.
CodeMirror.defineMode("null", function () { return ({token: function (stream) { return stream.skipToEnd(); }}); })
CodeMirror.defineMIME("text/plain", "null")

// EXTENSIONS

CodeMirror.defineExtension = function (name, func) {
  CodeMirror.prototype[name] = func
}
CodeMirror.defineDocExtension = function (name, func) {
  Doc.prototype[name] = func
}

CodeMirror.fromTextArea = fromTextArea

addLegacyProps(CodeMirror)

CodeMirror.version = "5.34.0"

return CodeMirror;

})));

if (window) window.__currentScriptPath = "/framework/common/codemirror/mode/css/css.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
"use strict";

CodeMirror.defineMode("css", function(config, parserConfig) {
  var inline = parserConfig.inline
  if (!parserConfig.propertyKeywords) parserConfig = CodeMirror.resolveMode("text/css");

  var indentUnit = config.indentUnit,
      tokenHooks = parserConfig.tokenHooks,
      documentTypes = parserConfig.documentTypes || {},
      mediaTypes = parserConfig.mediaTypes || {},
      mediaFeatures = parserConfig.mediaFeatures || {},
      mediaValueKeywords = parserConfig.mediaValueKeywords || {},
      propertyKeywords = parserConfig.propertyKeywords || {},
      nonStandardPropertyKeywords = parserConfig.nonStandardPropertyKeywords || {},
      fontProperties = parserConfig.fontProperties || {},
      counterDescriptors = parserConfig.counterDescriptors || {},
      colorKeywords = parserConfig.colorKeywords || {},
      valueKeywords = parserConfig.valueKeywords || {},
      allowNested = parserConfig.allowNested,
      lineComment = parserConfig.lineComment,
      supportsAtComponent = parserConfig.supportsAtComponent === true;

  var type, override;
  function ret(style, tp) { type = tp; return style; }

  // Tokenizers

  function tokenBase(stream, state) {
    var ch = stream.next();
    if (tokenHooks[ch]) {
      var result = tokenHooks[ch](stream, state);
      if (result !== false) return result;
    }
    if (ch == "@") {
      stream.eatWhile(/[\w\\\-]/);
      return ret("def", stream.current());
    } else if (ch == "=" || (ch == "~" || ch == "|") && stream.eat("=")) {
      return ret(null, "compare");
    } else if (ch == "\"" || ch == "'") {
      state.tokenize = tokenString(ch);
      return state.tokenize(stream, state);
    } else if (ch == "#") {
      stream.eatWhile(/[\w\\\-]/);
      return ret("atom", "hash");
    } else if (ch == "!") {
      stream.match(/^\s*\w*/);
      return ret("keyword", "important");
    } else if (/\d/.test(ch) || ch == "." && stream.eat(/\d/)) {
      stream.eatWhile(/[\w.%]/);
      return ret("number", "unit");
    } else if (ch === "-") {
      if (/[\d.]/.test(stream.peek())) {
        stream.eatWhile(/[\w.%]/);
        return ret("number", "unit");
      } else if (stream.match(/^-[\w\\\-]+/)) {
        stream.eatWhile(/[\w\\\-]/);
        if (stream.match(/^\s*:/, false))
          return ret("variable-2", "variable-definition");
        return ret("variable-2", "variable");
      } else if (stream.match(/^\w+-/)) {
        return ret("meta", "meta");
      }
    } else if (/[,+>*\/]/.test(ch)) {
      return ret(null, "select-op");
    } else if (ch == "." && stream.match(/^-?[_a-z][_a-z0-9-]*/i)) {
      return ret("qualifier", "qualifier");
    } else if (/[:;{}\[\]\(\)]/.test(ch)) {
      return ret(null, ch);
    } else if (((ch == "u" || ch == "U") && stream.match(/rl(-prefix)?\(/i)) ||
               ((ch == "d" || ch == "D") && stream.match("omain(", true, true)) ||
               ((ch == "r" || ch == "R") && stream.match("egexp(", true, true))) {
      stream.backUp(1);
      state.tokenize = tokenParenthesized;
      return ret("property", "word");
    } else if (/[\w\\\-]/.test(ch)) {
      stream.eatWhile(/[\w\\\-]/);
      return ret("property", "word");
    } else {
      return ret(null, null);
    }
  }

  function tokenString(quote) {
    return function(stream, state) {
      var escaped = false, ch;
      while ((ch = stream.next()) != null) {
        if (ch == quote && !escaped) {
          if (quote == ")") stream.backUp(1);
          break;
        }
        escaped = !escaped && ch == "\\";
      }
      if (ch == quote || !escaped && quote != ")") state.tokenize = null;
      return ret("string", "string");
    };
  }

  function tokenParenthesized(stream, state) {
    stream.next(); // Must be '('
    if (!stream.match(/\s*[\"\')]/, false))
      state.tokenize = tokenString(")");
    else
      state.tokenize = null;
    return ret(null, "(");
  }

  // Context management

  function Context(type, indent, prev) {
    this.type = type;
    this.indent = indent;
    this.prev = prev;
  }

  function pushContext(state, stream, type, indent) {
    state.context = new Context(type, stream.indentation() + (indent === false ? 0 : indentUnit), state.context);
    return type;
  }

  function popContext(state) {
    if (state.context.prev)
      state.context = state.context.prev;
    return state.context.type;
  }

  function pass(type, stream, state) {
    return states[state.context.type](type, stream, state);
  }
  function popAndPass(type, stream, state, n) {
    for (var i = n || 1; i > 0; i--)
      state.context = state.context.prev;
    return pass(type, stream, state);
  }

  // Parser

  function wordAsValue(stream) {
    var word = stream.current().toLowerCase();
    if (valueKeywords.hasOwnProperty(word))
      override = "atom";
    else if (colorKeywords.hasOwnProperty(word))
      override = "keyword";
    else
      override = "variable";
  }

  var states = {};

  states.top = function(type, stream, state) {
    if (type == "{") {
      return pushContext(state, stream, "block");
    } else if (type == "}" && state.context.prev) {
      return popContext(state);
    } else if (supportsAtComponent && /@component/i.test(type)) {
      return pushContext(state, stream, "atComponentBlock");
    } else if (/^@(-moz-)?document$/i.test(type)) {
      return pushContext(state, stream, "documentTypes");
    } else if (/^@(media|supports|(-moz-)?document|import)$/i.test(type)) {
      return pushContext(state, stream, "atBlock");
    } else if (/^@(font-face|counter-style)/i.test(type)) {
      state.stateArg = type;
      return "restricted_atBlock_before";
    } else if (/^@(-(moz|ms|o|webkit)-)?keyframes$/i.test(type)) {
      return "keyframes";
    } else if (type && type.charAt(0) == "@") {
      return pushContext(state, stream, "at");
    } else if (type == "hash") {
      override = "builtin";
    } else if (type == "word") {
      override = "tag";
    } else if (type == "variable-definition") {
      return "maybeprop";
    } else if (type == "interpolation") {
      return pushContext(state, stream, "interpolation");
    } else if (type == ":") {
      return "pseudo";
    } else if (allowNested && type == "(") {
      return pushContext(state, stream, "parens");
    }
    return state.context.type;
  };

  states.block = function(type, stream, state) {
    if (type == "word") {
      var word = stream.current().toLowerCase();
      if (propertyKeywords.hasOwnProperty(word)) {
        override = "property";
        return "maybeprop";
      } else if (nonStandardPropertyKeywords.hasOwnProperty(word)) {
        override = "string-2";
        return "maybeprop";
      } else if (allowNested) {
        override = stream.match(/^\s*:(?:\s|$)/, false) ? "property" : "tag";
        return "block";
      } else {
        override += " error";
        return "maybeprop";
      }
    } else if (type == "meta") {
      return "block";
    } else if (!allowNested && (type == "hash" || type == "qualifier")) {
      override = "error";
      return "block";
    } else {
      return states.top(type, stream, state);
    }
  };

  states.maybeprop = function(type, stream, state) {
    if (type == ":") return pushContext(state, stream, "prop");
    return pass(type, stream, state);
  };

  states.prop = function(type, stream, state) {
    if (type == ";") return popContext(state);
    if (type == "{" && allowNested) return pushContext(state, stream, "propBlock");
    if (type == "}" || type == "{") return popAndPass(type, stream, state);
    if (type == "(") return pushContext(state, stream, "parens");

    if (type == "hash" && !/^#([0-9a-fA-f]{3,4}|[0-9a-fA-f]{6}|[0-9a-fA-f]{8})$/.test(stream.current())) {
      override += " error";
    } else if (type == "word") {
      wordAsValue(stream);
    } else if (type == "interpolation") {
      return pushContext(state, stream, "interpolation");
    }
    return "prop";
  };

  states.propBlock = function(type, _stream, state) {
    if (type == "}") return popContext(state);
    if (type == "word") { override = "property"; return "maybeprop"; }
    return state.context.type;
  };

  states.parens = function(type, stream, state) {
    if (type == "{" || type == "}") return popAndPass(type, stream, state);
    if (type == ")") return popContext(state);
    if (type == "(") return pushContext(state, stream, "parens");
    if (type == "interpolation") return pushContext(state, stream, "interpolation");
    if (type == "word") wordAsValue(stream);
    return "parens";
  };

  states.pseudo = function(type, stream, state) {
    if (type == "meta") return "pseudo";

    if (type == "word") {
      override = "variable-3";
      return state.context.type;
    }
    return pass(type, stream, state);
  };

  states.documentTypes = function(type, stream, state) {
    if (type == "word" && documentTypes.hasOwnProperty(stream.current())) {
      override = "tag";
      return state.context.type;
    } else {
      return states.atBlock(type, stream, state);
    }
  };

  states.atBlock = function(type, stream, state) {
    if (type == "(") return pushContext(state, stream, "atBlock_parens");
    if (type == "}" || type == ";") return popAndPass(type, stream, state);
    if (type == "{") return popContext(state) && pushContext(state, stream, allowNested ? "block" : "top");

    if (type == "interpolation") return pushContext(state, stream, "interpolation");

    if (type == "word") {
      var word = stream.current().toLowerCase();
      if (word == "only" || word == "not" || word == "and" || word == "or")
        override = "keyword";
      else if (mediaTypes.hasOwnProperty(word))
        override = "attribute";
      else if (mediaFeatures.hasOwnProperty(word))
        override = "property";
      else if (mediaValueKeywords.hasOwnProperty(word))
        override = "keyword";
      else if (propertyKeywords.hasOwnProperty(word))
        override = "property";
      else if (nonStandardPropertyKeywords.hasOwnProperty(word))
        override = "string-2";
      else if (valueKeywords.hasOwnProperty(word))
        override = "atom";
      else if (colorKeywords.hasOwnProperty(word))
        override = "keyword";
      else
        override = "error";
    }
    return state.context.type;
  };

  states.atComponentBlock = function(type, stream, state) {
    if (type == "}")
      return popAndPass(type, stream, state);
    if (type == "{")
      return popContext(state) && pushContext(state, stream, allowNested ? "block" : "top", false);
    if (type == "word")
      override = "error";
    return state.context.type;
  };

  states.atBlock_parens = function(type, stream, state) {
    if (type == ")") return popContext(state);
    if (type == "{" || type == "}") return popAndPass(type, stream, state, 2);
    return states.atBlock(type, stream, state);
  };

  states.restricted_atBlock_before = function(type, stream, state) {
    if (type == "{")
      return pushContext(state, stream, "restricted_atBlock");
    if (type == "word" && state.stateArg == "@counter-style") {
      override = "variable";
      return "restricted_atBlock_before";
    }
    return pass(type, stream, state);
  };

  states.restricted_atBlock = function(type, stream, state) {
    if (type == "}") {
      state.stateArg = null;
      return popContext(state);
    }
    if (type == "word") {
      if ((state.stateArg == "@font-face" && !fontProperties.hasOwnProperty(stream.current().toLowerCase())) ||
          (state.stateArg == "@counter-style" && !counterDescriptors.hasOwnProperty(stream.current().toLowerCase())))
        override = "error";
      else
        override = "property";
      return "maybeprop";
    }
    return "restricted_atBlock";
  };

  states.keyframes = function(type, stream, state) {
    if (type == "word") { override = "variable"; return "keyframes"; }
    if (type == "{") return pushContext(state, stream, "top");
    return pass(type, stream, state);
  };

  states.at = function(type, stream, state) {
    if (type == ";") return popContext(state);
    if (type == "{" || type == "}") return popAndPass(type, stream, state);
    if (type == "word") override = "tag";
    else if (type == "hash") override = "builtin";
    return "at";
  };

  states.interpolation = function(type, stream, state) {
    if (type == "}") return popContext(state);
    if (type == "{" || type == ";") return popAndPass(type, stream, state);
    if (type == "word") override = "variable";
    else if (type != "variable" && type != "(" && type != ")") override = "error";
    return "interpolation";
  };

  return {
    startState: function(base) {
      return {tokenize: null,
              state: inline ? "block" : "top",
              stateArg: null,
              context: new Context(inline ? "block" : "top", base || 0, null)};
    },

    token: function(stream, state) {
      if (!state.tokenize && stream.eatSpace()) return null;
      var style = (state.tokenize || tokenBase)(stream, state);
      if (style && typeof style == "object") {
        type = style[1];
        style = style[0];
      }
      override = style;
      if (type != "comment")
        state.state = states[state.state](type, stream, state);
      return override;
    },

    indent: function(state, textAfter) {
      var cx = state.context, ch = textAfter && textAfter.charAt(0);
      var indent = cx.indent;
      if (cx.type == "prop" && (ch == "}" || ch == ")")) cx = cx.prev;
      if (cx.prev) {
        if (ch == "}" && (cx.type == "block" || cx.type == "top" ||
                          cx.type == "interpolation" || cx.type == "restricted_atBlock")) {
          // Resume indentation from parent context.
          cx = cx.prev;
          indent = cx.indent;
        } else if (ch == ")" && (cx.type == "parens" || cx.type == "atBlock_parens") ||
            ch == "{" && (cx.type == "at" || cx.type == "atBlock")) {
          // Dedent relative to current context.
          indent = Math.max(0, cx.indent - indentUnit);
        }
      }
      return indent;
    },

    electricChars: "}",
    blockCommentStart: "/*",
    blockCommentEnd: "*/",
    blockCommentContinue: " * ",
    lineComment: lineComment,
    fold: "brace"
  };
});

  function keySet(array) {
    var keys = {};
    for (var i = 0; i < array.length; ++i) {
      keys[array[i].toLowerCase()] = true;
    }
    return keys;
  }

  var documentTypes_ = [
    "domain", "regexp", "url", "url-prefix"
  ], documentTypes = keySet(documentTypes_);

  var mediaTypes_ = [
    "all", "aural", "braille", "handheld", "print", "projection", "screen",
    "tty", "tv", "embossed"
  ], mediaTypes = keySet(mediaTypes_);

  var mediaFeatures_ = [
    "width", "min-width", "max-width", "height", "min-height", "max-height",
    "device-width", "min-device-width", "max-device-width", "device-height",
    "min-device-height", "max-device-height", "aspect-ratio",
    "min-aspect-ratio", "max-aspect-ratio", "device-aspect-ratio",
    "min-device-aspect-ratio", "max-device-aspect-ratio", "color", "min-color",
    "max-color", "color-index", "min-color-index", "max-color-index",
    "monochrome", "min-monochrome", "max-monochrome", "resolution",
    "min-resolution", "max-resolution", "scan", "grid", "orientation",
    "device-pixel-ratio", "min-device-pixel-ratio", "max-device-pixel-ratio",
    "pointer", "any-pointer", "hover", "any-hover"
  ], mediaFeatures = keySet(mediaFeatures_);

  var mediaValueKeywords_ = [
    "landscape", "portrait", "none", "coarse", "fine", "on-demand", "hover",
    "interlace", "progressive"
  ], mediaValueKeywords = keySet(mediaValueKeywords_);

  var propertyKeywords_ = [
    "align-content", "align-items", "align-self", "alignment-adjust",
    "alignment-baseline", "anchor-point", "animation", "animation-delay",
    "animation-direction", "animation-duration", "animation-fill-mode",
    "animation-iteration-count", "animation-name", "animation-play-state",
    "animation-timing-function", "appearance", "azimuth", "backface-visibility",
    "background", "background-attachment", "background-blend-mode", "background-clip",
    "background-color", "background-image", "background-origin", "background-position",
    "background-repeat", "background-size", "baseline-shift", "binding",
    "bleed", "bookmark-label", "bookmark-level", "bookmark-state",
    "bookmark-target", "border", "border-bottom", "border-bottom-color",
    "border-bottom-left-radius", "border-bottom-right-radius",
    "border-bottom-style", "border-bottom-width", "border-collapse",
    "border-color", "border-image", "border-image-outset",
    "border-image-repeat", "border-image-slice", "border-image-source",
    "border-image-width", "border-left", "border-left-color",
    "border-left-style", "border-left-width", "border-radius", "border-right",
    "border-right-color", "border-right-style", "border-right-width",
    "border-spacing", "border-style", "border-top", "border-top-color",
    "border-top-left-radius", "border-top-right-radius", "border-top-style",
    "border-top-width", "border-width", "bottom", "box-decoration-break",
    "box-shadow", "box-sizing", "break-after", "break-before", "break-inside",
    "caption-side", "caret-color", "clear", "clip", "color", "color-profile", "column-count",
    "column-fill", "column-gap", "column-rule", "column-rule-color",
    "column-rule-style", "column-rule-width", "column-span", "column-width",
    "columns", "content", "counter-increment", "counter-reset", "crop", "cue",
    "cue-after", "cue-before", "cursor", "direction", "display",
    "dominant-baseline", "drop-initial-after-adjust",
    "drop-initial-after-align", "drop-initial-before-adjust",
    "drop-initial-before-align", "drop-initial-size", "drop-initial-value",
    "elevation", "empty-cells", "fit", "fit-position", "flex", "flex-basis",
    "flex-direction", "flex-flow", "flex-grow", "flex-shrink", "flex-wrap",
    "float", "float-offset", "flow-from", "flow-into", "font", "font-feature-settings",
    "font-family", "font-kerning", "font-language-override", "font-size", "font-size-adjust",
    "font-stretch", "font-style", "font-synthesis", "font-variant",
    "font-variant-alternates", "font-variant-caps", "font-variant-east-asian",
    "font-variant-ligatures", "font-variant-numeric", "font-variant-position",
    "font-weight", "grid", "grid-area", "grid-auto-columns", "grid-auto-flow",
    "grid-auto-rows", "grid-column", "grid-column-end", "grid-column-gap",
    "grid-column-start", "grid-gap", "grid-row", "grid-row-end", "grid-row-gap",
    "grid-row-start", "grid-template", "grid-template-areas", "grid-template-columns",
    "grid-template-rows", "hanging-punctuation", "height", "hyphens",
    "icon", "image-orientation", "image-rendering", "image-resolution",
    "inline-box-align", "justify-content", "justify-items", "justify-self", "left", "letter-spacing",
    "line-break", "line-height", "line-stacking", "line-stacking-ruby",
    "line-stacking-shift", "line-stacking-strategy", "list-style",
    "list-style-image", "list-style-position", "list-style-type", "margin",
    "margin-bottom", "margin-left", "margin-right", "margin-top",
    "marks", "marquee-direction", "marquee-loop",
    "marquee-play-count", "marquee-speed", "marquee-style", "max-height",
    "max-width", "min-height", "min-width", "move-to", "nav-down", "nav-index",
    "nav-left", "nav-right", "nav-up", "object-fit", "object-position",
    "opacity", "order", "orphans", "outline",
    "outline-color", "outline-offset", "outline-style", "outline-width",
    "overflow", "overflow-style", "overflow-wrap", "overflow-x", "overflow-y",
    "padding", "padding-bottom", "padding-left", "padding-right", "padding-top",
    "page", "page-break-after", "page-break-before", "page-break-inside",
    "page-policy", "pause", "pause-after", "pause-before", "perspective",
    "perspective-origin", "pitch", "pitch-range", "place-content", "place-items", "place-self", "play-during", "position",
    "presentation-level", "punctuation-trim", "quotes", "region-break-after",
    "region-break-before", "region-break-inside", "region-fragment",
    "rendering-intent", "resize", "rest", "rest-after", "rest-before", "richness",
    "right", "rotation", "rotation-point", "ruby-align", "ruby-overhang",
    "ruby-position", "ruby-span", "shape-image-threshold", "shape-inside", "shape-margin",
    "shape-outside", "size", "speak", "speak-as", "speak-header",
    "speak-numeral", "speak-punctuation", "speech-rate", "stress", "string-set",
    "tab-size", "table-layout", "target", "target-name", "target-new",
    "target-position", "text-align", "text-align-last", "text-decoration",
    "text-decoration-color", "text-decoration-line", "text-decoration-skip",
    "text-decoration-style", "text-emphasis", "text-emphasis-color",
    "text-emphasis-position", "text-emphasis-style", "text-height",
    "text-indent", "text-justify", "text-outline", "text-overflow", "text-shadow",
    "text-size-adjust", "text-space-collapse", "text-transform", "text-underline-position",
    "text-wrap", "top", "transform", "transform-origin", "transform-style",
    "transition", "transition-delay", "transition-duration",
    "transition-property", "transition-timing-function", "unicode-bidi",
    "user-select", "vertical-align", "visibility", "voice-balance", "voice-duration",
    "voice-family", "voice-pitch", "voice-range", "voice-rate", "voice-stress",
    "voice-volume", "volume", "white-space", "widows", "width", "will-change", "word-break",
    "word-spacing", "word-wrap", "z-index",
    // SVG-specific
    "clip-path", "clip-rule", "mask", "enable-background", "filter", "flood-color",
    "flood-opacity", "lighting-color", "stop-color", "stop-opacity", "pointer-events",
    "color-interpolation", "color-interpolation-filters",
    "color-rendering", "fill", "fill-opacity", "fill-rule", "image-rendering",
    "marker", "marker-end", "marker-mid", "marker-start", "shape-rendering", "stroke",
    "stroke-dasharray", "stroke-dashoffset", "stroke-linecap", "stroke-linejoin",
    "stroke-miterlimit", "stroke-opacity", "stroke-width", "text-rendering",
    "baseline-shift", "dominant-baseline", "glyph-orientation-horizontal",
    "glyph-orientation-vertical", "text-anchor", "writing-mode"
  ], propertyKeywords = keySet(propertyKeywords_);

  var nonStandardPropertyKeywords_ = [
    "scrollbar-arrow-color", "scrollbar-base-color", "scrollbar-dark-shadow-color",
    "scrollbar-face-color", "scrollbar-highlight-color", "scrollbar-shadow-color",
    "scrollbar-3d-light-color", "scrollbar-track-color", "shape-inside",
    "searchfield-cancel-button", "searchfield-decoration", "searchfield-results-button",
    "searchfield-results-decoration", "zoom"
  ], nonStandardPropertyKeywords = keySet(nonStandardPropertyKeywords_);

  var fontProperties_ = [
    "font-family", "src", "unicode-range", "font-variant", "font-feature-settings",
    "font-stretch", "font-weight", "font-style"
  ], fontProperties = keySet(fontProperties_);

  var counterDescriptors_ = [
    "additive-symbols", "fallback", "negative", "pad", "prefix", "range",
    "speak-as", "suffix", "symbols", "system"
  ], counterDescriptors = keySet(counterDescriptors_);

  var colorKeywords_ = [
    "aliceblue", "antiquewhite", "aqua", "aquamarine", "azure", "beige",
    "bisque", "black", "blanchedalmond", "blue", "blueviolet", "brown",
    "burlywood", "cadetblue", "chartreuse", "chocolate", "coral", "cornflowerblue",
    "cornsilk", "crimson", "cyan", "darkblue", "darkcyan", "darkgoldenrod",
    "darkgray", "darkgreen", "darkkhaki", "darkmagenta", "darkolivegreen",
    "darkorange", "darkorchid", "darkred", "darksalmon", "darkseagreen",
    "darkslateblue", "darkslategray", "darkturquoise", "darkviolet",
    "deeppink", "deepskyblue", "dimgray", "dodgerblue", "firebrick",
    "floralwhite", "forestgreen", "fuchsia", "gainsboro", "ghostwhite",
    "gold", "goldenrod", "gray", "grey", "green", "greenyellow", "honeydew",
    "hotpink", "indianred", "indigo", "ivory", "khaki", "lavender",
    "lavenderblush", "lawngreen", "lemonchiffon", "lightblue", "lightcoral",
    "lightcyan", "lightgoldenrodyellow", "lightgray", "lightgreen", "lightpink",
    "lightsalmon", "lightseagreen", "lightskyblue", "lightslategray",
    "lightsteelblue", "lightyellow", "lime", "limegreen", "linen", "magenta",
    "maroon", "mediumaquamarine", "mediumblue", "mediumorchid", "mediumpurple",
    "mediumseagreen", "mediumslateblue", "mediumspringgreen", "mediumturquoise",
    "mediumvioletred", "midnightblue", "mintcream", "mistyrose", "moccasin",
    "navajowhite", "navy", "oldlace", "olive", "olivedrab", "orange", "orangered",
    "orchid", "palegoldenrod", "palegreen", "paleturquoise", "palevioletred",
    "papayawhip", "peachpuff", "peru", "pink", "plum", "powderblue",
    "purple", "rebeccapurple", "red", "rosybrown", "royalblue", "saddlebrown",
    "salmon", "sandybrown", "seagreen", "seashell", "sienna", "silver", "skyblue",
    "slateblue", "slategray", "snow", "springgreen", "steelblue", "tan",
    "teal", "thistle", "tomato", "turquoise", "violet", "wheat", "white",
    "whitesmoke", "yellow", "yellowgreen"
  ], colorKeywords = keySet(colorKeywords_);

  var valueKeywords_ = [
    "above", "absolute", "activeborder", "additive", "activecaption", "afar",
    "after-white-space", "ahead", "alias", "all", "all-scroll", "alphabetic", "alternate",
    "always", "amharic", "amharic-abegede", "antialiased", "appworkspace",
    "arabic-indic", "armenian", "asterisks", "attr", "auto", "auto-flow", "avoid", "avoid-column", "avoid-page",
    "avoid-region", "background", "backwards", "baseline", "below", "bidi-override", "binary",
    "bengali", "blink", "block", "block-axis", "bold", "bolder", "border", "border-box",
    "both", "bottom", "break", "break-all", "break-word", "bullets", "button", "button-bevel",
    "buttonface", "buttonhighlight", "buttonshadow", "buttontext", "calc", "cambodian",
    "capitalize", "caps-lock-indicator", "caption", "captiontext", "caret",
    "cell", "center", "checkbox", "circle", "cjk-decimal", "cjk-earthly-branch",
    "cjk-heavenly-stem", "cjk-ideographic", "clear", "clip", "close-quote",
    "col-resize", "collapse", "color", "color-burn", "color-dodge", "column", "column-reverse",
    "compact", "condensed", "contain", "content", "contents",
    "content-box", "context-menu", "continuous", "copy", "counter", "counters", "cover", "crop",
    "cross", "crosshair", "currentcolor", "cursive", "cyclic", "darken", "dashed", "decimal",
    "decimal-leading-zero", "default", "default-button", "dense", "destination-atop",
    "destination-in", "destination-out", "destination-over", "devanagari", "difference",
    "disc", "discard", "disclosure-closed", "disclosure-open", "document",
    "dot-dash", "dot-dot-dash",
    "dotted", "double", "down", "e-resize", "ease", "ease-in", "ease-in-out", "ease-out",
    "element", "ellipse", "ellipsis", "embed", "end", "ethiopic", "ethiopic-abegede",
    "ethiopic-abegede-am-et", "ethiopic-abegede-gez", "ethiopic-abegede-ti-er",
    "ethiopic-abegede-ti-et", "ethiopic-halehame-aa-er",
    "ethiopic-halehame-aa-et", "ethiopic-halehame-am-et",
    "ethiopic-halehame-gez", "ethiopic-halehame-om-et",
    "ethiopic-halehame-sid-et", "ethiopic-halehame-so-et",
    "ethiopic-halehame-ti-er", "ethiopic-halehame-ti-et", "ethiopic-halehame-tig",
    "ethiopic-numeric", "ew-resize", "exclusion", "expanded", "extends", "extra-condensed",
    "extra-expanded", "fantasy", "fast", "fill", "fixed", "flat", "flex", "flex-end", "flex-start", "footnotes",
    "forwards", "from", "geometricPrecision", "georgian", "graytext", "grid", "groove",
    "gujarati", "gurmukhi", "hand", "hangul", "hangul-consonant", "hard-light", "hebrew",
    "help", "hidden", "hide", "higher", "highlight", "highlighttext",
    "hiragana", "hiragana-iroha", "horizontal", "hsl", "hsla", "hue", "icon", "ignore",
    "inactiveborder", "inactivecaption", "inactivecaptiontext", "infinite",
    "infobackground", "infotext", "inherit", "initial", "inline", "inline-axis",
    "inline-block", "inline-flex", "inline-grid", "inline-table", "inset", "inside", "intrinsic", "invert",
    "italic", "japanese-formal", "japanese-informal", "justify", "kannada",
    "katakana", "katakana-iroha", "keep-all", "khmer",
    "korean-hangul-formal", "korean-hanja-formal", "korean-hanja-informal",
    "landscape", "lao", "large", "larger", "left", "level", "lighter", "lighten",
    "line-through", "linear", "linear-gradient", "lines", "list-item", "listbox", "listitem",
    "local", "logical", "loud", "lower", "lower-alpha", "lower-armenian",
    "lower-greek", "lower-hexadecimal", "lower-latin", "lower-norwegian",
    "lower-roman", "lowercase", "ltr", "luminosity", "malayalam", "match", "matrix", "matrix3d",
    "media-controls-background", "media-current-time-display",
    "media-fullscreen-button", "media-mute-button", "media-play-button",
    "media-return-to-realtime-button", "media-rewind-button",
    "media-seek-back-button", "media-seek-forward-button", "media-slider",
    "media-sliderthumb", "media-time-remaining-display", "media-volume-slider",
    "media-volume-slider-container", "media-volume-sliderthumb", "medium",
    "menu", "menulist", "menulist-button", "menulist-text",
    "menulist-textfield", "menutext", "message-box", "middle", "min-intrinsic",
    "mix", "mongolian", "monospace", "move", "multiple", "multiply", "myanmar", "n-resize",
    "narrower", "ne-resize", "nesw-resize", "no-close-quote", "no-drop",
    "no-open-quote", "no-repeat", "none", "normal", "not-allowed", "nowrap",
    "ns-resize", "numbers", "numeric", "nw-resize", "nwse-resize", "oblique", "octal", "opacity", "open-quote",
    "optimizeLegibility", "optimizeSpeed", "oriya", "oromo", "outset",
    "outside", "outside-shape", "overlay", "overline", "padding", "padding-box",
    "painted", "page", "paused", "persian", "perspective", "plus-darker", "plus-lighter",
    "pointer", "polygon", "portrait", "pre", "pre-line", "pre-wrap", "preserve-3d",
    "progress", "push-button", "radial-gradient", "radio", "read-only",
    "read-write", "read-write-plaintext-only", "rectangle", "region",
    "relative", "repeat", "repeating-linear-gradient",
    "repeating-radial-gradient", "repeat-x", "repeat-y", "reset", "reverse",
    "rgb", "rgba", "ridge", "right", "rotate", "rotate3d", "rotateX", "rotateY",
    "rotateZ", "round", "row", "row-resize", "row-reverse", "rtl", "run-in", "running",
    "s-resize", "sans-serif", "saturation", "scale", "scale3d", "scaleX", "scaleY", "scaleZ", "screen",
    "scroll", "scrollbar", "scroll-position", "se-resize", "searchfield",
    "searchfield-cancel-button", "searchfield-decoration",
    "searchfield-results-button", "searchfield-results-decoration", "self-start", "self-end",
    "semi-condensed", "semi-expanded", "separate", "serif", "show", "sidama",
    "simp-chinese-formal", "simp-chinese-informal", "single",
    "skew", "skewX", "skewY", "skip-white-space", "slide", "slider-horizontal",
    "slider-vertical", "sliderthumb-horizontal", "sliderthumb-vertical", "slow",
    "small", "small-caps", "small-caption", "smaller", "soft-light", "solid", "somali",
    "source-atop", "source-in", "source-out", "source-over", "space", "space-around", "space-between", "space-evenly", "spell-out", "square",
    "square-button", "start", "static", "status-bar", "stretch", "stroke", "sub",
    "subpixel-antialiased", "super", "sw-resize", "symbolic", "symbols", "system-ui", "table",
    "table-caption", "table-cell", "table-column", "table-column-group",
    "table-footer-group", "table-header-group", "table-row", "table-row-group",
    "tamil",
    "telugu", "text", "text-bottom", "text-top", "textarea", "textfield", "thai",
    "thick", "thin", "threeddarkshadow", "threedface", "threedhighlight",
    "threedlightshadow", "threedshadow", "tibetan", "tigre", "tigrinya-er",
    "tigrinya-er-abegede", "tigrinya-et", "tigrinya-et-abegede", "to", "top",
    "trad-chinese-formal", "trad-chinese-informal", "transform",
    "translate", "translate3d", "translateX", "translateY", "translateZ",
    "transparent", "ultra-condensed", "ultra-expanded", "underline", "unset", "up",
    "upper-alpha", "upper-armenian", "upper-greek", "upper-hexadecimal",
    "upper-latin", "upper-norwegian", "upper-roman", "uppercase", "urdu", "url",
    "var", "vertical", "vertical-text", "visible", "visibleFill", "visiblePainted",
    "visibleStroke", "visual", "w-resize", "wait", "wave", "wider",
    "window", "windowframe", "windowtext", "words", "wrap", "wrap-reverse", "x-large", "x-small", "xor",
    "xx-large", "xx-small"
  ], valueKeywords = keySet(valueKeywords_);

  var allWords = documentTypes_.concat(mediaTypes_).concat(mediaFeatures_).concat(mediaValueKeywords_)
    .concat(propertyKeywords_).concat(nonStandardPropertyKeywords_).concat(colorKeywords_)
    .concat(valueKeywords_);
  CodeMirror.registerHelper("hintWords", "css", allWords);

  function tokenCComment(stream, state) {
    var maybeEnd = false, ch;
    while ((ch = stream.next()) != null) {
      if (maybeEnd && ch == "/") {
        state.tokenize = null;
        break;
      }
      maybeEnd = (ch == "*");
    }
    return ["comment", "comment"];
  }

  CodeMirror.defineMIME("text/css", {
    documentTypes: documentTypes,
    mediaTypes: mediaTypes,
    mediaFeatures: mediaFeatures,
    mediaValueKeywords: mediaValueKeywords,
    propertyKeywords: propertyKeywords,
    nonStandardPropertyKeywords: nonStandardPropertyKeywords,
    fontProperties: fontProperties,
    counterDescriptors: counterDescriptors,
    colorKeywords: colorKeywords,
    valueKeywords: valueKeywords,
    tokenHooks: {
      "/": function(stream, state) {
        if (!stream.eat("*")) return false;
        state.tokenize = tokenCComment;
        return tokenCComment(stream, state);
      }
    },
    name: "css"
  });

  CodeMirror.defineMIME("text/x-scss", {
    mediaTypes: mediaTypes,
    mediaFeatures: mediaFeatures,
    mediaValueKeywords: mediaValueKeywords,
    propertyKeywords: propertyKeywords,
    nonStandardPropertyKeywords: nonStandardPropertyKeywords,
    colorKeywords: colorKeywords,
    valueKeywords: valueKeywords,
    fontProperties: fontProperties,
    allowNested: true,
    lineComment: "//",
    tokenHooks: {
      "/": function(stream, state) {
        if (stream.eat("/")) {
          stream.skipToEnd();
          return ["comment", "comment"];
        } else if (stream.eat("*")) {
          state.tokenize = tokenCComment;
          return tokenCComment(stream, state);
        } else {
          return ["operator", "operator"];
        }
      },
      ":": function(stream) {
        if (stream.match(/\s*\{/, false))
          return [null, null]
        return false;
      },
      "$": function(stream) {
        stream.match(/^[\w-]+/);
        if (stream.match(/^\s*:/, false))
          return ["variable-2", "variable-definition"];
        return ["variable-2", "variable"];
      },
      "#": function(stream) {
        if (!stream.eat("{")) return false;
        return [null, "interpolation"];
      }
    },
    name: "css",
    helperType: "scss"
  });

  CodeMirror.defineMIME("text/x-less", {
    mediaTypes: mediaTypes,
    mediaFeatures: mediaFeatures,
    mediaValueKeywords: mediaValueKeywords,
    propertyKeywords: propertyKeywords,
    nonStandardPropertyKeywords: nonStandardPropertyKeywords,
    colorKeywords: colorKeywords,
    valueKeywords: valueKeywords,
    fontProperties: fontProperties,
    allowNested: true,
    lineComment: "//",
    tokenHooks: {
      "/": function(stream, state) {
        if (stream.eat("/")) {
          stream.skipToEnd();
          return ["comment", "comment"];
        } else if (stream.eat("*")) {
          state.tokenize = tokenCComment;
          return tokenCComment(stream, state);
        } else {
          return ["operator", "operator"];
        }
      },
      "@": function(stream) {
        if (stream.eat("{")) return [null, "interpolation"];
        if (stream.match(/^(charset|document|font-face|import|(-(moz|ms|o|webkit)-)?keyframes|media|namespace|page|supports)\b/i, false)) return false;
        stream.eatWhile(/[\w\\\-]/);
        if (stream.match(/^\s*:/, false))
          return ["variable-2", "variable-definition"];
        return ["variable-2", "variable"];
      },
      "&": function() {
        return ["atom", "atom"];
      }
    },
    name: "css",
    helperType: "less"
  });

  CodeMirror.defineMIME("text/x-gss", {
    documentTypes: documentTypes,
    mediaTypes: mediaTypes,
    mediaFeatures: mediaFeatures,
    propertyKeywords: propertyKeywords,
    nonStandardPropertyKeywords: nonStandardPropertyKeywords,
    fontProperties: fontProperties,
    counterDescriptors: counterDescriptors,
    colorKeywords: colorKeywords,
    valueKeywords: valueKeywords,
    supportsAtComponent: true,
    tokenHooks: {
      "/": function(stream, state) {
        if (!stream.eat("*")) return false;
        state.tokenize = tokenCComment;
        return tokenCComment(stream, state);
      }
    },
    name: "css",
    helperType: "gss"
  });

});


if (window) window.__currentScriptPath = "/framework/common/codemirror/mode/javascript/javascript.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
"use strict";

CodeMirror.defineMode("javascript", function(config, parserConfig) {
  var indentUnit = config.indentUnit;
  var statementIndent = parserConfig.statementIndent;
  var jsonldMode = parserConfig.jsonld;
  var jsonMode = parserConfig.json || jsonldMode;
  var isTS = parserConfig.typescript;
  var wordRE = parserConfig.wordCharacters || /[\w$\xa1-\uffff]/;

  // Tokenizer

  var keywords = function(){
    function kw(type) {return {type: type, style: "keyword"};}
    var A = kw("keyword a"), B = kw("keyword b"), C = kw("keyword c"), D = kw("keyword d");
    var operator = kw("operator"), atom = {type: "atom", style: "atom"};

    return {
      "if": kw("if"), "while": A, "with": A, "else": B, "do": B, "try": B, "finally": B,
      "return": D, "break": D, "continue": D, "new": kw("new"), "delete": C, "void": C, "throw": C,
      "debugger": kw("debugger"), "var": kw("var"), "const": kw("var"), "let": kw("var"),
      "function": kw("function"), "catch": kw("catch"),
      "for": kw("for"), "switch": kw("switch"), "case": kw("case"), "default": kw("default"),
      "in": operator, "typeof": operator, "instanceof": operator,
      "true": atom, "false": atom, "null": atom, "undefined": atom, "NaN": atom, "Infinity": atom,
      "this": kw("this"), "class": kw("class"), "super": kw("atom"),
      "yield": C, "export": kw("export"), "import": kw("import"), "extends": C,
      "await": C
    };
  }();

  var isOperatorChar = /[+\-*&%=<>!?|~^@]/;
  var isJsonldKeyword = /^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;

  function readRegexp(stream) {
    var escaped = false, next, inSet = false;
    while ((next = stream.next()) != null) {
      if (!escaped) {
        if (next == "/" && !inSet) return;
        if (next == "[") inSet = true;
        else if (inSet && next == "]") inSet = false;
      }
      escaped = !escaped && next == "\\";
    }
  }

  // Used as scratch variables to communicate multiple values without
  // consing up tons of objects.
  var type, content;
  function ret(tp, style, cont) {
    type = tp; content = cont;
    return style;
  }
  function tokenBase(stream, state) {
    var ch = stream.next();
    if (ch == '"' || ch == "'") {
      state.tokenize = tokenString(ch);
      return state.tokenize(stream, state);
    } else if (ch == "." && stream.match(/^\d+(?:[eE][+\-]?\d+)?/)) {
      return ret("number", "number");
    } else if (ch == "." && stream.match("..")) {
      return ret("spread", "meta");
    } else if (/[\[\]{}\(\),;\:\.]/.test(ch)) {
      return ret(ch);
    } else if (ch == "=" && stream.eat(">")) {
      return ret("=>", "operator");
    } else if (ch == "0" && stream.eat(/x/i)) {
      stream.eatWhile(/[\da-f]/i);
      return ret("number", "number");
    } else if (ch == "0" && stream.eat(/o/i)) {
      stream.eatWhile(/[0-7]/i);
      return ret("number", "number");
    } else if (ch == "0" && stream.eat(/b/i)) {
      stream.eatWhile(/[01]/i);
      return ret("number", "number");
    } else if (/\d/.test(ch)) {
      stream.match(/^\d*(?:\.\d*)?(?:[eE][+\-]?\d+)?/);
      return ret("number", "number");
    } else if (ch == "/") {
      if (stream.eat("*")) {
        state.tokenize = tokenComment;
        return tokenComment(stream, state);
      } else if (stream.eat("/")) {
        stream.skipToEnd();
        return ret("comment", "comment");
      } else if (expressionAllowed(stream, state, 1)) {
        readRegexp(stream);
        stream.match(/^\b(([gimyu])(?![gimyu]*\2))+\b/);
        return ret("regexp", "string-2");
      } else {
        stream.eat("=");
        return ret("operator", "operator", stream.current());
      }
    } else if (ch == "`") {
      state.tokenize = tokenQuasi;
      return tokenQuasi(stream, state);
    } else if (ch == "#") {
      stream.skipToEnd();
      return ret("error", "error");
    } else if (isOperatorChar.test(ch)) {
      if (ch != ">" || !state.lexical || state.lexical.type != ">") {
        if (stream.eat("=")) {
          if (ch == "!" || ch == "=") stream.eat("=")
        } else if (/[<>*+\-]/.test(ch)) {
          stream.eat(ch)
          if (ch == ">") stream.eat(ch)
        }
      }
      return ret("operator", "operator", stream.current());
    } else if (wordRE.test(ch)) {
      stream.eatWhile(wordRE);
      var word = stream.current()
      if (state.lastType != ".") {
        if (keywords.propertyIsEnumerable(word)) {
          var kw = keywords[word]
          return ret(kw.type, kw.style, word)
        }
        if (word == "async" && stream.match(/^(\s|\/\*.*?\*\/)*[\(\w]/, false))
          return ret("async", "keyword", word)
      }
      return ret("variable", "variable", word)
    }
  }

  function tokenString(quote) {
    return function(stream, state) {
      var escaped = false, next;
      if (jsonldMode && stream.peek() == "@" && stream.match(isJsonldKeyword)){
        state.tokenize = tokenBase;
        return ret("jsonld-keyword", "meta");
      }
      while ((next = stream.next()) != null) {
        if (next == quote && !escaped) break;
        escaped = !escaped && next == "\\";
      }
      if (!escaped) state.tokenize = tokenBase;
      return ret("string", "string");
    };
  }

  function tokenComment(stream, state) {
    var maybeEnd = false, ch;
    while (ch = stream.next()) {
      if (ch == "/" && maybeEnd) {
        state.tokenize = tokenBase;
        break;
      }
      maybeEnd = (ch == "*");
    }
    return ret("comment", "comment");
  }

  function tokenQuasi(stream, state) {
    var escaped = false, next;
    while ((next = stream.next()) != null) {
      if (!escaped && (next == "`" || next == "$" && stream.eat("{"))) {
        state.tokenize = tokenBase;
        break;
      }
      escaped = !escaped && next == "\\";
    }
    return ret("quasi", "string-2", stream.current());
  }

  var brackets = "([{}])";
  // This is a crude lookahead trick to try and notice that we're
  // parsing the argument patterns for a fat-arrow function before we
  // actually hit the arrow token. It only works if the arrow is on
  // the same line as the arguments and there's no strange noise
  // (comments) in between. Fallback is to only notice when we hit the
  // arrow, and not declare the arguments as locals for the arrow
  // body.
  function findFatArrow(stream, state) {
    if (state.fatArrowAt) state.fatArrowAt = null;
    var arrow = stream.string.indexOf("=>", stream.start);
    if (arrow < 0) return;

    if (isTS) { // Try to skip TypeScript return type declarations after the arguments
      var m = /:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(stream.string.slice(stream.start, arrow))
      if (m) arrow = m.index
    }

    var depth = 0, sawSomething = false;
    for (var pos = arrow - 1; pos >= 0; --pos) {
      var ch = stream.string.charAt(pos);
      var bracket = brackets.indexOf(ch);
      if (bracket >= 0 && bracket < 3) {
        if (!depth) { ++pos; break; }
        if (--depth == 0) { if (ch == "(") sawSomething = true; break; }
      } else if (bracket >= 3 && bracket < 6) {
        ++depth;
      } else if (wordRE.test(ch)) {
        sawSomething = true;
      } else if (/["'\/]/.test(ch)) {
        return;
      } else if (sawSomething && !depth) {
        ++pos;
        break;
      }
    }
    if (sawSomething && !depth) state.fatArrowAt = pos;
  }

  // Parser

  var atomicTypes = {"atom": true, "number": true, "variable": true, "string": true, "regexp": true, "this": true, "jsonld-keyword": true};

  function JSLexical(indented, column, type, align, prev, info) {
    this.indented = indented;
    this.column = column;
    this.type = type;
    this.prev = prev;
    this.info = info;
    if (align != null) this.align = align;
  }

  function inScope(state, varname) {
    for (var v = state.localVars; v; v = v.next)
      if (v.name == varname) return true;
    for (var cx = state.context; cx; cx = cx.prev) {
      for (var v = cx.vars; v; v = v.next)
        if (v.name == varname) return true;
    }
  }

  function parseJS(state, style, type, content, stream) {
    var cc = state.cc;
    // Communicate our context to the combinators.
    // (Less wasteful than consing up a hundred closures on every call.)
    cx.state = state; cx.stream = stream; cx.marked = null, cx.cc = cc; cx.style = style;

    if (!state.lexical.hasOwnProperty("align"))
      state.lexical.align = true;

    while(true) {
      var combinator = cc.length ? cc.pop() : jsonMode ? expression : statement;
      if (combinator(type, content)) {
        while(cc.length && cc[cc.length - 1].lex)
          cc.pop()();
        if (cx.marked) return cx.marked;
        if (type == "variable" && inScope(state, content)) return "variable-2";
        return style;
      }
    }
  }

  // Combinator utils

  var cx = {state: null, column: null, marked: null, cc: null};
  function pass() {
    for (var i = arguments.length - 1; i >= 0; i--) cx.cc.push(arguments[i]);
  }
  function cont() {
    pass.apply(null, arguments);
    return true;
  }
  function register(varname) {
    function inList(list) {
      for (var v = list; v; v = v.next)
        if (v.name == varname) return true;
      return false;
    }
    var state = cx.state;
    cx.marked = "def";
    if (state.context) {
      if (inList(state.localVars)) return;
      state.localVars = {name: varname, next: state.localVars};
    } else {
      if (inList(state.globalVars)) return;
      if (parserConfig.globalVars)
        state.globalVars = {name: varname, next: state.globalVars};
    }
  }

  function isModifier(name) {
    return name == "public" || name == "private" || name == "protected" || name == "abstract" || name == "readonly"
  }

  // Combinators

  var defaultVars = {name: "this", next: {name: "arguments"}};
  function pushcontext() {
    cx.state.context = {prev: cx.state.context, vars: cx.state.localVars};
    cx.state.localVars = defaultVars;
  }
  function popcontext() {
    cx.state.localVars = cx.state.context.vars;
    cx.state.context = cx.state.context.prev;
  }
  function pushlex(type, info) {
    var result = function() {
      var state = cx.state, indent = state.indented;
      if (state.lexical.type == "stat") indent = state.lexical.indented;
      else for (var outer = state.lexical; outer && outer.type == ")" && outer.align; outer = outer.prev)
        indent = outer.indented;
      state.lexical = new JSLexical(indent, cx.stream.column(), type, null, state.lexical, info);
    };
    result.lex = true;
    return result;
  }
  function poplex() {
    var state = cx.state;
    if (state.lexical.prev) {
      if (state.lexical.type == ")")
        state.indented = state.lexical.indented;
      state.lexical = state.lexical.prev;
    }
  }
  poplex.lex = true;

  function expect(wanted) {
    function exp(type) {
      if (type == wanted) return cont();
      else if (wanted == ";") return pass();
      else return cont(exp);
    };
    return exp;
  }

  function statement(type, value) {
    if (type == "var") return cont(pushlex("vardef", value.length), vardef, expect(";"), poplex);
    if (type == "keyword a") return cont(pushlex("form"), parenExpr, statement, poplex);
    if (type == "keyword b") return cont(pushlex("form"), statement, poplex);
    if (type == "keyword d") return cx.stream.match(/^\s*$/, false) ? cont() : cont(pushlex("stat"), maybeexpression, expect(";"), poplex);
    if (type == "debugger") return cont(expect(";"));
    if (type == "{") return cont(pushlex("}"), block, poplex);
    if (type == ";") return cont();
    if (type == "if") {
      if (cx.state.lexical.info == "else" && cx.state.cc[cx.state.cc.length - 1] == poplex)
        cx.state.cc.pop()();
      return cont(pushlex("form"), parenExpr, statement, poplex, maybeelse);
    }
    if (type == "function") return cont(functiondef);
    if (type == "for") return cont(pushlex("form"), forspec, statement, poplex);
    if (type == "class" || (isTS && value == "interface")) { cx.marked = "keyword"; return cont(pushlex("form"), className, poplex); }
    if (type == "variable") {
      if (isTS && value == "declare") {
        cx.marked = "keyword"
        return cont(statement)
      } else if (isTS && (value == "module" || value == "enum" || value == "type") && cx.stream.match(/^\s*\w/, false)) {
        cx.marked = "keyword"
        if (value == "enum") return cont(enumdef);
        else if (value == "type") return cont(typeexpr, expect("operator"), typeexpr, expect(";"));
        else return cont(pushlex("form"), pattern, expect("{"), pushlex("}"), block, poplex, poplex)
      } else if (isTS && value == "namespace") {
        cx.marked = "keyword"
        return cont(pushlex("form"), expression, block, poplex)
      } else {
        return cont(pushlex("stat"), maybelabel);
      }
    }
    if (type == "switch") return cont(pushlex("form"), parenExpr, expect("{"), pushlex("}", "switch"),
                                      block, poplex, poplex);
    if (type == "case") return cont(expression, expect(":"));
    if (type == "default") return cont(expect(":"));
    if (type == "catch") return cont(pushlex("form"), pushcontext, expect("("), funarg, expect(")"),
                                     statement, poplex, popcontext);
    if (type == "export") return cont(pushlex("stat"), afterExport, poplex);
    if (type == "import") return cont(pushlex("stat"), afterImport, poplex);
    if (type == "async") return cont(statement)
    if (value == "@") return cont(expression, statement)
    return pass(pushlex("stat"), expression, expect(";"), poplex);
  }
  function expression(type, value) {
    return expressionInner(type, value, false);
  }
  function expressionNoComma(type, value) {
    return expressionInner(type, value, true);
  }
  function parenExpr(type) {
    if (type != "(") return pass()
    return cont(pushlex(")"), expression, expect(")"), poplex)
  }
  function expressionInner(type, value, noComma) {
    if (cx.state.fatArrowAt == cx.stream.start) {
      var body = noComma ? arrowBodyNoComma : arrowBody;
      if (type == "(") return cont(pushcontext, pushlex(")"), commasep(funarg, ")"), poplex, expect("=>"), body, popcontext);
      else if (type == "variable") return pass(pushcontext, pattern, expect("=>"), body, popcontext);
    }

    var maybeop = noComma ? maybeoperatorNoComma : maybeoperatorComma;
    if (atomicTypes.hasOwnProperty(type)) return cont(maybeop);
    if (type == "function") return cont(functiondef, maybeop);
    if (type == "class" || (isTS && value == "interface")) { cx.marked = "keyword"; return cont(pushlex("form"), classExpression, poplex); }
    if (type == "keyword c" || type == "async") return cont(noComma ? expressionNoComma : expression);
    if (type == "(") return cont(pushlex(")"), maybeexpression, expect(")"), poplex, maybeop);
    if (type == "operator" || type == "spread") return cont(noComma ? expressionNoComma : expression);
    if (type == "[") return cont(pushlex("]"), arrayLiteral, poplex, maybeop);
    if (type == "{") return contCommasep(objprop, "}", null, maybeop);
    if (type == "quasi") return pass(quasi, maybeop);
    if (type == "new") return cont(maybeTarget(noComma));
    return cont();
  }
  function maybeexpression(type) {
    if (type.match(/[;\}\)\],]/)) return pass();
    return pass(expression);
  }

  function maybeoperatorComma(type, value) {
    if (type == ",") return cont(expression);
    return maybeoperatorNoComma(type, value, false);
  }
  function maybeoperatorNoComma(type, value, noComma) {
    var me = noComma == false ? maybeoperatorComma : maybeoperatorNoComma;
    var expr = noComma == false ? expression : expressionNoComma;
    if (type == "=>") return cont(pushcontext, noComma ? arrowBodyNoComma : arrowBody, popcontext);
    if (type == "operator") {
      if (/\+\+|--/.test(value) || isTS && value == "!") return cont(me);
      if (isTS && value == "<" && cx.stream.match(/^([^>]|<.*?>)*>\s*\(/, false))
        return cont(pushlex(">"), commasep(typeexpr, ">"), poplex, me);
      if (value == "?") return cont(expression, expect(":"), expr);
      return cont(expr);
    }
    if (type == "quasi") { return pass(quasi, me); }
    if (type == ";") return;
    if (type == "(") return contCommasep(expressionNoComma, ")", "call", me);
    if (type == ".") return cont(property, me);
    if (type == "[") return cont(pushlex("]"), maybeexpression, expect("]"), poplex, me);
    if (isTS && value == "as") { cx.marked = "keyword"; return cont(typeexpr, me) }
    if (type == "regexp") {
      cx.state.lastType = cx.marked = "operator"
      cx.stream.backUp(cx.stream.pos - cx.stream.start - 1)
      return cont(expr)
    }
  }
  function quasi(type, value) {
    if (type != "quasi") return pass();
    if (value.slice(value.length - 2) != "${") return cont(quasi);
    return cont(expression, continueQuasi);
  }
  function continueQuasi(type) {
    if (type == "}") {
      cx.marked = "string-2";
      cx.state.tokenize = tokenQuasi;
      return cont(quasi);
    }
  }
  function arrowBody(type) {
    findFatArrow(cx.stream, cx.state);
    return pass(type == "{" ? statement : expression);
  }
  function arrowBodyNoComma(type) {
    findFatArrow(cx.stream, cx.state);
    return pass(type == "{" ? statement : expressionNoComma);
  }
  function maybeTarget(noComma) {
    return function(type) {
      if (type == ".") return cont(noComma ? targetNoComma : target);
      else if (type == "variable" && isTS) return cont(maybeTypeArgs, noComma ? maybeoperatorNoComma : maybeoperatorComma)
      else return pass(noComma ? expressionNoComma : expression);
    };
  }
  function target(_, value) {
    if (value == "target") { cx.marked = "keyword"; return cont(maybeoperatorComma); }
  }
  function targetNoComma(_, value) {
    if (value == "target") { cx.marked = "keyword"; return cont(maybeoperatorNoComma); }
  }
  function maybelabel(type) {
    if (type == ":") return cont(poplex, statement);
    return pass(maybeoperatorComma, expect(";"), poplex);
  }
  function property(type) {
    if (type == "variable") {cx.marked = "property"; return cont();}
  }
  function objprop(type, value) {
    if (type == "async") {
      cx.marked = "property";
      return cont(objprop);
    } else if (type == "variable" || cx.style == "keyword") {
      cx.marked = "property";
      if (value == "get" || value == "set") return cont(getterSetter);
      var m // Work around fat-arrow-detection complication for detecting typescript typed arrow params
      if (isTS && cx.state.fatArrowAt == cx.stream.start && (m = cx.stream.match(/^\s*:\s*/, false)))
        cx.state.fatArrowAt = cx.stream.pos + m[0].length
      return cont(afterprop);
    } else if (type == "number" || type == "string") {
      cx.marked = jsonldMode ? "property" : (cx.style + " property");
      return cont(afterprop);
    } else if (type == "jsonld-keyword") {
      return cont(afterprop);
    } else if (isTS && isModifier(value)) {
      cx.marked = "keyword"
      return cont(objprop)
    } else if (type == "[") {
      return cont(expression, maybetype, expect("]"), afterprop);
    } else if (type == "spread") {
      return cont(expressionNoComma, afterprop);
    } else if (value == "*") {
      cx.marked = "keyword";
      return cont(objprop);
    } else if (type == ":") {
      return pass(afterprop)
    }
  }
  function getterSetter(type) {
    if (type != "variable") return pass(afterprop);
    cx.marked = "property";
    return cont(functiondef);
  }
  function afterprop(type) {
    if (type == ":") return cont(expressionNoComma);
    if (type == "(") return pass(functiondef);
  }
  function commasep(what, end, sep) {
    function proceed(type, value) {
      if (sep ? sep.indexOf(type) > -1 : type == ",") {
        var lex = cx.state.lexical;
        if (lex.info == "call") lex.pos = (lex.pos || 0) + 1;
        return cont(function(type, value) {
          if (type == end || value == end) return pass()
          return pass(what)
        }, proceed);
      }
      if (type == end || value == end) return cont();
      return cont(expect(end));
    }
    return function(type, value) {
      if (type == end || value == end) return cont();
      return pass(what, proceed);
    };
  }
  function contCommasep(what, end, info) {
    for (var i = 3; i < arguments.length; i++)
      cx.cc.push(arguments[i]);
    return cont(pushlex(end, info), commasep(what, end), poplex);
  }
  function block(type) {
    if (type == "}") return cont();
    return pass(statement, block);
  }
  function maybetype(type, value) {
    if (isTS) {
      if (type == ":") return cont(typeexpr);
      if (value == "?") return cont(maybetype);
    }
  }
  function mayberettype(type) {
    if (isTS && type == ":") {
      if (cx.stream.match(/^\s*\w+\s+is\b/, false)) return cont(expression, isKW, typeexpr)
      else return cont(typeexpr)
    }
  }
  function isKW(_, value) {
    if (value == "is") {
      cx.marked = "keyword"
      return cont()
    }
  }
  function typeexpr(type, value) {
    if (type == "variable" || value == "void") {
      if (value == "keyof") {
        cx.marked = "keyword"
        return cont(typeexpr)
      } else {
        cx.marked = "type"
        return cont(afterType)
      }
    }
    if (type == "string" || type == "number" || type == "atom") return cont(afterType);
    if (type == "[") return cont(pushlex("]"), commasep(typeexpr, "]", ","), poplex, afterType)
    if (type == "{") return cont(pushlex("}"), commasep(typeprop, "}", ",;"), poplex, afterType)
    if (type == "(") return cont(commasep(typearg, ")"), maybeReturnType)
  }
  function maybeReturnType(type) {
    if (type == "=>") return cont(typeexpr)
  }
  function typeprop(type, value) {
    if (type == "variable" || cx.style == "keyword") {
      cx.marked = "property"
      return cont(typeprop)
    } else if (value == "?") {
      return cont(typeprop)
    } else if (type == ":") {
      return cont(typeexpr)
    } else if (type == "[") {
      return cont(expression, maybetype, expect("]"), typeprop)
    }
  }
  function typearg(type) {
    if (type == "variable") return cont(typearg)
    else if (type == ":") return cont(typeexpr)
  }
  function afterType(type, value) {
    if (value == "<") return cont(pushlex(">"), commasep(typeexpr, ">"), poplex, afterType)
    if (value == "|" || type == ".") return cont(typeexpr)
    if (type == "[") return cont(expect("]"), afterType)
    if (value == "extends" || value == "implements") { cx.marked = "keyword"; return cont(typeexpr) }
  }
  function maybeTypeArgs(_, value) {
    if (value == "<") return cont(pushlex(">"), commasep(typeexpr, ">"), poplex, afterType)
  }
  function typeparam() {
    return pass(typeexpr, maybeTypeDefault)
  }
  function maybeTypeDefault(_, value) {
    if (value == "=") return cont(typeexpr)
  }
  function vardef(_, value) {
    if (value == "enum") {cx.marked = "keyword"; return cont(enumdef)}
    return pass(pattern, maybetype, maybeAssign, vardefCont);
  }
  function pattern(type, value) {
    if (isTS && isModifier(value)) { cx.marked = "keyword"; return cont(pattern) }
    if (type == "variable") { register(value); return cont(); }
    if (type == "spread") return cont(pattern);
    if (type == "[") return contCommasep(pattern, "]");
    if (type == "{") return contCommasep(proppattern, "}");
  }
  function proppattern(type, value) {
    if (type == "variable" && !cx.stream.match(/^\s*:/, false)) {
      register(value);
      return cont(maybeAssign);
    }
    if (type == "variable") cx.marked = "property";
    if (type == "spread") return cont(pattern);
    if (type == "}") return pass();
    return cont(expect(":"), pattern, maybeAssign);
  }
  function maybeAssign(_type, value) {
    if (value == "=") return cont(expressionNoComma);
  }
  function vardefCont(type) {
    if (type == ",") return cont(vardef);
  }
  function maybeelse(type, value) {
    if (type == "keyword b" && value == "else") return cont(pushlex("form", "else"), statement, poplex);
  }
  function forspec(type) {
    if (type == "(") return cont(pushlex(")"), forspec1, expect(")"), poplex);
  }
  function forspec1(type) {
    if (type == "var") return cont(vardef, expect(";"), forspec2);
    if (type == ";") return cont(forspec2);
    if (type == "variable") return cont(formaybeinof);
    return pass(expression, expect(";"), forspec2);
  }
  function formaybeinof(_type, value) {
    if (value == "in" || value == "of") { cx.marked = "keyword"; return cont(expression); }
    return cont(maybeoperatorComma, forspec2);
  }
  function forspec2(type, value) {
    if (type == ";") return cont(forspec3);
    if (value == "in" || value == "of") { cx.marked = "keyword"; return cont(expression); }
    return pass(expression, expect(";"), forspec3);
  }
  function forspec3(type) {
    if (type != ")") cont(expression);
  }
  function functiondef(type, value) {
    if (value == "*") {cx.marked = "keyword"; return cont(functiondef);}
    if (type == "variable") {register(value); return cont(functiondef);}
    if (type == "(") return cont(pushcontext, pushlex(")"), commasep(funarg, ")"), poplex, mayberettype, statement, popcontext);
    if (isTS && value == "<") return cont(pushlex(">"), commasep(typeparam, ">"), poplex, functiondef)
  }
  function funarg(type, value) {
    if (value == "@") cont(expression, funarg)
    if (type == "spread") return cont(funarg);
    if (isTS && isModifier(value)) { cx.marked = "keyword"; return cont(funarg); }
    return pass(pattern, maybetype, maybeAssign);
  }
  function classExpression(type, value) {
    // Class expressions may have an optional name.
    if (type == "variable") return className(type, value);
    return classNameAfter(type, value);
  }
  function className(type, value) {
    if (type == "variable") {register(value); return cont(classNameAfter);}
  }
  function classNameAfter(type, value) {
    if (value == "<") return cont(pushlex(">"), commasep(typeparam, ">"), poplex, classNameAfter)
    if (value == "extends" || value == "implements" || (isTS && type == ",")) {
      if (value == "implements") cx.marked = "keyword";
      return cont(isTS ? typeexpr : expression, classNameAfter);
    }
    if (type == "{") return cont(pushlex("}"), classBody, poplex);
  }
  function classBody(type, value) {
    if (type == "async" ||
        (type == "variable" &&
         (value == "static" || value == "get" || value == "set" || (isTS && isModifier(value))) &&
         cx.stream.match(/^\s+[\w$\xa1-\uffff]/, false))) {
      cx.marked = "keyword";
      return cont(classBody);
    }
    if (type == "variable" || cx.style == "keyword") {
      cx.marked = "property";
      return cont(isTS ? classfield : functiondef, classBody);
    }
    if (type == "[")
      return cont(expression, maybetype, expect("]"), isTS ? classfield : functiondef, classBody)
    if (value == "*") {
      cx.marked = "keyword";
      return cont(classBody);
    }
    if (type == ";") return cont(classBody);
    if (type == "}") return cont();
    if (value == "@") return cont(expression, classBody)
  }
  function classfield(type, value) {
    if (value == "?") return cont(classfield)
    if (type == ":") return cont(typeexpr, maybeAssign)
    if (value == "=") return cont(expressionNoComma)
    return pass(functiondef)
  }
  function afterExport(type, value) {
    if (value == "*") { cx.marked = "keyword"; return cont(maybeFrom, expect(";")); }
    if (value == "default") { cx.marked = "keyword"; return cont(expression, expect(";")); }
    if (type == "{") return cont(commasep(exportField, "}"), maybeFrom, expect(";"));
    return pass(statement);
  }
  function exportField(type, value) {
    if (value == "as") { cx.marked = "keyword"; return cont(expect("variable")); }
    if (type == "variable") return pass(expressionNoComma, exportField);
  }
  function afterImport(type) {
    if (type == "string") return cont();
    return pass(importSpec, maybeMoreImports, maybeFrom);
  }
  function importSpec(type, value) {
    if (type == "{") return contCommasep(importSpec, "}");
    if (type == "variable") register(value);
    if (value == "*") cx.marked = "keyword";
    return cont(maybeAs);
  }
  function maybeMoreImports(type) {
    if (type == ",") return cont(importSpec, maybeMoreImports)
  }
  function maybeAs(_type, value) {
    if (value == "as") { cx.marked = "keyword"; return cont(importSpec); }
  }
  function maybeFrom(_type, value) {
    if (value == "from") { cx.marked = "keyword"; return cont(expression); }
  }
  function arrayLiteral(type) {
    if (type == "]") return cont();
    return pass(commasep(expressionNoComma, "]"));
  }
  function enumdef() {
    return pass(pushlex("form"), pattern, expect("{"), pushlex("}"), commasep(enummember, "}"), poplex, poplex)
  }
  function enummember() {
    return pass(pattern, maybeAssign);
  }

  function isContinuedStatement(state, textAfter) {
    return state.lastType == "operator" || state.lastType == "," ||
      isOperatorChar.test(textAfter.charAt(0)) ||
      /[,.]/.test(textAfter.charAt(0));
  }

  function expressionAllowed(stream, state, backUp) {
    return state.tokenize == tokenBase &&
      /^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(state.lastType) ||
      (state.lastType == "quasi" && /\{\s*$/.test(stream.string.slice(0, stream.pos - (backUp || 0))))
  }

  // Interface

  return {
    startState: function(basecolumn) {
      var state = {
        tokenize: tokenBase,
        lastType: "sof",
        cc: [],
        lexical: new JSLexical((basecolumn || 0) - indentUnit, 0, "block", false),
        localVars: parserConfig.localVars,
        context: parserConfig.localVars && {vars: parserConfig.localVars},
        indented: basecolumn || 0
      };
      if (parserConfig.globalVars && typeof parserConfig.globalVars == "object")
        state.globalVars = parserConfig.globalVars;
      return state;
    },

    token: function(stream, state) {
      if (stream.sol()) {
        if (!state.lexical.hasOwnProperty("align"))
          state.lexical.align = false;
        state.indented = stream.indentation();
        findFatArrow(stream, state);
      }
      if (state.tokenize != tokenComment && stream.eatSpace()) return null;
      var style = state.tokenize(stream, state);
      if (type == "comment") return style;
      state.lastType = type == "operator" && (content == "++" || content == "--") ? "incdec" : type;
      return parseJS(state, style, type, content, stream);
    },

    indent: function(state, textAfter) {
      if (state.tokenize == tokenComment) return CodeMirror.Pass;
      if (state.tokenize != tokenBase) return 0;
      var firstChar = textAfter && textAfter.charAt(0), lexical = state.lexical, top
      // Kludge to prevent 'maybelse' from blocking lexical scope pops
      if (!/^\s*else\b/.test(textAfter)) for (var i = state.cc.length - 1; i >= 0; --i) {
        var c = state.cc[i];
        if (c == poplex) lexical = lexical.prev;
        else if (c != maybeelse) break;
      }
      while ((lexical.type == "stat" || lexical.type == "form") &&
             (firstChar == "}" || ((top = state.cc[state.cc.length - 1]) &&
                                   (top == maybeoperatorComma || top == maybeoperatorNoComma) &&
                                   !/^[,\.=+\-*:?[\(]/.test(textAfter))))
        lexical = lexical.prev;
      if (statementIndent && lexical.type == ")" && lexical.prev.type == "stat")
        lexical = lexical.prev;
      var type = lexical.type, closing = firstChar == type;

      if (type == "vardef") return lexical.indented + (state.lastType == "operator" || state.lastType == "," ? lexical.info + 1 : 0);
      else if (type == "form" && firstChar == "{") return lexical.indented;
      else if (type == "form") return lexical.indented + indentUnit;
      else if (type == "stat")
        return lexical.indented + (isContinuedStatement(state, textAfter) ? statementIndent || indentUnit : 0);
      else if (lexical.info == "switch" && !closing && parserConfig.doubleIndentSwitch != false)
        return lexical.indented + (/^(?:case|default)\b/.test(textAfter) ? indentUnit : 2 * indentUnit);
      else if (lexical.align) return lexical.column + (closing ? 0 : 1);
      else return lexical.indented + (closing ? 0 : indentUnit);
    },

    electricInput: /^\s*(?:case .*?:|default:|\{|\})$/,
    blockCommentStart: jsonMode ? null : "/*",
    blockCommentEnd: jsonMode ? null : "*/",
    blockCommentContinue: jsonMode ? null : " * ",
    lineComment: jsonMode ? null : "//",
    fold: "brace",
    closeBrackets: "()[]{}''\"\"``",

    helperType: jsonMode ? "json" : "javascript",
    jsonldMode: jsonldMode,
    jsonMode: jsonMode,

    expressionAllowed: expressionAllowed,

    skipExpression: function(state) {
      var top = state.cc[state.cc.length - 1]
      if (top == expression || top == expressionNoComma) state.cc.pop()
    }
  };
});

CodeMirror.registerHelper("wordChars", "javascript", /[\w$]/);

CodeMirror.defineMIME("text/javascript", "javascript");
CodeMirror.defineMIME("text/ecmascript", "javascript");
CodeMirror.defineMIME("application/javascript", "javascript");
CodeMirror.defineMIME("application/x-javascript", "javascript");
CodeMirror.defineMIME("application/ecmascript", "javascript");
CodeMirror.defineMIME("application/json", {name: "javascript", json: true});
CodeMirror.defineMIME("application/x-json", {name: "javascript", json: true});
CodeMirror.defineMIME("application/ld+json", {name: "javascript", jsonld: true});
CodeMirror.defineMIME("text/typescript", { name: "javascript", typescript: true });
CodeMirror.defineMIME("application/typescript", { name: "javascript", typescript: true });

});


if (window) window.__currentScriptPath = "/framework/common/codemirror/mode/xml/xml.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
"use strict";

var htmlConfig = {
  autoSelfClosers: {'area': true, 'base': true, 'br': true, 'col': true, 'command': true,
                    'embed': true, 'frame': true, 'hr': true, 'img': true, 'input': true,
                    'keygen': true, 'link': true, 'meta': true, 'param': true, 'source': true,
                    'track': true, 'wbr': true, 'menuitem': true},
  implicitlyClosed: {'dd': true, 'li': true, 'optgroup': true, 'option': true, 'p': true,
                     'rp': true, 'rt': true, 'tbody': true, 'td': true, 'tfoot': true,
                     'th': true, 'tr': true},
  contextGrabbers: {
    'dd': {'dd': true, 'dt': true},
    'dt': {'dd': true, 'dt': true},
    'li': {'li': true},
    'option': {'option': true, 'optgroup': true},
    'optgroup': {'optgroup': true},
    'p': {'address': true, 'article': true, 'aside': true, 'blockquote': true, 'dir': true,
          'div': true, 'dl': true, 'fieldset': true, 'footer': true, 'form': true,
          'h1': true, 'h2': true, 'h3': true, 'h4': true, 'h5': true, 'h6': true,
          'header': true, 'hgroup': true, 'hr': true, 'menu': true, 'nav': true, 'ol': true,
          'p': true, 'pre': true, 'section': true, 'table': true, 'ul': true},
    'rp': {'rp': true, 'rt': true},
    'rt': {'rp': true, 'rt': true},
    'tbody': {'tbody': true, 'tfoot': true},
    'td': {'td': true, 'th': true},
    'tfoot': {'tbody': true},
    'th': {'td': true, 'th': true},
    'thead': {'tbody': true, 'tfoot': true},
    'tr': {'tr': true}
  },
  doNotIndent: {"pre": true},
  allowUnquoted: true,
  allowMissing: true,
  caseFold: true
}

var xmlConfig = {
  autoSelfClosers: {},
  implicitlyClosed: {},
  contextGrabbers: {},
  doNotIndent: {},
  allowUnquoted: false,
  allowMissing: false,
  allowMissingTagName: false,
  caseFold: false
}

CodeMirror.defineMode("xml", function(editorConf, config_) {
  var indentUnit = editorConf.indentUnit
  var config = {}
  var defaults = config_.htmlMode ? htmlConfig : xmlConfig
  for (var prop in defaults) config[prop] = defaults[prop]
  for (var prop in config_) config[prop] = config_[prop]

  // Return variables for tokenizers
  var type, setStyle;

  function inText(stream, state) {
    function chain(parser) {
      state.tokenize = parser;
      return parser(stream, state);
    }

    var ch = stream.next();
    if (ch == "<") {
      if (stream.eat("!")) {
        if (stream.eat("[")) {
          if (stream.match("CDATA[")) return chain(inBlock("atom", "]]>"));
          else return null;
        } else if (stream.match("--")) {
          return chain(inBlock("comment", "-->"));
        } else if (stream.match("DOCTYPE", true, true)) {
          stream.eatWhile(/[\w\._\-]/);
          return chain(doctype(1));
        } else {
          return null;
        }
      } else if (stream.eat("?")) {
        stream.eatWhile(/[\w\._\-]/);
        state.tokenize = inBlock("meta", "?>");
        return "meta";
      } else {
        type = stream.eat("/") ? "closeTag" : "openTag";
        state.tokenize = inTag;
        return "tag bracket";
      }
    } else if (ch == "&") {
      var ok;
      if (stream.eat("#")) {
        if (stream.eat("x")) {
          ok = stream.eatWhile(/[a-fA-F\d]/) && stream.eat(";");
        } else {
          ok = stream.eatWhile(/[\d]/) && stream.eat(";");
        }
      } else {
        ok = stream.eatWhile(/[\w\.\-:]/) && stream.eat(";");
      }
      return ok ? "atom" : "error";
    } else {
      stream.eatWhile(/[^&<]/);
      return null;
    }
  }
  inText.isInText = true;

  function inTag(stream, state) {
    var ch = stream.next();
    if (ch == ">" || (ch == "/" && stream.eat(">"))) {
      state.tokenize = inText;
      type = ch == ">" ? "endTag" : "selfcloseTag";
      return "tag bracket";
    } else if (ch == "=") {
      type = "equals";
      return null;
    } else if (ch == "<") {
      state.tokenize = inText;
      state.state = baseState;
      state.tagName = state.tagStart = null;
      var next = state.tokenize(stream, state);
      return next ? next + " tag error" : "tag error";
    } else if (/[\'\"]/.test(ch)) {
      state.tokenize = inAttribute(ch);
      state.stringStartCol = stream.column();
      return state.tokenize(stream, state);
    } else {
      stream.match(/^[^\s\u00a0=<>\"\']*[^\s\u00a0=<>\"\'\/]/);
      return "word";
    }
  }

  function inAttribute(quote) {
    var closure = function(stream, state) {
      while (!stream.eol()) {
        if (stream.next() == quote) {
          state.tokenize = inTag;
          break;
        }
      }
      return "string";
    };
    closure.isInAttribute = true;
    return closure;
  }

  function inBlock(style, terminator) {
    return function(stream, state) {
      while (!stream.eol()) {
        if (stream.match(terminator)) {
          state.tokenize = inText;
          break;
        }
        stream.next();
      }
      return style;
    };
  }
  function doctype(depth) {
    return function(stream, state) {
      var ch;
      while ((ch = stream.next()) != null) {
        if (ch == "<") {
          state.tokenize = doctype(depth + 1);
          return state.tokenize(stream, state);
        } else if (ch == ">") {
          if (depth == 1) {
            state.tokenize = inText;
            break;
          } else {
            state.tokenize = doctype(depth - 1);
            return state.tokenize(stream, state);
          }
        }
      }
      return "meta";
    };
  }

  function Context(state, tagName, startOfLine) {
    this.prev = state.context;
    this.tagName = tagName;
    this.indent = state.indented;
    this.startOfLine = startOfLine;
    if (config.doNotIndent.hasOwnProperty(tagName) || (state.context && state.context.noIndent))
      this.noIndent = true;
  }
  function popContext(state) {
    if (state.context) state.context = state.context.prev;
  }
  function maybePopContext(state, nextTagName) {
    var parentTagName;
    while (true) {
      if (!state.context) {
        return;
      }
      parentTagName = state.context.tagName;
      if (!config.contextGrabbers.hasOwnProperty(parentTagName) ||
          !config.contextGrabbers[parentTagName].hasOwnProperty(nextTagName)) {
        return;
      }
      popContext(state);
    }
  }

  function baseState(type, stream, state) {
    if (type == "openTag") {
      state.tagStart = stream.column();
      return tagNameState;
    } else if (type == "closeTag") {
      return closeTagNameState;
    } else {
      return baseState;
    }
  }
  function tagNameState(type, stream, state) {
    if (type == "word") {
      state.tagName = stream.current();
      setStyle = "tag";
      return attrState;
    } else if (config.allowMissingTagName && type == "endTag") {
      setStyle = "tag bracket";
      return attrState(type, stream, state);
    } else {
      setStyle = "error";
      return tagNameState;
    }
  }
  function closeTagNameState(type, stream, state) {
    if (type == "word") {
      var tagName = stream.current();
      if (state.context && state.context.tagName != tagName &&
          config.implicitlyClosed.hasOwnProperty(state.context.tagName))
        popContext(state);
      if ((state.context && state.context.tagName == tagName) || config.matchClosing === false) {
        setStyle = "tag";
        return closeState;
      } else {
        setStyle = "tag error";
        return closeStateErr;
      }
    } else if (config.allowMissingTagName && type == "endTag") {
      setStyle = "tag bracket";
      return closeState(type, stream, state);
    } else {
      setStyle = "error";
      return closeStateErr;
    }
  }

  function closeState(type, _stream, state) {
    if (type != "endTag") {
      setStyle = "error";
      return closeState;
    }
    popContext(state);
    return baseState;
  }
  function closeStateErr(type, stream, state) {
    setStyle = "error";
    return closeState(type, stream, state);
  }

  function attrState(type, _stream, state) {
    if (type == "word") {
      setStyle = "attribute";
      return attrEqState;
    } else if (type == "endTag" || type == "selfcloseTag") {
      var tagName = state.tagName, tagStart = state.tagStart;
      state.tagName = state.tagStart = null;
      if (type == "selfcloseTag" ||
          config.autoSelfClosers.hasOwnProperty(tagName)) {
        maybePopContext(state, tagName);
      } else {
        maybePopContext(state, tagName);
        state.context = new Context(state, tagName, tagStart == state.indented);
      }
      return baseState;
    }
    setStyle = "error";
    return attrState;
  }
  function attrEqState(type, stream, state) {
    if (type == "equals") return attrValueState;
    if (!config.allowMissing) setStyle = "error";
    return attrState(type, stream, state);
  }
  function attrValueState(type, stream, state) {
    if (type == "string") return attrContinuedState;
    if (type == "word" && config.allowUnquoted) {setStyle = "string"; return attrState;}
    setStyle = "error";
    return attrState(type, stream, state);
  }
  function attrContinuedState(type, stream, state) {
    if (type == "string") return attrContinuedState;
    return attrState(type, stream, state);
  }

  return {
    startState: function(baseIndent) {
      var state = {tokenize: inText,
                   state: baseState,
                   indented: baseIndent || 0,
                   tagName: null, tagStart: null,
                   context: null}
      if (baseIndent != null) state.baseIndent = baseIndent
      return state
    },

    token: function(stream, state) {
      if (!state.tagName && stream.sol())
        state.indented = stream.indentation();

      if (stream.eatSpace()) return null;
      type = null;
      var style = state.tokenize(stream, state);
      if ((style || type) && style != "comment") {
        setStyle = null;
        state.state = state.state(type || style, stream, state);
        if (setStyle)
          style = setStyle == "error" ? style + " error" : setStyle;
      }
      return style;
    },

    indent: function(state, textAfter, fullLine) {
      var context = state.context;
      // Indent multi-line strings (e.g. css).
      if (state.tokenize.isInAttribute) {
        if (state.tagStart == state.indented)
          return state.stringStartCol + 1;
        else
          return state.indented + indentUnit;
      }
      if (context && context.noIndent) return CodeMirror.Pass;
      if (state.tokenize != inTag && state.tokenize != inText)
        return fullLine ? fullLine.match(/^(\s*)/)[0].length : 0;
      // Indent the starts of attribute names.
      if (state.tagName) {
        if (config.multilineTagIndentPastTag !== false)
          return state.tagStart + state.tagName.length + 2;
        else
          return state.tagStart + indentUnit * (config.multilineTagIndentFactor || 1);
      }
      if (config.alignCDATA && /<!\[CDATA\[/.test(textAfter)) return 0;
      var tagAfter = textAfter && /^<(\/)?([\w_:\.-]*)/.exec(textAfter);
      if (tagAfter && tagAfter[1]) { // Closing tag spotted
        while (context) {
          if (context.tagName == tagAfter[2]) {
            context = context.prev;
            break;
          } else if (config.implicitlyClosed.hasOwnProperty(context.tagName)) {
            context = context.prev;
          } else {
            break;
          }
        }
      } else if (tagAfter) { // Opening tag spotted
        while (context) {
          var grabbers = config.contextGrabbers[context.tagName];
          if (grabbers && grabbers.hasOwnProperty(tagAfter[2]))
            context = context.prev;
          else
            break;
        }
      }
      while (context && context.prev && !context.startOfLine)
        context = context.prev;
      if (context) return context.indent + indentUnit;
      else return state.baseIndent || 0;
    },

    electricInput: /<\/[\s\w:]+>$/,
    blockCommentStart: "<!--",
    blockCommentEnd: "-->",

    configuration: config.htmlMode ? "html" : "xml",
    helperType: config.htmlMode ? "html" : "xml",

    skipAttribute: function(state) {
      if (state.state == attrValueState)
        state.state = attrState
    }
  };
});

CodeMirror.defineMIME("text/xml", "xml");
CodeMirror.defineMIME("application/xml", "xml");
if (!CodeMirror.mimeModes.hasOwnProperty("text/html"))
  CodeMirror.defineMIME("text/html", {name: "xml", htmlMode: true});

});


if (window) window.__currentScriptPath = "/framework/common/codemirror/mode/htmlmixed/htmlmixed.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"), require("../xml/xml"), require("../javascript/javascript"), require("../css/css"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror", "../xml/xml", "../javascript/javascript", "../css/css"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
  "use strict";

  var defaultTags = {
    script: [
      ["lang", /(javascript|babel)/i, "javascript"],
      ["type", /^(?:text|application)\/(?:x-)?(?:java|ecma)script$|^module$|^$/i, "javascript"],
      ["type", /./, "text/plain"],
      [null, null, "javascript"]
    ],
    style:  [
      ["lang", /^css$/i, "css"],
      ["type", /^(text\/)?(x-)?(stylesheet|css)$/i, "css"],
      ["type", /./, "text/plain"],
      [null, null, "css"]
    ]
  };

  function maybeBackup(stream, pat, style) {
    var cur = stream.current(), close = cur.search(pat);
    if (close > -1) {
      stream.backUp(cur.length - close);
    } else if (cur.match(/<\/?$/)) {
      stream.backUp(cur.length);
      if (!stream.match(pat, false)) stream.match(cur);
    }
    return style;
  }

  var attrRegexpCache = {};
  function getAttrRegexp(attr) {
    var regexp = attrRegexpCache[attr];
    if (regexp) return regexp;
    return attrRegexpCache[attr] = new RegExp("\\s+" + attr + "\\s*=\\s*('|\")?([^'\"]+)('|\")?\\s*");
  }

  function getAttrValue(text, attr) {
    var match = text.match(getAttrRegexp(attr))
    return match ? /^\s*(.*?)\s*$/.exec(match[2])[1] : ""
  }

  function getTagRegexp(tagName, anchored) {
    return new RegExp((anchored ? "^" : "") + "<\/\s*" + tagName + "\s*>", "i");
  }

  function addTags(from, to) {
    for (var tag in from) {
      var dest = to[tag] || (to[tag] = []);
      var source = from[tag];
      for (var i = source.length - 1; i >= 0; i--)
        dest.unshift(source[i])
    }
  }

  function findMatchingMode(tagInfo, tagText) {
    for (var i = 0; i < tagInfo.length; i++) {
      var spec = tagInfo[i];
      if (!spec[0] || spec[1].test(getAttrValue(tagText, spec[0]))) return spec[2];
    }
  }

  CodeMirror.defineMode("htmlmixed", function (config, parserConfig) {
    var htmlMode = CodeMirror.getMode(config, {
      name: "xml",
      htmlMode: true,
      multilineTagIndentFactor: parserConfig.multilineTagIndentFactor,
      multilineTagIndentPastTag: parserConfig.multilineTagIndentPastTag
    });

    var tags = {};
    var configTags = parserConfig && parserConfig.tags, configScript = parserConfig && parserConfig.scriptTypes;
    addTags(defaultTags, tags);
    if (configTags) addTags(configTags, tags);
    if (configScript) for (var i = configScript.length - 1; i >= 0; i--)
      tags.script.unshift(["type", configScript[i].matches, configScript[i].mode])

    function html(stream, state) {
      var style = htmlMode.token(stream, state.htmlState), tag = /\btag\b/.test(style), tagName
      if (tag && !/[<>\s\/]/.test(stream.current()) &&
          (tagName = state.htmlState.tagName && state.htmlState.tagName.toLowerCase()) &&
          tags.hasOwnProperty(tagName)) {
        state.inTag = tagName + " "
      } else if (state.inTag && tag && />$/.test(stream.current())) {
        var inTag = /^([\S]+) (.*)/.exec(state.inTag)
        state.inTag = null
        var modeSpec = stream.current() == ">" && findMatchingMode(tags[inTag[1]], inTag[2])
        var mode = CodeMirror.getMode(config, modeSpec)
        var endTagA = getTagRegexp(inTag[1], true), endTag = getTagRegexp(inTag[1], false);
        state.token = function (stream, state) {
          if (stream.match(endTagA, false)) {
            state.token = html;
            state.localState = state.localMode = null;
            return null;
          }
          return maybeBackup(stream, endTag, state.localMode.token(stream, state.localState));
        };
        state.localMode = mode;
        state.localState = CodeMirror.startState(mode, htmlMode.indent(state.htmlState, ""));
      } else if (state.inTag) {
        state.inTag += stream.current()
        if (stream.eol()) state.inTag += " "
      }
      return style;
    };

    return {
      startState: function () {
        var state = CodeMirror.startState(htmlMode);
        return {token: html, inTag: null, localMode: null, localState: null, htmlState: state};
      },

      copyState: function (state) {
        var local;
        if (state.localState) {
          local = CodeMirror.copyState(state.localMode, state.localState);
        }
        return {token: state.token, inTag: state.inTag,
                localMode: state.localMode, localState: local,
                htmlState: CodeMirror.copyState(htmlMode, state.htmlState)};
      },

      token: function (stream, state) {
        return state.token(stream, state);
      },

      indent: function (state, textAfter, line) {
        if (!state.localMode || /^\s*<\//.test(textAfter))
          return htmlMode.indent(state.htmlState, textAfter);
        else if (state.localMode.indent)
          return state.localMode.indent(state.localState, textAfter, line);
        else
          return CodeMirror.Pass;
      },

      innerMode: function (state) {
        return {state: state.localState || state.htmlState, mode: state.localMode || htmlMode};
      }
    };
  }, "xml", "javascript", "css");

  CodeMirror.defineMIME("text/html", "htmlmixed");
});


if (window) window.__currentScriptPath = "/framework/common/codemirror/addon/hint/show-hint.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
  "use strict";

  var HINT_ELEMENT_CLASS        = "CodeMirror-hint";
  var ACTIVE_HINT_ELEMENT_CLASS = "CodeMirror-hint-active";

  // This is the old interface, kept around for now to stay
  // backwards-compatible.
  CodeMirror.showHint = function(cm, getHints, options) {
    if (!getHints) return cm.showHint(options);
    if (options && options.async) getHints.async = true;
    var newOpts = {hint: getHints};
    if (options) for (var prop in options) newOpts[prop] = options[prop];
    return cm.showHint(newOpts);
  };

  CodeMirror.defineExtension("showHint", function(options) {
    options = parseOptions(this, this.getCursor("start"), options);
    var selections = this.listSelections()
    if (selections.length > 1) return;
    // By default, don't allow completion when something is selected.
    // A hint function can have a `supportsSelection` property to
    // indicate that it can handle selections.
    if (this.somethingSelected()) {
      if (!options.hint.supportsSelection) return;
      // Don't try with cross-line selections
      for (var i = 0; i < selections.length; i++)
        if (selections[i].head.line != selections[i].anchor.line) return;
    }

    if (this.state.completionActive) this.state.completionActive.close();
    var completion = this.state.completionActive = new Completion(this, options);
    if (!completion.options.hint) return;

    CodeMirror.signal(this, "startCompletion", this);
    completion.update(true);
  });

  function Completion(cm, options) {
    this.cm = cm;
    this.options = options;
    this.widget = null;
    this.debounce = 0;
    this.tick = 0;
    this.startPos = this.cm.getCursor("start");
    this.startLen = this.cm.getLine(this.startPos.line).length - this.cm.getSelection().length;

    var self = this;
    cm.on("cursorActivity", this.activityFunc = function() { self.cursorActivity(); });
  }

  var requestAnimationFrame = window.requestAnimationFrame || function(fn) {
    return setTimeout(fn, 1000/60);
  };
  var cancelAnimationFrame = window.cancelAnimationFrame || clearTimeout;

  Completion.prototype = {
    close: function() {
      if (!this.active()) return;
      this.cm.state.completionActive = null;
      this.tick = null;
      this.cm.off("cursorActivity", this.activityFunc);

      if (this.widget && this.data) CodeMirror.signal(this.data, "close");
      if (this.widget) this.widget.close();
      CodeMirror.signal(this.cm, "endCompletion", this.cm);
    },

    active: function() {
      return this.cm.state.completionActive == this;
    },

    pick: function(data, i) {
      var completion = data.list[i];
      if (completion.hint) completion.hint(this.cm, data, completion);
      else this.cm.replaceRange(getText(completion), completion.from || data.from,
                                completion.to || data.to, "complete");
      CodeMirror.signal(data, "pick", completion);
      this.close();
    },

    cursorActivity: function() {
      if (this.debounce) {
        cancelAnimationFrame(this.debounce);
        this.debounce = 0;
      }

      var pos = this.cm.getCursor(), line = this.cm.getLine(pos.line);
      if (pos.line != this.startPos.line || line.length - pos.ch != this.startLen - this.startPos.ch ||
          pos.ch < this.startPos.ch || this.cm.somethingSelected() ||
          (pos.ch && this.options.closeCharacters.test(line.charAt(pos.ch - 1)))) {
        this.close();
      } else {
        var self = this;
        this.debounce = requestAnimationFrame(function() {self.update();});
        if (this.widget) this.widget.disable();
      }
    },

    update: function(first) {
      if (this.tick == null) return
      var self = this, myTick = ++this.tick
      fetchHints(this.options.hint, this.cm, this.options, function(data) {
        if (self.tick == myTick) self.finishUpdate(data, first)
      })
    },

    finishUpdate: function(data, first) {
      if (this.data) CodeMirror.signal(this.data, "update");

      var picked = (this.widget && this.widget.picked) || (first && this.options.completeSingle);
      if (this.widget) this.widget.close();

      this.data = data;

      if (data && data.list.length) {
        if (picked && data.list.length == 1) {
          this.pick(data, 0);
        } else {
          this.widget = new Widget(this, data);
          CodeMirror.signal(data, "shown");
        }
      }
    }
  };

  function parseOptions(cm, pos, options) {
    var editor = cm.options.hintOptions;
    var out = {};
    for (var prop in defaultOptions) out[prop] = defaultOptions[prop];
    if (editor) for (var prop in editor)
      if (editor[prop] !== undefined) out[prop] = editor[prop];
    if (options) for (var prop in options)
      if (options[prop] !== undefined) out[prop] = options[prop];
    if (out.hint.resolve) out.hint = out.hint.resolve(cm, pos)
    return out;
  }

  function getText(completion) {
    if (typeof completion == "string") return completion;
    else return completion.text;
  }

  function buildKeyMap(completion, handle) {
    var baseMap = {
      Up: function() {handle.moveFocus(-1);},
      Down: function() {handle.moveFocus(1);},
      PageUp: function() {handle.moveFocus(-handle.menuSize() + 1, true);},
      PageDown: function() {handle.moveFocus(handle.menuSize() - 1, true);},
      Home: function() {handle.setFocus(0);},
      End: function() {handle.setFocus(handle.length - 1);},
      Enter: handle.pick,
      Tab: handle.pick,
      Esc: handle.close
    };
    var custom = completion.options.customKeys;
    var ourMap = custom ? {} : baseMap;
    function addBinding(key, val) {
      var bound;
      if (typeof val != "string")
        bound = function(cm) { return val(cm, handle); };
      // This mechanism is deprecated
      else if (baseMap.hasOwnProperty(val))
        bound = baseMap[val];
      else
        bound = val;
      ourMap[key] = bound;
    }
    if (custom)
      for (var key in custom) if (custom.hasOwnProperty(key))
        addBinding(key, custom[key]);
    var extra = completion.options.extraKeys;
    if (extra)
      for (var key in extra) if (extra.hasOwnProperty(key))
        addBinding(key, extra[key]);
    return ourMap;
  }

  function getHintElement(hintsElement, el) {
    while (el && el != hintsElement) {
      if (el.nodeName.toUpperCase() === "LI" && el.parentNode == hintsElement) return el;
      el = el.parentNode;
    }
  }

  function Widget(completion, data) {
    this.completion = completion;
    this.data = data;
    this.picked = false;
    var widget = this, cm = completion.cm;

    var hints = this.hints = document.createElement("ul");
    hints.className = "CodeMirror-hints";
    this.selectedHint = data.selectedHint || 0;

    var completions = data.list;
    for (var i = 0; i < completions.length; ++i) {
      var elt = hints.appendChild(document.createElement("li")), cur = completions[i];
      var className = HINT_ELEMENT_CLASS + (i != this.selectedHint ? "" : " " + ACTIVE_HINT_ELEMENT_CLASS);
      if (cur.className != null) className = cur.className + " " + className;
      elt.className = className;
      if (cur.render) cur.render(elt, data, cur);
      else elt.appendChild(document.createTextNode(cur.displayText || getText(cur)));
      elt.hintId = i;
    }

    var pos = cm.cursorCoords(completion.options.alignWithWord ? data.from : null);
    var left = pos.left, top = pos.bottom, below = true;
    hints.style.left = left + "px";
    hints.style.top = top + "px";
    // If we're at the edge of the screen, then we want the menu to appear on the left of the cursor.
    var winW = window.innerWidth || Math.max(document.body.offsetWidth, document.documentElement.offsetWidth);
    var winH = window.innerHeight || Math.max(document.body.offsetHeight, document.documentElement.offsetHeight);
    (completion.options.container || document.body).appendChild(hints);
    var box = hints.getBoundingClientRect(), overlapY = box.bottom - winH;
    var scrolls = hints.scrollHeight > hints.clientHeight + 1
    var startScroll = cm.getScrollInfo();

    if (overlapY > 0) {
      var height = box.bottom - box.top, curTop = pos.top - (pos.bottom - box.top);
      if (curTop - height > 0) { // Fits above cursor
        hints.style.top = (top = pos.top - height) + "px";
        below = false;
      } else if (height > winH) {
        hints.style.height = (winH - 5) + "px";
        hints.style.top = (top = pos.bottom - box.top) + "px";
        var cursor = cm.getCursor();
        if (data.from.ch != cursor.ch) {
          pos = cm.cursorCoords(cursor);
          hints.style.left = (left = pos.left) + "px";
          box = hints.getBoundingClientRect();
        }
      }
    }
    var overlapX = box.right - winW;
    if (overlapX > 0) {
      if (box.right - box.left > winW) {
        hints.style.width = (winW - 5) + "px";
        overlapX -= (box.right - box.left) - winW;
      }
      hints.style.left = (left = pos.left - overlapX) + "px";
    }
    if (scrolls) for (var node = hints.firstChild; node; node = node.nextSibling)
      node.style.paddingRight = cm.display.nativeBarWidth + "px"

    cm.addKeyMap(this.keyMap = buildKeyMap(completion, {
      moveFocus: function(n, avoidWrap) { widget.changeActive(widget.selectedHint + n, avoidWrap); },
      setFocus: function(n) { widget.changeActive(n); },
      menuSize: function() { return widget.screenAmount(); },
      length: completions.length,
      close: function() { completion.close(); },
      pick: function() { widget.pick(); },
      data: data
    }));

    if (completion.options.closeOnUnfocus) {
      var closingOnBlur;
      cm.on("blur", this.onBlur = function() { closingOnBlur = setTimeout(function() { completion.close(); }, 100); });
      cm.on("focus", this.onFocus = function() { clearTimeout(closingOnBlur); });
    }

    cm.on("scroll", this.onScroll = function() {
      var curScroll = cm.getScrollInfo(), editor = cm.getWrapperElement().getBoundingClientRect();
      var newTop = top + startScroll.top - curScroll.top;
      var point = newTop - (window.pageYOffset || (document.documentElement || document.body).scrollTop);
      if (!below) point += hints.offsetHeight;
      if (point <= editor.top || point >= editor.bottom) return completion.close();
      hints.style.top = newTop + "px";
      hints.style.left = (left + startScroll.left - curScroll.left) + "px";
    });

    CodeMirror.on(hints, "dblclick", function(e) {
      var t = getHintElement(hints, e.target || e.srcElement);
      if (t && t.hintId != null) {widget.changeActive(t.hintId); widget.pick();}
    });

    CodeMirror.on(hints, "click", function(e) {
      var t = getHintElement(hints, e.target || e.srcElement);
      if (t && t.hintId != null) {
        widget.changeActive(t.hintId);
        if (completion.options.completeOnSingleClick) widget.pick();
      }
    });

    CodeMirror.on(hints, "mousedown", function() {
      setTimeout(function(){cm.focus();}, 20);
    });

    CodeMirror.signal(data, "select", completions[this.selectedHint], hints.childNodes[this.selectedHint]);
    return true;
  }

  Widget.prototype = {
    close: function() {
      if (this.completion.widget != this) return;
      this.completion.widget = null;
      this.hints.parentNode.removeChild(this.hints);
      this.completion.cm.removeKeyMap(this.keyMap);

      var cm = this.completion.cm;
      if (this.completion.options.closeOnUnfocus) {
        cm.off("blur", this.onBlur);
        cm.off("focus", this.onFocus);
      }
      cm.off("scroll", this.onScroll);
    },

    disable: function() {
      this.completion.cm.removeKeyMap(this.keyMap);
      var widget = this;
      this.keyMap = {Enter: function() { widget.picked = true; }};
      this.completion.cm.addKeyMap(this.keyMap);
    },

    pick: function() {
      this.completion.pick(this.data, this.selectedHint);
    },

    changeActive: function(i, avoidWrap) {
      if (i >= this.data.list.length)
        i = avoidWrap ? this.data.list.length - 1 : 0;
      else if (i < 0)
        i = avoidWrap ? 0  : this.data.list.length - 1;
      if (this.selectedHint == i) return;
      var node = this.hints.childNodes[this.selectedHint];
      node.className = node.className.replace(" " + ACTIVE_HINT_ELEMENT_CLASS, "");
      node = this.hints.childNodes[this.selectedHint = i];
      node.className += " " + ACTIVE_HINT_ELEMENT_CLASS;
      if (node.offsetTop < this.hints.scrollTop)
        this.hints.scrollTop = node.offsetTop - 3;
      else if (node.offsetTop + node.offsetHeight > this.hints.scrollTop + this.hints.clientHeight)
        this.hints.scrollTop = node.offsetTop + node.offsetHeight - this.hints.clientHeight + 3;
      CodeMirror.signal(this.data, "select", this.data.list[this.selectedHint], node);
    },

    screenAmount: function() {
      return Math.floor(this.hints.clientHeight / this.hints.firstChild.offsetHeight) || 1;
    }
  };

  function applicableHelpers(cm, helpers) {
    if (!cm.somethingSelected()) return helpers
    var result = []
    for (var i = 0; i < helpers.length; i++)
      if (helpers[i].supportsSelection) result.push(helpers[i])
    return result
  }

  function fetchHints(hint, cm, options, callback) {
    if (hint.async) {
      hint(cm, callback, options)
    } else {
      var result = hint(cm, options)
      if (result && result.then) result.then(callback)
      else callback(result)
    }
  }

  function resolveAutoHints(cm, pos) {
    var helpers = cm.getHelpers(pos, "hint"), words
    if (helpers.length) {
      var resolved = function(cm, callback, options) {
        var app = applicableHelpers(cm, helpers);
        function run(i) {
          if (i == app.length) return callback(null)
          fetchHints(app[i], cm, options, function(result) {
            if (result && result.list.length > 0) callback(result)
            else run(i + 1)
          })
        }
        run(0)
      }
      resolved.async = true
      resolved.supportsSelection = true
      return resolved
    } else if (words = cm.getHelper(cm.getCursor(), "hintWords")) {
      return function(cm) { return CodeMirror.hint.fromList(cm, {words: words}) }
    } else if (CodeMirror.hint.anyword) {
      return function(cm, options) { return CodeMirror.hint.anyword(cm, options) }
    } else {
      return function() {}
    }
  }

  CodeMirror.registerHelper("hint", "auto", {
    resolve: resolveAutoHints
  });

  CodeMirror.registerHelper("hint", "fromList", function(cm, options) {
    var cur = cm.getCursor(), token = cm.getTokenAt(cur);
    var to = CodeMirror.Pos(cur.line, token.end);
    if (token.string && /\w/.test(token.string[token.string.length - 1])) {
      var term = token.string, from = CodeMirror.Pos(cur.line, token.start);
    } else {
      var term = "", from = to;
    }
    var found = [];
    for (var i = 0; i < options.words.length; i++) {
      var word = options.words[i];
      if (word.slice(0, term.length) == term)
        found.push(word);
    }

    if (found.length) return {list: found, from: from, to: to};
  });

  CodeMirror.commands.autocomplete = CodeMirror.showHint;

  var defaultOptions = {
    hint: CodeMirror.hint.auto,
    completeSingle: true,
    alignWithWord: true,
    closeCharacters: /[\s()\[\]{};:>,]/,
    closeOnUnfocus: true,
    completeOnSingleClick: true,
    container: null,
    customKeys: null,
    extraKeys: null
  };

  CodeMirror.defineOption("hintOptions", null);
});


if (window) window.__currentScriptPath = "/framework/common/codemirror/addon/hint/css-hint.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"), require("../../mode/css/css"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror", "../../mode/css/css"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
  "use strict";

  var pseudoClasses = {link: 1, visited: 1, active: 1, hover: 1, focus: 1,
                       "first-letter": 1, "first-line": 1, "first-child": 1,
                       before: 1, after: 1, lang: 1};

  CodeMirror.registerHelper("hint", "css", function(cm) {
    var cur = cm.getCursor(), token = cm.getTokenAt(cur);
    var inner = CodeMirror.innerMode(cm.getMode(), token.state);
    if (inner.mode.name != "css") return;

    if (token.type == "keyword" && "!important".indexOf(token.string) == 0)
      return {list: ["!important"], from: CodeMirror.Pos(cur.line, token.start),
              to: CodeMirror.Pos(cur.line, token.end)};

    var start = token.start, end = cur.ch, word = token.string.slice(0, end - start);
    if (/[^\w$_-]/.test(word)) {
      word = ""; start = end = cur.ch;
    }

    var spec = CodeMirror.resolveMode("text/css");

    var result = [];
    function add(keywords) {
      for (var name in keywords)
        if (!word || name.lastIndexOf(word, 0) == 0)
          result.push(name);
    }

    var st = inner.state.state;
    if (st == "pseudo" || token.type == "variable-3") {
      add(pseudoClasses);
    } else if (st == "block" || st == "maybeprop") {
      add(spec.propertyKeywords);
    } else if (st == "prop" || st == "parens" || st == "at" || st == "params") {
      add(spec.valueKeywords);
      add(spec.colorKeywords);
    } else if (st == "media" || st == "media_parens") {
      add(spec.mediaTypes);
      add(spec.mediaFeatures);
    }

    if (result.length) return {
      list: result,
      from: CodeMirror.Pos(cur.line, start),
      to: CodeMirror.Pos(cur.line, end)
    };
  });
});


if (window) window.__currentScriptPath = "/framework/common/codemirror/addon/hint/html-hint.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"), require("./xml-hint"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror", "./xml-hint"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
  "use strict";

  var langs = "ab aa af ak sq am ar an hy as av ae ay az bm ba eu be bn bh bi bs br bg my ca ch ce ny zh cv kw co cr hr cs da dv nl dz en eo et ee fo fj fi fr ff gl ka de el gn gu ht ha he hz hi ho hu ia id ie ga ig ik io is it iu ja jv kl kn kr ks kk km ki rw ky kv kg ko ku kj la lb lg li ln lo lt lu lv gv mk mg ms ml mt mi mr mh mn na nv nb nd ne ng nn no ii nr oc oj cu om or os pa pi fa pl ps pt qu rm rn ro ru sa sc sd se sm sg sr gd sn si sk sl so st es su sw ss sv ta te tg th ti bo tk tl tn to tr ts tt tw ty ug uk ur uz ve vi vo wa cy wo fy xh yi yo za zu".split(" ");
  var targets = ["_blank", "_self", "_top", "_parent"];
  var charsets = ["ascii", "utf-8", "utf-16", "latin1", "latin1"];
  var methods = ["get", "post", "put", "delete"];
  var encs = ["application/x-www-form-urlencoded", "multipart/form-data", "text/plain"];
  var media = ["all", "screen", "print", "embossed", "braille", "handheld", "print", "projection", "screen", "tty", "tv", "speech",
               "3d-glasses", "resolution [>][<][=] [X]", "device-aspect-ratio: X/Y", "orientation:portrait",
               "orientation:landscape", "device-height: [X]", "device-width: [X]"];
  var s = { attrs: {} }; // Simple tag, reused for a whole lot of tags

  var data = {
    a: {
      attrs: {
        href: null, ping: null, type: null,
        media: media,
        target: targets,
        hreflang: langs
      }
    },
    abbr: s,
    acronym: s,
    address: s,
    applet: s,
    area: {
      attrs: {
        alt: null, coords: null, href: null, target: null, ping: null,
        media: media, hreflang: langs, type: null,
        shape: ["default", "rect", "circle", "poly"]
      }
    },
    article: s,
    aside: s,
    audio: {
      attrs: {
        src: null, mediagroup: null,
        crossorigin: ["anonymous", "use-credentials"],
        preload: ["none", "metadata", "auto"],
        autoplay: ["", "autoplay"],
        loop: ["", "loop"],
        controls: ["", "controls"]
      }
    },
    b: s,
    base: { attrs: { href: null, target: targets } },
    basefont: s,
    bdi: s,
    bdo: s,
    big: s,
    blockquote: { attrs: { cite: null } },
    body: s,
    br: s,
    button: {
      attrs: {
        form: null, formaction: null, name: null, value: null,
        autofocus: ["", "autofocus"],
        disabled: ["", "autofocus"],
        formenctype: encs,
        formmethod: methods,
        formnovalidate: ["", "novalidate"],
        formtarget: targets,
        type: ["submit", "reset", "button"]
      }
    },
    canvas: { attrs: { width: null, height: null } },
    caption: s,
    center: s,
    cite: s,
    code: s,
    col: { attrs: { span: null } },
    colgroup: { attrs: { span: null } },
    command: {
      attrs: {
        type: ["command", "checkbox", "radio"],
        label: null, icon: null, radiogroup: null, command: null, title: null,
        disabled: ["", "disabled"],
        checked: ["", "checked"]
      }
    },
    data: { attrs: { value: null } },
    datagrid: { attrs: { disabled: ["", "disabled"], multiple: ["", "multiple"] } },
    datalist: { attrs: { data: null } },
    dd: s,
    del: { attrs: { cite: null, datetime: null } },
    details: { attrs: { open: ["", "open"] } },
    dfn: s,
    dir: s,
    div: s,
    dl: s,
    dt: s,
    em: s,
    embed: { attrs: { src: null, type: null, width: null, height: null } },
    eventsource: { attrs: { src: null } },
    fieldset: { attrs: { disabled: ["", "disabled"], form: null, name: null } },
    figcaption: s,
    figure: s,
    font: s,
    footer: s,
    form: {
      attrs: {
        action: null, name: null,
        "accept-charset": charsets,
        autocomplete: ["on", "off"],
        enctype: encs,
        method: methods,
        novalidate: ["", "novalidate"],
        target: targets
      }
    },
    frame: s,
    frameset: s,
    h1: s, h2: s, h3: s, h4: s, h5: s, h6: s,
    head: {
      attrs: {},
      children: ["title", "base", "link", "style", "meta", "script", "noscript", "command"]
    },
    header: s,
    hgroup: s,
    hr: s,
    html: {
      attrs: { manifest: null },
      children: ["head", "body"]
    },
    i: s,
    iframe: {
      attrs: {
        src: null, srcdoc: null, name: null, width: null, height: null,
        sandbox: ["allow-top-navigation", "allow-same-origin", "allow-forms", "allow-scripts"],
        seamless: ["", "seamless"]
      }
    },
    img: {
      attrs: {
        alt: null, src: null, ismap: null, usemap: null, width: null, height: null,
        crossorigin: ["anonymous", "use-credentials"]
      }
    },
    input: {
      attrs: {
        alt: null, dirname: null, form: null, formaction: null,
        height: null, list: null, max: null, maxlength: null, min: null,
        name: null, pattern: null, placeholder: null, size: null, src: null,
        step: null, value: null, width: null,
        accept: ["audio/*", "video/*", "image/*"],
        autocomplete: ["on", "off"],
        autofocus: ["", "autofocus"],
        checked: ["", "checked"],
        disabled: ["", "disabled"],
        formenctype: encs,
        formmethod: methods,
        formnovalidate: ["", "novalidate"],
        formtarget: targets,
        multiple: ["", "multiple"],
        readonly: ["", "readonly"],
        required: ["", "required"],
        type: ["hidden", "text", "search", "tel", "url", "email", "password", "datetime", "date", "month",
               "week", "time", "datetime-local", "number", "range", "color", "checkbox", "radio",
               "file", "submit", "image", "reset", "button"]
      }
    },
    ins: { attrs: { cite: null, datetime: null } },
    kbd: s,
    keygen: {
      attrs: {
        challenge: null, form: null, name: null,
        autofocus: ["", "autofocus"],
        disabled: ["", "disabled"],
        keytype: ["RSA"]
      }
    },
    label: { attrs: { "for": null, form: null } },
    legend: s,
    li: { attrs: { value: null } },
    link: {
      attrs: {
        href: null, type: null,
        hreflang: langs,
        media: media,
        sizes: ["all", "16x16", "16x16 32x32", "16x16 32x32 64x64"]
      }
    },
    map: { attrs: { name: null } },
    mark: s,
    menu: { attrs: { label: null, type: ["list", "context", "toolbar"] } },
    meta: {
      attrs: {
        content: null,
        charset: charsets,
        name: ["viewport", "application-name", "author", "description", "generator", "keywords"],
        "http-equiv": ["content-language", "content-type", "default-style", "refresh"]
      }
    },
    meter: { attrs: { value: null, min: null, low: null, high: null, max: null, optimum: null } },
    nav: s,
    noframes: s,
    noscript: s,
    object: {
      attrs: {
        data: null, type: null, name: null, usemap: null, form: null, width: null, height: null,
        typemustmatch: ["", "typemustmatch"]
      }
    },
    ol: { attrs: { reversed: ["", "reversed"], start: null, type: ["1", "a", "A", "i", "I"] } },
    optgroup: { attrs: { disabled: ["", "disabled"], label: null } },
    option: { attrs: { disabled: ["", "disabled"], label: null, selected: ["", "selected"], value: null } },
    output: { attrs: { "for": null, form: null, name: null } },
    p: s,
    param: { attrs: { name: null, value: null } },
    pre: s,
    progress: { attrs: { value: null, max: null } },
    q: { attrs: { cite: null } },
    rp: s,
    rt: s,
    ruby: s,
    s: s,
    samp: s,
    script: {
      attrs: {
        type: ["text/javascript"],
        src: null,
        async: ["", "async"],
        defer: ["", "defer"],
        charset: charsets
      }
    },
    section: s,
    select: {
      attrs: {
        form: null, name: null, size: null,
        autofocus: ["", "autofocus"],
        disabled: ["", "disabled"],
        multiple: ["", "multiple"]
      }
    },
    small: s,
    source: { attrs: { src: null, type: null, media: null } },
    span: s,
    strike: s,
    strong: s,
    style: {
      attrs: {
        type: ["text/css"],
        media: media,
        scoped: null
      }
    },
    sub: s,
    summary: s,
    sup: s,
    table: s,
    tbody: s,
    td: { attrs: { colspan: null, rowspan: null, headers: null } },
    textarea: {
      attrs: {
        dirname: null, form: null, maxlength: null, name: null, placeholder: null,
        rows: null, cols: null,
        autofocus: ["", "autofocus"],
        disabled: ["", "disabled"],
        readonly: ["", "readonly"],
        required: ["", "required"],
        wrap: ["soft", "hard"]
      }
    },
    tfoot: s,
    th: { attrs: { colspan: null, rowspan: null, headers: null, scope: ["row", "col", "rowgroup", "colgroup"] } },
    thead: s,
    time: { attrs: { datetime: null } },
    title: s,
    tr: s,
    track: {
      attrs: {
        src: null, label: null, "default": null,
        kind: ["subtitles", "captions", "descriptions", "chapters", "metadata"],
        srclang: langs
      }
    },
    tt: s,
    u: s,
    ul: s,
    "var": s,
    video: {
      attrs: {
        src: null, poster: null, width: null, height: null,
        crossorigin: ["anonymous", "use-credentials"],
        preload: ["auto", "metadata", "none"],
        autoplay: ["", "autoplay"],
        mediagroup: ["movie"],
        muted: ["", "muted"],
        controls: ["", "controls"]
      }
    },
    wbr: s
  };

  var globalAttrs = {
    accesskey: ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9"],
    "class": null,
    contenteditable: ["true", "false"],
    contextmenu: null,
    dir: ["ltr", "rtl", "auto"],
    draggable: ["true", "false", "auto"],
    dropzone: ["copy", "move", "link", "string:", "file:"],
    hidden: ["hidden"],
    id: null,
    inert: ["inert"],
    itemid: null,
    itemprop: null,
    itemref: null,
    itemscope: ["itemscope"],
    itemtype: null,
    lang: ["en", "es"],
    spellcheck: ["true", "false"],
    style: null,
    tabindex: ["1", "2", "3", "4", "5", "6", "7", "8", "9"],
    title: null,
    translate: ["yes", "no"],
    onclick: null,
    rel: ["stylesheet", "alternate", "author", "bookmark", "help", "license", "next", "nofollow", "noreferrer", "prefetch", "prev", "search", "tag"]
  };
  function populate(obj) {
    for (var attr in globalAttrs) if (globalAttrs.hasOwnProperty(attr))
      obj.attrs[attr] = globalAttrs[attr];
  }

  populate(s);
  for (var tag in data) if (data.hasOwnProperty(tag) && data[tag] != s)
    populate(data[tag]);

  CodeMirror.htmlSchema = data;
  function htmlHint(cm, options) {
    var local = {schemaInfo: data};
    if (options) for (var opt in options) local[opt] = options[opt];
    return CodeMirror.hint.xml(cm, local);
  }
  CodeMirror.registerHelper("hint", "html", htmlHint);
});


if (window) window.__currentScriptPath = "/framework/common/codemirror/addon/hint/javascript-hint.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
  var Pos = CodeMirror.Pos;

  function forEach(arr, f) {
    for (var i = 0, e = arr.length; i < e; ++i) f(arr[i]);
  }

  function arrayContains(arr, item) {
    if (!Array.prototype.indexOf) {
      var i = arr.length;
      while (i--) {
        if (arr[i] === item) {
          return true;
        }
      }
      return false;
    }
    return arr.indexOf(item) != -1;
  }

  function scriptHint(editor, keywords, getToken, options) {
    // Find the token at the cursor
    var cur = editor.getCursor(), token = getToken(editor, cur);
    if (/\b(?:string|comment)\b/.test(token.type)) return;
    token.state = CodeMirror.innerMode(editor.getMode(), token.state).state;

    // If it's not a 'word-style' token, ignore the token.
    if (!/^[\w$_]*$/.test(token.string)) {
      token = {start: cur.ch, end: cur.ch, string: "", state: token.state,
               type: token.string == "." ? "property" : null};
    } else if (token.end > cur.ch) {
      token.end = cur.ch;
      token.string = token.string.slice(0, cur.ch - token.start);
    }

    var tprop = token;
    // If it is a property, find out what it is a property of.
    while (tprop.type == "property") {
      tprop = getToken(editor, Pos(cur.line, tprop.start));
      if (tprop.string != ".") return;
      tprop = getToken(editor, Pos(cur.line, tprop.start));
      if (!context) var context = [];
      context.push(tprop);
    }
    return {list: getCompletions(token, context, keywords, options),
            from: Pos(cur.line, token.start),
            to: Pos(cur.line, token.end)};
  }

  function javascriptHint(editor, options) {
    return scriptHint(editor, javascriptKeywords,
                      function (e, cur) {return e.getTokenAt(cur);},
                      options);
  };
  CodeMirror.registerHelper("hint", "javascript", javascriptHint);

  function getCoffeeScriptToken(editor, cur) {
  // This getToken, it is for coffeescript, imitates the behavior of
  // getTokenAt method in javascript.js, that is, returning "property"
  // type and treat "." as indepenent token.
    var token = editor.getTokenAt(cur);
    if (cur.ch == token.start + 1 && token.string.charAt(0) == '.') {
      token.end = token.start;
      token.string = '.';
      token.type = "property";
    }
    else if (/^\.[\w$_]*$/.test(token.string)) {
      token.type = "property";
      token.start++;
      token.string = token.string.replace(/\./, '');
    }
    return token;
  }

  function coffeescriptHint(editor, options) {
    return scriptHint(editor, coffeescriptKeywords, getCoffeeScriptToken, options);
  }
  CodeMirror.registerHelper("hint", "coffeescript", coffeescriptHint);

  var stringProps = ("charAt charCodeAt indexOf lastIndexOf substring substr slice trim trimLeft trimRight " +
                     "toUpperCase toLowerCase split concat match replace search").split(" ");
  var arrayProps = ("length concat join splice push pop shift unshift slice reverse sort indexOf " +
                    "lastIndexOf every some filter forEach map reduce reduceRight ").split(" ");
  var funcProps = "prototype apply call bind".split(" ");
  var javascriptKeywords = ("break case catch continue debugger default delete do else false finally for function " +
                  "if in instanceof new null return switch throw true try typeof var void while with").split(" ");
  var coffeescriptKeywords = ("and break catch class continue delete do else extends false finally for " +
                  "if in instanceof isnt new no not null of off on or return switch then throw true try typeof until void while with yes").split(" ");

  function forAllProps(obj, callback) {
    if (!Object.getOwnPropertyNames || !Object.getPrototypeOf) {
      for (var name in obj) callback(name)
    } else {
      for (var o = obj; o; o = Object.getPrototypeOf(o))
        Object.getOwnPropertyNames(o).forEach(callback)
    }
  }

  function getCompletions(token, context, keywords, options) {
    var found = [], start = token.string, global = options && options.globalScope || window;
    function maybeAdd(str) {
      if (str.lastIndexOf(start, 0) == 0 && !arrayContains(found, str)) found.push(str);
    }
    function gatherCompletions(obj) {
      if (typeof obj == "string") forEach(stringProps, maybeAdd);
      else if (obj instanceof Array) forEach(arrayProps, maybeAdd);
      else if (obj instanceof Function) forEach(funcProps, maybeAdd);
      forAllProps(obj, maybeAdd)
    }

    if (context && context.length) {
      // If this is a property, see if it belongs to some object we can
      // find in the current environment.
      var obj = context.pop(), base;
      if (obj.type && obj.type.indexOf("variable") === 0) {
        if (options && options.additionalContext)
          base = options.additionalContext[obj.string];
        if (!options || options.useGlobalScope !== false)
          base = base || global[obj.string];
      } else if (obj.type == "string") {
        base = "";
      } else if (obj.type == "atom") {
        base = 1;
      } else if (obj.type == "function") {
        if (global.jQuery != null && (obj.string == '$' || obj.string == 'jQuery') &&
            (typeof global.jQuery == 'function'))
          base = global.jQuery();
        else if (global._ != null && (obj.string == '_') && (typeof global._ == 'function'))
          base = global._();
      }
      while (base != null && context.length)
        base = base[context.pop().string];
      if (base != null) gatherCompletions(base);
    } else {
      // If not, just look in the global object and any local scope
      // (reading into JS mode internals to get at the local and global variables)
      for (var v = token.state.localVars; v; v = v.next) maybeAdd(v.name);
      for (var v = token.state.globalVars; v; v = v.next) maybeAdd(v.name);
      if (!options || options.useGlobalScope !== false)
        gatherCompletions(global);
      forEach(keywords, maybeAdd);
    }
    return found;
  }
});


if (window) window.__currentScriptPath = "/framework/common/codemirror/addon/display/placeholder.js";

// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
  CodeMirror.defineOption("placeholder", "", function(cm, val, old) {
    var prev = old && old != CodeMirror.Init;
    if (val && !prev) {
      cm.on("blur", onBlur);
      cm.on("change", onChange);
      cm.on("swapDoc", onChange);
      onChange(cm);
    } else if (!val && prev) {
      cm.off("blur", onBlur);
      cm.off("change", onChange);
      cm.off("swapDoc", onChange);
      clearPlaceholder(cm);
      var wrapper = cm.getWrapperElement();
      wrapper.className = wrapper.className.replace(" CodeMirror-empty", "");
    }

    if (val && !cm.hasFocus()) onBlur(cm);
  });

  function clearPlaceholder(cm) {
    if (cm.state.placeholder) {
      cm.state.placeholder.parentNode.removeChild(cm.state.placeholder);
      cm.state.placeholder = null;
    }
  }
  function setPlaceholder(cm) {
    clearPlaceholder(cm);
    var elt = cm.state.placeholder = document.createElement("pre");
    elt.style.cssText = "height: 0; overflow: visible";
    elt.style.direction = cm.getOption("direction");
    elt.className = "CodeMirror-placeholder";
    var placeHolder = cm.getOption("placeholder")
    if (typeof placeHolder == "string") placeHolder = document.createTextNode(placeHolder)
    elt.appendChild(placeHolder)
    cm.display.lineSpace.insertBefore(elt, cm.display.lineSpace.firstChild);
  }

  function onBlur(cm) {
    if (isEmpty(cm)) setPlaceholder(cm);
  }
  function onChange(cm) {
    var wrapper = cm.getWrapperElement(), empty = isEmpty(cm);
    wrapper.className = wrapper.className.replace(" CodeMirror-empty", "") + (empty ? " CodeMirror-empty" : "");

    if (empty) setPlaceholder(cm);
    else clearPlaceholder(cm);
  }

  function isEmpty(cm) {
    return (cm.lineCount() === 1) && (cm.getLine(0) === "");
  }
});


if (window) window.__currentScriptPath = "/cms/admin/widgets/AccessDeniedErrorDialog.js";

function AccessDeniedErrorDialog() {
    Dialog.call(this);
    
    this.title = "Error";
}
__extend(Dialog, AccessDeniedErrorDialog);
AccessDeniedErrorDialog.prototype.setup = function (error) {
    Dom.toggleClass(this.dialogContentNode, "Authenticated", error.authenticated ? true : false);
    this.error = error;
    
    if (error && !error.authenticated && error.data && error.data.permissionInvalidAuthenticated) {
        Dom.setInnerText(this.errorTitle, "Invalid Session");
        Dom.setInnerText(this.anonymousDeniedMessage, "Please make sure that your session is valid and you have authorization for this action.");
    }
};
AccessDeniedErrorDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "accept", title: "Login...",
            isApplicable: function () {
                return thiz.error && !thiz.error.authenticated;
            },
            run: function () { this.close(true); return false; }
        },
        {
            type: "cancel", title: this.error && this.error.authenticated ? "Close" : "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};
AccessDeniedErrorDialog.prototype.handleSubmit = function () {
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/AdminAlertCenter.js";

function AdminAlertCenter() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, AdminAlertCenter);


if (window) window.__currentScriptPath = "/cms/admin/widgets/AdminBillingInvoicePayment.js";

function AdminBillingInvoicePayment() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, AdminBillingInvoicePayment);


if (window) window.__currentScriptPath = "/cms/admin/widgets/AdminBillingReport.js";

function AdminBillingReport() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, AdminBillingReport);


if (window) window.__currentScriptPath = "/cms/admin/widgets/AdminBillingSetup.js";

function AdminBillingSetup() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, AdminBillingSetup);

AdminBillingSetup.prototype.confirmClosing = function (callback) {
    Dialog.confirm("Are you sure you want to leave?", "Leaving this page now may cause losing of unsaved data that you have made.", "Leave", callback, "Cancel");
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/AdminConsole.js";

function AdminConsole() {
    BaseTemplatedWidget.call(this);
    AdminConsole.instance = this;
    this.bind("p:ContentPageChanged", this.invalidateMenuItems, this.node());

    this.bind("click", function () {
        new SandboxInfoDialog().open();
    }, this.sandboxIndicator);
    this.bind("p:LoginSuccess", this.handleLoginSuccess, this.loginView.node());
    this.bind("p:AC_FeatureTitleChanged", this.invalidateFeatureTitle);
    this.bind("mouseenter", ProfileBar.handleLeave, this.contentPane);

    ServiceFactory.recoverer = AdminConsole.serviceFactoryRecoverer;

    // Ensure the team context is not changed when opening new URL
    // Make sure that code in /cms/scripts/common.js is also updated
    window.confirmIfSwitchingTeam = function(url, windowName, callback) {
        // Not logged in yet
        if (!AdminConsole.instance.userSession || !ADMIN_CONTEXT || !ADMIN_CONTEXT.teamAlias) {
            if (typeof callback == "function") return callback();
            return false;
        }

        var groups = url.match(/^\/team\/([^\/]+)\/.+$/i);
        if (!groups || groups.length < 2) groups = url.match(/.+(?:jsp|do)\?.*team=([\w-]+).*/i);
        if (!groups || groups.length < 2 || groups[1] == ADMIN_CONTEXT.teamAlias) {
            if (typeof callback == "function") return callback();
            return false;
        }

        Dialog.confirm("Switch Team?", "This action will take you to another team and terminate your current administration session.", "Switch", function () {
            if (typeof callback == "function") callback();
            AdminConsole.instance.logout(windowName && windowName == "_self");
        }, "Cancel");

        return false;
    };
    window._open = window.open;
    window.open = function(url, windowName, features) {
        return window.confirmIfSwitchingTeam(url, windowName, function() {
            return window._open(url, windowName, features);
        });
    }

    if (window.top != window && window.top.AdminConsole.instance) {
        window.top.location.reload();
    }
    window.defaultIndicator = this;

}
__extend(BaseTemplatedWidget, AdminConsole);
AdminConsole.prototype.onAttached = function () {
    this.initialize();
};
AdminConsole.prototype.launch = function (feature, preExecuteCallback, callback) {
    this.pageContentWrapper.launch(feature, preExecuteCallback, function (widget, iframe) {
        this._currentFeatureInfo = {
            feature: feature,
            widget: widget,
            iframe: iframe
        };
        this.initSystemToolbar(widget);
        this.invalidateFeatureTitle();

        if (callback) {
            if (widget && widget.addWidgetLoadListener) {
                widget.addWidgetLoadListener(function () {
                    callback(widget, iframe);
                })
            } else {
                callback(widget, iframe);
            }
        }
    }.bind(this));
};
AdminConsole.prototype.invalidateFeatureTitle = function () {
    if (typeof(this._currentFeatureInfo) == "undefined") {
        Dom.setInnerText(this.featureTitle, "");
        return;
    }
    var feature = this._currentFeatureInfo.feature || {};
    var title = typeof(feature.name) == "function" ? feature.name() : (feature.name || "");
    title = TeamLocalizer.getString(title);
    if (!feature.terminologyRequired || feature.terminologyRequired()) {
       title = FormatUtil.term(title);
    }
    var widget = this._currentFeatureInfo.widget;
    var prefix = (widget && widget.getAdminConsoleTitlePrefix && widget.getAdminConsoleTitlePrefix()) || "";
    var suffix = (widget && widget.getAdminConsoleTitleSuffix && widget.getAdminConsoleTitleSuffix()) || "";
    Dom.setInnerText(this.featureTitle, prefix + title + suffix);
};
AdminConsole.prototype.initSystemToolbar = function(widget) {
    this.toolbarContainer.innerHTML = "";
    if (widget && widget.getSystemToolbar) {
        var toolbar = widget.getSystemToolbar();
        if (toolbar) {
            if (toolbar.parentNode) {
                toolbar.parentNode.removeChild(toolbar);
            }
            this.toolbarContainer.appendChild(toolbar);
        }
    }
}
AdminConsole.prototype.isTeamFeatureModuleEnable = function (name) {
    if (!ADMIN_CONTEXT.enabledBetaFeatures) return false;
    return ADMIN_CONTEXT.enabledBetaFeatures.indexOf(name) >= 0;
};
AdminConsole.prototype.isFeatureEnable = function (featureKey) {
    if (!ADMIN_CONTEXT.enabledFeatures) return false;
    return ADMIN_CONTEXT.enabledFeatures.indexOf(featureKey) >= 0;
};
AdminConsole.prototype.startSession = function (session) {
    var thiz = this;
    thiz.setLoginSession(session);
    function quit() {
        window.top.location.href = "/Home.jsp?team=" + ADMIN_CONTEXT.teamAlias;
    }
    $cmsMigration.getCMSMigrationStatus(function (status) {
        if (status == "Live" || status == "Sandboxed" || status == "Allowed") {
            thiz.startWorkspace(status == "Sandboxed");
        } else {
            Dialog.error("CMS Feature Disabled", "There was an error when initializing the content management system for your team.", quit);
        }
    });
};

AdminConsole.prototype.startWorkspace = function (sandboxed) {
    var thiz = this;
    this.sandboxed = sandboxed;
    Dom.addClass(this.node(), "ValidSession");
    Dom.removeClass(this.node(), "WithLoginForm");
    Dom.toggleClass(this.node(), "Sandboxed", sandboxed);
    if (this.isSESSOEnabled() && ADMIN_CONTEXT.seSSOFirstLogin) {
        $authInfoService.getAssociatedTeamsOfAuthenticatedAccount(function(data){
            if (!data || data.length <= 1) return;
            new SignInMultiTeamsDialog(data).open();
        });
    }

    if (this.userSession && this.userSession.lockoutOnInvoiceOverdue) {
        $myTuInvoiceService.getCurrentInvoiceStatusInfo(function(info){
            thiz._currentInvoiceStatusInfo = info;
            if (!info || info.pastDue < 30) {
               thiz.navigationDrawer.initialize();
               return;
            }
            var showNotify = !info.dismissable || ADMIN_CONTEXT.fromLoginFlow || info.pastDue >= 90;
            if (!showNotify) {
                thiz.navigationDrawer.initialize();
                return;
            }
            thiz.navigationDrawer.initialize();
            widget.__ensureNamespaceLoaded("mytuinvoice", function(m){
                thiz._pastDueDialog = new m["PastsDueDialog"]({hasClose: info.dismissable});
                thiz._pastDueDialog.open(info);
            }, "Loading...");
        }, "Loading invoices status...");
    } else {
        this.navigationDrawer.initialize();
    }

};

AdminConsole.prototype.isSESSOEnabled = function () {
    return ADMIN_CONTEXT.sessoEnabled;
}
AdminConsole.prototype.invalidateMenuItems = function(keepCurrentFeatureShowing) {
    console.log("invalidateMenuItems AdminConsole");
    this.navigationDrawer.render(true, keepCurrentFeatureShowing);
};

AdminConsole.prototype.initialize = function () {
    var thiz = this;

    Dom.setInnerText(this.teamNameHeading, ADMIN_CONTEXT.teamName);
    this.warning.innerHTML = this.warning.innerHTML.replace(/#teamName/g, ADMIN_CONTEXT.teamName);
    document.title = "Management Console - " + ADMIN_CONTEXT.teamName + " - " + APP_INFO.BRAND_NAME;

    if (ADMIN_CONTEXT.teamLogoUrl) {
        this.teamLogo.src = ADMIN_CONTEXT.teamLogoUrl;
    } else {
        this.teamLogo.style.display = "none";
    }

    setTimeout(function() {
        var swimming = (TEAM_INFO.sportType == "swimming");
        var copy = String.format(APP_INFO.COPYRIGHT_ORG, ADMIN_CONTEXT.teamName);
        Dom.addClass(thiz.node(), "SEFlavor");
        var url = "/PrivacyPolicy.jsp?team=" + ADMIN_CONTEXT.teamAlias;
        if (ADMIN_CONTEXT.cmsMigrationStatus != "Live") {
            url += "&layout=empty";
        }
        var privacyLabel = "Privacy Statement";

        thiz.seTuLogo.src = "/" + APP_INFO.SE_DEFAULT_APP_LOGO_PATH;
        thiz.seTuLogo.height = 60;
        thiz.seCopyrightText.innerHTML = copy;
        thiz.sePrivacyStatement.href = url;
        Dom.setInnerText(thiz.sePrivacyStatement, privacyLabel);
        thiz.sePrivacyStatement.href = url;
    }, 300);

    this._loadGlobalToolbarWidgets();

    this.loginView.checkSession(function (session) {
        thiz.startSession(session);
    }, function (error) {
        thiz.requestLogin();
    });
};
AdminConsole.prototype._loadGlobalToolbarWidgets = function (callback) {
    var widgetClasses = window.adminGlobalToolbarWidgets;
    if (!widgetClasses) {
        if (callback) callback();
        return;
    }

    var thiz = this;

    var index = -1;
    (function next() {
        index ++;
        if (index >= widgetClasses.length) {
            if (callback) callback();
            return;
        }

        var clazz = widgetClasses[index];
        var ns = "ui";
        var name = clazz;
        if (clazz.match(/([a-z0-9]+):([a-z0-9]+)/gi)) {
            ns = RegExp.$1;
            clazz = RegExp.$2;
        }

        widget.createWidgetAsync(ns, clazz, {}, function (widget) {
            widget.into(thiz.headerBar);
            next();
        });
    })();
};
AdminConsole.prototype.requestLogin = function (forceWindowReload) {
    if (this.isSESSOEnabled()) {
        window.location.href = "/team/" + ADMIN_CONTEXT.teamAlias + "/controller/auth/login?to=" + encodeURIComponent(window.location.href);
        return;
    }
    Dom.removeClass(this.node(), "ValidSession");
    Dom.addClass(this.node(), "WithLoginForm");
    setTimeout(function () {
        if (forceWindowReload) {
            this.loginView.showLoading();
            window.location.reload();
        } else {
            this.loginView.reset();
        }
    }.bind(this), 100);

    this.loginRequested = true;
};
AdminConsole.prototype.logout = function (silent) {
    if (this.isSESSOEnabled()) {
        window.location.href = "/team/" + ADMIN_CONTEXT.teamAlias + "/controller/auth/logout?to=" + encodeURIComponent(window.location.href);
        return;
    }

    var thiz = this;
    this.userSession = null;
    var callback;
    if (silent) {
        callback = function () {};
    } else {
        callback = function () {
            thiz.pageContentWrapper.reset();
            thiz.requestLogin("true");
        };
    }
    this.loginView.logout(callback);
};

AdminConsole.prototype.isAccountLoggedIn = function() {
    if (!this.userSession) return false;
    return this.userSession.authorizationStatus == "LoggedIn";
}

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isAdminTypeAtLeast = function (adminType) {
    console.warn("Calling deprecated function: AdminConsole.isAdminTypeAtLeast");
    if (!this.userSession || !AdminType) return false;
    if (this.userSession.admin_type == AdminType.NotLoggedIn.code) return adminType == "NotLoggedIn";
    return this.userSession.admin_type >= AdminType[adminType].code;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isMainSetCoachTypeAtLeast = function (coachType) {
    console.warn("Calling deprecated function: AdminConsole.isMainSetCoachTypeAtLeast");
    if (!this.userSession || !MainSetCoachType) return false;
    return this.userSession.coach_type >= MainSetCoachType[coachType].code;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isLoggedWithRole = function (adminType) {
    console.warn("Calling deprecated function: AdminConsole.isLoggedWithRole");
    if (!this.userSession || !AdminType) return false;
    var admin = AdminType[adminType];
    return admin && this.userSession.admin_type == admin.code;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isAnyAdminLogin = function () {
    console.warn("Calling deprecated function: AdminConsole.isAnyAdminLogin");
    if (!this.userSession) return false;
    return this.isAdminTypeAtLeast(Role.EmailOnly) || this.lessonAdminEnabled() || this.tuMoneyAdminEnabled();
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isSuperAdminLogin = function () {
    console.warn("Calling deprecated function: AdminConsole.isSuperAdminLogin");
    if (!this.userSession) return false;
    return this.isAdminTypeAtLeast(Role.SuperUser);
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isEPCLogin = function () {
    console.warn("Calling deprecated function: AdminConsole.isEPCLogin");
    if (!this.userSession) return false;
    return this.isAdminTypeAtLeast(Role.EmailPrint);
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isLessonAdmin = function() {
    console.warn("Calling deprecated function: AdminConsole.isLessonAdmin");
    if (!this.userSession) return false;
    return this.userSession.lessonAdmin;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isAdminLessonLimited = function() {
    console.warn("Calling deprecated function: AdminConsole.isAdminLessonLimited");
    if (!this.userSession) return false;
    return this.userSession.adminLessonLimited;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isAdminLessonInter = function() {
    console.warn("Calling deprecated function: AdminConsole.isAdminLessonInter");
    if (!this.userSession) return false;
    return this.userSession.adminLessonInter;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.lessonAdminEnabled = function() {
    console.warn("Calling deprecated function: AdminConsole.lessonAdminEnabled");
    if (!this.userSession) return false;
    return this.isLessonAdmin() || this.isAdminLessonInter() || this.isAdminLessonLimited();
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isTuMoneyAdmin = function() {
    console.warn("Calling deprecated function: AdminConsole.isTuMoneyAdmin");
    if (!this.userSession) return false;
    return this.userSession.tuMoneyAdmin;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isAdminTUMoneyInter = function () {
    console.warn("Calling deprecated function: AdminConsole.isAdminTUMoneyInter");
    if (!this.userSession) return false;
    return this.userSession.adminTUMoneyInter;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isAdminTUMoneyLimited = function () {
    console.warn("Calling deprecated function: AdminConsole.isAdminTUMoneyLimited");
    if (!this.userSession) return false;
    return this.userSession.adminTUMoneyLimited;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.tuMoneyAdminEnabled = function () {
    console.warn("Calling deprecated function: AdminConsole.tuMoneyAdminEnabled");
    if (!this.userSession) return false;
    return this.isTuMoneyAdmin() || this.isAdminTUMoneyInter() || this.isAdminTUMoneyLimited();
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isFinancialAdmin = function() {
    console.warn("Calling deprecated function: AdminConsole.isFinancialAdmin");
    if (!this.userSession) return false;
    return this.userSession.financialAdmin;
};

/** * @deprecated use PermissionUtils instead */
AdminConsole.prototype.isFinancialAdminFullAccess = function() {
    console.warn("Calling deprecated function: AdminConsole.isFinancialAdminFullAccess");
    if (!this.userSession) return false;
    return this.userSession.financialAdminFullAccess;
};

AdminConsole.prototype.isTUAdmin = function () {
    return (this.userSession && this.userSession.email && (
                this.userSession.email.match(/^.*@teamunify\.com$/)
            || this.userSession.email.match(/^.*@sportngin\.com$/)
            || this.userSession.email.match(/^.*@sportsengine\.com$/)
            || this.userSession.email.match(/^.*@nbcuni\.com$/)
     ));
};
AdminConsole.prototype.isSwimTeam = function () {
    return typeof(ADMIN_CONTEXT) != "undefined" && ADMIN_CONTEXT.teamSportType == "swimming";
};
AdminConsole.prototype.setLoginSession = function (session) {
    this.userSession = session;
    this.navigationDrawer.profileBar.setSession(session);
    this.navigationDrawer.systemNotification.initialize();
};
AdminConsole.prototype.handleLoginSuccess = function (event) {
    this.startSession(this.loginView.session);
};

// ServiceFactory busy-indicator interface implementation
AdminConsole.prototype.busy = function (message) {
    if (!this._busyCount) this._busyCount = 0;
    this._busyCount ++;

    Dom.addClass(this.node(), "Busy");
    Dom.setInnerText(this.loadingMessage, message || "Please wait...");
};
AdminConsole.prototype.isBusy = function() {
    return this._busyCount > 0;
}
AdminConsole.prototype.done = function () {
    if (typeof this._busyCount == "number" && this._busyCount > 0) this._busyCount --;

    if (this._busyCount == 0) {
        Dom.removeClass(this.node(), "Busy");
        Dom.setInnerText(this.loadingMessage, "");
    }
};
AdminConsole.prototype.failed = function (e) {
};
AdminConsole.prototype.progressed = function (loaded, total) {
};
AdminConsole.prototype.asCustomIndicator = function (message) {
    var thiz = this;
    return {
        busy: function () {
            thiz.busy(message);
        },
        done: function () {
            thiz.done();
        },
        failed: function (e) {
            thiz.failed(e);
        },
        progressed: function (loaded, total) {
            thiz.progressed(loaded, total);
        }
    }
};
AdminConsole.prototype.clearLastVisitFeature = function () {
    localStorage.setItem(NavigationDrawer.STORAGE_KEY_LAST_FEATURE_ID, "");
};

AdminConsole.serviceFactory_recovering = false;
AdminConsole.serviceFactory_pendingRecoveringCallbacks = [];

AdminConsole.serviceFactoryRecoverer = function (errorCode, callback, errorObject) {
    if (errorCode != 403) return;

    // check current view
    if (Dom.hasClass(AdminConsole.instance.node(), "WithLoginForm")) return;

    window.defaultIndicator.done();

    if (!AdminConsole.instance.userSession && !AdminConsole.serviceFactory_pendingRecoveringCallbacks.length) {
        AdminConsole.serviceFactory_pendingRecoveringCallbacks.push(function() {
            if (AdminConsole.instance.userSession) AdminConsole.instance.startSession(AdminConsole.instance.userSession);
        });
    }
    if (callback) AdminConsole.serviceFactory_pendingRecoveringCallbacks.push(callback);

    if (AdminConsole.serviceFactory_recovering) return;
    AdminConsole.serviceFactory_recovering = true;

    var authenticated = errorObject && errorObject.authenticated;
    
    function finish(resolved) {
        while ((c = AdminConsole.serviceFactory_pendingRecoveringCallbacks.shift()) != null) c(resolved);
        AdminConsole.serviceFactory_recovering = false;
    }
    
    function logout() {
        AdminConsole.serviceFactory_pendingRecoveringCallbacks = [];
        AdminConsole.serviceFactory_recovering = false;
        AdminConsole.instance.logout();

    }
    
    function addLoginStatusIframe() {
        const iframeId = 'login-status-iframe';
        document.getElementById(iframeId)?.remove();

        const iframe = document.createElement('iframe');
        iframe.src = '/team/' + ADMIN_CONTEXT.teamAlias + '/controller/auth/login-status';
        iframe.hidden = true;
        iframe.width = '0';
        iframe.height = '0';
        iframe.id = iframeId;
        iframe.sandbox = 'allow-forms allow-scripts';
        document.body.appendChild(iframe);
    }
    
    function retryLogin() {
        console.log('Retrying login...');
        
        return new Promise((resolve, reject) => {
            addLoginStatusIframe();
            
            const messageListener = (event) => {
                if (event.data.type === 'LOGIN_STATUS' && event.data.loggedIn) {
                    window.removeEventListener('message', messageListener);
                    clearTimeout(timeoutId);
                    resolve();
                }
            };

            window.addEventListener('message', messageListener);

            const timeoutId = setTimeout(() => {
                window.removeEventListener('message', messageListener);
                reject(new Error('Login retry timed out.'));
            }, 5000);
        });
    }
    
    retryLogin().then((success) => {
        console.log('Login retry successful');
        AdminConsole.instance.setLoginSession(session);
        finish(true);
    }).catch((error) => {
        console.error("Login retry failed", error);
        
        if (AdminConsole.instance.isSESSOEnabled()) {
            window.location.href = "/team/" + ADMIN_CONTEXT.teamAlias + "/controller/auth/logout?to=" + encodeURIComponent(window.location.href);
            return;
        } else {
            const accessDeniedErrorDialog = new AccessDeniedErrorDialog();
            const accessDeniedErrorDialogCallback = (loginRequested) => {
                const quickLoginDialog = new QuickLoginDialog();
                const quickLoginDialogCallback = (session) => {
                    if (session) {
                        AdminConsole.instance.setLoginSession(session);
                        finish(true);
                    } else {
                        logout();
                    }
                }

                quickLoginDialog.callback(quickLoginDialogCallback).open();
            }
            
            accessDeniedErrorDialog.callback(accessDeniedErrorDialogCallback).open(errorObject);
        }
    });
    
//    new AccessDeniedErrorDialog().callback(function (loginRequested) {
//        if (authenticated) {
//            finish(false);
//            return;
//        }
//
//        if (loginRequested) {
//            if (AdminConsole.instance.isSESSOEnabled()) {
//                window.location.href = "/team/" + ADMIN_CONTEXT.teamAlias + "/controller/auth/logout?to=" + encodeURIComponent(window.location.href);
//                return;
//            }
//            new QuickLoginDialog().callback(function (session) {
//                if (!session) {
//                    logout();
//                    return;
//                }
//
//                AdminConsole.instance.setLoginSession(session);
//                finish(true);
//            }).open();
//        } else {
//            finish(false);
//            return;
//        }
//
//    }).open(errorObject);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/AdminContentManagement.js";

function AdminContentManagement() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, AdminContentManagement);


if (window) window.__currentScriptPath = "/cms/admin/widgets/AdminHome.js";

function AdminHome() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, AdminHome);


if (window) window.__currentScriptPath = "/cms/admin/widgets/CMSAuthUtils.js";

var CMSAuthUtils = (function () {
    return {
        canUpdateGeneralSetting: function(accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.CMS_GeneralSetting_Update);
        },
        canPublishUnpublishWebsite: function(accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.CMS_Website_PublishUnpublish);
        },
        canDesignWebsite: function(accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.CMS_Website_Design);
        },
        canCreateEditDeleteCustomPage: function(accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.OrgResource_CustomPage_CreateEditDelete);
        }
    }
}());

if (window) window.__currentScriptPath = "/cms/admin/widgets/Dashboard.js";

function Dashboard() {
    BaseTemplatedWidget.call(this);
    this.content.innerHTML = "Welcome to " + ADMIN_CONTEXT.teamName + " - Dashboard";
}
__extend(BaseTemplatedWidget, Dashboard);


if (window) window.__currentScriptPath = "/cms/admin/widgets/ForgotPasswordDialog.js";

function ForgotPasswordDialog() {
    Dialog.call(this);
    this.bind("submit", this.handleLoginClick, this.loginForm);
    
    this.title = "Forgot Password";
    
    this.validationRules = new RuleSet()
                    .live(true)
                    .required(this.emailInput, "Please enter your account email address")
                    .pattern(this.emailInput, ValidationManager.patterns.EMAIL_REGEX, "Please enter a valid email address");
}
__extend(Dialog, ForgotPasswordDialog);
ForgotPasswordDialog.prototype.setup = function (options) {
    this.emailInput.focus();
    if (options) {
        if (options.email) {
            this.emailInput.value = options.email;
            this.emailInput.select();
        }
    }
};
ForgotPasswordDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "accept", title: "Submit",
            run: function () { this.handleSubmit(); return false; }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};
ForgotPasswordDialog.prototype.handleSubmit = function () {
    if (!ValidationManager.run(this.validationRules)) return;
    
    var thiz = this;
    CommonNet.get("/team/" + ADMIN_CONTEXT.teamAlias + "/controller/cms/admin/forgotPassword", {
        email: this.emailInput.value
    },
    function (result) {
        thiz.close(thiz.emailInput.value);
        SnackBar.show("Password reset instructions have been successfully sent to your email address.");
    },
    function (error) {
        Dialog.error("There was an error when processing your request. The email address that you entered cannot be found on the system.");
    }, this);
};



if (window) window.__currentScriptPath = "/cms/admin/widgets/LegacyAdminFeatures.js";

function BaseLegacyAdminFeature(legacyPagePath) {
    BaseTemplatedWidget.call(this);

    this.iframe.src = "/team/" + ADMIN_CONTEXT.teamAlias + "/controller/cms/admin/legacy" + legacyPagePath;
}
__extend(BaseTemplatedWidget, BaseLegacyAdminFeature);

BaseLegacyAdminFeature.prototype.getTemplatePath = function () {
    return this.getTemplatePrefix() + "LegacyAdminFeatures.xhtml";
};


function AMALegacyFeature() {
    BaseLegacyAdminFeature.call(this, "/Ama2");
}
__extend(BaseLegacyAdminFeature, AMALegacyFeature);


if (window) window.__currentScriptPath = "/cms/admin/widgets/LoginView.js";

function LoginView() {
    BaseTemplatedWidget.call(this);
    this.bind("submit", this.handleLoginClick, this.loginForm);

    var thiz = this;
    this.bind("click", function () {
        new ForgotPasswordDialog().callback(function (email) {
            if (email) {
                thiz.usernameInput.value = email;
                thiz.passwordInput.value = "";
                window.setTimeout(function () {
                    thiz.passwordInput.focus();
                }, 300);
            }
        }).open({
            email: this.usernameInput.value
        });
    }, this.forgotPasswordLink);

    this.validationRules = new RuleSet()
                    .live(true)
                    .required(this.usernameInput, "Please enter Username")
                    .required(this.passwordInput, "Please enter Password");
}
__extend(BaseTemplatedWidget, LoginView);
LoginView.prototype.reset = function () {
    if (this.usernameInput.value.trim()) {
        this.passwordInput.value = "";
        this.passwordInput.focus();
    } else {
        this.usernameInput.focus();
        this.passwordInput.value = "";
    }
};
LoginView.prototype.showLoading = function() {
    Dom.hide(this.loginForm);
    this.progressBar.setMessage("Please wait...");
    Dom.show(this.progressBar.node());
}
LoginView.prototype.showLogin = function() {
    Dom.hide(this.progressBar.node());
    Dom.show(this.loginForm);
}
LoginView.prototype.handleLoginClick = function (event) {
    event.preventDefault();
    event.returnValue = false;

    if (!ValidationManager.run(this.validationRules)) return;

    var thiz = this;
    CommonNet.post("/team/" + ADMIN_CONTEXT.teamAlias + "/controller/cms/admin/login", {
        email: this.usernameInput.value,
        password: this.passwordInput.value,
        keep: this.rememberMeCheckbox.checked ? "on" : ""
    },
    function (session) {
        if (session) {
            thiz.session = session;
            thiz.passwordInput.value = "";
            Dom.emitEvent("p:LoginSuccess", thiz.node(), {});
            window.location.reload();
        } else {
            Dialog.error("Invalid username or password");
        }
    },
    function (error) {
        Dialog.error("Invalid username or password");
    }, AdminConsole.instance);
};

LoginView.prototype.checkSession = function (success, error) {
    //validate current session
    CommonNet.get("/team/" + ADMIN_CONTEXT.teamAlias + "/controller/cms/admin/checkLogin", {t: new Date().getTime()},
    function (session) {
        this.session = session;
        success(session);
    },
    function (e) {
        console.error(e);
        if (error) error();
    }, AdminConsole.instance);
};
LoginView.prototype.logout = function (callback) {
    var thiz = this;
    this.session = null;
    CommonNet.get("/rest/mainset/login/session/clear", {t: new Date().getTime()},
    function () {
        callback();
    },
    function (error) {
        Dialog.error("" + error.message);
    }, AdminConsole.instance, "text/plain");
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/NavigationDrawer.js";

function NavigationDrawer() {
    BaseTemplatedWidget.call(this);

    this.menuItemDataList = [];
    this.linkTeamWebsite.href = (ADMIN_CONTEXT.isUsingCustomDomain ? "" : ("/team/" + ADMIN_CONTEXT.teamAlias)) + "/page/home";
    this.bind("click", this.toggle, this.navToggleContainer);
    this._isExpanded = false;
    var isLastExpanded = localStorage.getItem(NavigationDrawer.STORAGE_KEY_LAST_EXPANDED) != "false";
    this.toggle(isLastExpanded);
    this._showingFeature = null;
    this.bind("click", this.handleItemClick, this.menuItemsContainer);
    NavigationDrawer.instance = this;
    this.bind("click", this._handlePrev, this.prevButton);
    this.bind("click", this._handleNext, this.nextButton);
    this.bind("wheel", this._handleWheel, this.menuBox);

    this.bind("p:NotificationChanged", function (event) {
        if (!document.body.contains(this.node())) return;

        this.updateNotification(event.feature);
    }, document.body);

    if (!PermissionUtils.hasAllPermissions(PERMISSION_KEY.HelpTraining_HelpCenter_Access)) {
        this.showHelpButton.parentNode.removeChild(this.showHelpButton);
    }

    this.bind("click", function () {
         if (typeof(WalkMePlayerAPI) == "undefined") {
            // Fallback: Open help documentation when WalkMe is not available (e.g., on mobile)
            window.open('https://motion-help.sportsengine.com/en/', '_blank');
        } else if (!WalkMePlayerAPI.isMenuOpen()) {
            WalkMePlayerAPI.toggleMenu();
        }
    }, this.showHelpButton);

    /*if (window._elev) {
        this.bind("click", function () {
            window._elev.open();
        }, this.showHelpButton);

        var thiz = this;
        window._elev.on("widget:opened", function () {
            Dom.addClass(thiz.node(), "ElevioOpened");
        });
        window._elev.on("widget:closed", function () {
            Dom.removeClass(thiz.node(), "ElevioOpened");
        });
    } else {
        this.showHelpButton.parentNode.removeChild(this.showHelpButton);
    }*/
}
__extend(BaseTemplatedWidget, NavigationDrawer);

NavigationDrawer.STORAGE_KEY_LAST_FEATURE_ID = "lastFeatureId";
NavigationDrawer.STORAGE_KEY_LAST_EXPANDED = "lastExpanded";

NavigationDrawer.handleItemEnter = function (event) {
    var li = Dom.findUpwardForNodeWithData(event.target, "_feature");
    if (!li) return;

    if (li._leaveTimeout) {
        window.clearTimeout(li._leaveTimeout);
        li._leaveTimeout = null;
    }

    if (li._enterTimeout) window.clearTimeout(li._enterTimeout);
    li._enterTimeout = window.setTimeout(function () {
            Dom.addClass(li, "Hover");
            var popupId = Dom.getAttributeAsString(li, "popup-menu-id");
            if (popupId) {
                var subMenu = Dom.get(popupId);
                if (subMenu) Dom.addClass(subMenu, "Active");
            }
            if (ProfileBar.instance) {
                ProfileBar.instance.hideMyMenu();
            }
            NavigationDrawer.instance.calculatePosition(li);
    }, 200);
};
NavigationDrawer.handleSubItemsEnter = function (event) {
    var id = Dom.getAttributeAsString(Dom.getTarget(event), "menu-item-id");
    if (!id) return;
    var li = Dom.get(id);
    if (!li) return;
    NavigationDrawer.handleItemEnter({target: li});
};

NavigationDrawer.handleSubItemsLeave = function (event) {
    var id = Dom.getAttributeAsString(Dom.getTarget(event), "menu-item-id");
    if (!id) return;
    var li = Dom.get(id);
    if (!li) return;
    NavigationDrawer.handleItemLeave({target: li});
};

NavigationDrawer.handleItemLeave = function (event) {
    var li = Dom.findUpwardForNodeWithData(event.target, "_feature");
    if (!li) return;
    if (li._enterTimeout) {
        window.clearTimeout(li._enterTimeout);
        li._enterTimeout = null;
    }

    if (li._leaveTimeout) window.clearTimeout(li._leaveTimeout);

    this._leaveTimeout = window.setTimeout(function () {
        Dom.removeClass(li, "Hover");
        var popupId = Dom.getAttributeAsString(li, "popup-menu-id");
        if (popupId) {
            var subMenu = Dom.get(popupId);
            if (subMenu) Dom.removeClass(subMenu, "Active");
        }
    }, 200);
};
NavigationDrawer.prototype.calculatePosition = function(li) {
    //console.log("Calculate", li);
    var box = undefined;
    var popupId = Dom.getAttributeAsString(li, "popup-menu-id");
    if (popupId) {
        box = Dom.get(popupId);
    }
    if (!box) return;
    var topNav = Dom.getOffsetTop(NavigationDrawer.instance.menuItemsContainer);
    var topLi = Dom.getOffsetTop(li) - NavigationDrawer.instance.menuItemsContainer.scrollTop || 0;
    var subMenuHeight = Dom.getOffsetHeight(box) - Util.em() * 3;
    var navHeight = Dom.getOffsetHeight(NavigationDrawer.instance.node());
    var space = navHeight - subMenuHeight;
    if (topLi > navHeight - subMenuHeight) {
        box.style.top = (navHeight - subMenuHeight) + "px";
    } else {
        box.style.top = topLi + "px";
        /*if (Dom.hasClass(box, "Large")) {
            box.style.top = ((topLi - subMenuHeight/2) + Dom.getOffsetHeight(li)/2) + "px";
        } else {
            box.style.top = topLi + "px";
        } */
    }
    box.style.left = Dom.getOffsetWidth(NavigationDrawer.instance.node()) + "px";
}
NavigationDrawer.prototype.initialize = function() {
    this.menuItemsContainer.innerHTML = "";
    this._showingFeature = null;
    Dom.setInnerText(this.teamNameLabel, ADMIN_CONTEXT.teamName);
    this.loadTeamLogo();
    this.render(true);
};

NavigationDrawer.prototype.render = function(refreshData, keepCurrentFeatureShowing) {
    if (refreshData) {
        AdminSectionManager.performRegistrationPostProcessing();
        this.menuItemDataList = AdminSectionManager.cloneFeatures();
        if (!keepCurrentFeatureShowing) this._showingFeature = undefined;
    }
    var thiz = this;
    $featureManagementService.getEnabledFeaturesOfMyTeam(function (data){
        thiz.teamFeatures = data;
        thiz.loadDynamicMenu(thiz.menuItemDataList, function() {
            thiz.doRender(keepCurrentFeatureShowing);
        });
    },  function(e) {

    }, "Loading...");
};

NavigationDrawer.prototype.doRender = function (keepCurrentFeatureShowing) {
    if (this._isRendering) return;
    this._isRendering = true;

    Dom.empty(this.menuItemsContainer);
    Dom.doOnSelector(AdminConsole.instance.node(), ":scope > .SubMenuBox.SubMenuBoxWrapper", function (node) {
        node.parentNode.removeChild(node);
    });
    console.log("Menu list after load ", this.menuItemDataList);
    this.populateFeatures(null, this.menuItemDataList);
    this.afterPopulateFeatures();
    this.initTitle();
    if (!keepCurrentFeatureShowing || !this._showingFeature) this.startNow(this.menuItemDataList);
    this._isRendering = false;
};

NavigationDrawer.prototype.startNow = function(features) {
    CommonNavigation.setRoot(this.getNavigationModule(), function(){
        var hash = "" + window.location.hash;
        if (hash.indexOf("#/") == 0) {
            hash = hash.slice(2);
        }
        if (hash.indexOf("#") == 0) {
            hash = hash.slice(1);
        }
        var feature = this.featureMap[hash] || this._showingFeature || this._pendingOpenFeature;
        if (hash.length <= 0 || !feature) {
            this.jumpToDefaultFeature();
        }
    }.bind(this));

}
NavigationDrawer.prototype.jumpToDefaultFeature = function() {
    var thiz = this;
    var tuUpdates = this.featureMap["SO" == SERVER_FLAVOR ? "tu-updates" : "se-updates"];

    if (tuUpdates && !tuUpdates.extra) {
        window.setTimeout(function() {
            thiz.jumpToDefaultFeature();
        }, 50);
        return;
    }
    var lastFeatureId = ADMIN_CONTEXT.accountStatusId != AccountStatus.Active.code ? "new-account-landing-page" : localStorage.getItem(NavigationDrawer.STORAGE_KEY_LAST_FEATURE_ID);
    var f = this.featureMap[lastFeatureId] || this.defaultFeature;

    // override #1: when tu-updates has notifications
    if (tuUpdates && tuUpdates.extra.count) {
        f = tuUpdates;
    }

    // override #2: when team is under migration sandbox and is SU
    var shouldOpenMigrationLandingPage = false;
    if (ADMIN_CONTEXT.migrationSandboxed && AdminConsole.instance.isAdminTypeAtLeast(Role.SuperUser)) {
        shouldOpenMigrationLandingPage = true;
        f = this.featureMap["smmigration-landing-page"];
    }

    // override #3: YMCA team is not customer team (Non TU team) - Only show ymca admin menu tools
    if(TEAM_INFO.isNonTUTeam && !shouldOpenMigrationLandingPage) {
        if (TEAM_INFO.isYmcaNonTUTeam) {
            this.openFeature(this.featureMap["yusa-home"]);
        } else {
            this.openFeature(this.featureMap["website-design"]);
        }
        return;
    }

    if (!f) {
        f = this.featureMap["home"]
        || this.featureMap["new-account-landing-page"]
        || this.featureMap["dashboard"]
        || this.featureMap["team-feed"] || this.featureMap["social-feed"]
        || this.featureMap["tu-updates"]
        || this.featureMap["alert-center"]
        || this.featureMap["my-account"];
    }
    var thiz = this;
    var onboardingDashboardAccessible = PermissionUtils.hasAllPermissions(PERMISSION_KEY.HelpTraining_Dashboard_ManageAll);
    if (!onboardingDashboardAccessible) {
        window.setTimeout(function() {
            thiz.openFeature(f);
        }, 100);

        return;
    }
    console.log('jumpToDefaultFeature with feature f: ', f);
    $cmsService.deploymentDashboardEnabled(function (enabled) {
        var deployment = thiz.featureMap["onboarding-dashboard"] || thiz.featureMap["welcome-onboarding-dashboard"];
        console.log('jumpToDefaultFeature deploymentDashboardEnabled: ', enabled);
        console.log('jumpToDefaultFeature deployment feature: ', deployment);
        if (enabled && deployment && !shouldOpenMigrationLandingPage) {
            var thizz = thiz;
            $teamInfoService.getSiteLive(function(isSiteLive) {
                console.log('jumpToDefaultFeature check team site live: ' + isSiteLive);
                if(isSiteLive) {
                    thizz.openFeature(f);
                } else {
                    thizz.openFeature(deployment);
                }
            });
        } else {
            thiz.openFeature(f);
        }
    }, function(error) {
        thiz.openFeature(f);
    });
}
NavigationDrawer.prototype.loadTeamLogo = function() {
    var thiz = this;
    Dom.removeClass(this.node(), "HasLogo");
    $teamInfoService.getTeamLogo(function (info) {
        var url = info == null || info.logoUrl.trim().length == 0 ? TEAM_INFO.seDefaultTeamLogoPath : info.logoUrl;
        if (url && url.length > 0) {
            thiz.teamLogo.setUrl(url.startsWith("/") ? url : "/" + url);
            Dom.addClass(thiz.node(), "HasLogo");
        }
    }, function(error) {
    });
}
NavigationDrawer.prototype.toggle = function(expanded) {
    var thiz = this;
    this._isExpanded = typeof(expanded) == "boolean" ? expanded : !this._isExpanded;
    Dom.removeClass(this.node(), "Expanded");
    Dom.removeClass(this.node(), "Collapsed");
    Dom.addClass(this.node(), this._isExpanded ? "Expanded" : "Collapsed");
    localStorage.setItem(NavigationDrawer.STORAGE_KEY_LAST_EXPANDED, this._isExpanded);
    this.initTitle();
}

NavigationDrawer.prototype.initTitle = function() {
    var thiz = this;
    Dom.doOnSelector(this.menuItemsContainer, "ul.Menu > .Primary", function(node) {
        if (thiz._isExpanded) {
            node.title = "";
        } else {
            node.title = thiz.getFeatureName(node._feature);
        }
    });
}
NavigationDrawer.prototype.getFeatureName = function(feature) {
    var featureName = feature.name;
    if (typeof(feature.name) == "function") {
        featureName = feature.name();
    }

    featureName = TeamLocalizer.getString(featureName);
    if (!feature.terminologyRequired || feature.terminologyRequired()) {
       featureName = FormatUtil.term(featureName);
    }
    return featureName;
}

NavigationDrawer.prototype.handleItemClick = function (event) {
    var item = Dom.findUpwardForNodeWithData(event.target, "_feature");
    if (!item) return;
    var feature = item._feature;
    if (feature.extra && feature.extra.count > 0) {
        Dom.doOnSelector(item, ":scope label.Badge", function(badge) {
            badge.parentNode.removeChild(badge);
            Dom.removeClass(item, "HasBadge");
        });
    }
    if (feature.implementation) {
        var p = Dom.findParentWithClass(item, "Primary");
        if (p) Dom.removeClass(p, "Hover");

        p = Dom.findParentWithClass(item, "SubMenuBoxWrapper");
        if (p) Dom.removeClass(p, "Active");

        this.openFeature(feature);
    }
};
NavigationDrawer.prototype.openFeature = function(feature, callback) {
    //Reject open feature when _pastDueDialog is showing
    if (AdminConsole.instance && AdminConsole.instance._currentInvoiceStatusInfo
        && (typeof(AdminConsole.instance._pastDueDialog) != "undefined" && AdminConsole.instance._pastDueDialog._shown)
        && (!AdminConsole.instance._currentInvoiceStatusInfo.dismissable
        || AdminConsole.instance._currentInvoiceStatusInfo.pastDue >= 90)) {
        if (callback) callback();
        return;
    }
    if (typeof(feature.implementation) === "function" && typeof(window[feature.implementation.name]) === "undefined") {
        feature.implementation();
        if (callback) callback();
        return;
    }
    var adminConsole = BaseWidget.findUpward(this.node(), AdminConsole);
    if (!adminConsole) return;
    var thiz = this;
    if (this._showingFeature != null
        && (this._showingFeature.implementation === feature.implementation
            && this._showingFeature.data === feature.data
            && this._showingFeature.module === feature.module)) {
        //Ensure at least one menu activated
        if (!feature.implementation.src) {
            this.markSelectedMenu(feature, thiz.node());
            if (this._showingFeature._createdWidget && this._showingFeature._createdWidget.reOpened) {
                this._showingFeature._createdWidget.reOpened();
            }
            return;
        }
    }
    this._pendingOpenFeature = feature;
    adminConsole.launch(feature, function() {

        Dom.doOnChildRecursively(thiz.node(), function (n) {
            return n && n._feature;
        }, function (n) {
            Dom.removeClass(n, "Active");
        });

    }, function (widget, iframe) {
        delete thiz._pendingOpenFeature;
        thiz._showingFeature = feature;
        thiz._showingFeature._createdWidget = widget;
        localStorage.setItem(NavigationDrawer.STORAGE_KEY_LAST_FEATURE_ID, feature.id);

        setTimeout(function(){
            thiz.markSelectedMenu(feature, thiz.node());
        }, 200);

        var navModule = null;
        if (widget) {
            navModule = widget.getNavigationModule ? widget.getNavigationModule() : widget;
        } else {
            navModule = thiz.createFrameNavigationModule(iframe, feature);
        }

        CommonNavigation.onNavigateToChildModule(this.navigationModule, feature.id, navModule);
        if (feature.module) {
            navModule.navigate(feature.module, function (childModule) {
                CommonNavigation.onNavigateToChildModule(navModule, feature.module, childModule);
            });
        }

        if (callback) {
            callback(widget, iframe, navModule);
        } else {
            if (navModule && navModule.onFinishAsLeaf) navModule.onFinishAsLeaf();
        }
    }.bind(this));
}
NavigationDrawer.prototype.markSelectedMenu = function(feature, menu) {
    var thiz = this;
    if (!feature) {
        feature = this._showingFeature;
    }
    if (!menu) {
        menu = this.node();
    }
    var activeFunc = function(node) {
        var hasF = thiz.hasFeature(feature, node._feature);
        Dom.toggleClass(node, "Active", hasF);
    };
    Dom.doOnSelector(menu, ":scope .MenuItem", activeFunc);
    Dom.doOnSelector(AdminConsole.instance.node(), ":scope > .SubMenuBox.SubMenuBoxWrapper .MenuItem", activeFunc);
}
NavigationDrawer.prototype.hasFeature = function(lookupFeauture , library) {
    if (lookupFeauture.id == library.id) return true;
    if (library.features) {
        for (var i = 0; i< library.features.length; i++) {
            var ok = this.hasFeature(lookupFeauture, library.features[i]);
            if (ok) return true;
        }
    }
    return false;
}

NavigationDrawer.prototype._setValue = function(obj, name, getFn, callback) {
    // First match everything inside the function argument parens.
    var args = getFn.toString().match(/^function\s*?\(([^)]+).*\)/);
    args = args ? args[1] : null;
    // Execute the simple function directly
    var item = obj;
    if (!item) return;
    if (!args) {
        item[name] = getFn();
        if (callback) callback();
        return;
    }
    getFn(function receiveValue(val) {
        item[name] = val;
        if (callback) callback();
    });
};

NavigationDrawer.prototype.loadMenuImpl = function(menuItem, callback) {
    var provider = menuItem.provider;
    if (!provider)  {
        callback(menuItem);
        return;
    }

    new provider().getMenus(function(items) {
        menuItem.features = items;
        if (callback) {
            callback(menuItem);
        }
    });
}

NavigationDrawer.prototype.loadDynamicMenu = function(features, callback) {
    var index = 0;
    var thiz = this;

    function next() {
        var f = index >= features.length ? undefined : features[index];
        index ++;
        if (!f) {
            if (callback && !callback._invoked) {
                callback();
                callback._invoked = true;
            }
            return;
        }
        var checkVisible = function(item, callbackVisible) {
            var featureKey = item.featureKey || "";
            var assigned = true;
            if (featureKey && thiz.teamFeatures) {
                assigned = thiz.teamFeatures.indexOf(featureKey) >= 0;
            }
            if (typeof(item.role) == "string") {
                item.visible = AdminConsole.instance.isAdminTypeAtLeast(item.role) && assigned;
                //console.log("Visible... with role ", item.id, item.visible, item.role);
                if (callbackVisible) callbackVisible();
            } else if (typeof item.visible == "function") {
                thiz._setValue(item, "visible", item.visible, function() {
                    item.visible = item.visible && assigned;
                    if (callbackVisible) callbackVisible();
                    //console.log("Visible... with custom function", item.id, item.visible);
                });
            } else if ((typeof (f.visible) === "string") || (typeof (f.visible) === "boolean")) {
                f.visible = "true" == ("" + f.visible) && assigned;
                //console.log("Visible... with boolean or string", f.id, f.visible);
                if (callbackVisible) callbackVisible();
            } else {
                f.visible = true && assigned;
                //console.log("Force visible menu item", f.id, f.visible);
                if (callbackVisible) callbackVisible();
            }
        };
        var checkVisibleWithChildren = function(menuItem) {
            var visibleCount = 0;
            for (var j = 0; j < menuItem.features.length; j++) {
                if (menuItem.features[j].visible) visibleCount++;
            }
            menuItem.visible = visibleCount > 0 && (menuItem.visible || typeof(menuItem.visible) == "undefined");
            //console.log("Visible... with children's visibility ", menuItem.id, menuItem.visible, menuItem.features);
        };
        if (f.provider) {

            thiz.loadMenuImpl(f, function(menuItem) {
                //console.log("Load menu with provider: ", f.provider, menuItem.id);
                checkVisible(menuItem, function(){
                    if (menuItem.features && menuItem.features.length > 0) {
                        thiz.loadDynamicMenu(menuItem.features, function() {
                            checkVisibleWithChildren(menuItem);
                            next();
                        });
                    } else {
                        next();
                    }
                });
            });
        } else if (f.features && f.features.length > 0) {
            thiz.loadDynamicMenu(f.features, function(){
                //console.log("Load sub menu of: ", f.id, f.features);
                checkVisible(f, function() {
                    checkVisibleWithChildren(f);
                    next();
                });
            });
        } else {
            checkVisible(f, function() {
                next();
            });
        }
    }
    next();
};
NavigationDrawer.prototype.isVisibleMenuItem = function(feature) {
    if (!feature || !feature.visible || feature.hidden) return false;
    if (feature.features && feature.visible && feature.features.length == 0) return false;

    // YMCA team is not customer team (Non TU team) - Only show ymca admin menu tools and Finish TeamUnify Update menu items
    var allowFeaturesForYMCANonTuTeam = ["smmigration-landing-page", "website-design", "help-training", "help-training-header", "se-help-training", "unpublish-site", "system-overview",
            "team-tool", "team-tool-membership-header", "ama2-accounts", "ama2-members", "permission-management-header", "permission-management"];
    if(TEAM_INFO.isNonTUTeam && !feature.id.startsWith("yusa-") && allowFeaturesForYMCANonTuTeam.indexOf(feature.id) < 0) return false;

    if (feature.features) {
        var visible = 0;
        for (var i = 0; i < feature.features.length; i++) {
            if (this.isVisibleMenuItem(feature.features[i])) {
                visible ++;
            }
        }
        return visible > 0;
    }
    return true
}
NavigationDrawer.prototype.onReceivedExtra = function(ref, extra) {
    var menuItem = ref.menuItem;
    var childSpec = undefined;
    var feature = menuItem._feature;
    if (!menuItem || !feature) return;
    feature.extra = extra || {};
    if (typeof(extra) != "undefined") {
        var count = extra.count || 0;
        if (count) {
            childSpec = {
                    _name: "label",
                    "class": "Badge " + " " + feature.id + (typeof(count) == "string" ? " Text" : ""),
                    _children: [{_name: "span", _text: "" + count}]
                };
        }
    }
    var badges = menuItem.querySelectorAll(".Badge");
    if (badges) {
        Array.prototype.forEach.call(badges, function (badge) {
            if (badge && badge.parentNode) {
                badge.parentNode.removeChild(badge);
            }
        });
    }
    if (childSpec && menuItem.childNodes && menuItem.childNodes.length > 0) {
        menuItem.childNodes[0].appendChild(Dom.newDOMElement(childSpec));
        Dom.addClass(menuItem, "HasBadge");
    }
}
NavigationDrawer.prototype.populateFeatures = function (container, features, sectionMenu) {
    var thiz = this;
    var top = false;
    if (!container) {
        this.featureMap = {};
        container = this.menuItemsContainer;
        top = true;
    }
    var ul = this.node().ownerDocument.createElement("ul");
    container.appendChild(ul);
    Dom.addClass(ul, !sectionMenu ? "Menu" : "SubMenu");

    for (var i = 0; i < features.length; i ++) {
        var feature = features[i];
        var itemVisible = this.isVisibleMenuItem(feature);

        if (itemVisible || (!feature.features && feature.visible && feature.hidden)) this.featureMap[feature.id] = feature;
        if (!itemVisible) continue;

        var _children = [];
        var imgIcon = feature.icon && (feature.icon.indexOf(".png") >= 0 || feature.icon.indexOf(".jpg") >= 0);
        if (imgIcon) {
            _children.push({
                    _name: "img",
                    "src": feature.icon
                });
        } else {
            _children.push({
                    _name: "icon",
                    "class": feature.icon || "checkbox-blank-circle-outline"
                });
        }

        var featureName = this.getFeatureName(feature);
        var flag = feature.flag;
        if (!flag) {
            if (featureName.indexOf("(BETA)") >= 0) {
                flag = "BETA";
                featureName = featureName.replace(/\(BETA\)/g, "").trim();
            }
        }

        var flagSpec = undefined;
        if (flag) {
            flagSpec = {
                    _name: "span",
                    "class": "Flag " + flag,
                    _text: flag};
        }

        var link = {
            _name: "a",
            _text: featureName
        };
        if (!feature.features || feature.features.length == 0) {
            link.href = "#/" + feature.id;
        }
        _children.push({
                _name: "label",
                flex: 1,
                _children: [link, flagSpec]});

        _children.push({
                _name: "icon",
                "class": "ExpandStatus"
            });

        var li = Dom.newDOMElement({
            _name: "li",
            "class": (feature.features ? "HasChild " + (sectionMenu ? "Header" : "")   : "") + " " + feature.id ,
            title: this.getFeatureName(feature),
            _children: [
                {
                    _name: "hbox",
                    _children: _children
                }
            ]
        });
        li._feature = feature;
        feature._currentListItem = li;

        ul.appendChild(li);
        Dom.addClass(li, feature.hidden ? "Hidden" : "");
        Dom.addClass(li, "MenuItem " + (sectionMenu ? "" : "Primary"));

        if (feature.notificationProvider) {
            this._initiateNotificationUpdate(li, feature);
        }

        if (feature.features && feature.features.length > 0) {
            var box = Dom.newDOMElement({
                _name: "vbox",
                "class": "SubMenuBox " + feature.id + " " + (sectionMenu ? "" : "SubMenuBoxWrapper")});

            if (feature.icon) {
                if (imgIcon) {
                    box.appendChild(Dom.newDOMElement({
                        _name: "img",
                        "src": feature.icon,
                        "class": "SubMenuIcon"}));
                } else {
                    box.appendChild(Dom.newDOMElement({
                        _name: "icon",
                        "class": "SubMenuIcon " + feature.icon}));
                }
            }
            this.populateFeatures(box, feature.features, true);
            if (sectionMenu) {
                li.appendChild(box);
            } else {
                var id = widget.random();
                var liId = widget.random();
                box.setAttribute("id", id);
                li.setAttribute("popup-menu-id", id);
                li.setAttribute("id", liId);
                box.setAttribute("menu-item-id", liId);
                this.node().parentNode.appendChild(box);
                this.bind("click", this.handleItemClick, box);
                Dom.registerEvent(box, "mouseenter", NavigationDrawer.handleSubItemsEnter);
                Dom.registerEvent(box, "mouseleave", NavigationDrawer.handleSubItemsLeave);
            }
        } else {
            if (!feature.implementation) Dom.addClass(li, "NotImplemented");
            if (feature.default) this.defaultFeature = feature;
            Dom.addClass(li, "Empty");
        }

        if (top) {
            Dom.registerEvent(li, "mouseenter", NavigationDrawer.handleItemEnter);
            Dom.registerEvent(li, "mouseleave", NavigationDrawer.handleItemLeave);
        }
    }
};
NavigationDrawer.prototype.afterPopulateFeatures = function() {
    var thiz = this;
    Dom.doOnSelector(AdminConsole.instance.node(), ":scope > .SubMenuBox.SubMenuBoxWrapper", function(node) {
        var menu = Dom.findFirstChildWithClass(node, "SubMenu");
        var subs = Dom.findChildrenWithClass(menu, "Header");
        if (subs.length >= 3) {
            Dom.addClass(node, "Large");
            Dom.addClass(menu, "Large");
        } else {
            Dom.removeClass(node, "Large");
            Dom.removeClass(menu, "Large");
        }
    });
    Dom.doOnSelector(this.menuItemsContainer, ":scope > .MenuItem.Primary.HasChild", function(node) {
        thiz.calculatePosition(node);
    });
    $cmsMigration.getCMSMigrationStatus(function(status){
        if (status == "Live" || status == "Sandboxed") {
            var isWebsiteDesignAccess = PermissionUtils.hasAnyPermission(PERMISSION_KEY.CMS_Website_Design, PERMISSION_KEY.CMS_Website_PublishUnpublish, PERMISSION_KEY.CMS_BasicContent_View);
            var hasLink = !isWebsiteDesignAccess && status == "Sandboxed" ? false : true;
            console.log("hasLink" + hasLink);
            if (hasLink) {
                Dom.addClass(thiz.linkTeamWebsite, "Active");
            }
        } else {
            Dom.removeClass(thiz.linkTeamWebsite, "Active");
        }
        thiz._invalidateScroll();
    }, function(e){});
    this._invalidateScroll();
}

NavigationDrawer.prototype.getNavigationModuleForFeatures = function (features) {
    var thiz = this;
    return {
        navigate: function (name, callback) {
            var feature = thiz.featureMap[name];
            if (!feature || !feature.visible || thiz._pendingOpenFeature == feature) {
                callback(null);
                return;
            }

            thiz.openFeature(feature, function (widget, iframe, createdNavModule) {
                var navModule = createdNavModule;
                if (!navModule) {
                    if (widget) {
                        navModule = widget.getNavigationModule ? widget.getNavigationModule() : widget;
                    } else {
                        navModule = thiz.createFrameNavigationModule(iframe, feature);
                    }
                }
                callback(navModule);

                thiz.markSelectedMenu(feature, thiz.node());
            });
        },
        close: function () {}
    };
};
NavigationDrawer.prototype.createFrameNavigationModule = function (frame, feature) {
    return {
        navigate: function (name, callback) {
            if (name && name.match(/^p:([a-z0-9]+)$/i)) {
                var qs = atob(RegExp.$1);
                var src = feature.implementation.src;
                src += (src.indexOf("?") > 0 ? "&" : "?") + qs;
                frame._pendingSrc = null;
                var newSrc = feature.enhanceSrc ? feature.enhanceSrc(src) : src;
                frame.src = newSrc;
                callback({ navigate: function (n, c) {c(null);}, close: function (callback) {
                    frame.src = newSrc;
                    if (callback) callback();
                }});

                return;
            }
            if (!feature.getSubPageUrl) {
                callback(null);
                return;
            }

            var url = feature.getSubPageUrl(name);
            if (url) {
                frame._pendingSrc = null;
                frame.src = url;
                callback({ navigate: function (n, c) {c(null);}, close: function () {
                    frame.src = feature.implementation.src;
                } });
            } else {
                callback(null);
            }
        },
        onFinishAsLeaf: function (callback) {
            if (!frame || !frame._pendingSrc) {
                if (callback) callback();
                return;
            }

            var src = frame._pendingSrc;
            window.setTimeout(function () {
                frame.src = src;
            }, 100);
            frame._pendingSrc = null;

            if (callback) callback();
        },
        close: function(callback) {
            if (callback) callback();
        }
    };
};
NavigationDrawer.prototype.getNavigationModule = function () {
    this.navigationModule = this.getNavigationModuleForFeatures(this.menuItemDataList);
    return this.navigationModule;
};
NavigationDrawer.prototype.onSizeChanged = function() {
    this._invalidateScroll();
}
NavigationDrawer.prototype._invalidateScroll = function () {
    var height = this.menuBox.getBoundingClientRect().height;
    var contentHeight = this.menuItemsContainer.scrollHeight;
    var scrollTop = Math.min(this.menuItemsContainer.scrollTop, contentHeight - height);
    var topOverlow = scrollTop > 0;
    var bottomOverlow = (contentHeight > Math.round(height + this.menuItemsContainer.scrollTop + 0.49999));
    Dom.toggleClass(this.menuBox, "OverflowTop", topOverlow);
    Dom.toggleClass(this.menuBox, "OverflowBottom", bottomOverlow);
};
NavigationDrawer.prototype._handlePrev = function () {
    this.prevButton.blur();
    if (!Dom.hasClass(this.menuBox, "OverflowTop")) return;
    var delta = Math.min(Math.round(2 * Util.em()), this.menuItemsContainer.scrollTop);
    this.menuItemsContainer.scrollTop -= delta;
    this._invalidateScroll();
};
NavigationDrawer.prototype._handleNext = function () {
    this.nextButton.blur();
    if (!Dom.hasClass(this.menuBox, "OverflowBottom")) return;
    var remaining = this.menuItemsContainer.scrollHeight - (this.menuBox.offsetHeight + this.menuItemsContainer.scrollTop);
    var delta = Math.min(Math.round(2 * Util.em()), remaining);
    this.menuItemsContainer.scrollTop += delta;
    this._invalidateScroll();
};
NavigationDrawer.prototype._handleWheel = function (event) {
    if (event.deltaY >= 0) {
        this._handleNext();
    } else {
        this._handlePrev();
    }
};
NavigationDrawer.prototype._initiateNotificationUpdate = function (li, feature) {
    var thiz = this;

    var instance = new feature.notificationProvider({menuItem: li});
    var getFn = instance.getNotificationInfo;
    if (typeof(getFn) == "function") {
        getFn.call(instance, function(ref, extra) {
            thiz.onReceivedExtra(ref, extra);
        });
    }
};
NavigationDrawer.prototype.updateNotification = function (name) {
    var feature = this.featureMap[name];
    if (!feature || !feature.notificationProvider || !feature._currentListItem) return;

    this._initiateNotificationUpdate(feature._currentListItem, feature);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/PageContentWrapper.js";

function PageContentWrapper() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, PageContentWrapper);
PageContentWrapper.prototype.reset = function () {
    this.pageContainer.innerHTML = "";
    this.iframe.src = "about:blank";
    Dom.addClass(this.node(), "WidgetMode");
    Dom.removeClass(this.node(), "IFrameMode");
};
PageContentWrapper.prototype.sendPageView = function(pageTitle, url) {
    /*ga(function() {
      // Logs an array of all tracker objects.
        var trackers = ga.getAll();
        if (!trackers || trackers.length == 0) {
            console.log("No trackers found");
            return;
        }
        for (var i = 0; i < trackers.length; i++) {
            var tracker = trackers[i];
            var name = tracker.get('name');
            tracker.set("page", pageTitle, url);
            tracker.set("location", url);
            ga(name  + ".send", "pageview");
        }
    });*/
   
    gtag('event', 'page_view', {
        'page_title': pageTitle,
        'page_location': url
    });
}
PageContentWrapper.prototype._configureSelfScrollManagedChild = function (featureWidget) {
    Dom.toggleClass(this.pageContainer, "WithSelfScrollManagedChild", (featureWidget && featureWidget._selfScrollManaged) ? true : false);
};

PageContentWrapper.prototype.launch = function (feature, preExecuteCallback,  callback) {
    var name = typeof(feature.name) == "function" ? feature.name() : feature.name;
    this.indicator = AdminConsole.instance.asCustomIndicator("Loading " + name + "...");
    var thiz = this;

    var next = function () {
        if (preExecuteCallback) preExecuteCallback();

        var f = feature.implementation;
        if (typeof(f) == "function") {
            this.pageContainer.innerHTML = "";
            var f = new f();
            
            thiz._configureSelfScrollManagedChild(f);
            
            this.featureWidget = f.into(this.pageContainer, feature.data);
            Dom.addClass(this.node(), "WidgetMode");
            Dom.removeClass(this.node(), "IFrameMode");
            if (f instanceof Dialog) {
                Dom.addClass(this.node(), "HostedDialog");
            } else {
                Dom.removeClass(this.node(), "HostedDialog");
            }

            var createdWidget = this.featureWidget;

            if (callback) {
                callback(createdWidget);
            }

            window.setTimeout(function(){
                thiz.sendPageView(name, window.location);
            }, 2000);

        } else if (typeof(f) == "string" && f.match(/^([a-z0-9]+):([a-z0-9]+)$/i)) {
            var ns = RegExp.$1;
            var clazz = RegExp.$2;

            widget.createWidgetAsync(ns, clazz, {}, function (w) {
                this.pageContainer.innerHTML = "";
                var impl = widget.namespaces[ns][clazz];

                thiz._configureSelfScrollManagedChild(w);
                this.featureWidget = w.into(this.pageContainer, feature.data);
                Dom.addClass(this.node(), "WidgetMode");
                Dom.removeClass(this.node(), "IFrameMode");
                if (w instanceof Dialog) {
                    Dom.addClass(this.node(), "HostedDialog");
                } else {
                    Dom.removeClass(this.node(), "HostedDialog");
                }

                var createdWidget = this.featureWidget;

                if (callback) {
                    callback(createdWidget);
                }

                window.setTimeout(function(){
                    thiz.sendPageView(name, window.location);
                }, 2000);

            }.bind(this));

        } else if (f.src) {
            var actualSrc = (typeof(f.src) == "function") ? f.src() : f.src;
            this.iframe.src = "about:blank";

            window.setTimeout(function () {
                this.indicator.busy();
                Dom.addClass(this.node(), "IFrameMode");
                Dom.removeClass(this.node(), "WidgetMode");
                this.featureWidget = null;
                this.bind("DOMContentLoaded", function () {
                    //console.log("Dom content of ifram loaded....");
                    var thiz = this;
                    if (this.indicator) {
                        this.indicator.done();
                    }
                    this.iframe.contentWindow.addEventListener("unload", function (event) {
                        if (AdminConsole.instance.userSession) {
                            thiz.indicator.busy();
                        }
                    }, false);

                }, this.iframe);
                // this.iframe.src = actualSrc;
                this.iframe._pendingSrc = actualSrc;

                window.setTimeout(function(){
                    thiz.indicator.done();
                    thiz.sendPageView(name, actualSrc);
                }, 2000);

                if (callback) callback(null, this.iframe);
            }.bind(this), 10);
        }
    }.bind(this);

    if (this.featureWidget && this.featureWidget.confirmClosing) {
        this.featureWidget.confirmClosing(next);
    } else {
        next();
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/ProfileBar.js";

function ProfileBar() {
    BaseTemplatedWidget.call(this);

    this.bind("click", function() {
        Dom.addClass(this.messageBadge, "Read");
        this.open("alert-center");
    }, this.viewMyMessageAction);

    this.bind("click", function() {
        Dom.addClass(this.teamFeedBadge, "Read");
        this.open("communication-team-feed");
    }, this.teamFeedAction);
    this._menu = null;
    this.activeProfile = false;
    this.invalidateStatus();
    ProfileBar.instance = this;
    Dom.registerEvent(this.profileInfoContainer, "mouseenter", ProfileBar.handleEnter);
    Dom.registerEvent(this.profileInfoContainer, "mouseleave", ProfileBar.handleLeave);
}
__extend(BaseTemplatedWidget, ProfileBar);


ProfileBar.handleEnter = function (event) {
    var profileBar = ProfileBar.instance;
    if (profileBar._leaveTimeout) {
        window.clearTimeout(profileBar._leaveTimeout);
        profileBar._leaveTimeout = null;
    }
    if (profileBar._enterTimeout) window.clearTimeout(profileBar._enterTimeout);
    profileBar._enterTimeout = window.setTimeout(function () {
            profileBar.openMyMenu();
    }, 200);
};

ProfileBar.handleLeave = function (event) {
    var profileBar = ProfileBar.instance;
    if (profileBar._enterTimeout) {
        window.clearTimeout(profileBar._enterTimeout);
        profileBar._enterTimeout = null;
    }
    if (profileBar._leaveTimeout) window.clearTimeout(profileBar._leaveTimeout);
    profileBar._leaveTimeout = window.setTimeout(function () {
        profileBar.hideMyMenu();
    }, 200);
};

ProfileBar.prototype.invalidateStatus = function() {
    Dom.removeClass(this.menuDown, "chevron-left");
    Dom.removeClass(this.menuDown, "chevron-right");
    Dom.addClass(this.menuDown, this.activeProfile ? "chevron-left" : "chevron-right");
    if (this.activeProfile) {
        Dom.addClass(this.profileInfoContainer, "Active");
    } else {
        Dom.removeClass(this.profileInfoContainer, "Active");
    }
}

ProfileBar.prototype.onAttached = function() {
}

ProfileBar.prototype.createMenuBar = function() {
    var thiz = this;
    var menu = new Menu();
    menu.onHide = function() {
        thiz.activeProfile = false;
        thiz.invalidateStatus();
        Dom.unregisterEvent(this.popupContainer, "mouseenter", ProfileBar.handleEnter);
    }
    menu.shouldCloseOnBlur = function(event) {
        var found = Dom.findUpward(event.target, function (node) {
            return node == thiz.profileInfoContainer;
        });
        return !found;
    };
    menu.setPopupClass("GlobalProfileMenu");

    menu.register({
        id: "myAccount",
        label: "My Account",
    });
    
    var adminConfig = this.createRoleConfig(this.session.accountRoleNames);
    menu.register(adminConfig);

    if (this.session.coach) {
        var mainSetConfig = this.createMainSetCoachConfig();
        mainSetConfig.class = "ViewOnly";
        menu.register(mainSetConfig);
    }
    
    if(!TEAM_INFO.isNonTUTeam) {
        menu.register({ label: "Update Profile", id: "updateProfile", run: function(){
            thiz.open("my-account");
        }});
    }
    
    menu.register({
        id: "privacyOptions",
        label: "Privacy Options",
    });
    
    menu.register({ 
        label: "Ad Choices", 
        run: function () {
            window.open(APP_INFO.AD_CHOICES_URL, "_blank");
        } 
    });

    menu.register({ 
        label: "Privacy Policy", 
        run: function () {
            window.open(APP_INFO.PRIVACY_POLICY_URL, "_blank");
        } 
    });    

    menu.register({ 
        id: "yourPrivacyChoices",
        label: "Your Privacy Choices",
        image: "/v2/privacy/privacyoptions.svg",

        // OneTrust CMP JavaScript (cdn.cookielaw.org/consent) is injected via GTM.
        run: function () {
            if (typeof syncAndShowOneTrustConsentModal === "function") {
                syncAndShowOneTrustConsentModal();
            } else if (typeof OneTrust?.ToggleInfoDisplay === "function") {
                OneTrust.ToggleInfoDisplay();
            } else {
                console.warn("OneTrust modal functions are not available yet.");
            }
        }
    });

    menu.register({ 
        label: "CA Notice", 
        run: function () {
            window.open(APP_INFO.CA_NOTICE_URL, "_blank");
        } 
    });

    menu.register({ 
        label: "Terms of Use", 
        run: function () {
            window.open(APP_INFO.TERM_AND_CONDITION_URL, "_blank");
        } 
    });
    
    
    menu.register({icon: "logout-variant", label: "SIGN OUT", id: "logout", run: function () {
        var adminConsole = thiz.findUpward(AdminConsole);
        Dialog.confirm("Are you sure you want to sign out?", "Signing out will terminate your current administration session.", "Sign out", function () {
            adminConsole.logout();
        }, "Cancel");
    }});
    return menu;
}

ProfileBar.prototype.openMyMenu = function() {
    if (this.activeProfile) return;

    this.activeProfile = true;
    this.invalidateStatus();
    if (this._menu == null) {
        this._menu = this.createMenuBar();
    }
        
    this._menu.showMenu(this.node(), "right", "top-inside", 0, 0);
    Dom.registerEvent(this._menu.popupContainer, "mouseenter", ProfileBar.handleEnter);
    
    // Do this here so the label is update when the popout displays.
    ProfileBar.instance.oneTrustShowPrivacyLabelIcon()
    ProfileBar.instance.oneTrustUpdatePrivacyLabelTag();
};

ProfileBar.prototype.oneTrustShowPrivacyLabelIcon = function () {
  /* 
    Toggles the visibility of the privacyoptions.svg icon based on the user's geolocation 
    (U.S. vs. non-U.S.), as determined by OneTrust.
    
    The OneTrust CMP JavaScript (`cdn.cookielaw.org/consent`) is injected using GTM.
  */        

  if (OneTrust?.getGeolocationData) {
    var privacyIcon = document.querySelector(".MenuItem_yourPrivacyChoices img.MenuIcon");

    if (privacyIcon) {
      privacyIcon.style.display = OneTrust.getGeolocationData()?.country === "US" ? "" : "none";
    }
  }
};

ProfileBar.prototype.oneTrustUpdatePrivacyLabelTag = function() {
  /* 
    Dynamically updates the OneTrust Privacy CMP label based on the user's geolocation 
    (U.S., E.U., or other regions). 

    OneTrust may replace the text dynamically with values such as:
    - "Your Privacy Choices"
    - "Cookie Preferences"
    - "Cookie Notice"

    The OneTrust CMP JavaScript (`cdn.cookielaw.org/consent`) is injected using GTM.
  */        

  var privacyLabel = document.querySelector(".MenuItem_yourPrivacyChoices label");

  if (privacyLabel) {
    privacyLabel.textContent = OneTrust?.GetDomainData?.()?.CookieSettingButtonText || privacyLabel.textContent;
  }
};

ProfileBar.prototype.hideMyMenu  = function() {
    if (this._menu && this._menu.isVisible()) {
        this._menu.hide();
    }
}
ProfileBar.prototype.open = function (id) {
    var features = AdminSectionManager.features;
    var feature = this.getFeature(features, id);
    if (!feature) {
        console.log("Open menu  " + id + " failed");
        return;
    }
    NavigationDrawer.instance.openFeature(feature);
}

ProfileBar.prototype.getFeature = function(features, id) {
    for (var i = 0; i < features.length; i++) {
        var feature = features[i];
        if (id == feature.id) return feature;
        if (feature.features) {
            var f = this.getFeature(feature.features, id);
            if (f) return f;
        }
    }
    return undefined;
}

ProfileBar.prototype.setSession = function (session) {
    this.session = session;
    Dom.setInnerText(this.userFullNameLabel, session.first_name + " " + session.last_name);
    this.profileAvatar.setUrl("/rest/accounts/avatar/cdn/" + ADMIN_CONTEXT.teamAlias + "/" + session.accountID + "?w=150&t=" + (new Date().getTime()));
    var thiz = this;

    if (AdminConsole.instance.isLoggedWithRole(Role.NotAnAdmin)) {
        Dom.addClass(this.actionsContainer, "NoPermission");
    } else if (AdminConsole.instance.isAdminTypeAtLeast(Role.SuperUser)) {
        Dom.removeClass(this.actionsContainer, "NoPermission");
        if (ADMIN_CONTEXT.teamFeedEnabled) {
            Dom.removeClass(this.teamFeedAction, "Disabled");
        } else {
            Dom.addClass(this.teamFeedAction, "Disabled");
        }
        /*
        $cmsService.getAlertInfo(function(info) {
            if (info.alertCount > 0) {
                Dom.setInnerText(thiz.messageBadgeValue, info.alertCount + "");
                Dom.removeClass(thiz.messageBadge, "Read");
            } else {
                Dom.addClass(thiz.messageBadge, "Read");
            }

            if (info.teamFeedCount > 0) {
                Dom.setInnerText(thiz.teamFeedBadgeValue, info.teamFeedCount + "");
                Dom.removeClass(thiz.teamFeedBadge, "Read");
            } else {
                Dom.addClass(thiz.teamFeedBadge, "Read");
            }
        }, function(error){});*/
    } else {
        Dom.removeClass(this.actionsContainer, "NoPermission");
        Dom.addClass(thiz.messageBadge, "Read");
        Dom.addClass(thiz.teamFeedBadge, "Read");
    }
    this._menu = this.createMenuBar();
};

ProfileBar.prototype.createMainSetCoachConfig = function() {
    var imgDir = "/v2/mainset/img/MS/"
    return {
        id: "coach",
        label: "Coach",
        image: imgDir + "head-coach.png"
    };
}

ProfileBar.prototype.createRoleConfig = function(roles) {
    if (!roles || roles.length < 1) {
        return {
            id: "NoRoles",
            label: "No roles assigned",
            class: "ViewOnly"
        };
    }

    var roleLabel = roles[0];
    if (roles.length > 1) roleLabel += String.format(" (+{0})", roles.length - 1);
    return {
        id: "AccountWithRoles",
        label: roleLabel,
        icon: "account",
        iconColor: "#cecece",
        run: function() {
            widget.__ensureNamespaceLoaded("adminpermission", function (module) {
                module.util.openAccountRoleDetailDialog(this.session.accountID);
            }.bind(this));
        }.bind(this)
    }; 
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/QuickLoginDialog.js";

function QuickLoginDialog() {
    Dialog.call(this);
    this.bind("submit", this.handleLoginClick, this.loginForm);
    
    this.title = "Login";
    this.bind("p:LoginSuccess", this.handleLoginSuccess, this.loginView.node());
}
__extend(Dialog, QuickLoginDialog);
QuickLoginDialog.prototype.setup = function (options) {
    this.loginView.reset(options ? (options.email || "") : "");
};
QuickLoginDialog.prototype.getDialogActions = function () {
    return [
    ]
};
QuickLoginDialog.prototype.handleLoginSuccess = function () {
    this.close(this.loginView.session);
};



if (window) window.__currentScriptPath = "/cms/admin/widgets/SystemNotificationWidget.js";

function SystemNotificationWidget (node) {
    BaseTemplatedWidget.call(this);
};

__extend(BaseTemplatedWidget, SystemNotificationWidget);

SystemNotificationWidget.prototype.initialize = function () {
    var thiz = this;
    $cmsService.getSystemNotification(function(message) {
        if (message) {
            thiz.systemMessage.innerHTML = message;
            thiz.node().title = message;
            Dom.removeClass(thiz.node(), "Hidden");
        } else {
            Dom.addClass(thiz.node(), "Hidden");
        }
    }, function (err) {
        Dom.addClass(thiz.node(), "Hidden");
    });
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/SystemPageWidget.js";

function SystemPageWidget() {
    BaseTemplatedWidget.call(this);
    this.resources = [];
}
__extend(BaseTemplatedWidget, SystemPageWidget);

SystemPageWidget.prototype.setup = function (data) {
    this.systemPageContent.innerHTML = "";
    var spinner = new Spinner("Loading....");
    spinner.busy();
    $cmsService.getSystemPageContent(data, function(info){
        this.initWithInfo(info, spinner);
    }.bind(this), function(e) {
        spinner.done();
    });
};
SystemPageWidget.prototype.initWithInfo = function(info, spinner) {
    var html = info.html || "";
    var thiz = this;
    if (info.webResources && info.webResources.length > 0) {
        var index = -1;
        var next = function(callback) {
            index += 1;
            if (index >= info.webResources.length) {
                callback();
                return;
            }
            var resource = info.webResources[index];
            if (resource.type == "JavaScript") {
                widget.__loadScript(resource.href, function(data) {
                    thiz.resources.push(Dom.getTarget(data));
                    next(callback);
                });
            } else if (resource.type == "StyleSheet") {
                widget.__loadStylesheet(resource.href, function(data) {
                    thiz.resources.push(Dom.getTarget(data));
                    next(callback);
                });
            } else if (resource.type == "Custom") {
                var customContent = resource.customContent || "";
                if (customContent.indexOf("<meta") == 0)  {
                    next(callback);
                } else {
                    console.log("Custom content: ", customContent);
                    html += customContent;
                    next(callback);
                }
            }
        };
        next(function() {
            spinner.done();
            thiz.setInnerHTMLWithScript(thiz.systemPageContent, html);
        });
    } else {
        thiz.setInnerHTMLWithScript(thiz.systemPageContent, html);
        spinner.done();
    }
}
SystemPageWidget.prototype.into = function (container, data) {
    container.appendChild(this.node());
    this.setup(data);
    return this;
};

SystemPageWidget.prototype.setInnerHTMLWithScript = function(elm, html) {
    var thiz = this;
    var loadResources = Util.setInnerHTMLWithScript(elm, html);
    if (loadResources) {
        this.resources = this.resources.concat(loadResources);
    }
    Dom.doOnSelector(this.node(), ".ImageContainer > img", function (image) {
        Dom.registerEvent(image, "load", thiz.handleImageLoad);
        Dom.registerEvent(image, "error", thiz.handleImageError);
    });
}

SystemPageWidget.prototype.onDetached = function() {
    if (!this.resources) return;
    for (var i = 0; i < this.resources.length; i++) {
        var r = this.resources[i];
        if (r.parentNode) {
            r.parentNode.removeChild(r);
        }
    };
    delete this.resources;
}
SystemPageWidget.prototype.handleImageLoad = function (event) {
    var image = event.target;
    Dom.addClass(image.parentNode, "Initialized");
    Util.cropImage(image, true, true);
}

SystemPageWidget.prototype.handleImageError = function(event) {
    var image = event.target;
    if (!image) return;
    image.parentNode.innerHTML = image.alt || "";
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/TestView.js";

function TestView() {
    BaseTemplatedWidget.call(this);

    this.bind("click", function () {
        console.log("getColor()", this.colorPicker.getColor());
        console.log("getRGBColorString()", this.colorPicker.getRGBColorString());
        console.log("getRGBAColorString()", this.colorPicker.getRGBAColorString());
    }, this.getButton);

    this.bind("click", function () {
        this.colorPicker.setColor("#33669977");
        this.colorPicker.setEnable(!this.colorPicker.isEnable());
    }, this.setButton);

    this.bind("p:ValueUpdated", function () {
        this.watcher.innerHTML = "" + this.colorPicker.getRGBAColorString();
    }, this.colorPicker);

    this.colorPicker.setColor(null);

    var USERS = [
        {name: "Pamala Starrett"},
        {name: "Aleisha Waldroup"},
        {name: "Floy Arroyo"},
        {name: "Lilian Stout"},
        {name: "Cristina Gerrish"},
        {name: "Leonila Borrelli"},
        {name: "Cleveland Posada"},
        {name: "Carol Fernandes"},
        {name: "Colby Maule"},
        {name: "Aura Christopher"},
        {name: "Beata Caplan"},
        {name: "Horacio Line"},
        {name: "Kip Pettus"},
        {name: "Jamal Trail"},
        {name: "Hershel Krueger"},
        {name: "Bernie Vogler"},
        {name: "Yolando Tapley"},
        {name: "Rachal Swaim"},
        {name: "Clarinda Oldham"},
        {name: "Dotty Gibson"},
        {name: "Luther Icenhour"},
        {name: "Simon Leary"},
        {name: "Maira Lovett"},
        {name: "Rosalyn Nilges"},
        {name: "Man Feemster"},
        {name: "Katia Klausner"},
        {name: "Gaylord Zaldivar"},
        {name: "Arturo Earley"},
        {name: "Milly Watchman"},
        {name: "Clayton Trapp"},
        {name: "Zelma Stiverson"},
        {name: "Jaimee Campa"},
        {name: "Faviola Showers"},
        {name: "Frank Waites"},
        {name: "Ching Shope"},
        {name: "Marcus Dinger"},
        {name: "Merlyn Payson"},
        {name: "Stefan Metayer"},
        {name: "Helene Trout"},
        {name: "Kandy Buitron"},
        {name: "Jonie Gills"},
        {name: "Janine Drews"},
        {name: "Suzann Gambrel"},
        {name: "Marivel Seawright"},
        {name: "Ariel Dorazio"},
        {name: "Devona Hewes"},
        {name: "Catina Hulme"},
        {name: "Cyndy Sponaugle"},
        {name: "Rosamond Spring"},
        {name: "Chana Premo"}
    ];
    var source = function (term, callback) {
        setTimeout(function () {
            var users = USERS.filter(function (u) {
                return !term || u.name.toLowerCase().indexOf(term.toLowerCase().trim()) >= 0;
            });
            callback(users);
        }, 100);
    };
    var renderer = function (user) {
        return user.name;
    };

    this.chipList.setup(source, renderer);
    this.chipList.setItems([{name: "Marcus Dinger"}, {name: "Chana Premo"}]);

    this.bind("click", function () {
        var result = ValidationManager.run(this.ruleSet);
        console.log(result);
    }, this.getListButton);

    this.ruleSet = new RuleSet()
        .live(true)
        .required(this.name, "Please enter name")
        .required(this.name2, "Please enter name, a much longer text to create a wrap.")
        .pattern(this.email, /^[a-z]+@[a-z\.]+$/, "Please enter a valid email address");
}
__extend(BaseTemplatedWidget, TestView);

TestView.prototype.onAttached = function () {
    this.balloon.onSizeChanged();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/USASDessPassNotification.js";

function USASDessPassNotification(ref) {
    this.ref = ref;
}
USASDessPassNotification.prototype.getNotificationInfo = function (callback) {
    var thiz = this;
    $usasDeckPassService.getCurrentAccountMemberSummaries(function (memberList) {
        if (memberList.live) {
            callback(thiz.ref, {count: "LIVE"});
        } else {
            var count = 0;
            memberList.summaries.forEach(function (member) {
                count += member.activityCount || (member.connected ? 0 : 1);
            })
            callback(thiz.ref, {count: count});
        }
    }, function (err) {
        callback(thiz.ref, {count: 0});
    });

    // $usasDeckPassService.getLiveStreamStatus(function (live) {
    //     callback({count: live ? "LIVE" : ""});
    // }, function (err) {
    //     callback({count: 0});
    // });

}


if (window) window.__currentScriptPath = "/cms/admin/widgets/WebDesignPage.js";

function WebDesignPage() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, WebDesignPage);


if (window) window.__currentScriptPath = "/cms/admin/widgets/template-management/AdminTemplateItemView.js";

function AdminTemplateItemView() {
    BaseTemplatedWidget.call(this);
    this.variantSelectorEnabled = false;

}
__extend(BaseTemplatedWidget, AdminTemplateItemView);

AdminTemplateItemView.prototype.setTemplate = function (template) {
    this.template = template;
    Dom.setInnerText(this.nameLabel, this.template.name);
    var text = ""
    if (this.template.description) {
        text = this.template.description;
        Dom.setInnerText(this.description, text);
        this.description.title = text;
        text = "";
    }
    text = "Updated " +  moment(this.template.lastModified).format(CMSCommon.getMomentFormat("MM/DD/YY HH:MM"))  + (this.template.lastUpdatedByName ? " by " + this.template.lastUpdatedByName : "");
    Dom.setInnerText(this.lastModifiedText, text);
    this.lastModifiedText.title = text;

    var hasVariants = (template.variants && template.variants.length > 1) ? true : false;
    Dom.toggleClass(this.node(), "HasVariants", hasVariants);
    Dom.toggleClass(this.node(), "DevMode", this.template.inDevMode ? true : false);

    if (hasVariants) {
        Dom.setInnerText(this.variantInfoLabel, (template.variants.length) + " color variants");
    } else {
        Dom.setInnerText(this.variantInfoLabel, "");
    }

    this.imageView.setUrl(this.template.calculatedPreviewPath);
    if (hasVariants) {
        if (this.variantSelectorEnabled) {
            Dom.hide(this.variantInfoLabel);
            this.variantsCombo.renderer = function (variant) {
                return Dom.newDOMElement({
                    _name: "span",
                    "class": "AdminTemplateItemView_VariantDisplay",
                    _children: [
                        {_name: "span", "class": "Color", style: "background-color: " + (variant.color || "transparent")},
                        {_name: "span", "class": "Name", _text: variant.displayName}
                    ]
                });
            };
            this.variantsCombo.comparer = function (a, b) {
                return a.name == b.name;
            }
            var variants = template.variants || [];
            this.variantsCombo.setItems(variants);
            Dom.show(this.variantsCombo.node());
        } else {
            Dom.show(this.variantInfoLabel);
            Dom.hide(this.variantsCombo.node());
        }
    } else {
        Dom.hide(this.variantsCombo.node());
        Dom.hide(this.variantInfoLabel);
    }
};
AdminTemplateItemView.prototype.getSelectedVariantName = function() {
    if (!this.variantSelectorEnabled) return "";
    var variant = this.variantsCombo.getSelectedItem();
    return variant ? variant.name : "";
}
AdminTemplateItemView.prototype.setVariantSelectorEnabled = function(variantSelectorEnabled) {
    this.variantSelectorEnabled = variantSelectorEnabled;
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/template-management/AdminWebsiteTemplateBuilderDialog.js";

function AdminWebsiteTemplateBuilderDialog() {
    this.grabHeight = true;
    this.grabWidth = true;
    Dialog.call(this);
    this.title = "Template Developer Tool";
    
    Dom.addClass(this.dialogFrame, "AdminWebsiteTemplateBuilderDialog");
    this.contentTabPane.withCloseButton = true;
    this.contentTabPane.canCloseTab = function (contentNode, callback) {
        if (!contentNode._file || !contentNode._file.modified) {
            callback(true);
            return;
        }
        
        Dialog.confirm("Are you sure you want to close unsaved file?", "WARNING: unsaved changes made to this file will be lost", "Yes, close anyway", function () {
            callback(true);
        });
    };
    
    this.bind("click", function () {
        this.editFile({
            path: Math.random() > 0.5 ? "/stylesheet/style.less" : "/home.xhtml"
        });
    }, this.testButton);
    
    this.bind("p:ItemDoubleClicked", function (event) {
        if (!event.item) return;
        this.editFile(event.item);
    }, this.fileTree.node());
    
    this.bind("e:TabChange", function () {
        this.invalidateStatuses();
    }, this.contentTabPane.node());
    
    CodeMirror.commands.save = function (instance) {
        if (!instance) return;
        var thiz = instance._thiz;
        if (!thiz) return;

        thiz.saveEditor(instance);
    };
}
__extend(Dialog, AdminWebsiteTemplateBuilderDialog);

AdminWebsiteTemplateBuilderDialog.EDITOR_MODE_MAP = {
    "less": "css",
    "css": "css",
    "html": "htmlmixed",
    "xhtml": "htmlmixed",
    "js": {name: "javascript", globalVars: true}
}

AdminWebsiteTemplateBuilderDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            run: function () {
                var thiz = this;
                var tabs = this.contentTabPane.getTabs();
                for (var i = 0; i < tabs.length; i ++) {
                    var tab = tabs[i];
                    if (tab.contentNode._file.modified) {
                        Dialog.confirm("Are you sure you want to close this tool and discard unsaved changes?", "WARNING: unsaved changes will be lost.", "Yes, close anyway", function () {
                            thiz.close();
                        });
                        return false;
                    }
                }
                
                return true;
            }
        }
    ]
};
AdminWebsiteTemplateBuilderDialog.prototype.getInnerOffset = function () {
    return {w: 20, h: 20};
};
AdminWebsiteTemplateBuilderDialog.prototype.onShown = function () {
    this.splitView.updateView();
    this.setupFileTree();
    
    var hbox = document.createElement("hbox");
    this.dialogClose.parentNode.insertBefore(hbox, this.dialogClose);
    hbox.style.alignItems = "center";
    
    this.toolbar = new ActionBar().into(hbox);
    
    var thiz = this;
    this.toolbar.register({
        getIcon: function () {return "content-save";},
        getTitle: function () {return "Save";},
        isApplicable: function () {
            var contentNode = thiz.contentTabPane.getActiveTabPane();
            if (!contentNode || !contentNode._file) return false;
            
            return contentNode._file.modified;
        },
        run: function () {
            var contentNode = thiz.contentTabPane.getActiveTabPane();
            if (!contentNode || !contentNode._file) return;
            
            thiz.saveEditor(contentNode._codeEditor);
        }
    });
};

AdminWebsiteTemplateBuilderDialog.prototype.setup = function (template) {
    this.template = template;
};

AdminWebsiteTemplateBuilderDialog.prototype.handleFileTreeContextClick = function (event) {
    var node = Dom.findUpwardForNodeWithData(event.target, "_item");
    if (!node) return;
    
    this.fileTree.setSelectedItem(node._item);
    
    Dom.cancelEvent(event);
    this.fileContextMenu.showMenuAt(event.clientX, event.clientY);
};
AdminWebsiteTemplateBuilderDialog.prototype.saveEditor = function (instance) {
    var file = instance._contentNode._file;
    var textarea = instance._contentNode._textarea;
    if (!file || !textarea) return;

    instance.save();
    
    var thiz = this;
    
    $templateAdminService.saveFileContent(this.template.id, file.path, textarea.value, function () {
        file.modified = false;
        thiz.invalidateStatuses();
    }, this);
};
AdminWebsiteTemplateBuilderDialog.prototype.editFile = function (file) {
    file.path.match(/\/([^\/\.]+\.([a-z0-9]+))$/i);
    file.name = RegExp.$1;
    file.type = RegExp.$2;
    
    var mode = AdminWebsiteTemplateBuilderDialog.EDITOR_MODE_MAP[file.type];
    if (!mode) {
        this.tryPreviewingFile(file);
        return;
    }
    
    var tabs = this.contentTabPane.getTabs();
    for (var i = 0; i < tabs.length; i ++) {
        var tab = tabs[i];
        if (tab.contentNode._file.path == file.path) {
            this.contentTabPane.setActiveTabPane(tab.contentNode);
            return;
        }
    }
    
    this._openFile(file);
};
AdminWebsiteTemplateBuilderDialog.prototype.tryPreviewingFile = function (file) {
    if (["png", "jpg", "jpeg", "gif", "bmp", "svg"].indexOf(file.type) < 0) return;
    var thiz = this;
    $templateAdminService.getTemplateFileUrl(this.template.id, file.path, function (url) {
        thiz.mediaPreviewer.items = [{src: url}];
        thiz.mediaPreviewer.startSlideShowAt(0);
    }, this);
};
AdminWebsiteTemplateBuilderDialog.prototype._openFile = function (file) {
    file.modified = false;
    
    var mode = AdminWebsiteTemplateBuilderDialog.EDITOR_MODE_MAP[file.type];
    if (!mode) return;
    
    var contentNode = Dom.newDOMElement({
        _name: "vbox",
        _children: [{
            _name: "textarea",
            flex: 1
        }]
    });
    
    contentNode._file = file;
    
    var thiz = this;
    this.contentTabPane.addTab(file.name, contentNode);
    this.contentTabPane.setActiveTabPane(contentNode);
    
    $templateAdminService.loadFileContent(this.template.id, file.path, function (content) {
        var textarea = contentNode.querySelector("textarea");
        textarea.value = content;
        var codeEditor = CodeMirror.fromTextArea(textarea, {
            lineNumbers: true,
            mode: mode,
            extraKeys: {"Ctrl-Space": "autocomplete"},
            indentUnit: 4,
            lineWrapping: true
        });
        
        contentNode._textarea = textarea;
        contentNode._codeEditor = codeEditor;
        codeEditor._contentNode = contentNode;
        codeEditor._thiz = thiz;
        
        codeEditor.on("change", function () {
            contentNode._file.modified = true;
            thiz.invalidateStatuses();
        });
    });
};
AdminWebsiteTemplateBuilderDialog.prototype.invalidateStatuses = function () {
    this.toolbar.invalidateActionStatus();
    
    var tabs = this.contentTabPane.getTabs();
    for (var i = 0; i < tabs.length; i ++) {
        var tab = tabs[i];
        if (tab.contentNode) {
            Dom.toggleClass(tab.header, "Modified", tab.contentNode._file.modified ? true : false);
        }
    }
};
AdminWebsiteTemplateBuilderDialog.prototype.getOpenedFiles = function () {
    var files = [];
    var tabs = this.contentTabPane.getTabs();
    tabs.forEach(function (tab) {
        if (tab.contentNode._file) {
            files.push(tab.contentNode._file);
        }
    });
    
    return files;
};
AdminWebsiteTemplateBuilderDialog.prototype.handleTemplateClick = function (event) {
};

AdminWebsiteTemplateBuilderDialog.getFileIcon = function (file) {
    if (!file || !file.name) return;
    if (file.directory) return file.path ? "folder-outline" : "palette";
    if (file.name.match(/.*\.(png|jpeg|jpg|gif|bmp|svg)$/)) return "image";
    if (file.name.match(/.*\.(html|htm|xhtml)$/)) return "file";
    
    return "file-document-box";
};
AdminWebsiteTemplateBuilderDialog.prototype.setupFileTree = function () {
    var thiz = this;
    var source = function (file, callback) {
        if (file && !file.directory) {
            callback([]);
            return;
        }
        
        if (!file) {
            callback([{
                name: thiz.template.name,
                path: "",
                directory: true
            }]);
            
            return;
        }
        
        $templateAdminService.listFiles(thiz.template.id, file.path, callback);
    };
    
    var renderer = function (file) {
        return "<span class=\"FileItem " + (file.directory ? "Directory" : "File") + " Path" + (file.path.replace(/[^a-z0-9]+/gi, "_")) + "\">"
                    + "<icon class=\"" + AdminWebsiteTemplateBuilderDialog.getFileIcon(file) + "\"></icon>"
                    + "<span>" + Dom.htmlEncode(file.name) + "</span>"
                + "</span>";
    };
    
    var options = {
        expandedAll: true,
        same: function (a, b) {return a.path == b.path;},
        isItemSelectable: function (item) {
            return true;
        },
        onInitialized: function () {
        }
    };
    
    console.log(this.fileTree);
    
    this.fileTree.setup(source, renderer, options);
    
    
    this.bind("contextmenu", this.handleFileTreeContextClick, this.fileTree.node());
    
    var thiz = this;
    this.fileContextMenu = new Menu();
    this.fileContextMenu.register({
        icon: "upload",
        label: "Upload...",
        isAvailable: function () {
            var item = thiz.fileTree.getSelectedItem();
            return item.directory;
        },
        run: function () {
            var item = thiz.fileTree.getSelectedItem();
            if (!item.directory) return;
            thiz.uploadTargetFile = item;
            thiz.fileInput.click();
        }
    });
    this.fileContextMenu.register({
        icon: "plus",
        label: "New Text File...",
        isAvailable: function () {
            var item = thiz.fileTree.getSelectedItem();
            return item.directory;
        },
        run: function () {
            var item = thiz.fileTree.getSelectedItem();
            if (!item.directory) return;
            
            Dialog.prompt("Enter new file name:", "", "Create", function (name) {
                if (!name) return;
                $templateAdminService.createNewFile(thiz.template.id, item.path, name, function () {
                    thiz.fileTree.refresh();
                });
            }); 
        }
    });
    this.fileContextMenu.register({
        icon: "folder-plus",
        label: "New Folder...",
        isAvailable: function () {
            var item = thiz.fileTree.getSelectedItem();
            return item.directory;
        },
        run: function () {
            var item = thiz.fileTree.getSelectedItem();
            if (!item.directory) return;
            
            Dialog.prompt("Enter new folder name:", "NewFolder", "Create", function (name) {
                if (!name) return;
                $templateAdminService.createNewFolder(thiz.template.id, item.path, name, function () {
                    thiz.fileTree.refresh();
                });
            }); 
        }
    });
    this.fileContextMenu.separator();
    this.fileContextMenu.register({
        icon: "rename-box",
        label: "Rename...",
        isAvailable: function () {
            var item = thiz.fileTree.getSelectedItem();
            return item.path;
        },
        run: function () {
            var item = thiz.fileTree.getSelectedItem();
            
            Dialog.prompt("Enter new name:", item.name, "Rename", function (name) {
                if (!name) return;
                $templateAdminService.renameFile(thiz.template.id, item.path, name, function () {
                    thiz.fileTree.refresh();
                });
            }); 
        }
    });
    this.fileContextMenu.register({
        icon: "delete",
        label: "Delete",
        isAvailable: function () {
            var item = thiz.fileTree.getSelectedItem();
            return item.path;
        },
        isEnabled: function () {
            var item = thiz.fileTree.getSelectedItem();
            return item.path != "/home.xhtml"
                    && item.path != "/inner.xhtml"
                    && item.path != "/stylesheet"
                    && item.path != "/stylesheet/style.less";
        },
        run: function () {
            var item = thiz.fileTree.getSelectedItem();
            
            Dialog.confirm("Are you sure you want to delete this " + (item.directory ? "folder" : "file") + "?", "WARNING: this action cannot be undone.", "Yes, delete it", function () {
                $templateAdminService.deleteFile(thiz.template.id, item.path, function () {
                    thiz.fileTree.refresh();
                });
            }); 
        }
    });
    
    this.fileContextMenu.setPopupClass("TemplateFilePopupMenu");
    
    this.bind("change", function () {
        if (!this.uploadTargetFile) return;
        
        var files = this.fileInput.files;
        if (!files) return;
        
        var index = -1;
        function next() {
            index ++;
            if (index >= files.length) {
                thiz.fileTree.refresh();
                this.uploadTargetFile = null;
                return;
            }
            
            var file = files[index];
            $templateAdminService.uploadFile(thiz.template.id, thiz.uploadTargetFile.path, file, function () {
                next();
            }, thiz.asCustomIndicator("Uploading " + file.name + "..."));
        }
        
        next();
    }, this.fileInput);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/template-management/AdminWebsiteTemplateManagement.js";

function AdminWebsiteTemplateManagement() {
    BaseTemplatedWidget.call(this);

    this.filterTerm = "";
    var thiz = this;
    this.bind("click", this.installNewTemplate, this.installButton);

    this.bind("click", this.reloadTemplates, this.filterButton);
    this.bind("click", this.handleTemplateClick, this.container);

    this.bind("click", this.handleFilterInputClick, this.filterInput);

    this.setupContextMenu();

    this.reloadTemplates();
}
__extend(BaseTemplatedWidget, AdminWebsiteTemplateManagement);

AdminWebsiteTemplateManagement.prototype.onAttached = function () {
    console.log("onAttached called");
    console.trace();
};
AdminWebsiteTemplateManagement.prototype.installNewTemplate = function () {
    var thiz = this;
    new TemplateDetailDialog().callback(function (updated) {
        if (updated) thiz.reloadTemplates();
    }).open();
};
AdminWebsiteTemplateManagement.prototype.reloadTemplates = function (event) {
    //this.container.innerHTML = "";
    if (event) this.filterTerm = this.filterInput.value;

    $templateAdminService.findPopulatedTemplateSuites(this.filterTerm, 0, 1000, Order.asc("name"), function (templates) {
        this.container.innerHTML = "";
        templates.result.forEach(function (template) {
            var itemView = new AdminTemplateItemView().into(this.container);
            Dom.addClass(itemView.node(), "ManageTemplate");
            var text = "Last updated " +  moment(template.lastModified).format(CMSCommon.getMomentFormat("MMM DD YYYY h:mm a"))  + (template.lastUpdatedByName ? " by " + template.lastUpdatedByName : "");
            itemView.setTemplate(template);
            itemView.node().title = text;
        }.bind(this));
        for (var i = 0; i < 10; i ++) {
            this.container.appendChild(Dom.newDOMElement({
                _name: "div",
                "class": "Fake"
            }));
        }
    }.bind(this), function (e) {}, AdminConsole.instance);
};
AdminWebsiteTemplateManagement.prototype.activateDevTool = function (event) {
    var thiz = this;
    $templateAdminService.setTemplateDevModeStatus(true, function () {
        thiz.filterInput.value = "";
        thiz.reloadTemplates();
        thiz.devToolEnabled = true;
        SnackBar.show("Template Developer Tool is now enabled. Enjoy template development!", null, null, "auto-fix");
    }, AdminConsole.instance);
};
AdminWebsiteTemplateManagement.prototype.handleFilterInputClick = function (event) {
    if (this.filterInput.value != "dev") return;

    var now = new Date().getTime();

    if (!this.lastDevAttemptClickAt || (now - this.lastDevAttemptClickAt > 1000) || !this.devAttemptClickCount) {
        this.devAttemptClickCount = 0;
    }

    this.devAttemptClickCount ++;
    this.lastDevAttemptClickAt = now;

    if (this.devAttemptClickCount >= 5) {
        this.activateDevTool();
        this.devAttemptClickCount = 0;
    }
}
AdminWebsiteTemplateManagement.prototype.handleTemplateClick = function (event) {
    var templateItemView = BaseWidget.findUpward(event.target, AdminTemplateItemView);
    if (!templateItemView) return;

    var thiz = this;
    new TemplateDetailDialog().callback(function (updated) {
        if (updated) thiz.reloadTemplates();

    }).open(templateItemView.template);
};
AdminWebsiteTemplateManagement.prototype.setupContextMenu = function () {
    var thiz = this;
    this.templateContextMenu = new Menu();

    this.templateContextMenu.register({
        icon: "upload",
        label: "Install new Template...",
        isAvailable: function () {
            return !thiz.focusedTemplateSuite;
        },
        run: function () {
            thiz.installNewTemplate();
        }
    });
    this.templateContextMenu.register({
        icon: "pencil",
        label: "Edit Template...",
        isAvailable: function () {
            return thiz.focusedTemplateSuite;
        },
        run: function () {
            new TemplateDetailDialog().callback(function (updated) {
                if (updated) thiz.reloadTemplates();
            }).open(thiz.focusedTemplateSuite);
        }
    });
    this.templateContextMenu.register({
        icon: "download",
        label: "Download as Zip",
        isAvailable: function () {
            return thiz.focusedTemplateSuite;
        },
        run: function () {
            $templateAdminService.compressTemplateForDownload(thiz.focusedTemplateSuite.id, function (url) {
                thiz.downloadFrame.src = url;
            }, AdminConsole.instance);
        }
    });
    this.templateContextMenu.separator();
    this.templateContextMenu.register({
        icon: "content-copy",
        label: "Clone as Developer Template",
        isAvailable: function () {
            return thiz.focusedTemplateSuite && thiz.devToolEnabled;
        },
        run: function () {
            Dialog.confirm("Are you sure you want to clone this as a new developer template?", "", "Yes, clone now", function () {
                $templateAdminService.cloneAsDevTemplate(thiz.focusedTemplateSuite.id, function () {
                    thiz.reloadTemplates();
                    SnackBar.show("Template was cloned successfully!");
                });
            });
        }
    });

    this.templateContextMenu.setPopupClass("TemplateItemPopupMenu");

    this.bind("contextmenu", this.handleTemplateItemContextClick, this.container);
};

AdminWebsiteTemplateManagement.prototype.handleTemplateItemContextClick = function (event) {
    var itemView = BaseWidget.findUpward(event.target, AdminTemplateItemView);
    this.focusedTemplateSuite = itemView ? itemView.template : null;

    Dom.cancelEvent(event);
    this.templateContextMenu.showMenuAt(event.clientX, event.clientY);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/template-management/TemplateDetailDialog.js";

function TemplateDetailDialog() {
    Dialog.call(this);

    this.bind("change", function () {
        Dom.toggleClass(this.templateFile, "HasFile", this.templateFile.files && this.templateFile.files.length > 0);
    }, this.templateFile);
    this.validationRules = new RuleSet()
    .live(true)
    .required(this.templateName, "Please input name");
    this.bind("click", function(e){
        new TemplateUsedDetailDialog().open(this.template);
    }, this.teamUsedText);
    var thiz = this;
    this.bind("click", function(){
        Dialog.confirm("Do you want to delete this template?", null, "Delete", function(){
            $templateAdminService.deleteTemplate(thiz.template.id, function () {
                thiz.close(true);
            },function(e){
                Dialog.error("Delete this template was denied!");
            }, thiz);
        },
        "Cancel", function() {});
    }, this.deleteButton);
}
__extend(Dialog, TemplateDetailDialog);

TemplateDetailDialog.prototype.setupTemplateSetting = function() {
    this.organSelectBox.getConfigs = function() {
        return {
            mode: SelectBox.MODE_DROPDOWN,
            multipleSelect: true,
            useExplicitSelectLinks: false,
            noneSelectionText: ComboManager.EMPTY_ITEM_TEXT
        };
    };
    this.organSelectBox.parseData = function(data) {
        return {
            value: data.id,
            text: data.name
        };
    };

    this.organSelectBox.setup();
    this.organSelectBox.setItems(this.templateSetting.organOptions);
}

TemplateDetailDialog.prototype.asyncSetup = function (template, callback) {
    var postSetupAction = function() {
        this.setupTemplateSetting();
        this.template = template;
        this.title = template ? "Update Template" : "Install New Template";
        if (template) {
            this.templateName.value = template.name;
            this.templateDescription.value = template.description;
            this.templateTags.value = template.tags;
            this.ymcaOnlyCheckbox.checked = template.forYMCA;
            text = "Updated " +  moment(this.template.lastModified).format(CMSCommon.getMomentFormat("MM/DD/YY HH:MM"))  + (this.template.lastUpdatedByName ? " by " + this.template.lastUpdatedByName : "");
            this.lastModifiedText.innerHTML = text;
            this.teamAliasesAllowedInput.value = template.teamAliasesAllowed || "";
            if (template.organIdsAllowed) this.organSelectBox.setValuesSelected(template.organIdsAllowed, true);
            $templateAdminService.getTemplateSuiteUsedInfo(this.template.id, function(newInfo){
                if (this.teamUsedText) {
                    this.teamUsedText.innerHTML = newInfo + (newInfo > 1 ? " teams" : " team");
                    Dom.addClass(this.teamUsedBox, "Done");
                }
                Dom.toggleClass(this.deleteButton, "Unused", newInfo == 0);
                if (callback) callback();
            }.bind(this), function(e){}, AdminConsole.instance);

        } else {
            if (callback) callback();
        }
    }.bind(this);

    $templateAdminService.getTemplateSetting(function(rs) {
        this.templateSetting = rs;
        postSetupAction();
    }.bind(this), function(err) {

    }, "Loading...");

}
TemplateDetailDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "accept", title: this.template ? "Update" : "Install",
            run: function () { this.install(); return false; }
        },
        {
            type: "extra1", title: "Develop...",
            run: function () { this.develop(); return true; },
            isApplicable: function () {
                return thiz.template
                            && thiz.template.inDevMode;
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};
TemplateDetailDialog.prototype.develop = function () {
    new AdminWebsiteTemplateBuilderDialog().open(this.template);
};
TemplateDetailDialog.prototype.install = function () {
    if (!ValidationManager.run(this.validationRules)) return;
    var file = null;
    if (this.templateFile.files && this.templateFile.files.length > 0) {
        file = this.templateFile.files[0];
    }

    if (!file && !this.template) {
        Dialog.error("Please select the template .zip bundle.");
        return;
    }

    var selectedOrgans = this.organSelectBox.getSelectedData();
    var selectedOrganIds = (selectedOrgans || []).map(function(item) { 
        return item.id;
    });
    var templateSuite = {
        name: this.templateName.value,
        description: this.templateDescription.value,
        tags: this.templateTags.value,
        forYMCA: this.ymcaOnlyCheckbox.checked,
        teamAliasesAllowed: this.teamAliasesAllowedInput.value.trim(),
        organIdsAllowed: selectedOrganIds
    };

    //TODO: add validation
    var thiz = this;

    if (this.template) {
        templateSuite.id = this.template.id;
        $templateAdminService.updateTemplateSuite(file, templateSuite, function () {
            SnackBar.show("Template suite '" + templateSuite.name + "' was successfully updated.");
            thiz.close("updated");
        }, function (error) {
            Dialog.error("Error updating template", error.message ? error.message : error);
        }, this);
    } else {
        $templateAdminService.installNewTemplateSuite(file, templateSuite, function () {
            SnackBar.show("New template '" + templateSuite.name + "' has been installed successfully.");
            thiz.close("updated");
        }, function (error) {
            Dialog.error("Error installing template", error.message ? error.message : error);
        }, this);
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/template-management/TemplateUsedDetailDialog.js";

function TemplateUsedDetailDialog() {
    Dialog.call(this);
    this.title = "Template Usage Information";
    this.listView.chunkSize = 15;
    this.listView.populator = function (data, binding, node) {
        var teamInfo = data;
        Dom.setInnerText(binding.teamName, teamInfo.name || "");
        binding._node._data = teamInfo;
        Dom.toggleClass(node, "Published", teamInfo.cmsUpgradeLive);
    };
    this.bind("click", function(ev){
        if (!Dom.hasClass(ev.target, "CopyButton")) return;

        var itemContainer = Dom.findUpwardForNodeWithData(ev.target, "_data");
        if (!itemContainer) return;
        var team = itemContainer._data;
        MainNavigatorSetting.copyClipboard(team.url);
    }.bind(this), this.listView);

    this.bind("click", this.performFilter, this.searchButton);
    this.bind("keypress", function(event) {
        if (event && event.keyCode == 13) {
            this.performFilter();
            Dom.cancelEvent(event);
        }
    }.bind(this), this.searchTerm);

}
__extend(Dialog, TemplateUsedDetailDialog);

TemplateUsedDetailDialog.prototype.performFilter = function() {
    var source = this.createSource();
    if (!source) return;
    this.listView.setSource(source);
}

TemplateUsedDetailDialog.prototype.setup = function(template) {
    this.template = template;
}
TemplateUsedDetailDialog.prototype.onShown = function() {
    this.performFilter();
}
TemplateUsedDetailDialog.prototype.createSource = function () {
    var thiz = this;
    var term = this.searchTerm.value.trim();
    if (thiz._term == term) return undefined;
    thiz._term = term;
    return {
        term: thiz._term,
        loadPage: function (start, count, handler, failed) {
            $templateAdminService.getTeamUsedTemplateSuiteInfo(thiz.template.id, this.term, start, count,
            function(results){
                handler(results.result, results.count);
            }.bind(thiz), function(e) {
                failed(e);
            });
        }
    };
};
TemplateUsedDetailDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/AdminWebsiteDesign.js";

function AdminWebsiteDesign() {
    BaseTemplatedWidget.call(this);

    var thiz = this;

    this.loadFn = function () {
        Dom.removeClass(thiz.node(), "Busy");
        thiz.iframe.contentWindow.addEventListener("unload", function (event) {
            Dom.addClass(thiz.node(), "Busy");
        }, false);

        if (thiz.hasNavigationModule()) {

            var location = thiz.iframe.contentWindow.location + "";
            if (location.length == 0) return;
            if (thiz._skippedNotify) {
                delete thiz._skippedNotify;
                return;
            }
            thiz.onNavigateToChildModule(location);
        }
    };
    this.bind("load", this.loadFn, this.iframe);
    this.bind("click", this.onIgnoreAll, this.ignoreAllButton);
    window.currentWebDesignFeature = this;
    this.bind(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, this.reload);

    this.layoutSizes = {
        desktop: 1280,
        tablet: 800,
        phone: 360
    };
    var mode = localStorage.getItem(AdminWebsiteDesign.STORAGE_KEY_LAST_SCREEN_MODE);
    if (mode == null || mode.length == 0) {
        mode = "desktop";
    }
    Dom.doOnSelector(this.deviceModeContainer, "button", function (b) {
        Dom.toggleClass(b, "Active", b.getAttribute && b.getAttribute("layout-mode") == mode);
    });
    this.setDeviceMode(mode, false);

    this.bind("click", this.handleDeviceModeClick, this.deviceModeContainer);

    this.bind("click", function () {
        this.reload();
    }, this.reloadButton);

    this.bind("click", function () {
        new GeneralSettingDialog().open();
    }, this.generalSettingButton);
    this.navigationModule = !this.hasNavigationModule() ? CommonNavigation.newUnnavigatableModule() : {
        navigate: function (name, callback) {
            var url = thiz.locationInfo[name];
            if (url && url.length > 0) {
                console.log("Navigate to: ", name, url);
                thiz._skippedNotify = true;
                thiz.iframe.contentWindow.location.href = url;
                callback(thiz.navigationModule);
            } else {
                console.log("Un navigate to : " + name, thiz.locationInfo);
                callback(null);
            }
        },
        close: function () {
        }
    };
    this.locationInfo = {};
    //this.iframe.src = this.getHome();

    if (!this.canUpdateGeneralSetting()) {
        this.generalSettingButton.parentNode.removeChild(this.generalSettingButton);
    }

}
__extend(BaseTemplatedWidget, AdminWebsiteDesign);
AdminWebsiteDesign.DESIGN_CHANGED_EVENT = "p:DesignChanged";
AdminWebsiteDesign.STORAGE_KEY_LAST_SCREEN_MODE = "lastScreenMode";

AdminWebsiteDesign.prototype.canUpdateGeneralSetting = function() {
    return CMSAuthUtils.canUpdateGeneralSetting();
}

AdminWebsiteDesign.prototype.hashCode = function(s) {
    var h = 0, l = s.length, i = 0;
    if ( l > 0 )
    while (i < l)
    h = (h << 5) - h + s.charCodeAt(i++) | 0;
    return Math.abs(h);
}
AdminWebsiteDesign.prototype.onAttached = function () {
    if (this._attached) return;
    this._attached = true;
    var thiz = this;
    var spinner = new Spinner("Loading...");

    $cmsMigration.getCMSMigrationStatus(function (status) {
        Dom.addClass(thiz.node(), "" + status);
        if (status == "Allowed") {
            AdminConsole.instance.initSystemToolbar(thiz);
            new CMSMigrationDialog().callback(function (successful) {
                Dom.removeClass(thiz.node(), "" + status);
                if (successful) {
                    AdminConsole.instance.startWorkspace(AdminConsole.instance.userSession);
                } else {
                    localStorage.setItem(NavigationDrawer.STORAGE_KEY_LAST_FEATURE_ID, "");
                    AdminConsole.instance.navigationDrawer.jumpToDefaultFeature();
                }
            }).open();
        } else if (status == "Sandboxed" || status == "Live") {
            thiz.loadWebsiteDesign(status);
        } else {
            localStorage.setItem(NavigationDrawer.STORAGE_KEY_LAST_FEATURE_ID, "");
            AdminConsole.instance.navigationDrawer.jumpToDefaultFeature();
        }
    }, function(e){}, spinner);
};
AdminWebsiteDesign.prototype.loadWebsiteDesign = function(clazz) {
    Dom.addClass(this.node(), "Busy");
    Dom.addClass(this.node(), clazz);
    this._setupWarningIndicator();
    this.iframe.src = this.getHome();
    AdminConsole.instance.initSystemToolbar(this);
    this._inspectMyTeamSite();
    Util.doPeriodically(this._updateWarningIndicator.bind(this), 20000, this.node());
}
AdminWebsiteDesign.prototype.getHome = function() {
    return (ADMIN_CONTEXT.isUsingCustomDomain ? "" : ("/team/" + ADMIN_CONTEXT.teamAlias)) + "/page/home@@@design";
}
AdminWebsiteDesign.prototype.onNavigateToChildModule = function(location) {
    var hash = this.hashCode(location);
    this.locationInfo[hash] = location;
    console.log("onNavigateToChildModule: ", hash, location);
    CommonNavigation.onNavigateToChildModule(this.navigationModule, hash, CommonNavigation.newUnnavigatableModule(), "true");
}
AdminWebsiteDesign.prototype.onDetached = function() {

    if (this.hasNavigationModule()) {
        CommonNavigation.onNavigationModuleClosed(this.navigationModule);
        console.log("Close ", this.navigationModule);
    }
    if (this.warningDetailPopup) {
        this.warningDetailPopup.kill();
    }

    delete this._attached;
}
AdminWebsiteDesign.prototype.hasNavigationModule = function() {
    return false;//rowser.isSafari;
}
AdminWebsiteDesign.prototype.getNavigationModule = function () {
    return this.navigationModule;
};

AdminWebsiteDesign.prototype.onIgnoreAll = function() {
    if (!Dom.hasClass(this.ignoreAllButton, "HasIgnore")) return;
    var thiz = this;
    Dialog.confirm("Are you sure you want to ignore all page warnings?", "",
        "Ignore All", function(){

            $cmsDiagService.ignoreAllProblems(function () {

                thiz._reloadProblemList();
                thiz.reload();

            }, function(e) {}, AdminConsole.instance);

        }, "Cancel");
}

AdminWebsiteDesign.prototype.onComponentSettingClicked = function (componentInfo) {
    ComponentDetailDialog.open(componentInfo);
};
AdminWebsiteDesign.prototype.onSectionSettingClicked = function (sectionInfo) {
    new SectionSettingDialog(this)
        .callback(function () {

        })
        .open(sectionInfo);
};
AdminWebsiteDesign.prototype.onComponentSelfSettingClicked = function (componentInfo) {
    var thiz = this;
    var callback = function (changed) {
        if (changed) thiz.reload();
    };
    if (componentInfo.namespace) {
        widget.__ensureNamespaceLoaded(componentInfo.namespace, function (targetNamespace) {
            var f = targetNamespace[componentInfo.functionName];
            if (!f) return;
            f(componentInfo, callback);
        });
    } else {
        var f = window[componentInfo.functionName];
        if (!f) return;
        f(componentInfo, callback);
    }
};
AdminWebsiteDesign.prototype.onComponentCloseClicked = function(componentInfo) {
    var TeamLocalizer = window.top.TeamLocalizer;
    var customization = TeamLocalizer.getString("customization");
    Dialog.confirm("Are you sure you want to remove this '" + componentInfo.componentName + "' component?", "When removing a component you will lose all specific " + customization + " done to it but its content data will be kept.",
        "Remove", function(){

            $cmsService.removeComponentFromPageSection(componentInfo.sectionId, componentInfo.componentId, function () {
                Dom.emitEvent(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, window.currentWebDesignFeature.node());
            }, function(e){
                if (e && "REMOVE_PRIMARY_COMPONENT_DOES_NOT_ALLOWED" == e.code) {
                    Dialog.error(e.message);
                }
            }, AdminConsole.instance);

        }, "Cancel");
}
AdminWebsiteDesign.prototype.onContentSize = function (width, height) {
    // this.iframe.style.width = width + "px";
    // this.iframe.style.height = height + "px";
};
AdminWebsiteDesign.prototype.reload = function () {
    Dom.addClass(this.node(), "Busy");
    this.iframe.contentWindow.location.reload();
    this._inspectMyTeamSite();
};
AdminWebsiteDesign.prototype.handleDeviceModeClick = function (event) {
    var button = Dom.findParentWithAttribute(event.target, "layout-mode");
    if (!button) return;
    var mode = button.getAttribute("layout-mode");
    if (!mode) return;
    localStorage.setItem(AdminWebsiteDesign.STORAGE_KEY_LAST_SCREEN_MODE, mode);
    this.setDeviceMode(mode, true);
};

AdminWebsiteDesign.prototype.setDeviceMode = function (name, reload) {
    Dom.doOnSelector(this.deviceModeContainer, "button", function (b) {
        Dom.toggleClass(b, "Active", b.getAttribute && b.getAttribute("layout-mode") == name);
    });
    var size = this.layoutSizes[name];

    this.node().setAttribute("device-mode", name);
    if (reload) this.reload();
    //this.iframe.style.width = size + "px";
};
AdminWebsiteDesign.prototype._updateWarningIndicator = function (__callback) {
    var thiz = this;
    $cmsDiagService.getTeamSiteWarningCount(function (count) {
        Dom.toggleClass(thiz.warningIndicatorButton, "HasWarning", count > 0);
        Dom.setInnerText(thiz.warningLabel, count > 0 ? (count + " warning" + (count != 1 ? "s" : "")) : "No warnings");
        if (__callback) {
            __callback();
        }
    }, function(e) {});
};
AdminWebsiteDesign.prototype._inspectMyTeamSite = function() {
    var thiz = this;
    $cmsDiagService.inspectMyTeamSite(function () {
        thiz._updateWarningIndicator();
    }, function(e) {});
}
AdminWebsiteDesign.prototype._resolveProblem = function (problem, event) {
    var thiz = this;
    $cmsDiagService.resolveProblem(problem.id, function () {
        thiz._reloadProblemList();
        thiz.reload();
    }, AdminConsole.instance);
};
AdminWebsiteDesign.prototype._ignoreProblem = function (problem, event) {
    var thiz = this;
    $cmsDiagService.ignoreProblem(problem.id, function () {
        thiz._reloadProblemList();
    }, AdminConsole.instance);
};
AdminWebsiteDesign.prototype._reloadProblemList = function () {
    var thiz = this;
    $cmsDiagService.getTeamSiteProblems(function (problems) {
        thiz._updateWarningIndicator();
        var items = [].concat(problems.result);
        thiz.warningListRepeater.setItems(items);
        thiz.updateIgnoreAllButton(items);
        thiz.warningDetailPopup.invalidatePosition();
    }, function(e) {}, AdminConsole.instance);
};
AdminWebsiteDesign.prototype.updateIgnoreAllButton = function(items) {
    var ignorAbleCount = 0;
    for (var i = 0; i < items.length; i++) {
        var data = items[i];
        var ignorAble = data.severity != "Severe" && !data.ignored && !data.resolved;
        if (ignorAble) {
            ignorAbleCount ++;
        }
    }
    Dom.toggleClass(this.ignoreAllButton, "HasIgnore", ignorAbleCount > 1);
}
AdminWebsiteDesign.prototype._setupWarningIndicator = function () {
    var thiz = this;

    this.bind("p:PopupShown", function() {
        Dom.addClass(this.node(), "WithWarningPopup");
    }, thiz.warningDetailPopup);
    this.bind("p:PopupHidden", function() {
        Dom.removeClass(this.node(), "WithWarningPopup");
    }, thiz.warningDetailPopup);

    this.bind("click", function () {
        $cmsDiagService.getTeamSiteProblems(function (problems) {
            var items = [].concat(problems.result);
            thiz.warningListRepeater.setItems(items);
            thiz.updateIgnoreAllButton(items);

            thiz.warningDetailPopup.show(thiz.warningIndicatorButton, "center", "bottom", 0, 5, false);

        }, AdminConsole.instance);
    }, this.warningIndicatorButton);

    thiz.warningListRepeater.populator = function (data, binding, node) {
        var title = (data.resolved && data.resolvingMessage) ? data.resolvingMessage : data.message;
        if (data.dataMap && data.dataMap.html) {
            Util.setInnerHTMLWithScript(binding.titleLabel, title);
        } else {
            Dom.setInnerText(binding.titleLabel, title);
        }
        Dom.toggleClass(binding._node, "Resolvable", data.resolvable);
        Dom.toggleClass(binding._node, "Ignorable", data.severity != "Severe");
        Dom.toggleClass(binding._node, "Ignored", data.ignored);
        Dom.toggleClass(binding._node, "Resolved", data.resolved);


        Dom.addClass(binding._node, data.severity);

        binding._node._problem = data;
    };

    this.bind("click", function () {
        thiz.closeWarningPopup();
    }, this.warningCloseButton);

    Dom.registerListActionHandlers(this.warningListRepeater, "_problem", {
        AnonId_resolveButton: function (problem, event) {
            thiz._resolveProblem(problem, event);
        },
        AnonId_ignoreButton: function (problem, event) {
            thiz._ignoreProblem(problem, event);
        }
    });
    this.bind("click", function (e) {
        if (!e) return;
        var target = Dom.getTarget(e);
        if (!target) return;
        if (Dom.hasClass(target, "HelpLink")) {
            thiz.closeWarningPopup();
        }
    }, this.warningListRepeater);
};
AdminWebsiteDesign.prototype.closeWarningPopup = function() {
    this.warningDetailPopup.close();
}
AdminWebsiteDesign.prototype.getSystemToolbar = function () {
    return Dom.hasClass(this.node(), "Live") || Dom.hasClass(this.node(), "Sandboxed") ? this.webDesignToolbar : null;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/BackgroundStyleEditor.js";

function BackgroundStyleEditor(node) {
    BaseTemplatedWidget.call(this);

    this.backgroundRepeatModeSelector.renderer = this.backgroundAttachmentModeSelector.renderer = this.backgroundSizeModeSelector.renderer = function (value) {
        return value.name;
    };
    this.backgroundRepeatModeSelector.comparer = this.backgroundAttachmentModeSelector.comparer = this.backgroundSizeModeSelector.comparer = Util.sameId;

    this.backgroundRepeatModeSelector.setItems(BackgroundStyleEditor.BACKGROUND_REPEAT_MODES);
    this.backgroundAttachmentModeSelector.setItems(BackgroundStyleEditor.BACKGROUND_ATTACHMENT_MODES);
    this.backgroundSizeModeSelector.setItems(BackgroundStyleEditor.BACKGROUND_SIZE_MODES);

    this.backgroundFileUploadView.dataType = node ? Dom.getAttributeAsString(node, "storage-type", "settings") : "settings";
    this.backgroundFileUploadView.dataUUID = node ? Dom.getAttributeAsString(node, "storage-uuid", "background") : "background";

    this.defaultBackgroundColor = node ? Dom.getAttributeAsString(node, "default-color", "#FFFFFF00") : "#FFFFFF00";
    this.backgroundColorPicker.setDefaultColor(this.defaultBackgroundColor);
    
    var emptyColorText = Dom.getAttributeAsString(node, "empty-color-text", "");
    if (emptyColorText) this.backgroundColorPicker.setInfoWhenDefaultColorSelected(emptyColorText);
    
    this.namePrefix = Dom.getAttributeAsString(node, "name-prefix", "");
}
__extend(BaseTemplatedWidget, BackgroundStyleEditor);

BackgroundStyleEditor.BACKGROUND_REPEAT_MODES = [
    {id: "no-repeat", name: "No repeat"},
    {id: "repeat-x", name: "Repeat horizontally"},
    {id: "repeat-y", name: "Repeat vertically"},
    {id: "repeat", name: "Repeat"}
];
BackgroundStyleEditor.BACKGROUND_ATTACHMENT_MODES = [
    {id: "scroll", name: "Scroll"},
    {id: "fixed", name: "Fixed"}
];
BackgroundStyleEditor.BACKGROUND_SIZE_MODES = [
    {id: "auto", name: "Auto"},
    {id: "contain", name: "Contain"},
    {id: "cover", name: "Cover"}
];
BackgroundStyleEditor.prototype.reset = function (value) {
    this.backgroundRepeatModeSelector.selectItemByKey("repeat");
    this.backgroundAttachmentModeSelector.selectItemByKey("scroll");
    this.backgroundSizeModeSelector.selectItemByKey("auto");
    this.backgroundFileUploadView.setCommaSeparatedStoragePaths("");
    this.backgroundColorPicker.setRGBAHexColorString(this.defaultBackgroundColor);
};
BackgroundStyleEditor.prototype.initFromValue = function (value) {
    if (!value) {
        this.reset();
    } else {
        this.backgroundRepeatModeSelector.selectItemByKey("id", value[this.namePrefix + "backgroundRepeat"] || "repeat");
        this.backgroundAttachmentModeSelector.selectItemByKey("id", value[this.namePrefix + "backgroundAttachment"] || "scroll");
        this.backgroundSizeModeSelector.selectItemByKey("id", value[this.namePrefix + "backgroundSize"] || "auto");
        this.backgroundFileUploadView.setCommaSeparatedStoragePaths(value[this.namePrefix + "backgroundImage"] || "");
        this.backgroundColorPicker.setRGBAHexColorString(value[this.namePrefix + "backgroundColor"] || this.defaultBackgroundColor);
    }
};

BackgroundStyleEditor.prototype.saveToValue = function (value) {
    value[this.namePrefix + "backgroundRepeat"] = this.backgroundRepeatModeSelector.getSelectedItem().id;
    value[this.namePrefix + "backgroundAttachment"] = this.backgroundAttachmentModeSelector.getSelectedItem().id;
    value[this.namePrefix + "backgroundSize"] = this.backgroundSizeModeSelector.getSelectedItem().id;
    value[this.namePrefix + "backgroundImage"] = this.backgroundFileUploadView.getCommaSeparatedStoragePaths();
    value[this.namePrefix + "backgroundColor"] = this.backgroundColorPicker.getRGBAHexColorString();
};

BackgroundStyleEditor.prototype.setValue = function (value) {
    this.initFromValue(value);
};
BackgroundStyleEditor.prototype.getValue = function () {
    var value = {};
    this.saveToValue(value);
    return value;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/ComponentDetailDialog.js";

function ComponentDetailDialog() {
    ModificationWatchDialog.call(this);
    this.hasDesignChangeEvent = false;
}
__extend(ModificationWatchDialog, ComponentDetailDialog);


ComponentDetailDialog._getSettingImpl = function (componentInfo) {
    var implName = componentInfo && componentInfo.componentType;
    if (implName) implName += "Setting";
    var f = window[implName];
    if (f) {
        return new f();
    }
    return null;
};
ComponentDetailDialog.open = function(componentInfo) {
    var impl =  ComponentDetailDialog._getSettingImpl(componentInfo);
    if (!impl) {
        impl = new GenericComponentDetailDialog();
    }
    impl.componentInfo = componentInfo;
    if (componentInfo.componentId > 0) {
        $cmsService.getSettingSchemas(componentInfo.componentId, componentInfo.componentType, function(schemas) {
                impl._receiveSettingSchemas(schemas);
        }, AdminConsole.instance.asCustomIndicator("Loading component settings..."));
    } else {
        if (impl.loadSettingSchemas) {
            impl.loadSettingSchemas(function(schemas){
                impl._receiveSettingSchemas(schemas);
            });
        } else {
            impl._receiveSettingSchemas([]);
        }
    }
};

ComponentDetailDialog.prototype._receiveSettingSchemas = function(schemas) {
    if (!schemas)  {
        this._ready();
        return;
    }

    this.schemas = schemas;
    var that = this;
    var callback = function(settings) {
        that._receiveSettingValues(settings);
    }
    if (this.componentInfo.componentId > 0) {
        this.getSettings(callback);
    } else {
        if (this.getSettingsValue) {
            this.getSettingsValue(callback);
        }else {
            that._receiveSettingValues({});
        }
    }
};
ComponentDetailDialog.prototype.getSettings = function(callback) {
    $cmsService.getSettings(this.componentInfo.componentId, this.componentInfo.componentType, function(settings) {
        if (callback) callback(settings);
    }, AdminConsole.instance.asCustomIndicator("Loading settings..."));
}
ComponentDetailDialog.prototype._receiveSettingValues = function(settings) {
    this.settings = settings;
    this._ready();
};
ComponentDetailDialog.prototype._ready = function() {
    this.open(this.componentInfo);
    if (this.onReady) this.onReady();
};

ComponentDetailDialog.prototype.shouldFireDesignChangeImmediately = function () {
    return false;
};
ComponentDetailDialog.prototype.signalDesignChanged = function() {
    if (this.shouldFireDesignChangeImmediately()) {
        this.performSignalDesignChanged();
    } else {
        this.hasDesignChangeEvent = true;
    }
};
ComponentDetailDialog.prototype.performSignalDesignChanged = function() {
    Dom.emitEvent(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, window.currentWebDesignFeature.node());
};
ComponentDetailDialog.prototype.onHide = function() {
    if (this.hasDesignChangeEvent) this.performSignalDesignChanged();
};

ComponentDetailDialog.prototype.loadSettings = function(container) {
    if (!container) return;
    var thiz = this;
    Dom.empty(container);
    this.propertiesWidget = new PropertiesWidget();
    this.propertiesWidget.setSchemas(this.schemas);
    this.propertiesWidget.setValue(this.settings);
    this.propertiesWidget.into(container);

    this.propertiesWidget.onRenderEditorFinished = function() {
        thiz.onSettingsChanged(false);
    }

    this._settingChangedMap = {};
    this.propertiesWidget.onValueChanged = function(ev) {
        var editor = Dom.getTarget(ev).__widget;
        var name = editor && editor._schema && editor._schema.name;
        if (!name) return;
        var originalValue = editor._value;
        var changed = thiz.toggleUnsavedNotify(name, originalValue, editor.getValue());
        thiz.onSettingsChanged(true, changed);
        if (changed) {
            thiz._settingChangedMap[name] = 1;
        } else {
            delete thiz._settingChangedMap[name];
        }
    }
}
ComponentDetailDialog.prototype.saveSettings = function(callback) {
    if (!this.propertiesWidget || !this.hasSettingsChanged()) {
        if (callback) callback();
        return;
    }
    this.saveSettingsImpl(this.propertiesWidget.getValue(), callback);
}
ComponentDetailDialog.prototype.saveSettingsImpl = function(values, callback) {
    var thiz = this;
    $cmsService.saveSettings(this.componentInfo.componentId, this.componentInfo.componentType, this.propertiesWidget.getValue(), function(){
        if (callback) callback();
        thiz.signalDesignChanged();
    }, function(error) {
    });
}
ComponentDetailDialog.prototype.hasSettingsChanged = function() {
    for (var k in this._settingChangedMap) {
        return true;
    }
    return false;
};
ComponentDetailDialog.prototype.onSettingsChanged = function(fromUser, diffOriginValue) {
};

ComponentDetailDialog.prototype.hasInputValuesChanged = function(values) {
    return this.hasSettingsChanged() || ComponentDetailDialog.__base.prototype.hasInputValuesChanged.call(this, values);
};
ComponentDetailDialog.prototype.getDialogTitle = function () {
    return CMSCommon.getString(this.componentInfo.componentType, this.componentInfo.componentName) + " Settings";
};
ComponentDetailDialog.prototype.asyncSetup = function (data, callback) {
    this.componentInfo = data;
    this.title = this.getDialogTitle();

    if (this.postAsyncSetup) {
        this.postAsyncSetup(callback);
    } else {
        callback();
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/CommandButtonsSetting.js";

function CommandButtonsSetting() {
    ComponentDetailDialog.call(this);
    var thiz = this;
    this.bind("click", function(){
        this.addCommand();
    }, this.addTabButton);
    var msg = this.hintBox.getMessage();
    msg = msg ? msg.replace("{MAX_BUTTON}", ADMIN_CONTEXT.maxCommandButtonsAllowed) : "";
    this.hintBox.setMessage(msg);


    this.menuItemRepeaterView.populator = function (data, binding) {
		binding._node._data = data;
        if (data.draft) Dom.addClass(binding._node, "Draft");
        Dom.setInnerText(binding.menuItemTitle, data.title || "");
        var linkTo = data.pageId ? data.pageTitle : data.url ? data.url : "";
        Dom.setInnerText(binding.menuItemCategory, linkTo);
        if (data.icon) {
            Dom.addClass(binding.commandIcon, data.icon);
        } else {
            binding.imageIcon.src = data.iconPath;
            Dom.addClass(binding.commandBox, "ImageIcon");
        }
        var rgba = Color.fromString(data.iconAndTextColor);
        var hsv = Color.RGB2HSV(rgba);
        var color = {
            h: hsv.hue,
            s: hsv.saturation,
            v: hsv.value,
            a: (typeof(rgba.a) == "undefined") ? 1 : rgba.a
        };
        var blank = color.a == 0;
        binding._node.style.color = binding.commandIcon.style.color = blank ? "" : Color.fromHSVA(color.h, color.s, color.v, color.a).toRGBAString();
        rgba = Color.fromString(data.backgroundColor);
        hsv = Color.RGB2HSV(rgba);
        color = {
           h: hsv.hue,
           s: hsv.saturation,
           v: hsv.value,
           a: (typeof(rgba.a) == "undefined") ? 1 : rgba.a
        };
        blank = color.a == 0;
        binding._node.style.backgroundColor = blank ? "" : Color.fromHSVA(color.h, color.s, color.v, color.a).toRGBAString();
	};

    var clickHandler = function(event) {

        var itemContainer = Dom.findUpwardForNodeWithData(event.target, "_data");
        if (!itemContainer) return;
        var data = itemContainer._data;
        var thiz = this;
        if (Dom.hasClass(event.target, "DeleteButton")) {

            var container = this.mode == "button" ? this.menuItemRepeaterView.node() : this.container;
            var nodes = container.childNodes;
            var ids = [];
            for (var i = 0; i < nodes.length; i ++) {
                var n = Dom.findUpwardForNodeWithData(nodes[i], "_data");
                if (!n) continue;
                ids.push(n._data.id);
            }
            var onlyOneItem = ids.length == 1;
            var dataSetName = data.dataSetName || "Default";
            Dialog.confirm("Do you want to delete this command button?", onlyOneItem ? "Data set \'" + dataSetName + "\' will be no longer available!!!" : null, "Delete", function(){
                $cmsService.deleteCommand(data.id, function (result) {
                    thiz._designChanged = true;
                    thiz.forceReload();
                    thiz.signalDesignChanged();
                }, function(error) {

                }, thiz);
            },
            "Cancel", function() {}, null, null);

        } else if (Dom.hasClass(event.target, "PublishButton")) {

            Dialog.confirm("Do you want to set this command button as publish?", null, "Set as Publish", function(){
                $cmsService.markAsPublishCommand(data.id, function (result) {
                    thiz._designChanged = true;
                    thiz.forceReload();
                    thiz.signalDesignChanged();
                }, function(e) {
                    if (e && "MAX_COMMAND_BUTTONS_EXCEEDED" == e.code) {
                        new Dialog.error(e.message);
                    }
                }, thiz);
            },
            "Cancel", function() {}, null, null);

        } else if (Dom.hasClass(event.target, "DraftButton")) {
            Dialog.confirm("Do you want to set this command button as draft?", null, "Set as Draft", function(){
                $cmsService.saveAsDraftCommand(data.id, function (result) {
                    thiz._designChanged = true;
                    thiz.forceReload();
                    thiz.signalDesignChanged();
                }, function(e) {

                }, thiz);
            },
            "Cancel", function() {}, null, null);
        } else if (Dom.hasClass(event.target, "CloneButton")) {
            Dialog.confirm("Do you want to clone this button?", null, "Clone", function(){
                $cmsService.cloneCommand(data.id, function (result) {
                    thiz._designChanged = true;
                    thiz.forceReload();
                    thiz.signalDesignChanged();
                }, function(e) {
                    // console.log("Clone error.");
                    if (e && "MAX_COMMAND_BUTTONS_EXCEEDED" == e.code) {
                        new Dialog.error(e.message);
                    }
                }, thiz);
            },
            "Cancel", function() {}, null, null);
        } else {

            var settings = thiz.propertiesWidget.getValue();
            var mode = settings["displayType"] || "button";

            new EditCommandButtonDialog().callback(function(command) {
                if (!command) return;

                $cmsService.updateCommand(command, function (result) {
                    thiz._designChanged = true;
                    thiz.forceReload();
                    thiz.signalDesignChanged();
                }, function(e) {
                    if (e && "MAX_COMMAND_BUTTONS_EXCEEDED" == e.code) {
                        new Dialog.error(e.message);
                    }
                }, thiz);

            }).open({command: data, mode: mode});
        }
    };
    this.bind("click", clickHandler, this.menuItemRepeaterView);
    this.bind("click", clickHandler, this.container);
}
__extend(ComponentDetailDialog, CommandButtonsSetting);
CommandButtonsSetting.prototype.getDialogActions = function() {
    if (this._designChanged && !this.modified) {
        return [{
            type: "accept", title: "Done",
            isCloseHandler: true,
            run: function () { return true; }
        }];
    }
    return ModificationWatchDialog.prototype.getDialogActions.call(this);
}
CommandButtonsSetting.prototype.setupReordering = function (container, horizontal) {
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(horizontal);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target) return null;
        return target;
    }.bind(this);

    this.dnd = new DragAndDropManager()
                .source(container)
                .anchor(function (dragNode) {
                    return Dom.hasClass(dragNode, "DragButton");
                })
                .itemInfo(function (dragNode) {
                    var node = Dom.findUpwardForNodeWithData(dragNode, "_data");
                    if (!node) return null;
                    return {
                        element: node,
                        data: node._data
                    };
                })
                .destination(container)
                .canDrop(function (data) {
                    return true;
                }.bind(this))
                .dropAt(dropTargetFinderFunction)
                .setup();
    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "CommandItemViewDragImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        var node =  Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
        node.style.width = horizontal ? "0px" : "100%";
        node.style.height = horizontal ? (Dom.getOffsetHeight(DragAndDropManager.draggable) + "px") : "0.5em";
        return node;
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);

            this._orderChanged = true;
            this.emitChangeEvent();

        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);

                this._orderChanged = true;
                this.emitChangeEvent();
            }
        }
    }.bind(this);
};
CommandButtonsSetting.prototype.save = function(callback) {
    var thiz = this;
    var container = this.mode == "button" ? this.menuItemRepeaterView.node() : this.container;
    var nodes = container.childNodes;
    var ids = [];
    for (var i = 0; i < nodes.length; i ++) {
        var n = Dom.findUpwardForNodeWithData(nodes[i], "_data");
        if (!n) continue;
        ids.push(n._data.id);
    }
    if (ids.length == 0) {
        Dialog.error("Please add command button before saving!");
        return;
    }
    if (thiz._orderChanged) {
        $cmsService.updateCommandsOrder(ids, function() {
            thiz.signalDesignChanged();
            thiz.saveSettings(callback);
        }, function(error){}, thiz);
    } else {
        thiz.saveSettings(callback);
    }
}
CommandButtonsSetting.prototype.getDialogTitle = function() {
    return "Edit Command Buttons";
}
CommandButtonsSetting.prototype.addCommand = function() {
    var thiz = this;

    var settings = this.propertiesWidget.getValue();
    var mode = settings["displayType"] || "button";
    var dataSetName = settings["dataSetName"] || "";

    new EditCommandButtonDialog().callback(function(command) {
        if (!command) return;

        command.dataSetName = dataSetName;
        $cmsService.createCommand(command, function (result) {
            thiz._designChanged = true;
            thiz.forceReload();
            thiz.signalDesignChanged();
        }, function(e) {
            if (e && "MAX_COMMAND_BUTTONS_EXCEEDED" == e.code) {
                new Dialog.error(e.message);
            }
        }, thiz);

    }).open({mode: mode});
}

CommandButtonsSetting.prototype.onHide = function() {
    this.__base().onHide.call(this);
    this.reset();
}
CommandButtonsSetting.prototype.onReady = function() {
    var thiz = this;
    this.loadSettings(this.settingsContainer);
}
CommandButtonsSetting.prototype.onSettingsChanged = function(fromUser) {
    this.reload(fromUser);
}
CommandButtonsSetting.prototype.destroyDnD = function() {
    if (this.dnd) {
        this.dnd.destroy();
    }
    this.dnd = null;
}
CommandButtonsSetting.prototype.reset = function() {
    this.container.innerHTML = "";
    this.menuItemRepeaterView.setItems([]);
    this.destroyDnD();
}
CommandButtonsSetting.prototype.forceReload = function () {
    this.mode = null;
    this.reload();
    this.invalidateElements();
}
CommandButtonsSetting.prototype.selectDataSet = function(name, push) {
    var e = this.propertiesWidget._editorsMap ? this.propertiesWidget._editorsMap["dataSetName"] : undefined;
    if (!e) return;
    var selectItem = null;
    if (typeof(name) == "string" && name.length > 0 && push) {
        var items = e.comboManager.items;
        var newDataSet = {key: name, value: name};
        selectItem = newDataSet;
        if (!e.comboManager.selectItemIfContains(selectItem)) {
            items.splice(items.length - 1, 0, selectItem);
            e.comboManager.setItems(items);
            e.comboManager.selectItem(selectItem, true);
        }
    } else {
        selectItem = {key: name || this.dataSetName || ""};
        e.comboManager.selectItemIfContains(selectItem)
    }
    e.fireChangeEvent(true);
}
CommandButtonsSetting.prototype.reload = function(onSettingsChanged) {
    var thiz = this;
    var settings = thiz.propertiesWidget.getValue();
    this.mode = settings["displayType"] || "button";
    var dataSetName = settings["dataSetName"];
    if (dataSetName == null && onSettingsChanged) {
        Dialog.prompt("Please input data set name!", "",  "Create", function(inputValue) {
            if (typeof(inputValue) == "undefined" || inputValue.length == 0) {
                thiz.selectDataSet("");
                return;
            }
            thiz.selectDataSet(inputValue, true);
        }, "Cancel", function() {
            thiz.selectDataSet("");
        });
        return;
    }
    this.reset();
    this.dataSetName = dataSetName;
    console.log("reload with >", this.mode, this.dataSetName);
    this.setupReordering(
        thiz.mode == "button" ? this.menuItemRepeaterView.node() : this.container,
        thiz.mode == "button" ? null : "horizontal");

    $cmsService.getAllCommands(dataSetName, function (r) {
        var items = r.result;
        if (thiz.mode && thiz.mode == "image") {

            Dom.addClass(thiz.container, "Active");
            Dom.removeClass(thiz.menuItemRepeaterView.node(), "Active");
            items.forEach(function (command) {
                var itemView = new CommandGridItemView().into(thiz.container);
                itemView.setCommand(command);
            }.bind(thiz));

            for (var i = 0; i < 10; i ++) {
                thiz.container.appendChild(Dom.newDOMElement({
                    _name: "div",
                    "class": "Fake"
                }));
            }
            thiz.alignToCenterWindow();
        } else {
            Dom.addClass(thiz.menuItemRepeaterView.node(), "Active");
            Dom.removeClass(thiz.container, "Active");
            thiz.menuItemRepeaterView.setItems(items, function () {
                thiz.alignToCenterWindow();
            });
        }
        thiz.invalidateSizing();

    }, function(error) {
    }, thiz);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/CommandGridItemView.js";

function CommandGridItemView() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, CommandGridItemView);

CommandGridItemView.prototype.setCommand = function (command) {
    this.command = command;

    var rgba = Color.fromString(this.command.iconAndTextColor);
    var hsv = Color.RGB2HSV(rgba);
    var color = {
        h: hsv.hue,
        s: hsv.saturation,
        v: hsv.value,
        a: (typeof(rgba.a) == "undefined") ? 1 : rgba.a
    };
    var blank = color.a == 0;
    this.node().style.color = blank ? "" : Color.fromHSVA(color.h, color.s, color.v, color.a).toRGBAString();

    Dom.setInnerText(this.nameLabel, this.command.title || "");
    this.description.setText(this.command.description || "");
    var linkTo = this.command.pageId ? this.command.pageTitle : this.command.url ? this.command.url : "";
    if (linkTo.length > 0) {
        this.linkToValue.innerHTML = "Link to: <strong>" + linkTo + "</strong>";
    } else {
        Dom.empty(this.linkToBox);
    }
    Dom.setInnerText(this.actionLink, this.command.action || "");
    this.imageView.setUrl(this.command.imagePath || "");
    if (this.command.draft) Dom.addClass(this.node(), "Draft");
    this.node()._data = this.command;
};
CommandGridItemView.prototype.setContentFragment = function (fragment) {
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node || node.nodeType != Node.ELEMENT_NODE) continue;
        var role = node.getAttribute("role") || node.localName;
        if (role == "command") {
            console.log("Load command info " + node.textContent);
        }
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/ContactDetailDialog.js";

function ContactDetailDialog () {
    Dialog.call(this);
    this.memberDyCombo.renderer = function (item) {return item.name;};
    this.memberDyCombo.comparer = Util.sameId;
    this.memberDyCombo.showContentCheckBox.checked = false;
    this.memberDyCombo.popup.setPopupClass("ContactDetailPopupView");

    this.title = "Create";
    this.bind("p:ItemSelected", function(ev) {
        if (!ev.fromUser) return;
        this._id = this.memberDyCombo.getSelectedItem().id;
    }.bind(this), this.memberDyCombo.node())

    this.validationRules = new RuleSet()
        .live(true)
        .custom(new RequiredRule(this.typeInput, "Please input maximum of 40 characters."), function(rule) {
                    var type = rule.input.value.trim();
                    if (!type) return true;
                    return type && type.length <= 40;
                })
        .required(this.memberDyCombo, "Please select member");

}
__extend(Dialog, ContactDetailDialog);

ContactDetailDialog.prototype.asyncSetup = function (options, callback) {
    var thiz = this;
    var id = options && options.memberId;
    var type = options && options.contact_type;
    this.item = options;
    thiz._id = id;
    if (id) {
        this.title = "Edit";
    }
    if (options && options.contact_section_id == 1) {
        this.title += " Coach"
    } else {
        this.title += " Director"
    }
    this.typeInput.value = type || "";

    var run = function (members, reload) {
        var source = this.getSource(members);
        this.memberDyCombo.setSource(source);
        if (!members || !members.length) {
            Dom.addClass(this.container, "NoMember");
        }
        if (reload) {
            ContactDetailDialog.ALL_MEMBERS_OBJECT.cacheTime = new Date();
            ContactDetailDialog.ALL_MEMBERS_OBJECT.members = members;
        }
        if (callback) callback();
    }.bind(this);

    var cacheTime = ContactDetailDialog.ALL_MEMBERS_OBJECT.cacheTime;
    if (cacheTime && ((new Date() - cacheTime) < ContactDetailDialog.RELOAD_TIME)
        && ContactDetailDialog.ALL_MEMBERS_OBJECT.members && ContactDetailDialog.ALL_MEMBERS_OBJECT.members.length) {
        run(ContactDetailDialog.ALL_MEMBERS_OBJECT.members);
        return;
    }

    $contactDetailService.getMemberDtos("", function(data) {
        var members = data.result;
        run(members, true);
    }.bind(this), new Spinner("Loading..."));

};

ContactDetailDialog.ALL_MEMBERS_OBJECT = {};
ContactDetailDialog.RELOAD_TIME = 5 * 60 * 1000;

ContactDetailDialog.prototype.getSource = function (items) {
    var thiz = this;
    var source =  {
        members: items,
        currentInput: undefined,
        getItems: function(term, callback) {
            if (this.currentInput == term) return;
            this.currentInput == term;
            if (!term) {
                callback(this.members);
                return;
            }
            var members = this.members.filter(function (member) {
                return member.name.toLowerCase().indexOf(term.toLowerCase()) >= 0;
            });
            callback(members);
        },
        getSelectedItem: function() {
            return thiz._id ? {id: thiz._id} : undefined;
        },
        getPreviewContent: function(data) {
            return undefined;
        }
    };
    return source;
}

ContactDetailDialog.prototype.getDialogActions = function () {
    var hasMember = ContactDetailDialog.ALL_MEMBERS_OBJECT.members
                && ContactDetailDialog.ALL_MEMBERS_OBJECT.members.length;
    return [
        {
            type: "cancel", title: hasMember ?  "Cancel" : "Close",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: this.item.id ? "Save" : "Create",
            isApplicable: function () { return hasMember; },
            run: function () { this.save(); return false; }
        }
    ]
};

ContactDetailDialog.prototype.save = function () {
    if (!ValidationManager.run(this.validationRules)) return;
    var thiz = this;
    var item = this.item || {};
    item.contact_type = this.typeInput.value.trim();
    item.memberId = this.memberDyCombo.getSelectedItem().id;
    $contactDetailService[(item.id && item.id >= 0 ? "update" : "create") + "Contact"](item, function () {
        thiz.close(true);
    }, new Spinner("Loading..."));
    return;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/ContactSortDialog.js";

function ContactSortDialog () {
    ModificationWatchDialog.call(this);
    this.contactItemRepeaterView.populator = function (data, binding, node, index) {
        binding._node._data = data;
        binding.contactName.innerHTML = data.name;
        binding.contactType.innerHTML = data.contact_type;
    };
    var thiz = this;
    this.bind("p:onAttached", this.setupReordering, this.contactItemRepeaterView.node());
    this.bind("click", this.handleItemClick, this.contactItemRepeaterView.node());
    this.bind("click", function () { thiz.editContact(); },this.addNewButton);
};
__extend(ModificationWatchDialog, ContactSortDialog);


ContactSortDialog.prototype.getDialogActions = function () {
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { this.close(this.change); return false; }
        }];
    }

    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () { this.save(function (data) {
                thiz.close(data);
            }); return false; }
        },
        {
            type: "cancel", title: (thiz.change ? "Close" : "Cancel"),
            isCloseHandler: true,
            run: function () {
                if (thiz.change) {
                    thiz.close(true);
                } else {
                    this.performCancel();
                }
                return false;
            }
        }
    ]
};

ContactSortDialog.prototype.save = function () {
    var ids = this.getCurrentInputValues();
    if (ids.length) {
        $contactDetailService.updateContactOrders(ids, function () {
            this.close(true);
        }.bind(this), function(err) {
            console.log(err);
        }, new Spinner("Saving.....") );
    }
    return;
};

ContactSortDialog.prototype.asyncSetup = function(options, callback) {
    var isCoach = options && options.isCoach;
    this.isCoach = isCoach;
    var text = isCoach ? "Coaches" : "Board of Directors";
    this.title = "Edit " + text;
    this.headerTitle.innerHTML = text + " List";
    this.refresh(callback);
};

ContactSortDialog.prototype.editContact = function (contact) {
    var data = contact || {};
    data.contact_section_id = this.isCoach ? 1 : 2;
    var contactDetailDialog = new ContactDetailDialog().callback (function (change) {
        if (change) {
            this.refresh();
            this.change = true;
        }
    }.bind(this));
    contactDetailDialog.open(data);
};

ContactSortDialog.prototype.refresh = function(callback) {
    var run = function (items) {
        this.contactItemRepeaterView.setItems(items);
        this.setSnapshotInputValues(this.getCurrentInputValues());
        if (callback) callback();
    }.bind(this);

    $contactDetailService["get" + (this.isCoach ? "Coach" : "Director") + "List"](function(rs) {
        run(rs.result);
    }, function(err) {
        console.log(err);
    }, new Spinner("Loading..."));
};
ContactSortDialog.prototype.getCurrentInputValues = function () {
    var ids = [];
    var nodes = this.contactItemRepeaterView.node().childNodes;
    Array.prototype.forEach.call(nodes, function(node){
        var data = node._data
        if (data && data.id > 0) {
            ids.push(data.id);
        }
    });
    return ids;
}
ContactSortDialog.prototype.handleItemClick = function (event) {
    var thiz = this;
    var text = this.isCoach ? "coach" : "director";
    var targetNode = event.target;
    var node = Dom.findUpwardForNodeWithData(targetNode, "_data");
    var data = node._data;
    if (Dom.hasClass(targetNode, "DeleteButton")) {
        Dialog.confirm("Do you want to delete this " + text + "?", data.name, "Delete", function() {
            $contactDetailService.removeContact(data.id, function () {
                thiz.refresh();
                thiz.change = true;
            }, new Spinner("Loading..."));
        }, "Cancel", function() {}, null, null);
    } else {
        thiz.editContact(data);
    }
};

ContactSortDialog.prototype.setupReordering = function () {

    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER();
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target) return null;
        return target;
    }.bind(this);

    this.dnd = new DragAndDropManager()
                .source(this.contactItemRepeaterView.node())
                .anchor(function (dragNode) {
                    return Dom.hasClass(dragNode, "DragButton");
                })
                .itemInfo(function (dragNode) {
                    var node = Dom.findParentWithClass(dragNode, "ContactItem");
                    if (!node) return null;
                    return {
                        element: node,
                        data: node._data
                    };
                })
                .destination(this.contactItemRepeaterView.node())
                .canDrop(function (data) {
                    return true;
                }.bind(this))
                .dropAt(dropTargetFinderFunction)
                .setup();
    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "DraggableItemImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        var node =  Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
        return node;
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        this.emitChangeEvent();
    }.bind(this);
};

function sortContact (componentInfo, callback) {
    var isCoach = componentInfo.data.isCoach == "true" ? true : false;
    var contactSort = new ContactSortDialog().callback(function (change) {
        if (change) {
            Dom.emitEvent(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, window.currentWebDesignFeature.node());
        }
    });
    contactSort.open({isCoach: isCoach});
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/ContactUsSetting.js";

function ContactUsSetting () {
    //this.grabHeight = true;
    this.dontStretchBody = false;
    ComponentDetailDialog.call(this);

    var thiz = this;
    this.contactItemRepeaterView.populator = function (data, binding, node, index) {
        var settings = thiz.settings;
        Dom.setInnerText(binding.locationName, data.locationName || "Location");
        if (data.hidden) Dom.addClass(binding._node, "Draft");
        binding._node._data = data;
        binding.mapImage.src = thiz.getMap(data);
        var address = thiz.getAddress(data);
        if (address) binding.address.innerHTML = "Address: " + "<strong>" + address + "</strong>";
        if (data.phoneNumber) binding.phone.innerHTML = "Phone: " + "<strong>" +  data.phoneNumber + "</strong>";
        if (data.fax) binding.fax.innerHTML = "Fax: "+ "<strong>" + data.fax + "</strong>";
    };
    // this.bind("input", this.handleSettingsClick, this.settingsContainer);
    this.bind("p:onAttached", this.setupReordering, this.contactItemRepeaterView.node());
    this.bind("click", this.handleItemClick, this.contactItemRepeaterView.node());
    this.bind("click", function() { this.editContact({}); }.bind(this), this.addContactButton);
}
__extend(ComponentDetailDialog, ContactUsSetting);

ContactUsSetting.prototype.render = function (callback) {
    $teamInfoService.getAllContactInfos(function(data) {
        var contacts = data && data.result;
        this.contactItemRepeaterView.setItems(contacts);
        if (!this.firstDayOfWeek && contacts.length > 0) {
            this.firstDayOfWeek = contacts[0].firstDayOfWeek;
        }
        this.setSnapshotInputValues(this.getCurrentInputValues());
        this.invalidateSizing();
        if (callback) callback();
    }.bind(this), function(e) {
        console.log(e);
    }, this);
};
ContactUsSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);
    this.propertiesWidget.onRenderEditorFinished = function () {
        var linkDescriptionEditor = this._editorsMap["linkDescription"];
        if (linkDescriptionEditor && this.valuesMap["linkDescription"] == "") {
            linkDescriptionEditor.textInput.node().value = "Contact Us";
        }
    }
}
ContactUsSetting.prototype.postAsyncSetup = function (callback) {
    if (this.team) {
        console.log(this.team);
        this.render(callback);
        return;
    }
    $teamInfoService.getTeam(function (result) {
        this.team = result;
        if (this.team.googleMapKey) {
            this.staticMapUrl = "https://maps.googleapis.com/maps/api/staticmap?key=" + this.team.googleMapKey + "&zoom=17&size=400x400&key=&center=_-center-_&markers=_-center-_";
        }
        this.render(callback);
    }.bind(this), function(error) {
        SnackBar.show("Failed to load Team Profile Info");
    }, this);
};
ContactUsSetting.LINK_NODE_CLASS = "ContactItem";
ContactUsSetting.prototype.setupReordering = function () {
    var thiz = this;

    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER();
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target) return null;
        return target;
    }.bind(this);

    this.dnd = new DragAndDropManager()
                .source(this.contactItemRepeaterView.node())
                .anchor(function (dragNode) {
                    return Dom.hasClass(dragNode, "DragButton");
                })
                .itemInfo(function (dragNode) {
                    var node = Dom.findParentWithClass(dragNode, ContactUsSetting.LINK_NODE_CLASS);
                    if (!node) return null;
                    return {
                        element: node,
                        data: node._data
                    };
                })
                .destination(this.contactItemRepeaterView.node())
                .canDrop(function (data) {
                    return true;
                }.bind(this))
                .dropAt(dropTargetFinderFunction)
                .setup();
    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "DraggableItemImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        var node =  Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
        return node;
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
            this._orderChanged = true;
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
                this._orderChanged = true;
            }
        }
        this.emitChangeEvent();
    }.bind(this);
};

ContactUsSetting.prototype.handleItemClick = function(event) {
    var targetNode = event.target;
    var thiz = this;
    var node = Dom.findUpwardForNodeWithData(targetNode, "_data");
    var data = node._data;
    if (!data) return;
    if (Dom.hasClass(targetNode, "PublishButton")) {
        Dialog.confirm("Do you want to show this item?", data.contactTitle, "Show", function() {
            $teamInfoService.updateContactVisibility(data.id, true, function () {
                thiz.render();
                thiz.signalDesignChanged();
            }, function (e) {
                console.log(e);
            }, thiz);
        },
        "Cancel", function() {}, null, null);
    } else if (Dom.hasClass(targetNode, "DraftButton")) {
        Dialog.confirm("Do you want to hide this item?", null, "Hide", function() {
            $teamInfoService.updateContactVisibility(data.id, false, function () {
                thiz.render();
                thiz.signalDesignChanged();
            }, function (e) {
                console.log(e.message);
            }, thiz);
        }, "Cancel", function() {}, null, null);
    } else if (Dom.hasClass(targetNode, "DeleteButton")) {
        Dialog.confirm("Do you want to delete this item?", data.locationName, "Delete", function() {
            $teamInfoService.deleteContactInfo(data.id, function() {
                SnackBar.show("Delete contact successfully.");
                thiz.render();
                thiz.signalDesignChanged();
            }, function (e) {
                console.log(e.message);
            }, thiz);
        }, "Cancel", function() {}, null, null);
    } else {
        this.editContact(data);
    }
};

ContactUsSetting.prototype.editContact = function(contact) {
    var thiz = this;
    var editContactInfoDialog = new EditContactInfoDialog().callback(function(data) {
        if (!data) return;
        if (!data.id) {
            $teamInfoService.addContactInfo(data, function() {
                thiz.render();
                thiz.signalDesignChanged();
            }, function (e) { console.log(e);}, thiz);
        } else {
            $teamInfoService.updateContactInfo(data, function () {
                thiz.render();
                thiz.signalDesignChanged();
            }, function (e) { console.log(e);}, thiz);
        }
    });
    editContactInfoDialog.open({
        info: contact,
        team: this.team,
        firstDayOfWeek: this.firstDayOfWeek,
        settings: this.propertiesWidget.getValue()
    });
};

ContactUsSetting.prototype.getCurrentInputValues = function () {
    var nodes = this.contactItemRepeaterView.node().childNodes;
    var orders = {};
    for (var i = 0; i < nodes.length; i++) {
        var n = nodes[i];
        var data = n._data;
        orders[data.id] = i;
    }
    return orders;
};

ContactUsSetting.prototype.getCurrentItemOrderInfos = function () {
    var nodes = this.contactItemRepeaterView.node().childNodes;
    var orders = [];
    for (var i = 0; i < nodes.length; i++) {
        var n = nodes[i];
        var data = n._data;
        orders.push(data.id);
    }
    return orders;
};


ContactUsSetting.prototype.save = function(callback) {
    var orders = this.getCurrentItemOrderInfos();
    if (this._orderChanged){
        $teamInfoService.updateContactInfoOrders(orders, function() {
            SnackBar.show("Contacts order are updated successfully.");
            this.saveSettings(callback);
            this.signalDesignChanged();
        }.bind(this), function(err) {
            SnackBar.show("Failed to update Utility Links: " + error.message);
        }, this);
    } else {
        this.saveSettings(callback);
    }

};
ContactUsSetting.prototype.getAddress = function(item) {
    var center = item.address.trim();
    if (center) center = center + ", ";
    center = center + item.city.trim();
    if (center) center = center + ", ";
    center = center + item.state.trim();
    // if (center) center = center + ", ";
    // center = center + item.country.trim();
    if (!center) return;
    return center;
}
ContactUsSetting.prototype.getMap = function (item) {
    var center = item.address.trim();
    if (center) center = center + ",";
    center = center + item.city.trim();
    if (center) center = center + ",";
    center = center + item.state.trim();
    if (center) center = center + " ";
    center = center + item.zipCode.trim();
    if (!center) return;
    return this.staticMapUrl.replace(/_-center-_/g, item.mapLatLng || center);
};

// ContactUsSetting.prototype.handleSettingsClick = function() {
//     var settings = this.propertiesWidget.getValue();
//     this.initSettings(settings);
// }
// ContactUsSetting.prototype.initSettings = function(settings) {
//     if (!settings) return;
//     Dom.toggleClass(this.contactItemRepeaterView.node(), "HiddenMap", !settings.showMap);
//     Dom.toggleClass(this.contactItemRepeaterView.node(), "HiddenAddress", !settings.showAddress);
//     Dom.toggleClass(this.contactItemRepeaterView.node(), "HiddenPhoneFax", !settings.showPhoneFax);
// }


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/CustomPageSelectionView.js";

function CustomPageSelectionView() {
    BaseTemplatedWidget.call(this);
    this.pageComboManager.renderer = function(item) {
        return !item ? "" : item.name;
    };
    this.pageComboManager.comparer = function(selected, item) {
        return selected.id == item.id;
    };

    this.pageComboManager.getMinimumWidth = function() {
        var show = this.showContentCheckBox.checked;
        return show ? this.button.offsetWidth * 1.7 : this.button.offsetWidth;
    };
    this.pageComboManager.popup.setPopupClass("CustomPagePopupView");

    var thiz = this;

    this.bind("p:ItemSelected", function(ev) {
        if (!ev.fromUser) return;
        thiz._id = thiz.pageComboManager.getSelectedItem().id;
    }, this.pageComboManager.node());

    this.bind("click", function() {
        var editDialog = new ContentPageEditDialog().callback(function (data) {
            if (!data) return;
            thiz._id = data.id;
            thiz.refresh();
        });
        editDialog.open({});
    }, this.addPageButton);

    this.bind("click", function() {
        var item = this.pageComboManager.getSelectedItem();
        if (!item) return;
        new ContentPagePreviewDialog().callback(function(){
        }).open(item);

    }, this.previewPageButton);

    this.bind("click", function() {
        var item = this.pageComboManager.getSelectedItem();
        if (!item) return;
        new ContentPageEditDialog().callback(function(data) {

            if (!data) return;
            thiz._id = data.id;
            thiz.refresh();

        }).open(item);
    }, this.editPageButton);

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.pageComboManager, "Please select page");

    this.refresh();
}
__extend(BaseTemplatedWidget, CustomPageSelectionView);
CustomPageSelectionView.prototype.getTemplatePath = function () {
    return this.getTemplatePrefix() + "CustomPageSelectionView.xhtml";
};
CustomPageSelectionView.prototype.type = function () {
    return "custom";
};
CustomPageSelectionView.prototype.onDetached = function() {
    //document.body.removeChild(this.pageComboManager.popup.popupContainer);
}
CustomPageSelectionView.prototype.getValue = function() {
    var data = {
        page: this.pageComboManager.getSelectedItem()
    }
    return data;
}

CustomPageSelectionView.prototype.confirmClosing = function (callback) {

    if (!ValidationManager.run(this.validationRules)) return;

    var page = this.pageComboManager.getSelectedItem();
    if (!page.draft)  {
        callback();
    } else {
        Dialog.confirm("Custom Page Tab Edit",
        "The page \"" + Dom.htmlEncode(page.name) + "\" is currently marked as a draft. Proceeding will make this page visible to all users. Publish?", "Publish", function() {
            //mark as Publish here
            $icms.setDraftContentPage(page.id, false, function() {
                callback();
            }, function(e){}, AdminConsole.instance);

        }, "Cancel");
    }
};

CustomPageSelectionView.prototype.setValue = function(data) {
    if (typeof(data) == "undefined") return;
    if (data && data.page) {
        this._data = data.page;
        this._id = data.page.contentPageId;
    }
}
CustomPageSelectionView.prototype.selectItem = function(id) {
    var thiz = this;
    this._id = id;
    this.pageComboManager.selectItemIfContains({id: id});
}
CustomPageSelectionView.prototype.refresh = function() {
    var thiz = this;
    var source =  {
        getItems: function(term, callback) {
            $icms.getAllCustomPages(term, function(result){
                var pages = result.result;
                callback(pages);
            }, function(err) {
                callback([]);
            });
        },
        getSelectedItem: function() {
            return thiz._id ? {id: thiz._id} : undefined;
        },
        getPreviewContent: function(data) {
            if (!data) return undefined;

            var v = new ContentPagePreview();
            v.create(data);
            return v;
        }
    };
    this.pageComboManager.setSource(source);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/CustomPageSetting.js";

function CustomPageSetting() {
    this.grabHeight = true;
    this.dontStretchBody = true;
    ComponentDetailDialog.call(this);
    this._original = null;
    var thiz = this;
    this.bind("p:onLoaded", function() {
        if (thiz._original) {
            //console.log("page view loaded.. set original", this._original);
            thiz.setSnapshotInputValues(thiz.getSnapShotValues());
            delete thiz._original;
        }
    }, this.pageView.node());
    this.pageView.disabledDraftBox();

}
__extend(ComponentDetailDialog, CustomPageSetting);

CustomPageSetting.prototype.getDialogTitle = function() {
    return "Custom Page Setting";
};

CustomPageSetting.prototype.getSnapShotValues = function() {
    return this.pageView.getSnapShotValues();
}

CustomPageSetting.prototype.onReady = function() {
    var id = this.settings["contentPageId"];
    Dom.addClass(this.settingsContainer, "Active");
    this.loadSettings(this.settingsContainer);
    this.refresh(id, "setSnapShort");
};

CustomPageSetting.prototype.onSettingsChanged = function(fromUser, diffOriginValue) {
    //console.log("Settings change --> fromUser: " + fromUser, diffOriginValue);
    if (!fromUser) return;
    var settings = this.propertiesWidget.getValue();
    var id = settings["contentPageId"];
    this.refresh(id);
};
CustomPageSetting.prototype.refresh = function(id, setSnapshot) {
    var thiz = this;

    $icms.getContentPageById(id, function(data) {
        if (setSnapshot) {
            thiz._original = data;
        }
        thiz.pageView.setup(data);
    },function(e){}, this);
}

CustomPageSetting.prototype.save = function(callback) {
    var thiz = this;
    if (!ValidationManager.run(this.pageView.validationRules)) return false;

    var finish = function(data) {
        thiz.clearUnsavedNotify();
        if (callback) callback(data);

        thiz.saveSettings(function() {
            thiz.close(data);
        });

    }
    this.pageView.save(finish, thiz.signalDesignChanged());
    return false;
};
CustomPageSetting.prototype.getCurrentInputValues = function() {
    return this.pageView.getCurrentInputValues();
}
CustomPageSetting.prototype.getChangeEventNames = function () {
    return this.pageView.getChangeEventNames();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/DeckPassSetting.js";

function DeckPassSetting() {
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, DeckPassSetting);

DeckPassSetting.prototype.getDialogTitle = function () {
    return "DeckPass Setting";

};

DeckPassSetting.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

DeckPassSetting.prototype.onReady = function () {
    this.loadSettings(this.settingsContainer);
    this.propertiesWidget.onRenderEditorFinished = function () {
        PropertiesWidget.prototype.onRenderEditorFinished.call(this);
        var heightEditor = this._editorsMap["maxHeight"];
        if (heightEditor && typeof(this.valuesMap["maxHeight"]) == "undefined") {
                heightEditor.numberInput.value = "";
        }
    }
    this.setSnapshotInputValues(this.settings);
};

DeckPassSetting.prototype.save = function( callback) {
    this.saveSettings(callback);
};
DeckPassSetting.prototype.getCurrentInputValues = function( callback) {
    return this.propertiesWidget.getValue();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/EditCommandButtonDialog.js";

function EditCommandButtonDialog() {
    Dialog.call(this);
    this.grabHeight = false;
}
__extend(Dialog, EditCommandButtonDialog);

EditCommandButtonDialog.prototype.setup = function(options) {
    this.options = options;
    this.command = this.options ? (this.options.command || undefined) : undefined;
    this.addingNew = !this.command;
    this.title =  this.addingNew ? "Add Command Button" : "Edit Command Button";
    this.photoFileUploadView.dataType = "command";
    this.photoFileUploadView.dataUUID = "default";
    var thiz = this;
    this.validationRules = new RuleSet().live(true);

    if (this.options.mode == "button") {
        this.validationRules = this.validationRules.custom(new RequiredRule(this.buttonColorInput, "Please select the button color"), function(rule) {
                    var hex = rule.input.getRGBAHexColorString();
                    return hex && hex.length > 0 ? hex : undefined;
                })
        /*.custom(new RequiredRule(this.iconInput, "Please select the button icon"), function(rule) {
                    var icon = rule.input.getIcon();
                    console.log("button icon: ", icon);
                    return icon && icon.length > 0 ? icon : undefined;
                })*/
        .custom(new RequiredRule(this.textAndIconColor, "Please select the text & icon color"), function(rule) {
                    var hex = rule.input.getRGBAHexColorString();
                    return hex && hex.length > 0 ? hex : undefined;
                });
     } else {
        this.validationRules = this.validationRules.custom(new RequiredRule(this.photoFileUploadView, "Please select the thumbnail photo"));
    }
    this.validationRules = this.validationRules.custom(new PatternMatchedRule(this.pageChooser, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid URL! Please check your input."), function(rule) {
            var page = rule.input.getSelectedPage();
            if (page) return "";
            var url = rule.input.getUrl();
            return url && url.length > 0 ? url : undefined;
        });
}
EditCommandButtonDialog.prototype.onShown = function() {
    var thiz = this;

    $configurationService.getConfigValue("cms_download_stock_images_url", function(config) {
            var url = config ? config.stringValue : "";
            Dom.toggleClass(thiz.downloadStockImagesLink, "Active", url && url.length > 0 ? true : false);
            thiz.downloadStockImagesLink.href = url;
    });

    this.initInfo();
}
EditCommandButtonDialog.prototype.initInfo = function() {
    this.buttonTextInput.focus();
    Dom.addClass(this.commandBox, this.options.mode);

    this.buttonColorInput.setInfoWhenDefaultColorSelected("Default template's color will be used");
    this.buttonColorInput.setDefaultColor("#FFFFFF00");

    this.textAndIconColor.setInfoWhenDefaultColorSelected("Default template's color will be used");
    this.textAndIconColor.setDefaultColor("#FFFFFF00");

    this.textColor.setInfoWhenDefaultColorSelected("Default template's color will be used");
    this.textColor.setDefaultColor("#FFFFFF00");

    if (this.addingNew) {
        this.iconInput.setIcon(null);
        this.invalidateSizing();
        return;
    }

    this.buttonTextInput.value = this.command.title || "";
    this.photoFileUploadView.setCommaSeparatedStoragePaths(this.command.imagePath);
    this.buttonInfoInput.value = this.command.action || "";
    this.descriptionInput.value = this.command.description || "";

    if (this.command.icon) {
        this.iconInput.setIcon(this.command.icon);
    } else if (this.command.iconPath) {
        this.iconInput.setIconPath(this.command.iconPath);
    }
    this.buttonColorInput.setRGBAHexColorString(this.command.backgroundColor || "#FFFFFF00");
    this.textAndIconColor.setRGBAHexColorString(this.command.iconAndTextColor || "#FFFFFF00");
    this.textColor.setRGBAHexColorString(this.command.iconAndTextColor || "#FFFFFF00");

    this.openPolicy.setValueSelected(this.command.openPolicy, true);
    if (this.command.pageId > 0) {
        var selectedPage = {id : this.command.pageId, title: this.command.pageTitle};
        this.pageChooser.selectPage(selectedPage);
    } else {
        this.pageChooser.setUrl(this.command.url);
    }
    this.invalidateSizing();
}
EditCommandButtonDialog.prototype.onHide = function() {
    /*document.body.removeChild(this.buttonColorInput.popup.popupContainer);
    document.body.removeChild(this.textAndIconColor.popup.popupContainer);
    document.body.removeChild(this.iconInput.iconPopup.popupContainer);*/
}
EditCommandButtonDialog.prototype.getDialogActions = function() {
    return [
        {
            type: "accept", title: "Save",
            run: function () { this.save(); return false; }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
}
EditCommandButtonDialog.prototype.save = function() {

    if (!ValidationManager.run(this.validationRules)) return;

    this.close(this.getValue());
}

EditCommandButtonDialog.prototype.getValue = function() {
    var command = {
        action: this.buttonInfoInput.value.trim(),
        openPolicy: this.openPolicy.getValues()[0],
        pageId: this.pageChooser.getSelectedPage() ? this.pageChooser.getSelectedPage().id : null,
        url: this.pageChooser.getSelectedPage() ? null : this.pageChooser.getUrl(),
        id: this.command ? this.command.id : 0,
    };
    command.title = this.buttonTextInput.value.trim();
    command.imagePath = this.photoFileUploadView.getCommaSeparatedStoragePaths();
    if (this.iconInput.getIconType() == IconChooserWidget.TYPE_CUSTOM_ICON) {
        command.iconPath = this.iconInput.getIcon();
    } else {
        command.icon = this.iconInput.getIcon();
    }
    command.backgroundColor = this.buttonColorInput.getRGBAHexColorString();
    command.iconAndTextColor = this.options.mode == "button" ? this.textAndIconColor.getRGBAHexColorString() : this.textColor.getRGBAHexColorString();
    command.description = this.descriptionInput.value.trim();

    return command;
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/EditContactInfoDialog.js";

function EditContactInfoDialog() {
    ModificationWatchDialog.call(this);
    this.grabHeight = true
    this.dontStretchBody = false;
    this.firstDayOfWeekId = 2; // Monday
    this.daysOfWeek = [];
    this.idToDayOfWeekMap = {};
    this.idToDayOfWeekNodeMap = {};
    this.googleMapUrl = "https://www.google.com/maps/place/_-place-_";
    var url = (ADMIN_CONTEXT.isUsingCustomDomain ? "" : ("/team/" + ADMIN_CONTEXT.teamAlias)) + "/page/system/contactus";
    this.linkContact.innerHTML = "<span>"+ url + "</span>";
    this.linkContact.href = url;
    this.bind("click", function (event) {
        this.copyFromTeamProfile(this.team);
        this.refreshMap();
        this.emitChangeEvent();
    }, this.copyInfoButton);
    this.bind("click", this.refreshMap.bind(this), this.refreshMapButton);
}
__extend(ModificationWatchDialog, EditContactInfoDialog);

EditContactInfoDialog.NUMBER_OF_DAYS_IN_WEEK = 7;

EditContactInfoDialog.prototype.setup = function(data) {
    var info = data.info;
    this.team = data.team;
    if (data.firstDayOfWeek && !info.id) this.firstDayOfWeekId = data.firstDayOfWeek;
    this.title = info.id ? "Edit Contact" : " Add New Contact";
    this.staticMapUrl = "https://maps.googleapis.com/maps/api/staticmap?key=" + this.team.googleMapKey + "&zoom=15&size=300x300&key=&center=_-center-_&markers=_-center-_";
    this.render(info);
    this.settings = data.settings;
    this.validationRules = new RuleSet().live(true).required(this.locationNameInput, "Please input the location name");
    if (this.settings.showAddress) this.validationRules.required(this.addressInput, "Please input the Address");
    this.validationRules.required(this.cityInput, "Please input the City")
                        .required(this.stateInput, "Please input the " + "State")
                        .required(this.zipCodeInput, "Please input the " + "Zip Code");
    if (this.settings.showPhoneFax) this.validationRules
        .required(this.phoneInput, "Please input the Phone Number", Condition.not(Condition.notEmpty(this.faxInput)))
        .required(this.faxInput, "Please input the Fax", Condition.not(Condition.notEmpty(this.phoneInput)));
    Dom.toggleClass(this.contactLinkBox, "Active", TEAM_INFO && TEAM_INFO.isNonTUTeam ? false : true);
}

EditContactInfoDialog.prototype.save = function() {
    if (!ValidationManager.run(this.validationRules)) return;
    if (this.settings.showHours && !this.getContactTimes(this.settings.showHours)) return;
    this.close(this.getCurrentInputValues());
}

EditContactInfoDialog.prototype.getCurrentInputValues = function() {
    var model = JSON.parse(JSON.stringify(this.item));
    model.locationName = this.locationNameInput.value;
    model.address = this.addressInput.value;
    model.address2 = this.address2Input.value;
    model.city = this.cityInput.value;
    model.state = this.stateInput.value;
    model.zipCode = this.zipCodeInput.value;
    model.phoneNumber = this.phoneInput.value;
    model.fax = this.faxInput.value;
    model.mapHeader = this.mapTitle.value;
    model.addressHeader = this.addressTitle.value;
    model.phoneAndFaxHeader = this.phoneAndFaxTitle.value;
    model.hoursHeader = this.hoursTitle.value;
    model.contactLinkHeader = this.contactLinkTitle.value;
    var contactTimes = this.getContactTimes(this.settings.showHours);
    if (contactTimes) {
        model.contactTimes = contactTimes;
    } else {
        model.contactTimes = [];
    }
    return model;
}

EditContactInfoDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

EditContactInfoDialog.prototype.render = function(contactInfo) {
    var team = this.team;
    this.item = contactInfo;
    this.locationNameInput.value = contactInfo.locationName  || "";
    this.addressInput.value = contactInfo.address || "";
    this.address2Input.value = contactInfo.address2 || "";
    this.cityInput.value = contactInfo.city || "";
    this.stateInput.value = contactInfo.state || "";
    this.zipCodeInput.value = contactInfo.zipCode || team.zip || "";
    this.countryInput.innerHTML = contactInfo.country || "";
    this.phoneInput.value = contactInfo.phoneNumber || team.phone || "";
    this.faxInput.value = contactInfo.fax || "";
    var thiz = this;

    if (!this.item.contactTimes || !this.item.contactTimes.length) {
        this.item.contactTimes = [];
        for (var k in this.idToDayOfWeekMap) {
            if (this.idToDayOfWeekMap.hasOwnProperty(k)) {
                this.item.contactTimes.push(this.getDefaultContactTime(k));
            }
        }
    } else {
        for (var i = 0; i < this.item.contactTimes.length; i++) {
            this.item.contactTimes[i].message = this.item.contactTimes[i].message || "";
        }
    }
    this.registerUnsavedChanges(false);
    if (typeof (this.item.firstDayOfWeek) == "number") this.firstDayOfWeekId = this.item.firstDayOfWeek;
    this._initDaysData();
    this.hoursRepeaterView.populator = function (data, binding, node, index) {
        node._data = this.getDefaultContactTime(data.id);
        this.idToDayOfWeekNodeMap[data.id] = binding;
        binding.startDay.innerHTML = this.idToDayOfWeekMap[data.id].name;
    }.bind(this);
    this.hoursRepeaterView.setItems(this.daysOfWeek, function () {
        this.invalidateSizing();
    }.bind(this));
    this.copyFromTeamProfile(this.item);
    this.bindEventsToHourElements();
    this.compactTimes(this.item.contactTimes);
    this.initDaySelectBoxes();
    //init custom header;
    this.mapTitle.value = this.item.mapHeader || "Map"
    this.phoneAndFaxTitle.value = this.item.phoneAndFaxHeader || "Phone & Fax";
    this.addressTitle.value = this.item.addressHeader || "Address";
    this.hoursTitle.value = this.item.hoursHeader || "Hours";
    this.contactLinkTitle.value = this.item.contactLinkHeader || "Contact Us";
    this.setSnapshotInputValues(contactInfo);
    this.registerUnsavedChanges(true);
    this.refreshMap(this.item.mapUrl, this.item.mapLatLng);
}


EditContactInfoDialog.prototype.copyFromTeamProfile = function(team) {
    if (!team) return;
    this.addressInput.value = team.address || "";
    this.address2Input.value = team.address2 || "";
    this.cityInput.value = team.city || "";
    this.stateInput.value = team.state || "";
    this.zipCodeInput.value = team.zipCode || team.zip || "";
    this.countryInput.innerHTML = team.country || "";
    this.phoneInput.value = team.phoneNumber || team.phone || "";
    this.faxInput.value = team.fax || "";
};

EditContactInfoDialog.prototype.getDefaultContactTime = function(dayOfWeek) {
    return {start: {dayOfWeek: dayOfWeek}, end: {dayOfWeek: dayOfWeek}, message: ""};
};

EditContactInfoDialog.prototype._initDaysData = function() {
    // Following java.util.Calendar.DAY_OF_WEEK
    var days = [
        [1, "Sunday", "Sun"],
        [2, "Monday", "Mon"],
        [3, "Tuesday", "Tue"],
        [4, "Wednesday", "Wed"],
        [5, "Thursday", "Thu"],
        [6, "Friday", "Fri"],
        [7, "Saturday", "Sat"]
    ];

    var fromIdx = 0;
    while (days[fromIdx][0] != this.firstDayOfWeekId) fromIdx++;
    for (var i = 0; i < EditContactInfoDialog.NUMBER_OF_DAYS_IN_WEEK; i++, fromIdx++) {
        var d = days[fromIdx % EditContactInfoDialog.NUMBER_OF_DAYS_IN_WEEK];
        var o = {id: d[0], name: d[1], abbr: d[2]};
        this.daysOfWeek.push(o);
        this.idToDayOfWeekMap[o.id] = o;
    }
};

EditContactInfoDialog.prototype.compactTimes = function(contactTimes) {
    // Enable corresponding nodes and do compact
    for (var i = 0; i < contactTimes.length; i++) {
        var data = contactTimes[i];
        var start = data.start;
        var end = data.end;
        var node = this.idToDayOfWeekNodeMap[start.dayOfWeek];
        node._node._data = data;

        var pressButton = this.getDayIndexInWeek(end.dayOfWeek) > this.getDayIndexInWeek(start.dayOfWeek);
        this.handleTogglgeButtonClick(node.toDayButton, false, pressButton);

        var isPM;
        if (!isNaN(start.hour)) {
            var item =  this.convert24HoursTo12Hours(start.hour);
            node.startHourInput.value =  item.hour;
            node.startMinuteInput.value = start.minute;
            isPM = item.isPM;
            this.handleTogglgeButtonClick(node.startTimePeriodButton, false, isPM);
        }

        if (!isNaN(end.hour)) {
            var item =  this.convert24HoursTo12Hours(end.hour);
            node.endHourInput.value = item.hour;
            node.endMinuteInput.value = end.minute;
            isPM = item.isPM;
            this.handleTogglgeButtonClick(node.endTimePeriodButton, false, isPM);
        }
        node.messageInput.value = data.message;

        var activeIconIndex = data.message.length > 0 ? 1 : 0;
        this.handleIconSwitcherClick(node.dayRangeContentTypeSwitcher, activeIconIndex);

        // Hide nodes in the day range except the start day
        var nextNode = node._node;
        do {
            nextNode = nextNode.nextSibling;
            if (nextNode == null) break;
            Dom.addClass(nextNode, "Hidden");
        } while (end.dayOfWeek != nextNode._data.end.dayOfWeek);
        Dom.removeClass(node._node, "Hidden");
    }
};

EditContactInfoDialog.prototype.initDaySelectBoxes = function() {
    var nodes = this.hoursRepeaterView.node().childNodes;
    for (var i = 0; i < nodes.length; i++) {
        var node = nodes[i];
        node.endDay = node.endDay || node.querySelector(".DayRangeHeader .EndDay").__widget;
        var nextDays = this.getNextDaysInWeek(parseInt(node._data.start.dayOfWeek, 10));
        // If there have none of next days, remove selection tool
        if (nextDays.length === 0) {
            var button = node._binding.toDayButton;
            this.handleTogglgeButtonClick(button, false, false);
            button.removeEventListener("click", this.handleTogglgeButtonClick);
            Dom.addClass(button, "Hidden");
            continue;
        }
        node.endDay.renderer = function(day) {
            return day.name;
        };
        node.endDay.comparer = function(a, b) {
            return a && b && a.id == b.id;;
        };
        node.endDay.setItems(nextDays);
        node.endDay.selectItemByKey("id", parseInt(node._data.end.dayOfWeek, 10));

        this.bind("p:ItemSelected", function(event) {
            var target = Dom.getTarget(event);
            var container = this._findUpwardItemView(target);
            if (container) {
                this.onDayRangeChanged(container, true);
            }
        }, node.endDay);
    }
};

EditContactInfoDialog.prototype.getNextDaysInWeek = function(from) {
    var days = [];
    var i = 0;
    while (this.daysOfWeek[i].id != from) i++;
    while (++i < this.daysOfWeek.length) days.push(this.daysOfWeek[i]);
    return days;
};

EditContactInfoDialog.prototype.getDayIndexInWeek = function(day) {
    return (day + EditContactInfoDialog.NUMBER_OF_DAYS_IN_WEEK - this.firstDayOfWeekId) % EditContactInfoDialog.NUMBER_OF_DAYS_IN_WEEK;
};

EditContactInfoDialog.prototype.checkDayRangeChanged = function(node) {
    var button = node._binding.toDayButton;
    this.onDayRangeChanged(node, this.isToggled(button));
};

EditContactInfoDialog.prototype.onDayRangeChanged = function(node, visibility) {
    var endDayOfWeek = visibility ? node._binding.endDay.getSelectedItem().id : parseInt(node._data.start.dayOfWeek, 10);
    var selectedEndDayOfWeekIndex = this.getDayIndexInWeek(endDayOfWeek);
    var nextNode = node;
    while ((nextNode = nextNode.nextSibling)) {
        // Unpressed toggle button
        this.handleTogglgeButtonClick(nextNode._binding.toDayButton, false, false);
        // Check visibility
        var nextStartDayOfWeekIndex = this.getDayIndexInWeek(parseInt(nextNode._data.start.dayOfWeek, 10));
        if (nextStartDayOfWeekIndex > selectedEndDayOfWeekIndex) {
            Dom.removeClass(nextNode, "Hidden");
        } else {
            Dom.addClass(nextNode, "Hidden");
        }
    }
    this.emitChangeEvent();
};

EditContactInfoDialog.prototype.bindEventsToHourElements = function() {
    this.bind("click", function(event) {
        var target = Dom.getTarget(event);
        var itemNode = this._findUpwardItemView(target);

        if (Dom.hasClass(target, "ToggleButton")) {
            this.handleTogglgeButtonClick(target, true);
            this.checkDayRangeChanged(itemNode);
        } else if (Dom.hasClass(target, "IconSwitcher")) {
            this.handleIconSwitcherClick(target);
            this.emitChangeEvent();
        }

    }, this.hoursRepeaterView);
    Dom.doOnSelector(this.hoursRepeaterView.node(), ".TimeInputGroup > input", function(input) {
        Dom.registerEvent(input, "focus", function (event) {
            Dom.addClass(this.parentNode, "Focus");
        }, true);
        Dom.registerEvent(input, "blur", function (event) {
            Dom.removeClass(this.parentNode, "Focus");
        }, true);
    });
};

EditContactInfoDialog.prototype.isToggled = function(button) {
    return button.getAttribute("aria-pressed") === "true";
};

EditContactInfoDialog.prototype.handleTogglgeButtonClick = function(button, updateState, isCurrentlyPressed) {
    var pressed = typeof(isCurrentlyPressed) != "undefined" ? !!isCurrentlyPressed : (this.isToggled(button));
    if (updateState) pressed = !pressed;
    var text = pressed ? button.getAttribute("data-pressed") : button.getAttribute("data-unpressed");
    if (text && text.length) button.innerHTML = text;
    button.setAttribute("aria-pressed", pressed);
};

EditContactInfoDialog.prototype.handleIconSwitcherClick = function(switcher, activeIndex) {
    var icons = this.findElementNodes(switcher);
    var count = switcher.getAttribute("data-count") || 0;
    count = parseInt(count, 10);
    Dom.removeClass(icons[count], "Selected");
    var nextCount = -1;
    try {
        if (typeof(activeIndex) != "undefined") nextCount = parseInt(activeIndex, 10);
    } catch (err) {}
    if (nextCount == -1) nextCount = (count + 1) % icons.length;

    Dom.addClass(icons[nextCount], "Selected");
    switcher.setAttribute("data-count", nextCount);

    if (Dom.hasClass(switcher, "DayRangeContentTypeSwitcher")) {
        var dataItems = this.findElementNodes(Dom.findChildWithClass(switcher.parentNode, "DayRangeData"));
        Dom.removeClass(dataItems[count], "Selected");
        Dom.addClass(dataItems[nextCount], "Selected");
    }
};

EditContactInfoDialog.prototype._findUpwardItemView = function(target) {
    return Dom.findParentWithClass(target, "ItemView");
};

EditContactInfoDialog.prototype.findElementNodes = function(parentNode) {
    return Dom.findChildren(parentNode, {eval: function (node) {
            return node.nodeType == Node.ELEMENT_NODE;
        }
    });
};

EditContactInfoDialog.prototype.getContactTimes = function(updateUI) {
    var contactTimes = [];
    var nodes = this.hoursRepeaterView.node().childNodes;
    for (var i = 0; i < nodes.length; i++) {
        node = nodes[i];
        if (Dom.hasClass(node, "Hidden")) continue;

        var range = this.getTimeRange(node._binding, updateUI);
        var msg = this.getTimeMessage(node._binding, updateUI);
        if (!range && !msg) return null;

        var start = {dayOfWeek: parseInt(node._data.start.dayOfWeek, 10)};
        var endId = this.isToggled(node._binding.toDayButton) ? node._binding.endDay.getSelectedItem().id : start.dayOfWeek;
        var end = {dayOfWeek: endId};
        if (range !== null) {
            start["hour"] = range.from.hour;
            start["minute"] = range.from.minute;
            end["hour"] = range.to.hour;
            end["minute"] = range.to.minute;
        } else {
            start["hour"] = 0;
            start["minute"] = 0;
            end["hour"] = 0;
            end["minute"] = 0;
        }

        contactTimes.push({start: start, end: end, message: msg});
    }
    return contactTimes;
};

EditContactInfoDialog.prototype.getTimeRange = function(node, updateUI) {
    var h = parseInt(node.startHourInput.value, 10);
    var m = parseInt(node.startMinuteInput.value, 10) || 0;
    var isZero = h === 0 ?  true : false;
    if (!isNaN(h)) {
        h =  this.convert12HoursTo24Hours(h, this.isToggled(node.startTimePeriodButton));
    }
    var invalid = isNaN(h) || h < 0 || h > 23 || isZero;
    invalid = invalid || isNaN(m) || m < 0 || m > 59;
    invalid = invalid || (h === 23 && m === 59 && this.isToggled(node.startTimePeriodButton));

    if (updateUI) {
        if (invalid) Dom.addClass(node.startHourInput.parentNode, "Invalid");
        else Dom.removeClass(node.startHourInput.parentNode, "Invalid");
    }
    if (invalid) return null;

    var range = {from: {hour: h, minute: m}};

    h = parseInt(node.endHourInput.value, 10);
    m = parseInt(node.endMinuteInput.value, 10) || 0;
    isZero = h === 0 ?  true : false;
    if (!isNaN(h)) {
        h =  this.convert12HoursTo24Hours(h, this.isToggled(node.endTimePeriodButton));
    }
    invalid = isNaN(h) || h < 0 || h > 23 || isZero;
    invalid = invalid || isNaN(m) || m < 0 || m > 59;
    invalid = invalid || (h === 23 && m === 59 && this.isToggled(node.endTimePeriodButton));

    if (updateUI) {
        if (invalid) Dom.addClass(node.endHourInput.parentNode, "Invalid");
        else Dom.removeClass(node.endHourInput.parentNode, "Invalid");
    }
    if (invalid) return null;

    range["to"] = {hour: h, minute: m};

    invalid = (range.to.hour * 60 + range.to.minute) <= (range.from.hour * 60 + range.from.minute);
    if (invalid && updateUI) {
        Dom.addClass(node.startHourInput.parentNode, "Invalid");
        Dom.addClass(node.endHourInput.parentNode, "Invalid");
    }
    if (invalid) return null;
    return range;
};

EditContactInfoDialog.prototype.getTimeMessage = function(node, updateUI) {
    var selected = Dom.hasClass(node.messageInput, "Selected");
    if (!selected) return "";

    var val = node.messageInput.value.trim();
    var invalid = val.length < 1;

    if (updateUI) {
        if (invalid) Dom.addClass(node.messageInput, "CV_Invalid");
        else Dom.removeClass(node.messageInput, "CV_Invalid");
    }

    return invalid ? "" : val;
};
EditContactInfoDialog.prototype.convert12HoursTo24Hours = function(hour,isPM) {
    if (isNaN(hour)) return;
    if (hour == 12)  hour = 0;
    if (isPM) hour += 12;
    return hour;
}

EditContactInfoDialog.prototype.refreshMap = function(mapUrl, mapLatLng) {
    if (!this.staticMapUrl ) return;
    var center = this.addressInput.value.trim();
    if (center) center = center + ",";
    center = center + this.cityInput.value.trim();
    if (center) center = center + ",";
    center = center + this.stateInput.value.trim();
    if (center) center = center + " ";
    center = center + this.zipCodeInput.value.trim();
    if (!center) return;
    this.mapImage.src = this.staticMapUrl.replace(/_-center-_/g, mapLatLng || center);
    this.mapImage.parentNode.href = mapUrl || this.googleMapUrl.replace("_-place-_", center);
}

EditContactInfoDialog.prototype._receiveSettingValues = function(settings) {
    if (!settings) return;
    if (settings.hasOwnProperty("showAddress")) this.addressCheckbox.checked = settings.showAddress;
    if (settings.hasOwnProperty("showPhoneFax")) this.phoneCheckbox.checked = settings.showPhoneFax;
    if (settings.hasOwnProperty("showMap")) this.mapCheckbox.checked = settings.showMap;
    if (settings.hasOwnProperty("showHours")) this.hoursCheckbox.checked = settings.showHours;
    if (settings.hasOwnProperty("showContactLink")) this.contactLinkCheckbox.checked = settings.showContactLink;
};
EditContactInfoDialog.prototype.convert24HoursTo12Hours = function(hour) {
    if (hour == 0) return { hour: 12, isPM: false};
    if (hour < 12)  return { hour: hour, isPM: false};
    if (hour == 12) return { hour : 12, isPM: true};
    return {hour: hour % 12, isPM: true};
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/EditMenuTabDialog.js";

function EditMenuTabDialog(parentMenuTab) {
    Dialog.call(this);
    this.contentTypeComboManager.renderer = function(data) {
        return data.name;
    };
    this.contentTypeComboManager.comparer = function(selected, item) {
        return selected.type == item.type;
    };
    var thiz = this;
    this.contentTypeComboManager.options = {
        onItemSelected: function() {
            thiz.onContentTypeChanged();
        }
    };
    Dom.addClass(this.linkBox, "Disabled");
    this.bind("click", function(){
        MainNavigatorSetting.copyClipboard(this.url);
    }.bind(this), this.copyLink);

    this[EditMenuTabDialog.TYPE_LINK] = LinkSelectionView;
    this[EditMenuTabDialog.TYPE_CUSTOM_PAGE] = CustomPageSelectionView;
    this.isEnterTilte = false;
    this.parentMenuTab = parentMenuTab;
    this.bind("click", function() {

        InfoTip.show(this.helpInfo, "Enable this option, this tab and its sub-tabs content are drafting and invisible on the site, only admin can view and edit until this option is disabled.", false, null, "tooltip", "right-inside", -(Dom.getOffsetWidth(this.helpInfo)/2 + 7));

    }, this.helpInfo);

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.tabTitle, "Please enter tab label");

    this.adminLevelCombo.renderer = function(item) {
        return item.displayName || "";
    };
    this.adminLevelCombo.comparer = function(a, b) {
        return a.code == b.code;
    };

    InfoTip.install(this.accessLevelContainer, {
        "match": function(node) {
            return Dom.hasClass(node, "LevelInfoIcon");
        },
        "getMessage": function(target) {
            var selected = this.adminLevelCombo.getSelectedItem();
            if (!selected && selected.type == ContentAccessLevel.PUBLIC.type) return "";
            if (selected.type == ContentAccessLevel.AUTHENTICATED.type) return "Only logged in account can access this content.";

            var displayName = ""
            if (selected.type == ContentAccessLevel.BASIC_LEVEL.type) {
                displayName = PERMISSION_DESCRIPTION.CMS_BasicContent_View.displayName
            }
            if (selected.type == ContentAccessLevel.WEBMASTER_LEVEL.type) {
                displayName = PERMISSION_DESCRIPTION.CMS_WebmasterContent_View.displayName
            }
            if (selected.type == ContentAccessLevel.HIGHEST_LEVEL.type) {
                displayName = PERMISSION_DESCRIPTION.CMS_HighestContent_View.displayName
            }

            return String.format("This content requires logged in account having permission '{0}' to access.", displayName);
        }.bind(this)
    });

    this.bind("input", function() {
        this.isEnterTilte = this.tabTitle.value.trim() ? true : false;
    }, this.tabTitle);
    this.bind("p:ItemSelected", function(ev) {
        var selected = this.adminLevelCombo.getSelectedItem();
        Dom.toggleClass(this.accessLevelContainer, "WithMoreInfo", selected && selected.type != ContentAccessLevel.PUBLIC.type);
    }, this.adminLevelCombo.node());
    this.adminLevelCombo.setItems(this.getContentAccessLevels());

}
__extend(Dialog, EditMenuTabDialog);

EditMenuTabDialog.prototype.getContentAccessLevels = function() {
    return Object.values(ContentAccessLevel);
}

EditMenuTabDialog.prototype.onContentTypeChanged = function() {
    var thiz = this;
    if (!this.contentTypeComboManager) return;
    var item = this.contentTypeComboManager.getSelectedItem();
    var defaultName = item.name;
    this.contentDescriptionLabel.innerHTML = item.description || "";
    Dom.empty(this.extraContainer);
    var f = this[item.type];
    if (f) {
        this.relatedWiget = new f();
        this.relatedWiget.onAttached = function() {
            thiz.relatedWiget.node().setAttribute("flex", 1);
            thiz.invalidateSizing();
        }
        this.relatedWiget.into(this.extraContainer);
        if (this.relatedWiget.setValue) {
            var data = undefined;
            if (typeof(this.menuTab) == "undefined") {
                data = {url: "", target: "SameWindow", page: undefined}
            } else {
                data = { url: this.menuTab.node.externalURL, target: this.menuTab.node.urlOpenMode, page: this.menuTab.node};
            }
            console.log("Init ", data);
            this.relatedWiget.setValue(data);
        }
        Dom.addClass(this.extraContainer, "Active");
        this.relatedWiget.node().setAttribute("flex", 1);
    } else {
        Dom.removeClass(this.extraContainer, "Active");
        this.relatedWiget = null;
    }

    this.tabTitle.setAttribute("placeholder", item.name);
    var inputName = this.tabTitle.value.trim();
    if (this.title != "Edit Tab" && !this.isEnterTilte) this.tabTitle.value = defaultName;

    this.invalidateSizing();
}
EditMenuTabDialog.prototype.setup = function(options) {

    this.options = options;
    this.menuTab = options.menuTab || undefined;
    this.addingNew = typeof(this.menuTab) == "undefined";
    this.title =  this.addingNew ?
    (this.parentMenuTab ? "Add Sub-Tab" : "Add Tab") : "Edit Tab";
}
EditMenuTabDialog.prototype.onShown = function() {
    var thiz = this;

    this.tabTitle.focus();

    $cmsService.getDefaultPages((this.addingNew ? "" : (this.menuTab.node.defaultPageName || "")), function(defaultPages) {
        var contentTypes = [];
        if (defaultPages)  {
            for (var i = 0; i < defaultPages.length; i++) {
                var page = defaultPages[i];
                if (thiz.options && thiz.options.existedMenuTabs && thiz.options.existedMenuTabs.indexOf(page.name) >= 0) {
                    console.log("Reject " + page.name);
                    continue;
                }
                var contentType = {name: page.title, type: page.name, description: page.description};

                contentTypes.push(contentType);
            }
        }
        contentTypes.push({name: "Custom Page", type: EditMenuTabDialog.TYPE_CUSTOM_PAGE, description: "A custom-built page using our rich-text editor or your own HTML."});
        contentTypes.push({name: "Link", type: EditMenuTabDialog.TYPE_LINK, description: "This tab will link to a URL that you specify."});
        console.log("is Adding news: ", thiz.addingNew);
        if (thiz.addingNew) {
            thiz.contentTypeComboManager.setItems(contentTypes);
            thiz.initInfo();
        } else {
            $cmsService.getMenuItemInfo(thiz.menuTab.node.id, function(menuTab) {
                thiz.menuTab = menuTab;
                var isHomeMenu = thiz.menuTab.node.defaultPageName == "home";
                if (isHomeMenu) {
                    var extras = [];
                    extras.push({name: "Home", type: "home", description: "Default team's home page."});
                    contentTypes = extras.concat(extras);
                }
                thiz.contentTypeComboManager.setItems(contentTypes);
                thiz.contentTypeComboManager.setEnable(!isHomeMenu);
                thiz.initInfo();
            }, function(error){}, thiz);
        }

    }, function() {

    }, this);
}
EditMenuTabDialog.TYPE_CUSTOM_PAGE = "@system:custom-page";
EditMenuTabDialog.TYPE_LINK = "@system:link";

EditMenuTabDialog.prototype.initInfo = function() {
    if (this.addingNew) {
        this.draftCheckBox.checked = false;
        return;
    }
    var page = this.menuTab.node;
    if (this.menuTab.url) {
        this.setLinkClipboard(this.menuTab.url);
    }

    this.tabTitle.value = page.title;
    this.draftCheckBox.checked = page.draft;
    this.isNavItemCheckBox.checked = page.navigationItem;

    var type = page.defaultPageName;

    if (page.contentPageId || page.defaultPageName == "@system:custom-page") {
        type = EditMenuTabDialog.TYPE_CUSTOM_PAGE;
    } else if (page.externalURL) {
        type = EditMenuTabDialog.TYPE_LINK;
    }

    this.contentTypeComboManager.selectItemIfContains({
        type:  type
    });

    this.adminLevelCombo.selectItemIfContains({
        code: typeof(page.contentAccessLevel) != "undefined" ? ContentAccessLevel[page.contentAccessLevel].code : ContentAccessLevel.Public.code
    });

    if (!this.menuTab.draftable) {
        Dom.empty(this.draftBox);
        this.optionsBox.parentNode.removeChild(this.optionsBox);

    }
}
EditMenuTabDialog.prototype.onHide = function() {
    /*document.body.removeChild(this.contentTypeComboManager.popup.popupContainer);
    document.body.removeChild(this.adminLevelCombo.popup.popupContainer);*/
}
EditMenuTabDialog.prototype.getDialogActions = function() {
    return [
        {
            type: "accept", title: "Save",
            run: function () { this.save(); return false; }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
}
EditMenuTabDialog.prototype.save = function() {
    var thiz = this;
    if (!ValidationManager.run(this.validationRules)) return;
    $cmsService.validateTabName(this.getValue(),function() {
        if (thiz.relatedWiget && thiz.relatedWiget.confirmClosing) {
            thiz.relatedWiget.confirmClosing(function () {
                thiz.close(thiz.getValue());
            });
        } else {
            thiz.close(thiz.getValue());
        }
    }, function (e) {
        Dialog.error(e.message);
    });
}


EditMenuTabDialog.prototype.getValue = function() {
    var page = {};
    if (this.menuTab) {
        page.id = this.menuTab.node.id;
    }
    page.title = this.tabTitle.value;
    var pageType = this.contentTypeComboManager.getSelectedItem();
    page.draft = this.draftCheckBox && this.draftCheckBox.checked;
    page.navigationItem = this.isNavItemCheckBox && this.isNavItemCheckBox.checked;
    page.contentAccessLevel = this.adminLevelCombo.getSelectedItem() ? this.adminLevelCombo.getSelectedItem().type : ContentAccessLevel.Public.type;
    if (pageType.type != EditMenuTabDialog.TYPE_CUSTOM_PAGE && pageType.type != EditMenuTabDialog.TYPE_LINK) {
        page.description = pageType.description;
        page.defaultPageName = pageType.type;
    } else {
        var data = this.relatedWiget ? this.relatedWiget.getValue() : null;
        if (data) {
            if (data.page && data.page.id) {
                page.contentPageId = data.page.id;
            } else if (data.url) {
                page.externalURL = data.url;
                page.urlOpenMode = data.target;
            }
        } else {
            //TODO: show error
        }
    }

    if (this.parentMenuTab) {
        page.parentPageId = this.parentMenuTab.node.id;
    }
    console.log(page);
    return page;
}

EditMenuTabDialog.prototype.setLinkClipboard = function(path) {
    var url;
    var URL_REGEX = new RegExp("^(http|https)://", "i");
    if (URL_REGEX.test(path)) {
        url = path;
    } else {
        url = window.location.origin + path;
    }
    this.pageLink.innerHTML = url;
    this.pageLink.href = url;
    this.url = url;
    Dom.removeClass(this.linkBox, "Disabled");
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/EditMetaDialog.js";

function EditMetaDialog() {
    ModificationWatchDialog.call(this);

    this.bind("click", function() {
        InfoTip.show(this.metaTitleHelpInfo,
             "This is what search engines will display as the title of the page. Make sure it is a concise and accurate summary of the content of the page. We recommend that it is less than 60 characters, but it can be longer.",
             false, null, "tooltip", "right-inside",
             -(Dom.getOffsetWidth(this.metaTitleHelpInfo)/2 + 7));
    }, this.metaTitleHelpInfo);

    this.bind("click", function() {
        InfoTip.show(this.metaDesHelpInfo,
             "Search engines will typically display this as the description of your page. It should clearly describe the content of the page so searchers can easily find what they are looking for and click onto your page. We recommend descriptions be about 120-155 characters long.",
             false, null, "tooltip", "right-inside",
             -(Dom.getOffsetWidth(this.metaDesHelpInfo)/2 + 7));
    }, this.metaDesHelpInfo);
    var validateInput = function(event) {
        var input = event.target;
        this.validate(input);
    }
    this.bind("input", validateInput.bind(this), this.metaTitle);
    this.bind("input", validateInput.bind(this), this.metaDescription);

}
__extend(ModificationWatchDialog, EditMetaDialog);

EditMetaDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};
EditMetaDialog.prototype.validate = function(input) {
    var indicator = this[Dom.getAttributeAsString(input, "indicator")];
    var warningValue = Dom.getAttributeAsInt(input, "warning-value", 0);
    indicator.innerHTML = input.value.length;
    if (input.value.length > warningValue) {
        if (!Dom.hasClass(indicator, "Warning")) Dom.addClass(indicator, "Warning");
    } else if (Dom.hasClass(indicator, "Warning")) Dom.removeClass(indicator, "Warning");
}
EditMetaDialog.prototype.setup = function(options) {
    this.page = options.page || {};
    this.title = "Edit \"" + this.page.title + "\" Meta Information";
    this.metaTitle.value = this.page.metaTitle || "";
    this.metaDescription.value = this.page.metaDescription || "";
    this.setSnapshotInputValues({title: this.page.metaTitle || "", description: this.page.metaDescription || ""});
    this.validate(this.metaTitle);
    this.validate(this.metaDescription);
}

EditMetaDialog.prototype.getCurrentInputValues = function() {
    var obj = {title: this.metaTitle.value, description: this.metaDescription.value};
    return obj;
}
EditMetaDialog.prototype.save = function(callback) {
    this.close(this.getCurrentInputValues());
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/FlexSizingPolicy.js";

function FlexSizingPolicy() {
    Dialog.call(this);

    this.title = "Size Settings";
    
    this.unitSelector.renderer = function (unit) {
        return unit.name;
    };
    this.unitSelector.comparer = Util.sameId;
    this.unitSelector.setItems(FlexSizingPolicy.UNITS);

    this.flexSelector.comparer = Util.sameRelax;
    var flexes = [];
    for (var i = 1; i <= FlexSizingPolicy.MAX_FLEX; i ++) flexes.push(i);
    this.flexSelector.setItems(flexes);
    
    this.validationRules = new RuleSet()
        .live()
        .required(this.widthValue, "Please specify the size value.", Condition.checked(this.sizeRadio));

    this.bind("change", this.invalidateStatus, this.fitRadio);
    this.bind("change", this.invalidateStatus, this.flexRadio);
    this.bind("change", this.invalidateStatus, this.sizeRadio);
}
__extend(Dialog, FlexSizingPolicy);

FlexSizingPolicy.MAX_FLEX = 6;

FlexSizingPolicy.prototype.invalidateStatus = function () {
    Dom.setEnabled(this.flexRadio.checked, this.flexWeightLabel, this.flexSelector.node());
    Dom.setEnabled(this.sizeRadio.checked, this.fixedSizeLabel, this.widthValue, this.unitSelector.node());
};
FlexSizingPolicy.prototype.setup = function (sizing) {
    this.fitRadio.checked = (!sizing.flex || isNaN(sizing.flex) || sizing.flex < -1 || sizing.flex > FlexSizingPolicy.MAX_FLEX);

    this.flexRadio.checked = !isNaN(sizing.flex) && sizing.flex >= 1 && sizing.flex <= FlexSizingPolicy.MAX_FLEX;
    if (this.flexRadio.checked) this.flexSelector.selectItem(sizing.flex);

    this.sizeRadio.checked = sizing.flex === -1;
    this.widthValue.value = sizing.size || "";
    if (sizing.sizeUnit) this.unitSelector.selectItemByKey("id", sizing.sizeUnit || "px");
    
    this.invalidateStatus();
};
FlexSizingPolicy.UNITS = [
    {id: "px", name: "Pixels"},
    {id: "%", name: "%"},
    {id: "ex", name: "Characters"}
];
FlexSizingPolicy.prototype.getDialogActions = function () {
    return [
        {
            type: "accept", title: "Update Size",
            run: function () { this.onAccept(); return false; }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};
FlexSizingPolicy.prototype.onAccept = function () {
    if (!ValidationManager.run(this.validationRules)) return;
    
    var sizing = {
        flex: this.fitRadio.checked ? 0 : (this.sizeRadio.checked ? -1 : this.flexSelector.getSelectedItem()),
        size: this.widthValue.valueAsNumber,
        sizeUnit: this.unitSelector.getSelectedItem().id
    };
    
    this.close(sizing);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/GeneralSettingDialog.js";

function GeneralSettingDialog() {
    this.grabHeight = true;
    ModificationWatchDialog.call(this);

    this.title = "Website General Settings";

    this.bind("e:TabChange", function () {
        if (this.mainTab.getActiveTabPane() == this.cssTab && !this.cssCodeEditor) {
            this.cssCodeEditor = CodeMirror.fromTextArea(this.customCSSInput, {
                lineNumbers: true,
                mode: "css",
                extraKeys: {"Ctrl-Space": "autocomplete"},
                indentUnit: 4
            });
        }
        if (this.mainTab.getActiveTabPane() == this.jsTab && !this.jsCodeEditor) {
            this.jsCodeEditor = CodeMirror.fromTextArea(this.customJSInput, {
                lineNumbers: true,
                mode: { name: "javascript", globalVars: true },
                extraKeys: {"Ctrl-Space": "autocomplete"},
                indentUnit: 4
            });
        }
    }, this.mainTab.node());


    this.variantSelector.renderer = function (variant) {
        return Dom.newDOMElement({
            _name: "span",
            "class": "GeneralSetting_VariantDisplay",
            _children: [
                {_name: "span", "class": "Color", style: "background-color: " + (variant.color || "transparent")},
                {_name: "span", "class": "Name", _text: variant.displayName}
            ]
        });
    };
    this.variantSelector.comparer = function (a, b) {
        return a.name == b.name;
    }

    this.fontSizeSelector.renderer = function (value) {
        return GeneralSettingDialog.TEXT_SIZE_MAP[value];
    };
    this.fontSizeSelector.comparer = Util.sameRelax;

    this.fontSizeSelector.setItems(GeneralSettingDialog.TEXT_SIZES);

    this.websiteFaviconUploadView.dataType = "site-settings";
    this.websiteFaviconUploadView.dataUUID = "favicon";
    this.bind("click", this.handleTemplateItemClick, this.templateSuiteList);

    this.mobileNavTextColorPicker.setInfoWhenDefaultColorSelected("Template text color will be used");
    this.mobileNavTextColorPicker.setDefaultColor("#FFFFFF00");
    var thiz = this;

    this.bind("click", function(){
        new CMSHiddenPageMigrationDialog().callback(function(updated) {
            if (updated) {
                Dom.emitEvent(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, window.currentWebDesignFeature.node());
                thiz.close();
            }
        }).open();
    }, this.hiddenPageMigrationButton);

    this.mainTab._activateTab = this.mainTab.activateTab;
    this.mainTab.activateTab = function (header) {
        if (header._contentNode == thiz.cssTab || header._contentNode == thiz.jsTab) {
            if (!ADMIN_CONTEXT.customJsAllowed && !ADMIN_CONTEXT.customCssAllowed && !AdminConsole.instance.isTUAdmin())  {
                return;
            }
        }
        if (header._contentNode == thiz.adminControlTab) {
            if (!AdminConsole.instance.isTUAdmin()) {
                return;
            }
        }
        if (header._contentNode == thiz.siteFooterTab && !thiz.siteFooterAllowed) {
            return;
        }
        this._activateTab(header);
    };

    if (AdminConsole.instance.isTUAdmin() || ADMIN_CONTEXT.customCssAllowed || ADMIN_CONTEXT.customJsAllowed) {
        if (AdminConsole.instance.isTUAdmin()) {
            Dom.addClass(this.mainTab.node(), "IsTUAdmin");
        }
        if (ADMIN_CONTEXT.customJsAllowed || AdminConsole.instance.isTUAdmin()) {
            Dom.addClass(this.mainTab.node(), "CustomJSAllowed");
        }
        if (ADMIN_CONTEXT.customCssAllowed || AdminConsole.instance.isTUAdmin()) {
            Dom.addClass(this.mainTab.node(), "CustomCSSAllowed");
        }
    }

}
__extend(ModificationWatchDialog, GeneralSettingDialog);
GeneralSettingDialog.prototype.onShown = function() {
    $cmsService.isSiteFooterSettingEnabled(function(enabled) {
        Dom.toggleClass(this.mainTab.node(), "SiteFooterAllowed", enabled);
        this.siteFooterAllowed = enabled;
    }.bind(this));
}
GeneralSettingDialog.prototype.asyncSetup = function(data, callback) {
    $templateAdminService.getMyTeamTemplateSuiteUsage(function (usage) {
        this.usage = usage;
        this.currentTemplateSuiteId = usage.templateSuiteId;

        this.customCSSInput.value = usage.customCSS || "";
        this.customJSInput.value = usage.customJS || "";
        //this.gaAccountId.value = usage.googleAnalyticsId || "";
        this.siteFooterView.setGoogleAnalytics(usage || {});

        this.templateSuiteMap = {};


        $templateAdminService.findPopulatedTemplateSuitesForMyTeam("", 0, 1000, Order.asc("name"), function (templates) {
            var list = [];
            var current = null;

            templates.result.forEach(function (template) {
                if (template.id == this.usage.templateSuiteId) {
                    current = template;
                } else {
                    list.push(template);
                }

                this.templateSuiteMap[template.id] = template;
            }.bind(this));

            if (current) {
                list.unshift(current);
            }

            list.forEach(function (template) {
                var itemView = new AdminTemplateItemView().into(this.templateSuiteList);
                itemView.setTemplate(template);

                if (template.id == this.usage.templateSuiteId) {
                    Dom.addClass(itemView.node(), "CurrentTemplateSuite");
                }

                var useButton = Dom.newDOMElement({
                    _name: "vbox",
                    "class": "UseButtonContainer",
                    _children: [
                        {
                            _name: "button",
                            "class": "UseButton",
                            _text: "Use this template",
                            role: "secondary"
                        },
                        {
                            _name: "a",
                            "class": "PreviewLink",
                            _text: "Preview",
                            target: "_blank",
                            href: template.calculatedPreviewPath.replace(/\.jpg$/, "-full.jpg")
                        }
                    ]
                });
                itemView.node().appendChild(useButton);

                itemView.node().setAttribute("tabindex", "0");

            }.bind(this));
            for (var i = 0; i < 10; i ++) {
                this.templateSuiteList.appendChild(Dom.newDOMElement({
                    _name: "div",
                    "class": "Fake"
                }));
            }

            this.updateVariantList();
            this.variantSelector.selectItemByKey("name", this.usage.variantName || "");

            this.bind("p:LearnMoreClicked", function () {
                this.close();
            }, this.siteFooterView.node());

            $cmsService.getCustomFooterSettings(function(settings) {
                this.siteFooterView.setFooterSettings(settings);
                this.setSnapshotInputValues(this.getCurrentInputValues());
                if (callback) callback();
            }.bind(this));


        }.bind(this), function(e) {}, AdminConsole.instance);

        this.fontSizeSelector.selectItem(this.usage.stylingParameterMap["fontSize"] || "default");
        this.websiteFaviconUploadView.setCommaSeparatedStoragePaths(this.usage.stylingParameterMap["faviconPath"] || "");
        this.backgroundStyleEditor.initFromValue(this.usage.stylingParameterMap);
        this.mobileNavBackgroundStyleEditor.initFromValue(this.usage.stylingParameterMap);
        this.mobileNavShowTeamNameCheckbox.checked = this.usage.stylingParameterMap.mobilenav_showTeamName ? true : false;
        this.mobileNavShowTeamLogoCheckbox.checked = this.usage.stylingParameterMap.mobilenav_showTeamLogo == "" ? false : true;
        this.mobileNavTextColorPicker.setRGBAHexColorString(this.usage.stylingParameterMap.mobilenav_textColor || "#FFFFFF00");
    }.bind(this), function(e) {}, AdminConsole.instance);
}

GeneralSettingDialog.TEXT_SIZE_MAP = {
    default: "Default",
    smaller: "Smaller",
    small: "Small",
    medium: "Medium",
    large: "Large",
    larger: "Larger"
};
GeneralSettingDialog.TEXT_SIZES = [
    "default", "smaller", "small", "medium", "large", "larger"
];

GeneralSettingDialog.prototype.getDialogTitle = function() {
    return "General Settings";
};

GeneralSettingDialog.prototype.updateVariantList = function() {
    var templateSuite = this.templateSuiteMap[this.currentTemplateSuiteId];
    var variants = templateSuite && templateSuite.variants ? templateSuite.variants : [];
    this.variantSelector.setItems(variants);
};

GeneralSettingDialog.prototype.getChangeEventNames = function () {
    var event_names = [].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES).concat(["keyup", FileUploadView.FILE_CHANGE_EVENT_NAME]);
    return event_names;
};

GeneralSettingDialog.prototype.getCurrentInputValues = function() {
    var styling = {
        fontSize: this.fontSizeSelector.getSelectedItem(),
        faviconPath: this.websiteFaviconUploadView.getCommaSeparatedStoragePaths(),
        mobilenav_showTeamName: this.mobileNavShowTeamNameCheckbox.checked ? "true" : "",
        mobilenav_showTeamLogo: this.mobileNavShowTeamLogoCheckbox.checked ? "true" : "",
        mobilenav_textColor: this.mobileNavTextColorPicker.getRGBAHexColorString()
    };
    this.backgroundStyleEditor.saveToValue(styling);
    this.mobileNavBackgroundStyleEditor.saveToValue(styling);
    if (this.cssCodeEditor) this.cssCodeEditor.save();
    if (this.jsCodeEditor) this.jsCodeEditor.save();
    var inputValues = {
        templateSuiteId: this.currentTemplateSuiteId,
        variantName: this.variantSelector.getSelectedItem() ? this.variantSelector.getSelectedItem().name : "",
        stylingParameterMap: styling,
        customCSS: this.customCSSInput.value,
        customJS: this.customJSInput.value,
        googleAnalyticsType: this.siteFooterView.getGoogleAnalyticsType(),
        googleAnalyticsId: this.siteFooterView.getGoogleAnalyticsId(),
        googleContainerId: this.siteFooterView.getGoogleContainerId(),
        cookieYes: this.siteFooterView.getCookieYes(),
        // cleanSetup: false
        privacyUrl: this.siteFooterView.getPrivacyUrl().trim() || "",
        termsUrl: this.siteFooterView.getTermsUrl().trim() || "",
    };
    return inputValues;
}

GeneralSettingDialog.prototype.save = function(callback) {

    if (this.siteFooterAllowed && !this.siteFooterView.isValid()) {
        if (this.mainTab.getActiveTabPane() != this.siteFooterTab) {
            Dialog.error("", "Please enter a valid URL.", function(){
                    var tabs = this.mainTab.getTabs();
                    tabs.forEach(function(tab) {
                        if (tab.contentNode == this.siteFooterTab) {
                            this.mainTab.activateTab(tab.header);
                        }
                    }.bind(this));
            }.bind(this), "Close");
        }
        return;
    }
    var runner = function (clean) {
        var values = this.getCurrentInputValues();
        
        var thiz = this;
        var applyTemplate = function() {
            if(values.googleAnalyticsType == thiz.siteFooterView.noGA.value) {
                values.googleAnalyticsId = "";
            } else if(values.googleAnalyticsType == thiz.siteFooterView.googleTagManagerId.value) {
                values.googleAnalyticsId = values.googleContainerId;
            }
            delete values.googleAnalyticsType;
            delete values.googleContainerId;
            $templateAdminService.applyMyTeamTemplateSuite(values, clean, function () {
                Dom.emitEvent(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, window.currentWebDesignFeature.node());
                callback();
            }, function(error) {
                console.log("Fail to apply template suite.", error);
            }, thiz);
        }

        if (this.siteFooterAllowed) {
            if(!this.siteFooterView.customPrivacy.checked) {
                values.privacyUrl = "";
            }
            if(!this.siteFooterView.customTerms.checked) {
                values.termsUrl = "";
            }
            $cmsService.updateCustomFooterUrls(values.privacyUrl, values.termsUrl, function(){
                applyTemplate();
            }, function(e) {
                Dialog.error("", "Can not update URL.", function(){
                }, "Close");
            });
        } else {
            applyTemplate();
        }

    }.bind(this);

    if (this.currentTemplateSuiteId != this.usage.templateSuiteId) {
        Dialog.select([true, false], function (items) {
            runner(items[0]);
        }, [false], {
            exclusive: true,
            title: "Changing template",
            message: "You are going to apply a new design template. Component layout and settings in the new template may be different to your current configuration.\nDo you want to:",
            formatter: function (clean) {
                if (clean) return "Startover and use new template layout/settings";
                return "Attempt to migrate current component layout and settings to new template";
            },
            selectActionTitle: "Apply new template"
        });
    } else {
        runner(false);
    }
};
GeneralSettingDialog.prototype.handleTemplateItemClick = function (event) {
    var button = Dom.findParentWithClass(event.target, "UseButton");
    if (button) {
        this.handleTemplateItemSelected(event);
        return;
    }

    var link = Dom.findParentWithClass(event.target, "PreviewLink");
    if (link) {
        Dom.cancelEvent(event);
        this.handleTemplatePreviewClicked(link.href);
        return;
    }

    var templateView = BaseWidget.findUpward(event.target, AdminTemplateItemView);
    if (!templateView) return;

    for (var i = 0; i < this.templateSuiteList.childNodes.length; i ++) {
        var node = this.templateSuiteList.childNodes[i];
        Dom.toggleClass(node, "Focused", node == templateView.node());
    }
};
GeneralSettingDialog.prototype.handleTemplatePreviewClicked = function (link) {
    this.mediaPreviewer.items = [{src: link}];
    this.mediaPreviewer.setIndicator(this);
    this.mediaPreviewer.startSlideShowAt(0);
};
GeneralSettingDialog.prototype.handleTemplateItemSelected = function (event) {
    var templateView = BaseWidget.findUpward(event.target, AdminTemplateItemView);
    if (!templateView) return;

    this.currentTemplateSuiteId = templateView.template.id;

    for (var i = 0; i < this.templateSuiteList.childNodes.length; i ++) {
        var node = this.templateSuiteList.childNodes[i];
        var tv = BaseWidget.findUpward(node, AdminTemplateItemView);
        if (!tv) continue;

        var on = tv.template && tv.template.id == this.currentTemplateSuiteId;
        console.log(on);
        Dom.toggleClass(tv.node(), "CurrentTemplateSuite", on);
    }

    this.updateVariantList();
    this.emitChangeEvent();

};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/GenericComponentDetailDialog.js";

function GenericComponentDetailDialog() {
    ModificationWatchDialog.call(this);
    this.hasDesignChangeEvent = false;
}
__extend(ComponentDetailDialog, GenericComponentDetailDialog);


GenericComponentDetailDialog.prototype.getDialogTitle = function () {
    return CMSCommon.getString(this.componentInfo.componentType, this.componentInfo.componentName) + " Settings";
};
GenericComponentDetailDialog.prototype.asyncSetup = function (data, callback) {
    this.componentInfo = data;
    console.log(this.componentInfo);
    this.title = this.getDialogTitle();
    
    this.loadSettings(this.componentDetailContent);
    callback();
};

GenericComponentDetailDialog.prototype.save = function (callback) {
    this.saveSettings(callback);
};

if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/GenericContentSetting.js";

function GenericContentSetting() {
    ComponentDetailDialog.call(this);

    this.validationRules = new RuleSet()
                    .live(true)
                    .required(this.contentEditor, "Please enter the content.");

    this.titleColorInput.setInfoWhenDefaultColorSelected("Default template's color will be used");
    this.titleColorInput.setDefaultColor("#FFFFFF00");
}
__extend(ComponentDetailDialog, GenericContentSetting);

GenericContentSetting.prototype.getDialogTitle = function () {
    return (this.item && this.item.id ? "Edit" : "Add") + " Generic Content";
};

GenericContentSetting.prototype.onReady = function () {
    var id = this.settings["contentId"];
    if (id) {
        var that = this;
        $icms.getGenericContent(id, function(data){
            that.render(data);

            if (data && data.id) {
                that.title = that.getDialogTitle();
                that.invalidateElements();
            }
        },function(e){}, this);
    } else {
        this.render();
    }
};
GenericContentSetting.prototype.render = function (data) {
    this.item = data || {};
    this.item.headingTitle = this.item.headingTitle || "";
    this.item.content = this.item.content || "";
    this.item.contentCSS = this.item.contentCSS || "";

    this.titleInput.value = this.item.headingTitle;
    this.titleColorInput.setRGBAHexColorString(this.item.headingTitleColor || "#FFFFFF00");
    this.contentEditor.setContent({ html: this.item.content, css: this.item.contentCSS });

    this.setSnapshotInputValues(this.item);
    this.invalidateSizing();
};

GenericContentSetting.prototype.save = function (callback) {
    if (!ValidationManager.run(this.validationRules)) return;

    var thiz = this;
    this.item = this.getCurrentInputValues();

    $cmsService.getInvalidHtmlTags(this.item.content, function(tags) {
        if (tags) {
            var warningDialog = new HTMLWarningDialog(tags).callback(function (rs) {
                if (rs) {
                    thiz.saveItem(callback);
                }
            });
            warningDialog.open();
        } else {
            thiz.saveItem(callback);
        }
    }, this);
}

GenericContentSetting.prototype.saveItem = function (callback) {
    var that = this;
    $icms.saveGenericContent(this.item, function (result) {
        if (!that.item.id && result && result.id) {
            that.settings["contentId"] = result.id;
            $cmsService.saveSettings(
                that.componentInfo.componentId, that.componentInfo.componentType, that.settings,
                function() {}, function() {}
            );
        }
        callback();
        that.signalDesignChanged();
    }, function(error) {
        SnackBar.show("Failed to update Generic Content");
    }, this);
}

GenericContentSetting.prototype.getChangeEventNames = function () {
    return [RichTextEditor.TEXT_CHANGE_EVENT_NAME].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES);
};

GenericContentSetting.prototype.getCurrentInputValues = function() {
    var model = JSON.parse(JSON.stringify(this.item));
    model.headingTitle = this.titleInput.value,
    model.headingTitleColor = this.titleColorInput.getRGBAHexColorString();
    model.content = this.contentEditor.getContent();
    model.contentCSS = this.contentEditor.getContentStylesheet();

    return model;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/GenericPhotoSetting.js";

function GenericPhotoSetting() {
    ComponentDetailDialog.call(this);

    var thiz = this;

    this.photoFileUploadView.dataUUID = "default";
    this.photoFileUploadView.dataType = "generic-photo";

    this.validationRules = new RuleSet()
                            .live(true)
                            .custom(new RequiredRule(this.photoFileUploadView, "Please upload the photo"))
                            .custom(new PatternMatchedRule(this.pageChooser, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid URL! Please check your input."), function(rule) {
                                var page = rule.input.getSelectedPage();
                                if (page) return "";
                                var url = rule.input.getUrl();
                                return url && url.length > 0 ? url : "";
                            });

    this.bind("p:ImageSizeAvailable", function () {
        console.log("Imagesize: ", this.photoFileUploadView.getFirstImageSize());
    }, this.photoFileUploadView.node());
}
__extend(ComponentDetailDialog, GenericPhotoSetting);

GenericPhotoSetting.prototype.getDialogTitle = function () {
    return (this.item && this.item.id ? "Edit" : "Add") + " Generic Photo";
};

GenericPhotoSetting.prototype.onReady = function () {
    var id = this.settings["contentId"];
    if (id) {
        var that = this;
        $icms.getGenericPhoto(id, function(data){
            that.render(data);

            if (data && data.id) {
                that.title = that.getDialogTitle();
                that.invalidateElements();
            }
        },function(e){}, this);
    } else {
        this.render();
    }
};
GenericPhotoSetting.prototype.onShown = function() {
    var thiz = this;
    $configurationService.getConfigValue("cms_download_stock_images_url", function(config) {
            var url = config ? config.stringValue : "";
            Dom.toggleClass(thiz.downloadStockImagesLink, "Active", url && url.length > 0 ? true : false);
            thiz.downloadStockImagesLink.href = url;
    });

}
GenericPhotoSetting.prototype.render = function (data) {
    this.item = data || {};
    this.item.photoPath = this.item.photoPath || "";
    this.item.altText = this.item.altText || "";
    this.item.url = this.item.url || "";
    this.item.linkedPage = this.item.linkedPage || { id: 0 };
    this.item.targetMode = this.item.targetMode || "SameWindow";
    var os = this.photoFileUploadView.getFirstImageSize();
    var settings = this.settings;
    settings.alternateText = this.item.altText;
    this.sizingOptions.setValue(this.photoFileUploadView, settings);
    this.sizingOptions.render();
    this.registerUnsavedChanges(false);
    var url = this.item.photoPath;
    if (url && url.length > 0) this.photoFileUploadView.setCommaSeparatedStoragePaths(url);

    if (this.item.linkedPage.id) {
        var selectedPage = {id : this.item.linkedPage.id, title: this.item.linkedPage.title};
        this.pageChooser.selectPage(selectedPage);
    } else if (this.item.url) {
        this.pageChooser.setUrl(this.item.url);
    }

    this.targetMode.setValueSelected(this.item.targetMode, true);
    this.setSnapshotInputValues({item: this.item, settings: settings});
    this.registerUnsavedChanges(true);
};

GenericPhotoSetting.prototype.save = function (callback) {
    if (!ValidationManager.run(this.validationRules)) return;

    var that = this;
    var data = this.getCurrentInputValues();
    this.item = data.item;
    $icms.saveGenericPhoto(this.item, function (result) {
        that.settings["contentId"] = result.id;
        $cmsService.saveSettings(
            that.componentInfo.componentId, that.componentInfo.componentType, that.settings,
            function() {}, function() {}
        );
        callback();
        that.signalDesignChanged();
    }, function(error) {
        SnackBar.show("Failed to update Generic Photo");
    }, this);
}

GenericPhotoSetting.prototype.getChangeEventNames = function () {
    return [FileUploadView.FILE_CHANGE_EVENT_NAME].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES);
};

GenericPhotoSetting.prototype.getCurrentInputValues = function() {
    var model = JSON.parse(JSON.stringify(this.item));
    model.photoPath = this.photoFileUploadView.getCommaSeparatedStoragePaths() || "";
    model.targetMode = this.targetMode.getValue();
    var selectedPage = this.pageChooser.getSelectedPage();
    if (!selectedPage) model.url = this.pageChooser.getUrl();
    model.linkedPage.id = selectedPage ? selectedPage.id : 0;
    var settings = this.sizingOptions.getValue();
    model.altText = settings.alternateText;
    return {item: model, settings: settings};
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/GoogleTranslateSetting.js";

function GoogleTranslateSetting() {
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, GoogleTranslateSetting);

GoogleTranslateSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);
    this.propertiesWidget.onRenderEditorFinished = function () {
        PropertiesWidget.prototype.onRenderEditorFinished.call(this);
        var modeEditor =  this._editorsMap["displayMode"]._editorsMap["mode"];
        console.log("Mode" , modeEditor);
        if (modeEditor) {
            var input = modeEditor.selectionInput;
            var newNode = Dom.newDOMElement({
                _name: "span",
                class: "AutomaticInfo",
                _text: "The translation banner will automatically be displayed when the default browser language of the visitor is different from the language of your page. No dropdown will be displayed."
            });
            input.appendChild(newNode);
        }
    }
    this.setSnapshotInputValues(this.settings);
};

GoogleTranslateSetting.prototype.getDialogTitle = function() {
    return "Google Translate Setting";
}
GoogleTranslateSetting.prototype.save = function(callback) {
    this.saveSettings(callback);
};
GoogleTranslateSetting.prototype.getCurrentInputValues = function(callback) {
    return this.propertiesWidget.getValue();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/HTMLWarningDialog.js";

function HTMLWarningDialog(tags) {
    Dialog.call(this);
    this.title = "HTML Warning";

    var usedTags = "";
    for (var tag in tags) {
        if (usedTags) {
            usedTags += ", ";
        }
        usedTags += tag;
        var attrs  = tags[tag];
        if (attrs.length) {
            var attrStr = "";
            attrs.forEach(function (attr) {
                if (attrStr) {
                    attrStr += ", ";
                }
                attrStr += attr;
            });

            usedTags += "(" + attrStr  + ")";
        }

    }
    this.message.innerHTML = this.message.innerHTML.replace("{usedTagList}", usedTags);
};
__extend(Dialog, HTMLWarningDialog);


HTMLWarningDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { this.close(false); return false; }
        },
        {
            type: "accept", title: "Continue",
            run: function () { this.save(); return false; }
        }
    ]
};

HTMLWarningDialog.prototype.save = function () {
    this.close(true);
    return;
};

HTMLWarningDialog.invalidateHtml = function (html, callback) {
    $cmsService.getInvalidHtmlTags(html, function(tags) {
        if (tags) {
            var warningDialog = new HTMLWarningDialog(tags).callback(function (rs) {
                if (rs) {
                    if (callback) callback();
                }
            });
            warningDialog.open();
        } else {
            if (callback) callback();
        }
    }, new Spinner("Loading..."));
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/IconChooserWidget.js";

function IconChooserWidget() {
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.iconPopup.shouldCloseOnBlur = function(event) {
        var found = Dom.findUpward(event.target, function (node) {
            return node == thiz.iconInputButton;
        });
        return !found;
    };
    this.bind("click", function() {
        this.term.value = "";
        this.iconPopup.hide();
        this.setIcon("_blank_icon");
    }.bind(this), this.resetIcon);


    this.bind("click", function() {
        if (this.iconPopup.isVisible()) {
            this.iconPopup.hide();
            return;
        }
        this.iconPopup.show(this.node(), "left-inside", "bottom", 0, 5, "autoFlip");
    }, this.iconInputButton);

    this.bind("p:PopupShown", function() {
        thiz.iconListView.reload(thiz.term.value.trim());
        thiz.term.focus();
        if (this.iconType == IconChooserWidget.TYPE_CUSTOM_ICON) {
            this.photoFileUploadView.setCommaSeparatedStoragePaths(this._icon);
        }
    }, this.iconPopup);

    this.bind("click", function(event) {
        var node = Dom.findUpwardForNodeWithData(event.target, "_data");
        if (!node) return;
        var name = node._data.name || "_blank_icon"
        thiz.setIcon(name);
        thiz.iconPopup.hide();
    }, this.iconListView);
    this.iconPopup.setPopupClass("CMSIconPickerPopup");

    this.bind("input", function(event){
        Dom.cancelEvent(event);
        if (thiz.task) {
            window.clearTimeout(thiz.task);
        }
        thiz.task = window.setTimeout(function() {
            thiz.iconListView.reload(thiz.term.value.trim());
            thiz.task = null;
        }, 200);
    },this.term);

    this.bind("keypress", function(event) {
        if ((event.keyCode < 37 || event.keyCode > 40) && event.charCode != DOM_VK_SPACE && event.keyCode != DOM_VK_RETURN) {
            currentFocus == null;
            return;
        }
        var currentFocus = Dom.findChild(this.iconListView.node(), {eval: function (node) {
            if (node.nodeType != Node.ELEMENT_NODE) return false;
            return (" " + node.className + " ").indexOf(" Focus ") >= 0;
        }}, true);
        if (!currentFocus) {
            currentFocus = Dom.findChild(this.iconListView.node(), {eval: function (node) {
                if (node.nodeType != Node.ELEMENT_NODE) return false;
                return Dom.hasClass(node, "IconItem");
            }}, true);
            this._focusElement(currentFocus);
            return
        } else {
            this._handleMovement(event);
        }
    }, this.term);

    this.photoFileUploadView.dataType = "command";
    this.photoFileUploadView.dataUUID = "icons";
    this.bind(FileUploadView.FILE_CHANGE_EVENT_NAME, function() {
        var thiz = this;
        var iconPath = thiz.photoFileUploadView.getCommaSeparatedStoragePaths().split(",")[0];
        if (iconPath && iconPath.length > 0) {
            this._loadUploadedFile(iconPath);
            setTimeout(function() {
                thiz.iconPopup.hide();
            }, 100);
        }
    }, this.photoFileUploadView);
}
__extend(BaseTemplatedWidget, IconChooserWidget);

IconChooserWidget.TYPE_CUSTOM_ICON = "custom_icon";
IconChooserWidget.TYPE_DEFAULT_ICON = "default_icon";

IconChooserWidget.prototype.onDetached = function() {

}

IconChooserWidget.prototype.setIcon = function(icon) {
    if (this._icon) {
        Dom.removeClass(this.iconDisplayInner, this._icon);
    }
    if (icon) {
        this._loadUploadedFile("");
        if (icon == "_blank_icon") {
            this._icon = "";
        } else {
            this._icon = icon;
        }
        Dom.addClass(this.iconDisplayInner, this._icon);
        this.setIconType(IconChooserWidget.TYPE_DEFAULT_ICON);
        this.photoFileUploadView.setCommaSeparatedStoragePaths("");
    }
    Dom.emitEvent("p:ItemSelected", this.node());
}

IconChooserWidget.prototype.getIcon = function() {
    return this._icon;
}

IconChooserWidget.prototype.setIconPath = function(iconPath) {
    this._loadUploadedFile(iconPath);
}

IconChooserWidget.prototype.getIconPath = function() {
    return this._icon;
}

IconChooserWidget.prototype._loadUploadedFile = function(iconPath) {
    Dom.removeClass(this.iconDisplayInner, this._icon);
    this._icon = iconPath;
    this.imageDisplayInner.src = iconPath;
    this.setIconType(IconChooserWidget.TYPE_CUSTOM_ICON);
    Dom.emitEvent("p:ItemSelected", this.node());
}

IconChooserWidget.prototype.getIconType = function() {
    return this.iconType;
}

IconChooserWidget.prototype.setIconType = function(type) {
    if (type == IconChooserWidget.TYPE_CUSTOM_ICON) {
        Dom.addClass(this.iconDisplay, "CustomIcon");
        this.iconType = type;
    } else {
        Dom.removeClass(this.iconDisplay, "CustomIcon");
        this.iconType = IconChooserWidget.TYPE_DEFAULT_ICON;
    }
}

IconChooserWidget.prototype._handleMovement = function(event) {
    Dom.cancelEvent(event);
    switch ( event.keyCode ) {
        case DOM_VK_LEFT:
            var nextFocus = this.currentFocus.previousSibling;
            if (nextFocus && Dom.hasClass(nextFocus, "IconItem")) this._focusElement(nextFocus);
        break;
        case DOM_VK_UP:
            var index = Dom.getIndexInParent(this.currentFocus);
            var prevParent = this.currentFocus.parentNode.previousSibling;
            if (!prevParent) return;
            var nextFocus = Dom.getChildByIndex(prevParent, index, "IconItem");
            if (nextFocus && Dom.hasClass(nextFocus, "IconItem")) this._focusElement(nextFocus);
        break;
        case DOM_VK_RIGHT:
            var nextFocus = this.currentFocus.nextSibling;
            if (nextFocus && Dom.hasClass(nextFocus, "IconItem")) this._focusElement(nextFocus);
        break;
        case DOM_VK_DOWN:
            var index = Dom.getIndexInParent(this.currentFocus);
            var nextParent = this.currentFocus.parentNode.nextSibling;
            if (!nextParent) return;
            var nextFocus = Dom.getChildByIndex(nextParent, index, "IconItem");
            if (nextFocus && Dom.hasClass(nextFocus, "IconItem")) this._focusElement(nextFocus);
        break;
        case DOM_VK_RETURN:
        case DOM_VK_SPACE:
        case 0: // charCode = 26 = DOM_VK_SPACE
            var node = Dom.findUpwardForNodeWithData(this.currentFocus, "_data");
            if (!node) return;
            this.setIcon(node._data.name);
            this.iconPopup.hide();
        break;
        default:
        break;
    }
}

IconChooserWidget.prototype._focusElement = function(element) {
    if (this.currentFocus) {
        Dom.removeClass(this.currentFocus, "Focus");
    }
    Dom.addClass(element, "Focus");
    this.currentFocus = element;
    this.displayElementOnViewZone(element);
}

IconChooserWidget.prototype.onDetached = function() {
    if (this.iconPopup && this.iconPopup.popupContainer) {
        document.body.removeChild(this.iconPopup.popupContainer);
    }
}
IconChooserWidget.prototype.displayElementOnViewZone = function(element) {
    var container = element.parentNode.parentNode.parentNode;
    var eTop = element.offsetTop;
    var eHeight = element.offsetHeight;
    var pTop = container.scrollTop;
    var pHeight = container.offsetHeight;
    if (eTop > (pTop + pHeight)) container.scrollTop = eTop + eHeight - pHeight;
    else if (eTop < pTop) container.scrollTop = eTop;
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/IconListView.js";

function IconListView() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.listView.chunkSize = 5;
    this.listView.populator = function (data, binding, node) {
        binding._node.innerHTML = "";
        for (var i = 0; i < data.length; i++) {
            var ic = data[i];
            var icon = Dom.newDOMElement(
                {   _name: "hbox",
                    class: "IconItem",
                    title: ic.name,
                    _children: [{
                        _name: "icon", "class": ic.name
                    }]
                });
            icon._data = ic;

            binding._node.appendChild(icon);
        }
        for (var i = data.length; i < thiz.COLS; i++) {
            binding._node.appendChild(binding._node.ownerDocument.createElement("span"));
        }
    };
    this.COLS = 7;
}
__extend(BaseTemplatedWidget, IconListView);
IconListView.prototype.reload = function(term) {
    var source = this.createSource(term);
    this.listView.setSource(source);
}
IconListView.prototype.createSource = function (keywords) {
    var thiz = this;
    return {
        keywords: keywords,
        loadPage: function (start, count, handler, failed) {
            var icons = this.keywords.length == 0 ? MATERIAL_ICONS : [];
            if (this.keywords.length > 0) {
                for (var i = 0; i < MATERIAL_ICONS.length; i++) {
                    var icon = MATERIAL_ICONS[i];
                    if (icon.name.toLowerCase().indexOf(this.keywords.toLowerCase())>= 0) {
                        icons.push(icon);
                    }
                }
            }
            var page =  Math.floor(icons.length / thiz.COLS) + ((icons.length % thiz.COLS) > 0 ? 1 : 0);
            var ics = thiz.toGrid(icons, start, count);
            handler(ics, page);
        }
    };
};
IconListView.prototype.toGrid = function(data, rowIndex, totalRows) {

    var icons = [];
    var s = rowIndex * this.COLS;
    for (var i = 0; i < totalRows; i++) {
        var items = data.slice(s, s + this.COLS);
        if (items.length > 0) {
            icons.push(items);
        }
        s += this.COLS;
    }
    return icons;
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/LinkListSelectionView.js";

function LinkListSelectionView() {
    CustomPageSelectionView.call(this);
}
__extend(CustomPageSelectionView, LinkListSelectionView);

LinkListSelectionView.prototype.type = function () {
    return "link";
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/LinkSelectionView.js";

function LinkSelectionView(node) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.validationRules = new RuleSet()
        .live(true)
        .custom(new GenericRule(this.urlInput, function() {
            var re = thiz.isRequired();
            if (re == "false" || !re) return true;
            return thiz.urlInput.value.trim().length > 0;
        }, "Please enter url."))
        .pattern(this.urlInput, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid URL! Please check your input.");
    
    this.setRequired(Util.getProperty(node, "required", "true") == "true");
    this.setEnableTarget(Util.getProperty(node, "use-target", "true") == "true");
    
}
__extend(BaseTemplatedWidget, LinkSelectionView);



LinkSelectionView.prototype.getValue = function() {
    var data = {
        url: this.urlInput.value,
        target: this.openPolicy.getValue()
    };
    return data;
}
LinkSelectionView.prototype.setValue = function(data) {
    this.openPolicy.setValueSelected(data.target, true);
    this.urlInput.value = data.url || "";
}
LinkSelectionView.prototype.validateInput = function() {
    return ValidationManager.run(this.validationRules);
};

LinkSelectionView.prototype.confirmClosing = function(callback) {
    if (!this.validateInput()) return;
    if (callback) {
        callback();
    }
};

LinkSelectionView.prototype.setRequired = function (required) {
    this.required = required;
    Dom.toggleClass(this.linkLabel, "RequiredFieldLabel", required);
};

LinkSelectionView.prototype.isRequired = function () {
    return this.required;
};

LinkSelectionView.prototype.setEnableTarget = function(enable) {
    this.enableTarget = enable;
    Dom.toggleClass(this.node(), "TargetEnabled", enable);
};

LinkSelectionView.prototype.isEnableTarget = function() {
    this.enableTarget;
}

if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/MainNavigatorSetting.js";

function MainNavigatorSetting() {
    ComponentDetailDialog.call(this);

    this.orderChanged = false;

    this.bind("click", function(){
        this.addMenuTab();
    }, this.addTabButton);
    var thiz = this;

    this.menuItemRepeaterView.populator = function (data, binding) {
        thiz.createMenuItem(binding._node, data);
	};
    this.bind("click", function(event) {

        var itemContainer = Dom.findUpwardForNodeWithData(event.target, "_data");
        if (!itemContainer || Dom.hasClass(event.target, "MenuCheckBox")) return;

        var data = itemContainer._data;
        var thiz = this;
        if (Dom.hasClass(event.target, "EditMetaButton")) {

            new EditMetaDialog().callback(function(meta) {
                if (!meta) return;
                thiz.saveOrder(function() {
                    $cmsService.updatePageMeta(data.node.id, meta.title, meta.description, function (result) {
                        thiz.onShown();
                        thiz.signalDesignChanged();
                    }, function(e) {
                        console.log(e);
                    }, thiz);
                }, true);

            }).open({page: data.node});

        } else if (Dom.hasClass(event.target, "DeleteButton")) {
            Dialog.confirm("Do you want to delete this menu tab?", null, "Delete", function(){
                thiz.saveOrder(function () {
                    $cmsService.deletePage(data.node.id, function (result) {
                        thiz.onShown();
                        thiz.signalDesignChanged();
                    }, function(error) {
                    }, thiz);
                }, true);
            },
            "Cancel", function() {}, null, null);

        } else if (Dom.hasClass(event.target, "EditButton")) {

            var existedDefaultPages = thiz.getExistedSystemPage();
            for (var i = existedDefaultPages.length - 1; i >= 0; i--) {
                if (existedDefaultPages[i] === data.node.defaultPageName) {
                    existedDefaultPages.splice(i, 1);
                }
            }
            new EditMenuTabDialog().callback(function(menuTab) {
                if (!menuTab) return;
                thiz.saveOrder(function () {
                    $cmsService.updatePage(menuTab, function () {
                        thiz.onShown();
                        thiz.signalDesignChanged();
                    }, function(e) {
                        if (e && "ONE_DEFAULT_PAGE_ALLOWED" == e.code) {
                            Dialog.error(e.message);
                        }
                    }, thiz);
                }, true);
            }).open({
                menuTab: data,
                existedMenuTabs: existedDefaultPages
            });

        } else if (Dom.hasClass(event.target, "AddButton")) {
            this.addMenuTab(data);
        } else if (Dom.hasClass(event.target, "PublishButton")) {

            Dialog.confirm("Do you want to set this menu tab shown on the site navigation?", null, "Show", function(){
                thiz.saveOrder(function () {
                    $cmsService.setPagesVisibility(true, [data.node.id], function (result) {
                        thiz.onShown();
                        thiz.signalDesignChanged();
                    }, function(e) {
                        if (e && "ONE_DEFAULT_PAGE_ALLOWED" == e.code) {
                            new Dialog.error(e.message);
                        }
                    }, thiz);
                }, true);
            },
            "Cancel", function() {}, null, null);
        } else if (Dom.hasClass(event.target, "CopyButton")) {
            var url;
            var URL_REGEX = new RegExp("^(http|https)://", "i");
            if (URL_REGEX.test(data.url)) {
                url = data.url;
            } else {
                url = window.location.origin + data.url;
            }
            MainNavigatorSetting.copyClipboard(url);
        } else if (Dom.hasClass(event.target, "DraftButton")) {

            Dialog.confirm("Do you want to set this menu tab hidden on the site navigation?", null, "Hide", function(){
                thiz.saveOrder(function() {
                    $cmsService.setPagesVisibility(false, [data.node.id], function (result) {
                        thiz.onShown();
                        thiz.signalDesignChanged();
                    }, function(error) {
                    }, thiz);
                }, true);
            },
            "Cancel", function() {}, null, null);

        } else if (data) {
            Dom.toggleClass(itemContainer, "Collapsed");
            this.alignToCenterWindow();
        }
    }, this.menuItemRepeaterView);

    this.bind("p:onAttached", this.setupReordering, this.menuItemRepeaterView.node());
    this.bind("change", this.selectMenuItemHandle, this.menuItemRepeaterView.node())
}
__extend(ComponentDetailDialog, MainNavigatorSetting);

MainNavigatorSetting.prototype.selectMenuItemHandle = function(event) {
    if (!Dom.hasClass(event.target, "MenuCheckBox")) return;
    this.invalidateElements();
}
MainNavigatorSetting.prototype.toNames = function(menuItems) {
    var names = "";
    for (var i = 0; i < menuItems.length; i++) {
        if (names.length > 0) names += ", ";
        names += menuItems[i].node.title;
    }
    return names;
}
MainNavigatorSetting.prototype.getDialogActions = function() {
    var thiz =  this;
    var selectedItems = [];
    Dom.doOnSelector(this.menuItemRepeaterView.node(), ":scope li.MenuItem > hbox > .MenuCheckBox", function(cb) {
        var itemContainer = Dom.findUpwardForNodeWithData(cb, "_data");
        if (cb.checked && itemContainer._data) {
            selectedItems.push(itemContainer._data);
        }
    });
    if (selectedItems.length <= 0) return ComponentDetailDialog.prototype.getDialogActions.call(this);

    var actions = ComponentDetailDialog.prototype.getDialogActions.call(this)
    var extraActions = [];
    var draftCount = 0;
    var publishCount = 0;
    var invisibleCount = 0;
    var visibleCount = 0;
    for (var i = 0; i < selectedItems.length; i++) {
        var menuItem = selectedItems[i];
        if (menuItem.draft) {
            draftCount++;
        } else {
            publishCount++;

            if (!menuItem.node.navigationItem) {
                invisibleCount++;
            } else {
                visibleCount++;
            }
        }

    }
    var suffix = "(" + selectedItems.length +  ")";
    if (draftCount > 0 && draftCount <= selectedItems.length) {
        extraActions.push({
                type: "extra" + (extraActions.length + 1), title: "Publish All " + suffix,
                run: function () {

                    Dialog.confirm("Do you want to publish all the selected menu tabs?", thiz.toNames(selectedItems), "Publish All", function(){
                        thiz.saveOrder(function () {
                            var ids = [];
                            selectedItems.forEach(function(n) {
                                ids.push(n.node.id);
                            });
                            $cmsService.markAsPublishPages(ids, function (result) {
                                thiz.onShown();
                                thiz.signalDesignChanged();
                            }, function(error) {
                            }, thiz);
                        }, true);
                    },
                    "Cancel", function() {});

                    return false; }
        });
    }
    if (publishCount > 0 &&  publishCount <= selectedItems.length) {
        extraActions.push({
                type: "extra" + (extraActions.length + 1), title: "Draft All " + suffix,
                run: function () {

                    Dialog.confirm("Do you want to set as draft all the selected menu tabs?", thiz.toNames(selectedItems), "Draft All", function(){
                        thiz.saveOrder(function () {

                            var ids = [];
                            selectedItems.forEach(function(n) {
                                ids.push(n.node.id);
                            });
                            $cmsService.saveAsDrafts(ids, function (result) {
                                thiz.onShown();
                                thiz.signalDesignChanged();
                            }, function(error) {
                            }, thiz);

                        }, true);
                    },
                    "Cancel", function() {});

                    return false; }
        });
    }
    if (invisibleCount > 0 &&  invisibleCount <= selectedItems.length) {
        extraActions.push({
                type: "extra" + (extraActions.length + 1), title: "Show All " + suffix,
                run: function () {

                    Dialog.confirm("Do you want to set all the selected menu tabs shown on the site navigation?", thiz.toNames(selectedItems), "Show All", function(){
                        thiz.saveOrder(function () {

                            var ids = [];
                            selectedItems.forEach(function(n) {
                                ids.push(n.node.id);
                            });
                            $cmsService.setPagesVisibility(true, ids, function (result) {
                                thiz.onShown();
                                thiz.signalDesignChanged();
                            }, function(error) {
                            }, thiz);

                        }, true);
                    },
                    "Cancel", function() {});

                    return false; }
        });
    }

    if (visibleCount > 0 && visibleCount <= selectedItems.length) {
        extraActions.push({
                type: "extra" + (extraActions.length + 1), title: "Hide All " + suffix,
                run: function () {

                    Dialog.confirm("Do you want to set all the selected menu tabs hidden on the site navigation?", thiz.toNames(selectedItems), "Hide All", function(){
                        thiz.saveOrder(function () {

                            var ids = [];
                            selectedItems.forEach(function(n) {
                                ids.push(n.node.id);
                            });
                            $cmsService.setPagesVisibility(false, ids, function (result) {
                                thiz.onShown();
                                thiz.signalDesignChanged();
                            }, function(error) {
                            }, thiz);

                        }, true);
                    },
                    "Cancel", function() {});

                    return false; }
        });
    }


    return actions.concat(extraActions);
}
MainNavigatorSetting.prototype.createMenuItem = function(li, item, addSubChild) {
    var actions = [];
    actions.push({
        _name: "icon",
        class: "AddButton",
        title: "Add Sub-Tab"
    });


    actions.push({
        _name: "icon",
        class: "EditButton",
        title: "Edit Tab"
    });

    if (!item.draft) {
        actions.push({
            _name: "icon",
            class: "CopyButton",
            title: "Copy Link"
        });
    }

    actions.push({
        _name: "icon",
        class: "EditMetaButton",
        title: "Edit Meta"
    });

    if (item.deletable) {
        if (item.node.navigationItem) {
            actions.push({
                _name: "icon",
                class: "DraftButton",
                title: "Hide Tab"
            });
        } else {
            actions.push({
                _name: "icon",
                class:  "PublishButton",
                title: "Show Tab"
            });
        }
    }
    if (item.deletable) {
        actions.push({
            _name: "icon",
            class: "DeleteButton",
            title: "Delete Tab"
        });
    }
    var id = widget.random();
    var nodes = [
        {
            _name: "icon",
            "class": "ExpandStatus"
        }];

    nodes.push({
        _name: "input",
        _checked: false,
        type: "checkbox",
        class: "MenuCheckBox" + (item.draftable || item.deletable ? "" : " Hidden"),
        id: id
        });

    nodes = nodes.concat([
        {
            _name: "label",
            _text: item.node.title,
            class: "MenuTitle"
        },
        {
            _name: "label",
            _text: item.description,
            class: "MenuCategory",
            flex: 1
        },
        {
            _name: "hbox",
            class: "HoverEditBar ActionBox",
            _children: actions,
        },
        {
            _name: "icon",
            class: "DragButton",
            title: "Move Tab"
        }]);
    var itemContent = Dom.newDOMElement({
                _name: "hbox",
                title: item.node.title,
                _children: nodes
            });
    li.appendChild(itemContent);
    li._data = item;
    if (item.deletable && !item.generated) Dom.addClass(li, "Deletable");
    if (item.draft) Dom.addClass(li, "Draft");
    if (item.draftable && !item.generated) Dom.addClass(li, "Draftable");
    if (item.node && !item.node.navigationItem) Dom.addClass(li, "Internal");
    if (item.generated)  Dom.addClass(li, "Generated");
    Dom.addClass(li, "MenuItem");

    var hasChild = item.children && item.children.length > 0;
    if (hasChild) {
        Dom.addClass(li, "HasChild Collapsed");
        var ul = li.ownerDocument.createElement("ul");
        Dom.addClass(ul, "SubMenuItem")
        li.appendChild(ul);
        for (var i = 0; i < item.children.length; i++) {

            var liChild = ul.ownerDocument.createElement("li");
            ul.appendChild(liChild);

            this.createMenuItem(liChild, item.children[i], "doNotAllowAddChild");
        }
    }

}
MainNavigatorSetting.prototype.getDialogTitle = function() {
    return "Edit Site Navigation";
};

MainNavigatorSetting.prototype.save = function (callback) {
    var thiz = this;
    this.saveOrder(function() {
        if (callback) callback();
        thiz.signalDesignChanged();
        SnackBar.show("Website navigation structure was updated successfully.");
    });
};


MainNavigatorSetting.prototype.saveOrder = function (callback , onConfig) {
    if (!this.orderChanged)  {
        if (callback) callback();
        return;
    }

    var config = [];
    (function populateList(ul, parentId) {
        var index = 0;
        for (var i = 0; i < ul.childNodes.length; i ++) {
            var n = ul.childNodes[i];
            if (n.nodeType != Node.ELEMENT_NODE || n.localName != "li" || n._data.generated) continue;
            var id = n._data.node.id;
            config.push({
                id: id,
                order: index ++,
                parentId: parentId
            });

            var childUL = Dom.findFirstChild(n, "ul");
            if (childUL) {
                populateList(childUL, id);
            }
        }
    })(this.menuItemRepeaterView.node(), null);

    var thiz = this;
    if (onConfig) {
        Dialog.confirm("Do you want to save the order this menu ? ", null, "Save", function () {
            thiz.saveOrder(callback);
        }, "Cancel", function() {
            if (callback) callback();
            thiz.clearUnsavedNotify();
        }, null);
        return;
    }
    $cmsService.updateNavigationStructure(config, function () {
        thiz.orderChanged = false;
        if (callback) callback();
        thiz.clearUnsavedNotify();
        thiz.signalDesignChanged();
    }, thiz);

};

MainNavigatorSetting.prototype.setupReordering = function () {
    var thiz = this;

    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false, function (element) {
        var containers = [];
        for (var i = 0; i < element.childNodes.length; i ++) {
            var ul = Dom.findFirstChild(element.childNodes[i], "ul");
            if (ul) containers.push(ul);
        }
        return containers;
    }); //vertical
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target) return null;
        var hasChildren = DragAndDropManager.draggable.querySelector("ul li");
        if (hasChildren) {
            var container = target.mode == DragAndDropManager.DROP_APPEND ? target.element : target.element.parentNode;
            if (container != thiz.menuItemRepeaterView.node()) return null;
        }
        // if (target.mode == DragAndDropManager.DROP_APPEND) {
        //     target.mode = DragAndDropManager.DROP_PREV_SIBLING;
        //     target.element = this.addMoreButton;
        // }

        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
                .source(this.menuItemRepeaterView.node())
                .anchor(function (node) {
                    return Dom.hasClass(node, "DragButton");
                })
                .itemInfo(function (anchor) {
                    var node = Dom.findUpwardForNodeWithData(anchor, "_data");
                    return {
                        element: node,
                        data: node._data
                    };
                })
                .destination(this.menuItemRepeaterView.node())
                .canDrop(function (data) {
                    return true;
                }.bind(this))
                .dropAt(dropTargetFinderFunction)
                .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "NavigationItemDragFeedback"
        });

        node.style.width = DragAndDropManager.draggableSize.width + "px";
        node.style.height = DragAndDropManager.draggableSize.height + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";

        return node;
    };
    this.dnd.createDropHintNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });

        // node.style.width = DragAndDropManager.draggableSize.width + "px";
        // node.style.height = DragAndDropManager.draggableSize.height + "px";
        // node.style.backgroundColor = "rgba(255, 255, 255, 0.7)";

        return node;
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }

        Dom.addClass(draggable, "JustDropped");

        window.setTimeout(function () {
            Dom.removeClass(draggable, "JustDropped");
        }, 100);

        this.orderChanged = true;
        this.emitChangeEvent();

        // this.rebuildFileInfoList();
    }.bind(this);

    this.dnd.onAimed = function (target) {
        var hasChildren = DragAndDropManager.draggable.querySelector("ul li");
        if (hasChildren) return;

        var itemContainer = Dom.findUpwardForNodeWithData(target, "_data");
        if (!itemContainer || itemContainer == DragAndDropManager.draggable || DragAndDropManager.draggable.contains(itemContainer)) return;

        if (itemContainer.parentNode != this.menuItemRepeaterView.node()) return;

        var data = itemContainer._data;

        //aiming on a no-child item, forcibly create a child container for it
        if (!Dom.hasClass(itemContainer, "HasChild")) {
            Dom.addClass(itemContainer, "HasChild");
            var ul = Dom.newDOMElement({
                _name: "ul",
                class: "SubMenuItem"
            });
            itemContainer.appendChild(ul);
        }

        if (data) Dom.removeClass(itemContainer, "Collapsed");
    }.bind(this);
    this.dnd.onDragFinished = function (accepted) {
        var uls = thiz.menuItemRepeaterView.node().getElementsByTagName("ul");
        var removedULs = [];
        for (var i = 0; i < uls.length; i ++) {
            var ul = uls[i];
            if (!ul.querySelector("li")) {
                removedULs.push(ul);
            }
        }
        for (var i = 0; i < removedULs.length; i ++) {
            var ul = removedULs[i];
            var container = ul.parentNode;
            Dom.removeClass(container, "HasChild");
            container.removeChild(ul);
        }
        thiz.onChanged();

    };

    console.log("Setup reordering done...");
};
MainNavigatorSetting.prototype.getExistedSystemPage = function() {
    var pages = this.menuItemRepeaterView.getItems();
    var systems = [];
    for (var i = 0; i < pages.length; i++) {
        var page = pages[i];
        this.getSystemPageName(systems, page);
    }
    return systems;
}
MainNavigatorSetting.prototype.getSystemPageName = function(systems, page) {
    var name = page.node.defaultPageName;
    if (name && name.length > 0) {
        systems.push(name);
    }
    if (page.children && page.children.length > 0) {
        for (var j = 0; j < page.children.length; j++) {
            var p = page.children[j];
            this.getSystemPageName(systems, p);
        }
    }
}
MainNavigatorSetting.prototype.addMenuTab = function(parent) {
    var thiz = this;
    new EditMenuTabDialog(parent).callback(function(newMenuTab){
        if (!newMenuTab) return;
        thiz.saveOrder(function() {
            $cmsService.createNewPage(newMenuTab, function (result) {
                thiz.onShown();
                thiz.signalDesignChanged();
            }, function(e) {
                console.log(e.message);
            }, thiz);
        }, true);
    }).open({
                menuTab : null,
                existedMenuTabs: thiz.getExistedSystemPage()
            });
}
MainNavigatorSetting.prototype.onShown = function() {
    var thiz = this;
    var states = {};
    Dom.doOnChildRecursively(this.menuItemRepeaterView.node(), {
        eval: function (n) { return Dom.hasClass(n, "HasChild")}
    }, function (c) {
        var itemContainer = Dom.findUpwardForNodeWithData(c, "_data");
        if (!itemContainer) return;
        var id = itemContainer._data.node.id;
        states[id] = !Dom.hasClass(c, "Collapsed");
    });

    $cmsService.getMainNavigatorItems(function (result) {

        thiz.menuItemRepeaterView.setItems(result, function () {

            Dom.doOnChildRecursively(thiz.menuItemRepeaterView.node(), {
                eval: function (n) { return Dom.hasClass(n, "HasChild")}
            }, function (c) {
                var itemContainer = Dom.findUpwardForNodeWithData(c, "_data");
                if (!itemContainer) return;

                var id = itemContainer._data.node.id;
                var expanded = states[id];
                if (expanded) {
                    Dom.removeClass(c, "Collapsed");
                } else {
                    Dom.addClass(c, "Collapsed");
                }
            });
            thiz.onChanged();
            thiz.invalidateElements();
            thiz.invalidateSizing();
            thiz.alignToCenterWindow();
        });
    }, function(error) {
        console.log(error);
    }, this);

}

MainNavigatorSetting.prototype.onChanged = function() {
    Dom.doOnSelector(this.menuItemRepeaterView.node(), "li .AddButton", function(node) {
        Dom.removeClass(node, "Invalid");
    });
    Dom.doOnSelector(this.menuItemRepeaterView.node(), "li > ul > li .AddButton", function(node) {
        Dom.addClass(node, "Invalid");
    });
}

MainNavigatorSetting.copyClipboard = function(url, name) {
    var node = Dom.newDOMElement({
        _name: "input",
        value: url,
        position: -99999
    });
    document.body.appendChild(node);
    node.select();
    var success = document.execCommand("copy");
    document.body.removeChild(node);
    if (name) {
        SnackBar.show(success ? (name + " copied to clipboard!") : ("Copy " + name + " was unsuccessfully"), null, null, success ? null : "close-box");
        return;
    }
    SnackBar.show( success ? "URL copied to clipboard!" : "Copy URL was unsuccessfully", null, null, success ? null : "close-box");
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/MainTextSetting.js";

function MainTextSetting() {
    GenericContentSetting.call(this);
};
__extend(GenericContentSetting, MainTextSetting);

MainTextSetting.prototype.postAsyncSetup = function(callback) {
    var that = this;
    $icms.getMainText(function (data) {
        that.render(data);

        if (data && data.id) {
            that.title = that.getDialogTitle();
            that.invalidateElements();
        }

        if (callback) callback();
    }, function(error) {
        that.render();
        SnackBar.show("Failed to load Main Text");
    });
};

MainTextSetting.prototype.getDialogTitle = function() {
    return "Edit Main Text";
};

MainTextSetting.prototype.getTemplatePath = function () {
    return this.getTemplatePrefix() + "GenericContentSetting.xhtml";
};

MainTextSetting.prototype.save = function (callback) {
    if (!ValidationManager.run(this.validationRules)) return;
    var thiz = this;
    this.item = this.getCurrentInputValues();
    $cmsService.getInvalidHtmlTags(this.item.content, function(tags) {
        if (tags) {
            var warningDialog = new HTMLWarningDialog(tags).callback(function (rs) {
                if (rs) {
                    thiz.saveItem(callback);
                }
            });
            warningDialog.open();
        } else {
            thiz.saveItem(callback);
        }
    }, this);
}

MainTextSetting.prototype.saveItem = function (callback) {
    var that = this;
    $icms.saveMainText(this.item, function (result) {
        callback();
        that.signalDesignChanged();
    }, function(error) {
        SnackBar.show("Failed to update Main Text");
    }, this);
}

MainTextSetting.prototype.onReady = null;


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/NewsSetting.js";

function NewsSetting() {
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, NewsSetting);

NewsSetting.prototype.getDialogTitle = function() {
    return "News Settings";
};

NewsSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);
};

NewsSetting.prototype.save = function(callback) {
    this.saveSettings(callback);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/PageChooserWidget.js";

function PageChooserWidget(nodeDefinition) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this._cachedPages = null;

    this.bind("click", function() {

        if (thiz._cachedPages && thiz._cachedPages.length > 0) {
            thiz.showPageSelection(thiz._cachedPages);
        } else {
            var systemPageIncluded = "true" == Dom.getAttributeAsString(thiz.node(), "systemPageIncluded", "true");
            var teamLink = "true" == Dom.getAttributeAsString(thiz.node(), "teamLinkIncluded", "true");
            $cmsService.getAvailablePages({systemPage: systemPageIncluded, teamLink: teamLink}, function (result) {
                thiz._cachedPages = result;
                thiz.showPageSelection(result);
            }, function(error) {
            });
        }
    }, this.pageSelectButton);
    this.bind("input", function() {
        thiz.selectedPage = null;
    }, this.onClickLinkTo);

    if ("true" == Dom.getAttributeAsString(nodeDefinition, "required", "false")) {
        Dom.addClass(this.linkToLabel, "RequiredFieldLabel");
    }
    this.customPageCombo.popup.setPopupClass("CustomPagePopup");
    this.customPageCombo.show = function() {
        this.popup.setMinWidth(this.getMinimumWidth() * 2);
        this.popup.show(thiz.onClickLinkTo, "left-inside", "bottom", 0, 5, "autoFlip");
    }
    this.customPageCombo.renderer = function(item, forCurrentDisplay) {
        return item.name;
    };
    this.customPageCombo.comparer = function(selected, item) {
        return selected.id == item.id;
    };
    var source =  {
        getItems: function(term, callback) {
            $icms.getAllCustomPages(term, function(result){
                var pages = result.result;
                callback(pages);
            }, function(err) {
                callback([]);
            });
        },
        getSelectedItem: function() {
            return thiz._resId > 0 ? {id: thiz._resId} : undefined;
        },
        getPreviewContent: function(data) {
            console.log("Get preview data with " + data);
            if (!data) return undefined;

            var v = new ContentPagePreview();
            v.create(data);
            return v;
        }
    };
    thiz.bind("p:ItemSelected", function(ev) {
        if (!ev.fromUser) return;
        var customPage = thiz.customPageCombo.getSelectedItem();
        thiz.onSelectCustomPage(customPage);
    }, this.customPageCombo.node());

    this.customPageCombo.setSource(source);

}
__extend(BaseTemplatedWidget, PageChooserWidget);

PageChooserWidget._getSubPagesAsMenuItems = function(item, callback) {
    $cmsService.getAvailableSubPages(
        item.data.generatorModuleId, 
        item.data.moduleInternalType,
        item.data.moduleInternalId,
        function (pages) {
            var items = [];
            pages.forEach(function (page) {
                var expandable = page.generatorModuleId && page.hasSubPages;
                items.push({
                    selected: false,
                    label: page.title,
                    class: "Link" + (page.parentPageId ? (" SubPage") : ""),
                    data: page,
                    _instance: item._instance,
                    expandable: expandable,
                    getSubItemsAsync: expandable ? PageChooserWidget._getSubPagesAsMenuItems: undefined,
                    handleAction: function(){
                        item._instance.selectPage(page);
                    }});
            });
            
            callback(items);
        }
    );
};

PageChooserWidget.prototype.showPageSelection = function(pages) {
    var thiz = this;
    if (this._menu != null && this._menu.isVisible()) {
        this._menu.hide();
        return;
    }
    var menu = new Menu();
    menu.setPopupClass("TeamPagePopup");
    var customPageSelected = this.onClickLinkTo.value.indexOf("\/page\/system\/res/") >= 0;

    menu.onHide = function() {
        document.body.removeChild(this.popupContainer);
    };
    menu.shouldCloseOnBlur = function(event) {
        var found = Dom.findUpward(event.target, function (node) {
            return node == thiz.pageSelectButton;
        });
        return !found;
    };
    var customPageSeparator = false;
    var linkSeparator = false;
    var eventsRegistrationSeparator = false;

    menu.register({
        label: "Navigation Items",
        class: "SubHeader",
        isEnabled: function() {return false;},
        data: {},
        handleAction: function(){}
    });
    menu.separator();
    
    var lastModuleId = null;

    for (var i = 0; i < pages.length; i++) {
        var page = pages[i];

        if (page.draft || page.deleted) continue;

        if (!customPageSeparator && page.id == 0 && !page.generated
            && !page.parentPageId && !linkSeparator) {

            menu.register({
                label: "Custom Pages",
                class: "SubHeader",
                isEnabled: function() {return false;},
                data: {},
                handleAction: function(){}
            });
            menu.separator();

            menu.register({
                label: "Find Custom Page...",
                data: {id: "findCustomPage"},
                selected: customPageSelected,
                class: "FindCustomPage",
                handleAction: function(){
                    thiz.customPageCombo.show();
                }
            });
            customPageSeparator = true;
        }

        if (!eventsRegistrationSeparator
            && page.eventsRegistrationLink
            && page.externalURL && page.externalURL.length > 0 && page.id == 0) {
            menu.register({
                label: "Event Registrations",
                class: "SubHeader",
                isEnabled: function() {return false;},
                data: {},
                handleAction: function(){}
            });
            menu.separator();
            eventsRegistrationSeparator = true;
        }

        if (!linkSeparator  && page.externalURL && page.externalURL.length > 0 && page.id == 0) {
            menu.register({
                label: "Utility Links",
                class: "SubHeader",
                isEnabled: function() {return false;},
                data: {},
                handleAction: function(){}
            });
            menu.separator();
            linkSeparator = true;
        }
        
        if (page.generatorModuleId && page.generatorModuleId != lastModuleId) {
            menu.register({
                label: page.generatorModuleName,
                class: "SubHeader",
                isEnabled: function() {return false;},
                data: {},
                handleAction: function(){}
            });
            menu.separator();
            
            lastModuleId = page.generatorModuleId;
        } 


        var selected = !customPageSelected && ((this.selectedPage && this.selectedPage.id == page.id && page.id > 0)
            || (page.externalURL
                && page.externalURL.length > 0
                && (page.externalURL === this.onClickLinkTo.value))
            || ((!page.externalURL || page.externalURL.length == 0)
                && page.id == 0 && this.getPathOfPage(page) === this.onClickLinkTo.value));

        var clazz = page.externalURL
            && page.externalURL.length > 0 ? "Link" : (page.contentPageId ? "CustomPage" : "SystemPage");

        var expandable = page.generatorModuleId && page.hasSubPages;
        menu.register({
            selected: selected,
            label: page.title,
            class: clazz + (page.parentPageId ? (" SubPage") : ""),
            data: page,
            expandable: expandable,
            _instance: this,
            getSubItemsAsync: expandable ? PageChooserWidget._getSubPagesAsMenuItems: undefined,
        handleAction: function(){
            thiz.selectPage(this.data);
        }});
    }
    menu.setMinWidth(this.onClickLinkTo.offsetWidth);
    menu.showMenu(this.onClickLinkTo, "left-inside", "bottom", 0, 5, "autoFlip");
    this._menu = menu;

    Dom.registerEvent(this._menu.node(), "p:PopupShown", function(node){
        var nodes = Dom.findChildrenWithClass(this._menu.popupContainer, "Selected");
        var node = nodes && nodes.length > 0 ? nodes[0] : undefined;
        if (node) {
            var top = 0;
            for (var i = 0; i < this._menu.popupContainer.childNodes.length; i++) {
                var item = this._menu.popupContainer.childNodes[i];
                if (Dom.hasClass(item, "Selected")) {
                    break;
                }
                top += Dom.getOffsetHeight(item);
            }
            var nH = Dom.getOffsetHeight(node);
            var lH = Dom.getOffsetHeight(this._menu.popupContainer);
            this._menu.popupContainer.scrollTop = top - ((lH - nH)/2);
        } else {
            this._menu.popupContainer.scrollTop = 0;
        }

    }.bind(this));

}
PageChooserWidget.prototype.onSelectCustomPage = function(scp) {
    if (this._menu && this._menu.isVisible()) {
        this._menu.hide();
    }
    if (!scp) return;
    var thiz = this;

    if (scp.draft) {
        Dialog.confirm(Dom.htmlEncode(scp.name) + " Saved As Draft",
        "The page \"" + Dom.htmlEncode(scp.name) + "\" is currently marked as a draft. Proceeding will make this page visible to all users. Publish?", "Publish", function() {

            $icms.setDraftContentPage(scp.id, false, function() {
                scp.draft = false;
                thiz.onSelectCustomPage(scp);
            }, function(e){});

        }, "Cancel");
        return;
    }

    this.setUrl("/team/" + ADMIN_CONTEXT.teamAlias +"/page/system/res/" + scp.id);
}
PageChooserWidget.prototype.selectPage = function(page) {
    this.selectedPage = page;
    delete this._resId;
    if (this.selectedPage)  {
        console.log(this.selectedPage);
        if (this.selectedPage.id == 0 && this.selectedPage.externalURL && this.selectedPage.externalURL.length > 0) {
            this.onClickLinkTo.value = this.selectedPage.externalURL;
        } else {
            if (this.selectedPage.id == 0) {
                this.onClickLinkTo.value = this.getPathOfPage(this.selectedPage);
            } else {
                this.onClickLinkTo.value = this.selectedPage.title || "";
            }
        }
    } else {
        this.onClickLinkTo.value = "";
    }
    Dom.emitEvent("p:ItemSelected", this.node());
}
PageChooserWidget.prototype.getPathOfPage = function(page) {
    var parent = this.lookupParent(page.parentPageId);
    var path = (parent ? parent.defaultPageName : "") + ("/" + page.name);
    var url = "/team/" + ADMIN_CONTEXT.teamAlias +"/page/" + path;
    return url;
}
PageChooserWidget.prototype.lookupParent = function(parentPageId) {
    if (!this._cachedPages) return undefined;
    for (var i = 0; i < this._cachedPages.length; i++) {
        var p = this._cachedPages[i];
        if (p.id == parentPageId) return p;
    };
    return undefined;
}
PageChooserWidget.prototype.setUrl = function(url) {
    this.onClickLinkTo.value = url || "";
    this.selectedPage = null;
    var resId = 0;
    var cur = this.onClickLinkTo.value.trim();
    if (cur.match(/\/page\/system\/res\/([0-9]+)$/)) {
        resId = RegExp.$1;
    }
    this._resId = resId;
    Dom.emitEvent("p:ItemSelected", this.node());
}
PageChooserWidget.prototype.getSelectedPage = function() {
    return (this.selectedPage && this.selectedPage.id > 0) ? this.selectedPage : undefined;
}
PageChooserWidget.prototype.getUrl = function() {
    return this.onClickLinkTo.value.trim();
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/PowerBarSetting.js";

function PowerBarSetting() {
    var thiz = this;
    ComponentDetailDialog.call(this);
};
__extend(ComponentDetailDialog, PowerBarSetting);

PowerBarSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);
}

PowerBarSetting.prototype.getDialogTitle = function() {
    return "Edit Power Bar";
}

PowerBarSetting.prototype.save = function(callback) {
    this.saveSettings(callback);
    this.signalDesignChanged();
    this.close();
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/ReviewShowcaseSetting.js";

function ReviewShowcaseSetting () {
    this.grabHeight = true;
    this.dontStretchBody = false;
    this.orderedReviewItems = {};
    ComponentDetailDialog.call(this);
    this.bind("p:bpi_review_show_case_item_change", this.onReviewShowcaseItemChanged, this.reviewShowcaseContainer);
    this.bind("p:bpi_item_order_changed", this.onReviewItemOrderChanged, this.reviewShowcaseContainer);
}
__extend(ComponentDetailDialog, ReviewShowcaseSetting);

ReviewShowcaseSetting.prototype.render = function (callback) {
    this.loadTeamReviewShowCase();
    if (callback) callback();
};

ReviewShowcaseSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);

    this.propertiesWidget.onRenderEditorFinished = function () {
        var autoSlideNode = Dom.findChildrenWithClass(this.settingsContainer, "SchemaName_autoSlide", true);
        var slideDelayNode = Dom.findChildrenWithClass(this.settingsContainer, "SchemaName_slideDelay", true);
        if (autoSlideNode.length && slideDelayNode.length) {
            autoSlideNode[0].appendChild(slideDelayNode[0]);
        }
    }.bind(this);
};

ReviewShowcaseSetting.prototype.onReviewItemOrderChanged = function (data) {
    this.changedData = {serviceType: data.serviceType, reviewIds: data.reviewIds};
    this.orderedReviewItems[data.serviceType] = data.reviewIds;
    this.emitChangeEvent();
};

ReviewShowcaseSetting.prototype.onReviewShowcaseItemChanged = function () {
    this.hasDesignChangeEvent = true;
    this.loadTeamReviewShowCase();
};

ReviewShowcaseSetting.prototype.loadTeamReviewShowCase = function () {
    Dom.empty(this.reviewShowcaseContainer);
    $businessPublisherIntegrationService.getCMSComponentReviewShowcaseInfo(false, function (data) {
        if (!data) return;

        data.forEach(function (review) {
            var node = Dom.newDOMElement({
                _name: "vbox",
                "flex": "1"
            });
            var reviewShowcaseBoard = new this.bpiModule.ReviewShowcaseBoard();
            reviewShowcaseBoard.initWith(review.serviceType, review.reviews, null, {showReviewItemAction: true, showEmptyItemMessage: true});
            reviewShowcaseBoard.into(node);

            this.reviewShowcaseContainer.appendChild(node);
        }.bind(this));
        this.reviewShowcaseItems = data;
        this.setSnapshotInputValues(this.getCurrentInputValues());
        this.clearUnsavedNotify();
        this.invalidateSizing();
    }.bind(this), function (error) {
        Dialog.error(error.message);
    }, "Loading...");
};

ReviewShowcaseSetting.prototype.postAsyncSetup = function (callback) {
    widget.__ensureNamespaceLoaded("bpi", function (bpi) {
        this.bpiModule = bpi;
        this.render(callback);
    }.bind(this), "Loading...");
};

ReviewShowcaseSetting.prototype.getCurrentInputValues = function () {
    var ordered = {};
    this.reviewShowcaseItems.forEach(function (item) {
        if (item.reviews) {
            var ids = [];
            for (var i = 0; i < item.reviews.length; i ++) {
                ids.push(item.reviews[i].id);
            }
            ordered[item.serviceType] = ids;
        }
    });
    return ordered;
};

ReviewShowcaseSetting.prototype.hasInputValuesChanged = function () {
    if (!this.changedData) return false;

    var currentValues = this.getCurrentInputValues();
    if (!currentValues || !currentValues[this.changedData.serviceType]
        || currentValues[this.changedData.serviceType].length !== this.changedData.reviewIds.length) return false;

    for (var i = 0; i < currentValues[this.changedData.serviceType].length; i ++) {
        if (currentValues[this.changedData.serviceType][i] !== this.changedData.reviewIds[i]) return true;
    }
    return false;
};

ReviewShowcaseSetting.prototype.save = function(callback) {
    this.saveSettings(callback);
    if (this.hasInputValuesChanged() && this.orderedReviewItems) {
        $businessPublisherIntegrationService.updateCMSComponentReviewShowcaseItemsOrder(this.orderedReviewItems, function () {
            SnackBar.show("Review showcase setting has been saved!");
        }, function (error) {
            Dialog.error(error.message);
        }, "Loading");
    }
    this.signalDesignChanged();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SectionSettingDialog.js";

function SectionSettingDialog() {
    ModificationWatchDialog.call(this);

    this.title = "Section Settings";

    this.layoutOrientationCombo.comparer = Util.sameRelax;
    this.layoutOrientationCombo.setItems([SectionSettingDialog.ORIENTATION_HORIZONTAL, SectionSettingDialog.ORIENTATION_VERTICAL]);
    this.bind("p:ItemSelected", this.invalidateOrientation, this.layoutOrientationCombo);
    this.bind("click", this.handleEditToolbarAction, this.layoutCanvas);
    this.bind("click", this.handleAddComponent, this.addComponentLink);
    this.titleColorInput.setInfoWhenDefaultColorSelected("Default template's color will be used");
    this.titleColorInput.setDefaultColor("#FFFFFF00");
    this.bind("p:ValueUpdated", function(){
        this.validateUsingTemplateStyleInfo();
    }.bind(this), this.backgroundStyleEditor.node());
    this.bind("p:FileModified", function(){
        this.validateUsingTemplateStyleInfo();
    }.bind(this), this.backgroundStyleEditor.node());

    this.gapUnitSelector.comparer = Util.sameId;
    this.gapUnitSelector.renderer = function (item) { return item.name; };
    this.gapUnitSelector.setItems([
        {id: "px", name: "Pixels"},
        {id: "ex", name: "Characters"}
    ]);

    Dom.registerListActionHandlers(this.layoutCanvas, "_slotSettings", {
        SectionConfigButton: function (settings, event, view) {
            this.configureSection(view);
        }.bind(this)
    });
}
__extend(ModificationWatchDialog, SectionSettingDialog);

SectionSettingDialog.prototype.getChangeEventNames = function () {
    return [ModificationWatchDialog.DEFAULT_CHANGE_EVENT_NAME, FileUploadView.FILE_CHANGE_EVENT_NAME, "p:ValueChanged", "input", "p:ItemSelected"];
};

SectionSettingDialog.ORIENTATION_HORIZONTAL = "Horizontal";
SectionSettingDialog.ORIENTATION_VERTICAL = "Vertical";

SectionSettingDialog.prototype.asyncSetup = function (sectionInfo, callback) {
    this.sectionInfo = sectionInfo;
    $cmsService.getComponentTypeRegistry(function (registry) {
        this.componentRegistry = registry;
        this.componentRegistryMap = {};
        for (var i = 0; i < registry.length; i++) {
            var type = registry[i];
            this.componentRegistryMap[type.name] = type;
        }
        this.reload(callback);

    }.bind(this));
};

SectionSettingDialog.prototype.reload = function(callback) {
    $cmsService.getPageSectionById(this.sectionInfo.sectionId, function (section) {
        this.section = section;
        this.initUI();
        if (callback) callback();
    }.bind(this));
}
SectionSettingDialog.prototype.setupReordering = function () {
    var horizontalTargetFinderFunction = DragAndDropManager.DROP_AT_CONTAINER(true);
    var verticalTargetFinderFunction = DragAndDropManager.DROP_AT_CONTAINER(false);

    var thiz = this;

    this.dndTargetFinderFunction = function (horizontal, subContainerFinder, itemBoundGetter) {
        var orientation = thiz.layoutOrientationCombo.getSelectedItem();
        if (orientation == SectionSettingDialog.ORIENTATION_VERTICAL) {
            return verticalTargetFinderFunction(horizontal, subContainerFinder, itemBoundGetter);
        } else {
            return horizontalTargetFinderFunction(horizontal, subContainerFinder, itemBoundGetter);
        }
    };

    this._setupDNDForSection();
};
SectionSettingDialog.prototype.initUI = function () {
    this.setupReordering();
    this.layoutOrientationCombo.selectItemIfContains(this.section.settings.orientation || SecinitionSettingDialog.ORIENTATION_HORIZONTAL);
    this.backgroundStyleEditor.initFromValue(this.section.settings);
    this.sectionTitleInput.value = this.section.settings.title || "";
    var titleColor = this.section.settings.titleColor;
    if (titleColor) {
        this.titleColorInput.setRGBAHexColorString(titleColor);
    }

    this.layoutCanvas.innerHTML = "";

    var slotIndexes = [];
    for (var i = 0; i < this.section.components.result.length; i ++) {
        var component = this.section.components.result[i];
        if (slotIndexes.indexOf(component.slot) < 0) slotIndexes.push(component.slot);
    }
    slotIndexes.sort(function(a, b) {
        return a - b;
    });

    var slotSizes = this._parseSlotSizes(this.section.settings.slotSizes)

    for (var i = 0; i < this.section.components.result.length; i ++) {
        var component = this.section.components.result[i];
        component.slot = slotIndexes.indexOf(component.slot);
        this.newComponentView(component);
    }

    var slotViews = this.layoutCanvas.querySelectorAll(":scope > *");
    for (var i = 0; i < slotViews.length; i ++) {
        var view = slotViews[i];
        if (Dom.hasClass(view, "Blank")) continue;

        var size = slotSizes[i] || this._getDefaultSlotSettings();
        view._slotSettings = size;
    }

    this.invalidateAllSlotsViewSize();

    var gapValue = "0";
    var gapUnit = "px";

    if (this.section.settings.gap && this.section.settings.gap.match(/^([0-9\.]+)(px|ex)$/)) {
        gapValue = RegExp.$1;
        gapUnit = RegExp.$2;
    }

    this.gapUnitSelector.selectItemByKey("id", gapUnit);
    this.gapValueInput.value = gapValue;

    this._updateSlotViews();

    this.setSnapshotInputValues(this.getCurrentInputValues());
    this.validateUsingTemplateStyleInfo();
};
SectionSettingDialog.prototype.validateUsingTemplateStyleInfo = function() {
    var currentValue = this.backgroundStyleEditor.getValue();
    var hasColor = currentValue["backgroundColor"] && currentValue["backgroundColor"] != "#FFFFFF00";
    var hasBackground = currentValue["backgroundImage"] && currentValue["backgroundImage"].length > 0;
    Dom.toggleClass(this.usingTemplateStyleBox, "UsingTemplateStyle", !hasColor && !hasBackground);
}
SectionSettingDialog.prototype.invalidateAllSlotsViewSize = function () {
    var slotViews = this.layoutCanvas.querySelectorAll(":scope > *");
    for (var i = 0; i < slotViews.length; i ++) {
        var view = slotViews[i];
        this._invalidateSlotViewSizing(view);
    }
};
SectionSettingDialog.prototype._invalidateSlotViewSizing = function (view) {
    var totalFlex = 0;
    var slotViews = this.layoutCanvas.querySelectorAll(":scope > *");
    var count = 0;
    for (var i = 0; i < slotViews.length; i ++) {
        var v = slotViews[i];
        if (Dom.hasClass(v, "Blank")) continue;
        count ++;
        var size = v._slotSettings || this._getDefaultSlotSettings();
        if (size.flex > 0) totalFlex += size.flex;
    }

    var size = view._slotSettings || this._getDefaultSlotSettings();

    if (typeof(size.flex) == "undefined") size.flex = 0;

    var orientation = this.layoutOrientationCombo.getSelectedItem();
    var isBlank = Dom.hasClass(view, "Blank");
    if (size.flex == 0 || orientation == SectionSettingDialog.ORIENTATION_HORIZONTAL || isBlank) {
        if (count == 1 && !isBlank && orientation == SectionSettingDialog.ORIENTATION_VERTICAL) { // when a fit slot is also the only slot, make it flex = 1
            view.setAttribute("style", "flex: 1 0 1em; -webkit-flex: 1 0 1em;");
        } else {
            view.setAttribute("style", "flex: 0 0 auto; -webkit-flex: 0 0 auto;");
        }
        view.setAttribute("sizing", "Fit");
    } else if (size.flex < 0) {
        var s = "8em";
        view.setAttribute("style", "flex: 0 0 " + s + "; -webkit-flex: 0 0 " + s + ";");
        view.setAttribute("sizing", size.size + size.sizeUnit);
    } else {
        view.setAttribute("style", "flex: " + size.flex + " 0 1em; -webkit-flex: " + size.flex + " 0 1em;");
        view.setAttribute("sizing", "Weight: " + size.flex + "/" + totalFlex);
    }
};
SectionSettingDialog.prototype._parseSlotSizes = function (sizes) {
    var slotSizes = [];
    if (!sizes) return slotSizes;
    sizes.split(",").forEach(function (item) {
        var slotSize = {
            flex: 0,
            size: 0,
            sizeUnit: "px"
        };
        if (item.match(/^([1-6])\*$/)) {
            slotSize.flex = parseInt(RegExp.$1, 10);
        } else if (item.match(/^([0-9\.]+)(px|ex|%)$/)) {
            slotSize.flex = -1;
            slotSize.size = parseFloat(RegExp.$1);
            slotSize.sizeUnit = RegExp.$2;
        }

        slotSizes.push(slotSize);
    });
    return slotSizes;
};

SectionSettingDialog.prototype.newComponentView = function (component) {
    console.log("newComponentView(), component = ", component);
    var displayName = this.getComponentName(component);
    var configurable = this.componentRegistryMap[component.type].configurable && component.configurable || false;
    var element = Dom.newDOMElement({
        _name: "hbox",
        flex: component.layoutFlex || "0",
        "class": component.hidden ? "Component Hidden" : "Component",
        _children: [
            {
                _name: "div",
                "class": "NameAndSize",
                _children: [
                    { _name: "strong", "class": "Name", _text: displayName },
                    { _name: "span", "class": "Size", _text: "" }
                ]
            },
            {
                _name: "hbox", "class": "HoverEditBar",
                _children: [
                    {
                        _name: "icon", "class": "EditButton", title: "Edit size"
                    },
                    {
                        _name: "icon", "class": "EditItemButton" + ((component.id > 0 && configurable) ? "" : " Disabled"), title: "Configure " + displayName
                    },
                    {
                        _name: "icon", "class": "DraftButton", title: "Hide component"
                    },
                    {
                        _name: "icon", "class": "PublishButton", title: "Show component"
                    },
                    {
                        _name: "icon", "class": "DeleteButton", title: "Remove component"
                    }
                ]
            }
        ]
    });
    element._component = component;
    this._obtainSlotView(component).appendChild(element);
    this.invalidateAllViewsSize();
};
SectionSettingDialog.prototype._createSlotView = function (slotSettings) {
    var view = document.createElement("div");
    this.layoutCanvas.appendChild(view);
    this._setupDNDForSlot(view);

    Dom.addClass(view, "SlotView");
    view.appendChild(Dom.newDOMElement({
        _name: "hbox",
        "class": "Toolbar",
        _children: [
            {
                _name: "button",
                title: "Configure sub-section",
                "class": "SectionConfigButton",
                _children: [
                    {_name: "icon", "class": "dots-horizontal"}
                ]
            }
        ]
    }));

    view._slotSettings = slotSettings || {};

    return view;
};
SectionSettingDialog.prototype._obtainSlotView = function (component) {
    if (component.slot < 0) component.slot = 0;
    var views = this.layoutCanvas.querySelectorAll(":scope > *");
    if (views.length <= component.slot) {
        var view = this._createSlotView();
        component.slot = views.length;
    } else {
        view = views[component.slot];
    }

    return view;
};
SectionSettingDialog.prototype._setupDNDForSection = function () {
    if (this._dnd) this._dnd.destroy();

    var horizontalTargetFinderFunction = DragAndDropManager.DROP_AT_CONTAINER(true);
    var verticalTargetFinderFunction = DragAndDropManager.DROP_AT_CONTAINER(false);

    var thiz = this;

    var targetFinderFunction = function (horizontal, subContainerFinder, itemBoundGetter) {
        var orientation = thiz.layoutOrientationCombo.getSelectedItem();
        if (orientation == SectionSettingDialog.ORIENTATION_HORIZONTAL) {
            return verticalTargetFinderFunction(horizontal, subContainerFinder, itemBoundGetter);
        } else {
            return horizontalTargetFinderFunction(horizontal, subContainerFinder, itemBoundGetter);
        }
    };

    this._dnd = new DragAndDropManager()
                .source(this.layoutCanvas)
                .anchor(function (node) {
                    if (Dom.findParentWithClass(node, "Component")) throw "Stop";
                    if (Dom.findParentWithClass(node, "HoverEditBar")) throw "Stop";
                    if (Dom.findParentWithClass(node, "SectionConfigButton")) throw "Stop";
                    if (Dom.findParentWithClass(node, "Blank")) throw "Stop";

                    return node._slotSettings;
                })
                .itemInfo(function (node) {
                    var slotView = Dom.findParentWithClass(node, "SlotView");

                    return {
                        element: node,
                        data: {
                            isSlotData: true,
                            slotView: node
                        }
                    };
                })
                .destination(this.layoutCanvas)
                .canDrop(function (data) {
                    return data.isSlotData;
                }.bind(this))
                .dropAt(targetFinderFunction)
                .setup();

    this._dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "SectionDragImage"
        });

        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";

        return node;
    };
    this._dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "SectionDropHint"
        });
    };

    this._dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            return;
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }

        // this._updateSlotViews();
        // this.invalidateAllViewsSize();

        Dom.addClass(draggable, "JustDropped");

        window.setTimeout(function () {
            Dom.removeClass(draggable, "JustDropped");
        }, 100);

        this.emitChangeEvent();
    }.bind(this);
};

SectionSettingDialog.prototype.getComponentName = function (component){
    return this.componentRegistryMap[component.type] ? this.componentRegistryMap[component.type].displayName : (component.type || "Unknown");
};

SectionSettingDialog.prototype._setupDNDForSlot = function (view) {
    if (view._dnd) view._dnd.destroy();

    view._dnd = new DragAndDropManager()
                .source(view)
                .anchor(function (node) {
                    if (Dom.findParentWithClass(node, "HoverEditBar")) throw "Stop";
                    return node._component;
                })
                .itemInfo(function (node) {
                    return {
                        element: node,
                        data: node._component
                    };
                })
                .destination(view)
                .canDrop(function (data) {
                    return !data.isSlotData && this.componentRegistryMap[data.type];
                }.bind(this))
                .dropAt(this.dndTargetFinderFunction)
                .setup();

    view._dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "SectionComponentDragImage"
        });

        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";

        return node;
    };
    view._dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };

    view._dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }

        this._updateSlotViews();
        this.invalidateAllViewsSize();

        Dom.addClass(draggable, "JustDropped");

        window.setTimeout(function () {
            Dom.removeClass(draggable, "JustDropped");
        }, 100);

        this.emitChangeEvent();
    }.bind(this);
};
SectionSettingDialog.prototype._updateSlotViews = function () {
    var views = this.layoutCanvas.querySelectorAll(":scope > *");
    for (var i = 0; i < views.length; i ++) {
        var view = views[i];
        var compViews = view.querySelectorAll(":scope > .Component");
        if (compViews.length <= 0) {
            if (view._dnd) view._dnd.destroy();
            this.layoutCanvas.removeChild(view);
        } else {
            Dom.removeClass(view, "Blank");
            if (!view._slotSettings) view._slotSettings = this._getDefaultSlotSettings();
        }
    }

    var view = this._createSlotView();
    Dom.addClass(view, "Blank");

    this.invalidateAllSlotsViewSize();
}
SectionSettingDialog.prototype.getTotalFlex = function (slotView) {
    var flex = 0;
    Dom.doOnSelector(slotView, ":scope > .Component", function (node) {
        if (!node || !node._component) return;
        if (node._component.layoutFlex > 0) flex += node._component.layoutFlex;
    });

    return flex;
};
SectionSettingDialog.prototype.invalidateAllViewsSize = function () {
    var thiz = this;
    Dom.doOnSelector(this.layoutCanvas, ":scope > div > .Component", function (node) {
        if (!node || !node._component) return;
        thiz._invalidateViewSize(node, node._component);
    });
};
SectionSettingDialog.prototype._invalidateViewSize = function (view, component) {
    var sizeLabel = view.querySelector(".Size");
    if (component.layoutFlex == 0) {
        view.setAttribute("style", "flex: 0 0 auto; -webkit-flex: 0 0 auto;");
        sizeLabel.innerHTML = "(Fit)";
    } else if (component.layoutFlex < 0) {
        var s = "8em";
        view.setAttribute("style", "flex: 0 0 " + s + "; -webkit-flex: 0 0 " + s + ";");
        sizeLabel.innerHTML = "(" + component.size + (component.sizeUnit == "ex" ? " chars" : component.sizeUnit) + ")";
    } else {
        view.setAttribute("style", "flex: " + component.layoutFlex + " 0 1em; -webkit-flex: " + component.layoutFlex + " 0 1em;");
        sizeLabel.innerHTML = "(" + component.layoutFlex + "/" + this.getTotalFlex(view.parentNode) + ")";
    }
};

SectionSettingDialog.prototype.invalidateOrientation = function (event) {
    var orientation = this.layoutOrientationCombo.getSelectedItem();
    Dom.toggleClass(this.layoutCanvas, "OrientVertical", orientation == SectionSettingDialog.ORIENTATION_VERTICAL);

    Dom.setInnerText(this.gapLabel, orientation == SectionSettingDialog.ORIENTATION_VERTICAL ? "Column gap:" : "Row gap:")

    this.invalidateAllSlotsViewSize();
    this.invalidateAllViewsSize();

    this.invalidateSizing();

    if (event.fromUser) this.emitChangeEvent();
};

SectionSettingDialog.prototype.save = function (callback) {
    var thiz = this;
    var values = this.getCurrentInputValues();

    $cmsService.updatePageSection(values.id, values.settings, values.components, function () {
        Dom.emitEvent(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, window.currentWebDesignFeature.node());
        if (callback) callback();
    }, function(e) {
        if (e && "REMOVE_PRIMARY_COMPONENT_DOES_NOT_ALLOWED" == e.code) {
            Dialog.error(e.message, null, function(){
                thiz.clearUnsavedNotify();
                thiz.reload();
            });
        }
    }, this);
};
SectionSettingDialog.prototype.onInstallResult = function (result) {
};
SectionSettingDialog.prototype.configureSection = function (view) {
    var thiz = this;
    var settings = view._slotSettings;
    new FlexSizingPolicy().callback(function (sizing) {
        console.log("configureSection", sizing);
        if (!sizing) return;
        settings.flex = sizing.flex;
        settings.size = isNaN(sizing.size) ? 0 : sizing.size;
        settings.sizeUnit = sizing.sizeUnit;
        thiz.invalidateAllSlotsViewSize();
        thiz.emitChangeEvent();
    }).open({
        flex: settings.flex,
        size: settings.size,
        sizeUnit: settings.sizeUnit
    });
};
SectionSettingDialog.prototype.handleEditToolbarAction = function (event) {
    var toolbar = Dom.findParentWithClass(event.target, "HoverEditBar");
    if (!toolbar) return;

    var icon = Dom.findParentByTagName(event.target, "icon");
    if (!icon) return;

    var view = Dom.findUpwardForNodeWithData(icon, "_component");
    if (!view) return;

    var component = view._component;

    var thiz = this;
    if (Dom.hasClass(icon, "DraftButton")) {
        component.hidden = true;
        Dom.toggleClass(view, "Hidden", component.hidden);
        this.emitChangeEvent();
    }
    if (Dom.hasClass(icon, "PublishButton")) {
        component.hidden = false;
        Dom.toggleClass(view, "Hidden", component.hidden);
        this.emitChangeEvent();
    }
    if (Dom.hasClass(icon, "EditButton")) {
        var flex = component.layoutFlex;
        new FlexSizingPolicy().callback(function (sizing) {
            if (!sizing) return;
            component.layoutFlex = sizing.flex;
            component.size = isNaN(sizing.size) ? 0 : sizing.size;
            component.sizeUnit = sizing.sizeUnit;
            thiz.invalidateAllViewsSize();
            thiz.emitChangeEvent();
        }).open({
            flex: component.layoutFlex,
            size: component.size,
            sizeUnit: component.sizeUnit
        });
        // Dialog.select([0, 1, 2, 3, 4, 5, 6], function (flexes) {
        //     var flex = flexes[0];
        //     component.layoutFlex = flex;
        //     view.setAttribute("flex", ""  + flex);
        //     thiz.emitChangeEvent();
        // }, [component.layoutFlex], {
        //     exclusive: true,
        //     formatter: function (f) {
        //         return !f ? "Fit to Component" : ("Weight = " + f);
        //     },
        //     message: "Please select the expect sizing setting for this component.",
        //     size: "smaller"
        // });
    }
    if (Dom.hasClass(icon, "DeleteButton")) {
        var displayName = this.getComponentName(component);
        var TeamLocalizer = window.top.TeamLocalizer;
        var customization = TeamLocalizer.getString("customization");
        Dialog.confirm("Are you sure you want to remove this '" + displayName + "' component?",
        "When removing a component you will lose all specific " + customization + " done to it but its content data will be kept.", "Remove", function () {
            $cmsService.validateComponentRemovable(thiz.section.id, view._component.id, function () {
                view.parentNode.removeChild(view);
                thiz._updateSlotViews();
                thiz.emitChangeEvent();
            }, function (e) {
                if (e && "REMOVE_PRIMARY_COMPONENT_DOES_NOT_ALLOWED" == e.code) {
                    Dialog.error(e.message, null, function(){});
                }
            });
        }, "Cancel");
    }

    if (Dom.hasClass(icon, "EditItemButton")) {
        ComponentDetailDialog.open({
            componentType: component.type,
            componentName: this.getComponentName(component),
            componentId: component.id,
            pageId: this.sectionInfo.pageId
        });
    }
};

SectionSettingDialog.prototype.getCurrentInputValues = function() {
    var settings = {
        orientation: this.layoutOrientationCombo.getSelectedItem(),
        title: this.sectionTitleInput.value,
        titleColor: this.titleColorInput.getRGBAHexColorString(),
        gap: this.gapValueInput.value + this.gapUnitSelector.getSelectedItem().id
    };
    this.backgroundStyleEditor.saveToValue(settings);
    var components = [];
    var slot = -1;
    var slotSizes = [];
    var thiz = this;
    Dom.doOnSelector(this.layoutCanvas, ":scope > div", function (view) {
        slot ++;
        Dom.doOnSelector(view, ":scope > .Component", function (node) {
            if (!node || !node._component) return;
            components.push({
                id: node._component.id,
                hidden: node._component.hidden,
                layoutFlex: node._component.layoutFlex,
                size: node._component.size,
                sizeUnit: node._component.sizeUnit,
                type: node._component.type,
                slot: slot
            });
        });

        var settings = view._slotSettings || thiz._getDefaultSlotSettings();
        if (settings.flex == 0) {
            slotSizes.push("fit");
        } else if (settings.flex < 0) {
            slotSizes.push(settings.size + settings.sizeUnit);
        } else slotSizes.push("" + settings.flex + "*");
    });

    settings.slotSizes = slotSizes.join(",");
    return {
        id: this.section.id,
        settings: settings,
        components: components
    }
}
SectionSettingDialog.prototype._getDefaultSlotSettings = function () {
    return {flex: 0, size: 0, sizeUnit: "px"};
}
SectionSettingDialog.prototype.getGroupRegistryImpl = function(callback) {
    if (this.groupRegistry && this.groupMap) {
        if (callback) callback();
        return;
    }
    $cmsService.getGroupRegistry(function(registry) {
        this.groupRegistry = registry;
        this.groupMap =  {};
        for (var i = 0; i < registry.length; i++) {
            var group = registry[i];
            this.groupMap[group.name] = group;
        }
        if (callback) callback();
    }.bind(this), this);

}
SectionSettingDialog.prototype.handleAddComponent = function () {
    var thiz = this;
    this.getGroupRegistryImpl(function(){

        $cmsService.getAvailableExtraComponentsByGroup(this.sectionInfo.pageId, this.sectionInfo.sectionId, [], function(componentGroups) {

            if (!componentGroups || componentGroups.length == 0) {
                Dialog.alert("Message","There are no components to add into this section.");
                return;
            }


            var selectionComponentDialog = new SelectionComponentDialog(this.groupRegistry, this.componentRegistryMap, componentGroups).callback(
                function(selectedItems) {
                    if (!selectedItems) return;
                    for (var i = 0; i < selectedItems.length; i++) {
                        var type = selectedItems[i];
                        var component = {
                            id: 0,
                            type: type,
                            hidden: false,
                            layoutFlex: 0,
                            slot: 0
                        };
                        thiz.newComponentView(component);
                    }
                    thiz._updateSlotViews();
                    thiz.emitChangeEvent();
                }
            );
            selectionComponentDialog.open();
        }.bind(this), this);
    }.bind(this));

}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SelectionComponentDialog.js";

function SelectionComponentDialog(groups, componentRegistryMap , componentGroups) {
    Dialog.call(this);
    this.title = "Select Components"
    this.selectedItems = [];
    this.groups = groups;
    this.inputs = [];
    this.componentRegistryMap = componentRegistryMap;
    this.componentGroups = componentGroups;
    this.render();
}
__extend(Dialog, SelectionComponentDialog)

SelectionComponentDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "accept", title: "Select",
            run: function () {
                var selected = [];
                for (var i = 0; i < thiz.inputs.length; i++) {
                    if (thiz.inputs[i].checked) selected.push(thiz.inputs[i]._item);
                }
                thiz.close(selected);
                return false;
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
}


SelectionComponentDialog.prototype.render = function () {
    var thiz = this;
    for (var i = 0; i < this.groups.length; i++) {
        var group = this.groups[i];
        var vbox = Dom.newDOMElement({_name: "vbox", class: "Group"});
        var header = Dom.newDOMElement({
            _name: "strong",
            class: "GroupHeader",
            _html: group.displayName.toUpperCase()
        })
        vbox.appendChild(header);
        var items = this.componentGroups[group.name];
        if (!items) continue;
        for (var j = 0; j < items.length; j++){
            var id = "checkbox_" + widget.random();
            var holder = {};
            var span = Dom.newDOMElement({
                _name: "hbox",
                class: "ItemSelected",
                _children: [
                    {
                        _name: "input",
                        type: "checkbox",
                        id: id,
                        _id: "checkbox"
                    },
                    {
                        _name: "label",
                        "for": id,
                        _html: Dom.htmlEncode(thiz.componentRegistryMap[items[j]].displayName)
                    }
                ]
            }, document, holder);
            this.inputs.push(holder.checkbox);
            holder.checkbox._item = items[j];
            //holder.checkbox.checked = Util.contains(thiz.selectedItems, items[j], widget.sameRelax);
            vbox.appendChild(span);
        }
        this.container.appendChild(vbox);
    }
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SiteFooterSettingsView.js";

function  SiteFooterSettingsView() {
    BaseTemplatedWidget.call(this);
    
    var thiz = this;
    this.bind("change", function(event) {
        thiz.linkCustomPrivacy.disabled = !event.target.checked;
        Dom.removeClass(thiz.linkCustomPrivacy, "CV_Invalid");
    }, this.customPrivacy);
    
    this.bind("change", function(event) {
        thiz.linkCustomTerms.disabled = !event.target.checked;
        Dom.removeClass(thiz.linkCustomTerms, "CV_Invalid");
    }, this.customTerms);
    
    this.bind("change", this.getGoogleAnalyticsTypeChangedHandler, this.gaInputPane);
    this.addValidation();
}
__extend(BaseTemplatedWidget, SiteFooterSettingsView);

SiteFooterSettingsView.prototype.onAttached = function(first) {
    if (!first) return;
}

SiteFooterSettingsView.prototype.addValidation = function() {
    var thiz = this;
    this.validationRules = new RuleSet()
        .live(true)
        .custom(new GenericRule(this.gaAccountId, function() {
             if(thiz.googleAnalyticsId.checked && thiz.getGoogleAnalyticsType() == thiz.googleAnalyticsId.value && !thiz.getGoogleAnalyticsId().startsWith("G-")) {
                 return false;
             }
            
             return true;
        }, "Tag ID must start with G-! Please check your input."))
        .custom(new GenericRule(this.gaContainerId, function() {
             if(thiz.getGoogleAnalyticsType() == thiz.googleTagManagerId.value && !thiz.getGoogleContainerId().startsWith("GTM")) {
                 return false;
             }
            
             return true;
        }, "Container ID must start with GTM! Please check your input."))
        .custom(new GenericRule(this.linkCustomPrivacy, function() {
            if(thiz.customPrivacy.checked && thiz.getPrivacyUrl() == "") {
                return false;
            }
             
            return true;
        }, "Please enter the Custom Privacy URL."))
        .pattern(this.linkCustomPrivacy, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid Custom Privacy URL! Please check your input.")
        .custom(new GenericRule(this.linkCustomTerms, function() {
            if(thiz.customTerms.checked && thiz.getTermsUrl() == "") {
                return false;
            }
             
            return true;
        }, "Please enter the Custom Terms & Conditions URL."))
        .pattern(this.linkCustomTerms, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid Custom Terms & Conditions URL! Please check your input.");
}

SiteFooterSettingsView.prototype.getGoogleAnalyticsTypeChangedHandler = function(event) {
    if (event.target.name == "googleAnalytics") {
        this.initGoogleAnalyticsRadioButton(event.target.value);
    }
}

SiteFooterSettingsView.prototype.initCMPCombo = function(usage) {
    if(this.gtmInitiated) {
        return;
    }
    var thiz = this;
    var comboManager = this.cmpCombo;
    var selected = usage.cookieYes ? "1" : "0";
    
    var yesNo = [{key: 0, value: "None"}, {key: 1, value: "CookieYes"}];
    comboManager.comparer = function(a, b) {
        return a.key == b.key;
    };
    comboManager.renderer = function(data) {
        return data.value || "";
    };
    comboManager.setItems(yesNo);
    comboManager.selectItemByKey("key", selected);
    
    this.bind('change', function() {
        console.log('googleAnalytics changed with settings ', this.settings);
        Dom.setEnabled(thiz.googleTagManagerId.checked, this.cmpCombo);
        comboManager.selectItemByKey("key", thiz.googleTagManagerId.checked ? comboManager.getSelectedItem() : 0);
        Dom.hide(thiz.cmpPane);
        if(thiz.noGA.checked) {
            Dom.hide(thiz.cmpPane);
        } else if(this.settings && this.settings.enabledGTM == "1") {
            Dom.show(thiz.cmpPane);
        }
    }, this.googleAnalytics);
    this.gtmInitiated = true;
}

SiteFooterSettingsView.prototype.initGoogleAnalyticsRadioButton = function(value) {
    console.log('initGoogleAnalyticsRadioButton', value);
    Dom.show(this.cmpPane);
    if(value == "gaId") {
        this.gaAccountId.disabled = false;
        this.gaContainerId.disabled = true;
        this.removeInvalidInput(this.gaContainerId);
    } else if(value == "gtmId") {
        this.gaAccountId.disabled = true;
        this.gaContainerId.disabled = false;
        this.removeInvalidInput(this.gaAccountId);
    } else {
        this.gaAccountId.disabled = true;
        this.gaContainerId.disabled = true;
        this.removeInvalidInput(this.gaAccountId);
        this.removeInvalidInput(this.gaContainerId);
        Dom.hide(this.cmpPane);
    }
}

SiteFooterSettingsView.prototype.getPrivacyUrl = function() {
    if(this.linkCustomPrivacy.value) {
        return this.linkCustomPrivacy.value.trim();
    }
    return "";
}

SiteFooterSettingsView.prototype.setPrivacyUrl = function(url) {
    this.linkCustomPrivacy.value = url;
}

SiteFooterSettingsView.prototype.getTermsUrl = function() {
    if(this.linkCustomTerms.value) {
        return this.linkCustomTerms.value.trim();
    }
    return "";
}

SiteFooterSettingsView.prototype.setTermsUrl = function(url) {
    this.linkCustomTerms.value = url;
}

SiteFooterSettingsView.prototype.isValid = function() {
    return ValidationManager.run(this.validationRules);
}

SiteFooterSettingsView.prototype.setGoogleAnalytics = function(usage) {
    var ga = usage.googleAnalyticsId || "";
    
//    var googleAnalyticsId = usage.googleAnalyticsId;
//    var googleTagManagerId = usage.googleTagManagerId;
    var radioValue = "";
    if(ga.startsWith("G-")) {
        this.setGoogleAnalyticsId(ga);
//    if(googleAnalyticsId !== undefined && googleAnalyticsId.startsWith("G-")) {
//        this.setGoogleAnalyticsId(googleAnalyticsId);
        this.googleAnalyticsId.checked = true;
        radioValue = this.googleAnalyticsId.value;
    } else if(ga.startsWith("GTM")) {
        this.setGoogleContainerId(ga);
//    } else if(googleTagManagerId !== undefined && googleTagManagerId.startsWith("GTM")) {
//        this.setGoogleContainerId(googleTagManagerId);
        this.googleTagManagerId.checked = true;
        radioValue = this.googleTagManagerId.value;
    } else {
        this.noGA.checked = true;
        radioValue = "";
    }
    this.initGoogleAnalyticsRadioButton(radioValue);
    this.initCMPCombo(usage);
}

SiteFooterSettingsView.prototype.setFooterSettings = function(settings) {
    this.settings = settings;
    if(settings.privacyUrl != "") {
        this.setPrivacyUrl(settings.privacyUrl);
        this.customPrivacy.checked = true;
    } else {
        this.linkCustomPrivacy.disabled = true;
    }
    
    if(settings.termsUrl != "") {
        this.setTermsUrl(settings.termsUrl);
        this.customTerms.checked = true;
    } else {
        this.linkCustomTerms.disabled = true;
    }

    Dom.setEnabled(false, this.cmpCombo);
    if(settings.enabledGTM == "1") {
        Dom.removeClass(this.gtmContainerLabel, "DisableGTM");
        Dom.removeClass(this.gtmContainerInput, "DisableGTM");
        Dom.setEnabled(this.googleTagManagerId.checked, this.cmpCombo);
        
        if(settings.googleAnalyticsId !== undefined || 
            settings.googleTagManagerContainerId !== undefined || 
            settings.cookieYes !== undefined) {
                this.setTrackingAndAnalyticsData(settings);
        }
    } else {
        Dom.hide(this.cmpPane);
    }
}

SiteFooterSettingsView.prototype.getTrackingAndAnalyticsData = function() {
    this.trackingAndAnalyticsData = {
        googleAnalyticsId: '',
        googleTagManagerId: '',
        cookieYes: false
    };
    if(this.googleAnalyticsId.checked) {
        this.trackingAndAnalyticsData.googleAnalyticsId = this.gaAccountId.value;
    } else if(this.googleTagManagerId.checked) {
        this.trackingAndAnalyticsData.googleTagManagerId = this.gaContainerId.value;
        this.trackingAndAnalyticsData.cookieYes = this.cmpCombo.getSelectedItem().key == 1;
    }
    return this.trackingAndAnalyticsData;
}

SiteFooterSettingsView.prototype.setTrackingAndAnalyticsData = function(data) {
    if(data.googleAnalyticsId !== undefined) {
        this.gaAccountId.value = data.googleAnalyticsId;
    }
    if(data.googleTagManagerId !== undefined) {
        this.gaContainerId.value = data.googleTagManagerId;
        if(data.cookieYes !== undefined) {
            this.cmpCombo.selectItemByKey("key", data.cookieYes ? 1 : 0);
        }
    }
}

SiteFooterSettingsView.prototype.removeInvalidInput = function(element) {
    Dom.removeClass(element, "CV_Invalid");
}

SiteFooterSettingsView.prototype.setGoogleAnalyticsId = function(ga) {
    this.gaAccountId.value = ga;
}

SiteFooterSettingsView.prototype.getGoogleAnalyticsId = function() {
    if(this.gaAccountId.value) {
        return this.gaAccountId.value.trim();
    }
    return "";
}

SiteFooterSettingsView.prototype.setGoogleContainerId = function(ga) {
    this.gaContainerId.value = ga;
}

SiteFooterSettingsView.prototype.getGoogleContainerId = function() {
    if(this.gaContainerId.value) {
        return this.gaContainerId.value.trim();
    }
    
    return "";
}

SiteFooterSettingsView.prototype.setCookieYes = function(cookieYes) {
    this.cmpCombo.selectItemByKey("key", cookieYes === "CookieYes" ? 1 : 0);
}

SiteFooterSettingsView.prototype.getCookieYes = function() {
    return this.cmpCombo.getSelectedItem().key === 1;
}


SiteFooterSettingsView.prototype.setGoogleAnalyticsType = function(ga) {
    
}

SiteFooterSettingsView.prototype.getGoogleAnalyticsType = function() {
    var type = document.querySelector("input[name=\"googleAnalytics\"]:checked");
    return Dom.getAttributeAsString(type, "value", "");
}

if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SizeOptionsWidget.js";

function SizeOptionsWidget() {
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.hAlignCombo.comparer = this.vAlignCombo.comparer = this.unitSelector.comparer = Util.sameId;
    this.hAlignCombo.renderer = this.vAlignCombo.renderer = this.unitSelector.renderer = function (item) { return item.name; };
    this.unitSelector.setItems(FlexSizingPolicy.UNITS);
    this.hAlignCombo.setItems(SizeOptionsWidget.HORIZONTAL_ALIGNS);
    this.vAlignCombo.setItems(SizeOptionsWidget.VERTICAL_ALIGNS);
    this.bind("change", this.validateSizingBox ,this.relativeInputMode);
    this.bind("change", this.validateSizingBox ,this.absoluteInputMode);

}
__extend(BaseTemplatedWidget, SizeOptionsWidget);

SizeOptionsWidget.FORMS = ["desktop", "tablet", "phone"];
SizeOptionsWidget.prototype.getValue = function() {
    this.refreshSettingValues();
    var isRelative = this.relativeInputMode.checked;
    if (isRelative) {
        for (var i = 0; i < SizeOptionsWidget.FORMS.length; i++){
            var item = SizeOptionsWidget.FORMS[i];
            var checkbox = this[item + "AllowedCheckbox"];
            if (checkbox.checked) {
                this.settings[item + "Width"] = null;
                this.settings[item + "Height"] = null;
            }
        }
    }
    return this.settings;
};

SizeOptionsWidget.prototype.setValue = function(photoFileUploadView, settings, options) {
    this.photoFileUploadView = photoFileUploadView;
    this.settings = settings;
    this.options = options || { showAllowedCheckboxs: true, desktop: true, tablet: true, phone: true};
};
SizeOptionsWidget.HORIZONTAL_ALIGNS = [
    {id: "left", name: "Left"},
    {id: "center", name: "Center"},
    {id: "right", name: "Right"}
];
SizeOptionsWidget.VERTICAL_ALIGNS = [
    {id: "top", name: "Top"},
    {id: "center", name: "Center"},
    {id: "bottom", name: "Bottom"}
];

SizeOptionsWidget.prototype.setupSizeInputGroup = function(name) {
    var box = this[name + "SizeInputGroup"];
    var widthInput = box.querySelector(":scope > .Width");
    var heightInput = box.querySelector(":scope > .Height");
    var checkbox = this[name + "AllowedCheckbox"];
    Dom.registerEvent(widthInput, "input", SizeOptionsWidget.handleSizeInputChange.bind(this), true);
    Dom.registerEvent(heightInput, "input", SizeOptionsWidget.handleSizeInputChange.bind(this), true);
    Dom.registerEvent(checkbox, "change", function (event) {this.validateSizeCheckboxToggle(event.target)}.bind(this), true);
};
SizeOptionsWidget.prototype.validateSizeCheckboxToggle = function (checkbox) {
    var container = checkbox.parentNode.parentNode;
    var widthInput = container.querySelector(".Width");
    var heightInput = container.querySelector(".Height");

    var isRelative = this.relativeInputMode.checked;

    if (checkbox.checked && !isRelative) {
        widthInput.removeAttribute("disabled");
        heightInput.removeAttribute("disabled");
    } else {
        widthInput.setAttribute("disabled", true);
        heightInput.setAttribute("disabled", true);
    }
};
SizeOptionsWidget.handleSizeInputChange = function (event) {
    var input = event.target;
    var os = this.photoFileUploadView.getFirstImageSize();
    if (!os) return;
    var isWidth = Dom.hasClass(input, "Width");
    var brother = input.parentNode.querySelector(":scope > ." + (isWidth ? "Height" : "Width"));

    var value = parseFloat(input.value);
    if (isNaN(value)) {
        input._modified = false;
        if (!brother._modified) brother.value = "";
        return;
    }

    input._modified = true;

    if (brother._modified) return;

    var isPercent = (this.unitSelector.getSelectedItem().id == "%");

    var otherValue = value;

    if (!isPercent) {
        otherValue = value * (isWidth ? (os.h / os.w) : (os.w / os.h));
        var p = 0;
        while (Math.floor(value * Math.pow(10, p)) != value * Math.pow(10, p)) p ++;

        var p10 = Math.pow(10, p);
        otherValue = Math.round(otherValue * p10) / p10;
    }

    brother.value = otherValue;

};

SizeOptionsWidget.prototype.loadSizeFromSettings = function (name) {
    var box = this[name + "SizeInputGroup"];
    var checkbox = this[name + "AllowedCheckbox"];
    var widthInput = box.querySelector(":scope > .Width");
    var heightInput = box.querySelector(":scope > .Height");

    var width = this.settings[name + "Width"];

    if (this.settings[name + "Hidden"]) {
        widthInput.value = "";
        heightInput.value = "";
        checkbox.checked = false;
        widthInput.setAttribute("disabled", true);
        heightInput.setAttribute("disabled", true);
    } else {
        widthInput.value = this.settings[name + "Width"] || "";
        heightInput.value = this.settings[name + "Height"] || "";

        checkbox.checked = true;
        widthInput.removeAttribute("disabled");
        heightInput.removeAttribute("disabled");
    }
};

SizeOptionsWidget.prototype.render = function () {
    var thiz = this;
    SizeOptionsWidget.FORMS.forEach(function (name) {
        thiz.setupSizeInputGroup(name);
    });
    var that = this;
    SizeOptionsWidget.FORMS.forEach(function (name) {
        that.loadSizeFromSettings(name, that.settings);
    });
    if (this.settings.sizeUnit) {
        this.unitSelector.selectItemByKey("id", that.settings.sizeUnit);
    }
    if (this.settings.hAlign) {
        this.hAlignCombo.selectItemByKey("id", that.settings.hAlign);
    } else if (this.settings.halign) {
        this.hAlignCombo.selectItemByKey("id", that.settings.halign);
    }
    if (this.settings.vAlign) {
        this.vAlignCombo.selectItemByKey("id", that.settings.vAlign);
    } else if (this.settings.valign) {
        this.vAlignCombo.selectItemByKey("id", that.settings.valign);
    }
    if (this.settings.alternateText) {
        this.alternateInput.value = this.settings.alternateText;
    }
    var isRelative = this.isRelative();
    if (isRelative) {
        this.relativeInputMode.checked = true;
        this.absoluteInputMode.checked = false;
    } else {
        this.relativeInputMode.checked = false;
        this.absoluteInputMode.checked = true;
    }

    this.validateSizingBox();
}

SizeOptionsWidget.prototype.refreshSettingValues = function () {
    var that = this;
    SizeOptionsWidget.FORMS.forEach(function (name) {
        that.saveSizeToSettings(name, that.settings);
    });
    this.settings.sizeUnit = this.unitSelector.getSelectedItem().id;
    this.settings.hAlign = this.hAlignCombo.getSelectedItem().id;
    this.settings.vAlign = this.vAlignCombo.getSelectedItem().id;
    this.settings.alternateText = this.alternateInput.value.trim();
    var os = this.photoFileUploadView.getFirstImageSize();;
    if (os) {
        this.settings.originalWidth = os.w;
        this.settings.originalHeight = os.h;
    }
};

SizeOptionsWidget.prototype.validateSizingBox = function() {
    var thiz = this;
    var isRelative = this.relativeInputMode.checked;
    Dom.toggleClass(this.sizingBox, "Disabled", isRelative ? true : false);
    if (isRelative) {
        Dom.doOnSelector(this.sizingBox, ":scope .SizeValueEntry input", function(input) {
            input.setAttribute("disabled", true);
        });
        this.displayModeText.innerHTML = "The image will automatically resize to fit within its container.";
    } else {
        Dom.doOnSelector(this.sizingBox, ":scope .Entry", function(entry) {
            var checkbox = entry.querySelector(".VisibleToggle input");
            if (checkbox) {
                checkbox.removeAttribute("disabled");
                thiz.validateSizeCheckboxToggle(checkbox);
            } else {
                Dom.doOnSelector(entry, ":scope input", function(input) {
                    input.removeAttribute("disabled");
                });
            }
        });
        this.displayModeText.innerHTML = this.options.absoluteText ? this.options.absoluteText : "Specify exact sizes for image to display on different devices.";
    }

    if (!this.options.showAllowedCheckboxs) {
        Dom.addClass(this.sizingBox, "HideAllowedCheckboxs");
        Dom.doOnSelector(this.sizingBox, ":scope .VisibleToggle input", function(input) {
            input.setAttribute("disabled", true);
        });
    }

    SizeOptionsWidget.FORMS.forEach(function(name) {
        if(!this.options[name]) {
            this.disableOption(name);
        }
    }.bind(this));
    this.unitSelector.setDisabled(isRelative);
}
SizeOptionsWidget.prototype.saveSizeToSettings = function (name, settings) {
    var box = this[name + "SizeInputGroup"];
    var checkbox = this[name + "AllowedCheckbox"];

    if (checkbox.checked || !this.options.showAllowedCheckboxs) {
        var widthInput = box.querySelector(":scope > .Width");
        var heightInput = box.querySelector(":scope > .Height");
        var w = parseFloat(widthInput.value);
        settings[name + "Width"] = (isNaN(w) || !this.options[name]) ? null : w;
        var h = parseFloat(heightInput.value);
        settings[name + "Height"] = (isNaN(h) || !this.options[name]) ? null : h;
        delete settings[name + "Hidden"];
    } else {
        settings[name + "Width"] = null;
        settings[name + "Height"] = null;
        settings[name + "Hidden"] = true;
    }
};
SizeOptionsWidget.prototype.isRelative = function () {
    for (var i = 0; i < SizeOptionsWidget.FORMS.length; i++){
        var item = SizeOptionsWidget.FORMS[i];
        if (this.settings[item + "Width"] && this.settings[item + "Height"]) {
            return false;
        }
    }
    return true;
}
SizeOptionsWidget.prototype.disableOption = function (name) {
    var box = this[name + "SizeInputGroup"];
    var widthInput = box.querySelector(":scope > .Width");
    widthInput.setAttribute("disabled", true);
    var heightInput = box.querySelector(":scope > .Height");
    heightInput.setAttribute("disabled", true);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SlideShowEditDialog.js";

function SlideShowEditDialog() {
    Dialog.call(this);
    this.photoFileUploadView.dataUUID = "default";
    this.photoFileUploadView.dataType = "photosliders";
    this.genericContent.setContent("");
}
__extend(Dialog, SlideShowEditDialog);

SlideShowEditDialog.prototype.setupFontSize = function(fontSizeSelector) {
    fontSizeSelector.renderer = function (value) {
        return GeneralSettingDialog.TEXT_SIZE_MAP[value];
    };
    fontSizeSelector.comparer = Util.sameRelax;
    fontSizeSelector.setItems(GeneralSettingDialog.TEXT_SIZES);
}
SlideShowEditDialog.prototype.setupTextStyleActions = function(actionBar, key) {
    var selectFunction = function(action) {
        Dom.doOnSelector(actionBar.node(), ":scope button", function(button) {
            if (button._action && button._action.id == action.id) {
                Dom.toggleClass(button, "Active", !Dom.hasClass(button, "Active"));
            }
        });
    }
    actionBar.simple = true;
    actionBar.register({id: "bold", _bit: 2, getIcon: function() { return "format-bold"}, getTitle: function(){ return "Bold"}, run: function(){
        selectFunction(this);
    }});
    actionBar.register({id: "italic", _bit: 4, getIcon: function() { return "format-italic"}, getTitle: function(){ return "Italic"}, run: function(){
        selectFunction(this);
    }});
    actionBar.register({id: "underline",  _bit: 8, getIcon: function() { return "format-underline"}, getTitle: function(){ return "Underline"}, run: function(){
        selectFunction(this);
    }});
    actionBar.node().__key = key;
}

SlideShowEditDialog.prototype.onShown = function() {
    var thiz = this;
    $configurationService.getConfigValue("cms_download_stock_images_url", function(config) {
            var url = config ? config.stringValue : "";
            Dom.toggleClass(thiz.downloadStockImagesLink, "Active", url && url.length > 0 ? true : false);
            thiz.downloadStockImagesLink.href = url;
    });
}
SlideShowEditDialog.prototype.initTextStyle = function(actionBar, stylingMap) {
    var key = actionBar.node().__key;
    if (!key) return;
    var textStyle = stylingMap[key] || "";
    var v = textStyle.length > 0 ? parseInt(textStyle) : 0;
    Dom.doOnSelector(actionBar.node(), ":scope button", function(button) {
        var action = button._action;
        if (!action) return;
        Dom.toggleClass(button, "Active", (v & action._bit) != 0);
    });
}
SlideShowEditDialog.prototype.initTextStyleDefault = function(actionBar, id, selected) {
    Dom.doOnSelector(actionBar.node(), ":scope button.Action_" + id, function(button) {
        if (selected) {
            Dom.addClass(button, "Active");
        } else {
            Dom.removeClass(button, "Active");
        }
    });
}
SlideShowEditDialog.prototype.getTextStyle = function(actionBar) {
    var key = actionBar.node().__key;
    if (!key) return 0;
    var v = 0;
    Dom.doOnSelector(actionBar.node(), ":scope button", function(button) {
        var action = button._action;
        if (!action) return;
        if (Dom.hasClass(button, "Active")) {
            v = v | action._bit;
        }
    });
    return v;
}
SlideShowEditDialog.prototype.setup = function (photoSlider) {
    var thiz = this;
    this.title = photoSlider.id > 0 ? "Edit Slide" : "Add New Slide";
    this.photoSlider = photoSlider;
    var defaultColor = "#FFFFFF00";
    this.textColor.setDefaultColor(defaultColor);
    this.buttonColorInput.setDefaultColor(defaultColor);
    this.primaryTextColor.setDefaultColor(defaultColor);
    this.secondaryTextColor.setDefaultColor(defaultColor);
    this.contentBackgroundInput.setDefaultColor(defaultColor);
    this.orverlayBackgroundInput.setDefaultColor(defaultColor);

    var renderer = function (item) { return item.name; };
    this.hAlignCombo.comparer = this.vAlignCombo.comparer = Util.sameId;
    this.hAlignCombo.renderer = this.vAlignCombo.renderer = renderer;
    this.hAlignCombo.setItems(SizeOptionsWidget.HORIZONTAL_ALIGNS);
    this.vAlignCombo.setItems(SizeOptionsWidget.VERTICAL_ALIGNS);

    this.textAlignCombo.comparer = Util.sameId;
    this.textAlignCombo.renderer = renderer;
    this.textAlignCombo.setItems(SizeOptionsWidget.HORIZONTAL_ALIGNS);

    this.setupFontSize(this.primaryTextSizeCombo);
    this.setupFontSize(this.secondaryTextSizeCombo);
    this.setupFontSize(this.actionTextSizeCombo);

    this.setupTextStyleActions(this.primaryTextStyleActionBar, "primary_text_style");
    this.setupTextStyleActions(this.secondaryTextStyleActionBar, "secondary_text_style");
    this.setupTextStyleActions(this.actionTextStyleActionBar,  "action_button_text_style");

    if (this.photoSlider.id) {
        this.photoFileUploadView.setCommaSeparatedStoragePaths(photoSlider.imageSourcePath);
        this.displayCheckBox.checked = !photoSlider.draft;
        if(photoSlider.pageId) this.pageChooser.selectPage({id: photoSlider.pageId, title: photoSlider.pageTitle});
        else this.pageChooser.setUrl(photoSlider.url);
        this.selectOpenPolicy.setValueSelected(photoSlider.openPolicy, true);
        this.primaryText.value = photoSlider.primaryText || "";
        this.secondaryText.value = photoSlider.secondaryText || "";
        this.actionText.value = photoSlider.action || "";
        var stylingMap = photoSlider.stylingParameterMap || {};

        this.buttonColorInput.setRGBAHexColorString(stylingMap["action_button_color"] || "#FFFFFF00");
        this.textColor.setRGBAHexColorString(stylingMap["action_button_text_color"] || "#FFFFFF00");

        this.hAlignCombo.selectItemByKey("id", stylingMap["horizontal_align"] || "center");
        this.vAlignCombo.selectItemByKey("id", stylingMap["vertical_align"] || "center");
        this.textAlignCombo.selectItemByKey("id", stylingMap["text_align"] || "center");
        this.primaryTextColor.setRGBAHexColorString(stylingMap["primary_text_color"] || "#FFFFFF00");
        this.secondaryTextColor.setRGBAHexColorString(stylingMap["secondary_text_color"] || "#FFFFFF00");

        this.contentBackgroundInput.setRGBAHexColorString(stylingMap["content_background_color"] || "#FFFFFF00");
        this.orverlayBackgroundInput.setRGBAHexColorString(stylingMap["overlay_background_color"] || "#FFFFFF00");

        this.primaryTextSizeCombo.selectItem(stylingMap["primary_text_size"] || "default");
        this.secondaryTextSizeCombo.selectItem(stylingMap["secondary_text_size"] || "default");
        this.actionTextSizeCombo.selectItem(stylingMap["action_button_text_size"] || "default");

        this.contentWidth.value = (stylingMap["content_width"] || "100");

        var content = {html: photoSlider.genericContent || "", css: photoSlider.customCss || ""};
        this.genericContent.setContent(content);

        this.initTextStyle(this.primaryTextStyleActionBar, stylingMap);
        this.initTextStyle(this.secondaryTextStyleActionBar, stylingMap);
        this.initTextStyle(this.actionTextStyleActionBar, stylingMap);

    } else {
        this.hAlignCombo.selectItemByKey("id", "center");
        this.vAlignCombo.selectItemByKey("id", "center");
        this.textAlignCombo.selectItemByKey("id", "center");

        this.primaryTextSizeCombo.selectItem("default");
        this.secondaryTextSizeCombo.selectItem("default");
        this.actionTextSizeCombo.selectItem("default");

        //this.initTextStyleDefault(this.primaryTextStyleActionBar, "bold", true);
        //this.initTextStyleDefault(this.actionTextStyleActionBar, "bold", true);
        this.contentWidth.value = "100";
    }

    this.validationRules = new RuleSet()
        .live(true)
        .custom(new PatternMatchedRule(this.pageChooser, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid URL! Please check your input."), function(rule) {
            var page = rule.input.getSelectedPage();
            if (page) return "";
            var url = rule.input.getUrl();
            return url && url.length > 0 ? url : "";
        })
        .custom(new GenericRule(this.contentWidth, function() {
            var v = parseInt(thiz.contentWidth.value, 10);
            return v > 0 && v <= 100;
        }, "Please input valid number. Value must be from 1 to 100."))
        .required(this.photoFileUploadView, "Please select the thumbnail photo");
}

SlideShowEditDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                if (!ValidationManager.run(this.validationRules)) return;
                var photoSlider = {
                    imageSourcePath: this.photoFileUploadView.getCommaSeparatedStoragePaths().split(",")[0],
                    draft: !this.displayCheckBox.checked,
                    openPolicy: this.selectOpenPolicy.getValue()
                };
                if (this.pageChooser.getSelectedPage()) {
                    photoSlider.pageId = this.pageChooser.getSelectedPage().id;
                } else {
                    photoSlider.url = this.pageChooser.getUrl()
                };

                photoSlider.primaryText = this.primaryText.value.trim();
                photoSlider.secondaryText = this.secondaryText.value.trim();
                photoSlider.action = this.actionText.value.trim();
                photoSlider.genericContent = this.genericContent.getContent();
                photoSlider.customCss = this.genericContent.getContentStylesheet();
                var stylingMap = {};
                stylingMap["content_width"] = parseInt(this.contentWidth.value.trim());
                stylingMap["horizontal_align"] = this.hAlignCombo.getSelectedItem().id;
                stylingMap["vertical_align"] = this.vAlignCombo.getSelectedItem().id;
                stylingMap["text_align"] = this.textAlignCombo.getSelectedItem().id;

                stylingMap["action_button_text_color"] = this.textColor.getRGBAHexColorString();
                stylingMap["action_button_color"] = this.buttonColorInput.getRGBAHexColorString();
                stylingMap["action_button_text_size"] = this.actionTextSizeCombo.getSelectedItem();

                stylingMap["primary_text_color"] = this.primaryTextColor.getRGBAHexColorString();
                stylingMap["primary_text_size"] = this.primaryTextSizeCombo.getSelectedItem();

                stylingMap["secondary_text_color"] = this.secondaryTextColor.getRGBAHexColorString();
                stylingMap["secondary_text_size"] = this.secondaryTextSizeCombo.getSelectedItem();

                stylingMap["primary_text_style"] = this.getTextStyle(this.primaryTextStyleActionBar);
                stylingMap["secondary_text_style"] = this.getTextStyle(this.secondaryTextStyleActionBar);
                stylingMap["action_button_text_style"] = this.getTextStyle(this.actionTextStyleActionBar);
                stylingMap["content_background_color"] = this.contentBackgroundInput.getRGBAHexColorString();
                stylingMap["overlay_background_color"] = this.orverlayBackgroundInput.getRGBAHexColorString();
                photoSlider.stylingParameterMap = stylingMap;
                var thiz = this;
                var saveCallBack = function(){
                    thiz.savePhotoSlider(photoSlider, thiz.close.bind(thiz));
                };
                if (photoSlider.genericContent && photoSlider.genericContent.length > 0) {
                    CMSCommon.checkValidHtml(photoSlider.genericContent, saveCallBack);
                } else {
                    saveCallBack();
                }
                return false;
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
}

SlideShowEditDialog.prototype.savePhotoSlider = function (photoSlider, callback) {
    var thiz = this;

    if (!photoSlider.imageSourcePath) {
        Dialog.error("Please select upload image.");
        return;
    }
    if (this.photoSlider.id) {
        photoSlider.id = this.photoSlider.id;
        $cmsService.updatePhotoSlider(photoSlider, function (result) {
            callback(photoSlider);
        }, function (err) {
            console.log("Update PhotoSlider fail with Error: ", err);
        });
    } else {
        if (this.photoSlider.dataSetName) {
            photoSlider.dataSetName = this.photoSlider.dataSetName;
        }
        $cmsService.createPhotoSlider(photoSlider, function (result) {
            photoSlider.id = result;
            callback(photoSlider);
        }, function (err) {
            console.log("Create PhotoSlider fail with Error: ", err);
        });
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SlideShowSetting.js";

function SlideShowSetting() {
    var thiz = this;
    ComponentDetailDialog.call(this);
    this.photoRepeaterView.populator = function (data, binding, node, index) {
        Dom.setInnerText(binding.itemTitle, "Slide " + (index + 1));
        binding.imageView.setCenterCrop(false);
        binding.imageView.setUrl(data.imageSourcePath);
        var linkText = data.pageId ? data.pageTitle : data.url;
        if (linkText) {
            Dom.setInnerText(binding.linkTo, "Link To: " + linkText);
        }
        if (data.draft) {
            Dom.addClass(binding._node, "Draft");
        }
        binding._node._data = data;
    };
    this.bind("p:onAttached", this.setupReordering, this.photoRepeaterView.node());

    this.bind("click", function () {
        var item = {};
        var settings = thiz.propertiesWidget.getValue();
        item.dataSetName = settings["dataSetName"] || "";

        this.editPhotoSlider(item);

    }, this.addPhotoSlideButton);
    this.bind("click", this.registContentPageEvent, this.photoRepeaterView);
}
__extend(ComponentDetailDialog, SlideShowSetting);

SlideShowSetting.prototype.getDialogTitle = function() {
    return "Edit Photo Slideshow";
}
SlideShowSetting.prototype.onSettingsChanged = function(fromUser) {
    this.requestSliderList(null, fromUser);
}
SlideShowSetting.prototype.selectDataSet = function(name, push) {
    var e = this.propertiesWidget._editorsMap ? this.propertiesWidget._editorsMap["dataSetName"] : undefined;
    if (!e) return;
    var selectItem = null;
    if (typeof(name) == "string" && name.length > 0 && push) {
        var items = e.comboManager.items;
        var newDataSet = {key: name, value: name};
        selectItem = newDataSet;
        if (!e.comboManager.selectItemIfContains(selectItem)) {
            items.splice(items.length - 1, 0, selectItem);
            e.comboManager.setItems(items);
            e.comboManager.selectItem(selectItem, true);
        }
    } else {
        selectItem = {key: name || this.dataSetName || ""};
        e.comboManager.selectItemIfContains(selectItem)
    }
    e.fireChangeEvent(true);
}

SlideShowSetting.prototype.requestSliderList = function(forceReload, onSettingsChanged) {
    var thiz = this;
    var settings = thiz.propertiesWidget.getValue();
    var dataSetName = settings["dataSetName"];
    if (dataSetName == null && onSettingsChanged) {
        Dialog.prompt("Please input data set name:", "",  "Create", function(inputValue) {
            if (typeof(inputValue) == "undefined" || inputValue.length == 0) {
                thiz.selectDataSet("");
                return;
            }
            thiz.selectDataSet(inputValue, true);
        }, "Cancel", function() {
            thiz.selectDataSet("");
        });
        return;
    }
    if (typeof(this.dataSetName) != "undefined" && this.dataSetName == dataSetName  && !forceReload) {
        return;
    }
    this.dataSetName = dataSetName;
    $cmsService.getAllPhotoSlider(dataSetName, function(data) {
        var rs = data.result;
        thiz.photoRepeaterView.setItems(rs);
        var orders = {};
        for (var i = 0; i < rs.length; i ++) {
            orders[rs[i].id] = i;
        }
        thiz.invalidateSizing();
        thiz.setSnapshotInputValues(orders);
    }, function(err) {
        console.log("Get Photo Slider List Error:", err);
    });
}

SlideShowSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);
}

SlideShowSetting.prototype.editPhotoSlider = function(photoSlider) {
    var thiz = this;
    var slideShowEditDialog = new SlideShowEditDialog().callback(function(sliderItem) {
        if (sliderItem) {
            thiz.requestSliderList(true);
            thiz.signalDesignChanged();
        }
    });
    slideShowEditDialog.open(photoSlider);
}

SlideShowSetting.prototype.save = function(callback) {
    var thiz = this;
    var saveData = thiz.getItemIds();
    if (saveData.length == 0) {
        Dialog.error("Please add photo slide before saving!");
        return;
    }

    this.saveSettings(callback);

    var snapshot = this._snapshotInputValues || {};
    var curr = this.getCurrentInputValues() || {};
    var orderChanged = JSON.stringify(snapshot) !== JSON.stringify(curr);
    if (!orderChanged) return;
    $cmsService.updateSliderOrder(saveData, function(result) {
        if (result) {
            SnackBar.show("Sliders order are updated successfully.");
            thiz.signalDesignChanged();
            thiz.close();
        }
    }, function(err) {
        console.log("Update Slider order fail");
    });
}

SlideShowSetting.prototype.registContentPageEvent = function(event) {
    var thiz = this;
    var itemContainer = Dom.findUpwardForNodeWithData(event.target, "_data");
    var data = itemContainer._data;

    if (Dom.hasClass(event.target, "PublishButton")) {
        data.draft = false;
        $cmsService.updatePhotoSlider(data, function() {
            SnackBar.show("Slider is published.");
            Dom.removeClass(itemContainer, "Draft");
            thiz.signalDesignChanged();
        }, function(err) {
            console.log("Error:", err);
        });
    } else if (Dom.hasClass(event.target, "DraftButton")) {
        data.draft = true;
        $cmsService.updatePhotoSlider(data, function() {
            SnackBar.show("Slider is saved as Draft.");
            Dom.addClass(itemContainer, "Draft");
            thiz.signalDesignChanged();
        }, function(err) {
            console.log("Error:", err);
        });
    } else if (Dom.hasClass(event.target, "DeleteButton")) {
        var ids = thiz.getItemIds();
        var onlyOneItem = ids.length == 1;
        var dataSetName = data.dataSetName || "Default";
        Dialog.confirm("Would you like to remove this item?", onlyOneItem ? "Data set \'" + dataSetName + "\' will be no longer available!!!" : null,
            "Delete", function() {
                $cmsService.deletePhotoSlider(data.id, function() {
                    SnackBar.show("Slide item was deleted successfully.");
                    itemContainer.remove();
                    thiz.signalDesignChanged();
                }, function(err) {
                    console.log("Error:", err);
                });
            },
            "Cancel", function() {
                console.log("Cancel");
            });
    } else {
        if (data == null) return;
        this.editPhotoSlider(data);
    }
}
SlideShowSetting.prototype.getItemIds = function() {
    var saveData = [];
    var sliderList = Dom.findChildrenWithClass(this.photoRepeaterView.node(), "PhotoSliderItem");

    for (var i = 0; i < sliderList.length; i++ ) {
        var data = sliderList[i]._data;
        saveData.push(data.id);
    }
    return saveData;
}
SlideShowSetting.prototype.setupReordering = function () {
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
    .source(this.photoRepeaterView.node())
    .anchor(function (node) {
        return Dom.hasClass(node, "DragButton");
    })
    .itemInfo(function (anchor) {
        var item = Dom.findParentWithClass(anchor, "PhotoSliderItem");
        if (!item) return null;
        return {
            element: item,
            data: item._data
        };
    })
    .destination(this.photoRepeaterView.node())
    .canDrop(function (data) {
        return true;
    }
    .bind(this))
    .dropAt(dropTargetFinderFunction)
    .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "FileUploadViewDragImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        this.emitChangeEvent();
    }.bind(this);
};

SlideShowSetting.prototype.getCurrentInputValues = function() {
    var nodes = this.photoRepeaterView.node().childNodes;
    var orders = {};
    for (var i = 0; i < nodes.length; i++) {
        var n = nodes[i];
        var data = n._data;
        orders[data.id] = i;
    }
    return orders;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SocialLinksSetting.js";

function SocialLinksSetting() {
    ComponentDetailDialog.call(this);

    this.validationRules = new RuleSet().live(true);

    var that = this;
    this.menuItemRepeaterView.populator = function (data, binding, node) {
        var defaultCssClass = SocialLinksSetting.DEFAULT_CSS_CLASSES[data.type] || "";
        Dom.addClass(binding.linkItemIcon, defaultCssClass);
        binding.linkItemIcon.setAttribute("title", data.description || "");
        binding.linkItemUrl.value = data.url || "";

        binding._node._data = data;
        that.bindURLValidation(binding.linkItemUrl);
  	};

    this.hintBox.done = function() {
        setTimeout(function () {
            that.invalidateSizing();
        }, 100);
    };
}
__extend(ComponentDetailDialog, SocialLinksSetting);

SocialLinksSetting.DEFAULT_CSS_CLASSES = {
    "FACEBOOK": "facebook",
    "GOOGLE_PLUS": "google-plus",
    "TWITTER": "twitter",
    "INSTAGRAM": "instagram",
    "PINTEREST": "pinterest",
    "YOUTUBE": "youtube-play",
    "LINKEDIN": "linkedin",
    "TIKTOK": "music-note",
};

SocialLinksSetting.prototype.bindURLValidation = function(input) {
    this.validationRules.custom(new GenericRule(input, function(context) {
        var value = this.getValue();
        if (!value) return true;
        return value.toString().match(ValidationManager.patterns.URL_REGEX);
    }, "Invalid URL! Please check your input."));
};

SocialLinksSetting.prototype.postAsyncSetup = function(callback) {
    var that = this;
    $teamInfoService.getSocialLinks(function (data) {
        var rs = data && data.result;
        that.menuItemRepeaterView.setItems(rs, function () {
            if (callback) callback();
        });
        that.setSnapshotInputValues(rs);
    }, function(error) {
        SnackBar.show("Failed to load Social Links");
    });
};

SocialLinksSetting.prototype.getDialogTitle = function () {
    return "Edit Social Links";
};

SocialLinksSetting.prototype.onReady = function () {
    console.log("ready...");
    this.loadSettings(this.settingsContainer);
}

SocialLinksSetting.prototype.save = function(callback) {
    if (!ValidationManager.run(this.validationRules)) return;
    var links = this.getCurrentInputValues();
    var that = this;
    $teamInfoService.updateLinks(links, function (result) {
        if (callback) callback();
        that.signalDesignChanged();
        that.saveSettings();
    }, function(error) {
        SnackBar.show("Failed to update Social Links: " + error.message);
    }, this);
}

SocialLinksSetting.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};
SocialLinksSetting.prototype.getCurrentInputValues = function() {
    var nodes = this.menuItemRepeaterView.node().childNodes;
    var links = [];
    for (var i = 0; i < nodes.length; i++) {
        var n = nodes[i];
        var l = n._data;
        l.url = Dom.findChildWithClass(n, "Textbox").value;
        //For SOCIAL
        l.set = "SOCIAL";
        links.push(l);
    }
    return links;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/SwimAThonSetting.js";

function SwimAThonSetting() {
    ComponentDetailDialog.call(this);
    this.loadEventSetting();
}
__extend(ComponentDetailDialog, SwimAThonSetting);

SwimAThonSetting.prototype.getDialogTitle = function() {
    return "Fundraising Goal Settings";
}
SwimAThonSetting.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};
SwimAThonSetting.prototype.loadEventSetting = function() {
    var thiz = this;
    $cmsService.getActiveTUMoneyEventDetail(function(data) {
        thiz.eventId = data.id;
        thiz.firstLineItem.value = data.promo_line1 || "";
        thiz.secondLineItem.value = data.promo_line2 || "";
        thiz.thirdLineItem.value = data.promo_line3 || "" ;
        thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
    }, function() {
    });
}
SwimAThonSetting.prototype.getCurrentInputValues = function() {
    return {
        id: this.eventId,
        promoLine1: this.firstLineItem.value,
        promoLine2: this.secondLineItem.value,
        promoLine3: this.thirdLineItem.value
    }
}

SwimAThonSetting.prototype.save = function(callback) {
    var thiz = this;
    $cmsService.saveTeamEventData(this.getCurrentInputValues(), function(result) {
        SnackBar.show("SwimAThon Setting save successfully.");
        if (callback) callback(result);
        thiz.signalDesignChanged();
    }, function(err) {
        if (callback) callback(err);
    });
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamFeedSetting.js";

function TeamFeedSetting() {
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, TeamFeedSetting);

TeamFeedSetting.prototype.onReady = function() {
    var msg = this.hintBox.getMessage();
    msg = msg ? msg.replace("{TEAM_FEED}",
    CMSCommon.getString(this.componentInfo.componentType, this.componentInfo.componentName || "TeamFeed")) : "";
    this.hintBox.setMessage(msg);
    this.loadSettings(this.settingsContainer);
};

TeamFeedSetting.prototype.save = function(callback) {
    this.saveSettings(callback);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamLevelSetting.js";

function TeamLevelSetting() {
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, TeamLevelSetting);


TeamLevelSetting.prototype.postAsyncSetup = function(callback) {
    var that = this;
    $teamInfoService.getTeamLevel(function (data) {
        if (data) {
            that.propertyContainer.setSchemas(data);
            that.propertyContainer.setup();
            that.setSnapshotInputValues(that.propertyContainer.getValue());

            setTimeout(function () {
                that.invalidateSizing();
            }, 100);
        }

        if (callback) callback();
    }, function(error) {
        SnackBar.show("Failed to load Team Level");
    });
}

TeamLevelSetting.prototype.getDialogTitle = function () {
    return "Edit Team Level";
};

TeamLevelSetting.prototype.save = function(callback) {
    var that = this;

    $teamInfoService.updateTeamLevel(this.getCurrentInputValues(), function (result) {
        if (callback) callback();
        that.signalDesignChanged();
    }, function(error) {
        SnackBar.show("Failed to update Team Level");
    }, this);
}

TeamLevelSetting.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};
TeamLevelSetting.prototype.getCurrentInputValues = function() {
    return this.propertyContainer.getValue();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamLinkEditDialog.js";

function TeamLinkEditDialog() {
    ComponentDetailDialog.call(this);
    this.item = {};

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.labelInput, "It's a required field")
        .custom(new PatternMatchedRule(this.pageChooser, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid URL! Please check your input."), function(rule) {
            var page = rule.input.getSelectedPage();
            if (page) return "";
            var url = rule.input.getUrl();
            return url && url.length > 0 ? url : undefined;
        });
}
__extend(ComponentDetailDialog, TeamLinkEditDialog);

TeamLinkEditDialog.prototype.getDialogTitle = function () {
    var str = this.item && this.item.id ? "Edit" : "Add";
    return str + " Utility Link";
};

TeamLinkEditDialog.prototype.setValue = function(link) {
    if (!link) {
        // create a default model
        link = {
            "description": "",
            "url": "",
            "linkedPage": {
                "id": 0
            },
            "targetMode": "SameWindow",
            "hidden": false
        };
    } else {
        // normalize
        link.url = link.url || "";
        link.linkedPage = link.linkedPage || { id: 0 };
    }

    this.item = link;
    this.registerUnsavedChanges(false);

    this.labelInput.value = this.item.description;

    if (this.item.linkedPage.id) {
        var selectedPage = {id : this.item.linkedPage.id, title: this.item.linkedPage.title};
        this.pageChooser.selectPage(selectedPage);
    } else if (this.item.url) {
        this.pageChooser.setUrl(this.item.url);
    }
    this.targetMode.setValueSelected(this.item.targetMode, true);

    this.setSnapshotInputValues(this.item);
    this.registerUnsavedChanges(true);
}

TeamLinkEditDialog.prototype.save = function(callback) {
    if (!ValidationManager.run(this.validationRules)) return;

    this.item = this.getCurrentInputValues();
    var that = this;

    var onSuccess = function(result) {
        if (callback) callback();
        that.signalDesignChanged();
    };
    var onError = function(error) {
        SnackBar.show("Failed to save Utility Link: " + error.message);
    };
    if (this.item.id) {
        var links = [this.item];
        $teamInfoService.updateLinks(links, onSuccess, onError);
    } else {
        $teamInfoService.addUtilityLink(this.item, onSuccess, onError);
    }
};

TeamLinkEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};
TeamLinkEditDialog.prototype.getCurrentInputValues = function() {
    var model = JSON.parse(JSON.stringify(this.item));

    model.description = this.labelInput.value;
    model.targetMode = this.targetMode.getValue();
    var selectedPage = this.pageChooser.getSelectedPage();
    if (!selectedPage) model.url = this.pageChooser.getUrl();
    model.linkedPage.id = selectedPage ? selectedPage.id : 0;

    return model;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamLinksSetting.js";

function TeamLinksSetting() {
    ComponentDetailDialog.call(this);
    this.openEditDialogEventBinded = false;

    var that = this;
    this.menuItemRepeaterView.populator = function (data, binding, node, index) {
        if (data.hidden) Dom.addClass(binding._node, "Draft");
        binding.linkName.innerHTML = data.description;
        binding._node._data = data;
  	};

    this.bind("click", function(event) {
        that.openEditDialog();
    }, this.addNewButton);

    this.bind("click", function(event) {
        var target = Dom.getTarget(event);
        var link = that._findUpwardLinkData(target);

        if (Dom.hasClass(event.target, "PublishButton")) {
            Dialog.confirm("Do you want to show this item?", link.description, "Show", function(){
                $teamInfoService.updateLinkVisibility(link.id, true, function (result) {
                    that.loadData();
                    that.signalDesignChanged();
                }, function(error) {
                }, that);
            },
            "Cancel", function() {}, null, null);

        } else if (Dom.hasClass(event.target, "DraftButton")) {
            Dialog.confirm("Do you want to hide this item?", link.description, "Hide", function(){
                $teamInfoService.updateLinkVisibility(link.id, false, function (result) {
                    that.loadData();
                    that.signalDesignChanged();
                }, function(error) {
                }, that);
            },
            "Cancel", function() {}, null, null);

        } else if (Dom.hasClass(target, "DeleteButton")) {
            Dialog.confirm("Delete this item?", link.description,
            "Delete", function() {
                that.delete(link);
            },
            "Cancel", function() {},
            null, null);
        } else {
            that.openEditDialog(link);
        }
    }, this.menuItemRepeaterView);

    this.bind("p:onAttached", this.setupReordering, this.menuItemRepeaterView.node());
}
__extend(ComponentDetailDialog, TeamLinksSetting);
TeamLinksSetting.LINK_NODE_CLASS = "UtilityLink";

TeamLinksSetting.prototype._findUpwardLinkData = function(target) {
    var node = Dom.findParentWithClass(target, TeamLinksSetting.LINK_NODE_CLASS);
    return node === void 0 ? {} : node._data;
};

TeamLinksSetting.prototype.setupReordering = function () {
    var that = this;

    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER();
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target) return null;
        return target;
    }.bind(this);

    this.dnd = new DragAndDropManager()
                .source(this.menuItemRepeaterView.node())
                .anchor(function (dragNode) {
                    return Dom.hasClass(dragNode, "DragButton");
                })
                .itemInfo(function (dragNode) {
                    var node = Dom.findParentWithClass(dragNode, TeamLinksSetting.LINK_NODE_CLASS);
                    if (!node) return null;
                    return {
                        element: node,
                        data: node._data
                    };
                })
                .destination(this.menuItemRepeaterView.node())
                .canDrop(function (data) {
                    return true;
                }.bind(this))
                .dropAt(dropTargetFinderFunction)
                .setup();
    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "DraggableItemImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        var node =  Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
        return node;
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        this.emitChangeEvent();
    }.bind(this);
};

TeamLinksSetting.prototype.postAsyncSetup = function(callback) {
    this.loadData(callback);
};

TeamLinksSetting.prototype.loadData = function(callback) {
    var that = this;
    if (typeof(callback) !== "function") {
        callback = this.invalidateSizing.bind(this);
    }
    $teamInfoService.getUtilityLinks(function (data) {
        var rs = data && data.result;
        that.menuItemRepeaterView.setItems(rs, function () {
            if (typeof(callback) === "function") callback();
        });

        var orders = {};
        for (var i = 0; i < rs.length; i ++) {
            orders[rs[i].id] = i;
        }
        that.setSnapshotInputValues(orders);

    }, function(error) {
        SnackBar.show("Failed to load Utility Links");
    });
};

TeamLinksSetting.prototype.getDialogTitle = function () {
    return "Edit Utility Links";
};

TeamLinksSetting.prototype.save = function(callback) {
    var orders = this.getCurrentInputValues();

    var that = this;
    $teamInfoService.updateLinkOrders(orders, function (result) {
        if (callback) callback();
        that.signalDesignChanged();
    }, function(error) {
        SnackBar.show("Failed to update Utility Links: " + error.message);
    }, this);
};
TeamLinksSetting.prototype.getCurrentInputValues = function() {
    var nodes = this.menuItemRepeaterView.node().childNodes;
    var orders = {};
    for (var i = 0; i < nodes.length; i++) {
        var n = nodes[i];
        var l = n._data;
        orders[l.id] = i;
    }
    return orders;
};

TeamLinksSetting.prototype.openEditDialog = function(link) {
    var dialog = new TeamLinkEditDialog();
    dialog.setValue(link);
    dialog.open();

    if (!this.openEditDialogEventBinded) {
        this.bind(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, this.loadData, window.currentWebDesignFeature.node());
        this.openEditDialogEventBinded = true;
    }
};

TeamLinksSetting.prototype.delete = function(link) {
    var that = this;
    $teamInfoService.deleteLink(link.id, function (result) {
        that.loadData();
        that.signalDesignChanged();
    }, function(error) {
        SnackBar.show("Failed to delete Utility Links: " + error.message);
    }, this);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamLogoGenerateYMCADialog.js";

function TeamLogoGenerateYMCADialog() {
    Dialog.call(this);

    this.title = "Generate YMCA Logo";
    
    this.colorCombo.renderer = function (variation) {
        return variation.name;
    };
    this.colorCombo.comparer = function (a, b) {
        return a.key == b.key;
    };
    
    this.colorCombo.setItems(TeamLogoGenerateYMCADialog.VARIATIONS);
    
}
__extend(Dialog, TeamLogoGenerateYMCADialog);

TeamLogoGenerateYMCADialog.VARIATIONS = [
    {key: "teal", name: "Teal"},
    {key: "blue", name: "Blue"},
    {key: "purple", name: "Purple"},
    {key: "red", name: "Red"},
    {key: "orange", name: "Orange"}
];

TeamLogoGenerateYMCADialog.prototype.getDialogActions = function () {
    return [
        {
            type: "accept", title: "Generate",
            run: function () { this.generate(); return false; }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

TeamLogoGenerateYMCADialog.prototype.setup = function (options) {
    if (options) {
        this.ymcaNameInput.value = (options.ymcaName || "YMCA").toUpperCase();
        this.teamNameInput.value = (options.teamName || ADMIN_CONTEXT.teamName).toUpperCase();
        this.colorCombo.selectItemByKey("key", options.color || TeamLogoGenerateYMCADialog.VARIATIONS[0].key);
        this.useWhiteCheckbox.checked = (options.useWhiteMobile ? true : false);
    }
};

TeamLogoGenerateYMCADialog.prototype.generate = function () {
    var result = {
        color: this.colorCombo.getSelectedItem().key,
        ymcaName: this.ymcaNameInput.value.trim().toUpperCase(),
        teamName: this.teamNameInput.value.trim().toUpperCase(),
        useWhiteMobile: this.useWhiteCheckbox.checked
    };
    
    var thiz = this;
    $teamInfoService.generateYMCALogo(result.color, result.teamName, result.ymcaName, result.useWhiteMobile,
        function (pair) {
            result.resourcePath = pair.primary;
            result.mobileResourcePath = pair.secondary;
            thiz.close(result);
        }, this);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamLogoSetting.js";

function TeamLogoSetting() {
    ComponentDetailDialog.call(this);

    this.photoFileUploadView.dataUUID = "default";
    this.photoFileUploadView.dataType = "team-logo";

    this.mobileLogoUploadView.dataUUID = "mobile";
    this.mobileLogoUploadView.dataType = "team-logo";

    this.emailLogoUploadView.dataUUID = "email";
    this.emailLogoUploadView.dataType = "team-logo";

    this.validationRules = new RuleSet()
        .live(true)
        .custom(new RequiredRule(this.photoFileUploadView, "Please upload the team logo"))
        .custom(new PatternMatchedRule(this.pageChooser, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid URL! Please check your input."), function(rule) {
            var page = rule.input.getSelectedPage();
            if (page) return "";
            var url = rule.input.getUrl();
            return url && url.length > 0 ? url : "";
        });

    this.bind("click", this.generateYMCALogo, this.generateYMCALogoButton);
}
__extend(ComponentDetailDialog, TeamLogoSetting);

TeamLogoSetting.prototype.postAsyncSetup = function(callback) {
    var thiz = this;
    $teamInfoService.getYMCATeamInfo(function (ymcaInfo) {
        if (ymcaInfo.ymcateam || ymcaInfo.regionTeam || ymcaInfo.yusateam) {
            Dom.addClass(thiz.dialogContentNode, "YMCAEnabled");
        }
        $teamInfoService.getTeamLogo(
            function(info){
                thiz._render(info);
                if (callback) callback();
             }, function(error) {
            SnackBar.show("Failed to load Team Logo");
        });
    });
};

TeamLogoSetting.prototype.generateYMCALogo = function() {
    var thiz = this;
    new TeamLogoGenerateYMCADialog().callback(function (result) {
        if (result && result.resourcePath) {
            thiz.lastYMCALogoSettings = result;

            thiz.photoFileUploadView.setCommaSeparatedStoragePaths(result.resourcePath);
            if (result.mobileResourcePath) thiz.mobileLogoUploadView.setCommaSeparatedStoragePaths(result.mobileResourcePath);

            thiz.emitChangeEvent();
        }
    }).open(this.lastYMCALogoSettings || this.settings);
};

TeamLogoSetting.prototype._render = function(info) {
    this.info = info || {};
    this.info.logoUrl = this.info.logoUrl || "";
    this.info.alternateText = this.info.alternateText || "";
    this.info.linkedPage = this.info.linkedPage || {id: 0};
    this.info.url = this.info.url || "";
    this.info.targetMode = this.info.targetMode || "SameWindow";
    var os = this.photoFileUploadView.getFirstImageSize();
    var settings = this.settings;
    settings.alternateText = this.info.alternateText || "";
    //this.sizingOptions.setValue(this.photoFileUploadView, this.settings);
    var options = {
        showAllowedCheckboxs: false,
        tablet: false,
        phone: false,
        desktop: true,
        absoluteText: "Specify exact sizes for image to display on desktop."
    };
    this.sizingOptions.setValue(this.photoFileUploadView, settings, options);
    this.sizingOptions.render();
    this.registerUnsavedChanges(false);
    //this.alternateInput.value = this.info.alternateText;

    var url = this.info.logoUrl;
    if (url && url.length > 0) this.photoFileUploadView.setCommaSeparatedStoragePaths(url);

    url = this.info.mobileLogoUrl;
    if (url && url.length > 0) this.mobileLogoUploadView.setCommaSeparatedStoragePaths(url);

    url = this.info.emailLogoUrl;
    if (url && url.length > 0) this.emailLogoUploadView.setCommaSeparatedStoragePaths(url);

    if (this.info.linkedPage.id) {
        var selectedPage = {id : this.info.linkedPage.id, title: this.info.linkedPage.title};
        this.pageChooser.selectPage(selectedPage);
    } else if (this.info.url) {
        this.pageChooser.setUrl(this.info.url);
    }
    delete this.settings.alternateText;
    this.targetMode.setValueSelected(this.info.targetMode, true);
    this.setSnapshotInputValues({info: this.info, settings: this.settings});
    this.registerUnsavedChanges(true);
    this.invalidateSizing();
};

TeamLogoSetting.prototype.getDialogTitle = function () {
    return "Edit Team Logo";
};

TeamLogoSetting.prototype.save = function(callback) {
    if (!ValidationManager.run(this.validationRules)) return;
    var thiz = this;
    var data = this.getCurrentInputValues();

    $teamInfoService.updateTeamLogo(data.info, function (result) {
        if (callback) callback();
        $cmsService.saveSettings(
            thiz.componentInfo.componentId, thiz.componentInfo.componentType, data.settings,
            function() {}, function() {}
        );
        thiz.signalDesignChanged();
        if (NavigationDrawer.instance) {
            NavigationDrawer.instance.loadTeamLogo();
        }
    }, function(error) {
        SnackBar.show("Failed to update Team Logo: " + error.message);
    });
}

TeamLogoSetting.prototype.getChangeEventNames = function () {
    return [FileUploadView.FILE_CHANGE_EVENT_NAME].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES);
};
TeamLogoSetting.prototype.getCurrentInputValues = function() {
    var model = JSON.parse(JSON.stringify(this.info));
    //model.alternateText = this.alternateInput.value.trim();
    model.logoUrl = this.photoFileUploadView.getCommaSeparatedStoragePaths() || "";
    model.mobileLogoUrl = this.mobileLogoUploadView.getCommaSeparatedStoragePaths() || "";
    model.emailLogoUrl = this.emailLogoUploadView.getCommaSeparatedStoragePaths() || "";
    model.targetMode = this.targetMode.getValue();
    var selectedPage = this.pageChooser.getSelectedPage();
    if (!selectedPage) model.url = this.pageChooser.getUrl();
    model.linkedPage.id = selectedPage ? selectedPage.id : 0;
    var settings = this.sizingOptions.getValue();
    model.alternateText = settings.alternateText;
    delete settings.alternateText;
    //return {info: model, settings: this.sizingOptions.getValue()};
    if (this.lastYMCALogoSettings) {
        settings.teamName = this.lastYMCALogoSettings.teamName;
        settings.ymcaName = this.lastYMCALogoSettings.ymcaName;
        settings.color = this.lastYMCALogoSettings.color;
        settings.useWhiteMobile = this.lastYMCALogoSettings.useWhiteMobile;
    };

    return {info: model, settings: settings};
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamPartnerEditDialog.js";

function TeamPartnerEditDialog() {
    ComponentDetailDialog.call(this);

    this.customTitle = "Sponsors & Partners";
    this.item = {};

    this.photoFileUploadView.dataUUID = "default";
    this.photoFileUploadView.dataType = "partners-sponsors";
    this._imageViewInitialed = false;
    this._htmlEditorInitialed = false;

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.name, "It's a required input")
        ;
    this.logoValidationRules = new RuleSet()
        .live(true)
        .required(this.photoFileUploadView, "It's a required input")
        .custom(new PatternMatchedRule(this.pageChooser, ValidationManager.patterns.RELATIVE_URL_REGEX, "Invalid URL! Please check your input."), function(rule) {
            var page = rule.input.getSelectedPage();
            if (page) return "";
            var url = rule.input.getUrl();
            return url && url.length > 0 ? url : "";
        });
    this.htmlValidationRules = new RuleSet()
        .live(true)
        .required(this.htmlEditor, "It's a required input")
        ;

    this.bind("p:ValueChanged", this.switchContent, this.useHTMLEditor.node());
}
__extend(ComponentDetailDialog, TeamPartnerEditDialog);

TeamPartnerEditDialog.prototype.getDialogTitle = function () {
    var str = this.item && this.item.id ? "Edit" : "Add";
    return str + " " + this.customTitle;
};

TeamPartnerEditDialog.prototype.setValue = function(item, customTitle) {
    if (customTitle) this.customTitle = customTitle;
    if (!item) {
        // create a default model
        item = {
            name: "",
            logoUrl: "",
            url: "",
            linkedPage: {
                id: 0
            },
            targetMode: "SameWindow",
            useHTML: false,
            html: ""
        };
    } else {
        // normalize
        item.url = item.url || "";
        item.linkedPage = item.linkedPage || { id: 0 };
        item.html = item.html || "";
    }

    this.item = item;
    this.setSnapshotInputValues(item);
}

TeamPartnerEditDialog.prototype.postAsyncSetup = function(callback) {
    if (callback) callback();

    this.registerUnsavedChanges(false);

    this.name.value = this.item.name;

    this.useHTMLEditor.setRefSchema({"displayName": "Use HTML"});
    this.useHTMLEditor.setValue(this.item.useHTML);
    this.useHTMLEditor.render();

    if (this.item.linkedPage.id) {
        var selectedPage = {id : this.item.linkedPage.id, title: this.item.linkedPage.title};
        this.pageChooser.selectPage(selectedPage);
    } else if (this.item.url) {
        this.pageChooser.setUrl(this.item.url);
    }
    this.targetMode.setValueSelected(this.item.targetMode, true);

    this.switchContent();
    this.registerUnsavedChanges(true);
};

TeamPartnerEditDialog.prototype.switchContent = function() {
    if (this.useHTMLEditor.getValue()) {
        Dom.addClass(this.switchContainer, "UseHTML");
        this._ensureRichEditorInitialized();
    } else {
        Dom.removeClass(this.switchContainer, "UseHTML");
        this._ensureImageViewInitialized();
    }

    this.invalidateSizing();
};
TeamPartnerEditDialog.prototype._ensureRichEditorInitialized = function() {
    if (this._htmlEditorInitialed) return;

    if (this.item.html && this.item.html.length) {
        this.htmlEditor.value = this.item.html;
    }
    this._htmlEditorInitialed = true;
};
TeamPartnerEditDialog.prototype._ensureImageViewInitialized = function() {
    if (this._imageViewInitialed) return;

    if (this.item.logoUrl && this.item.logoUrl.length) {
        this.photoFileUploadView.setCommaSeparatedStoragePaths(this.item.logoUrl);
    }
    this._imageViewInitialed = true;
};

TeamPartnerEditDialog.prototype.save = function(callback) {
    var model = this.getCurrentInputValues();
    if (!ValidationManager.run(this.validationRules)) return;
    if (model.useHTML) {
        if (!ValidationManager.run(this.htmlValidationRules)) return;
    } else {
        if (!ValidationManager.run(this.logoValidationRules)) return;
    }

    this.item = model;

    var that = this;
    var onSuccess = function(result) {
        if (callback) callback();
        that.signalDesignChanged();
    };
    var onError = function(error) {
        SnackBar.show("Failed to save Team Partner-Sponsor: " + error.message);
    };
    if (this.item.id) {
        var items = [this.item];
        $teamInfoService.updateTeamPartners(items, onSuccess, onError);
    } else {
        $teamInfoService.addTeamPartner(this.item, onSuccess, onError);
    }
};

TeamPartnerEditDialog.prototype.getChangeEventNames = function() {
    return [FileUploadView.FILE_CHANGE_EVENT_NAME, RichTextEditor.TEXT_CHANGE_EVENT_NAME].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES);
};
TeamPartnerEditDialog.prototype.getCurrentInputValues = function() {
    var model = JSON.parse(JSON.stringify(this.item));

    model.name = this.name.value;
    model.useHTML = this.useHTMLEditor.getValue();
    if (model.useHTML) {
        model.html = this.htmlEditor.value;
    } else {
        model.logoUrl = this.photoFileUploadView.getCommaSeparatedStoragePaths();
        model.targetMode = this.targetMode.getValue();
        var selectedPage = this.pageChooser.getSelectedPage();
        if (!selectedPage) model.url = this.pageChooser.getUrl();
        model.linkedPage.id = selectedPage ? selectedPage.id : 0;
    }

    return model;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamPartnersSetting.js";

function TeamPartnersSetting() {
    ComponentDetailDialog.call(this);
    this.openEditDialogEventBinded = false;

    var that = this;
    this.hintBox.done = function() {
        setTimeout(function () {
            that.invalidateSizing();
        }, 100);
    };

    this.menuItemRepeaterView.populator = function (data, binding, node, index) {
        if (data.hidden) Dom.addClass(binding._node, "Draft");
        binding.name.innerHTML = data.name;
        var url = data.linkedPage ? data.linkedPage.title : data.url;
        if(url) {
            binding.link.innerHTML = url;
            Dom.addClass(binding.itemView, "HasLink");
        }
        if(data.useHTML) {
            binding.itemHTML.innerHTML = data.html;
            Dom.addClass(binding.itemView, "UseHTML");
        } else if(data.logoUrl) {
            binding.itemLogo.setUrl(data.logoUrl);
            Dom.addClass(binding.itemView, "HasLogo");
        }
        binding._node._data = data;
  	};

    this.bind("click", function(event) {
        that.openEditDialog();
    }, this.addNewButton);

    this.bind("click", function(event) {
        var target = Dom.getTarget(event);
        var item = that._findUpwardLinkData(target);

        if (Dom.hasClass(event.target, "PublishButton")) {
            Dialog.confirm("Do you want to show this item?", item.name, "Show", function(){
                $teamInfoService.updateTeamPartnerVisibility(item.id, true, function (result) {
                    that.loadData();
                    that.signalDesignChanged();
                }, function(error) {
                }, that);
            },
            "Cancel", function() {}, null, null);

        } else if (Dom.hasClass(event.target, "DraftButton")) {
            Dialog.confirm("Do you want to hide this item?", item.name, "Hide", function(){
                $teamInfoService.updateTeamPartnerVisibility(item.id, false, function (result) {
                    that.loadData();
                    that.signalDesignChanged();
                }, function(error) {
                }, that);
            },
            "Cancel", function() {}, null, null);

        } else if (Dom.hasClass(target, "DeleteButton")) {
            Dialog.confirm("Delete this item?", item.name,
            "Delete", function() {
                that.delete(item);
            },
            "Cancel", function() {},
            null, null);
        } else {
            that.openEditDialog(item);
        }
    }, this.menuItemRepeaterView);

    this.bind("p:onAttached", this.setupReordering, this.menuItemRepeaterView.node());
}
__extend(ComponentDetailDialog, TeamPartnersSetting);

TeamPartnersSetting.LINK_NODE_CLASS = "Entry";

TeamPartnersSetting.prototype._findUpwardLinkData = function(target) {
    var node = Dom.findParentWithClass(target, TeamPartnersSetting.LINK_NODE_CLASS);
    return node === void 0 ? {} : node._data;
};
TeamPartnersSetting.prototype.getChangeEventNames = function () {
    return [ModificationWatchDialog.DEFAULT_CHANGE_EVENT_NAME, "p:ValueChanged", "input", "p:ItemSelected"];
};

TeamPartnersSetting.prototype.setupReordering = function () {
    var that = this;

    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER();
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target) return null;
        return target;
    }.bind(this);

    this.dnd = new DragAndDropManager()
                .source(this.menuItemRepeaterView.node())
                .anchor(function (dragNode) {
                    return Dom.hasClass(dragNode, "DragButton");
                })
                .itemInfo(function (dragNode) {
                    var node = Dom.findParentWithClass(dragNode, TeamPartnersSetting.LINK_NODE_CLASS);
                    if (!node) return null;
                    return {
                        element: node,
                        data: node._data
                    };
                })
                .destination(this.menuItemRepeaterView.node())
                .canDrop(function (data) {
                    return true;
                }.bind(this))
                .dropAt(dropTargetFinderFunction)
                .setup();
    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "DraggableItemImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        var node =  Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
        return node;
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }

        this.emitChangeEvent();

    }.bind(this);
};

TeamPartnersSetting.prototype.postAsyncSetup = function(callback) {
    this.loadData(callback);
};
TeamPartnersSetting.prototype.loadData = function(callback) {
    var that = this;
    if (typeof(callback) !== "function") {
        callback = this.invalidateSizing.bind(this);
    }
    $teamInfoService.getTeamPartners(function (data) {
        var rs = data && data.result;
        that.menuItemRepeaterView.setItems(rs, function () {
            if (typeof(callback) === "function") callback();
        });

        var orders = {};
        for (var i = 0; i < rs.length; i ++) {
            orders[rs[i].id] = i;
        }
        that.setSnapshotInputValues(orders);
        that.emitChangeEvent(); // recheck unsaved changes

    }, function(error) {
        SnackBar.show("Failed to load Sponsors & Partners");
    });
};

TeamPartnersSetting.prototype.getDialogTitle = function () {
    return "Edit Sponsors & Partners";
};
TeamPartnersSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);

    // Update dialog title
    this.title = this.getDialogTitle();
    Dom.empty(this.dialogTitle);
    this.dialogTitle.appendChild(document.createTextNode(this.e(this.title)));
}

TeamPartnersSetting.prototype.save = function(callback) {
    var that = this;
    this.saveSettings(function() {
        var orders = that.getCurrentInputValues();
        if (!ModificationWatchDialog.prototype.hasInputValuesChanged.call(that, orders)) {
            if (callback) {
                callback();
            }
            that.signalDesignChanged();
            return;
        }
        $teamInfoService.updateTeamPartnerOrders(orders, function (result) {
            if (callback) callback();
            that.signalDesignChanged();
        }, function(error) {
            SnackBar.show("Failed to update Sponsors & Partners: " + error.message);
        }, that);
    });
};
TeamPartnersSetting.prototype.getCurrentInputValues = function() {
    var nodes = this.menuItemRepeaterView.node().childNodes;
    var orders = {};
    for (var i = 0; i < nodes.length; i++) {
        var n = nodes[i];
        var l = n._data;
        orders[l.id] = i;
    }
    return orders;
};

TeamPartnersSetting.prototype.openEditDialog = function(item) {
    var dialog = new TeamPartnerEditDialog();
    dialog.setValue(item);
    dialog.open();

    if (!this.openEditDialogEventBinded) {
        this.bind(AdminWebsiteDesign.DESIGN_CHANGED_EVENT, this.loadData, window.currentWebDesignFeature.node());
        this.openEditDialogEventBinded = true;
    }
};

TeamPartnersSetting.prototype.delete = function(item) {
    var that = this;
    $teamInfoService.deleteTeamPartner(item.id, function (result) {
        that.loadData();
        that.signalDesignChanged();
    }, function(error) {
        SnackBar.show("Failed to delete Sponsors & Partners: " + error.message);
    }, this);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TeamSettingsSetting.js";

function TeamSettingsSetting() {
    ModificationWatchDialog.call(this);
    this.hasDesignChangeEvent = false;
}
__extend(ComponentDetailDialog, TeamSettingsSetting);

TeamSettingsSetting.prototype.asyncSetup = function (data, callback) {
    this.componentInfo = data;
    this.title = data.title || "";
    this.loadSettings(this.settingContainer);
    if (data.data && data.data.settingKey) {
        Dom.addClass(this.settingContainer, "SystemPage" + data.data.settingKey.toUpperCaseAt(0));
    }
    callback();
};
TeamSettingsSetting.prototype.save = function (callback) {
    this.saveSettings(callback);
}
TeamSettingsSetting.prototype.getSettingsValue = function(callback) {
    $settingsService.getSettings(this.componentInfo.data.settingKey, function(results){
        callback(results);
    }, function(e){});
}
TeamSettingsSetting.prototype.loadSettingSchemas = function(callback) {
    $settingsService.getSettingSchemas(this.componentInfo.data.settingKey, function(results){
        callback(results);
    }, function(e){});
}
TeamSettingsSetting.prototype.saveSettingsImpl = function(values, callback) {
    var thiz = this;
    var schemas = this.propertiesWidget.schemas;
    var save = function () {
        $settingsService.saveSettings(thiz.componentInfo.data.settingKey, values, function(results) {
            callback();
            thiz.signalDesignChanged();
        }, function(e){});
    };
    var html = "";
    schemas.forEach(function(schema){
        if (schema.type == "Html") {
            html += values[schema.name] + " ";
        }
    });
    if (html) {
        HTMLWarningDialog.invalidateHtml(html, save);
    } else {
        save();
    }
}

function TeamSettings_start(componentInfo, callback) {
    componentInfo.componentType = "TeamSettings";
    componentInfo.title = componentInfo.data.title || "";
    ComponentDetailDialog.open(componentInfo, callback);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/TwitterFeedSetting.js";

function TwitterFeedSetting() {
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, TwitterFeedSetting);

TwitterFeedSetting.prototype.getDialogTitle = function () {
    return "Twitter Timeline Setting";

};

TwitterFeedSetting.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

TwitterFeedSetting.prototype.onReady = function () {
    this.loadSettings(this.settingsContainer);
    this.propertiesWidget.onRenderEditorFinished = function () {
        PropertiesWidget.prototype.onRenderEditorFinished.call(this);
        var colorEditor = this._editorsMap["color"];
        if (colorEditor) {
            colorEditor.comboManager.renderer = function (variant) {
                return Dom.newDOMElement({
                    _name: "span",
                    "class": "TwitterFeed_Link_Color",
                    _children: [
                        {_name: "span", "class": "Color", style: "background-color: " + (variant.key || "transparent")},
                        {_name: "span", "class": "Name", _text: variant.key}
                    ]
                });
            };
            colorEditor.comboManager.useHtml = true;
            var items = colorEditor.comboManager.items;
            var selected = colorEditor.comboManager.getSelectedItem();
            colorEditor.comboManager.setItems(items);
            if (selected) {
                colorEditor.comboManager.selectItemIfContains(selected);
            }
        }
        var linkEditor =  this._editorsMap["twitterLinks"];
        if (linkEditor) {
            var input = linkEditor.textInput;
            var newNode = Dom.newDOMElement({
                _name: "hbox",
                class: "EditorInput",
                _children: [
                    {_name: "span", class: "Prefix", _html: "https://twitter.com/"},
                ]
            });
            newNode.appendChild(input.node());
            Dom.insertBefore(newNode, linkEditor.multilineTextInput);
        }
        var widthEditor = this._editorsMap["width"];
        if (widthEditor && typeof(this.valuesMap["width"]) == "undefined") {
            widthEditor.numberInput.value = "";
        }
        var heightEditor = this._editorsMap["height"];
        if (heightEditor && typeof(this.valuesMap["width"]) == "undefined") {
                heightEditor.numberInput.value = "";
        }

    }
    this.setSnapshotInputValues(this.settings);
};

TwitterFeedSetting.prototype.save = function( callback) {
    this.saveSettings(callback);
};
TwitterFeedSetting.prototype.getCurrentInputValues = function( callback) {
    return this.propertiesWidget.getValue();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/UnmountContentPageSetting.js";

function UnmountContentPageSetting() {
    this.grabHeight = true;
    this.dontStretchBody = true;
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, UnmountContentPageSetting);

UnmountContentPageSetting.prototype.onReady = function () {
    this.refresh(this.componentInfo.contentPageId, "setSnapshot");
};
UnmountContentPageSetting.prototype.getDialogTitle = function() {
    return "Edit Custom Page";
};
UnmountContentPageSetting.prototype.refresh = function(id, setSnapshot) {
    var thiz = this;
    $icms.getContentPageById(id, function(data) {
        if (setSnapshot) {
            thiz._original = data;
        }
        thiz.editContentPageView.setup(data, thiz);
    },function(e){}, this);
}
UnmountContentPageSetting.prototype.getCurrentInputValues = function() {
    return this.editContentPageView.getCurrentInputValues();
}
UnmountContentPageSetting.prototype.getChangeEventNames = function () {
    return this.editContentPageView.getChangeEventNames();
};
UnmountContentPageSetting.prototype.save = function(callback) {
    var thiz = this;
    if (!ValidationManager.run(this.editContentPageView.validationRules)) return false;

    var finish = function(data) {
        thiz.clearUnsavedNotify();
        if (callback) callback(data);
        thiz.close(data);
    }
    this.editContentPageView.save(finish, thiz.signalDesignChanged());
    return false;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/web-design/UpcomingEventsSetting.js";

function UpcomingEventsSetting() {
    ComponentDetailDialog.call(this);
}
__extend(ComponentDetailDialog, UpcomingEventsSetting);

UpcomingEventsSetting.prototype.onReady = function() {
    this.loadSettings(this.settingsContainer);
    this.invalidateSizing();
}

UpcomingEventsSetting.prototype.getDialogTitle = function () {
    return "Events Settings";
};
UpcomingEventsSetting.prototype.save = function(callback) {
    this.saveSettings(callback);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/onboarding/CMSHiddenPageMigrationDialog.js";

function CMSHiddenPageMigrationDialog() {
    BoldDialog.call(this);

    this.title = "Hidden Page Migration";
}

__extend(BoldDialog, CMSHiddenPageMigrationDialog);


CMSHiddenPageMigrationDialog.prototype.asyncSetup = function (options, callback) {
    var thiz = this;
    $cmsMigration.getHiddenMenuItemsOfCurrentTeam(function (pages) {
        console.log("Pages...", pages);
        thiz.setupTree(pages);
        callback();
    }, this);
};
CMSHiddenPageMigrationDialog.prototype.onShown = function () {
    var pages = this._pages;
    if (!pages || pages.length == 0) {
        SnackBar.show("All hidden pages are migrated!");
        this.close();
    }
}
CMSHiddenPageMigrationDialog.prototype.setupTree = function(pages) {
    var thiz = this;
    var source = function (page, callback) {
        if (!page)  {
            callback(pages);
            return;
        }
        if (page && (!page.children || typeof(page.children) == "undefined" || page.children.length == 0)) {
            callback([]);
            return;
        }
        callback(page.children);
    };

    var renderer = function (page) {
        return  "<span>" + (page.node ? Dom.htmlEncode(page.node.title) : "")+ "</span>"
    };

    var options = {
        expandedAll: true,
        same: function (a, b) {return a.node && b.node && a.node.id == b.node.id;},
        isItemSelectable: function (item) {
            return true;
        },
        onInitialized: function () {
        }
    };

    console.log(this.pageTree);

    this.pageTree.setup(source, renderer, options);
    this._pages = pages;
    this.pageTree.setCheckedItems(pages);
}
CMSHiddenPageMigrationDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; },
        },
        {
            type: "accept", title: "Start",
            run: function () { this.start(); return false; }
        }
    ]
};
CMSHiddenPageMigrationDialog.prototype.start = function () {
    var tabs = this.pageTree.getCheckedItemsSync();
    var tabIds = [];
    if (tabs && tabs.length > 0) {
        for (var i in tabs) {
            var tab = tabs[i];
            tabIds.push(tab.node.id);
        }
    }
    if (tabIds.length == 0) {
        Dialog.error("Please select hidden page to start migration!");
        return;
    }
    var thiz = this;
    thiz.busy("Starting migration...");
    function errorHandler(e) {
        thiz.done();
        if (thiz._checker) {
            window.clearTimeout(thiz._checker);
        }
        var pending = e && e.code == "CMS:Migration:Processing";
        Dialog.error("Migration error", pending ? "Please try later after 60 seconds." : "There was an error when migrating your team website. Please contact the system administrator.", function () {
            thiz.close(false);
        });
    }

    $cmsMigration.startHiddenPageMigrationProcess(tabIds, function () {
        var checker = function () {
            $cmsMigration.getCMSMigrationProgress(function (progress) {
                if (!progress.finished) {
                    console.log(progress.percent, progress.activeStepName);
                    var p = typeof(progress.percent) != "undefined"  ? progress.percent : undefined;
                    thiz.progressed(p, p ? 100 : undefined, progress.activeStepName + "...");
                    thiz._checker = window.setTimeout(checker, 500);
                    return;
                }

                thiz.done();
                thiz.close(true);
            }, errorHandler);
        };
        checker();
    }, errorHandler);

};


if (window) window.__currentScriptPath = "/cms/admin/widgets/onboarding/CMSMigrationDialog.js";

function CMSMigrationDialog() {
    this.grabHeight = true;
    BoldDialog.call(this);
    this.title = "Get ready with your team's new website!";
    this.setupTemplates();
}

__extend(BoldDialog, CMSMigrationDialog);

CMSMigrationDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Start Setup",
            run: function () { this.startMigration(); return false; }
        }
    ]
};
CMSMigrationDialog.prototype.setupTemplates = function () {
    $templateAdminService.findPopulatedTemplateSuitesForMyTeam("", 0, 1000, Order.asc("name"), function (templates) {
        var list = [];
        var current = null;
        if (templates && templates.result) {
            templates.result.forEach(function (template) {
                list.push(template);
            }.bind(this));
        }
        if (list.length == 0 && ADMIN_CONTEXT.teamAlias == "teamunify") {
            this.close(true);
            return;
        }

        list.forEach(function (template) {
            var itemView = new AdminTemplateItemView().into(this.templateSuiteList);
            itemView.setVariantSelectorEnabled(true);
            itemView.setTemplate(template);

            var useButton = Dom.newDOMElement({
                _name: "div",
                "class": "UseButtonContainer",
                _children: [
                    {
                        _name: "button",
                        "class": "UseButton",
                        _text: "Use this template",
                        role: "secondary"
                    }
                ]
            });
            itemView.node().appendChild(useButton);

            itemView.node().setAttribute("tabindex", "0");

        }.bind(this));
        for (var i = 0; i < 10; i ++) {
            this.templateSuiteList.appendChild(Dom.newDOMElement({
                _name: "div",
                "class": "Fake"
            }));
        }
    }.bind(this), function(e) {}, this);
    this.bind("click", this.handleTemplateItemSelected, this.templateSuiteList);
};
CMSMigrationDialog.prototype.handleTemplateItemSelected = function (event) {
    var templateView = BaseWidget.findUpward(event.target, AdminTemplateItemView);
    if (!templateView) return;

    this.currentTemplateSuiteId = templateView.template.id;

    for (var i = 0; i < this.templateSuiteList.childNodes.length; i ++) {
        var node = this.templateSuiteList.childNodes[i];
        var tv = BaseWidget.findUpward(node, AdminTemplateItemView);
        if (!tv) continue;

        var on = tv.template && tv.template.id == this.currentTemplateSuiteId;
        Dom.toggleClass(tv.node(), "CurrentTemplateSuite", on);
    }

};

CMSMigrationDialog.prototype.startMigration = function () {
    if (!this.currentTemplateSuiteId) {
        Dialog.error("Template is required", "Please select a template for your team's new site.");
        return;
    }

    var thiz = this;

    thiz.busy("Setting up new team site...");
    function errorHandler(e) {
        thiz.done();
        if (thiz._checker) {
            window.clearTimeout(thiz._checker);
        }
        var pending = e && e.code == "CMS:Migration:Processing";
        Dialog.error("Migration error", pending ? "Please try later after 60 seconds." : "There was an error when migrating your team website. Please contact the system administrator.", function () {
            thiz.close(false);
        });
    }
    var variantName = "";

    for (var i = 0; i < this.templateSuiteList.childNodes.length; i ++) {
        var node = this.templateSuiteList.childNodes[i];
        var tv = BaseWidget.findUpward(node, AdminTemplateItemView);
        if (!tv) continue;
        var current = tv.template && tv.template.id == this.currentTemplateSuiteId;
        if (current) {
            variantName = tv.getSelectedVariantName();
        }
    }
    console.log("teamplateId: " + this.currentTemplateSuiteId, " variants: ", variantName);
    $cmsMigration.startMigrationProcess(this.currentTemplateSuiteId, variantName, function () {
        var checker = function () {
            $cmsMigration.getCMSMigrationProgress(function (progress) {
                if (!progress.finished) {
                    console.log(progress.percent, progress.activeStepName);
                    var p = typeof(progress.percent) != "undefined"  ? progress.percent : undefined;
                    thiz.progressed(p, p ? 100 : undefined, progress.activeStepName + "...");
                    thiz._checker = window.setTimeout(checker, 500);
                    return;
                }

                thiz.done();
                thiz.close(true);
            }, errorHandler);
        };
        checker();
    }, errorHandler);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/onboarding/CMSUnpublishDialog.js";

function CMSUnpublishDialog() {
    BoldDialog.call(this);

    this.title = "Unpublish Site";
    this.bind("click", this.unpublish, this.unpublishSiteButton);

    this.bind("click", function(){
        if (window._elev && window._elev.openHome) {
            window._elev.openHome();
        }
    }, this.getHelpButton);
}

__extend(BoldDialog, CMSUnpublishDialog);

CMSUnpublishDialog.prototype.getDialogActions = function () {
    return [
    ]
};
CMSUnpublishDialog.prototype.unpublish = function () {
    Dialog.confirm("Unpublish Site?",
                    "This will revert to your old site at the state it was when you last publish the new website. Are you sure you want to continue?",
                    "Yes, I want to unpublish", function () {
                        $cmsMigration.unpublish(function () {
                            localStorage.setItem(NavigationDrawer.STORAGE_KEY_LAST_FEATURE_ID, "home");
                            window.top.location.reload();
                        });
                    },
                    "Cancel");
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/onboarding/SandboxAccessConfigDialog.js";

function SandboxAccessConfigDialog() {
    Dialog.call(this);
    
    this.title = "Sandbox Access Levels";
    
    this.checkboxes = [];
    var thiz = this;
    
    this.roleRepeaterView.populator = function (data, binding, node, index) {
        binding.checkbox._data = data;
        binding.icon.src = data.image;
        binding.label.innerHTML = data.label;
        
        binding.label.setAttribute("for", binding.checkbox.id);
        
        if (data.forced) {
            binding.checkbox.checked = true;
            binding.checkbox.disabled = true;
        }
    };
    
    this.roleRepeaterView.setItems(SandboxAccessConfigDialog.SUPPORTED_ROLES);
}
SandboxAccessConfigDialog.SUPPORTED_ROLES = [
    {
        code: 90,
        label: "Superuser",
        image: "/v2/mainset/img/SO/super-user.png",
        forced: true
    }, {
        code: 60,
        label: "Webmaster/Event",
        image: "/v2/mainset/img/SO/webmaster-event.png"
    }, {
        code: 30,
        label: "Email/Print/Calendar",
        image: "/v2/mainset/img/SO/email-print-calendar.png"
    }
];

__extend(Dialog, SandboxAccessConfigDialog);
SandboxAccessConfigDialog.prototype.asyncSetup = function (options, callback) {
    var thiz = this;
    $cmsMigration.getSandboxAccessLevels(function (codes) {
        Dom.doOnSelector(thiz.roleRepeaterView.node(), "input", function (node) {
            if (!node._data || node._data.forced) return;
            node.checked = codes && (codes.indexOf(node._data.code) >= 0);
        });
        
        callback();
    }, AdminConsole.instance);
};
SandboxAccessConfigDialog.prototype.save = function () {
    var codes = [];
    Dom.doOnSelector(this.roleRepeaterView.node(), "input", function (node) {
        if (!node._data || node._data.forced) return;
        
        if (node.checked) codes.push(node._data.code);
    });
    
    var thiz = this;
    $cmsMigration.updateSandboxAccessLevels(codes, function () {
        thiz.close(true);
    }, this);
};

SandboxAccessConfigDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Update",
            run: function () { this.save(); return false; }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/onboarding/SandboxInfoDialog.js";

function SandboxInfoDialog() {
    BoldDialog.call(this);

    this.title = "Sandbox Mode";
}

__extend(BoldDialog, SandboxInfoDialog);
SandboxInfoDialog.prototype.setup = function() {
    this.sandboxView.setOnCloseCallback(function(){
        this.close();
    }.bind(this));
}
SandboxInfoDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/onboarding/SandboxInfoView.js";

function SandboxInfoView() {
    BaseTemplatedWidget.call(this);

    this.bind("click", function () {
        if (this.closeCallback) {
            this.closeCallback();
        }
        if (window._elev && window._elev.openHome) {
            window._elev.openHome();
        }
    }, this.getHelpButton);

    this.init();
    this.bind("click", this.publish, this.publishSiteButton);
    this.bind("click", this.rollbackMigration, this.rollbackMigrationButton);

    if (AdminConsole.instance && AdminConsole.instance.userSession
        && AdminConsole.instance.userSession.email.match(/^.*@teamunify.com$/)
        && ADMIN_CONTEXT && !ADMIN_CONTEXT.isNewTeamUsedCMS) {
        Dom.addClass(this.node(), "RollbackAllowed");
    }
}
__extend(BaseTemplatedWidget, SandboxInfoView);
SandboxInfoView.prototype.onAttached = function () {
};
SandboxInfoView.prototype.setOnCloseCallback = function(callback) {
    this.closeCallback = callback;
}
SandboxInfoView.prototype.launch = function () {
};
SandboxInfoView.prototype.init = function (options, callback) {
    var thiz = this;
    var isAdmin = CMSAuthUtils.canPublishUnpublishWebsite();
    this.publishSiteButton.disabled = !isAdmin;
    Dom.toggleClass(this.node(), "IsAdmin", isAdmin);
};
SandboxInfoView.prototype.rollbackMigration = function () {
    Dialog.prompt("You are going to rollback the migration to new CMS, remove all team data setup for the new CMS. "
                    + "This operation cannot be undone.\n"
                    + "Please type 'rollback' in the following input to confirm.",
                    "", "Rollback",
                    function (input) {
                        if (input != "rollback") {
                            Dialog.error("Wrong keyword was entered. Operation canceled.");
                            return;
                        }

                        $cmsService.removeAllCMSTeamData(function () {
                            Dialog.alert("All CMS data deleted!", "All CMS data was reset. You're going be redirected to the migration step again.", function () {
                                window.top.location.reload();
                            });
                        });
                    });
};

SandboxInfoView.prototype.publish = function () {
    Dialog.confirm("Ready to publish?",
                    "This will redirect all traffic to your new site. Please make sure everything looks good before proceeding!",
                    "I'm Ready!", function () {
                        $cmsMigration.publish(function () {
                            window.top.location.reload();
                        });
                    },
                    "Not Yet...");
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/ConfigurationItemDialog.js";

function ConfigurationItemDialog() {
    Dialog.call(this);
}
__extend(Dialog, ConfigurationItemDialog);

ConfigurationItemDialog.prototype.setup = function(config) {
    this.config = config;
    this.title = typeof(this.config.id) != "undefined" ? "Edit Configuration Item" : "Add Configuration Item";
    this.configType.comparer = function(a, b) {
        return a == b;
    }
    this.configType.setItems(["String", "Html", "Number", "Boolean", "Color", "Date", "File"]);
}

ConfigurationItemDialog.prototype.onShown = function() {
    if (!this.config) return;

    this.configType.selectItem(this.isSupportedType(this.config.typeClassName) ? this.config.typeClassName : "String");
    this.configName.value = this.config.configKey || "";
    this.configDescription.value =  this.config.description || "";

    this.createEditorFor(this.config);
    if (this.config.system) {
        this.configType.setEnable(false);
        this.configName.setAttribute("disabled", true);
        this.configDescription.setAttribute("disabled", true);
    } else if (this.config.id > 0) {
        this.configName.setAttribute("disabled", true);
    }

    if (this.isReadOnlyType(this.config.typeClassName)) {
        this.configType.setEnable(false);
    } else {
        Dom.registerEvent(this.configType.node(), "p:ItemSelected", function(){
            this.config.typeClassName = this.configType.getSelectedItem();
            this.createEditorFor(this.config);
        }.bind(this));
    }

    this.validationRules = new RuleSet().live(true)
    .required(this.configName, "Please input configuration key.");
}

ConfigurationItemDialog.prototype.isSupportedType = function(typeClassName) {
    switch (typeClassName) {
        case "String":
        case "Html":
        case "Number":
        case "Boolean":
        case "Color":
        case "Date":
        case "File":
        case "Enum":
            return true;

        default:
            return false;
    }
};

ConfigurationItemDialog.prototype.isReadOnlyType = function(typeClassName) {
    return typeClassName === "Enum";
};

ConfigurationItemDialog.prototype.createEditorFor = function(config) {
    Dom.toggleClass(this.propertiesContainer, "File", config.typeClassName == "File");
    Dom.toggleClass(this.propertiesContainer, "Html", config.typeClassName == "Html");
    Dom.empty(this.propertiesContainer);
    this.grabHeight = config.typeClassName == "Html";

    this.propertiesWidget = new PropertiesWidget();
    this.propertiesWidget.setSchemas(this.getSchemas(config));
    this.propertiesWidget.setValue(this.getValues(config));
    this.propertiesWidget.into(this.propertiesContainer);
    this.invalidateSizing();
}
ConfigurationItemDialog.prototype.getSchemas = function(config) {
    var schemas = [];
    var schema = undefined;
    if (typeof(config.typeClassName) == "undefined" || config.typeClassName == "String") {
        schema = {  type: "String",
                    defaultValue: ""};
    } else if (config.typeClassName == "Html") {
        schema = {  type: "Html",
                    defaultValue: ""};
    } else if (config.typeClassName == "Boolean") {
        schema = {  type: "Boolean",
                    defaultValue: false };
    } else if (config.typeClassName == "Number") {
        schema = {  type: "Number",
                    defaultValue: 0 };
        schema.decimal = config.numberDecimalPlaces && config.numberDecimalPlaces > 0;
        schema.decimalPlaces = config.numberDecimalPlaces;
    } else if (config.typeClassName == "Color") {
        schema = {  type: "Color",
                    defaultValue: "#FFFFFFF" };
    } else if (config.typeClassName == "File") {
        schema = {  type: "FileUpload",
                    defaultValue: "" };
    } else if (config.typeClassName == "Date") {
        schema = {  type: "Date",
                    withTime: true,
                    defaultValue: new Date()};
    } else if (config.typeClassName == "Enum") {
        schema = {  type: "Enum",
                    exclusive: true,
                    items: config.dataList};
    };
    if (typeof(schema) != "undefined") {

        schema.name = config.configKey || "";
        schema.displayName = config.configKey || "";

        schemas.push(schema);
    }
    return schemas;
}
ConfigurationItemDialog.prototype.getValues = function(config) {
    var values = {};
    var v = undefined;
    if (config.typeClassName == "String" || config.typeClassName == "Html") {
        v = config.stringValue || "";
    } else if (config.typeClassName == "Boolean") {
        v = config.booleanValue;
    } else if (config.typeClassName == "Number") {
        v = config.numberValue || 0;
    } else if (config.typeClassName == "Color") {
        v = config.stringValue || "";
    } else if (config.typeClassName == "Date") {
        v = config.dateValue;
    } else if (config.typeClassName == "File") {
        v = config.stringValue || "";
    } else if (config.typeClassName == "Enum") {
        v = config.numberValue || "";
    }
    if (typeof(v) != "undefined") {
        values[config.configKey] = v;
    }
    return values;
}
ConfigurationItemDialog.prototype.getConfigItemFromUI = function() {
    var valueMap = this.propertiesWidget.getValue();
    var newConfig = {};
    if (this.config.id) {
        newConfig.id = this.config.id;
        newConfig.numberDecimalPlaces = this.config.numberDecimalPlaces;
    }
    newConfig.typeClassName = this.configType.getSelectedItem();
    newConfig.configKey = this.configName.value.trim();
    newConfig.description = this.configDescription.value.trim();
    var value = valueMap[this.config.id > 0 ? this.config.configKey : ""];

    if (newConfig.typeClassName == "String" || newConfig.typeClassName == "Html") {
        newConfig.stringValue = value;
    } else if (newConfig.typeClassName == "Boolean") {
        newConfig.booleanValue = value;
    } else if (newConfig.typeClassName == "Number") {
        newConfig.numberValue = value;
    } else if (newConfig.typeClassName == "Color") {
        newConfig.stringValue = value;
    } else if (newConfig.typeClassName == "Date") {
        newConfig.dateValue = value;
    } else if (newConfig.typeClassName == "File") {
        newConfig.stringValue = value;
    } else if (newConfig.typeClassName == "Enum") {
        newConfig.numberValue = value;
    }

    newConfig.typeClassName = this.isReadOnlyType(this.config.typeClassName) ? this.config.originalTypeClassName : this.configType.getSelectedItem();

    return newConfig;
}
ConfigurationItemDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Save",
            run: function () {

                if (!ValidationManager.run(this.validationRules)) return;

                this.close(this.getConfigItemFromUI());
                return false;
            }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/ConfigurationItemsView.js";

function ConfigurationItemsView() {
    BaseTemplatedWidget.call(this);
    this.title = "System Configuration Items";
    this.listView.chunkSize = 15;
    this.listView.populator = function (data, binding, node) {
        Dom.setInnerText(binding.configKey, data.configKey || "");
        binding._node._data = data;
        Dom.toggleClass(node, "System", data.system);
        var valuesMap = ConfigurationItemDialog.prototype.getValues(data);
        var v = valuesMap[data.configKey];
        if (v && data.typeClassName == "Date") {
             v = moment(v).format("MMM DD YYYY h:mm a");
        }
        if (typeof(v) === "undefined") {
            v = "";
        }
        Dom.setInnerText(binding.configValue, "" + v);
        binding._node.setAttribute("title" , data.description || "");
        if (data.typeClassName == "Color") {
            binding.configValue.setAttribute("style" , "color: " +  v);
        } else {
            binding.configValue.setAttribute("style" , "");
        }
     };
    this.bind("click", function(ev){
        if (!Dom.hasClass(ev.target, "EditButton") && !Dom.hasClass(ev.target, "DeleteButton")) return;
        var itemContainer = Dom.findUpwardForNodeWithData(ev.target, "_data");
        if (!itemContainer) return;
        var config = itemContainer._data;
        var thiz = this;
        if (Dom.hasClass(ev.target, "EditButton")) {
            ConfigurationItemsView.openEditor(config, function(data) {
                if (!data) return;
                thiz.performFilter();
            }.bind(this));
        } else if (Dom.hasClass(ev.target, "DeleteButton") && !config.system) {
            Dialog.confirm("Are you sure you want to delete this configuration item?", "",
                "Delete", function(){
                    $configurationService.deleteConfigItem(config.configKey,
                    function(){
                        thiz.performFilter();
                    }.bind(thiz),
                    function(e) {
                        console.log("Delete config failed ", e);
                    });
                }, "Cancel");
        }

    }.bind(this), this.listView);

    this.bind("click", this.performFilter, this.searchButton);
    this.bind("keypress", function(event) {
        if (event && event.keyCode == 13) {
            this.performFilter();
            Dom.cancelEvent(event);
        }
    }.bind(this), this.searchTerm);

    this.bind("click", this.createNewConfig, this.addButton);

}
__extend(BaseTemplatedWidget, ConfigurationItemsView);

ConfigurationItemsView.prototype.getSystemToolbar = function () {
    return this.toolbar;
};

ConfigurationItemsView.prototype.performFilter = function() {
    var source = this.createSource();
    if (!source) return;
    this.listView.setSource(source);
}
ConfigurationItemsView.prototype.onAttached = function() {
    this.performFilter();
}
ConfigurationItemsView.prototype.createNewConfig = function() {
    var thiz = this;
    new ConfigurationItemDialog().callback(function(data){
        if (!data) return;

        $configurationService.addConfigItem(data.configKey, data,
        function(){
            thiz.performFilter();
        }.bind(thiz),
        function(e) {
            Dialog.error("Configuration key existed. Please try another key.");
        });

    }).open({});

}
ConfigurationItemsView.prototype.createSource = function () {
    var thiz = this;
    var term = this.searchTerm.value.trim();
    thiz._term = term;
    return {
        term: thiz._term,
        loadPage: function (start, count, handler, failed) {
            $configurationService.list(this.term, start, count,
            function(results){
                handler(results.result, results.count);
            }.bind(thiz), function(e) {
                failed(e);
            });
        }
    };
};

ConfigurationItemsView.openEditor = function (config, callback) {
    if (typeof config !== "object") {
        config = {};
    } else {
        config = Util.clone(config);
    }
    if (typeof callback !== "function") callback = function () {};

    // config.typeClassName could be one of the following formats: "Type", ":RegisteredModelClassName", "namespace:RegisteredModelClassName"
    var prop = config.typeClassName ? config.typeClassName.split(":") : [];
    var ns = prop.length > 1 ? prop[0] : null;
    var type = prop.length > 1 ? prop[1] : prop[0];

    config.originalTypeClassName = config.typeClassName;
    var openFn = function (namespace) {
        // Handle Enum type
        if (type.indexOf("Enum$") === 0) {
            config.dataTypeClassName = type.replace("Enum$", "");

            config.dataList = Array.isArray(config.dataList) ? config.dataList : [];
            var enumMap = (namespace.ModuleData && namespace.ModuleData[config.dataTypeClassName]) || window[config.dataTypeClassName];
            if (typeof enumMap === "object") {
                for (var key in enumMap) {
                    if (Object.prototype.hasOwnProperty.call(enumMap, key)) {
                        var obj = enumMap[key];
                        config.dataList.push({
                            key: obj.key || obj.code || obj.index,
                            value: obj.value || obj.title || obj.displayName
                        });
                    }
                }
            }

            if (config.dataList.length) {
                config.typeClassName = "Enum";
                type = "Enum";
            }
        }

        var editor = ConfigurationItemsView.lookupEditor(type);
        if (!editor) {
            console.error("No editor registered for type: " + type);
            return;
        }

        editor = new editor();

        if (typeof editor.callback === "function") {
            editor.callback(function(data) {
                if (!data) return;

                $configurationService.updateConfigItem(data.configKey, data,
                    function () {
                        callback(data);
                    }, function(err) {
                        Dialog.error("Cannot save the configuration", (err && err.message) || "An unknown exception occured.");
                    }
                );
            });
        }

        if (typeof editor.open === "function") editor.open(config);
    };

    if (ns && ns.length > 0) {
        widget.__ensureNamespaceLoaded(ns, openFn);
    } else {
        openFn(window);
    }
};

ConfigurationItemsView._editorMap = {};
ConfigurationItemsView.registerEditor = function (type, editor) {
    var t = "" + type;
    ConfigurationItemsView._editorMap[t] = editor;
};

ConfigurationItemsView.lookupEditor = function (type) {
    var t = "" + type;
    return ConfigurationItemsView._editorMap ? ConfigurationItemsView._editorMap[t] : undefined;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/ImportMigrationResultDialog.js";

function ImportMigrationResultDialog() {
    Dialog.call(this);
    this.bind("change", function () {
        Dom.toggleClass(this.importFile, "HasFile", this.importFile.files && this.importFile.files.length > 0);
    }, this.importFile);
    this.bind("cancel" , function (e){
        console.log(e);
    }, this.importFile);
    this.bind("change", function() {
        this.invalidateUI();
    }, this.loginEnabledInput);

}
__extend(Dialog, ImportMigrationResultDialog);
ImportMigrationResultDialog.prototype.invalidateUI = function() {
    this.firstTimeSignInInput.disabled = !this.loginEnabledInput.checked;
    if (!this.loginEnabledInput.checked) {
        this.firstTimeSignInInput.checked = false;
    }
}
ImportMigrationResultDialog.prototype.setup = function (region) {
    this.region = region;
    this.title = "Region " + (this.region.regionName || "");
};
ImportMigrationResultDialog.prototype.onShown = function () {
    //this.importFile.click();
    this.firstTimeSignInInput.checked = this.region.firstTimeSignInNotifyEnabled;
    this.loginEnabledInput.checked = this.region.loginEnabled;
    this.invalidateUI();
}

ImportMigrationResultDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "accept", title: "Import/Update",
            run: function () {
                thiz.import();
                return false;
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

ImportMigrationResultDialog.prototype.import = function () {
    var thiz = this;
    var file = null;
    if (this.importFile.files && this.importFile.files.length > 0) {
        file = this.importFile.files[0];
    }
    var ssoEnabled = this.loginEnabledInput.checked;
    var firstTimeSignIn = this.firstTimeSignInInput.checked;
    var saveImpl = function() {
        $ssoMigrationService.importMigrationResult(thiz.region.id, file, ssoEnabled, firstTimeSignIn, function(jobId){
            if (!jobId || jobId.length == 0) {
                thiz.close(true);
                return;
            }
            thiz.getMigrationResultWithJobId(jobId);
        }, function(e) {
            Dialog.error("Import csv file failed. Please recheck the selected file.");
            thiz.close(false);
        }, "Processing...");
    }
    if (!file) {
        saveImpl();
        return;
    }
    Dialog.confirm("Are you sure you want to import this file?", null, "Import", function () {
        saveImpl();
    }, "Cancel", function () {
        thiz.close(false);
    });
};

ImportMigrationResultDialog.prototype.getMigrationResultWithJobId = function (id) {
    var thiz = this;
    var indicator = new Spinner("Importing...");
    indicator.busy();
    var timeReload = 5000;
    var checker = function () {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(id, function (job) {
                if (job) {
                    if (job.status == "Failed") {
                        console.log("job failed " + id);
                        window.clearTimeout(timeoutTask);
                        indicator.done();
                    } else if (job.status == "Done" && job.data > -1) {
                        indicator.progressed(100, 100, "Done.");
                        indicator.done();
                        window.clearTimeout(timeoutTask);
                        thiz.close(true);
                        if (job.data > 0) {
                            SnackBar.show(job.data + " account(s) updated.");
                        }
                    } else {
                        var p = Math.round(job.processed * 100 / job.total);
                        indicator.progressed(isNaN(p) ? 0 : p, 100, (isNaN(p) ? "0" : p) + "% accounts in migration result file processed." );
                        timeReload =  Math.min(job.total / 5, 10000);
                        checker();
                    }
                } else {
                    console.log("job not found " + id);
                }
            });
        }, timeReload);
    };
    checker();
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/RegionDetailDialog.js";

function RegionDetailDialog() {
    Dialog.call(this);
    thiz = this;
    this.title = "Region Details";
    this.bind("keypress", function(event) {
        if (event && event.keyCode == 13) {
            this.reload();
            Dom.cancelEvent(event);
        }
    }.bind(this), this.searchTerm);

    var inputTimeout = null;
    this.bind("input", function(event) {
        window.clearTimeout(inputTimeout);
        inputTimeout = window.setTimeout(function () {
            thiz.reload();
            Dom.cancelEvent(event);
        }, 200);
    }.bind(this), this.searchTerm);

    this.bind("click",function() {
        Dialog.confirm("Are you sure you want to start migration?", null, "Start", function () {
            $ssoMigrationService.startMigration(thiz.region.id, function () {
                thiz.change = true;
                thiz.reloadInfo();
            }, "Start Migration...");
        }, "Cancel", function () {});

    }, this.startMigrationButton);

    this.bind("click", function () {
        $ssoMigrationService.downloadRegionAccountZipPackage(thiz.region.id, function(jobId){
            thiz.downloadWithJobId(jobId);
        }, "Exporting...");

    }, this.download);

    this.bind("click", function() {
        new ImportMigrationResultDialog().callback(function (change) {
            if (change) {
                thiz.reloadInfo();
                thiz.change = true;
            }
        }).open(thiz.region);
    }, this.importMigrationButton);
};
__extend(Dialog, RegionDetailDialog);

RegionDetailDialog.prototype.asyncSetup = function (region, callback) {
    this.region = region;
    this.reloadInfo(function (rg) {
        callback();
        this.updateFooter(rg);
    }.bind(this));
};

RegionDetailDialog.prototype.downloadWithJobId = function (id) {
    var indicator = new Spinner("Exporting...");
    var percent = 0;
    indicator.busy();
    var reloadTime = Math.min(thiz.region.totalTeam * 10, 4000);
    var checker = function () {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(id, function (job) {
                if (job) {
                    if (job.status == "Failed") {
                        console.log("job failed " + id);
                        window.clearTimeout(timeoutTask);
                        indicator.done();
                    } else if (job.status == "Done" && job.data) {
                        indicator.progressed(100, 100, "Done.");
                        indicator.done();
                        window.clearTimeout(timeoutTask);
                        window.location.href = "https://" + window.location.host + "/" + job.data;
                    } else {
                        var p = Math.round(job.processed * 100 / job.total);
                        indicator.progressed(isNaN(p) ? 0 : p, 100, (isNaN(p) ? "0" : p) + "% teams in '" + thiz.region.regionName +"' region exported..." );
                        checker();
                    }
                } else {
                    console.log("job not found " + id);
                }
            });
        }, reloadTime);
    };
    checker();
};

RegionDetailDialog.prototype.updateFooter = function (region) {
    var lastAt = region.lastUpdatedDate ? ("Last activity: " +  FormatUtil.formatDate(region.lastUpdatedDate, "datetime_named", "local") + " by " + region.updatedByFullName  + ".") :"";
    this.dialogFooterMiddlePane.appendChild(Dom.newDOMElement({"class": "LastAt Description", _name: "hbox", _children: [{_name: "span", _text: lastAt}]}));
};

RegionDetailDialog.prototype.reloadInfo = function (callback) {
    var thiz = this;
    $ssoMigrationService.getSSOMigrationItemByRegionId(this.region.id, function(region) {
        thiz.showRegionInfo(region);
        if (callback) callback(region);
    }, "Loading...");
};

RegionDetailDialog.prototype.showRegionInfo = function (region) {
    this.region = region;
    this.regionName.innerHTML = region.regionName || "";
    this.regionSummary.innerHTML =  region.regionSummary || "";
    this.loginEnabled.innerHTML =  region.loginEnabled ? "Enabled" : "Disabled";
    Dom.toggleClass(this.loginEnabled, "Done", region.loginEnabled);

    this.firstTimeSignIn.innerHTML =  region.firstTimeSignInNotifyEnabled ? "Enabled" : "Disabled";
    Dom.toggleClass(this.firstTimeSignIn, "Enabled", region.firstTimeSignInNotifyEnabled);

    //this.totalTeam.innerHTML = region.totalTeam ? (region.totalTeam + " teams found.") : "";
    this.updateStatus(region.status);
    Dom.empty(this.dialogFooterMiddlePane);
    this.updateFooter(region);
};

RegionDetailDialog.prototype.onShown = function () {
    this._setupTable();
    this.init();
    this.reload();
};

RegionDetailDialog.MigrationStatus = ["NotStarted", "Submitted", "Done"];
RegionDetailDialog.prototype.updateStatus = function (status) {
    var thiz = this;
    this.status.innerHTML = status == "NotStarted" ? "Not Started" : status;
    RegionDetailDialog.MigrationStatus.forEach(function(item){
        Dom.toggleClass(thiz.actions, item, item == status);
        Dom.toggleClass(thiz.status, item, item == status);
    });
};

RegionDetailDialog.prototype._setupTable = function() {
    var thiz = this;
    this.dataTable.column(new DataTable.GenericDomColumn("Team Name", function (item) {
        return Dom.vbox(Dom.strong(item.name));
    }).width("2*").sortable("name"));
    this.dataTable.column(new DataTable.GenericDomColumn("Alias", function (item) {
        return Dom.vbox(Dom.span(item.directory));
    }).width("1*").sortable("directory"));
    this.dataTable.column(new DataTable.GenericDomColumn("# Accounts", function (item) {
        return Dom.newDOMElement({"class": "Number", _name: "hbox", _children: [{_name: "span", _text: (item.totalActiveAccount ? Util.formatNumber(item.totalActiveAccount) : 0) + ""}]});
    }).width("1*").sortable("totalActiveAccount"));
    this.dataTable.useFloatingHeader = true;
    this.dataTable.addOrderRequestListener({
        changeOrder: function(order) {
            thiz.dataTable.setOrder({asc: order.asc, propertyName: order.propertyName});
            thiz.reload();
        }
    });
    this.dataTable.setup();
    this.dataTable.setOrder({asc: true, propertyName: "name"});
};

RegionDetailDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [{
        type: "cancel", title: "Close",
        run: function () {
            thiz.close(this.change ? true : false);
        }
    }];
};

RegionDetailDialog.prototype.init = function() {
    var thiz = this;
    this.paginator = new InfiniteScrollPaginator();
    var comparer = function(a, b) {
        return a.teamId == b.teamId;
    };
    this.paginator.setup({
        withoutStatus: true,
        onPageStartLoading: function(page) {},
        onPageLoaded: function (paginator, count) {
            var showItem = Math.min((paginator.lastLoadedIndex + 1) * paginator.pageSize, paginator.total);
            thiz.totalTeam.innerHTML = paginator.total == 0 ? "0 team found." : String.format("{0}/{1} team(s) listed.", Util.formatNumber(showItem), Util.formatNumber(paginator.total));
        },
        onPageLoadFailed: function (page) {},
        comparer: comparer,
        useButtons: false,
        avoidPageSizeRecalculation: true
    });
    this.dataTable.comparer = comparer;
    this.paginator.control(this.dataTable);
    this.paginator.pageSize = 20;
};

RegionDetailDialog.prototype.reload = function () {
    var term = this.searchTerm.value.trim();
    var thiz = this;
    var order = this.dataTable.getOrder();
    var orders = null;
    if (order) {
        orders = [];
        orders.push({name: order.propertyName, asc: order.asc});
    }
    this.dataListSource = {
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var fromIndex = pageIndex * pageSize;
            $ssoMigrationService.findTeamsInRegion(thiz.region.id, term, orders, fromIndex, pageSize, function (items) {
                if (items) {
                    handler(items.result, items.count);
                } else {
                    failed();
                }
            }, failed, "Loading...");
        },
    };
    setTimeout(function(){
        this.paginator.setSource(this.dataListSource);
    }.bind(this), 50);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/SSOMigrationManagmentView.js";

function SSOMigrationManagmentView() {
    BaseTemplatedWidget.call(this);
    this.title = "SSO Migration Management";

    this.bind("click", this.reload, this.searchButton);
    this.bind("keypress", function(event) {
        if (event && event.keyCode == 13) {
            this.reload();
            Dom.cancelEvent(event);
        }
    }.bind(this), this.searchTerm);

}
__extend(BaseTemplatedWidget, SSOMigrationManagmentView);

SSOMigrationManagmentView.prototype.onAttached = function() {
    this.dataTable.column(new DataTable.GenericDomColumn("Team", function (item) {
        return Dom.vbox(Dom.strong(item.teamAlias), Dom.span(item.teamName));
    }).width("2*"));
    this.dataTable.column(new DataTable.GenericDomColumn("Migration Status", function (item) {
        return Dom.newDOMElement({"class": item.status, _name: "hbox", _children: [{_name: "strong", _text: item.status}]});
    }).width("2*"));
    this.dataTable.column(new DataTable.GenericDomColumn("Note", function (item) {
        return Dom.hbox(Dom.span(item.note));
    }).width("1*"));

    var thiz = this;

    var editAction = {
        icon: "export",
        title: "Export accounts to CSV",
        role: "primary",
        isApplicable: function(data){ return true;},
        run: function (data, callback) {
            $ssoMigrationService.exportAccountsOfTeamToCVS(data.teamId, function (url) {
                if (!url) {
                    Dialog.error("Export accounts failed. Please try again.");
                    return;
                }
                window.location.href = url;

                thiz.reload();
            }, "Exporting...");
        }
    };
    var updateStatus = {
        icon: "pencil",
        title: "Finish SSO Migration",
        role: "secondary",
        applicable: function(data){ return data.status == "Started";},
        run: function (data, callback) {
            Dialog.prompt("Mark SSO migration for team '" + data.teamAlias + " - " + data.teamName + "' is finish.", "", "Finish", function(text){
                $ssoMigrationService.updateMigrationStatusFinished(data.teamId, text, function () {
                    thiz.reload();
                }, "Updating...");
            }, "Cancel", function(e){});
        }
    };

    this.dataTable.column(new DataTable.GenericDomColumn("", this.dataTable.createActionColumnHandler(editAction, updateStatus)).width("10em"));
    this.dataTable.useFloatingHeader = true;
    this.dataTable.setup();
    this.init();

    this.reload();
};

SSOMigrationManagmentView.prototype.init = function() {
    var thiz = this;
    this.paginator = new InfiniteScrollPaginator();
    var comparer = function(a, b) {return a.teamId == b.teamId;};
    this.paginator.setup({
        getTotalItemText: function(total) {
            return String.format("Total %d items", total);
        },
        showPaginator: false,
        withoutStatus: true,
        onPageStartLoading: function(page) {},
        onPageLoaded: function (p, count) {
        },
        onPageLoadFailed: function (page) {},
        comparer: comparer,
        useButtons: false,
        avoidPageSizeRecalculation: true
    });
    this.dataTable.comparer = comparer;
    this.paginator.control(this.dataTable);
    this.paginator.pageSize = 50;

};

SSOMigrationManagmentView.prototype.reload = function () {
    var term = this.searchTerm.value.trim();
    this.dataListSource = {
        loadPage: function (pageIndex, pageSize, handler, failed) {
            $ssoMigrationService.getSSOMigrationItems(term, pageIndex, pageSize, function (items) {
                if (items) {
                    handler(items.result, items.count);
                } else {
                    failed();
                }
            }, failed, "Loading...");
        },
    };
    this.paginator.setSource(this.dataListSource);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/SSOMigrationRegionsView.js";

function SSOMigrationRegionsView () {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, SSOMigrationRegionsView);

SSOMigrationRegionsView.prototype._setupsRegionsTable = function () {
    var thiz = this;
    this.regionsTable.column(new DataTable.GenericDomColumn("Team Regions", function (item) {
        return Dom.vbox(Dom.strong(item.regionName), {"class": "Description", _name: "vbox", _children: [{_name: "span", _text: item.regionSummary}]});
    }).width("2*").sortable("name"));

    this.regionsTable.column(new DataTable.GenericDomColumn("# Teams", function (item) {
        return Dom.newDOMElement({
            _name: "hbox",
            "class": "Number",
            _children: [{
                _name: "strong",
                _text: item.totalTeam ? Util.formatNumber(item.totalTeam) : 0
            }]
        });
    }).width("15em").sortable("totalTeam"));

    this.regionsTable.column(new DataTable.GenericDomColumn("Migration Status", function (item) {
        return Dom.newDOMElement({"class": item.status + " Status", _name: "vbox", _children: [{_name: "strong", _text:
        item.status == "NotStarted" ? "Not Started" : item.status}]});
    }).width("15em").sortable("status"));

    this.regionsTable.column(new DataTable.GenericDomColumn("SSO Logins", function (item) {
        return Dom.newDOMElement({"class": item.loginEnabled ? "Enabled Status" : "Disabled Status", _name: "vbox", _children: [{_name: "strong", _text:
        item.loginEnabled ? "Enabled" : "Disabled"}]});
    }).width("15em"));

    this.regionsTable.column(new DataTable.GenericDomColumn("Last Activity Date", function (item) {
        var lastAt = item.lastUpdatedDate ? (FormatUtil.formatDate(item.lastUpdatedDate, "datetime_named", "local") + "<br />by " + item.updatedByFullName) :"";
        return Dom.newDOMElement({"class": item.status, _name: "vbox", _children: [{_name: "span", _html: lastAt}]});
    }).width("1*").sortable("lastUpdatedDate"));

    this.regionsTable.useFloatingHeader = true;
    this.regionsTable.defaultSelectionHandler = {
        run: function(data, event) {
            new RegionDetailDialog().callback(function(change) {
                if (change) {
                    thiz.reload();
                }
            }).open(data);
        }
    };
    this.regionsTable.supportZebraColor = function() {return true;};
    this.regionsTable.addOrderRequestListener({
        changeOrder: function(order) {
            thiz.regionsTable.setOrder({asc: order.asc, propertyName: order.propertyName});
            thiz.regionsTable.setItems(thiz.sortImpl(thiz.regionsTable.getItems()));
        }
    });
    this.regionsTable.setup();
    this.regionsTable.setOrder({asc: true, propertyName: "id"});
};

SSOMigrationRegionsView.prototype.reload = function () {
    var thiz = this;
    $ssoMigrationService.getSSOMigrationItems(function (rs){
        this.regionsTable.setItems(thiz.sortImpl(rs.result));
        var totalTeam = 0;
        rs.result.forEach(function (item) {
            totalTeam += item.totalTeam;
        });
        this.totalLable.innerHTML =  "Total " + rs.count + " region(s), " + Util.formatNumber(totalTeam) + " team(s) listed."
        Dom.toggleClass(this.initializeRegionButton, "Active", (rs.result.length == 0));
    }.bind(this), function (err) {
        console.log(err);
    }, "Loading...");
};
SSOMigrationRegionsView.prototype.sortImpl = function(items) {
    var thiz = this;
    var order = this.regionsTable.getOrder();
    if (!items || items.length == 1 || !order) return items;
    items = items.sort(function(a, b) {
        var v = 0;
        if (order.propertyName == "name") {
            v = a.regionName.localeCompare(b.regionName);
        } else if (order.propertyName == "totalTeam") {
            v = a.totalTeam - b.totalTeam;
        } else if (order.propertyName == "status") {
            var v1 = thiz.getValueOfStatus(a.status);
            var v2 = thiz.getValueOfStatus(b.status);
            v = v1 - v2;
        } else if (order.propertyName == "lastUpdatedDate") {
            var v1 = a.lastUpdatedDate ? a.lastUpdatedDate.getTime() : 0;
            var v2 = b.lastUpdatedDate ? b.lastUpdatedDate.getTime() : 0;
            v = v1 - v2;
        }
        if (v == 0 || order.propertyName == "id") {
            v = a.id - b.id;
        }
        return v;
    });
    if (!order.asc) {
        items = items.reverse();
    }
    return items;
}
SSOMigrationRegionsView.prototype.getValueOfStatus = function(status) {
    if (status == "Done") return 10;
    if (status == "Submitted") return 5;
    return 0;
}
SSOMigrationRegionsView.prototype.onAttached = function (first) {
    var thiz = this;
    if (first) {
        this._setupsRegionsTable();
    }
    this.reload();

    Dom.registerEvent(this.initializeRegionButton, "click", function(event) {
        Dom.cancelEvent(event);
        Dialog.confirm("Are you sure you want to initialize migration regions?", null, "Initialize", function () {
            $ssoMigrationService.initMigrationRegionItems(function (rs){
                thiz.reload();
            }.bind(this), function (err) {
            }, "Initializing...");
        }, "Cancel", function () {
            thiz.close(false);
        });
    });
};
SSOMigrationRegionsView.prototype.getSystemToolbar = function () {
    return this.initializeRegionPane;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/TeamFeatureConfigDialog.js";

function TeamFeatureConfigDialog() {
    Dialog.call(this);
    this.title = "BETA Feature Settings";
}
__extend(Dialog, TeamFeatureConfigDialog);

TeamFeatureConfigDialog.prototype.setup = function (config) {
    this.config = config;
    
    Dom.setInnerText(this.moduleDisplayNameLabel, config.module.displayName);
    Dom.setInnerText(this.moduleKeyLabel, config.module.key);
    
    this.commonList = this._configureTeamList("Common");
    this.androidList = this._configureTeamList("Android");
    this.iosList = this._configureTeamList("iOS");
    
    this.commonList.setValue(config.teams);
    if (config.module.mobileSpecific) {
        this.androidList.setValue(config.mobileTeamMap ? (config.mobileTeamMap.android || []) : []);
        this.iosList.setValue(config.mobileTeamMap ? (config.mobileTeamMap.ios || []) : []);
    }
    
    Dom.toggleClass(this.dialogContentNode, "WithMobileSpecific", config.module.mobileSpecific);
}
TeamFeatureConfigDialog.prototype._configureTeamList = function (name) {
    var container = this.node().querySelector(".TeamList." + name);
    var checkbox = container.querySelector(".AllTeamCheckBoxContainer > input");
    var chipList = container.querySelector(".widget_ChipList").__widget;
    
    this._configureChipList(chipList);
    
    checkbox.addEventListener("click", function () {
        Dom.toggleClass(container, "All", checkbox.checked);
    }, false);
    
    return {
        setValue: function (teams) {
            checkbox.checked = false;
            Dom.removeClass(container, "All");
            if (!teams) {
                chipList.setItems([]);
            } else {
                if (teams.length == 1 && teams[0] == "*") {
                    checkbox.checked = true;
                    Dom.addClass(container, "All");
                } else {
                    chipList.setItems(teams.map(function (t) {
                        return {
                            directory: t,
                            name: t
                        };
                    }));
                }
            }
        },
        getValue: function () {
            if (checkbox.checked) return ["*"];
            var items = chipList.getItems();
            console.log("Items of " + name + ":", items);
            return items.map(function (item) {
                return item.directory;
            });
        }
    };
};
TeamFeatureConfigDialog.prototype._configureChipList = function (chipList) {
    if (!this._source) {
        this._source = function (term, callback) {
            if (!term || term.trim().length == 0) {
                callback([]);
            } else {
                $configurationService.searchTeams(term, callback);
            }
        };
        
        this._renderer = function (team, selected) {
            if (selected) return team.directory;
            
            return "<hbox><span title=\"" + team.directory + "\" style=\"font-weight: bold; display: inline-block; width: 6em; overflow: hidden; margin-right: 1em;\">" + Dom.htmlEncode(team.directory) + "</span>" + Dom.htmlEncode(team.name) + "</hbox>";
        };
    }
    chipList.autoCompleteInput.useHtml = true;
    chipList.setup(this._source, this._renderer);
};
TeamFeatureConfigDialog.prototype._save = function() {
    var newConfig = {
        module: this.config.module,
        teams: this.commonList.getValue()
    };
    
    if (this.config.module.mobileSpecific) {
        newConfig.mobileTeamMap = {
            android: this.androidList.getValue(),
            ios: this.iosList.getValue()
        };
    }
    
    var thiz = this;
    $configurationService.updateTeamFeatureModuleConfig(newConfig, function () {
        thiz.close(true);
    }, "Applying...");
};

TeamFeatureConfigDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Apply",
            run: function () {
                thiz._save();
                return false;
            }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/TeamFeatureModuleListView.js";

function TeamFeatureModuleListView() {
    BaseTemplatedWidget.call(this);
    this.title = "Beta Feature Management";

}
__extend(BaseTemplatedWidget, TeamFeatureModuleListView);

TeamFeatureModuleListView._makeTeamDescription = function (teams) {
    if (!teams || teams.length == 0) return Dom.span("<No teams selected>", "NoTeam");
    if (teams.length == 1 && teams[0] == "*") return Dom.span("<All teams>", "All");
    
    return {_name: "hbox", "class": "TeamList", _children: teams.map(function (team) {
        return Dom.span(team);
    })};
}
TeamFeatureModuleListView._makeMobileTeamDescription = function (config) {
    return {_name: "hbox", _children: ["Android", "iOS"].map(function (type) {
        var teams = config.mobileTeamMap ? (config.mobileTeamMap[type.toLowerCase()] || []) : [];
        var display = "<No teams>";
        var clazz = "NoTeam";
        if (teams && teams.length > 0) {
            if (teams.length == 1 && teams[0] == "*") {
                display = "<All teams>";
                clazz = "All";
            } else {
                display = teams.length + " team" + (teams.length > 1 ? "s" : "");
                clazz = "Some";
            }
        }
        return Dom.hbox(
            Dom.label(type + ": "),
            Dom.span(display, clazz),
            "ClientType " + type
        );
    })};
}
TeamFeatureModuleListView.prototype.onAttached = function() {
    this.dataTable.column(new DataTable.GenericDomColumn("Feature/Module", function (item) {
        return Dom.vbox(Dom.strong(item.module.displayName), Dom.span(item.module.key));
    }).width("2*"));
    this.dataTable.column(new DataTable.GenericDomColumn("Teams", function (item) {
        return Dom.vbox(
            TeamFeatureModuleListView._makeTeamDescription(item.teams),
            item.module.mobileSpecific ? TeamFeatureModuleListView._makeMobileTeamDescription(item) : "undefined"
        );
    }).width("3*"));
    
    var thiz = this;
    
    var editAction = {
        icon: "pencil",
        title: "Edit...",
        role: "primary",
        run: function (data, callback) {
            new TeamFeatureConfigDialog().callback(function(updated) {
                if (updated) thiz.reload();
            }).open(data);
        }
    };
    
    this.dataTable.column(new DataTable.GenericDomColumn("", this.dataTable.createActionColumnHandler(editAction)).width("5em"));
    this.dataTable.useFloatingHeader = true;
    this.dataTable.setup();
    
    this.reload();
};

TeamFeatureModuleListView.prototype.reload = function () {
    var thiz = this;
    $configurationService.getAllTeamFeatureModuleConfigs(function (configs) {
        thiz.dataTable.setItems(configs);
    }, "Loading...");
};

if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/feature/FeatureListView.js";

function FeatureListView(node) {
    BaseTemplatedWidget.call(this);

    this._initDataView();
    this.bind("p:ItemClicked", this.dataViewClickedHandler, this.dataView);
};
__extend(BaseTemplatedWidget, FeatureListView);

FeatureListView.prototype.onAttached = function(firstAttached) {
    if (!firstAttached) return;

    this.dataView.boot();
};

FeatureListView.prototype.onItemChanged = function() {
    this.refreshDataList();
};

FeatureListView.prototype.refreshDataList = function() {
    this.dataView.refreshDataList();
};

FeatureListView.prototype._initDataView = function() {
    var thiz = this;

    this.dataView.registerCustomRenderer("feature", function (data, value) {
        var childrenNodes = [{
            _name: "div",
            class: "SubjectName",
            _html: value.name || ""
        }];
        if (value.description) {
            childrenNodes.push({
                _name: "div",
                class: "SubjectDescription",
                _html: value.description || ""
            });
        }

        return {
            _name: "vbox",
            class: "SubjectColumnContent",
            _children: childrenNodes
        }
    }.bind(this));

    this.dataView.registerCustomRenderer("sportType", function (data, value) {
        if (!data.feature.sportType) return "";
        return data.feature.sportType.key || "";
    }.bind(this));

    this.dataView.registerCustomRenderer("onByDefault", function (data, value) {
        return {
            _name: "span",
            class: "FeatureMode " + (data.onByDefault ? "On" : "Off"),
            _text: data.onByDefault ? "PUBLIC" : "LIMITED"
        }
    }.bind(this));

    this.dataView.registerCustomRenderer("dependsOn", function (data, value) {
        if (!data.feature.superiorFeatures) return {};

        var childrenNodes = [];
        data.feature.superiorFeatures.forEach(function(item, i) {
            childrenNodes.push({
                _name: "div",
                class: "Linkable SuperiorName",
                _html: item.name || "",
                "data-key": item.key
            });
        });

        return {
            _name: "hbox",
            class: "SuperiorColumnContent",
            _children: childrenNodes
        }
    }.bind(this));

    this.dataView.registerCustomRenderer("assignedOrgs", function (data, value) {
        var childrenNodes = [];

        if (data.onByDefault) {
            if (data.excludedTeams && data.excludedTeams.length) {
                childrenNodes.push({
                    _name: "div",
                    class: "AssignedTeamName ExcludedTeams",
                    _html: "<strong>" + Util.formatNumber(data.excludedTeams.length) + "</strong>" + ( data.excludedTeams.length == 1 ? " org" : " orgs") + " excluded"
                });
            } else {
                childrenNodes.push({
                    _name: "div",
                    class: "AssignedTeamName AllTeams",
                    _html: "All orgs"
                });
            }
        } else {
            if (data.assignedTeamIds && data.assignedTeamIds.length) {
                var text = "<strong>" + Util.formatNumber(data.assignedTeamIds.length) + "</strong>" + ( data.assignedTeamIds.length == 1 ? " org" : " orgs") + " allowed";
                childrenNodes.push({
                    _name: "div",
                    class: "AssignedTeamName AllowedTeams",
                    _html: text
                });
            } else {
                childrenNodes.push({
                    _name: "div",
                    class: "AssignedTeamName NoTeams",
                    _html: "No orgs"
                });
            }
        }

        return {
            _name: "hbox",
            class: "AssignedTeamColumnContent",
            _children: childrenNodes
        }
    }.bind(this));

    this.dataView.comparer = function(a, b) {
        return (a.feature && a.feature && a.feature.key) == (b.feature && b.feature && b.feature.key);
    };

    this.bind("p:PageLoaded", function () {
        var total = this.dataView.getDiscoveredTotalItems();
        var text = "features.";
        if (total == 1) text = "feature."
        this.summaryLabel.innerHTML = String.format("<span>{0}</span> {1}", total, text);
    }, this.dataView);
};

FeatureListView.prototype.dataViewClickedHandler = function (event) {
    if (event.detail && event.detail.cell && !Dom.hasClass(event.detail.cell, "DTCheckBoxBody")) {
        var data = DataTable.getRowData(event.detail.cell);
        if (!data || !data.feature || !data.feature.key) return;
        this.findUpward(__pkg.FeatureManagementView).openFeature(data.feature.key);
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/feature/FeatureLogDetailView.js";

function FeatureLogDetailView() {
    BaseTemplatedWidget.call(this);
};
__extend(BaseTemplatedWidget, FeatureLogDetailView);

FeatureLogDetailView.prototype.onAttached = function(firstAttached) {
    if (!firstAttached) return;

};

FeatureLogDetailView.prototype.initWith = function(logData) {
    Dom.setInnerText(this.featureText, logData.data.featureName || logData.data.featureKey);
    Dom.setInnerText(this.organizationText, logData.teamName);
    Dom.setInnerText(this.featureSettingText, logData.data.newStatus || "");
    Dom.toggleClass(this.featureSettingText.parentNode, "Inapplicable", logData.data.status == "Removed" && logData.data.newStatus ? false : true);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/feature/FeatureManagementView.js";

function FeatureManagementView() {
    BaseTemplatedWidget.call(this);
    this.title = "Feature Management";

    this.bind("click", this.closeDetail, this.closeButton);
    this.bind("p:ItemChanged", this.onItemChanged, this.detailContainer);
}
__extend(BaseTemplatedWidget, FeatureManagementView);

FeatureManagementView.prototype.getSystemToolbar = function () {
    return this.featureManagementToolbar;
};

FeatureManagementView.prototype.getAdminConsoleTitleSuffix = function () {
    if (!this._currentDetailWidget) return "";
    return " \xA0\xA0 \u2023 \xA0\xA0  " + this._currentDetailWidget.getTitle();
};

FeatureManagementView.prototype.getNavigationModule = function () {
    if (!this._navigationModule) {
        var tabNavigationModule = this.mainTab.getNavigationModule();
        tabNavigationModule._navigate = tabNavigationModule.navigate;
        var thiz = this;
        tabNavigationModule.navigate = function (name, callback) {
            if (name.match(/^feature:(\w+)$/)) {
                var parsedData = CommonNavigation.parseParamsForData(name, thiz.getNavigationParamParser());
                if (parsedData && parsedData.feature) {
                    thiz.openFeature(parsedData.feature, function () {
                        callback(thiz._currentFeatureNavigationModule);
                    });
                    return;
                }
            } else if (name.match(/^team:(\w+)$/)) {
                var parsedData = CommonNavigation.parseParamsForData(name, thiz.getNavigationParamParser());
                if (parsedData && parsedData.team) {
                    thiz.openTeam(parsedData.team, function () {
                        callback(thiz._currentTeamNavigationModule);
                    });
                    return;
                }
            }
            return tabNavigationModule._navigate(name, callback);
        };

        this._navigationModule = tabNavigationModule;
    }

    return this._navigationModule;
};

FeatureManagementView.prototype.getNavigationParamParser = function () {
    if (!this.navigationParamParser) {
        this.navigationParamParser = CommonNavigation.buildNavigationParamParser({
            feature: "String",
            team: "String"
        });
    }

    return this.navigationParamParser;
};

FeatureManagementView.prototype._buildCurrentDetailNavigationModule = function () {
    var thiz = this;
    var navModule = this._currentDetailWidget.getNavigationModule ? this._currentDetailWidget.getNavigationModule() : null;
    var module = {
        navigate: function (name, callback) {
            if (navModule) {
                navModule.navigate(name, callback);
            } else {
                callback(CommonNavigation.newUnnavigatableModule());
            }
        },
        close: function () {
            thiz.closeDetail();
        }
    };
    return module;
};

FeatureManagementView.prototype.openFeature = function (featureKey, callback) {
    var thiz = this;
    var wg = new __pkg.FeatureView({
        featureKey: featureKey,
        onDataLoaded: function () {
            thiz._onDetailDataLoaded("feature:" + featureKey, callback);
        }
    });
    this._openDetail(wg);
};

FeatureManagementView.prototype.openTeam = function (teamId, callback) {
    teamId = parseInt(teamId);

    var thiz = this;
    var wg = new __pkg.TeamView({
        id: teamId,
        onDataLoaded: function () {
            thiz._onDetailDataLoaded("team:" + teamId, callback);
        }
    });
    this._openDetail(wg);
};

FeatureManagementView.prototype._onDetailDataLoaded = function (childModuleNavHash, callback) {
    if (this._currentDetailWidget._loadedSignaled) return;
    this._currentDetailWidget._loadedSignaled = true;
    this._currentDetailNavigationModule = this._buildCurrentDetailNavigationModule();
    CommonNavigation.onNavigateToChildModule(this.getNavigationModule(), childModuleNavHash, this._currentDetailNavigationModule, false);
    Dom.emitEvent("p:AC_FeatureTitleChanged", this.node(), {});
    if (callback) callback();
};

FeatureManagementView.prototype._openDetail = function (widgetInstance) {
    Dom.addClass(this.node(), "WithDetail");
    Dom.addClass(this.featureManagementToolbar, "WithDetail");

    this._currentDetailWidget = widgetInstance;

    this._currentDetailWidget.node().setAttribute("flex", "1");
    this._currentDetailWidget.into(this.detailContainer);
};

FeatureManagementView.prototype.closeDetail = function () {
    CommonNavigation.onNavigationModuleClosed(this._currentDetailNavigationModule);
    this._currentDetailWidget = null;
    this.detailContainer.innerHTML = "";
    Dom.removeClass(this.node(), "WithDetail");
    Dom.removeClass(this.featureManagementToolbar, "WithDetail");

    Dom.emitEvent("p:AC_FeatureTitleChanged", this.node(), {});
    if (this._itemChanged) {
        this.delegateItemChangedEvent();
        this._itemChanged = false;
    }
};

FeatureManagementView.prototype.onItemChanged = function () {
    this._itemChanged = true;
};

FeatureManagementView.prototype.delegateItemChangedEvent = function () {
    var targetTab = this.mainTab.findTabByName("feature-list");
    if (!targetTab) return;

    var n = Dom.findChild(targetTab, {eval: function (x) {
            return x.__widget;
        }
    }, false);

    if (!n) return;
    var widget = n.__widget;
    if (widget && widget.onItemChanged) widget.onItemChanged();
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/feature/FeatureView.js";

function FeatureView(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;

    this.bind("click", this._turnDefaultStatusOn.bind(this), this.turnDefaultStatusOnButton);
    this.bind("click", this._turnDefaultStatusOff.bind(this), this.turnDefaultStatusOffButton);
};
__extend(BaseTemplatedWidget, FeatureView);

FeatureView.prototype.onAttached = function(firstAttached) {
    if (!firstAttached) return;

    if (this.options.featureKey) {
        this.dataView._convertFilterMap = function(valueMap) {
            var map = {};
            if (valueMap) {
                for (var name in valueMap) map[name] = valueMap[name];
            }
            map.featureKey = this.options.featureKey;
            return map;
        }.bind(this);

        this.load(this.options.featureKey);
    }
};

FeatureView.prototype.load = function(featureKey) {
    this.getDetail(featureKey, function() {
        this._initDataView();
        this.dataView.boot();
    }.bind(this));

    if (this.options.onDataLoaded) this.options.onDataLoaded();
};

FeatureView.prototype.getDetail = function(featureKey, callback) {
    $featureManagementService.getFeatureAssignmentDetail(featureKey, function(response) {
        this.detail = response;
        this._render(response);
        if (callback) callback();
    }.bind(this), function(err) {
        Dialog.error("Cannot load feature details", (err && err.message) || "An unknown exception occured.");
    }.bind(this));
};

FeatureView.prototype.refresh = function() {
    this.getDetail(this.detail.feature.key, this.refreshDataList.bind(this));
};

FeatureView.prototype.refreshDataList = function() {
    this.dataView.refreshDataList();
};

FeatureView.prototype.getTitle = function() {
    var title = this.detail && this.detail.feature ? this.detail.feature.name : "???";
    return "Feature" + " \xA0\xA0 \u2023 \xA0\xA0  " + title;
};

FeatureView.prototype._render = function(detail) {
    if (!detail) return;
    
    console.log(detail);

    Dom.setInnerText(this.featureName, detail.feature.name);
    Dom.setInnerText(this.featureDescription, detail.feature.description);
    
    Dom.toggleClass(this.defaultStatusSections, "Disable", !detail.onByDefault);
    
    Dom.addClass(this.node(), "Loaded");

    if (!detail.feature || !detail.feature.superiorFeatures) {
        Dom.addClass(this.node(), "NoDependencies");
    } else {
        Dom.removeClass(this.node(), "NoDependencies");

        this.superiorContainer.innerHTML = "";
        detail.feature.superiorFeatures.forEach(function(item) {
            this.superiorContainer.appendChild(Dom.newDOMElement({
                _name: "div",
                class: "Linkable",
                _html: item.name || ""
            }));
        }.bind(this));
    }

    Dom.emitEvent("p:AC_FeatureTitleChanged", this.node(), {});
};

FeatureView.prototype._initDataView = function() {
    var thiz = this;

    this.dataView.registerCustomRenderer("name", function (data, value) {
        var childrenNodes = [{
            _name: "div",
            class: "SubjectName",
            _html: data.directory || ""
        }, {
            _name: "div",
            class: "SubjectDescription",
            _html: data.name || ""
        }];

        return {
            _name: "vbox",
            class: "SubjectColumnContent",
            _children: childrenNodes
        }
    }.bind(this));

    this.dataView.registerCustomRenderer("status", function (data, value) {
        return {
            _name: "vbox",
            class: "StatusColumnContent",
            _html: value ? (value == "Allowed" ? "Manually allowed" : "Manually disabled") : ""
        }
    }.bind(this));

    this.dataView.registerCustomRenderer("actions", this.dataView.createActionColumnHandler(
        this.getActionsButtonSpec({
            title: "Allow",
            icon: "check-circle",
            role: "primary",
            show: function(data) {
                return (data.availabilityByActionMap && data.availabilityByActionMap.TEAM_FEATURE_ACTIVATE)
                        && !data.status;
            },
            run: function (data, callback) {
                this.activateTeam(data);
            }.bind(this)
        }),
        this.getActionsButtonSpec({
            title: "Resume",
            icon: "check-circle",
            role: "primary",
            show: function(data) {
                return (data.availabilityByActionMap && data.availabilityByActionMap.TEAM_FEATURE_ACTIVATE)
                        && data.status == "Disabled";
            },
            run: function (data, callback) {
                this.activateTeam(data);
            }.bind(this)
        }),
        this.getActionsButtonSpec({
            title: "Disable",
            icon: "flash-off",
            role: "primary",
            show: function(data) {
                return data.availabilityByActionMap && data.availabilityByActionMap.TEAM_FEATURE_DISABLE;
            },
            run: function (data, callback) {
                this.disableTeam(data);
            }.bind(this)
        }),
        this.getActionsButtonSpec({
            title: "Remove team-specific configuration",
            icon: "close",
            role: "danger",
            show: function(data) {
                return data.availabilityByActionMap && data.availabilityByActionMap.TEAM_FEATURE_REMOVE;
            },
            applicable : function (data) {
                return true;
            }.bind(this),
            run: function (data, callback) {
                this.deleteTeam(data);
            }.bind(this)
        })
    ));

    this.dataView.dataTable.getClassOfRow = function (item) {
        if (item.status == "Allowed") return "Status Allowed";
        if (item.status == "Disabled") return "Status Disabled";
        return "";
    };

    this.bind("p:PageLoaded", function () {
        var total = this.dataView.getDiscoveredTotalItems();
        var text = "orgs.";
        if (total == 1) text = "org."
        this.summaryLabel.innerHTML = String.format("<span>{0}</span> {1}", total, text);
    }, this.dataView);
};

FeatureView.prototype.getActionsButtonSpec = function(action) {
    if (!action) return;
    var getSpec = function(data, value) {
        var isShow = typeof(action.show) == "undefined" ? true : action.show(data);
        var spec = {
            _name: "button",
            autocomplete: "off",
            title: action.title || action.label || "",
            "class": "ActionButton" + (action.icon && !action.label ? " IconOnly" : "") + (!isShow ? " Invalid" : ""),
            "action-role": action.role || "normal",
            _children: [
                (action.icon ? {_name: "icon", "class": action.icon} : undefined),
                (action.label ? {_name: "span", _text: action.label} : undefined)
            ]
        }
        if (action.applicable && !action.applicable(data)) {
            spec.disabled = "true";
        }
        return spec;
    };
    return {
        spec: getSpec,
        run: action.run
    }
};

FeatureView.prototype.activateTeam = function(team) {
    if (!team) return;
    $featureManagementService.activateFeatureForTeam(this.detail.feature.key, team.id, function(response) {
        this.refreshDataList();
        Dom.emitEvent("p:ItemChanged", this.node(), {});
    }.bind(this), function(err) {
        var msg;
        if (err && err.code == "activate_feature.failed.dependencies") {
            msg = "Please make sure the features that this one depended on are also activated for the team.";
        } else {
            msg = (err && err.message) || "An unknown exception occured.";
        }

        Dialog.error("Cannot activate the feature!", msg);
    }.bind(this));
};

FeatureView.prototype.disableTeam = function(team) {
    if (!team) return;
    $featureManagementService.disableFeatureOnTeam(this.detail.feature.key, team.id, function(response) {
        this.refreshDataList();
        Dom.emitEvent("p:ItemChanged", this.node(), {});
    }.bind(this), function(err) {
        var msg;
        if (err && err.code == "disable_feature.failed.dependencies") {
            msg = "Please make sure that none of features depended on this feature is activated for the team.";
        } else {
            msg = (err && err.message) || "An unknown exception occured.";
        }

        Dialog.error("Cannot disable the feature!", msg);
    }.bind(this));
};

FeatureView.prototype.deleteTeam = function(team) {
    if (!team) return;
    $featureManagementService.removeFeatureFromTeam(this.detail.feature.key, team.id, function(response) {
        this.refreshDataList();
        Dom.emitEvent("p:ItemChanged", this.node(), {});
    }.bind(this), function(err) {
        var msg;
        if (err && err.code == "remove_feature.failed.dependencies") {
            msg = "Please make sure that none of features depended on this feature is activated for the team.";
        } else {
            msg = (err && err.message) || "An unknown exception occured.";
        }

        Dialog.error("Cannot remove the feature!", msg);
    }.bind(this));
};

FeatureView.prototype._turnDefaultStatusOn = function() {
    if (!this.detail.ableToTurnOnByDefault) return;

    Dialog.confirm("Are you sure you want turn this feature ON globally?", "Turning a feature ON will make it available to all organizations except for ones that are explicitly disabled in the list.",
        "Yes, Turn ON",
        function () {
            $featureManagementService.setDefaultStatusOfFeature(this.detail.feature.key, true, function(response) {
                this.refresh();
                Dom.emitEvent("p:ItemChanged", this.node(), {});
            }.bind(this), function(err) {
                var msg;
                if (err && err.code == "enable_feature.all_teams.failed.dependencies") {
                    msg = "Please make sure the features that this one depended on are also ON.";
                } else {
                    msg = (err && err.message) || "An unknown exception occured.";
                }

                Dialog.error("Cannot turn the feature ON by default!", msg);
            }.bind(this));
        }.bind(this));
};

FeatureView.prototype._turnDefaultStatusOff = function() {
    if (!this.detail.ableToTurnOffByDefault) return;

    Dialog.confirm("Are you sure you want turn this feature OFF?", "Turning a feature OFF will make it unavailable for all organizations except for ones that are explicitly allowed in the list.",
        "Yes, Turn OFF",
        function () {
            $featureManagementService.setDefaultStatusOfFeature(this.detail.feature.key, false, function(response) {
                this.refresh();
                Dom.emitEvent("p:ItemChanged", this.node(), {});
            }.bind(this), function(err) {
                var msg;
                if (err && err.code == "disable_feature.all_teams.failed.dependencies") {
                    msg = "Please make sure that none of features depended on this feature is currently ON.";
                } else {
                    msg = (err && err.message) || "An unknown exception occured.";
                }

                Dialog.error("Cannot turn the feature OFF by default!", msg);
            }.bind(this));
        }.bind(this));
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/feature/TeamListView.js";

function TeamListView(node) {
    BaseTemplatedWidget.call(this);

    this._initDataView();
    this.bind("p:ItemClicked", this.dataViewClickedHandler, this.dataView);
};
__extend(BaseTemplatedWidget, TeamListView);

TeamListView.prototype.onAttached = function(firstAttached) {
    if (!firstAttached) return;

    this.dataView.boot();
};

TeamListView.prototype._initDataView = function() {
    var thiz = this;

    this.dataView.registerCustomRenderer("team", function (data, value) {
        var childrenNodes = [{
            _name: "div",
            class: "SubjectName",
            _html: data.directory || ""
        }, {
            _name: "div",
            class: "SubjectDescription",
            _html: data.name || ""
        }];

        return {
            _name: "vbox",
            class: "SubjectColumnContent",
            _children: childrenNodes
        }
    }.bind(this));

    this.dataView.registerCustomRenderer("deleted", function (data, value) {
        var childrenNodes = [];
        if (value) {
            childrenNodes.push({
                _name: "icon",
                class: "check"
            });
        }

        return {
            _name: "vbox",
            class: "DeletedColumnContent",
            _children: childrenNodes
        }
    }.bind(this));

    this.dataView.registerCustomRenderer("actions", this.dataView.createActionColumnHandler(
        {
            title: "Edit",
            icon: "pencil",
            role: "primary",
            run: function (data, callback) {
                if (!data || !data.id) return;
                this.findUpward(__pkg.FeatureManagementView).openTeam(data.id);
            }.bind(this)
        }
    ));

    this.bind("p:PageLoaded", function () {
        var total = this.dataView.getDiscoveredTotalItems();
        var text = "orgs.";
        if (total == 1) text = "org."
        this.summaryLabel.innerHTML = String.format("<span>{0}</span> {1}", total, text);
    }, this.dataView);
};

TeamListView.prototype.dataViewClickedHandler = function (event) {
    if (event.detail && event.detail.cell && !Dom.hasClass(event.detail.cell, "DTCheckBoxBody")) {
        var rowData = DataTable.getRowData(event.detail.cell);
        if (!rowData || !rowData.id) return;
        this.findUpward(__pkg.FeatureManagementView).openTeam(rowData.id);
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/configuration/feature/TeamView.js";

function TeamView(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
};
__extend(BaseTemplatedWidget, TeamView);

TeamView.prototype.onAttached = function(firstAttached) {
    if (!firstAttached) return;
    this._initDataTable();
    if (this.options.id) this.load(this.options.id);
};

TeamView.prototype.load = function(teamId) {
    this.getDetail(teamId);
    if (this.options.onDataLoaded) this.options.onDataLoaded();
};

TeamView.prototype.getDetail = function(teamId, callback) {
    $featureManagementService.getAllTeamFeatures(teamId, function(response) {
        this.detail = response;
        this._render(response);
        if (callback) callback();
    }.bind(this), function(err) {
        Dialog.error("Cannot load feature details", (err && err.message) || "An unknown exception occured.");
    }.bind(this));
};

TeamView.prototype.refresh = function() {
    this.getDetail(this.detail.id);
};

TeamView.prototype.getTitle = function() {
    var title = this.detail ? (this.detail.name + " (" + this.detail.directory + ")") : "???";
    return "Organization" + " \xA0\xA0 \u2023 \xA0\xA0  " + title;
};

TeamView.prototype._render = function(detail) {
    if (!detail) return;
    
    if (detail.assignmentFeatures) {
        var map = {};
        detail.assignmentFeatures.forEach(function (feature) {
            map[feature.feature.key] = feature;
        });
        
        function dependenciesSatisfied(feature) {
            if (!feature || !feature.feature) return false;
            if (!feature.feature.superiorKeys || feature.feature.superiorKeys.length == 0) return true;
            return feature.feature.superiorKeys.every(function (key) {
                var superFeature = map[key];
                return superFeature && (superFeature.status == "Allowed") && dependenciesSatisfied(superFeature);
            });
        }
        var allowedFeatureMap = {};
        detail.assignmentFeatures.forEach(function (feature) {
            if (feature.status == "Allowed") feature._dependenciesSatisfied = dependenciesSatisfied(feature);
        });
    }
    

    this.dataTable.setItems(detail.assignmentFeatures);
    Dom.emitEvent("p:AC_FeatureTitleChanged", this.node(), {});
};

TeamView.prototype._initDataTable = function() {
    var thiz = this;

    this.dataTable.column(new DataTable.DomNodeColumn("Feature", function (item) {
        if (!item.feature) return {};

        var childrenNodes = [{
            _name: "div",
            class: "SubjectName",
            _html: item.feature.name || ""
        }, {
            _name: "div",
            class: "SubjectDescription",
            _html: item.feature.description || ""
        }];

        return {
            _name: "vbox",
            class: "SubjectColumnContent",
            _children: childrenNodes
        };
    }.bind(this)).width("1*"));

    this.dataTable.column(new DataTable.DomNodeColumn("Depends On", function (item) {
        if (!item.feature.superiorFeatures) return {};

        var childrenNodes = [];
        item.feature.superiorFeatures.forEach(function(feature, i) {
            childrenNodes.push({
                _name: "div",
                class: "Linkable SuperiorName",
                _html: feature.name || "",
                "data-key": feature.key
            });
        });

        return {
            _name: "hbox",
            class: "SuperiorColumnContent",
            _children: childrenNodes
        };
    }.bind(this)).width("20em"));

    this.dataTable.column(new DataTable.DomNodeColumn("Status", function (item) {
        if (!item.status) return {};

        var dependenciesIndicator = "";
        if (item.status == "Allowed" && !item._dependenciesSatisfied) {
            dependenciesIndicator = " <br/><em>Missing dependencies</em>";
        }

        return {
            _name: "vbox",
            "class": "StatusColumnContent" + (item.id ? " Mannual" : "") + (!item._dependenciesSatisfied ? " MissingDependencies" : ""),
            _html: ((item.id ? "Mannually " : "") + item.status + dependenciesIndicator) || ""
        }
    }.bind(this)).width("12em"));

    var activateAction = {
        spec: function (data, index) {
            if (!data.availabilityByActionMap || !data.availabilityByActionMap.TEAM_FEATURE_ACTIVATE) return { _name: "span" };

            return {
                _name: "button",
                autocomplete: "off",
                title: "Activate",
                "class": "ActionButton",
                "action-role": "primary",
                _children: [
                    {_name: "icon", "class": "check-circle"}
                ]
            };
        },
        run: function (data, callback, ev) {
            this.activateTeam(data);
        }.bind(this)
    };

    var disableAction = {
        spec: function (data, index) {
            if (!data.availabilityByActionMap || !data.availabilityByActionMap.TEAM_FEATURE_DISABLE) return { _name: "span" };

            return {
                _name: "button",
                autocomplete: "off",
                title: "Disable",
                "class": "ActionButton",
                "action-role": "primary",
                _children: [
                    {_name: "icon", "class": "flash-off"}
                ]
            };
        },
        run: function (data, callback, ev) {
            this.disableTeam(data);
        }.bind(this)
    };

    var removeAction = {
        spec: function (data, index) {
            if (!data.availabilityByActionMap || !data.availabilityByActionMap.TEAM_FEATURE_REMOVE) return { _name: "span" };

            return {
                _name: "button",
                autocomplete: "off",
                title: "Remove org-specific configuration",
                "class": "ActionButton",
                "action-role": "danger",
                _children: [
                    {_name: "icon", "class": "close"}
                ]
            };
        },
        run: function (data, callback, ev) {
            this.deleteTeam(data);
        }.bind(this)
    };

    var actionsColumnHandler = this.dataTable.createActionColumnHandler(activateAction, disableAction, removeAction);
    this.dataTable.column(new DataTable.GenericDomColumn("Actions", actionsColumnHandler).width("12em"));

    this.dataTable.getClassOfRow = function (item) {
        if (item.status == "Allowed") return "Status Allowed" + (!item._dependenciesSatisfied ? " MissingDependencies" : "");
        if (item.status == "Disabled") return "Status Disabled";
        return "";
    };

    this.dataTable.selector(false, false);
    this.dataTable.withItemComparer = function(a, b) {
        return (a && a.feature && a.feature.key) == (b && b.feature && b.feature.key);
    }
    this.dataTable.useFloatingHeader = true;
    this.dataTable.setup();
};

TeamView.prototype.activateTeam = function(data) {
    if (!data || !data.feature || !data.feature.key) return;
    $featureManagementService.activateFeatureForTeam(data.feature.key, this.detail.id, function(response) {
        this.refresh();
        Dom.emitEvent("p:ItemChanged", this.node(), {});
    }.bind(this), function(err) {
        var msg;
        if (err && err.code == "activate_feature.failed.dependencies") {
            msg = "Please make sure the features that this one depends on are also activated for the team.";
        } else {
            msg = (err && err.message) || "An unknown exception occured.";
        }

        Dialog.error("Cannot activate the feature!", msg);
    }.bind(this));
};

TeamView.prototype.disableTeam = function(data) {
    if (!data || !data.feature || !data.feature.key) return;
    $featureManagementService.disableFeatureOnTeam(data.feature.key, this.detail.id, function(response) {
        this.refresh();
        Dom.emitEvent("p:ItemChanged", this.node(), {});
    }.bind(this), function(err) {
        var msg;
        if (err && err.code == "disable_feature.failed.dependencies") {
            msg = "Please make sure that none of features depending on this feature is activated for the team.";
        } else {
            msg = (err && err.message) || "An unknown exception occured.";
        }

        Dialog.error("Cannot disable the feature!", msg);
    }.bind(this));
};

TeamView.prototype.deleteTeam = function(data) {
    if (!data || !data.feature || !data.feature.key) return;
    $featureManagementService.removeFeatureFromTeam(data.feature.key, this.detail.id, function(response) {
        this.refresh();
        Dom.emitEvent("p:ItemChanged", this.node(), {});
    }.bind(this), function(err) {
        var msg;
        if (err && err.code == "remove_feature.failed.dependencies") {
            msg = "Please make sure that none of features depended on this feature is activated for the team.";
        } else {
            msg = (err && err.message) || "An unknown exception occured.";
        }

        Dialog.error("Cannot remove the feature!", msg);
    }.bind(this));
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/cron/CronAccountListDialog.js";

function CronAccountListDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    this.title = "Team Execution Result";
    
    this.bind("click", function () {
        if (!this.cronTeamResult.resultSummary) return;
        Dialog.alert("Result Summary", this.cronTeamResult.resultSummary);
    }, this.resultLevelLabel);
}
__extend(Dialog, CronAccountListDialog);

CronAccountListDialog.STATUS_MAP = {
    Failed: "Failed",
    SubProcessFailed: "Error in accounts",
    Successful: "Successful"
};
CronAccountListDialog.formatResultLevel = function (level) {
    return CronAccountListDialog.STATUS_MAP[level] || "Unknown";
}

CronAccountListDialog.prototype.setup = function (cronTeamResult) {
    this.cronTeamResult = cronTeamResult;
    Dom.setInnerText(this.teamNameLabel, this.cronTeamResult.teamName);
    
    Dom.setInnerText(this.resultLevelLabel, CronAccountListDialog.formatResultLevel(this.cronTeamResult.resultLevel));
    Dom.addClass(this.resultLevelLabel, "" + this.cronTeamResult.resultLevel);
    
    if (this.cronTeamResult.resultSummary) {
        Dom.addClass(this.resultInfoPane, "HasTeamResultSummary");
    }
    
    Dom.setInnerText(this.startedAtLabel, FormatUtil.formatDate(this.cronTeamResult.startedAt, "datetime_standard_with_zone", "server"));
    Dom.setInnerText(this.finishedAtLabel, FormatUtil.formatDate(this.cronTeamResult.finishedAt, "datetime_standard_with_zone", "server"));
    
    Dom.setInnerText(this.totalAccountsLabel, Util.formatNumber(this.cronTeamResult.accountCount));
    Dom.setInnerText(this.failedAccountsLabel, Util.formatNumber(this.cronTeamResult.accountErrorCount));
};

CronAccountListDialog.prototype.onBeforeShow = function () {
    this.dataView._convertFilterMap = function(valueMap) {
        var map = {};
        if (valueMap) {
            for (var name in valueMap) map[name] = valueMap[name];
        }
        map.cronTeamResultId = "" + this.cronTeamResult.id;
        return map;
    }.bind(this);
    
    var thiz = this;
    this.dataView.setDefaultSelectionHandler(function (data, fieldName) {
        new CronAccountResultDialog().open({
            cronAccountResult: data,
            cronTeamResult: thiz.cronTeamResult
        });
    });
    
    this.dataView.registerCustomRenderer("accountName", function (data, value) {
        var accountNameWrapper = Dom.newDOMElement({
            _name: "hbox",
            "class": "AccountNameWrapper"
        });

        var imageView = new SimpleImageView(Dom.newDOMElement({
            _name: "div"
        }));
        var url = "/rest/accounts/avatar/cdn/" + thiz.cronTeamResult.teamAlias + "/" + data.accountId +"?w=100&t=" + (new Date().getTime());
        imageView.setUrl(url);
        imageView.setCenterCropped(true)
        imageView.into(accountNameWrapper);
        var nameWrapper = Dom.newDOMElement({
            _name: "vbox",
            "class": "NameWrapper",
            "flex": 1
        });
        var name = Dom.newDOMElement({
            _name: "div",
            "class": "AccountName",
            _html: data.accountName
        });
        var email = Dom.newDOMElement({
            _name: "div",
            "class": "AccountEmail",
            _html: data.email
        });
        nameWrapper.appendChild(name);
        nameWrapper.appendChild(email);
        accountNameWrapper.appendChild(nameWrapper)
        return accountNameWrapper;
    });
    
    this.dataView.boot();
}

CronAccountListDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/cron/CronAccountResultDialog.js";

function CronAccountResultDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    this.title = "Account Execution Result";
    
    this.summaryContainer.populator = function (data, binding, node, index) {
        if (data.other) {
            binding.content.appendChild(Dom.newDOMFragment(data.lines.map(function (line) {
                return {
                    _name: "div",
                    _text: line
                }
            })));
        } else {
            Dom.setInnerText(binding.exceptionClassLabel, data.className);
            Dom.setInnerText(binding.messageLabel, data.message);
            
            binding.stack.appendChild(Dom.newDOMFragment(data.stack.map(function (line) {
                return {
                    _name: "div",
                    _text: line
                }
            })));
            
            Dom.toggleClass(binding._node, "WithMessage", data.message ? true : false);
        }
    };
    this.summaryContainer.getTemplateRoleForData = function(data, index) {
        return data.other ? "item-other" : "item-exception";
    }
}
__extend(Dialog, CronAccountResultDialog);

CronAccountResultDialog.STATUS_MAP = {
    Failed: "Failed",
    SubProcessFailed: "SubProcessFailed",
    Successful: "Successful"
};
CronAccountResultDialog.formatResultLevel = function (level) {
    return CronAccountResultDialog.STATUS_MAP[level] || "Unknown";
}

CronAccountResultDialog.prototype.setup = function (data) {
    this.cronAccountResult = data.cronAccountResult;
    this.cronTeamResult = data.cronTeamResult;
    
    Dom.setInnerText(this.accountNameLabel, this.cronAccountResult.accountName);
    
    Dom.setInnerText(this.resultLevelLabel, CronAccountResultDialog.formatResultLevel(this.cronAccountResult.resultLevel));
    Dom.addClass(this.resultLevelLabel, "" + this.cronAccountResult.resultLevel);
    
    Dom.setInnerText(this.startedAtLabel, FormatUtil.formatDate(this.cronAccountResult.startedAt, "datetime_standard_with_zone", "server"));
    Dom.setInnerText(this.finishedAtLabel, FormatUtil.formatDate(this.cronAccountResult.finishedAt, "datetime_standard_with_zone", "server"));
    
    this.imageView.setUrl("/rest/accounts/avatar/cdn/" + this.cronTeamResult.teamAlias + "/" + this.cronAccountResult.accountId +"?w=100&t=" + (new Date().getTime()));
    this.imageView.setCenterCropped(true);
    
    this.summaryContainer.setItems(this.buildSummaryList(this.cronAccountResult.resultSummary));
};

CronAccountResultDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

CronAccountResultDialog.prototype.buildSummaryList = function (summary) {
    var list = [];
    var currentOtherItem = null;
    var lastException = null;
    
    summary.split(/[\r\n]+/).forEach(function (line) {
        line = line.trim();
        if (line.match(/^([a-zA-Z0-9\.]+Exception)$/)) {
            lastException = {
                className: RegExp.$1,
                message: "",
                stack: []
            }
            list.push(lastException);
            currentOtherItem = null;
        } else if (line.match(/^Caused by: ([^ ]+)(: (.+))?$/)) {
            lastException = {
                className: RegExp.$1,
                message: RegExp.$3 || "",
                stack: []
            }
            list.push(lastException);
            currentOtherItem = null;
        } else if (line.match(/^(at (.+))|(\.\.\. [0-9]+ more)$/)) {
            if (!lastException) {
                lastException = {
                    className: "",
                    message: "",
                    stack: []
                }
                list.push(lastException);
                currentOtherItem = null;
            }
            
            lastException.stack.push(line);
        } else {
            if (!currentOtherItem) {
                currentOtherItem = {
                    other: true,
                    lines: []
                };
                list.push(currentOtherItem);
                lastException = null;
            }
            currentOtherItem.lines.push(line);
        }
    });
    
    return list;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/cron/CronInvocationParamsDialog.js";

function CronInvocationParamsDialog() {
    Dialog.call(this);
    this.title = "Invoke Cron Task";
    
    this.bind("click", function () {
        InfoTip.show(this.dateTimeInfoIcon,
                "Simulating the cron as it is invoked at this specific date and time at server time zone.",
                false, null, "tooltip", "left-inside", -1.6 * Util.em(), 0.05 * Util.em());
    }, this.dateTimeInfoIcon);
    
    this.segmentNumberInput.valueAsNumber = 5;

    var thiz = this;
    this.bind("change", function () {
        var alias = this.teamAliasInput.value.trim();
        var handler = function (teamInfo) {
            thiz.teamInfo = teamInfo;
            Dom.setInnerText(thiz.teamNameLabel, teamInfo ? teamInfo.name : (alias ? "<Invalid team alias>" : "(No team specified)"));
            Dom.toggleClass(thiz.teamAliasInput.parentNode, "Invalid", thiz.teamInfo ? false : true);
            // 
            // thiz.dateTimePicker.setCustomTimezoneProvider({
            //     getTimezoneId: function () {
            //         return thiz.teamInfo ? thiz.teamInfo.timeZoneId : TIMEZONES.server;
            //     },
            //     getName: function () {
            //         return thiz.teamInfo ? (teamInfo.name + " team time zone") : "Server time zone";
            //     }
            // });
        };
        if (alias) {
            $cronSupportService.getTeamInfo(alias, handler, "Loading team info...");
        } else {
            handler(null);
        }
    }, this.teamAliasInput);
}
__extend(Dialog, CronInvocationParamsDialog);


CronInvocationParamsDialog.prototype.setup = function (options) {
    this.options = options;
};

CronInvocationParamsDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Invoke Now",
            isCloseHandler: true,
            run: function () {
                var accountId = Number(thiz.accountIdInput.value.trim());
                var params = {
                    targetTeamId: thiz.teamInfo ? thiz.teamInfo.id : 0,
                    targetAccountId: !isNaN(accountId) ? accountId : 0,
                    dateTime: thiz.dateTimePicker.getDate(),
                    skipDependencies: thiz.skipDependenciesCheckbox.checked,
                    segmentCount: thiz.segmentNumberInput.valueAsNumber,
                    logSuccessful: thiz.logAllResultsCheckbox.checked
                };
                
                if (params.targetTeamId <= 0 && params.targetAccountId <= 0) {
                    if (!params.dateTime) {
                        Dialog.error("At least a target team id, a target account id or a mock date needs to be provided to invoke the cron.");
                        return false;
                    }
                }
                
                thiz.close(params);
                
                return false;
            }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/cron/CronMonitoringListView.js";

function CronMonitoringListView() {
    BaseTemplatedWidget.call(this);
    this.title = "CRON - Background Job Monitoring";
}
__extend(BaseTemplatedWidget, CronMonitoringListView);
CronMonitoringListView.STATUS_MAP = {
    Failed: "Failed",
    SubProcessFailed: "Error in teams",
    Successful: "Successful"
};
CronMonitoringListView.formatResultLevel = function (level) {
    return CronMonitoringListView.STATUS_MAP[level] || "Unknown";
}
CronMonitoringListView.prototype.onAttached = function() {
    this.dataTable.column(new DataTable.GenericDomColumn("Job Name", function (item) {
        return Dom.hbox(
            {_name: "icon", "class": "settings"},
            Dom.vbox(Dom.strong(item.displayName), Dom.span("System code: " + item.type))
        );
    }).width("1*"));
    this.dataTable.column(new DataTable.GenericDomColumn("Last Run", function (item) {
        if (!item.lastResult) return Dom.span("");
        return Dom.vbox(
            Dom.strong(FormatUtil.formatDate(item.lastResult.startedAt, "datetime_standard", "server")),
            
            Dom.span(CronMonitoringListView.formatResultLevel(item.lastResult.resultLevel), "Level " + item.lastResult.resultLevel)
        );
    }).width("2*"));
    
    var thiz = this;
    
    this.dataTable.useFloatingHeader = true;
    this.dataTable.setDefaultSelectionHandler({
        run: function (data, event) {
            new CronResultListDialog().open(data);
        }
    });
    this.dataTable.setup();
    
    this.reload();
};

CronMonitoringListView.prototype.reload = function () {
    var thiz = this;
    $cronSupportService.getRegisteredCronTaskTypes(function (infos) {
        thiz.dataTable.setItems(infos);
    }, "Loading...");
};

if (window) window.__currentScriptPath = "/cms/admin/widgets/cron/CronResultListDialog.js";

function CronResultListDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    this.title = "Background Job Execution Log";
    
    this.bind("click", this.handleManualInvoke, this.manualRunButton);
}
__extend(Dialog, CronResultListDialog);

CronResultListDialog.prototype.asyncSetup = function (config, callback) {
    this.config = config;
    Dom.setInnerText(this.taskDisplayNameLabel, this.config.displayName);
    Dom.setInnerText(this.taskKeyLabel, this.config.type);
    
    $cronSupportService.isManualModeEnable(this.config.code, function (enabled) {
        Dom.toggleClass(this.manualRunButton, "Enabled", enabled);
        callback();
    }.bind(this));
};

CronResultListDialog.prototype.onBeforeShow = function () {
    this.dataView._convertFilterMap = function(valueMap) {
        var map = {};
        if (valueMap) {
            for (var name in valueMap) map[name] = valueMap[name];
        }
        map.taskTypeUniqueId = "" + this.config.code;
        return map;
    }.bind(this);
    
    this.dataView.setDefaultSelectionHandler(function (data) {
        new CronTeamListDialog().open(data);
    });
    
    this.dataView.boot();
}

CronResultListDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

CronResultListDialog.prototype.handleManualInvoke = function () {
    var thiz = this;
    new CronInvocationParamsDialog(this.config)
        .callback(function (params) {
            if (!params) return;
            $cronSupportService.executeCronManually(thiz.config.code, params, function (jobId) {
                thiz.startChecking(jobId);
            });
        }).open();
};
CronResultListDialog.prototype.startChecking = function (jobId) {
    var thiz = this;
    var indicator = new Spinner("Invoking...");
    indicator.busy();
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        indicator.progressed(100, 100, "Done.");
                        indicator.done();
                        thiz.dataView.refreshDataList();
                    } else {
                        checker();
                    }
                } else {
                    indicator.done();
                }
            });
        }, 2000);
    })();
};




if (window) window.__currentScriptPath = "/cms/admin/widgets/cron/CronTeamListDialog.js";

function CronTeamListDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    this.title = "Cron Job Execution Result";
    
    this.bind("click", function () {
        var html = [];
        this.cronResult.cmd.split("\n").forEach(function (line) {
            html.push(Dom.htmlEncode(line.replace(/\t/g, "    ")).replace(/  /g, "&#160; "));
        });

        html = html.join("<br/>");
        
        html = html.replace(/\-\-at\-date\-time=([0-9]+)/g, function (zero, time) {
            var date = new Date(parseInt(time, 10));
            var display = "(" + FormatUtil.formatDate(date, "datetime_standard_with_zone", "server") + ", " + moment(date).fromNow() + ")";
            
            return zero + " <span style=\"opacity: 0.5; color: #336699;\">" + display + "</span>";
        });
        
        Dialog.alertHtmlMessage("Invocation", html);
    }, this.viewCommandLink);
}
__extend(Dialog, CronTeamListDialog);

CronTeamListDialog.prototype.setup = function (cronResult) {
    this.cronResult = cronResult;
    Dom.setInnerText(this.taskInstanceNameLabel, this.cronResult.taskInstanceName);
    
    Dom.setInnerText(this.resultLevelLabel, CronMonitoringListView.formatResultLevel(this.cronResult.resultLevel));
    Dom.addClass(this.resultLevelLabel, "" + this.cronResult.resultLevel);
    
    Dom.setInnerText(this.startedAtLabel, FormatUtil.formatDate(this.cronResult.startedAt, "datetime_standard_with_zone", "server"));
    Dom.setInnerText(this.startedFromNowLabel, "(" + moment(this.cronResult.startedAt).fromNow() + ")");
    
    Dom.setInnerText(this.finishedAtLabel, FormatUtil.formatDate(this.cronResult.finishedAt, "datetime_standard_with_zone", "server"));
    
    Dom.setInnerText(this.totalTeamsLabel, Util.formatNumber(this.cronResult.teamCount));
    Dom.setInnerText(this.failedTeamsLabel, Util.formatNumber(this.cronResult.teamErrorCount));
    
    if (!cronResult.withLogFile) {
        this.viewLogLink.style.display = "none";
    } else {
        this.viewLogLink.setAttribute("href", "/team/teamunify/controller/system/cron/log?id=" + cronResult.id);
    }
};

CronTeamListDialog.prototype.onBeforeShow = function () {
    this.dataView._convertFilterMap = function(valueMap) {
        var map = {};
        if (valueMap) {
            for (var name in valueMap) map[name] = valueMap[name];
        }
        map.cronResultId = "" + this.cronResult.id;
        return map;
    }.bind(this);
    
    this.dataView.setDefaultSelectionHandler(function (data) {
        new CronAccountListDialog().open(data);
    });
    
    this.dataView.registerCustomRenderer("teamName", function (data, value, spec) {
        var displayName = data.memberCount && data.memberCount > 0 ? data.memberCount : "0";
        return {
            _name: "strong",
            "class": data.resultLevel,
            _text: value
        };
    });
    this.dataView.registerCustomRenderer("resultLevel", function (data, value, spec) {
        var displayName = data.memberCount && data.memberCount > 0 ? data.memberCount : "0";
        return {
            _name: "span",
            "class": value,
            _text: value
        };
    });
    
    this.dataView.boot();
}

CronTeamListDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/update/CurriculumUpdateReadingView.js";

function CurriculumUpdateReadingView(options) {
    BaseTemplatedWidget.call(this);
    this.currentPath = "";
    this.rootPath = "";

    var thiz = this;
    this.navigationModule = {
        navigate: function (name, callback) {
            callback(null);
        },
        close: function () {
            thiz.back();
        }
    };
};

__extend(BaseTemplatedWidget, CurriculumUpdateReadingView);

CurriculumUpdateReadingView.prototype.setupBreadcrumb = function(rootPath, rootLabel) {
    this.addBreadcrumbPath(rootPath, rootLabel, true);
}

CurriculumUpdateReadingView.prototype.setUpdateItem = function (updateItem) {
    this.updateReaderView.setUpdateItem(updateItem);
    this.addBreadcrumb(updateItem.id, updateItem.title);
    BaseWidget.signalOnSizeChangedRecursively(this.node());
}

CurriculumUpdateReadingView.prototype.setOptions = function(options) {
    this.updateReaderView.setOptions(options);
}

CurriculumUpdateReadingView.prototype.buildBreadcrumbPath = function(key) {
    return this.currentPath + "/" + key;
}

CurriculumUpdateReadingView.prototype.addBreadcrumb = function(key, label) {
    this.addBreadcrumbPath(this.buildBreadcrumbPath(key), label);
}

CurriculumUpdateReadingView.prototype.addBreadcrumbPath = function(path, label, isRootPath) {
    var isRoot = this.rootPath.length < 1 || isRootPath;
    if (isRoot) {
        this.rootPath = path;
        this.breadcrumb.innerHTML = "";
    }

    this.currentPath = path;

    this.breadcrumb.appendChild(Dom.newDOMElement(
        {
            _name: "div",
            "class": "BreadcrumbItem",
            _children: [
                !isRoot ? { _name: "icon", "class": "menu-right"} : undefined,
                {
                    _name: "a",
                    "href": path,
                    "_text": label
                }
            ]
        }));
}

CurriculumUpdateReadingView.prototype.back = function(changed) {
    var modified = changed || this.modified;
    if (this.onCloseCallback) this.onCloseCallback(modified);
}

CurriculumUpdateReadingView.prototype.onAttached = function(first) {
    if (!first) return;
    var parentNode = this.updateReaderView.titleBar.parentNode;
    parentNode && parentNode.removeChild(this.updateReaderView.titleBar);
}

if (window) window.__currentScriptPath = "/cms/admin/widgets/update/TuUpdateListView.js";

function TuUpdateListView() {
    BaseTemplatedWidget.call(this);

    this.bind("click", this.createButtonClickedHandler, this.createButton);
    this.bind("p:ItemSelected", event => event && event.fromUser && this.performSearch(), this.subSystemSelector);
    this.bind("click", this.performSearch, this.searchButton);
    this.bind("keypress", event => (event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN) && this.performSearch(), this.keywordsInput);
    this.bind("p:SelectionChanged", () => this.editActionMenu.invalidate(), this.listView);
    this.bind("click", this.listViewClickedHandler, this.listView);
    Dom.setInnerText(this.viewTitle, this.getViewTitle());
    Dom.toggleClass(this.node(), "Editable", this.isEditable());

    this.editActionMenu.register({
        title: "Edit Update",
        icon: "pencil",
        run: this.editFirstSelectedItem.bind(this),
        applicable: () => this.listView.getSelectedItems().length && this.isEditable(),
    });

    this.editActionMenu.register({
        title: "Delete",
        icon: "delete",
        run: this.handleDeleteAction.bind(this),
        applicable: () => this.listView.getSelectedItems().length && this.isEditable(),
    });
};

__extend(BaseTemplatedWidget, TuUpdateListView);

TuUpdateListView.isSO = function () {
    return "SO" == SERVER_FLAVOR;
};

TuUpdateListView.prototype.getUpdates = function (filters, start, count, onCool, onFailed) {
    $tuUpdateService.getUpdates(filters, start, count, onCool, onFailed);
};

TuUpdateListView.prototype.deleteUpdates = function (ids, onCool) {
    $tuUpdateService.deleteUpdates(ids, onCool);
};

TuUpdateListView.prototype.getUpdateById = function (id, onCool) {
    $tuUpdateService.getUpdateById(id, onCool);
};

TuUpdateListView.prototype.createUpdate = function (updateItem, files, onCool, ctx) {
    $tuUpdateService.createUpdate(updateItem, files, onCool, ctx);
};

TuUpdateListView.prototype.editUpdate = function (updateItem, files, onCool, ctx) {
    $tuUpdateService.editUpdate(updateItem, files, onCool, ctx);
};

TuUpdateListView.prototype.deleteUpdates = function (ids, onCool) {
    $tuUpdateService.deleteUpdates(ids, onCool);
};

TuUpdateListView.prototype.setupSubSystemSelector = function () {
    this.subSystemSelector.comparer = Util.sameId;
    this.subSystemSelector.renderer = function (item) { return item.name; };
    this.subSystemSelector.setItems(TuUpdateListView.SUB_SYSTEMS);
};

TuUpdateListView.prototype._setupView = function () {
    if (this._setupDone) return;
    this.setupSubSystemSelector();

    var thiz = this;
    this.listView.populator = function (data, binding, node) {
        var type =TeamUnifyUpdateSubsystem[data.subsystem];
        var imgSrc = !type ? "" : TuUpdateListView.getSystemIcons(type);
        binding.primaryPhoto.setUrl(imgSrc);
        if (!imgSrc) Dom.addClass(node, "NoIcon");
        Dom.toggleClass(binding._node, "WithVideo", data.video ? true : false);
        Dom.toggleClass(binding._node, "DraftItem", data.published ?  false : true);
        Dom.setInnerText(binding.date, typeof(data.dtCreated) != "undefined" ?
        FormatUtil.formatDate(data.dtCreated, "date_named_full", "local"): "");
        Dom.setInnerText(binding.title, data.title);
        Dom.setInnerText(binding.content, data.summary);
        if (thiz.isEditable() && thiz.registerUpdateActions) {
            binding.actionsWrapper.innerHTML = "";
            var actionMenu = new ActionMenu();
            actionMenu.setTitle({label: "..."});
            actionMenu.into(binding.actionsWrapper);
            thiz.registerUpdateActions(actionMenu, data, node);
            Dom.show(binding.actionsWrapper);
        } else {
            Dom.hide(binding.actionsWrapper);
        }
    }

    this.listView.setSource(this.createSource());
    this._setupDone = true;
};

TuUpdateListView.SUB_SYSTEMS = TuUpdateListView.isSO() ? [
    { name: 'All', id: -1},
    { name: 'Info', id: 0},
    { name: 'SwimOffice', id: 1},
    { name: 'OnDeck', id: 2},
    { name: 'Touchpad', id: 3},
    { name: 'TUMoney', id: 4},
    { name: 'TULessons', id: 5},
    { name: 'Coaching Tools', id: 6}
] :
[
    { name: 'All', id: -1},
    { name: 'Web Application', id: 100},
    { name: 'Mobile', id: 101},
    { name: 'Fundraising', id: 102},
    { name: 'Billing', id: 103},
    { name: 'Website', id: 104}
];

TuUpdateListView.prototype.createSource = function () {
    var thiz = this;
    return {
        loadPage: (start, count, handler, failed) => {
            thiz.getUpdates(this.buildFilter(), start, count,
                (list) => handler(list.result, list.count),
                (err) => Dialog.error(err.message));
        }
    };
};

TuUpdateListView.prototype.buildFilter = function () {
    return {
        term: this.keywordsInput.value.trim(),
        subSystem: this.subSystemSelector.getSelectedItem().id
    };
};

TuUpdateListView.prototype.performSearch = function () {
    this.listView.reload();
};

TuUpdateListView.prototype.onAttached = function () {
};

TuUpdateListView.prototype.updateView = function () {
    if (this._setupDone) {
        if (this.listView.initialized) this.performSearch();
    } else {
        this._setupView();
    }
};

TuUpdateListView.icons = [
    "/cms/images/updates/info_icon.png","/cms/images/updates/SO_icon.png",
    "/cms/images/updates/OD_icon.png","/cms/images/updates/TP_icon.png",
    "/cms/images/updates/TUM_icon.png","/cms/images/updates/TUL_icon.png",
    "/cms/images/updates/MS_icon.png"
];
TuUpdateListView.seStudioLogo =  "/cms/images/updates/SE_logo.png";
TuUpdateListView.logos = [
    "/cms/images/updates/info_logo.png", "/cms/images/updates/SO_logo.png",
    "/cms/images/updates/OD_logo.png", "/cms/images/updates/TP_logo.png",
    "/cms/images/updates/TUM_logo.png", "/cms/images/updates/TUL_logo.png",
    "/cms/images/updates/MS_logo.png"
];

TuUpdateListView.prototype.editFirstSelectedItem = function () {
    this._openUpdateDetail(this.listView.getSelectedItems()[0].id);
};

TuUpdateListView.prototype.handleDeleteAction = function () {
    Dialog.confirm(
        "Delete selected items?",
        "Selected items will be deleted without recovery. Are you sure you want to delete this?",
        "Delete",
        () =>
            this.deleteUpdates(
                this.listView.getSelectedItems().map(Util.idMapFunction),
                this.performSearch.bind(this)
            ),
        "Cancel"
    );
};

TuUpdateListView.getSystemLogo = function (type) {
    return TuUpdateListView.getSystemPhotoByType(TuUpdateListView.logos, type);
};

TuUpdateListView.getSystemIcons = function (type) {
    return TuUpdateListView.getSystemPhotoByType(TuUpdateListView.icons, type);
};

TuUpdateListView.getSystemPhotoByType = function (photos, type) {
    return ""; //SESTUDIO-3579 remove branding
    // if (!TuUpdateListView.isSO()) return TuUpdateListView.seStudioLogo;
    // return type ? photos[type.code] : "";
}

TuUpdateListView.prototype.listViewClickedHandler = function (event) {
    if (!event.target) return;
    if (!Dom.hasClass(event.target, "AnonId_title")) return;

    var updateItem = Dom.findUpwardForData(event.target, "_data");
    if (!updateItem) return;
    var tuUpdateAdminPane = this._getTuUpdateAdminPane();
    if (tuUpdateAdminPane) {
        var readingView = this.getReadingView();
        this.getUpdateById(updateItem.id, (data) => {
            this.openUpdateReadingView(data);
            this.onNavigateToReadingViewModule(data, readingView.navigationModule);
        });
        return;
    }

    this._openUpdateDetail(updateItem.id);
};

TuUpdateListView.prototype.onNavigateToReadingViewModule = function(data, readingViewModule) {
    CommonNavigation.onNavigateToChildModule(this.navigationModule, "" + data.id, readingViewModule, "auto");
}

TuUpdateListView.prototype.getReadingView = function () {
    if (!this._readingView) {
        this._readingView = new UpdateReadingView();
        var thiz = this;
        this._readingView.onCloseCallback = function (changed) {
            var parentNode = this.node().parentNode;
            parentNode && parentNode.removeChild(this.node());
            CommonNavigation.onNavigationModuleClosed(this.navigationModule);
            if (changed) thiz.performSearch();
        };
    }

    this._readingView.setOptions(this.getDetailOption());
    this._readingView.invalidatElements();

    return this._readingView;
};

TuUpdateListView.prototype.openUpdateReadingView = function (updateItem) {
    var tuUpdateAdminPane = this._getTuUpdateAdminPane();
    if (!tuUpdateAdminPane) return;
    var readingView = this.getReadingView();
    readingView.into(tuUpdateAdminPane.node());
    tuUpdateAdminPane.ensureWistiaScriptLoaded(() => readingView.setUpdateItem(updateItem));
};

TuUpdateListView.prototype.createButtonClickedHandler = function (event) {
    this._openUpdateDetail();
};

TuUpdateListView.prototype.getNavigationModule = function () {
    if (this.navigationModule) return this.navigationModule;

    this.navigationModule = {
        navigate: (name, callback) => {
            var id = parseInt(name, 10);
            if (isNaN(id)) {
                callback(null);
            } else {
                var tuUpdateAdminPane = this._getTuUpdateAdminPane();
                if (tuUpdateAdminPane) {
                    var readingView = this.getReadingView();
                    this.getUpdateById(
                        id,
                        (data) => {
                            this.openUpdateReadingView(data);
                            callback(readingView.navigationModule);
                        },
                        console.log
                    );
                }
            }
        },
        close: function () {},
    };

    return this.navigationModule;
};

TuUpdateListView.prototype._openUpdateDetail = function(updateId) {
    var _openUpdateDetailImpl = data => new UpdateDetailDialog(this.getDetailOption())
        .callback(changed => changed && this.performSearch()).open(data);
    if (updateId) {
        this.getUpdateById(updateId, _openUpdateDetailImpl);
    } else {
        _openUpdateDetailImpl();
    }
};

TuUpdateListView.prototype.getDetailOption = function() {
    return {
        subSytemItems: TuUpdateListView.SUB_SYSTEMS,
        editable: this.isEditable(),
        createUpdateFn: this.createUpdate,
        editUpdateFn: this.editUpdate,
        getUpdateByIdFn: this.getUpdateById,
        deleteUpdatesFn: this.deleteUpdates
    }
};

TuUpdateListView.prototype._getTuUpdateAdminPane = function() {
    if (this._adminPane) return this._adminPane;
    if (this._adminPaneTime) return null;
    this._adminPane = this.findUpward(TuUpdateAdminPane);
    this._adminPaneTime = new Date();
    return this._adminPane;
};

TuUpdateListView.prototype.isEditable = function() {
    return PermissionUtils.hasAllPermissions(PERMISSION_KEY.TUUpdate_TUUpdate_ManageAll);
};

TuUpdateListView.prototype.getViewTitle = function() {
    return "SportsEngine Announcements";
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/update/TeamUpdateListView.js";

function TeamUpdateListView(options) {
    this.options = options;
    this.categoriesItems = options.sessionCategories;
    this.teamUpdateLabel = options.teamUpdateLabel;
    this.category = this.categoriesItems[0];
    TuUpdateListView.call(this);
    
    this.levelItems = options.subSystemCategories;
    this.bind("p:ItemSelected", event => event && event.fromUser && this.curriculumSelectorChangedHandler(), this.categorySelector);
    this.bind("p:ItemSelected", event => event && event.fromUser && this.performSearch(), this.levelSelector);
    Dom.setEnabled(PermissionUtils.hasAllPermissions(PERMISSION_KEY.Affiliation_FeatureManagement_Update), this.visibleSwitch);
    this._categoryNavigationModule = CommonNavigation.newUnnavigatableModule();
    Dom.hide(this.subSystemSelector.node());
    this.keywordsInput.placeholder = "Search for Curriculum";
};

__extend(TuUpdateListView, TeamUpdateListView);

TeamUpdateListView.prototype.getUpdates = function (filters, start, count, onCool, onFailed) {
    $teamUpdateService.getUpdates(filters, start, count, onCool, onFailed);
};

TeamUpdateListView.prototype.deleteUpdates = function (ids, onCool) {
    $teamUpdateService.deleteUpdates(ids, onCool);
};

TeamUpdateListView.prototype.getUpdateById = function (id, onCool) {
    $teamUpdateService.getUpdateById(id, onCool);
};

TeamUpdateListView.prototype.createUpdate = function (updateItem, files, onCool, ctx) {
    $teamUpdateService.createUpdate(updateItem, files, onCool, ctx);
};

TeamUpdateListView.prototype.editUpdate = function (updateItem, files, onCool, ctx) {
    $teamUpdateService.editUpdate(updateItem, files, onCool, ctx);
};

TeamUpdateListView.prototype.openUpdateReadingView = function (updateItem) {
    var tuUpdateAdminPane = this._getTuUpdateAdminPane();
    if (!tuUpdateAdminPane) return;
    var readingView = this.getReadingView();
    readingView.into(this.node());
    tuUpdateAdminPane.ensureWistiaScriptLoaded(() => readingView.setUpdateItem(updateItem));
};

TeamUpdateListView.prototype._setupViewImpl = function(skipTimeout) {
    var thiz = this;
    if (this.setupViewTimeout) {
        clearTimeout(this.setupViewTimeout);
    }
    this.setupViewTimeout = setTimeout(function() {
        clearTimeout(thiz.setupViewTimeout);
        thiz._setupView();
    }.bind(this), skipTimeout ? 0 : 100);
}

TeamUpdateListView.prototype.updateView = function () {
    if (this._setupDone) {
        this.performSearch();
    } else {
        this._setupViewImpl();
    }
};

TeamUpdateListView.prototype.getReadingView = function () {
    if (!this._readingView) {
        this._readingView = new CurriculumUpdateReadingView();
        var thiz = this;
        this._readingView.onCloseCallback = function (changed) {
            var parentNode = thiz._readingView.node().parentNode;
            parentNode && parentNode.removeChild(thiz._readingView.node());
            CommonNavigation.onNavigationModuleClosed(this.navigationModule);
        };
    }

    var breadcrumbRootPath = this.buildCategoryURLPath(this.category);
    var breadcrumbRootLabel = this.category.title;
    this._readingView.setupBreadcrumb(breadcrumbRootPath, breadcrumbRootLabel);

    return this._readingView;
};

TeamUpdateListView.prototype.onNavigateToReadingViewModule = function(data, readingViewModule) {
    CommonNavigation.onNavigateToChildModule(this.navigationModule, this.buildCategoryKey(this.category) + "/" + data.id, readingViewModule, "auto");
}

TeamUpdateListView.prototype.getNavigationModule = function() {
    if (this.navigationModule) return this.navigationModule;
    var thiz = this;
    this.navigationModule = {
        navigate: (name, callback) => {
            var id = parseInt(name, 10);
            if (isNaN(id)) {
                var found = null;
                for (var i = 0; i < thiz.categoriesItems.length; i ++) {
                    var h = thiz.categoriesItems[i];
                    var key = thiz.buildCategoryKey(h);
                    if (key == name) {
                        found = h;
                        break;
                    }
                }
                if (found) {
                    if (thiz._readingView && thiz._readingView.onCloseCallback) thiz._readingView.onCloseCallback();
                    var isReloadListNeeded = thiz._setupDone && thiz.category && thiz.category.id != found.id;
                    thiz.category = found;
                    if (!thiz._setupDone) {
                        thiz._setupViewImpl();
                    } else if (isReloadListNeeded) {
                        thiz.categorySelector.selectItemByKey("id", thiz.category.id);
                        thiz.listView.reload();
                    }
                    callback(thiz.navigationModule);
                } else {
                    callback(null);
                }
            } else {
                var tuUpdateAdminPane = this._getTuUpdateAdminPane();
                if (tuUpdateAdminPane) {
                    var readingView = this.getReadingView();
                    $tuUpdateService.getUpdateById(
                        id,
                        (data) => {
                            this.openUpdateReadingView(data);
                            callback(readingView.navigationModule);
                        },
                    );
                }
            }
        },
        close: function () {},
    };

    return this.navigationModule;
};

TeamUpdateListView.prototype.curriculumSelectorChangedHandler = function(event) {
    this.category = this.categorySelector.getSelectedItem();
    CommonNavigation.onNavigateToChildModule(this.navigationModule, this.buildCategoryKey(this.category), this._categoryNavigationModule);
    this.listView.reload();
}

TeamUpdateListView.prototype.canManageCurriculumUpdate = function() {
    return PermissionUtils.hasAllPermissions(PERMISSION_KEY.Affiliation_CurriculumUpdate_CreateEditDelete);
};

TeamUpdateListView.prototype.isEditable = function() {
    return false;
};

TeamUpdateListView.prototype.isCategoryEditable = function() {
    var category = this.category;
    return category && category.editable;
};

TeamUpdateListView.prototype.buildFilter = function() {
    var categoryId = this.category.id;
    var level = (this.levelSelector.getSelectedItem() || {id: -1}).id;
    var keywords = this.keywordsInput.value.trim();
    return {term: keywords, subSystem: level, categoryId: categoryId};
};

TeamUpdateListView.prototype.setupSubSystemSelector = function() {
    Dom.show(this.extraFilterWrapper);
    this.categorySelector.comparer = Util.sameId;
    this.categorySelector.renderer = function (item) { return item.title; };
    this.categorySelector.setItems(this.categoriesItems);
    if (this.category) this.categorySelector.selectItemByKey("id", this.category.id);

    this.levelSelector.comparer = Util.sameId;
    this.levelSelector.renderer = function (item) { return item.title; };
    this.levelSelector.setItems([{title: "All", id: -1}].concat(this.levelItems));
};

TeamUpdateListView.prototype.getDetailOption = function() {
    return {
        subSytemItems: this.levelItems,
        categoryId: this.category.id,
        subSystemLabel: "Level",
        layout: "STRETCH",
        isBreadcrumbEnabled: true,
        breadcrumbRootPath: this.buildCategoryURLPath(this.category),
        breadcrumbRootLabel: this.category.title,
    };
};

TeamUpdateListView.prototype.onAttached = function(first) {
    if (first) this._setupViewImpl();
};

TeamUpdateListView.prototype.isTuUpdateCategory = function() {
    return false;
};

TeamUpdateListView.prototype.getViewTitle = function() {
    return this.teamUpdateLabel;
};

TeamUpdateListView.prototype.buildCategoryKey = function(category) {
    if (!category || !this.options.uriFragmentByCategory) return "";
    return this.options.uriFragmentByCategory[category.id];
}

TeamUpdateListView.prototype.buildCategoryURLPath = function(category) {
    return "#/se-updates/curriculums/" + this.buildCategoryKey(category);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/update/TuUpdateAdminPane.js";

function TuUpdateAdminPane() {
    BaseTemplatedWidget.call(this);

    var thiz = this;

    this.bind("e:TabChange", function (e) {
        var activateTab = thiz.mainTab.getActiveTabPane();
        var tabName = Dom.getAttributeAsString(activateTab, "tab-name");
        var tabHeader = thiz.getTabHeader(tabName);

    }, this.mainTab);

    this.mainTab._activateDefaultTab = function () {
        if (!thiz.mainTab._pluginsAttached) return;
        this.constructor.prototype._activateDefaultTab.call(this);
    }

    this.mainTab.onPluginsAttatched = function() {
        thiz.mainTab._activateDefaultTab();
    };

};

__extend(BaseTemplatedWidget, TuUpdateAdminPane);

TuUpdateAdminPane.prototype.ensureWistiaScriptLoaded = function (callback) {
    if (this._loadWistiaScript) {
        callback();
    } else {
        this.loadJS("https://fast.wistia.com/assets/external/E-v1.js", function () {
            this._loadWistiaScript = true;
            callback();
        });
    }
};

TuUpdateAdminPane.prototype.loadJS = function (scriptStr, callback) {
    if (!this.wistiaScripts) this.wistiaScripts = [];
    var id = "wistia_" + widget.random();
    var script = Dom.newDOMElement({
        _name: "script",
        src: scriptStr,
        id: id,
        type: "text/javascript"
    });
    script.onload = callback;
    var head = document.getElementsByTagName("head")[0];
    if (head) {
        if (typeof(head.append) == "function") {
            head.append(script);
        } else if (typeof(head.appendChild) == "function") {
            head.appendChild(script);
        }
    }
    this.wistiaScripts.push(script);
};

TuUpdateAdminPane.prototype.onAttached = function () {
    var thiz = this;
    $tuUpdateService.getNotificationMap(function (data) {
        if (!data) return;
        var addJewel = function (tabKey, count) {
            var tabHeader = thiz.getTabHeader(tabKey);
            var notificationNode = Dom.newDOMElement({
                _name: "label",
                class: "Badge"
            });
            var span = Dom.newDOMElement({
                _name: "span",
                _html: count
            });
            span._count = count;
            notificationNode.appendChild(span);
            tabHeader.appendChild(notificationNode);
            tabHeader._spanNode = span;
            Dom.addClass(tabHeader, "Notification");
        };

        if (data.updates) {
            addJewel("updates", data.updates);
        }

        if (data.alerts) {
            addJewel("alert-center", data.alerts);
            thiz.mainTab.setActiveTabPane(thiz.alertCenterIframe.parentNode);
        }

    }, function(e) {
        console.log(e);
    });
};

TuUpdateAdminPane.prototype.removeJS = function () {
    var head = document.getElementsByTagName("head")[0];
    if (head) {
        if (this.wistiaScripts && this.wistiaScripts.length) {
            this.wistiaScripts.forEach(function (script){
                head.removeChild(script);
            });
            this.wistiaScripts = [];
        }
    }
    delete this._loadWistiaScript;
};
TuUpdateAdminPane.prototype.onDetached = function () {
    this.removeJS();
};

TuUpdateAdminPane.prototype.getNavigationModule = function () {
    return this.mainTab.getNavigationModule();
};

TuUpdateAdminPane.prototype.getTabHeader = function (tabKey) {
    return this.mainTab.header.querySelector(":scope > .TabHeader[tab-key=\"" + tabKey + "\"]");
};

TuUpdateAdminPane.prototype.handleAdminAlertItemClicked = function(event) {
    var id = event.id;
    if (!id) return;
    if (ADMIN_CONTEXT.AMA2_BETA_TEST_ENABLED) {
        if (id == "member-admin") {
            id = "ama2-members";
        } else if (id == "account-admin") {
            id = "ama2-accounts";
        }
    }
    var navigationDrawer = NavigationDrawer.instance;
    if (navigationDrawer) {
        var feature = navigationDrawer.featureMap[id];
        if (feature) {
            navigationDrawer.openFeature(feature);
        }
    }

};

TuUpdateAdminPane.prototype._canViewCurriculumUpdates = function () {
    return PermissionUtils.hasAllPermissions(PERMISSION_KEY.TeamUpdate_TeamUpdate_View);
};

TuUpdateAdminPane.prototype._canViewProductUpdates = function () {
    return PermissionUtils.hasAllPermissions(PERMISSION_KEY.TUUpdate_TUUpdate_ViewAll);
};

TuUpdateAdminPane.prototype._canManageProductUpdates = function () {
    return PermissionUtils.hasAllPermissions(PERMISSION_KEY.TUUpdate_TUUpdate_ManageAll);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/update/UpdateDetailDialog.js";

function UpdateDetailDialog(options) {
    Dialog.call(this);
    this.options = options || {};
    this.links = [];
    this.contentEditor.setContent("");
    this.grabHeight = true;

    this.subSystemSelector.comparer = Util.sameId;
    this.subSystemSelector.renderer = function (item) { return item.name || item.title; };
    this.subSystemSelector.setItems(this.options.subSytemItems || UpdateDetailDialog.SUB_SYSTEMS);
    if (this.options.subSystemLabel) Dom.setInnerText(this.subSystemLabel, this.options.subSystemLabel);

    var thiz = this;
    this.bind("click", function () {
        new UpdateLinkEditDialog().callback(function (data) {
            if (data) {
                var node = thiz.createLink(data);
                thiz.linkList.appendChild(node);
            }
        }).open();
    }, this.createLinkButton);

    this.bind("click" , function (event){
        var target = Dom.getTarget(event);
        var node = Dom.findUpwardForNodeWithData(target, "_data");
        if (Dom.hasClass(target, "DeleteButton")) {
            thiz.linkList.removeChild(node);
        }
    }, this.linkList);

    this.validationRules = new RuleSet()
                    .live(true)
                    .required(this.titleInput, "Please enter the update title")
                    .required(this.startDateInput, "Please specify the date when this update get listed.")
                    .required(this.contentEditor, "Please enter the update item content.");
}

__extend(Dialog, UpdateDetailDialog);

UpdateDetailDialog.prototype.setup = function (updateItem) {
    this.updateItem = updateItem;

    this.title = this.options.editable ? (updateItem ? "Edit Update" : "Create Update") : "View Update";

    if (this.updateItem) {
        this.titleInput.value = updateItem.title;
        this.startDateInput.setDate(updateItem.dtCreated);

        this.publishedCheckbox.checked = updateItem.published;
        this.summaryInput.value = updateItem.summary;
        this.contentEditor.setReadOnly(!this.options.editable);
        this.contentEditor.setContent(updateItem.copy);
        var subSystemId;
        var type = TeamUnifyUpdateSubsystem[updateItem.subsystem];
        if (updateItem.forTeamUpdate && this.options.subSytemItems) {
            subSystemId = updateItem.subsystemValue;
        } else if (type) {
            subSystemId = type.code;
        }
        if (subSystemId) {
            this.subSystemSelector.selectItemByKey("id", subSystemId);
        }

        this.videoInput.value = updateItem.video;
        if (updateItem.links && updateItem.links.length > 0) {
            for (var i = 0; i < updateItem.links.length; i++) {
                var link = updateItem.links[i];
                var node = this.createLink(link);
                this.linkList.appendChild(node);
            }
        }
        this.mapImages = {};
        var images = updateItem.images;
        if(images && images.length) {
            var photoList = "";
            for (var i = 0; i < images.length; i++) {
                photoList += images[i].uri;
                if (i < images.length - 1) {
                    photoList += ", ";
                }
                this.mapImages[images[i].uri] = images[i];
            }
            this.photoFileUploadView.setCommaSeparatedStoragePaths(photoList);
        }
    } else {
        this.startDateInput.setDate(new Date());
    }
};
UpdateDetailDialog.prototype.onShown = function() {
    if (!this.options.editable) {
        var disabledFunc = function(node) {
            Dom.setEnabled(false, node);
        };
        Dom.doOnSelector(this.dialogBody, "input", disabledFunc);
        Dom.doOnSelector(this.dialogBody, "button", disabledFunc);
        Dom.doOnSelector(this.dialogBody, "textarea", disabledFunc);
    }
}
UpdateDetailDialog.SUB_SYSTEMS = "SO" == SERVER_FLAVOR ? [
    { name: 'Info', id: 0},
    { name: 'SwimOffice', id: 1},
    { name: 'OnDeck', id: 2},
    { name: 'Touchpad', id: 3},
    { name: 'TUMoney', id: 4},
    { name: 'TULessons', id: 5},
    { name: 'Coaching Tools', id: 6}
] : [
    { name: 'Web Application', id: 100},
    { name: 'Mobile', id: 101},
    { name: 'Fundraising', id: 102},
    { name: 'Billing', id: 103},
    { name: 'Website', id: 104}
];

UpdateDetailDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: this.updateItem ? "Save" : "Create",
            run: function () { this.save(); return false; },
            isApplicable: function () { return this.options.editable }.bind(this)
        }
    ]
};

UpdateDetailDialog.prototype.save = function () {
    var updateItem = {};

    if (!ValidationManager.run(this.validationRules)) return;

    updateItem.title = this.titleInput.value.trim();
    updateItem.summary = this.summaryInput.value.trim();
    updateItem.copy = this.contentEditor.getContent();
    updateItem.dtCreated = this.startDateInput.getDate();
    updateItem.published = this.publishedCheckbox.checked;
    updateItem.systemCode = this.subSystemSelector.getSelectedItem().id;
    updateItem.links = this.getLinks();
    updateItem.video = this.videoInput.value;
    updateItem.categoryId = this.options.categoryId;

    this.photoFileUploadView.rebuildFileInfoList();
    var files = this.photoFileUploadView.getSelectedLocalFiles();
    var fileInfos = this.photoFileUploadView.fileInfoList;

    var thiz = this;
    if (this.updateItem) {
        var storagePaths = this.photoFileUploadView.getCommaSeparatedStoragePaths().trim();

        var oldImages = [];
        if (storagePaths) {
            var oldImagePaths = storagePaths.split(",");;
            for (var i = 0; i < oldImagePaths.length; i++) {
                var image = this.mapImages[oldImagePaths[i].trim()];
                if (image) oldImages.push(image);
            }
        }
        updateItem.images = oldImages;
        updateItem.id = this.updateItem.id;
        var indexInfo = {};
        for (var index in fileInfos) {
            var fileInfo = fileInfos[index];
            if (fileInfo.file) {
                indexInfo[fileInfo.file.name] = index;
            } else {
                indexInfo[(fileInfo.storageLocation || "").trim()] = index;
            }
        }
        updateItem.indexInfo = indexInfo;
        this.options.editUpdateFn(updateItem, files,function () {
            thiz.close("updated");
        }, this);
    } else {
        this.options.createUpdateFn(updateItem, files,function () {
            thiz.close("created");
        }, this);
    }
};

UpdateDetailDialog.prototype._generateTargetDetails = function (name, selection) {
    if (!selection || selection.length <= 0) return null;
    if (selection.length == 1 && selection[0] == "*") return "All " + name;
    return selection.length + " " + name;
};

UpdateDetailDialog.prototype.createLink = function (data) {
    var node = Dom.newDOMElement({
        _name: "hbox",
        "class": "Item",
        _children: [
            {
                _name: "a",
                href: data.href,
                _html: data.label,
                target: "_blank"
            },
            {
                _name: "hbox",
                "class": "HoverEditBar",
                _children : [
                    {
                        _name: "icon",
                        "class": "DeleteButton Active",
                        title : "Delete"
                    }
                ]
            }
        ]
    });

    node._data = data;
    return node;
};

UpdateDetailDialog.prototype.getLinks = function () {
    var nodes = this.linkList.childNodes;
    var links = [];
    for (var i = 0; i < nodes.length; i++) {
        var node = nodes[i];
        if (node._data) {
            links.push(node._data);
        }
    }
    return links;
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/update/UpdateLinkEditDialog.js";

function UpdateLinkEditDialog() {
    Dialog.call(this);
    this.title = "Create Link";
}
__extend(Dialog, UpdateLinkEditDialog);


UpdateLinkEditDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Create",
            run: function () { this.save(); return false; }
        }
    ]
};

UpdateLinkEditDialog.prototype.getValidationRules = function () {
    if (this._validationRules) return this._validationRules;
    this._validationRules = new RuleSet()
        .live(true)
        .required(this.labelInput, "Please enter link label")
        .required(this.linkInput, "Please enter link");
    return this._validationRules;
};

UpdateLinkEditDialog.prototype.save = function () {
    if (!ValidationManager.run(this.getValidationRules())) return;

    var item = {};
    item.label = this.labelInput.value;
    item.href = this.linkInput.value;
    this.close(item);
    return;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/update/UpdateReadingView.js";

function UpdateReadingView(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.options = options || {};
    this.modified = false;

    this.bind("click", function () {
        thiz.back();
    }, this.backButton);

    this.bind("click", function () {
        new UpdateDetailDialog(this.options).callback(function (changed) {
            if (changed) {
                thiz.modified = true;
                thiz.reload();
            }
         }).open(this.updateItem);
    }, this.editButton);

    this.bind("click", function () {
        Dialog.confirm("Delete update item?", "This update item will be deleted without recovery. Are you sure you want to delete this?", "Delete",
            function () {
                var ids = [];
                ids.push(thiz.updateItem.id);
                thiz.options.deleteUpdatesFn(ids, function () {
                    thiz.back("deleted");
                });
            },
            "Cancel"
        );
    }, this.deleteButton);

    this.navigationModule = {
        navigate: function (name, callback) {
            callback(null);
        },
        close: function () {
            thiz.back();
        }
    };

    this.linkList.populator = function (data, binding, node) {
        Dom.setInnerText(binding.linkTitle, data.label);
        binding.linkItem.href = data.href
    }
    this.invalidatElements();
};

__extend(BaseTemplatedWidget, UpdateReadingView);

UpdateReadingView.prototype.onAttached = function () {
};
UpdateReadingView.prototype.reload = function() {
    var thiz = this;
    thiz.options.getUpdateByIdFn(thiz.updateItem.id, function (data) {
        thiz.setUpdateItem(data);
    });
}

UpdateReadingView.prototype.back = function(changed) {
    var modified = changed || this.modified;
    if (this.onCloseCallback) this.onCloseCallback(modified);
}
UpdateReadingView.prototype.setUpdateItem = function (updateItem) {
    Dom.setInnerText(this.title, updateItem.title);
    Dom.setInnerText(this.dateLabel, typeof(updateItem.dtCreated) != "undefined" ?
    FormatUtil.formatDate(updateItem.dtCreated, "date_named_full", "local") : "");

    var images = updateItem.images;
    var hasPhotoList = (images && images.length > 0);
    Dom.toggleClass(this.node(), "WithPhotos", hasPhotoList ? true : false);

    var type =TeamUnifyUpdateSubsystem[updateItem.subsystem];
    var imgSrc = !type ? "" : TuUpdateListView.getSystemLogo(type);
    if (imgSrc) {
        this.systemLogo.src = imgSrc;
    }
    if (updateItem.video) {
        Dom.toggleClass(this.node(), "WithVideo", updateItem.video ? true : false);
        this.setInnerHTMLWithScript(this.videoNotePane, updateItem.video || "");
    } else {
        this.videoNotePane.innerHTML = "";
    }
    var urls = [];
    var images = updateItem.images;
    if (images && images.length > 0) {
        for (var i = 0; i < images.length; i++) {
            urls.push(images[i].uri);
        }
        var url = urls.shift();
        this.primaryPhoto.src = url;
    }
    this.setInnerHTMLWithScript(this.contentPane, updateItem.copy || "");

    if (urls.length > 0) {
        this.mediaCollectionView.setUrls(urls);
    }
    Dom.toggleClass(this.node(), "WithExtraPhotos", urls.length > 0);
    var links = updateItem.links;
    if (links && links.length > 0) {
        this.linkList.setItems(links);
    } else {
        this.linkList.setItems([]);
    }
    this.updateItem = updateItem;
    BaseWidget.signalOnSizeChangedRecursively(this.node());
};
UpdateReadingView.prototype.setInnerHTMLWithScript = function(elm, html) {
    elm.innerHTML = html;
    var scripts = elm.getElementsByTagName("script");
    var scriptsClone = [];
    for (var i = 0; i < scripts.length; i++) {
        scriptsClone.push(scripts[i]);
    }
    for (var i = 0; i < scriptsClone.length; i++) {
        var currentScript = scriptsClone[i];
        var s = document.createElement("script");
        for (var j = 0; j < currentScript.attributes.length; j++) {
            var a = currentScript.attributes[j];
            s.setAttribute(a.name, a.value);
        }
        var beforeHtml = currentScript.innerHTML;
        if (beforeHtml && beforeHtml.trim().length > 0) {
            s.appendChild(document.createTextNode(this.removeCodeComments(beforeHtml)));
        }
        currentScript.parentNode.replaceChild(s, currentScript);
    }

}
UpdateReadingView.prototype.removeCodeComments = function(code) {
    return code.replace(/\/\*(.|[\r\n])*?\*\//g, '').replace(/\/\/.*/gm, '');
}

UpdateReadingView.prototype.setOptions = function(options) {
    this.options = options || {};
};

UpdateReadingView.prototype.invalidatElements = function() {
    Dom.toggleClass(this.node(), "Editable", this.options.editable);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/sso/SignInMultiTeamsDialog.js";

function SignInMultiTeamsDialog(data) {
    BoldDialog.call(this);
    this.data = data;
    this.title = "Multi Teams Dialog";
    var ondeckNode = null;
    this.itemRepeaterView.populator = function (data, binding, node) {
        var team = data.secondary || {};
        Dom.setInnerText(binding.itemName, team.name || "");
        binding.itemLogo.setUrl(team.logoUrl || "");
        binding._node._itemData = team;
        if (data.primary == 0) {
            ondeckNode = node;
        }
    };
    var url = TEAM_INFO.seDefaultTeamLogoPath;
    url = url.startsWith("/") ? url : "/" + url;
    this.bannerImageUrl = url;

    this.bind("click", function () {
        var heigth = Dom.getOffsetHeight(this.itemRepeaterView.node().parentNode);
         this.itemRepeaterView.appendItems(this.moreItems);
        this.itemRepeaterView.node().parentNode.scrollTop = heigth;
        Dom.hide(this.moreItemsText);
        var accountId = this.getAccountId();
        if (googleAnalyticsService) {
            googleAnalyticsService.sendFirstTimeEvent(SignInMultiTeamsDialog.FIRSTTIME_SIGNIN_ACTIONS.MORE_CLICK, accountId);
        }
    }.bind(this), this.moreItemsText);

    this.bind("click", function(event) {
        var itemContainer = Dom.findUpwardForNodeWithData(event.target, "_itemData");
        var data = itemContainer._itemData;
    }.bind(this), this.itemRepeaterView);
    Dom.addClass(this.learnMoreBox, "SO" == SERVER_FLAVOR ? "SO" : "");

    this.itemRepeaterView.onAfterAppending = function () {
        if (ondeckNode) {
            this.node().appendChild(ondeckNode);
        }
    }
};
__extend(BoldDialog, SignInMultiTeamsDialog);

SignInMultiTeamsDialog.prototype.getDialogActions = function () {
    var accountId = this.getAccountId();
    return [
        {
            type: "accept", title: "OK",
            run: function () {
                if (googleAnalyticsService) {
                    googleAnalyticsService.sendFirstTimeEvent(SignInMultiTeamsDialog.FIRSTTIME_SIGNIN_ACTIONS.OK_CLICK, accountId);
                }
                return true;
            }
        }
    ];
};

SignInMultiTeamsDialog.FIRSTTIME_SIGNIN_ACTIONS = {
    MORE_CLICK: "firsttime_more_click",
    DISPLAYED: "firsttime_displayed",
    OK_CLICK: "firsttime_ok_click"
};

SignInMultiTeamsDialog.prototype.asyncSetup = function (option, callback) {
    var ondeck = {};
    var team = {};
    var other = [];
    this.data.forEach(function (item) {
        if (item.primary == 0) {
            ondeck = item;
        } else {
            if (item.secondary.id == (TEAM_INFO.id || ADMIN_CONTEXT.teamId)) {
                team = item;
            } else {
                other.push(item);
            }
        }
    });

    var SIZE = 4;
    this.teamItems = [team, ondeck].concat(other);
    this.moreItems = [];
    if (this.teamItems.length > SIZE * 2) {
        this.moreItems = this.teamItems.slice(SIZE);
        this.moreItemsText.innerHTML = String.format("+{0} more " + "organizations", this.moreItems.length);
        this.itemRepeaterView.setItems(this.teamItems.slice(0, SIZE), callback);
    } else {
        this.itemRepeaterView.setItems(this.teamItems, callback);
        Dom.hide(this.moreItemsText);
    }

    var accountId = this.getAccountId();
    if (googleAnalyticsService) {
        googleAnalyticsService.sendFirstTimeEvent(SignInMultiTeamsDialog.FIRSTTIME_SIGNIN_ACTIONS.DISPLAYED, accountId);
    }
};

SignInMultiTeamsDialog.prototype.getAccountId = function () {
    return (typeof(LOGIN_INFO) != "undefined" && LOGIN_INFO.accountId) 
        || (typeof(CONTEXT) != "undefined" && CONTEXT.accountId)
        || (typeof(ADMIN_CONTEXT) != "undefined" && ADMIN_CONTEXT.accountId);
};

if (window) window.__currentScriptPath = "/v2/js/moment-with-locales.min.js";

!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.moment=b()}(this,function(){"use strict";function a(){return le.apply(null,arguments)}
// This is done to register the method called with moment()
// without creating circular dependencies.
function b(a){le=a}function c(a){return a instanceof Array||"[object Array]"===Object.prototype.toString.call(a)}function d(a){
// IE8 will treat undefined and null as object if it wasn't for
// input != null
return null!=a&&"[object Object]"===Object.prototype.toString.call(a)}function e(a){var b;for(b in a)
// even if its not own property I'd still call it non-empty
return!1;return!0}function f(a){return"number"==typeof a||"[object Number]"===Object.prototype.toString.call(a)}function g(a){return a instanceof Date||"[object Date]"===Object.prototype.toString.call(a)}function h(a,b){var c,d=[];for(c=0;c<a.length;++c)d.push(b(a[c],c));return d}function i(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function j(a,b){for(var c in b)i(b,c)&&(a[c]=b[c]);return i(b,"toString")&&(a.toString=b.toString),i(b,"valueOf")&&(a.valueOf=b.valueOf),a}function k(a,b,c,d){return rb(a,b,c,d,!0).utc()}function l(){
// We need to deep clone this object.
return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],meridiem:null}}function m(a){return null==a._pf&&(a._pf=l()),a._pf}function n(a){if(null==a._isValid){var b=m(a),c=ne.call(b.parsedDateParts,function(a){return null!=a}),d=!isNaN(a._d.getTime())&&b.overflow<0&&!b.empty&&!b.invalidMonth&&!b.invalidWeekday&&!b.nullInput&&!b.invalidFormat&&!b.userInvalidated&&(!b.meridiem||b.meridiem&&c);if(a._strict&&(d=d&&0===b.charsLeftOver&&0===b.unusedTokens.length&&void 0===b.bigHour),null!=Object.isFrozen&&Object.isFrozen(a))return d;a._isValid=d}return a._isValid}function o(a){var b=k(NaN);return null!=a?j(m(b),a):m(b).userInvalidated=!0,b}function p(a){return void 0===a}function q(a,b){var c,d,e;if(p(b._isAMomentObject)||(a._isAMomentObject=b._isAMomentObject),p(b._i)||(a._i=b._i),p(b._f)||(a._f=b._f),p(b._l)||(a._l=b._l),p(b._strict)||(a._strict=b._strict),p(b._tzm)||(a._tzm=b._tzm),p(b._isUTC)||(a._isUTC=b._isUTC),p(b._offset)||(a._offset=b._offset),p(b._pf)||(a._pf=m(b)),p(b._locale)||(a._locale=b._locale),oe.length>0)for(c in oe)d=oe[c],e=b[d],p(e)||(a[d]=e);return a}
// Moment prototype object
function r(b){q(this,b),this._d=new Date(null!=b._d?b._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),
// Prevent infinite loop in case updateOffset creates new moment
// objects.
pe===!1&&(pe=!0,a.updateOffset(this),pe=!1)}function s(a){return a instanceof r||null!=a&&null!=a._isAMomentObject}function t(a){return a<0?Math.ceil(a)||0:Math.floor(a)}function u(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=t(b)),c}
// compare two arrays, return the number of differences
function v(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;d<e;d++)(c&&a[d]!==b[d]||!c&&u(a[d])!==u(b[d]))&&g++;return g+f}function w(b){a.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+b)}function x(b,c){var d=!0;return j(function(){if(null!=a.deprecationHandler&&a.deprecationHandler(null,b),d){for(var e,f=[],g=0;g<arguments.length;g++){if(e="","object"==typeof arguments[g]){e+="\n["+g+"] ";for(var h in arguments[0])e+=h+": "+arguments[0][h]+", ";e=e.slice(0,-2)}else e=arguments[g];f.push(e)}w(b+"\nArguments: "+Array.prototype.slice.call(f).join("")+"\n"+(new Error).stack),d=!1}return c.apply(this,arguments)},c)}function y(b,c){null!=a.deprecationHandler&&a.deprecationHandler(b,c),qe[b]||(w(c),qe[b]=!0)}function z(a){return a instanceof Function||"[object Function]"===Object.prototype.toString.call(a)}function A(a){var b,c;for(c in a)b=a[c],z(b)?this[c]=b:this["_"+c]=b;this._config=a,
// Lenient ordinal parsing accepts just a number in addition to
// number + (possibly) stuff coming from _ordinalParseLenient.
this._ordinalParseLenient=new RegExp(this._ordinalParse.source+"|"+/\d{1,2}/.source)}function B(a,b){var c,e=j({},a);for(c in b)i(b,c)&&(d(a[c])&&d(b[c])?(e[c]={},j(e[c],a[c]),j(e[c],b[c])):null!=b[c]?e[c]=b[c]:delete e[c]);for(c in a)i(a,c)&&!i(b,c)&&d(a[c])&&(
// make sure changes to properties don't modify parent config
e[c]=j({},e[c]));return e}function C(a){null!=a&&this.set(a)}function D(a,b,c){var d=this._calendar[a]||this._calendar.sameElse;return z(d)?d.call(b,c):d}function E(a){var b=this._longDateFormat[a],c=this._longDateFormat[a.toUpperCase()];return b||!c?b:(this._longDateFormat[a]=c.replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a])}function F(){return this._invalidDate}function G(a){return this._ordinal.replace("%d",a)}function H(a,b,c,d){var e=this._relativeTime[c];return z(e)?e(a,b,c,d):e.replace(/%d/i,a)}function I(a,b){var c=this._relativeTime[a>0?"future":"past"];return z(c)?c(b):c.replace(/%s/i,b)}function J(a,b){var c=a.toLowerCase();Ae[c]=Ae[c+"s"]=Ae[b]=a}function K(a){return"string"==typeof a?Ae[a]||Ae[a.toLowerCase()]:void 0}function L(a){var b,c,d={};for(c in a)i(a,c)&&(b=K(c),b&&(d[b]=a[c]));return d}function M(a,b){Be[a]=b}function N(a){var b=[];for(var c in a)b.push({unit:c,priority:Be[c]});return b.sort(function(a,b){return a.priority-b.priority}),b}function O(b,c){return function(d){return null!=d?(Q(this,b,d),a.updateOffset(this,c),this):P(this,b)}}function P(a,b){return a.isValid()?a._d["get"+(a._isUTC?"UTC":"")+b]():NaN}function Q(a,b,c){a.isValid()&&a._d["set"+(a._isUTC?"UTC":"")+b](c)}
// MOMENTS
function R(a){return a=K(a),z(this[a])?this[a]():this}function S(a,b){if("object"==typeof a){a=L(a);for(var c=N(a),d=0;d<c.length;d++)this[c[d].unit](a[c[d].unit])}else if(a=K(a),z(this[a]))return this[a](b);return this}function T(a,b,c){var d=""+Math.abs(a),e=b-d.length,f=a>=0;return(f?c?"+":"":"-")+Math.pow(10,Math.max(0,e)).toString().substr(1)+d}
// token:    'M'
// padded:   ['MM', 2]
// ordinal:  'Mo'
// callback: function () { this.month() + 1 }
function U(a,b,c,d){var e=d;"string"==typeof d&&(e=function(){return this[d]()}),a&&(Fe[a]=e),b&&(Fe[b[0]]=function(){return T(e.apply(this,arguments),b[1],b[2])}),c&&(Fe[c]=function(){return this.localeData().ordinal(e.apply(this,arguments),a)})}function V(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function W(a){var b,c,d=a.match(Ce);for(b=0,c=d.length;b<c;b++)Fe[d[b]]?d[b]=Fe[d[b]]:d[b]=V(d[b]);return function(b){var e,f="";for(e=0;e<c;e++)f+=d[e]instanceof Function?d[e].call(b,a):d[e];return f}}
// format date using native date object
function X(a,b){return a.isValid()?(b=Y(b,a.localeData()),Ee[b]=Ee[b]||W(b),Ee[b](a)):a.localeData().invalidDate()}function Y(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(De.lastIndex=0;d>=0&&De.test(a);)a=a.replace(De,c),De.lastIndex=0,d-=1;return a}function Z(a,b,c){Xe[a]=z(b)?b:function(a,d){return a&&c?c:b}}function $(a,b){return i(Xe,a)?Xe[a](b._strict,b._locale):new RegExp(_(a))}
// Code from http://stackoverflow.com/questions/3561493/is-there-a-regexp-escape-function-in-javascript
function _(a){return aa(a.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e}))}function aa(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function ba(a,b){var c,d=b;for("string"==typeof a&&(a=[a]),f(b)&&(d=function(a,c){c[b]=u(a)}),c=0;c<a.length;c++)Ye[a[c]]=d}function ca(a,b){ba(a,function(a,c,d,e){d._w=d._w||{},b(a,d._w,d,e)})}function da(a,b,c){null!=b&&i(Ye,a)&&Ye[a](b,c._a,c,a)}function ea(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function fa(a,b){return a?c(this._months)?this._months[a.month()]:this._months[(this._months.isFormat||hf).test(b)?"format":"standalone"][a.month()]:this._months}function ga(a,b){return a?c(this._monthsShort)?this._monthsShort[a.month()]:this._monthsShort[hf.test(b)?"format":"standalone"][a.month()]:this._monthsShort}function ha(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._monthsParse)for(
// this is not used
this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],d=0;d<12;++d)f=k([2e3,d]),this._shortMonthsParse[d]=this.monthsShort(f,"").toLocaleLowerCase(),this._longMonthsParse[d]=this.months(f,"").toLocaleLowerCase();return c?"MMM"===b?(e=gf.call(this._shortMonthsParse,g),e!==-1?e:null):(e=gf.call(this._longMonthsParse,g),e!==-1?e:null):"MMM"===b?(e=gf.call(this._shortMonthsParse,g),e!==-1?e:(e=gf.call(this._longMonthsParse,g),e!==-1?e:null)):(e=gf.call(this._longMonthsParse,g),e!==-1?e:(e=gf.call(this._shortMonthsParse,g),e!==-1?e:null))}function ia(a,b,c){var d,e,f;if(this._monthsParseExact)return ha.call(this,a,b,c);
// TODO: add sorting
// Sorting makes sure if one month (or abbr) is a prefix of another
// see sorting in computeMonthsParse
for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),d=0;d<12;d++){
// test the regex
if(
// make the regex if we don't have it already
e=k([2e3,d]),c&&!this._longMonthsParse[d]&&(this._longMonthsParse[d]=new RegExp("^"+this.months(e,"").replace(".","")+"$","i"),this._shortMonthsParse[d]=new RegExp("^"+this.monthsShort(e,"").replace(".","")+"$","i")),c||this._monthsParse[d]||(f="^"+this.months(e,"")+"|^"+this.monthsShort(e,""),this._monthsParse[d]=new RegExp(f.replace(".",""),"i")),c&&"MMMM"===b&&this._longMonthsParse[d].test(a))return d;if(c&&"MMM"===b&&this._shortMonthsParse[d].test(a))return d;if(!c&&this._monthsParse[d].test(a))return d}}
// MOMENTS
function ja(a,b){var c;if(!a.isValid())
// No op
return a;if("string"==typeof b)if(/^\d+$/.test(b))b=u(b);else
// TODO: Another silent failure?
if(b=a.localeData().monthsParse(b),!f(b))return a;return c=Math.min(a.date(),ea(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a}function ka(b){return null!=b?(ja(this,b),a.updateOffset(this,!0),this):P(this,"Month")}function la(){return ea(this.year(),this.month())}function ma(a){return this._monthsParseExact?(i(this,"_monthsRegex")||oa.call(this),a?this._monthsShortStrictRegex:this._monthsShortRegex):(i(this,"_monthsShortRegex")||(this._monthsShortRegex=lf),this._monthsShortStrictRegex&&a?this._monthsShortStrictRegex:this._monthsShortRegex)}function na(a){return this._monthsParseExact?(i(this,"_monthsRegex")||oa.call(this),a?this._monthsStrictRegex:this._monthsRegex):(i(this,"_monthsRegex")||(this._monthsRegex=mf),this._monthsStrictRegex&&a?this._monthsStrictRegex:this._monthsRegex)}function oa(){function a(a,b){return b.length-a.length}var b,c,d=[],e=[],f=[];for(b=0;b<12;b++)
// make the regex if we don't have it already
c=k([2e3,b]),d.push(this.monthsShort(c,"")),e.push(this.months(c,"")),f.push(this.months(c,"")),f.push(this.monthsShort(c,""));for(
// Sorting makes sure if one month (or abbr) is a prefix of another it
// will match the longer piece.
d.sort(a),e.sort(a),f.sort(a),b=0;b<12;b++)d[b]=aa(d[b]),e[b]=aa(e[b]);for(b=0;b<24;b++)f[b]=aa(f[b]);this._monthsRegex=new RegExp("^("+f.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+e.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+d.join("|")+")","i")}
// HELPERS
function pa(a){return qa(a)?366:365}function qa(a){return a%4===0&&a%100!==0||a%400===0}function ra(){return qa(this.year())}function sa(a,b,c,d,e,f,g){
//can't just apply() to create a date:
//http://stackoverflow.com/questions/181348/instantiating-a-javascript-object-by-calling-prototype-constructor-apply
var h=new Date(a,b,c,d,e,f,g);
//the date constructor remaps years 0-99 to 1900-1999
return a<100&&a>=0&&isFinite(h.getFullYear())&&h.setFullYear(a),h}function ta(a){var b=new Date(Date.UTC.apply(null,arguments));
//the Date.UTC function remaps years 0-99 to 1900-1999
return a<100&&a>=0&&isFinite(b.getUTCFullYear())&&b.setUTCFullYear(a),b}
// start-of-first-week - start-of-year
function ua(a,b,c){var// first-week day -- which january is always in the first week (4 for iso, 1 for other)
d=7+b-c,
// first-week day local weekday -- which local weekday is fwd
e=(7+ta(a,0,d).getUTCDay()-b)%7;return-e+d-1}
//http://en.wikipedia.org/wiki/ISO_week_date#Calculating_a_date_given_the_year.2C_week_number_and_weekday
function va(a,b,c,d,e){var f,g,h=(7+c-d)%7,i=ua(a,d,e),j=1+7*(b-1)+h+i;return j<=0?(f=a-1,g=pa(f)+j):j>pa(a)?(f=a+1,g=j-pa(a)):(f=a,g=j),{year:f,dayOfYear:g}}function wa(a,b,c){var d,e,f=ua(a.year(),b,c),g=Math.floor((a.dayOfYear()-f-1)/7)+1;return g<1?(e=a.year()-1,d=g+xa(e,b,c)):g>xa(a.year(),b,c)?(d=g-xa(a.year(),b,c),e=a.year()+1):(e=a.year(),d=g),{week:d,year:e}}function xa(a,b,c){var d=ua(a,b,c),e=ua(a+1,b,c);return(pa(a)-d+e)/7}
// HELPERS
// LOCALES
function ya(a){return wa(a,this._week.dow,this._week.doy).week}function za(){return this._week.dow}function Aa(){return this._week.doy}
// MOMENTS
function Ba(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")}function Ca(a){var b=wa(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")}
// HELPERS
function Da(a,b){return"string"!=typeof a?a:isNaN(a)?(a=b.weekdaysParse(a),"number"==typeof a?a:null):parseInt(a,10)}function Ea(a,b){return"string"==typeof a?b.weekdaysParse(a)%7||7:isNaN(a)?null:a}function Fa(a,b){return a?c(this._weekdays)?this._weekdays[a.day()]:this._weekdays[this._weekdays.isFormat.test(b)?"format":"standalone"][a.day()]:this._weekdays}function Ga(a){return a?this._weekdaysShort[a.day()]:this._weekdaysShort}function Ha(a){return a?this._weekdaysMin[a.day()]:this._weekdaysMin}function Ia(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],d=0;d<7;++d)f=k([2e3,1]).day(d),this._minWeekdaysParse[d]=this.weekdaysMin(f,"").toLocaleLowerCase(),this._shortWeekdaysParse[d]=this.weekdaysShort(f,"").toLocaleLowerCase(),this._weekdaysParse[d]=this.weekdays(f,"").toLocaleLowerCase();return c?"dddd"===b?(e=gf.call(this._weekdaysParse,g),e!==-1?e:null):"ddd"===b?(e=gf.call(this._shortWeekdaysParse,g),e!==-1?e:null):(e=gf.call(this._minWeekdaysParse,g),e!==-1?e:null):"dddd"===b?(e=gf.call(this._weekdaysParse,g),e!==-1?e:(e=gf.call(this._shortWeekdaysParse,g),e!==-1?e:(e=gf.call(this._minWeekdaysParse,g),e!==-1?e:null))):"ddd"===b?(e=gf.call(this._shortWeekdaysParse,g),e!==-1?e:(e=gf.call(this._weekdaysParse,g),e!==-1?e:(e=gf.call(this._minWeekdaysParse,g),e!==-1?e:null))):(e=gf.call(this._minWeekdaysParse,g),e!==-1?e:(e=gf.call(this._weekdaysParse,g),e!==-1?e:(e=gf.call(this._shortWeekdaysParse,g),e!==-1?e:null)))}function Ja(a,b,c){var d,e,f;if(this._weekdaysParseExact)return Ia.call(this,a,b,c);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),d=0;d<7;d++){
// test the regex
if(
// make the regex if we don't have it already
e=k([2e3,1]).day(d),c&&!this._fullWeekdaysParse[d]&&(this._fullWeekdaysParse[d]=new RegExp("^"+this.weekdays(e,"").replace(".",".?")+"$","i"),this._shortWeekdaysParse[d]=new RegExp("^"+this.weekdaysShort(e,"").replace(".",".?")+"$","i"),this._minWeekdaysParse[d]=new RegExp("^"+this.weekdaysMin(e,"").replace(".",".?")+"$","i")),this._weekdaysParse[d]||(f="^"+this.weekdays(e,"")+"|^"+this.weekdaysShort(e,"")+"|^"+this.weekdaysMin(e,""),this._weekdaysParse[d]=new RegExp(f.replace(".",""),"i")),c&&"dddd"===b&&this._fullWeekdaysParse[d].test(a))return d;if(c&&"ddd"===b&&this._shortWeekdaysParse[d].test(a))return d;if(c&&"dd"===b&&this._minWeekdaysParse[d].test(a))return d;if(!c&&this._weekdaysParse[d].test(a))return d}}
// MOMENTS
function Ka(a){if(!this.isValid())return null!=a?this:NaN;var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=Da(a,this.localeData()),this.add(a-b,"d")):b}function La(a){if(!this.isValid())return null!=a?this:NaN;var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")}function Ma(a){if(!this.isValid())return null!=a?this:NaN;
// behaves the same as moment#day except
// as a getter, returns 7 instead of 0 (1-7 range instead of 0-6)
// as a setter, sunday should belong to the previous week.
if(null!=a){var b=Ea(a,this.localeData());return this.day(this.day()%7?b:b-7)}return this.day()||7}function Na(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysStrictRegex:this._weekdaysRegex):(i(this,"_weekdaysRegex")||(this._weekdaysRegex=sf),this._weekdaysStrictRegex&&a?this._weekdaysStrictRegex:this._weekdaysRegex)}function Oa(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(i(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=tf),this._weekdaysShortStrictRegex&&a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)}function Pa(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(i(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=uf),this._weekdaysMinStrictRegex&&a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)}function Qa(){function a(a,b){return b.length-a.length}var b,c,d,e,f,g=[],h=[],i=[],j=[];for(b=0;b<7;b++)
// make the regex if we don't have it already
c=k([2e3,1]).day(b),d=this.weekdaysMin(c,""),e=this.weekdaysShort(c,""),f=this.weekdays(c,""),g.push(d),h.push(e),i.push(f),j.push(d),j.push(e),j.push(f);for(
// Sorting makes sure if one weekday (or abbr) is a prefix of another it
// will match the longer piece.
g.sort(a),h.sort(a),i.sort(a),j.sort(a),b=0;b<7;b++)h[b]=aa(h[b]),i[b]=aa(i[b]),j[b]=aa(j[b]);this._weekdaysRegex=new RegExp("^("+j.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+i.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+h.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+g.join("|")+")","i")}
// FORMATTING
function Ra(){return this.hours()%12||12}function Sa(){return this.hours()||24}function Ta(a,b){U(a,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),b)})}
// PARSING
function Ua(a,b){return b._meridiemParse}
// LOCALES
function Va(a){
// IE8 Quirks Mode & IE7 Standards Mode do not allow accessing strings like arrays
// Using charAt should be more compatible.
return"p"===(a+"").toLowerCase().charAt(0)}function Wa(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"}function Xa(a){return a?a.toLowerCase().replace("_","-"):a}
// pick the locale from the array
// try ['en-au', 'en-gb'] as 'en-au', 'en-gb', 'en', as in move through the list trying each
// substring from most specific to least, but move to the next array item if it's a more specific variant than the current root
function Ya(a){for(var b,c,d,e,f=0;f<a.length;){for(e=Xa(a[f]).split("-"),b=e.length,c=Xa(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=Za(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&v(e,c,!0)>=b-1)
//the next array item is better than a shallower substring of this one
break;b--}f++}return null}function Za(a){var b=null;
// TODO: Find a better way to register and load all the locales in Node
if(!zf[a]&&"undefined"!=typeof module&&module&&module.exports)try{b=vf._abbr,require("./locale/"+a),
// because defineLocale currently also sets the global locale, we
// want to undo that for lazy loaded locales
$a(b)}catch(a){}return zf[a]}
// This function will load locale and then set the global locale.  If
// no arguments are passed in, it will simply return the current global
// locale key.
function $a(a,b){var c;
// moment.duration._locale = moment._locale = data;
return a&&(c=p(b)?bb(a):_a(a,b),c&&(vf=c)),vf._abbr}function _a(a,b){if(null!==b){var c=yf;if(b.abbr=a,null!=zf[a])y("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),c=zf[a]._config;else if(null!=b.parentLocale){if(null==zf[b.parentLocale])return Af[b.parentLocale]||(Af[b.parentLocale]=[]),Af[b.parentLocale].push({name:a,config:b}),null;c=zf[b.parentLocale]._config}
// backwards compat for now: also set the locale
// make sure we set the locale AFTER all child locales have been
// created, so we won't end up with the child locale set.
return zf[a]=new C(B(c,b)),Af[a]&&Af[a].forEach(function(a){_a(a.name,a.config)}),$a(a),zf[a]}
// useful for testing
return delete zf[a],null}function ab(a,b){if(null!=b){var c,d=yf;
// MERGE
null!=zf[a]&&(d=zf[a]._config),b=B(d,b),c=new C(b),c.parentLocale=zf[a],zf[a]=c,
// backwards compat for now: also set the locale
$a(a)}else
// pass null for config to unupdate, useful for tests
null!=zf[a]&&(null!=zf[a].parentLocale?zf[a]=zf[a].parentLocale:null!=zf[a]&&delete zf[a]);return zf[a]}
// returns locale data
function bb(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return vf;if(!c(a)){if(
//short-circuit everything else
b=Za(a))return b;a=[a]}return Ya(a)}function cb(){return te(zf)}function db(a){var b,c=a._a;return c&&m(a).overflow===-2&&(b=c[$e]<0||c[$e]>11?$e:c[_e]<1||c[_e]>ea(c[Ze],c[$e])?_e:c[af]<0||c[af]>24||24===c[af]&&(0!==c[bf]||0!==c[cf]||0!==c[df])?af:c[bf]<0||c[bf]>59?bf:c[cf]<0||c[cf]>59?cf:c[df]<0||c[df]>999?df:-1,m(a)._overflowDayOfYear&&(b<Ze||b>_e)&&(b=_e),m(a)._overflowWeeks&&b===-1&&(b=ef),m(a)._overflowWeekday&&b===-1&&(b=ff),m(a).overflow=b),a}
// date from iso format
function eb(a){var b,c,d,e,f,g,h=a._i,i=Bf.exec(h)||Cf.exec(h);if(i){for(m(a).iso=!0,b=0,c=Ef.length;b<c;b++)if(Ef[b][1].exec(i[1])){e=Ef[b][0],d=Ef[b][2]!==!1;break}if(null==e)return void(a._isValid=!1);if(i[3]){for(b=0,c=Ff.length;b<c;b++)if(Ff[b][1].exec(i[3])){
// match[2] should be 'T' or space
f=(i[2]||" ")+Ff[b][0];break}if(null==f)return void(a._isValid=!1)}if(!d&&null!=f)return void(a._isValid=!1);if(i[4]){if(!Df.exec(i[4]))return void(a._isValid=!1);g="Z"}a._f=e+(f||"")+(g||""),kb(a)}else a._isValid=!1}
// date from iso format or fallback
function fb(b){var c=Gf.exec(b._i);return null!==c?void(b._d=new Date(+c[1])):(eb(b),void(b._isValid===!1&&(delete b._isValid,a.createFromInputFallback(b))))}
// Pick the first defined of two or three arguments.
function gb(a,b,c){return null!=a?a:null!=b?b:c}function hb(b){
// hooks is actually the exported moment object
var c=new Date(a.now());return b._useUTC?[c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()]:[c.getFullYear(),c.getMonth(),c.getDate()]}
// convert an array to a date.
// the array should mirror the parameters below
// note: all values past the year are optional and will default to the lowest possible value.
// [year, month, day , hour, minute, second, millisecond]
function ib(a){var b,c,d,e,f=[];if(!a._d){
// Default to current date.
// * if no year, month, day of month are given, default to today
// * if day of month is given, default month and year
// * if month is given, default only year
// * if year is given, don't default anything
for(d=hb(a),
//compute day of the year from weeks and weekdays
a._w&&null==a._a[_e]&&null==a._a[$e]&&jb(a),
//if the day of the year is set, figure out what it is
a._dayOfYear&&(e=gb(a._a[Ze],d[Ze]),a._dayOfYear>pa(e)&&(m(a)._overflowDayOfYear=!0),c=ta(e,0,a._dayOfYear),a._a[$e]=c.getUTCMonth(),a._a[_e]=c.getUTCDate()),b=0;b<3&&null==a._a[b];++b)a._a[b]=f[b]=d[b];
// Zero out whatever was not defaulted, including time
for(;b<7;b++)a._a[b]=f[b]=null==a._a[b]?2===b?1:0:a._a[b];
// Check for 24:00:00.000
24===a._a[af]&&0===a._a[bf]&&0===a._a[cf]&&0===a._a[df]&&(a._nextDay=!0,a._a[af]=0),a._d=(a._useUTC?ta:sa).apply(null,f),
// Apply timezone offset from input. The actual utcOffset can be changed
// with parseZone.
null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()-a._tzm),a._nextDay&&(a._a[af]=24)}}function jb(a){var b,c,d,e,f,g,h,i;if(b=a._w,null!=b.GG||null!=b.W||null!=b.E)f=1,g=4,
// TODO: We need to take the current isoWeekYear, but that depends on
// how we interpret now (local, utc, fixed offset). So create
// a now version of current config (take local/utc/offset flags, and
// create now).
c=gb(b.GG,a._a[Ze],wa(sb(),1,4).year),d=gb(b.W,1),e=gb(b.E,1),(e<1||e>7)&&(i=!0);else{f=a._locale._week.dow,g=a._locale._week.doy;var j=wa(sb(),f,g);c=gb(b.gg,a._a[Ze],j.year),
// Default to current week.
d=gb(b.w,j.week),null!=b.d?(
// weekday -- low day numbers are considered next week
e=b.d,(e<0||e>6)&&(i=!0)):null!=b.e?(
// local weekday -- counting starts from begining of week
e=b.e+f,(b.e<0||b.e>6)&&(i=!0)):
// default to begining of week
e=f}d<1||d>xa(c,f,g)?m(a)._overflowWeeks=!0:null!=i?m(a)._overflowWeekday=!0:(h=va(c,d,e,f,g),a._a[Ze]=h.year,a._dayOfYear=h.dayOfYear)}
// date from string and format string
function kb(b){
// TODO: Move this to another part of the creation flow to prevent circular deps
if(b._f===a.ISO_8601)return void eb(b);b._a=[],m(b).empty=!0;
// This array is used to make a Date, either with `new Date` or `Date.UTC`
var c,d,e,f,g,h=""+b._i,i=h.length,j=0;for(e=Y(b._f,b._locale).match(Ce)||[],c=0;c<e.length;c++)f=e[c],d=(h.match($(f,b))||[])[0],
// console.log('token', token, 'parsedInput', parsedInput,
//         'regex', getParseRegexForToken(token, config));
d&&(g=h.substr(0,h.indexOf(d)),g.length>0&&m(b).unusedInput.push(g),h=h.slice(h.indexOf(d)+d.length),j+=d.length),
// don't parse if it's not a known token
Fe[f]?(d?m(b).empty=!1:m(b).unusedTokens.push(f),da(f,d,b)):b._strict&&!d&&m(b).unusedTokens.push(f);
// add remaining unparsed input length to the string
m(b).charsLeftOver=i-j,h.length>0&&m(b).unusedInput.push(h),
// clear _12h flag if hour is <= 12
b._a[af]<=12&&m(b).bigHour===!0&&b._a[af]>0&&(m(b).bigHour=void 0),m(b).parsedDateParts=b._a.slice(0),m(b).meridiem=b._meridiem,
// handle meridiem
b._a[af]=lb(b._locale,b._a[af],b._meridiem),ib(b),db(b)}function lb(a,b,c){var d;
// Fallback
return null==c?b:null!=a.meridiemHour?a.meridiemHour(b,c):null!=a.isPM?(d=a.isPM(c),d&&b<12&&(b+=12),d||12!==b||(b=0),b):b}
// date from string and array of format strings
function mb(a){var b,c,d,e,f;if(0===a._f.length)return m(a).invalidFormat=!0,void(a._d=new Date(NaN));for(e=0;e<a._f.length;e++)f=0,b=q({},a),null!=a._useUTC&&(b._useUTC=a._useUTC),b._f=a._f[e],kb(b),n(b)&&(
// if there is any input that was not parsed add a penalty for that format
f+=m(b).charsLeftOver,
//or tokens
f+=10*m(b).unusedTokens.length,m(b).score=f,(null==d||f<d)&&(d=f,c=b));j(a,c||b)}function nb(a){if(!a._d){var b=L(a._i);a._a=h([b.year,b.month,b.day||b.date,b.hour,b.minute,b.second,b.millisecond],function(a){return a&&parseInt(a,10)}),ib(a)}}function ob(a){var b=new r(db(pb(a)));
// Adding is smart enough around DST
return b._nextDay&&(b.add(1,"d"),b._nextDay=void 0),b}function pb(a){var b=a._i,d=a._f;return a._locale=a._locale||bb(a._l),null===b||void 0===d&&""===b?o({nullInput:!0}):("string"==typeof b&&(a._i=b=a._locale.preparse(b)),s(b)?new r(db(b)):(g(b)?a._d=b:c(d)?mb(a):d?kb(a):qb(a),n(a)||(a._d=null),a))}function qb(b){var d=b._i;void 0===d?b._d=new Date(a.now()):g(d)?b._d=new Date(d.valueOf()):"string"==typeof d?fb(b):c(d)?(b._a=h(d.slice(0),function(a){return parseInt(a,10)}),ib(b)):"object"==typeof d?nb(b):f(d)?
// from milliseconds
b._d=new Date(d):a.createFromInputFallback(b)}function rb(a,b,f,g,h){var i={};
// object construction must be done this way.
// https://github.com/moment/moment/issues/1423
return f!==!0&&f!==!1||(g=f,f=void 0),(d(a)&&e(a)||c(a)&&0===a.length)&&(a=void 0),i._isAMomentObject=!0,i._useUTC=i._isUTC=h,i._l=f,i._i=a,i._f=b,i._strict=g,ob(i)}function sb(a,b,c,d){return rb(a,b,c,d,!1)}
// Pick a moment m from moments so that m[fn](other) is true for all
// other. This relies on the function fn to be transitive.
//
// moments should either be an array of moment objects or an array, whose
// first element is an array of moment objects.
function tb(a,b){var d,e;if(1===b.length&&c(b[0])&&(b=b[0]),!b.length)return sb();for(d=b[0],e=1;e<b.length;++e)b[e].isValid()&&!b[e][a](d)||(d=b[e]);return d}
// TODO: Use [].sort instead?
function ub(){var a=[].slice.call(arguments,0);return tb("isBefore",a)}function vb(){var a=[].slice.call(arguments,0);return tb("isAfter",a)}function wb(a){var b=L(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;
// representation for dateAddRemove
this._milliseconds=+k+1e3*j+// 1000
6e4*i+// 1000 * 60
1e3*h*60*60,//using 1000 * 60 * 60 instead of 36e5 to avoid floating point rounding errors https://github.com/moment/moment/issues/2978
// Because of dateAddRemove treats 24 hours as different from a
// day when working around DST, we need to store them separately
this._days=+g+7*f,
// It is impossible translate months into days without knowing
// which months you are are talking about, so we have to store
// it separately.
this._months=+e+3*d+12*c,this._data={},this._locale=bb(),this._bubble()}function xb(a){return a instanceof wb}function yb(a){return a<0?Math.round(-1*a)*-1:Math.round(a)}
// FORMATTING
function zb(a,b){U(a,0,0,function(){var a=this.utcOffset(),c="+";return a<0&&(a=-a,c="-"),c+T(~~(a/60),2)+b+T(~~a%60,2)})}function Ab(a,b){var c=(b||"").match(a);if(null===c)return null;var d=c[c.length-1]||[],e=(d+"").match(Kf)||["-",0,0],f=+(60*e[1])+u(e[2]);return 0===f?0:"+"===e[0]?f:-f}
// Return a moment from input, that is local/utc/zone equivalent to model.
function Bb(b,c){var d,e;
// Use low-level api, because this fn is low-level api.
return c._isUTC?(d=c.clone(),e=(s(b)||g(b)?b.valueOf():sb(b).valueOf())-d.valueOf(),d._d.setTime(d._d.valueOf()+e),a.updateOffset(d,!1),d):sb(b).local()}function Cb(a){
// On Firefox.24 Date#getTimezoneOffset returns a floating point.
// https://github.com/moment/moment/pull/1871
return 15*-Math.round(a._d.getTimezoneOffset()/15)}
// MOMENTS
// keepLocalTime = true means only change the timezone, without
// affecting the local hour. So 5:31:26 +0300 --[utcOffset(2, true)]-->
// 5:31:26 +0200 It is possible that 5:31:26 doesn't exist with offset
// +0200, so we adjust the time as needed, to be valid.
//
// Keeping the time actually adds/subtracts (one hour)
// from the actual represented time. That is why we call updateOffset
// a second time. In case it wants us to change the offset again
// _changeInProgress == true case, then we have to adjust, because
// there is no such time in the given timezone.
function Db(b,c){var d,e=this._offset||0;if(!this.isValid())return null!=b?this:NaN;if(null!=b){if("string"==typeof b){if(b=Ab(Ue,b),null===b)return this}else Math.abs(b)<16&&(b=60*b);return!this._isUTC&&c&&(d=Cb(this)),this._offset=b,this._isUTC=!0,null!=d&&this.add(d,"m"),e!==b&&(!c||this._changeInProgress?Tb(this,Ob(b-e,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,a.updateOffset(this,!0),this._changeInProgress=null)),this}return this._isUTC?e:Cb(this)}function Eb(a,b){return null!=a?("string"!=typeof a&&(a=-a),this.utcOffset(a,b),this):-this.utcOffset()}function Fb(a){return this.utcOffset(0,a)}function Gb(a){return this._isUTC&&(this.utcOffset(0,a),this._isUTC=!1,a&&this.subtract(Cb(this),"m")),this}function Hb(){if(null!=this._tzm)this.utcOffset(this._tzm);else if("string"==typeof this._i){var a=Ab(Te,this._i);null!=a?this.utcOffset(a):this.utcOffset(0,!0)}return this}function Ib(a){return!!this.isValid()&&(a=a?sb(a).utcOffset():0,(this.utcOffset()-a)%60===0)}function Jb(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Kb(){if(!p(this._isDSTShifted))return this._isDSTShifted;var a={};if(q(a,this),a=pb(a),a._a){var b=a._isUTC?k(a._a):sb(a._a);this._isDSTShifted=this.isValid()&&v(a._a,b.toArray())>0}else this._isDSTShifted=!1;return this._isDSTShifted}function Lb(){return!!this.isValid()&&!this._isUTC}function Mb(){return!!this.isValid()&&this._isUTC}function Nb(){return!!this.isValid()&&(this._isUTC&&0===this._offset)}function Ob(a,b){var c,d,e,g=a,
// matching against regexp is expensive, do it on demand
h=null;// checks for null or undefined
return xb(a)?g={ms:a._milliseconds,d:a._days,M:a._months}:f(a)?(g={},b?g[b]=a:g.milliseconds=a):(h=Lf.exec(a))?(c="-"===h[1]?-1:1,g={y:0,d:u(h[_e])*c,h:u(h[af])*c,m:u(h[bf])*c,s:u(h[cf])*c,ms:u(yb(1e3*h[df]))*c}):(h=Mf.exec(a))?(c="-"===h[1]?-1:1,g={y:Pb(h[2],c),M:Pb(h[3],c),w:Pb(h[4],c),d:Pb(h[5],c),h:Pb(h[6],c),m:Pb(h[7],c),s:Pb(h[8],c)}):null==g?g={}:"object"==typeof g&&("from"in g||"to"in g)&&(e=Rb(sb(g.from),sb(g.to)),g={},g.ms=e.milliseconds,g.M=e.months),d=new wb(g),xb(a)&&i(a,"_locale")&&(d._locale=a._locale),d}function Pb(a,b){
// We'd normally use ~~inp for this, but unfortunately it also
// converts floats to ints.
// inp may be undefined, so careful calling replace on it.
var c=a&&parseFloat(a.replace(",","."));
// apply sign while we're at it
return(isNaN(c)?0:c)*b}function Qb(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function Rb(a,b){var c;return a.isValid()&&b.isValid()?(b=Bb(b,a),a.isBefore(b)?c=Qb(a,b):(c=Qb(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c):{milliseconds:0,months:0}}
// TODO: remove 'name' arg after deprecation is removed
function Sb(a,b){return function(c,d){var e,f;
//invert the arguments, but complain about it
return null===d||isNaN(+d)||(y(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),f=c,c=d,d=f),c="string"==typeof c?+c:c,e=Ob(c,d),Tb(this,e,a),this}}function Tb(b,c,d,e){var f=c._milliseconds,g=yb(c._days),h=yb(c._months);b.isValid()&&(e=null==e||e,f&&b._d.setTime(b._d.valueOf()+f*d),g&&Q(b,"Date",P(b,"Date")+g*d),h&&ja(b,P(b,"Month")+h*d),e&&a.updateOffset(b,g||h))}function Ub(a,b){var c=a.diff(b,"days",!0);return c<-6?"sameElse":c<-1?"lastWeek":c<0?"lastDay":c<1?"sameDay":c<2?"nextDay":c<7?"nextWeek":"sameElse"}function Vb(b,c){
// We want to compare the start of today, vs this.
// Getting start-of-today depends on whether we're local/utc/offset or not.
var d=b||sb(),e=Bb(d,this).startOf("day"),f=a.calendarFormat(this,e)||"sameElse",g=c&&(z(c[f])?c[f].call(this,d):c[f]);return this.format(g||this.localeData().calendar(f,this,sb(d)))}function Wb(){return new r(this)}function Xb(a,b){var c=s(a)?a:sb(a);return!(!this.isValid()||!c.isValid())&&(b=K(p(b)?"millisecond":b),"millisecond"===b?this.valueOf()>c.valueOf():c.valueOf()<this.clone().startOf(b).valueOf())}function Yb(a,b){var c=s(a)?a:sb(a);return!(!this.isValid()||!c.isValid())&&(b=K(p(b)?"millisecond":b),"millisecond"===b?this.valueOf()<c.valueOf():this.clone().endOf(b).valueOf()<c.valueOf())}function Zb(a,b,c,d){return d=d||"()",("("===d[0]?this.isAfter(a,c):!this.isBefore(a,c))&&(")"===d[1]?this.isBefore(b,c):!this.isAfter(b,c))}function $b(a,b){var c,d=s(a)?a:sb(a);return!(!this.isValid()||!d.isValid())&&(b=K(b||"millisecond"),"millisecond"===b?this.valueOf()===d.valueOf():(c=d.valueOf(),this.clone().startOf(b).valueOf()<=c&&c<=this.clone().endOf(b).valueOf()))}function _b(a,b){return this.isSame(a,b)||this.isAfter(a,b)}function ac(a,b){return this.isSame(a,b)||this.isBefore(a,b)}function bc(a,b,c){var d,e,f,g;// 1000
// 1000 * 60
// 1000 * 60 * 60
// 1000 * 60 * 60 * 24, negate dst
// 1000 * 60 * 60 * 24 * 7, negate dst
return this.isValid()?(d=Bb(a,this),d.isValid()?(e=6e4*(d.utcOffset()-this.utcOffset()),b=K(b),"year"===b||"month"===b||"quarter"===b?(g=cc(this,d),"quarter"===b?g/=3:"year"===b&&(g/=12)):(f=this-d,g="second"===b?f/1e3:"minute"===b?f/6e4:"hour"===b?f/36e5:"day"===b?(f-e)/864e5:"week"===b?(f-e)/6048e5:f),c?g:t(g)):NaN):NaN}function cc(a,b){
// difference in months
var c,d,e=12*(b.year()-a.year())+(b.month()-a.month()),
// b is in (anchor - 1 month, anchor + 1 month)
f=a.clone().add(e,"months");
//check for negative zero, return zero if negative zero
// linear across the month
// linear across the month
return b-f<0?(c=a.clone().add(e-1,"months"),d=(b-f)/(f-c)):(c=a.clone().add(e+1,"months"),d=(b-f)/(c-f)),-(e+d)||0}function dc(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function ec(){var a=this.clone().utc();return 0<a.year()&&a.year()<=9999?z(Date.prototype.toISOString)?this.toDate().toISOString():X(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):X(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}/**
 * Return a human readable representation of a moment that can
 * also be evaluated to get a new moment which is the same
 *
 * @link https://nodejs.org/dist/latest/docs/api/util.html#util_custom_inspect_function_on_objects
 */
function fc(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var a="moment",b="";this.isLocal()||(a=0===this.utcOffset()?"moment.utc":"moment.parseZone",b="Z");var c="["+a+'("]',d=0<this.year()&&this.year()<=9999?"YYYY":"YYYYYY",e="-MM-DD[T]HH:mm:ss.SSS",f=b+'[")]';return this.format(c+d+e+f)}function gc(b){b||(b=this.isUtc()?a.defaultFormatUtc:a.defaultFormat);var c=X(this,b);return this.localeData().postformat(c)}function hc(a,b){return this.isValid()&&(s(a)&&a.isValid()||sb(a).isValid())?Ob({to:this,from:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function ic(a){return this.from(sb(),a)}function jc(a,b){return this.isValid()&&(s(a)&&a.isValid()||sb(a).isValid())?Ob({from:this,to:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function kc(a){return this.to(sb(),a)}
// If passed a locale key, it will set the locale for this
// instance.  Otherwise, it will return the locale configuration
// variables for this instance.
function lc(a){var b;return void 0===a?this._locale._abbr:(b=bb(a),null!=b&&(this._locale=b),this)}function mc(){return this._locale}function nc(a){
// the following switch intentionally omits break keywords
// to utilize falling through the cases.
switch(a=K(a)){case"year":this.month(0);/* falls through */
case"quarter":case"month":this.date(1);/* falls through */
case"week":case"isoWeek":case"day":case"date":this.hours(0);/* falls through */
case"hour":this.minutes(0);/* falls through */
case"minute":this.seconds(0);/* falls through */
case"second":this.milliseconds(0)}
// weeks are a special case
// quarters are also special
return"week"===a&&this.weekday(0),"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this}function oc(a){
// 'date' is an alias for 'day', so it should be considered as such.
return a=K(a),void 0===a||"millisecond"===a?this:("date"===a&&(a="day"),this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms"))}function pc(){return this._d.valueOf()-6e4*(this._offset||0)}function qc(){return Math.floor(this.valueOf()/1e3)}function rc(){return new Date(this.valueOf())}function sc(){var a=this;return[a.year(),a.month(),a.date(),a.hour(),a.minute(),a.second(),a.millisecond()]}function tc(){var a=this;return{years:a.year(),months:a.month(),date:a.date(),hours:a.hours(),minutes:a.minutes(),seconds:a.seconds(),milliseconds:a.milliseconds()}}function uc(){
// new Date(NaN).toJSON() === null
return this.isValid()?this.toISOString():null}function vc(){return n(this)}function wc(){return j({},m(this))}function xc(){return m(this).overflow}function yc(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}}function zc(a,b){U(0,[a,a.length],0,b)}
// MOMENTS
function Ac(a){return Ec.call(this,a,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)}function Bc(a){return Ec.call(this,a,this.isoWeek(),this.isoWeekday(),1,4)}function Cc(){return xa(this.year(),1,4)}function Dc(){var a=this.localeData()._week;return xa(this.year(),a.dow,a.doy)}function Ec(a,b,c,d,e){var f;return null==a?wa(this,d,e).year:(f=xa(a,d,e),b>f&&(b=f),Fc.call(this,a,b,c,d,e))}function Fc(a,b,c,d,e){var f=va(a,b,c,d,e),g=ta(f.year,0,f.dayOfYear);return this.year(g.getUTCFullYear()),this.month(g.getUTCMonth()),this.date(g.getUTCDate()),this}
// MOMENTS
function Gc(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)}
// HELPERS
// MOMENTS
function Hc(a){var b=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")}function Ic(a,b){b[df]=u(1e3*("0."+a))}
// MOMENTS
function Jc(){return this._isUTC?"UTC":""}function Kc(){return this._isUTC?"Coordinated Universal Time":""}function Lc(a){return sb(1e3*a)}function Mc(){return sb.apply(null,arguments).parseZone()}function Nc(a){return a}function Oc(a,b,c,d){var e=bb(),f=k().set(d,b);return e[c](f,a)}function Pc(a,b,c){if(f(a)&&(b=a,a=void 0),a=a||"",null!=b)return Oc(a,b,c,"month");var d,e=[];for(d=0;d<12;d++)e[d]=Oc(a,d,c,"month");return e}
// ()
// (5)
// (fmt, 5)
// (fmt)
// (true)
// (true, 5)
// (true, fmt, 5)
// (true, fmt)
function Qc(a,b,c,d){"boolean"==typeof a?(f(b)&&(c=b,b=void 0),b=b||""):(b=a,c=b,a=!1,f(b)&&(c=b,b=void 0),b=b||"");var e=bb(),g=a?e._week.dow:0;if(null!=c)return Oc(b,(c+g)%7,d,"day");var h,i=[];for(h=0;h<7;h++)i[h]=Oc(b,(h+g)%7,d,"day");return i}function Rc(a,b){return Pc(a,b,"months")}function Sc(a,b){return Pc(a,b,"monthsShort")}function Tc(a,b,c){return Qc(a,b,c,"weekdays")}function Uc(a,b,c){return Qc(a,b,c,"weekdaysShort")}function Vc(a,b,c){return Qc(a,b,c,"weekdaysMin")}function Wc(){var a=this._data;return this._milliseconds=Xf(this._milliseconds),this._days=Xf(this._days),this._months=Xf(this._months),a.milliseconds=Xf(a.milliseconds),a.seconds=Xf(a.seconds),a.minutes=Xf(a.minutes),a.hours=Xf(a.hours),a.months=Xf(a.months),a.years=Xf(a.years),this}function Xc(a,b,c,d){var e=Ob(b,c);return a._milliseconds+=d*e._milliseconds,a._days+=d*e._days,a._months+=d*e._months,a._bubble()}
// supports only 2.0-style add(1, 's') or add(duration)
function Yc(a,b){return Xc(this,a,b,1)}
// supports only 2.0-style subtract(1, 's') or subtract(duration)
function Zc(a,b){return Xc(this,a,b,-1)}function $c(a){return a<0?Math.floor(a):Math.ceil(a)}function _c(){var a,b,c,d,e,f=this._milliseconds,g=this._days,h=this._months,i=this._data;
// if we have a mix of positive and negative values, bubble down first
// check: https://github.com/moment/moment/issues/2166
// The following code bubbles up values, see the tests for
// examples of what that means.
// convert days to months
// 12 months -> 1 year
return f>=0&&g>=0&&h>=0||f<=0&&g<=0&&h<=0||(f+=864e5*$c(bd(h)+g),g=0,h=0),i.milliseconds=f%1e3,a=t(f/1e3),i.seconds=a%60,b=t(a/60),i.minutes=b%60,c=t(b/60),i.hours=c%24,g+=t(c/24),e=t(ad(g)),h+=e,g-=$c(bd(e)),d=t(h/12),h%=12,i.days=g,i.months=h,i.years=d,this}function ad(a){
// 400 years have 146097 days (taking into account leap year rules)
// 400 years have 12 months === 4800
return 4800*a/146097}function bd(a){
// the reverse of daysToMonths
return 146097*a/4800}function cd(a){var b,c,d=this._milliseconds;if(a=K(a),"month"===a||"year"===a)return b=this._days+d/864e5,c=this._months+ad(b),"month"===a?c:c/12;switch(
// handle milliseconds separately because of floating point math errors (issue #1867)
b=this._days+Math.round(bd(this._months)),a){case"week":return b/7+d/6048e5;case"day":return b+d/864e5;case"hour":return 24*b+d/36e5;case"minute":return 1440*b+d/6e4;case"second":return 86400*b+d/1e3;
// Math.floor prevents floating point math errors here
case"millisecond":return Math.floor(864e5*b)+d;default:throw new Error("Unknown unit "+a)}}
// TODO: Use this.as('ms')?
function dd(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*u(this._months/12)}function ed(a){return function(){return this.as(a)}}function fd(a){return a=K(a),this[a+"s"]()}function gd(a){return function(){return this._data[a]}}function hd(){return t(this.days()/7)}
// helper function for moment.fn.from, moment.fn.fromNow, and moment.duration.fn.humanize
function id(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function jd(a,b,c){var d=Ob(a).abs(),e=lg(d.as("s")),f=lg(d.as("m")),g=lg(d.as("h")),h=lg(d.as("d")),i=lg(d.as("M")),j=lg(d.as("y")),k=e<mg.s&&["s",e]||f<=1&&["m"]||f<mg.m&&["mm",f]||g<=1&&["h"]||g<mg.h&&["hh",g]||h<=1&&["d"]||h<mg.d&&["dd",h]||i<=1&&["M"]||i<mg.M&&["MM",i]||j<=1&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,id.apply(null,k)}
// This function allows you to set the rounding function for relative time strings
function kd(a){return void 0===a?lg:"function"==typeof a&&(lg=a,!0)}
// This function allows you to set a threshold for relative time strings
function ld(a,b){return void 0!==mg[a]&&(void 0===b?mg[a]:(mg[a]=b,!0))}function md(a){var b=this.localeData(),c=jd(this,!a,b);return a&&(c=b.pastFuture(+this,c)),b.postformat(c)}function nd(){
// for ISO strings we do not use the normal bubbling rules:
//  * milliseconds bubble up until they become hours
//  * days do not bubble at all
//  * months bubble up until they become years
// This is because there is no context-free conversion between hours and days
// (think of clock changes)
// and also not between days and months (28-31 days per month)
var a,b,c,d=ng(this._milliseconds)/1e3,e=ng(this._days),f=ng(this._months);
// 3600 seconds -> 60 minutes -> 1 hour
a=t(d/60),b=t(a/60),d%=60,a%=60,
// 12 months -> 1 year
c=t(f/12),f%=12;
// inspired by https://github.com/dordille/moment-isoduration/blob/master/moment.isoduration.js
var g=c,h=f,i=e,j=b,k=a,l=d,m=this.asSeconds();return m?(m<0?"-":"")+"P"+(g?g+"Y":"")+(h?h+"M":"")+(i?i+"D":"")+(j||k||l?"T":"")+(j?j+"H":"")+(k?k+"M":"")+(l?l+"S":""):"P0D"}
//! moment.js locale configuration
//! locale : Belarusian [be]
//! author : Dmitry Demidov : https://github.com/demidov91
//! author: Praleska: http://praleska.pro/
//! Author : Menelion Elensúle : https://github.com/Oire
function od(a,b){var c=a.split("_");return b%10===1&&b%100!==11?c[0]:b%10>=2&&b%10<=4&&(b%100<10||b%100>=20)?c[1]:c[2]}function pd(a,b,c){var d={mm:b?"хвіліна_хвіліны_хвілін":"хвіліну_хвіліны_хвілін",hh:b?"гадзіна_гадзіны_гадзін":"гадзіну_гадзіны_гадзін",dd:"дзень_дні_дзён",MM:"месяц_месяцы_месяцаў",yy:"год_гады_гадоў"};return"m"===c?b?"хвіліна":"хвіліну":"h"===c?b?"гадзіна":"гадзіну":a+" "+od(d[c],+a)}
//! moment.js locale configuration
//! locale : Breton [br]
//! author : Jean-Baptiste Le Duigou : https://github.com/jbleduigou
function qd(a,b,c){var d={mm:"munutenn",MM:"miz",dd:"devezh"};return a+" "+td(d[c],a)}function rd(a){switch(sd(a)){case 1:case 3:case 4:case 5:case 9:return a+" bloaz";default:return a+" vloaz"}}function sd(a){return a>9?sd(a%10):a}function td(a,b){return 2===b?ud(a):a}function ud(a){var b={m:"v",b:"v",d:"z"};return void 0===b[a.charAt(0)]?a:b[a.charAt(0)]+a.substring(1)}
//! moment.js locale configuration
//! locale : Bosnian [bs]
//! author : Nedim Cholich : https://github.com/frontyard
//! based on (hr) translation by Bojan Marković
function vd(a,b,c){var d=a+" ";switch(c){case"m":return b?"jedna minuta":"jedne minute";case"mm":return d+=1===a?"minuta":2===a||3===a||4===a?"minute":"minuta";case"h":return b?"jedan sat":"jednog sata";case"hh":return d+=1===a?"sat":2===a||3===a||4===a?"sata":"sati";case"dd":return d+=1===a?"dan":"dana";case"MM":return d+=1===a?"mjesec":2===a||3===a||4===a?"mjeseca":"mjeseci";case"yy":return d+=1===a?"godina":2===a||3===a||4===a?"godine":"godina"}}function wd(a){return a>1&&a<5&&1!==~~(a/10)}function xd(a,b,c,d){var e=a+" ";switch(c){case"s":// a few seconds / in a few seconds / a few seconds ago
return b||d?"pár sekund":"pár sekundami";case"m":// a minute / in a minute / a minute ago
return b?"minuta":d?"minutu":"minutou";case"mm":// 9 minutes / in 9 minutes / 9 minutes ago
// 9 minutes / in 9 minutes / 9 minutes ago
return b||d?e+(wd(a)?"minuty":"minut"):e+"minutami";break;case"h":// an hour / in an hour / an hour ago
return b?"hodina":d?"hodinu":"hodinou";case"hh":// 9 hours / in 9 hours / 9 hours ago
// 9 hours / in 9 hours / 9 hours ago
return b||d?e+(wd(a)?"hodiny":"hodin"):e+"hodinami";break;case"d":// a day / in a day / a day ago
return b||d?"den":"dnem";case"dd":// 9 days / in 9 days / 9 days ago
// 9 days / in 9 days / 9 days ago
return b||d?e+(wd(a)?"dny":"dní"):e+"dny";break;case"M":// a month / in a month / a month ago
return b||d?"měsíc":"měsícem";case"MM":// 9 months / in 9 months / 9 months ago
// 9 months / in 9 months / 9 months ago
return b||d?e+(wd(a)?"měsíce":"měsíců"):e+"měsíci";break;case"y":// a year / in a year / a year ago
return b||d?"rok":"rokem";case"yy":// 9 years / in 9 years / 9 years ago
// 9 years / in 9 years / 9 years ago
return b||d?e+(wd(a)?"roky":"let"):e+"lety"}}
//! moment.js locale configuration
//! locale : German (Austria) [de-at]
//! author : lluchs : https://github.com/lluchs
//! author: Menelion Elensúle: https://github.com/Oire
//! author : Martin Groller : https://github.com/MadMG
//! author : Mikolaj Dadela : https://github.com/mik01aj
function yd(a,b,c,d){var e={m:["eine Minute","einer Minute"],h:["eine Stunde","einer Stunde"],d:["ein Tag","einem Tag"],dd:[a+" Tage",a+" Tagen"],M:["ein Monat","einem Monat"],MM:[a+" Monate",a+" Monaten"],y:["ein Jahr","einem Jahr"],yy:[a+" Jahre",a+" Jahren"]};return b?e[c][0]:e[c][1]}
//! moment.js locale configuration
//! locale : German [de]
//! author : lluchs : https://github.com/lluchs
//! author: Menelion Elensúle: https://github.com/Oire
//! author : Mikolaj Dadela : https://github.com/mik01aj
function zd(a,b,c,d){var e={m:["eine Minute","einer Minute"],h:["eine Stunde","einer Stunde"],d:["ein Tag","einem Tag"],dd:[a+" Tage",a+" Tagen"],M:["ein Monat","einem Monat"],MM:[a+" Monate",a+" Monaten"],y:["ein Jahr","einem Jahr"],yy:[a+" Jahre",a+" Jahren"]};return b?e[c][0]:e[c][1]}
//! moment.js locale configuration
//! locale : Estonian [et]
//! author : Henry Kehlmann : https://github.com/madhenry
//! improvements : Illimar Tambek : https://github.com/ragulka
function Ad(a,b,c,d){var e={s:["mõne sekundi","mõni sekund","paar sekundit"],m:["ühe minuti","üks minut"],mm:[a+" minuti",a+" minutit"],h:["ühe tunni","tund aega","üks tund"],hh:[a+" tunni",a+" tundi"],d:["ühe päeva","üks päev"],M:["kuu aja","kuu aega","üks kuu"],MM:[a+" kuu",a+" kuud"],y:["ühe aasta","aasta","üks aasta"],yy:[a+" aasta",a+" aastat"]};return b?e[c][2]?e[c][2]:e[c][1]:d?e[c][0]:e[c][1]}function Bd(a,b,c,d){var e="";switch(c){case"s":return d?"muutaman sekunnin":"muutama sekunti";case"m":return d?"minuutin":"minuutti";case"mm":e=d?"minuutin":"minuuttia";break;case"h":return d?"tunnin":"tunti";case"hh":e=d?"tunnin":"tuntia";break;case"d":return d?"päivän":"päivä";case"dd":e=d?"päivän":"päivää";break;case"M":return d?"kuukauden":"kuukausi";case"MM":e=d?"kuukauden":"kuukautta";break;case"y":return d?"vuoden":"vuosi";case"yy":e=d?"vuoden":"vuotta"}return e=Cd(a,d)+" "+e}function Cd(a,b){return a<10?b?Sg[a]:Rg[a]:a}
//! moment.js locale configuration
//! locale : Croatian [hr]
//! author : Bojan Marković : https://github.com/bmarkovic
function Dd(a,b,c){var d=a+" ";switch(c){case"m":return b?"jedna minuta":"jedne minute";case"mm":return d+=1===a?"minuta":2===a||3===a||4===a?"minute":"minuta";case"h":return b?"jedan sat":"jednog sata";case"hh":return d+=1===a?"sat":2===a||3===a||4===a?"sata":"sati";case"dd":return d+=1===a?"dan":"dana";case"MM":return d+=1===a?"mjesec":2===a||3===a||4===a?"mjeseca":"mjeseci";case"yy":return d+=1===a?"godina":2===a||3===a||4===a?"godine":"godina"}}function Ed(a,b,c,d){var e=a;switch(c){case"s":return d||b?"néhány másodperc":"néhány másodperce";case"m":return"egy"+(d||b?" perc":" perce");case"mm":return e+(d||b?" perc":" perce");case"h":return"egy"+(d||b?" óra":" órája");case"hh":return e+(d||b?" óra":" órája");case"d":return"egy"+(d||b?" nap":" napja");case"dd":return e+(d||b?" nap":" napja");case"M":return"egy"+(d||b?" hónap":" hónapja");case"MM":return e+(d||b?" hónap":" hónapja");case"y":return"egy"+(d||b?" év":" éve");case"yy":return e+(d||b?" év":" éve")}return""}function Fd(a){return(a?"":"[múlt] ")+"["+ah[this.day()]+"] LT[-kor]"}
//! moment.js locale configuration
//! locale : Icelandic [is]
//! author : Hinrik Örn Sigurðsson : https://github.com/hinrik
function Gd(a){return a%100===11||a%10!==1}function Hd(a,b,c,d){var e=a+" ";switch(c){case"s":return b||d?"nokkrar sekúndur":"nokkrum sekúndum";case"m":return b?"mínúta":"mínútu";case"mm":return Gd(a)?e+(b||d?"mínútur":"mínútum"):b?e+"mínúta":e+"mínútu";case"hh":return Gd(a)?e+(b||d?"klukkustundir":"klukkustundum"):e+"klukkustund";case"d":return b?"dagur":d?"dag":"degi";case"dd":return Gd(a)?b?e+"dagar":e+(d?"daga":"dögum"):b?e+"dagur":e+(d?"dag":"degi");case"M":return b?"mánuður":d?"mánuð":"mánuði";case"MM":return Gd(a)?b?e+"mánuðir":e+(d?"mánuði":"mánuðum"):b?e+"mánuður":e+(d?"mánuð":"mánuði");case"y":return b||d?"ár":"ári";case"yy":return Gd(a)?e+(b||d?"ár":"árum"):e+(b||d?"ár":"ári")}}
//! moment.js locale configuration
//! locale : Luxembourgish [lb]
//! author : mweimerskirch : https://github.com/mweimerskirch
//! author : David Raison : https://github.com/kwisatz
function Id(a,b,c,d){var e={m:["eng Minutt","enger Minutt"],h:["eng Stonn","enger Stonn"],d:["een Dag","engem Dag"],M:["ee Mount","engem Mount"],y:["ee Joer","engem Joer"]};return b?e[c][0]:e[c][1]}function Jd(a){var b=a.substr(0,a.indexOf(" "));return Ld(b)?"a "+a:"an "+a}function Kd(a){var b=a.substr(0,a.indexOf(" "));return Ld(b)?"viru "+a:"virun "+a}/**
 * Returns true if the word before the given number loses the '-n' ending.
 * e.g. 'an 10 Deeg' but 'a 5 Deeg'
 *
 * @param number {integer}
 * @returns {boolean}
 */
function Ld(a){if(a=parseInt(a,10),isNaN(a))return!1;if(a<0)
// Negative Number --> always true
return!0;if(a<10)
// Only 1 digit
return 4<=a&&a<=7;if(a<100){
// 2 digits
var b=a%10,c=a/10;return Ld(0===b?c:b)}if(a<1e4){
// 3 or 4 digits --> recursively check first digit
for(;a>=10;)a/=10;return Ld(a)}
// Anything larger than 4 digits: recursively check first n-3 digits
return a/=1e3,Ld(a)}function Md(a,b,c,d){return b?"kelios sekundės":d?"kelių sekundžių":"kelias sekundes"}function Nd(a,b,c,d){return b?Pd(c)[0]:d?Pd(c)[1]:Pd(c)[2]}function Od(a){return a%10===0||a>10&&a<20}function Pd(a){return dh[a].split("_")}function Qd(a,b,c,d){var e=a+" ";return 1===a?e+Nd(a,b,c[0],d):b?e+(Od(a)?Pd(c)[1]:Pd(c)[0]):d?e+Pd(c)[1]:e+(Od(a)?Pd(c)[1]:Pd(c)[2])}/**
 * @param withoutSuffix boolean true = a length of time; false = before/after a period of time.
 */
function Rd(a,b,c){return c?b%10===1&&b%100!==11?a[2]:a[3]:b%10===1&&b%100!==11?a[0]:a[1]}function Sd(a,b,c){return a+" "+Rd(eh[c],a,b)}function Td(a,b,c){return Rd(eh[c],a,b)}function Ud(a,b){return b?"dažas sekundes":"dažām sekundēm"}function Vd(a,b,c,d){var e="";if(b)switch(c){case"s":e="काही सेकंद";break;case"m":e="एक मिनिट";break;case"mm":e="%d मिनिटे";break;case"h":e="एक तास";break;case"hh":e="%d तास";break;case"d":e="एक दिवस";break;case"dd":e="%d दिवस";break;case"M":e="एक महिना";break;case"MM":e="%d महिने";break;case"y":e="एक वर्ष";break;case"yy":e="%d वर्षे"}else switch(c){case"s":e="काही सेकंदां";break;case"m":e="एका मिनिटा";break;case"mm":e="%d मिनिटां";break;case"h":e="एका तासा";break;case"hh":e="%d तासां";break;case"d":e="एका दिवसा";break;case"dd":e="%d दिवसां";break;case"M":e="एका महिन्या";break;case"MM":e="%d महिन्यां";break;case"y":e="एका वर्षा";break;case"yy":e="%d वर्षां"}return e.replace(/%d/i,a)}function Wd(a){return a%10<5&&a%10>1&&~~(a/10)%10!==1}function Xd(a,b,c){var d=a+" ";switch(c){case"m":return b?"minuta":"minutę";case"mm":return d+(Wd(a)?"minuty":"minut");case"h":return b?"godzina":"godzinę";case"hh":return d+(Wd(a)?"godziny":"godzin");case"MM":return d+(Wd(a)?"miesiące":"miesięcy");case"yy":return d+(Wd(a)?"lata":"lat")}}
//! moment.js locale configuration
//! locale : Romanian [ro]
//! author : Vlad Gurdiga : https://github.com/gurdiga
//! author : Valentin Agachi : https://github.com/avaly
function Yd(a,b,c){var d={mm:"minute",hh:"ore",dd:"zile",MM:"luni",yy:"ani"},e=" ";return(a%100>=20||a>=100&&a%100===0)&&(e=" de "),a+e+d[c]}
//! moment.js locale configuration
//! locale : Russian [ru]
//! author : Viktorminator : https://github.com/Viktorminator
//! Author : Menelion Elensúle : https://github.com/Oire
//! author : Коренберг Марк : https://github.com/socketpair
function Zd(a,b){var c=a.split("_");return b%10===1&&b%100!==11?c[0]:b%10>=2&&b%10<=4&&(b%100<10||b%100>=20)?c[1]:c[2]}function $d(a,b,c){var d={mm:b?"минута_минуты_минут":"минуту_минуты_минут",hh:"час_часа_часов",dd:"день_дня_дней",MM:"месяц_месяца_месяцев",yy:"год_года_лет"};return"m"===c?b?"минута":"минуту":a+" "+Zd(d[c],+a)}function _d(a){return a>1&&a<5}function ae(a,b,c,d){var e=a+" ";switch(c){case"s":// a few seconds / in a few seconds / a few seconds ago
return b||d?"pár sekúnd":"pár sekundami";case"m":// a minute / in a minute / a minute ago
return b?"minúta":d?"minútu":"minútou";case"mm":// 9 minutes / in 9 minutes / 9 minutes ago
// 9 minutes / in 9 minutes / 9 minutes ago
return b||d?e+(_d(a)?"minúty":"minút"):e+"minútami";break;case"h":// an hour / in an hour / an hour ago
return b?"hodina":d?"hodinu":"hodinou";case"hh":// 9 hours / in 9 hours / 9 hours ago
// 9 hours / in 9 hours / 9 hours ago
return b||d?e+(_d(a)?"hodiny":"hodín"):e+"hodinami";break;case"d":// a day / in a day / a day ago
return b||d?"deň":"dňom";case"dd":// 9 days / in 9 days / 9 days ago
// 9 days / in 9 days / 9 days ago
return b||d?e+(_d(a)?"dni":"dní"):e+"dňami";break;case"M":// a month / in a month / a month ago
return b||d?"mesiac":"mesiacom";case"MM":// 9 months / in 9 months / 9 months ago
// 9 months / in 9 months / 9 months ago
return b||d?e+(_d(a)?"mesiace":"mesiacov"):e+"mesiacmi";break;case"y":// a year / in a year / a year ago
return b||d?"rok":"rokom";case"yy":// 9 years / in 9 years / 9 years ago
// 9 years / in 9 years / 9 years ago
return b||d?e+(_d(a)?"roky":"rokov"):e+"rokmi"}}
//! moment.js locale configuration
//! locale : Slovenian [sl]
//! author : Robert Sedovšek : https://github.com/sedovsek
function be(a,b,c,d){var e=a+" ";switch(c){case"s":return b||d?"nekaj sekund":"nekaj sekundami";case"m":return b?"ena minuta":"eno minuto";case"mm":return e+=1===a?b?"minuta":"minuto":2===a?b||d?"minuti":"minutama":a<5?b||d?"minute":"minutami":b||d?"minut":"minutami";case"h":return b?"ena ura":"eno uro";case"hh":return e+=1===a?b?"ura":"uro":2===a?b||d?"uri":"urama":a<5?b||d?"ure":"urami":b||d?"ur":"urami";case"d":return b||d?"en dan":"enim dnem";case"dd":return e+=1===a?b||d?"dan":"dnem":2===a?b||d?"dni":"dnevoma":b||d?"dni":"dnevi";case"M":return b||d?"en mesec":"enim mesecem";case"MM":return e+=1===a?b||d?"mesec":"mesecem":2===a?b||d?"meseca":"mesecema":a<5?b||d?"mesece":"meseci":b||d?"mesecev":"meseci";case"y":return b||d?"eno leto":"enim letom";case"yy":return e+=1===a?b||d?"leto":"letom":2===a?b||d?"leti":"letoma":a<5?b||d?"leta":"leti":b||d?"let":"leti"}}function ce(a){var b=a;return b=a.indexOf("jaj")!==-1?b.slice(0,-3)+"leS":a.indexOf("jar")!==-1?b.slice(0,-3)+"waQ":a.indexOf("DIS")!==-1?b.slice(0,-3)+"nem":b+" pIq"}function de(a){var b=a;return b=a.indexOf("jaj")!==-1?b.slice(0,-3)+"Hu’":a.indexOf("jar")!==-1?b.slice(0,-3)+"wen":a.indexOf("DIS")!==-1?b.slice(0,-3)+"ben":b+" ret"}function ee(a,b,c,d){var e=fe(a);switch(c){case"mm":return e+" tup";case"hh":return e+" rep";case"dd":return e+" jaj";case"MM":return e+" jar";case"yy":return e+" DIS"}}function fe(a){var b=Math.floor(a%1e3/100),c=Math.floor(a%100/10),d=a%10,e="";return b>0&&(e+=Fh[b]+"vatlh"),c>0&&(e+=(""!==e?" ":"")+Fh[c]+"maH"),d>0&&(e+=(""!==e?" ":"")+Fh[d]),""===e?"pagh":e}function ge(a,b,c,d){var e={s:["viensas secunds","'iensas secunds"],m:["'n míut","'iens míut"],mm:[a+" míuts",""+a+" míuts"],h:["'n þora","'iensa þora"],hh:[a+" þoras",""+a+" þoras"],d:["'n ziua","'iensa ziua"],dd:[a+" ziuas",""+a+" ziuas"],M:["'n mes","'iens mes"],MM:[a+" mesen",""+a+" mesen"],y:["'n ar","'iens ar"],yy:[a+" ars",""+a+" ars"]};return d?e[c][0]:b?e[c][0]:e[c][1]}
//! moment.js locale configuration
//! locale : Ukrainian [uk]
//! author : zemlanin : https://github.com/zemlanin
//! Author : Menelion Elensúle : https://github.com/Oire
function he(a,b){var c=a.split("_");return b%10===1&&b%100!==11?c[0]:b%10>=2&&b%10<=4&&(b%100<10||b%100>=20)?c[1]:c[2]}function ie(a,b,c){var d={mm:b?"хвилина_хвилини_хвилин":"хвилину_хвилини_хвилин",hh:b?"година_години_годин":"годину_години_годин",dd:"день_дні_днів",MM:"місяць_місяці_місяців",yy:"рік_роки_років"};return"m"===c?b?"хвилина":"хвилину":"h"===c?b?"година":"годину":a+" "+he(d[c],+a)}function je(a,b){var c={nominative:"неділя_понеділок_вівторок_середа_четвер_п’ятниця_субота".split("_"),accusative:"неділю_понеділок_вівторок_середу_четвер_п’ятницю_суботу".split("_"),genitive:"неділі_понеділка_вівторка_середи_четверга_п’ятниці_суботи".split("_")},d=/(\[[ВвУу]\]) ?dddd/.test(b)?"accusative":/\[?(?:минулої|наступної)? ?\] ?dddd/.test(b)?"genitive":"nominative";return c[d][a.day()]}function ke(a){return function(){return a+"о"+(11===this.hours()?"б":"")+"] LT"}}var le,me;me=Array.prototype.some?Array.prototype.some:function(a){for(var b=Object(this),c=b.length>>>0,d=0;d<c;d++)if(d in b&&a.call(this,b[d],d,b))return!0;return!1};var ne=me,oe=a.momentProperties=[],pe=!1,qe={};a.suppressDeprecationWarnings=!1,a.deprecationHandler=null;var re;re=Object.keys?Object.keys:function(a){var b,c=[];for(b in a)i(a,b)&&c.push(b);return c};var se,te=re,ue={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},ve={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},we="Invalid date",xe="%d",ye=/\d{1,2}/,ze={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},Ae={},Be={},Ce=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,De=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,Ee={},Fe={},Ge=/\d/,He=/\d\d/,Ie=/\d{3}/,Je=/\d{4}/,Ke=/[+-]?\d{6}/,Le=/\d\d?/,Me=/\d\d\d\d?/,Ne=/\d\d\d\d\d\d?/,Oe=/\d{1,3}/,Pe=/\d{1,4}/,Qe=/[+-]?\d{1,6}/,Re=/\d+/,Se=/[+-]?\d+/,Te=/Z|[+-]\d\d:?\d\d/gi,Ue=/Z|[+-]\d\d(?::?\d\d)?/gi,Ve=/[+-]?\d+(\.\d{1,3})?/,We=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Xe={},Ye={},Ze=0,$e=1,_e=2,af=3,bf=4,cf=5,df=6,ef=7,ff=8;se=Array.prototype.indexOf?Array.prototype.indexOf:function(a){
// I know
var b;for(b=0;b<this.length;++b)if(this[b]===a)return b;return-1};var gf=se;
// FORMATTING
U("M",["MM",2],"Mo",function(){return this.month()+1}),U("MMM",0,0,function(a){return this.localeData().monthsShort(this,a)}),U("MMMM",0,0,function(a){return this.localeData().months(this,a)}),
// ALIASES
J("month","M"),
// PRIORITY
M("month",8),
// PARSING
Z("M",Le),Z("MM",Le,He),Z("MMM",function(a,b){return b.monthsShortRegex(a)}),Z("MMMM",function(a,b){return b.monthsRegex(a)}),ba(["M","MM"],function(a,b){b[$e]=u(a)-1}),ba(["MMM","MMMM"],function(a,b,c,d){var e=c._locale.monthsParse(a,d,c._strict);
// if we didn't find a month name, mark the date as invalid.
null!=e?b[$e]=e:m(c).invalidMonth=a});
// LOCALES
var hf=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,jf="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),kf="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),lf=We,mf=We;
// FORMATTING
U("Y",0,0,function(){var a=this.year();return a<=9999?""+a:"+"+a}),U(0,["YY",2],0,function(){return this.year()%100}),U(0,["YYYY",4],0,"year"),U(0,["YYYYY",5],0,"year"),U(0,["YYYYYY",6,!0],0,"year"),
// ALIASES
J("year","y"),
// PRIORITIES
M("year",1),
// PARSING
Z("Y",Se),Z("YY",Le,He),Z("YYYY",Pe,Je),Z("YYYYY",Qe,Ke),Z("YYYYYY",Qe,Ke),ba(["YYYYY","YYYYYY"],Ze),ba("YYYY",function(b,c){c[Ze]=2===b.length?a.parseTwoDigitYear(b):u(b)}),ba("YY",function(b,c){c[Ze]=a.parseTwoDigitYear(b)}),ba("Y",function(a,b){b[Ze]=parseInt(a,10)}),
// HOOKS
a.parseTwoDigitYear=function(a){return u(a)+(u(a)>68?1900:2e3)};
// MOMENTS
var nf=O("FullYear",!0);
// FORMATTING
U("w",["ww",2],"wo","week"),U("W",["WW",2],"Wo","isoWeek"),
// ALIASES
J("week","w"),J("isoWeek","W"),
// PRIORITIES
M("week",5),M("isoWeek",5),
// PARSING
Z("w",Le),Z("ww",Le,He),Z("W",Le),Z("WW",Le,He),ca(["w","ww","W","WW"],function(a,b,c,d){b[d.substr(0,1)]=u(a)});var of={dow:0,// Sunday is the first day of the week.
doy:6};
// FORMATTING
U("d",0,"do","day"),U("dd",0,0,function(a){return this.localeData().weekdaysMin(this,a)}),U("ddd",0,0,function(a){return this.localeData().weekdaysShort(this,a)}),U("dddd",0,0,function(a){return this.localeData().weekdays(this,a)}),U("e",0,0,"weekday"),U("E",0,0,"isoWeekday"),
// ALIASES
J("day","d"),J("weekday","e"),J("isoWeekday","E"),
// PRIORITY
M("day",11),M("weekday",11),M("isoWeekday",11),
// PARSING
Z("d",Le),Z("e",Le),Z("E",Le),Z("dd",function(a,b){return b.weekdaysMinRegex(a)}),Z("ddd",function(a,b){return b.weekdaysShortRegex(a)}),Z("dddd",function(a,b){return b.weekdaysRegex(a)}),ca(["dd","ddd","dddd"],function(a,b,c,d){var e=c._locale.weekdaysParse(a,d,c._strict);
// if we didn't get a weekday name, mark the date as invalid
null!=e?b.d=e:m(c).invalidWeekday=a}),ca(["d","e","E"],function(a,b,c,d){b[d]=u(a)});
// LOCALES
var pf="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),qf="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),rf="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),sf=We,tf=We,uf=We;U("H",["HH",2],0,"hour"),U("h",["hh",2],0,Ra),U("k",["kk",2],0,Sa),U("hmm",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)}),U("hmmss",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)+T(this.seconds(),2)}),U("Hmm",0,0,function(){return""+this.hours()+T(this.minutes(),2)}),U("Hmmss",0,0,function(){return""+this.hours()+T(this.minutes(),2)+T(this.seconds(),2)}),Ta("a",!0),Ta("A",!1),
// ALIASES
J("hour","h"),
// PRIORITY
M("hour",13),Z("a",Ua),Z("A",Ua),Z("H",Le),Z("h",Le),Z("HH",Le,He),Z("hh",Le,He),Z("hmm",Me),Z("hmmss",Ne),Z("Hmm",Me),Z("Hmmss",Ne),ba(["H","HH"],af),ba(["a","A"],function(a,b,c){c._isPm=c._locale.isPM(a),c._meridiem=a}),ba(["h","hh"],function(a,b,c){b[af]=u(a),m(c).bigHour=!0}),ba("hmm",function(a,b,c){var d=a.length-2;b[af]=u(a.substr(0,d)),b[bf]=u(a.substr(d)),m(c).bigHour=!0}),ba("hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[af]=u(a.substr(0,d)),b[bf]=u(a.substr(d,2)),b[cf]=u(a.substr(e)),m(c).bigHour=!0}),ba("Hmm",function(a,b,c){var d=a.length-2;b[af]=u(a.substr(0,d)),b[bf]=u(a.substr(d))}),ba("Hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[af]=u(a.substr(0,d)),b[bf]=u(a.substr(d,2)),b[cf]=u(a.substr(e))});var vf,wf=/[ap]\.?m?\.?/i,xf=O("Hours",!0),yf={calendar:ue,longDateFormat:ve,invalidDate:we,ordinal:xe,ordinalParse:ye,relativeTime:ze,months:jf,monthsShort:kf,week:of,weekdays:pf,weekdaysMin:rf,weekdaysShort:qf,meridiemParse:wf},zf={},Af={},Bf=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Cf=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Df=/Z|[+-]\d\d(?::?\d\d)?/,Ef=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],
// YYYYMM is NOT allowed by the standard
["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],Ff=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],Gf=/^\/?Date\((\-?\d+)/i;a.createFromInputFallback=x("value provided is not in a recognized ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non ISO date formats are discouraged and will be removed in an upcoming major release. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(a){a._d=new Date(a._i+(a._useUTC?" UTC":""))}),
// constant that refers to the ISO standard
a.ISO_8601=function(){};var Hf=x("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=sb.apply(null,arguments);return this.isValid()&&a.isValid()?a<this?this:a:o()}),If=x("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=sb.apply(null,arguments);return this.isValid()&&a.isValid()?a>this?this:a:o()}),Jf=function(){return Date.now?Date.now():+new Date};zb("Z",":"),zb("ZZ",""),
// PARSING
Z("Z",Ue),Z("ZZ",Ue),ba(["Z","ZZ"],function(a,b,c){c._useUTC=!0,c._tzm=Ab(Ue,a)});
// HELPERS
// timezone chunker
// '+10:00' > ['10',  '00']
// '-1530'  > ['-15', '30']
var Kf=/([\+\-]|\d\d)/gi;
// HOOKS
// This function will be called whenever a moment is mutated.
// It is intended to keep the offset in sync with the timezone.
a.updateOffset=function(){};
// ASP.NET json date format regex
var Lf=/^(\-)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/,Mf=/^(-)?P(?:(-?[0-9,.]*)Y)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)W)?(?:(-?[0-9,.]*)D)?(?:T(?:(-?[0-9,.]*)H)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)S)?)?$/;Ob.fn=wb.prototype;var Nf=Sb(1,"add"),Of=Sb(-1,"subtract");a.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",a.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var Pf=x("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(a){return void 0===a?this.localeData():this.locale(a)});
// FORMATTING
U(0,["gg",2],0,function(){return this.weekYear()%100}),U(0,["GG",2],0,function(){return this.isoWeekYear()%100}),zc("gggg","weekYear"),zc("ggggg","weekYear"),zc("GGGG","isoWeekYear"),zc("GGGGG","isoWeekYear"),
// ALIASES
J("weekYear","gg"),J("isoWeekYear","GG"),
// PRIORITY
M("weekYear",1),M("isoWeekYear",1),
// PARSING
Z("G",Se),Z("g",Se),Z("GG",Le,He),Z("gg",Le,He),Z("GGGG",Pe,Je),Z("gggg",Pe,Je),Z("GGGGG",Qe,Ke),Z("ggggg",Qe,Ke),ca(["gggg","ggggg","GGGG","GGGGG"],function(a,b,c,d){b[d.substr(0,2)]=u(a)}),ca(["gg","GG"],function(b,c,d,e){c[e]=a.parseTwoDigitYear(b)}),
// FORMATTING
U("Q",0,"Qo","quarter"),
// ALIASES
J("quarter","Q"),
// PRIORITY
M("quarter",7),
// PARSING
Z("Q",Ge),ba("Q",function(a,b){b[$e]=3*(u(a)-1)}),
// FORMATTING
U("D",["DD",2],"Do","date"),
// ALIASES
J("date","D"),
// PRIOROITY
M("date",9),
// PARSING
Z("D",Le),Z("DD",Le,He),Z("Do",function(a,b){return a?b._ordinalParse:b._ordinalParseLenient}),ba(["D","DD"],_e),ba("Do",function(a,b){b[_e]=u(a.match(Le)[0],10)});
// MOMENTS
var Qf=O("Date",!0);
// FORMATTING
U("DDD",["DDDD",3],"DDDo","dayOfYear"),
// ALIASES
J("dayOfYear","DDD"),
// PRIORITY
M("dayOfYear",4),
// PARSING
Z("DDD",Oe),Z("DDDD",Ie),ba(["DDD","DDDD"],function(a,b,c){c._dayOfYear=u(a)}),
// FORMATTING
U("m",["mm",2],0,"minute"),
// ALIASES
J("minute","m"),
// PRIORITY
M("minute",14),
// PARSING
Z("m",Le),Z("mm",Le,He),ba(["m","mm"],bf);
// MOMENTS
var Rf=O("Minutes",!1);
// FORMATTING
U("s",["ss",2],0,"second"),
// ALIASES
J("second","s"),
// PRIORITY
M("second",15),
// PARSING
Z("s",Le),Z("ss",Le,He),ba(["s","ss"],cf);
// MOMENTS
var Sf=O("Seconds",!1);
// FORMATTING
U("S",0,0,function(){return~~(this.millisecond()/100)}),U(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),U(0,["SSS",3],0,"millisecond"),U(0,["SSSS",4],0,function(){return 10*this.millisecond()}),U(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),U(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),U(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),U(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),U(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),
// ALIASES
J("millisecond","ms"),
// PRIORITY
M("millisecond",16),
// PARSING
Z("S",Oe,Ge),Z("SS",Oe,He),Z("SSS",Oe,Ie);var Tf;for(Tf="SSSS";Tf.length<=9;Tf+="S")Z(Tf,Re);for(Tf="S";Tf.length<=9;Tf+="S")ba(Tf,Ic);
// MOMENTS
var Uf=O("Milliseconds",!1);
// FORMATTING
U("z",0,0,"zoneAbbr"),U("zz",0,0,"zoneName");var Vf=r.prototype;Vf.add=Nf,Vf.calendar=Vb,Vf.clone=Wb,Vf.diff=bc,Vf.endOf=oc,Vf.format=gc,Vf.from=hc,Vf.fromNow=ic,Vf.to=jc,Vf.toNow=kc,Vf.get=R,Vf.invalidAt=xc,Vf.isAfter=Xb,Vf.isBefore=Yb,Vf.isBetween=Zb,Vf.isSame=$b,Vf.isSameOrAfter=_b,Vf.isSameOrBefore=ac,Vf.isValid=vc,Vf.lang=Pf,Vf.locale=lc,Vf.localeData=mc,Vf.max=If,Vf.min=Hf,Vf.parsingFlags=wc,Vf.set=S,Vf.startOf=nc,Vf.subtract=Of,Vf.toArray=sc,Vf.toObject=tc,Vf.toDate=rc,Vf.toISOString=ec,Vf.inspect=fc,Vf.toJSON=uc,Vf.toString=dc,Vf.unix=qc,Vf.valueOf=pc,Vf.creationData=yc,
// Year
Vf.year=nf,Vf.isLeapYear=ra,
// Week Year
Vf.weekYear=Ac,Vf.isoWeekYear=Bc,
// Quarter
Vf.quarter=Vf.quarters=Gc,
// Month
Vf.month=ka,Vf.daysInMonth=la,
// Week
Vf.week=Vf.weeks=Ba,Vf.isoWeek=Vf.isoWeeks=Ca,Vf.weeksInYear=Dc,Vf.isoWeeksInYear=Cc,
// Day
Vf.date=Qf,Vf.day=Vf.days=Ka,Vf.weekday=La,Vf.isoWeekday=Ma,Vf.dayOfYear=Hc,
// Hour
Vf.hour=Vf.hours=xf,
// Minute
Vf.minute=Vf.minutes=Rf,
// Second
Vf.second=Vf.seconds=Sf,
// Millisecond
Vf.millisecond=Vf.milliseconds=Uf,
// Offset
Vf.utcOffset=Db,Vf.utc=Fb,Vf.local=Gb,Vf.parseZone=Hb,Vf.hasAlignedHourOffset=Ib,Vf.isDST=Jb,Vf.isLocal=Lb,Vf.isUtcOffset=Mb,Vf.isUtc=Nb,Vf.isUTC=Nb,
// Timezone
Vf.zoneAbbr=Jc,Vf.zoneName=Kc,
// Deprecations
Vf.dates=x("dates accessor is deprecated. Use date instead.",Qf),Vf.months=x("months accessor is deprecated. Use month instead",ka),Vf.years=x("years accessor is deprecated. Use year instead",nf),Vf.zone=x("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",Eb),Vf.isDSTShifted=x("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",Kb);var Wf=C.prototype;Wf.calendar=D,Wf.longDateFormat=E,Wf.invalidDate=F,Wf.ordinal=G,Wf.preparse=Nc,Wf.postformat=Nc,Wf.relativeTime=H,Wf.pastFuture=I,Wf.set=A,
// Month
Wf.months=fa,Wf.monthsShort=ga,Wf.monthsParse=ia,Wf.monthsRegex=na,Wf.monthsShortRegex=ma,
// Week
Wf.week=ya,Wf.firstDayOfYear=Aa,Wf.firstDayOfWeek=za,
// Day of Week
Wf.weekdays=Fa,Wf.weekdaysMin=Ha,Wf.weekdaysShort=Ga,Wf.weekdaysParse=Ja,Wf.weekdaysRegex=Na,Wf.weekdaysShortRegex=Oa,Wf.weekdaysMinRegex=Pa,
// Hours
Wf.isPM=Va,Wf.meridiem=Wa,$a("en",{ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===u(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),
// Side effect imports
a.lang=x("moment.lang is deprecated. Use moment.locale instead.",$a),a.langData=x("moment.langData is deprecated. Use moment.localeData instead.",bb);var Xf=Math.abs,Yf=ed("ms"),Zf=ed("s"),$f=ed("m"),_f=ed("h"),ag=ed("d"),bg=ed("w"),cg=ed("M"),dg=ed("y"),eg=gd("milliseconds"),fg=gd("seconds"),gg=gd("minutes"),hg=gd("hours"),ig=gd("days"),jg=gd("months"),kg=gd("years"),lg=Math.round,mg={s:45,// seconds to minute
m:45,// minutes to hour
h:22,// hours to day
d:26,// days to month
M:11},ng=Math.abs,og=wb.prototype;og.abs=Wc,og.add=Yc,og.subtract=Zc,og.as=cd,og.asMilliseconds=Yf,og.asSeconds=Zf,og.asMinutes=$f,og.asHours=_f,og.asDays=ag,og.asWeeks=bg,og.asMonths=cg,og.asYears=dg,og.valueOf=dd,og._bubble=_c,og.get=fd,og.milliseconds=eg,og.seconds=fg,og.minutes=gg,og.hours=hg,og.days=ig,og.weeks=hd,og.months=jg,og.years=kg,og.humanize=md,og.toISOString=nd,og.toString=nd,og.toJSON=nd,og.locale=lc,og.localeData=mc,
// Deprecations
og.toIsoString=x("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",nd),og.lang=Pf,
// Side effect imports
// FORMATTING
U("X",0,0,"unix"),U("x",0,0,"valueOf"),
// PARSING
Z("x",Se),Z("X",Ve),ba("X",function(a,b,c){c._d=new Date(1e3*parseFloat(a,10))}),ba("x",function(a,b,c){c._d=new Date(u(a))}),
// Side effect imports
//! moment.js
//! version : 2.17.1
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
a.version="2.17.1",b(sb),a.fn=Vf,a.min=ub,a.max=vb,a.now=Jf,a.utc=k,a.unix=Lc,a.months=Rc,a.isDate=g,a.locale=$a,a.invalid=o,a.duration=Ob,a.isMoment=s,a.weekdays=Tc,a.parseZone=Mc,a.localeData=bb,a.isDuration=xb,a.monthsShort=Sc,a.weekdaysMin=Vc,a.defineLocale=_a,a.updateLocale=ab,a.locales=cb,a.weekdaysShort=Uc,a.normalizeUnits=K,a.relativeTimeRounding=kd,a.relativeTimeThreshold=ld,a.calendarFormat=Ub,a.prototype=Vf,
//! moment.js locale configuration
//! locale : Afrikaans [af]
//! author : Werner Mollentze : https://github.com/wernerm
a.defineLocale("af",{months:"Januarie_Februarie_Maart_April_Mei_Junie_Julie_Augustus_September_Oktober_November_Desember".split("_"),monthsShort:"Jan_Feb_Mrt_Apr_Mei_Jun_Jul_Aug_Sep_Okt_Nov_Des".split("_"),weekdays:"Sondag_Maandag_Dinsdag_Woensdag_Donderdag_Vrydag_Saterdag".split("_"),weekdaysShort:"Son_Maa_Din_Woe_Don_Vry_Sat".split("_"),weekdaysMin:"So_Ma_Di_Wo_Do_Vr_Sa".split("_"),meridiemParse:/vm|nm/i,isPM:function(a){return/^nm$/i.test(a)},meridiem:function(a,b,c){return a<12?c?"vm":"VM":c?"nm":"NM"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Vandag om] LT",nextDay:"[Môre om] LT",nextWeek:"dddd [om] LT",lastDay:"[Gister om] LT",lastWeek:"[Laas] dddd [om] LT",sameElse:"L"},relativeTime:{future:"oor %s",past:"%s gelede",s:"'n paar sekondes",m:"'n minuut",mm:"%d minute",h:"'n uur",hh:"%d ure",d:"'n dag",dd:"%d dae",M:"'n maand",MM:"%d maande",y:"'n jaar",yy:"%d jaar"},ordinalParse:/\d{1,2}(ste|de)/,ordinal:function(a){return a+(1===a||8===a||a>=20?"ste":"de")},week:{dow:1,// Maandag is die eerste dag van die week.
doy:4}}),
//! moment.js locale configuration
//! locale : Arabic (Algeria) [ar-dz]
//! author : Noureddine LOUAHEDJ : https://github.com/noureddineme
a.defineLocale("ar-dz",{months:"جانفي_فيفري_مارس_أفريل_ماي_جوان_جويلية_أوت_سبتمبر_أكتوبر_نوفمبر_ديسمبر".split("_"),monthsShort:"جانفي_فيفري_مارس_أفريل_ماي_جوان_جويلية_أوت_سبتمبر_أكتوبر_نوفمبر_ديسمبر".split("_"),weekdays:"الأحد_الإثنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"احد_اثنين_ثلاثاء_اربعاء_خميس_جمعة_سبت".split("_"),weekdaysMin:"أح_إث_ثلا_أر_خم_جم_سب".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[اليوم على الساعة] LT",nextDay:"[غدا على الساعة] LT",nextWeek:"dddd [على الساعة] LT",lastDay:"[أمس على الساعة] LT",lastWeek:"dddd [على الساعة] LT",sameElse:"L"},relativeTime:{future:"في %s",past:"منذ %s",s:"ثوان",m:"دقيقة",mm:"%d دقائق",h:"ساعة",hh:"%d ساعات",d:"يوم",dd:"%d أيام",M:"شهر",MM:"%d أشهر",y:"سنة",yy:"%d سنوات"},week:{dow:0,// Sunday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Arabic (Lybia) [ar-ly]
//! author : Ali Hmer: https://github.com/kikoanis
var pg={1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",0:"0"},qg=function(a){return 0===a?0:1===a?1:2===a?2:a%100>=3&&a%100<=10?3:a%100>=11?4:5},rg={s:["أقل من ثانية","ثانية واحدة",["ثانيتان","ثانيتين"],"%d ثوان","%d ثانية","%d ثانية"],m:["أقل من دقيقة","دقيقة واحدة",["دقيقتان","دقيقتين"],"%d دقائق","%d دقيقة","%d دقيقة"],h:["أقل من ساعة","ساعة واحدة",["ساعتان","ساعتين"],"%d ساعات","%d ساعة","%d ساعة"],d:["أقل من يوم","يوم واحد",["يومان","يومين"],"%d أيام","%d يومًا","%d يوم"],M:["أقل من شهر","شهر واحد",["شهران","شهرين"],"%d أشهر","%d شهرا","%d شهر"],y:["أقل من عام","عام واحد",["عامان","عامين"],"%d أعوام","%d عامًا","%d عام"]},sg=function(a){return function(b,c,d,e){var f=qg(b),g=rg[a][qg(b)];return 2===f&&(g=g[c?0:1]),g.replace(/%d/i,b)}},tg=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];a.defineLocale("ar-ly",{months:tg,monthsShort:tg,weekdays:"الأحد_الإثنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"أحد_إثنين_ثلاثاء_أربعاء_خميس_جمعة_سبت".split("_"),weekdaysMin:"ح_ن_ث_ر_خ_ج_س".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/‏M/‏YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/ص|م/,isPM:function(a){return"م"===a},meridiem:function(a,b,c){return a<12?"ص":"م"},calendar:{sameDay:"[اليوم عند الساعة] LT",nextDay:"[غدًا عند الساعة] LT",nextWeek:"dddd [عند الساعة] LT",lastDay:"[أمس عند الساعة] LT",lastWeek:"dddd [عند الساعة] LT",sameElse:"L"},relativeTime:{future:"بعد %s",past:"منذ %s",s:sg("s"),m:sg("m"),mm:sg("m"),h:sg("h"),hh:sg("h"),d:sg("d"),dd:sg("d"),M:sg("M"),MM:sg("M"),y:sg("y"),yy:sg("y")},preparse:function(a){return a.replace(/\u200f/g,"").replace(/،/g,",")},postformat:function(a){return a.replace(/\d/g,function(a){return pg[a]}).replace(/,/g,"،")},week:{dow:6,// Saturday is the first day of the week.
doy:12}}),
//! moment.js locale configuration
//! locale : Arabic (Morocco) [ar-ma]
//! author : ElFadili Yassine : https://github.com/ElFadiliY
//! author : Abdel Said : https://github.com/abdelsaid
a.defineLocale("ar-ma",{months:"يناير_فبراير_مارس_أبريل_ماي_يونيو_يوليوز_غشت_شتنبر_أكتوبر_نونبر_دجنبر".split("_"),monthsShort:"يناير_فبراير_مارس_أبريل_ماي_يونيو_يوليوز_غشت_شتنبر_أكتوبر_نونبر_دجنبر".split("_"),weekdays:"الأحد_الإتنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"احد_اتنين_ثلاثاء_اربعاء_خميس_جمعة_سبت".split("_"),weekdaysMin:"ح_ن_ث_ر_خ_ج_س".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[اليوم على الساعة] LT",nextDay:"[غدا على الساعة] LT",nextWeek:"dddd [على الساعة] LT",lastDay:"[أمس على الساعة] LT",lastWeek:"dddd [على الساعة] LT",sameElse:"L"},relativeTime:{future:"في %s",past:"منذ %s",s:"ثوان",m:"دقيقة",mm:"%d دقائق",h:"ساعة",hh:"%d ساعات",d:"يوم",dd:"%d أيام",M:"شهر",MM:"%d أشهر",y:"سنة",yy:"%d سنوات"},week:{dow:6,// Saturday is the first day of the week.
doy:12}});
//! moment.js locale configuration
//! locale : Arabic (Saudi Arabia) [ar-sa]
//! author : Suhail Alkowaileet : https://github.com/xsoh
var ug={1:"١",2:"٢",3:"٣",4:"٤",5:"٥",6:"٦",7:"٧",8:"٨",9:"٩",0:"٠"},vg={"١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","٠":"0"};a.defineLocale("ar-sa",{months:"يناير_فبراير_مارس_أبريل_مايو_يونيو_يوليو_أغسطس_سبتمبر_أكتوبر_نوفمبر_ديسمبر".split("_"),monthsShort:"يناير_فبراير_مارس_أبريل_مايو_يونيو_يوليو_أغسطس_سبتمبر_أكتوبر_نوفمبر_ديسمبر".split("_"),weekdays:"الأحد_الإثنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"أحد_إثنين_ثلاثاء_أربعاء_خميس_جمعة_سبت".split("_"),weekdaysMin:"ح_ن_ث_ر_خ_ج_س".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/ص|م/,isPM:function(a){return"م"===a},meridiem:function(a,b,c){return a<12?"ص":"م"},calendar:{sameDay:"[اليوم على الساعة] LT",nextDay:"[غدا على الساعة] LT",nextWeek:"dddd [على الساعة] LT",lastDay:"[أمس على الساعة] LT",lastWeek:"dddd [على الساعة] LT",sameElse:"L"},relativeTime:{future:"في %s",past:"منذ %s",s:"ثوان",m:"دقيقة",mm:"%d دقائق",h:"ساعة",hh:"%d ساعات",d:"يوم",dd:"%d أيام",M:"شهر",MM:"%d أشهر",y:"سنة",yy:"%d سنوات"},preparse:function(a){return a.replace(/[١٢٣٤٥٦٧٨٩٠]/g,function(a){return vg[a]}).replace(/،/g,",")},postformat:function(a){return a.replace(/\d/g,function(a){return ug[a]}).replace(/,/g,"،")},week:{dow:0,// Sunday is the first day of the week.
doy:6}}),
//! moment.js locale configuration
//! locale  :  Arabic (Tunisia) [ar-tn]
//! author : Nader Toukabri : https://github.com/naderio
a.defineLocale("ar-tn",{months:"جانفي_فيفري_مارس_أفريل_ماي_جوان_جويلية_أوت_سبتمبر_أكتوبر_نوفمبر_ديسمبر".split("_"),monthsShort:"جانفي_فيفري_مارس_أفريل_ماي_جوان_جويلية_أوت_سبتمبر_أكتوبر_نوفمبر_ديسمبر".split("_"),weekdays:"الأحد_الإثنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"أحد_إثنين_ثلاثاء_أربعاء_خميس_جمعة_سبت".split("_"),weekdaysMin:"ح_ن_ث_ر_خ_ج_س".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[اليوم على الساعة] LT",nextDay:"[غدا على الساعة] LT",nextWeek:"dddd [على الساعة] LT",lastDay:"[أمس على الساعة] LT",lastWeek:"dddd [على الساعة] LT",sameElse:"L"},relativeTime:{future:"في %s",past:"منذ %s",s:"ثوان",m:"دقيقة",mm:"%d دقائق",h:"ساعة",hh:"%d ساعات",d:"يوم",dd:"%d أيام",M:"شهر",MM:"%d أشهر",y:"سنة",yy:"%d سنوات"},week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Arabic [ar]
//! author : Abdel Said: https://github.com/abdelsaid
//! author : Ahmed Elkhatib
//! author : forabi https://github.com/forabi
var wg={1:"١",2:"٢",3:"٣",4:"٤",5:"٥",6:"٦",7:"٧",8:"٨",9:"٩",0:"٠"},xg={"١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9","٠":"0"},yg=function(a){return 0===a?0:1===a?1:2===a?2:a%100>=3&&a%100<=10?3:a%100>=11?4:5},zg={s:["أقل من ثانية","ثانية واحدة",["ثانيتان","ثانيتين"],"%d ثوان","%d ثانية","%d ثانية"],m:["أقل من دقيقة","دقيقة واحدة",["دقيقتان","دقيقتين"],"%d دقائق","%d دقيقة","%d دقيقة"],h:["أقل من ساعة","ساعة واحدة",["ساعتان","ساعتين"],"%d ساعات","%d ساعة","%d ساعة"],d:["أقل من يوم","يوم واحد",["يومان","يومين"],"%d أيام","%d يومًا","%d يوم"],M:["أقل من شهر","شهر واحد",["شهران","شهرين"],"%d أشهر","%d شهرا","%d شهر"],y:["أقل من عام","عام واحد",["عامان","عامين"],"%d أعوام","%d عامًا","%d عام"]},Ag=function(a){return function(b,c,d,e){var f=yg(b),g=zg[a][yg(b)];return 2===f&&(g=g[c?0:1]),g.replace(/%d/i,b)}},Bg=["كانون الثاني يناير","شباط فبراير","آذار مارس","نيسان أبريل","أيار مايو","حزيران يونيو","تموز يوليو","آب أغسطس","أيلول سبتمبر","تشرين الأول أكتوبر","تشرين الثاني نوفمبر","كانون الأول ديسمبر"];a.defineLocale("ar",{months:Bg,monthsShort:Bg,weekdays:"الأحد_الإثنين_الثلاثاء_الأربعاء_الخميس_الجمعة_السبت".split("_"),weekdaysShort:"أحد_إثنين_ثلاثاء_أربعاء_خميس_جمعة_سبت".split("_"),weekdaysMin:"ح_ن_ث_ر_خ_ج_س".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/‏M/‏YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/ص|م/,isPM:function(a){return"م"===a},meridiem:function(a,b,c){return a<12?"ص":"م"},calendar:{sameDay:"[اليوم عند الساعة] LT",nextDay:"[غدًا عند الساعة] LT",nextWeek:"dddd [عند الساعة] LT",lastDay:"[أمس عند الساعة] LT",lastWeek:"dddd [عند الساعة] LT",sameElse:"L"},relativeTime:{future:"بعد %s",past:"منذ %s",s:Ag("s"),m:Ag("m"),mm:Ag("m"),h:Ag("h"),hh:Ag("h"),d:Ag("d"),dd:Ag("d"),M:Ag("M"),MM:Ag("M"),y:Ag("y"),yy:Ag("y")},preparse:function(a){return a.replace(/\u200f/g,"").replace(/[١٢٣٤٥٦٧٨٩٠]/g,function(a){return xg[a]}).replace(/،/g,",")},postformat:function(a){return a.replace(/\d/g,function(a){return wg[a]}).replace(/,/g,"،")},week:{dow:6,// Saturday is the first day of the week.
doy:12}});
//! moment.js locale configuration
//! locale : Azerbaijani [az]
//! author : topchiyev : https://github.com/topchiyev
var Cg={1:"-inci",5:"-inci",8:"-inci",70:"-inci",80:"-inci",2:"-nci",7:"-nci",20:"-nci",50:"-nci",3:"-üncü",4:"-üncü",100:"-üncü",6:"-ncı",9:"-uncu",10:"-uncu",30:"-uncu",60:"-ıncı",90:"-ıncı"};a.defineLocale("az",{months:"yanvar_fevral_mart_aprel_may_iyun_iyul_avqust_sentyabr_oktyabr_noyabr_dekabr".split("_"),monthsShort:"yan_fev_mar_apr_may_iyn_iyl_avq_sen_okt_noy_dek".split("_"),weekdays:"Bazar_Bazar ertəsi_Çərşənbə axşamı_Çərşənbə_Cümə axşamı_Cümə_Şənbə".split("_"),weekdaysShort:"Baz_BzE_ÇAx_Çər_CAx_Cüm_Şən".split("_"),weekdaysMin:"Bz_BE_ÇA_Çə_CA_Cü_Şə".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[bugün saat] LT",nextDay:"[sabah saat] LT",nextWeek:"[gələn həftə] dddd [saat] LT",lastDay:"[dünən] LT",lastWeek:"[keçən həftə] dddd [saat] LT",sameElse:"L"},relativeTime:{future:"%s sonra",past:"%s əvvəl",s:"birneçə saniyyə",m:"bir dəqiqə",mm:"%d dəqiqə",h:"bir saat",hh:"%d saat",d:"bir gün",dd:"%d gün",M:"bir ay",MM:"%d ay",y:"bir il",yy:"%d il"},meridiemParse:/gecə|səhər|gündüz|axşam/,isPM:function(a){return/^(gündüz|axşam)$/.test(a)},meridiem:function(a,b,c){return a<4?"gecə":a<12?"səhər":a<17?"gündüz":"axşam"},ordinalParse:/\d{1,2}-(ıncı|inci|nci|üncü|ncı|uncu)/,ordinal:function(a){if(0===a)// special case for zero
return a+"-ıncı";var b=a%10,c=a%100-b,d=a>=100?100:null;return a+(Cg[b]||Cg[c]||Cg[d])},week:{dow:1,// Monday is the first day of the week.
doy:7}}),a.defineLocale("be",{months:{format:"студзеня_лютага_сакавіка_красавіка_траўня_чэрвеня_ліпеня_жніўня_верасня_кастрычніка_лістапада_снежня".split("_"),standalone:"студзень_люты_сакавік_красавік_травень_чэрвень_ліпень_жнівень_верасень_кастрычнік_лістапад_снежань".split("_")},monthsShort:"студ_лют_сак_крас_трав_чэрв_ліп_жнів_вер_каст_ліст_снеж".split("_"),weekdays:{format:"нядзелю_панядзелак_аўторак_сераду_чацвер_пятніцу_суботу".split("_"),standalone:"нядзеля_панядзелак_аўторак_серада_чацвер_пятніца_субота".split("_"),isFormat:/\[ ?[Вв] ?(?:мінулую|наступную)? ?\] ?dddd/},weekdaysShort:"нд_пн_ат_ср_чц_пт_сб".split("_"),weekdaysMin:"нд_пн_ат_ср_чц_пт_сб".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., HH:mm",LLLL:"dddd, D MMMM YYYY г., HH:mm"},calendar:{sameDay:"[Сёння ў] LT",nextDay:"[Заўтра ў] LT",lastDay:"[Учора ў] LT",nextWeek:function(){return"[У] dddd [ў] LT"},lastWeek:function(){switch(this.day()){case 0:case 3:case 5:case 6:return"[У мінулую] dddd [ў] LT";case 1:case 2:case 4:return"[У мінулы] dddd [ў] LT"}},sameElse:"L"},relativeTime:{future:"праз %s",past:"%s таму",s:"некалькі секунд",m:pd,mm:pd,h:pd,hh:pd,d:"дзень",dd:pd,M:"месяц",MM:pd,y:"год",yy:pd},meridiemParse:/ночы|раніцы|дня|вечара/,isPM:function(a){return/^(дня|вечара)$/.test(a)},meridiem:function(a,b,c){return a<4?"ночы":a<12?"раніцы":a<17?"дня":"вечара"},ordinalParse:/\d{1,2}-(і|ы|га)/,ordinal:function(a,b){switch(b){case"M":case"d":case"DDD":case"w":case"W":return a%10!==2&&a%10!==3||a%100===12||a%100===13?a+"-ы":a+"-і";case"D":return a+"-га";default:return a}},week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Bulgarian [bg]
//! author : Krasen Borisov : https://github.com/kraz
a.defineLocale("bg",{months:"януари_февруари_март_април_май_юни_юли_август_септември_октомври_ноември_декември".split("_"),monthsShort:"янр_фев_мар_апр_май_юни_юли_авг_сеп_окт_ное_дек".split("_"),weekdays:"неделя_понеделник_вторник_сряда_четвъртък_петък_събота".split("_"),weekdaysShort:"нед_пон_вто_сря_чет_пет_съб".split("_"),weekdaysMin:"нд_пн_вт_ср_чт_пт_сб".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"D.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd, D MMMM YYYY H:mm"},calendar:{sameDay:"[Днес в] LT",nextDay:"[Утре в] LT",nextWeek:"dddd [в] LT",lastDay:"[Вчера в] LT",lastWeek:function(){switch(this.day()){case 0:case 3:case 6:return"[В изминалата] dddd [в] LT";case 1:case 2:case 4:case 5:return"[В изминалия] dddd [в] LT"}},sameElse:"L"},relativeTime:{future:"след %s",past:"преди %s",s:"няколко секунди",m:"минута",mm:"%d минути",h:"час",hh:"%d часа",d:"ден",dd:"%d дни",M:"месец",MM:"%d месеца",y:"година",yy:"%d години"},ordinalParse:/\d{1,2}-(ев|ен|ти|ви|ри|ми)/,ordinal:function(a){var b=a%10,c=a%100;return 0===a?a+"-ев":0===c?a+"-ен":c>10&&c<20?a+"-ти":1===b?a+"-ви":2===b?a+"-ри":7===b||8===b?a+"-ми":a+"-ти"},week:{dow:1,// Monday is the first day of the week.
doy:7}});
//! moment.js locale configuration
//! locale : Bengali [bn]
//! author : Kaushik Gandhi : https://github.com/kaushikgandhi
var Dg={1:"১",2:"২",3:"৩",4:"৪",5:"৫",6:"৬",7:"৭",8:"৮",9:"৯",0:"০"},Eg={"১":"1","২":"2","৩":"3","৪":"4","৫":"5","৬":"6","৭":"7","৮":"8","৯":"9","০":"0"};a.defineLocale("bn",{months:"জানুয়ারী_ফেব্রুয়ারি_মার্চ_এপ্রিল_মে_জুন_জুলাই_আগস্ট_সেপ্টেম্বর_অক্টোবর_নভেম্বর_ডিসেম্বর".split("_"),monthsShort:"জানু_ফেব_মার্চ_এপ্র_মে_জুন_জুল_আগ_সেপ্ট_অক্টো_নভে_ডিসে".split("_"),weekdays:"রবিবার_সোমবার_মঙ্গলবার_বুধবার_বৃহস্পতিবার_শুক্রবার_শনিবার".split("_"),weekdaysShort:"রবি_সোম_মঙ্গল_বুধ_বৃহস্পতি_শুক্র_শনি".split("_"),weekdaysMin:"রবি_সোম_মঙ্গ_বুধ_বৃহঃ_শুক্র_শনি".split("_"),longDateFormat:{LT:"A h:mm সময়",LTS:"A h:mm:ss সময়",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm সময়",LLLL:"dddd, D MMMM YYYY, A h:mm সময়"},calendar:{sameDay:"[আজ] LT",nextDay:"[আগামীকাল] LT",nextWeek:"dddd, LT",lastDay:"[গতকাল] LT",lastWeek:"[গত] dddd, LT",sameElse:"L"},relativeTime:{future:"%s পরে",past:"%s আগে",s:"কয়েক সেকেন্ড",m:"এক মিনিট",mm:"%d মিনিট",h:"এক ঘন্টা",hh:"%d ঘন্টা",d:"এক দিন",dd:"%d দিন",M:"এক মাস",MM:"%d মাস",y:"এক বছর",yy:"%d বছর"},preparse:function(a){return a.replace(/[১২৩৪৫৬৭৮৯০]/g,function(a){return Eg[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return Dg[a]})},meridiemParse:/রাত|সকাল|দুপুর|বিকাল|রাত/,meridiemHour:function(a,b){return 12===a&&(a=0),"রাত"===b&&a>=4||"দুপুর"===b&&a<5||"বিকাল"===b?a+12:a},meridiem:function(a,b,c){return a<4?"রাত":a<10?"সকাল":a<17?"দুপুর":a<20?"বিকাল":"রাত"},week:{dow:0,// Sunday is the first day of the week.
doy:6}});
//! moment.js locale configuration
//! locale : Tibetan [bo]
//! author : Thupten N. Chakrishar : https://github.com/vajradog
var Fg={1:"༡",2:"༢",3:"༣",4:"༤",5:"༥",6:"༦",7:"༧",8:"༨",9:"༩",0:"༠"},Gg={"༡":"1","༢":"2","༣":"3","༤":"4","༥":"5","༦":"6","༧":"7","༨":"8","༩":"9","༠":"0"};a.defineLocale("bo",{months:"ཟླ་བ་དང་པོ_ཟླ་བ་གཉིས་པ_ཟླ་བ་གསུམ་པ_ཟླ་བ་བཞི་པ_ཟླ་བ་ལྔ་པ_ཟླ་བ་དྲུག་པ_ཟླ་བ་བདུན་པ_ཟླ་བ་བརྒྱད་པ_ཟླ་བ་དགུ་པ_ཟླ་བ་བཅུ་པ_ཟླ་བ་བཅུ་གཅིག་པ_ཟླ་བ་བཅུ་གཉིས་པ".split("_"),monthsShort:"ཟླ་བ་དང་པོ_ཟླ་བ་གཉིས་པ_ཟླ་བ་གསུམ་པ_ཟླ་བ་བཞི་པ_ཟླ་བ་ལྔ་པ_ཟླ་བ་དྲུག་པ_ཟླ་བ་བདུན་པ_ཟླ་བ་བརྒྱད་པ_ཟླ་བ་དགུ་པ_ཟླ་བ་བཅུ་པ_ཟླ་བ་བཅུ་གཅིག་པ_ཟླ་བ་བཅུ་གཉིས་པ".split("_"),weekdays:"གཟའ་ཉི་མ་_གཟའ་ཟླ་བ་_གཟའ་མིག་དམར་_གཟའ་ལྷག་པ་_གཟའ་ཕུར་བུ_གཟའ་པ་སངས་_གཟའ་སྤེན་པ་".split("_"),weekdaysShort:"ཉི་མ་_ཟླ་བ་_མིག་དམར་_ལྷག་པ་_ཕུར་བུ_པ་སངས་_སྤེན་པ་".split("_"),weekdaysMin:"ཉི་མ་_ཟླ་བ་_མིག་དམར་_ལྷག་པ་_ཕུར་བུ_པ་སངས་_སྤེན་པ་".split("_"),longDateFormat:{LT:"A h:mm",LTS:"A h:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm",LLLL:"dddd, D MMMM YYYY, A h:mm"},calendar:{sameDay:"[དི་རིང] LT",nextDay:"[སང་ཉིན] LT",nextWeek:"[བདུན་ཕྲག་རྗེས་མ], LT",lastDay:"[ཁ་སང] LT",lastWeek:"[བདུན་ཕྲག་མཐའ་མ] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ལ་",past:"%s སྔན་ལ",s:"ལམ་སང",m:"སྐར་མ་གཅིག",mm:"%d སྐར་མ",h:"ཆུ་ཚོད་གཅིག",hh:"%d ཆུ་ཚོད",d:"ཉིན་གཅིག",dd:"%d ཉིན་",M:"ཟླ་བ་གཅིག",MM:"%d ཟླ་བ",y:"ལོ་གཅིག",yy:"%d ལོ"},preparse:function(a){return a.replace(/[༡༢༣༤༥༦༧༨༩༠]/g,function(a){return Gg[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return Fg[a]})},meridiemParse:/མཚན་མོ|ཞོགས་ཀས|ཉིན་གུང|དགོང་དག|མཚན་མོ/,meridiemHour:function(a,b){return 12===a&&(a=0),"མཚན་མོ"===b&&a>=4||"ཉིན་གུང"===b&&a<5||"དགོང་དག"===b?a+12:a},meridiem:function(a,b,c){return a<4?"མཚན་མོ":a<10?"ཞོགས་ཀས":a<17?"ཉིན་གུང":a<20?"དགོང་དག":"མཚན་མོ"},week:{dow:0,// Sunday is the first day of the week.
doy:6}}),a.defineLocale("br",{months:"Genver_C'hwevrer_Meurzh_Ebrel_Mae_Mezheven_Gouere_Eost_Gwengolo_Here_Du_Kerzu".split("_"),monthsShort:"Gen_C'hwe_Meu_Ebr_Mae_Eve_Gou_Eos_Gwe_Her_Du_Ker".split("_"),weekdays:"Sul_Lun_Meurzh_Merc'her_Yaou_Gwener_Sadorn".split("_"),weekdaysShort:"Sul_Lun_Meu_Mer_Yao_Gwe_Sad".split("_"),weekdaysMin:"Su_Lu_Me_Mer_Ya_Gw_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"h[e]mm A",LTS:"h[e]mm:ss A",L:"DD/MM/YYYY",LL:"D [a viz] MMMM YYYY",LLL:"D [a viz] MMMM YYYY h[e]mm A",LLLL:"dddd, D [a viz] MMMM YYYY h[e]mm A"},calendar:{sameDay:"[Hiziv da] LT",nextDay:"[Warc'hoazh da] LT",nextWeek:"dddd [da] LT",lastDay:"[Dec'h da] LT",lastWeek:"dddd [paset da] LT",sameElse:"L"},relativeTime:{future:"a-benn %s",past:"%s 'zo",s:"un nebeud segondennoù",m:"ur vunutenn",mm:qd,h:"un eur",hh:"%d eur",d:"un devezh",dd:qd,M:"ur miz",MM:qd,y:"ur bloaz",yy:rd},ordinalParse:/\d{1,2}(añ|vet)/,ordinal:function(a){var b=1===a?"añ":"vet";return a+b},week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("bs",{months:"januar_februar_mart_april_maj_juni_juli_august_septembar_oktobar_novembar_decembar".split("_"),monthsShort:"jan._feb._mar._apr._maj._jun._jul._aug._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedjelja_ponedjeljak_utorak_srijeda_četvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._čet._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_če_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[jučer u] LT",lastWeek:function(){switch(this.day()){case 0:case 3:return"[prošlu] dddd [u] LT";case 6:return"[prošle] [subote] [u] LT";case 1:case 2:case 4:case 5:return"[prošli] dddd [u] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"par sekundi",m:vd,mm:vd,h:vd,hh:vd,d:"dan",dd:vd,M:"mjesec",MM:vd,y:"godinu",yy:vd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Catalan [ca]
//! author : Juan G. Hurtado : https://github.com/juanghurtado
a.defineLocale("ca",{months:"gener_febrer_març_abril_maig_juny_juliol_agost_setembre_octubre_novembre_desembre".split("_"),monthsShort:"gen._febr._mar._abr._mai._jun._jul._ag._set._oct._nov._des.".split("_"),monthsParseExact:!0,weekdays:"diumenge_dilluns_dimarts_dimecres_dijous_divendres_dissabte".split("_"),weekdaysShort:"dg._dl._dt._dc._dj._dv._ds.".split("_"),weekdaysMin:"Dg_Dl_Dt_Dc_Dj_Dv_Ds".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd D MMMM YYYY H:mm"},calendar:{sameDay:function(){return"[avui a "+(1!==this.hours()?"les":"la")+"] LT"},nextDay:function(){return"[demà a "+(1!==this.hours()?"les":"la")+"] LT"},nextWeek:function(){return"dddd [a "+(1!==this.hours()?"les":"la")+"] LT"},lastDay:function(){return"[ahir a "+(1!==this.hours()?"les":"la")+"] LT"},lastWeek:function(){return"[el] dddd [passat a "+(1!==this.hours()?"les":"la")+"] LT"},sameElse:"L"},relativeTime:{future:"d'aquí %s",past:"fa %s",s:"uns segons",m:"un minut",mm:"%d minuts",h:"una hora",hh:"%d hores",d:"un dia",dd:"%d dies",M:"un mes",MM:"%d mesos",y:"un any",yy:"%d anys"},ordinalParse:/\d{1,2}(r|n|t|è|a)/,ordinal:function(a,b){var c=1===a?"r":2===a?"n":3===a?"r":4===a?"t":"è";return"w"!==b&&"W"!==b||(c="a"),a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Czech [cs]
//! author : petrbela : https://github.com/petrbela
var Hg="leden_únor_březen_duben_květen_červen_červenec_srpen_září_říjen_listopad_prosinec".split("_"),Ig="led_úno_bře_dub_kvě_čvn_čvc_srp_zář_říj_lis_pro".split("_");a.defineLocale("cs",{months:Hg,monthsShort:Ig,monthsParse:function(a,b){var c,d=[];for(c=0;c<12;c++)
// use custom parser to solve problem with July (červenec)
d[c]=new RegExp("^"+a[c]+"$|^"+b[c]+"$","i");return d}(Hg,Ig),shortMonthsParse:function(a){var b,c=[];for(b=0;b<12;b++)c[b]=new RegExp("^"+a[b]+"$","i");return c}(Ig),longMonthsParse:function(a){var b,c=[];for(b=0;b<12;b++)c[b]=new RegExp("^"+a[b]+"$","i");return c}(Hg),weekdays:"neděle_pondělí_úterý_středa_čtvrtek_pátek_sobota".split("_"),weekdaysShort:"ne_po_út_st_čt_pá_so".split("_"),weekdaysMin:"ne_po_út_st_čt_pá_so".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd D. MMMM YYYY H:mm",l:"D. M. YYYY"},calendar:{sameDay:"[dnes v] LT",nextDay:"[zítra v] LT",nextWeek:function(){switch(this.day()){case 0:return"[v neděli v] LT";case 1:case 2:return"[v] dddd [v] LT";case 3:return"[ve středu v] LT";case 4:return"[ve čtvrtek v] LT";case 5:return"[v pátek v] LT";case 6:return"[v sobotu v] LT"}},lastDay:"[včera v] LT",lastWeek:function(){switch(this.day()){case 0:return"[minulou neděli v] LT";case 1:case 2:return"[minulé] dddd [v] LT";case 3:return"[minulou středu v] LT";case 4:case 5:return"[minulý] dddd [v] LT";case 6:return"[minulou sobotu v] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"před %s",s:xd,m:xd,mm:xd,h:xd,hh:xd,d:xd,dd:xd,M:xd,MM:xd,y:xd,yy:xd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Chuvash [cv]
//! author : Anatoly Mironov : https://github.com/mirontoli
a.defineLocale("cv",{months:"кӑрлач_нарӑс_пуш_ака_май_ҫӗртме_утӑ_ҫурла_авӑн_юпа_чӳк_раштав".split("_"),monthsShort:"кӑр_нар_пуш_ака_май_ҫӗр_утӑ_ҫур_авн_юпа_чӳк_раш".split("_"),weekdays:"вырсарникун_тунтикун_ытларикун_юнкун_кӗҫнерникун_эрнекун_шӑматкун".split("_"),weekdaysShort:"выр_тун_ытл_юн_кӗҫ_эрн_шӑм".split("_"),weekdaysMin:"вр_тн_ыт_юн_кҫ_эр_шм".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD-MM-YYYY",LL:"YYYY [ҫулхи] MMMM [уйӑхӗн] D[-мӗшӗ]",LLL:"YYYY [ҫулхи] MMMM [уйӑхӗн] D[-мӗшӗ], HH:mm",LLLL:"dddd, YYYY [ҫулхи] MMMM [уйӑхӗн] D[-мӗшӗ], HH:mm"},calendar:{sameDay:"[Паян] LT [сехетре]",nextDay:"[Ыран] LT [сехетре]",lastDay:"[Ӗнер] LT [сехетре]",nextWeek:"[Ҫитес] dddd LT [сехетре]",lastWeek:"[Иртнӗ] dddd LT [сехетре]",sameElse:"L"},relativeTime:{future:function(a){var b=/сехет$/i.exec(a)?"рен":/ҫул$/i.exec(a)?"тан":"ран";return a+b},past:"%s каялла",s:"пӗр-ик ҫеккунт",m:"пӗр минут",mm:"%d минут",h:"пӗр сехет",hh:"%d сехет",d:"пӗр кун",dd:"%d кун",M:"пӗр уйӑх",MM:"%d уйӑх",y:"пӗр ҫул",yy:"%d ҫул"},ordinalParse:/\d{1,2}-мӗш/,ordinal:"%d-мӗш",week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Welsh [cy]
//! author : Robert Allen : https://github.com/robgallen
//! author : https://github.com/ryangreaves
a.defineLocale("cy",{months:"Ionawr_Chwefror_Mawrth_Ebrill_Mai_Mehefin_Gorffennaf_Awst_Medi_Hydref_Tachwedd_Rhagfyr".split("_"),monthsShort:"Ion_Chwe_Maw_Ebr_Mai_Meh_Gor_Aws_Med_Hyd_Tach_Rhag".split("_"),weekdays:"Dydd Sul_Dydd Llun_Dydd Mawrth_Dydd Mercher_Dydd Iau_Dydd Gwener_Dydd Sadwrn".split("_"),weekdaysShort:"Sul_Llun_Maw_Mer_Iau_Gwe_Sad".split("_"),weekdaysMin:"Su_Ll_Ma_Me_Ia_Gw_Sa".split("_"),weekdaysParseExact:!0,
// time formats are the same as en-gb
longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Heddiw am] LT",nextDay:"[Yfory am] LT",nextWeek:"dddd [am] LT",lastDay:"[Ddoe am] LT",lastWeek:"dddd [diwethaf am] LT",sameElse:"L"},relativeTime:{future:"mewn %s",past:"%s yn ôl",s:"ychydig eiliadau",m:"munud",mm:"%d munud",h:"awr",hh:"%d awr",d:"diwrnod",dd:"%d diwrnod",M:"mis",MM:"%d mis",y:"blwyddyn",yy:"%d flynedd"},ordinalParse:/\d{1,2}(fed|ain|af|il|ydd|ed|eg)/,
// traditional ordinal numbers above 31 are not commonly used in colloquial Welsh
ordinal:function(a){var b=a,c="",d=["","af","il","ydd","ydd","ed","ed","ed","fed","fed","fed",// 1af to 10fed
"eg","fed","eg","eg","fed","eg","eg","fed","eg","fed"];return b>20?c=40===b||50===b||60===b||80===b||100===b?"fed":"ain":b>0&&(c=d[b]),a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Danish [da]
//! author : Ulrik Nielsen : https://github.com/mrbase
a.defineLocale("da",{months:"januar_februar_marts_april_maj_juni_juli_august_september_oktober_november_december".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec".split("_"),weekdays:"søndag_mandag_tirsdag_onsdag_torsdag_fredag_lørdag".split("_"),weekdaysShort:"søn_man_tir_ons_tor_fre_lør".split("_"),weekdaysMin:"sø_ma_ti_on_to_fr_lø".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY HH:mm",LLLL:"dddd [d.] D. MMMM YYYY HH:mm"},calendar:{sameDay:"[I dag kl.] LT",nextDay:"[I morgen kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[I går kl.] LT",lastWeek:"[sidste] dddd [kl] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"%s siden",s:"få sekunder",m:"et minut",mm:"%d minutter",h:"en time",hh:"%d timer",d:"en dag",dd:"%d dage",M:"en måned",MM:"%d måneder",y:"et år",yy:"%d år"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("de-at",{months:"Jänner_Februar_März_April_Mai_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jän._Febr._Mrz._Apr._Mai_Jun._Jul._Aug._Sept._Okt._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Sonntag_Montag_Dienstag_Mittwoch_Donnerstag_Freitag_Samstag".split("_"),weekdaysShort:"So._Mo._Di._Mi._Do._Fr._Sa.".split("_"),weekdaysMin:"So_Mo_Di_Mi_Do_Fr_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY HH:mm",LLLL:"dddd, D. MMMM YYYY HH:mm"},calendar:{sameDay:"[heute um] LT [Uhr]",sameElse:"L",nextDay:"[morgen um] LT [Uhr]",nextWeek:"dddd [um] LT [Uhr]",lastDay:"[gestern um] LT [Uhr]",lastWeek:"[letzten] dddd [um] LT [Uhr]"},relativeTime:{future:"in %s",past:"vor %s",s:"ein paar Sekunden",m:yd,mm:"%d Minuten",h:yd,hh:"%d Stunden",d:yd,dd:yd,M:yd,MM:yd,y:yd,yy:yd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("de",{months:"Januar_Februar_März_April_Mai_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jan._Febr._Mrz._Apr._Mai_Jun._Jul._Aug._Sept._Okt._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Sonntag_Montag_Dienstag_Mittwoch_Donnerstag_Freitag_Samstag".split("_"),weekdaysShort:"So._Mo._Di._Mi._Do._Fr._Sa.".split("_"),weekdaysMin:"So_Mo_Di_Mi_Do_Fr_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY HH:mm",LLLL:"dddd, D. MMMM YYYY HH:mm"},calendar:{sameDay:"[heute um] LT [Uhr]",sameElse:"L",nextDay:"[morgen um] LT [Uhr]",nextWeek:"dddd [um] LT [Uhr]",lastDay:"[gestern um] LT [Uhr]",lastWeek:"[letzten] dddd [um] LT [Uhr]"},relativeTime:{future:"in %s",past:"vor %s",s:"ein paar Sekunden",m:zd,mm:"%d Minuten",h:zd,hh:"%d Stunden",d:zd,dd:zd,M:zd,MM:zd,y:zd,yy:zd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Maldivian [dv]
//! author : Jawish Hameed : https://github.com/jawish
var Jg=["ޖެނުއަރީ","ފެބްރުއަރީ","މާރިޗު","އޭޕްރީލު","މޭ","ޖޫން","ޖުލައި","އޯގަސްޓު","ސެޕްޓެމްބަރު","އޮކްޓޯބަރު","ނޮވެމްބަރު","ޑިސެމްބަރު"],Kg=["އާދިއްތަ","ހޯމަ","އަންގާރަ","ބުދަ","ބުރާސްފަތި","ހުކުރު","ހޮނިހިރު"];a.defineLocale("dv",{months:Jg,monthsShort:Jg,weekdays:Kg,weekdaysShort:Kg,weekdaysMin:"އާދި_ހޯމަ_އަން_ބުދަ_ބުރާ_ހުކު_ހޮނި".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/M/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/މކ|މފ/,isPM:function(a){return"މފ"===a},meridiem:function(a,b,c){return a<12?"މކ":"މފ"},calendar:{sameDay:"[މިއަދު] LT",nextDay:"[މާދަމާ] LT",nextWeek:"dddd LT",lastDay:"[އިއްޔެ] LT",lastWeek:"[ފާއިތުވި] dddd LT",sameElse:"L"},relativeTime:{future:"ތެރޭގައި %s",past:"ކުރިން %s",s:"ސިކުންތުކޮޅެއް",m:"މިނިޓެއް",mm:"މިނިޓު %d",h:"ގަޑިއިރެއް",hh:"ގަޑިއިރު %d",d:"ދުވަހެއް",dd:"ދުވަސް %d",M:"މަހެއް",MM:"މަސް %d",y:"އަހަރެއް",yy:"އަހަރު %d"},preparse:function(a){return a.replace(/،/g,",")},postformat:function(a){return a.replace(/,/g,"،")},week:{dow:7,// Sunday is the first day of the week.
doy:12}}),
//! moment.js locale configuration
//! locale : Greek [el]
//! author : Aggelos Karalias : https://github.com/mehiel
a.defineLocale("el",{monthsNominativeEl:"Ιανουάριος_Φεβρουάριος_Μάρτιος_Απρίλιος_Μάιος_Ιούνιος_Ιούλιος_Αύγουστος_Σεπτέμβριος_Οκτώβριος_Νοέμβριος_Δεκέμβριος".split("_"),monthsGenitiveEl:"Ιανουαρίου_Φεβρουαρίου_Μαρτίου_Απριλίου_Μαΐου_Ιουνίου_Ιουλίου_Αυγούστου_Σεπτεμβρίου_Οκτωβρίου_Νοεμβρίου_Δεκεμβρίου".split("_"),months:function(a,b){return/D/.test(b.substring(0,b.indexOf("MMMM")))?this._monthsGenitiveEl[a.month()]:this._monthsNominativeEl[a.month()]},monthsShort:"Ιαν_Φεβ_Μαρ_Απρ_Μαϊ_Ιουν_Ιουλ_Αυγ_Σεπ_Οκτ_Νοε_Δεκ".split("_"),weekdays:"Κυριακή_Δευτέρα_Τρίτη_Τετάρτη_Πέμπτη_Παρασκευή_Σάββατο".split("_"),weekdaysShort:"Κυρ_Δευ_Τρι_Τετ_Πεμ_Παρ_Σαβ".split("_"),weekdaysMin:"Κυ_Δε_Τρ_Τε_Πε_Πα_Σα".split("_"),meridiem:function(a,b,c){return a>11?c?"μμ":"ΜΜ":c?"πμ":"ΠΜ"},isPM:function(a){return"μ"===(a+"").toLowerCase()[0]},meridiemParse:/[ΠΜ]\.?Μ?\.?/i,longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendarEl:{sameDay:"[Σήμερα {}] LT",nextDay:"[Αύριο {}] LT",nextWeek:"dddd [{}] LT",lastDay:"[Χθες {}] LT",lastWeek:function(){switch(this.day()){case 6:return"[το προηγούμενο] dddd [{}] LT";default:return"[την προηγούμενη] dddd [{}] LT"}},sameElse:"L"},calendar:function(a,b){var c=this._calendarEl[a],d=b&&b.hours();return z(c)&&(c=c.apply(b)),c.replace("{}",d%12===1?"στη":"στις")},relativeTime:{future:"σε %s",past:"%s πριν",s:"λίγα δευτερόλεπτα",m:"ένα λεπτό",mm:"%d λεπτά",h:"μία ώρα",hh:"%d ώρες",d:"μία μέρα",dd:"%d μέρες",M:"ένας μήνας",MM:"%d μήνες",y:"ένας χρόνος",yy:"%d χρόνια"},ordinalParse:/\d{1,2}η/,ordinal:"%dη",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : English (Australia) [en-au]
//! author : Jared Morse : https://github.com/jarcoal
a.defineLocale("en-au",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : English (Canada) [en-ca]
//! author : Jonathan Abourbih : https://github.com/jonbca
a.defineLocale("en-ca",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"YYYY-MM-DD",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),
//! moment.js locale configuration
//! locale : English (United Kingdom) [en-gb]
//! author : Chris Gedrim : https://github.com/chrisgedrim
a.defineLocale("en-gb",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : English (Ireland) [en-ie]
//! author : Chris Cartlidge : https://github.com/chriscartlidge
a.defineLocale("en-ie",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : English (New Zealand) [en-nz]
//! author : Luke McGregor : https://github.com/lukemcgregor
a.defineLocale("en-nz",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Esperanto [eo]
//! author : Colin Dean : https://github.com/colindean
//! komento: Mi estas malcerta se mi korekte traktis akuzativojn en tiu traduko.
//!          Se ne, bonvolu korekti kaj avizi min por ke mi povas lerni!
a.defineLocale("eo",{months:"januaro_februaro_marto_aprilo_majo_junio_julio_aŭgusto_septembro_oktobro_novembro_decembro".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aŭg_sep_okt_nov_dec".split("_"),weekdays:"Dimanĉo_Lundo_Mardo_Merkredo_Ĵaŭdo_Vendredo_Sabato".split("_"),weekdaysShort:"Dim_Lun_Mard_Merk_Ĵaŭ_Ven_Sab".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Ĵa_Ve_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"D[-an de] MMMM, YYYY",LLL:"D[-an de] MMMM, YYYY HH:mm",LLLL:"dddd, [la] D[-an de] MMMM, YYYY HH:mm"},meridiemParse:/[ap]\.t\.m/i,isPM:function(a){return"p"===a.charAt(0).toLowerCase()},meridiem:function(a,b,c){return a>11?c?"p.t.m.":"P.T.M.":c?"a.t.m.":"A.T.M."},calendar:{sameDay:"[Hodiaŭ je] LT",nextDay:"[Morgaŭ je] LT",nextWeek:"dddd [je] LT",lastDay:"[Hieraŭ je] LT",lastWeek:"[pasinta] dddd [je] LT",sameElse:"L"},relativeTime:{future:"je %s",past:"antaŭ %s",s:"sekundoj",m:"minuto",mm:"%d minutoj",h:"horo",hh:"%d horoj",d:"tago",//ne 'diurno', ĉar estas uzita por proksimumo
dd:"%d tagoj",M:"monato",MM:"%d monatoj",y:"jaro",yy:"%d jaroj"},ordinalParse:/\d{1,2}a/,ordinal:"%da",week:{dow:1,// Monday is the first day of the week.
doy:7}});
//! moment.js locale configuration
//! locale : Spanish (Dominican Republic) [es-do]
var Lg="ene._feb._mar._abr._may._jun._jul._ago._sep._oct._nov._dic.".split("_"),Mg="ene_feb_mar_abr_may_jun_jul_ago_sep_oct_nov_dic".split("_");a.defineLocale("es-do",{months:"enero_febrero_marzo_abril_mayo_junio_julio_agosto_septiembre_octubre_noviembre_diciembre".split("_"),monthsShort:function(a,b){return/-MMM-/.test(b)?Mg[a.month()]:Lg[a.month()]},monthsParseExact:!0,weekdays:"domingo_lunes_martes_miércoles_jueves_viernes_sábado".split("_"),weekdaysShort:"dom._lun._mar._mié._jue._vie._sáb.".split("_"),weekdaysMin:"do_lu_ma_mi_ju_vi_sá".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY h:mm A",LLLL:"dddd, D [de] MMMM [de] YYYY h:mm A"},calendar:{sameDay:function(){return"[hoy a la"+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[mañana a la"+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(1!==this.hours()?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(1!==this.hours()?"s":"")+"] LT"},lastWeek:function(){return"[el] dddd [pasado a la"+(1!==this.hours()?"s":"")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"hace %s",s:"unos segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un día",dd:"%d días",M:"un mes",MM:"%d meses",y:"un año",yy:"%d años"},ordinalParse:/\d{1,2}º/,ordinal:"%dº",week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Spanish [es]
//! author : Julio Napurí : https://github.com/julionc
var Ng="ene._feb._mar._abr._may._jun._jul._ago._sep._oct._nov._dic.".split("_"),Og="ene_feb_mar_abr_may_jun_jul_ago_sep_oct_nov_dic".split("_");a.defineLocale("es",{months:"enero_febrero_marzo_abril_mayo_junio_julio_agosto_septiembre_octubre_noviembre_diciembre".split("_"),monthsShort:function(a,b){return/-MMM-/.test(b)?Og[a.month()]:Ng[a.month()]},monthsParseExact:!0,weekdays:"domingo_lunes_martes_miércoles_jueves_viernes_sábado".split("_"),weekdaysShort:"dom._lun._mar._mié._jue._vie._sáb.".split("_"),weekdaysMin:"do_lu_ma_mi_ju_vi_sá".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY H:mm",LLLL:"dddd, D [de] MMMM [de] YYYY H:mm"},calendar:{sameDay:function(){return"[hoy a la"+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[mañana a la"+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(1!==this.hours()?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(1!==this.hours()?"s":"")+"] LT"},lastWeek:function(){return"[el] dddd [pasado a la"+(1!==this.hours()?"s":"")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"hace %s",s:"unos segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un día",dd:"%d días",M:"un mes",MM:"%d meses",y:"un año",yy:"%d años"},ordinalParse:/\d{1,2}º/,ordinal:"%dº",week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("et",{months:"jaanuar_veebruar_märts_aprill_mai_juuni_juuli_august_september_oktoober_november_detsember".split("_"),monthsShort:"jaan_veebr_märts_apr_mai_juuni_juuli_aug_sept_okt_nov_dets".split("_"),weekdays:"pühapäev_esmaspäev_teisipäev_kolmapäev_neljapäev_reede_laupäev".split("_"),weekdaysShort:"P_E_T_K_N_R_L".split("_"),weekdaysMin:"P_E_T_K_N_R_L".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[Täna,] LT",nextDay:"[Homme,] LT",nextWeek:"[Järgmine] dddd LT",lastDay:"[Eile,] LT",lastWeek:"[Eelmine] dddd LT",sameElse:"L"},relativeTime:{future:"%s pärast",past:"%s tagasi",s:Ad,m:Ad,mm:Ad,h:Ad,hh:Ad,d:Ad,dd:"%d päeva",M:Ad,MM:Ad,y:Ad,yy:Ad},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Basque [eu]
//! author : Eneko Illarramendi : https://github.com/eillarra
a.defineLocale("eu",{months:"urtarrila_otsaila_martxoa_apirila_maiatza_ekaina_uztaila_abuztua_iraila_urria_azaroa_abendua".split("_"),monthsShort:"urt._ots._mar._api._mai._eka._uzt._abu._ira._urr._aza._abe.".split("_"),monthsParseExact:!0,weekdays:"igandea_astelehena_asteartea_asteazkena_osteguna_ostirala_larunbata".split("_"),weekdaysShort:"ig._al._ar._az._og._ol._lr.".split("_"),weekdaysMin:"ig_al_ar_az_og_ol_lr".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"YYYY[ko] MMMM[ren] D[a]",LLL:"YYYY[ko] MMMM[ren] D[a] HH:mm",LLLL:"dddd, YYYY[ko] MMMM[ren] D[a] HH:mm",l:"YYYY-M-D",ll:"YYYY[ko] MMM D[a]",lll:"YYYY[ko] MMM D[a] HH:mm",llll:"ddd, YYYY[ko] MMM D[a] HH:mm"},calendar:{sameDay:"[gaur] LT[etan]",nextDay:"[bihar] LT[etan]",nextWeek:"dddd LT[etan]",lastDay:"[atzo] LT[etan]",lastWeek:"[aurreko] dddd LT[etan]",sameElse:"L"},relativeTime:{future:"%s barru",past:"duela %s",s:"segundo batzuk",m:"minutu bat",mm:"%d minutu",h:"ordu bat",hh:"%d ordu",d:"egun bat",dd:"%d egun",M:"hilabete bat",MM:"%d hilabete",y:"urte bat",yy:"%d urte"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:7}});
//! moment.js locale configuration
//! locale : Persian [fa]
//! author : Ebrahim Byagowi : https://github.com/ebraminio
var Pg={1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹",0:"۰"},Qg={"۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"7","۸":"8","۹":"9","۰":"0"};a.defineLocale("fa",{months:"ژانویه_فوریه_مارس_آوریل_مه_ژوئن_ژوئیه_اوت_سپتامبر_اکتبر_نوامبر_دسامبر".split("_"),monthsShort:"ژانویه_فوریه_مارس_آوریل_مه_ژوئن_ژوئیه_اوت_سپتامبر_اکتبر_نوامبر_دسامبر".split("_"),weekdays:"یک‌شنبه_دوشنبه_سه‌شنبه_چهارشنبه_پنج‌شنبه_جمعه_شنبه".split("_"),weekdaysShort:"یک‌شنبه_دوشنبه_سه‌شنبه_چهارشنبه_پنج‌شنبه_جمعه_شنبه".split("_"),weekdaysMin:"ی_د_س_چ_پ_ج_ش".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},meridiemParse:/قبل از ظهر|بعد از ظهر/,isPM:function(a){return/بعد از ظهر/.test(a)},meridiem:function(a,b,c){return a<12?"قبل از ظهر":"بعد از ظهر"},calendar:{sameDay:"[امروز ساعت] LT",nextDay:"[فردا ساعت] LT",nextWeek:"dddd [ساعت] LT",lastDay:"[دیروز ساعت] LT",lastWeek:"dddd [پیش] [ساعت] LT",sameElse:"L"},relativeTime:{future:"در %s",past:"%s پیش",s:"چندین ثانیه",m:"یک دقیقه",mm:"%d دقیقه",h:"یک ساعت",hh:"%d ساعت",d:"یک روز",dd:"%d روز",M:"یک ماه",MM:"%d ماه",y:"یک سال",yy:"%d سال"},preparse:function(a){return a.replace(/[۰-۹]/g,function(a){return Qg[a]}).replace(/،/g,",")},postformat:function(a){return a.replace(/\d/g,function(a){return Pg[a]}).replace(/,/g,"،")},ordinalParse:/\d{1,2}م/,ordinal:"%dم",week:{dow:6,// Saturday is the first day of the week.
doy:12}});
//! moment.js locale configuration
//! locale : Finnish [fi]
//! author : Tarmo Aidantausta : https://github.com/bleadof
var Rg="nolla yksi kaksi kolme neljä viisi kuusi seitsemän kahdeksan yhdeksän".split(" "),Sg=["nolla","yhden","kahden","kolmen","neljän","viiden","kuuden",Rg[7],Rg[8],Rg[9]];a.defineLocale("fi",{months:"tammikuu_helmikuu_maaliskuu_huhtikuu_toukokuu_kesäkuu_heinäkuu_elokuu_syyskuu_lokakuu_marraskuu_joulukuu".split("_"),monthsShort:"tammi_helmi_maalis_huhti_touko_kesä_heinä_elo_syys_loka_marras_joulu".split("_"),weekdays:"sunnuntai_maanantai_tiistai_keskiviikko_torstai_perjantai_lauantai".split("_"),weekdaysShort:"su_ma_ti_ke_to_pe_la".split("_"),weekdaysMin:"su_ma_ti_ke_to_pe_la".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD.MM.YYYY",LL:"Do MMMM[ta] YYYY",LLL:"Do MMMM[ta] YYYY, [klo] HH.mm",LLLL:"dddd, Do MMMM[ta] YYYY, [klo] HH.mm",l:"D.M.YYYY",ll:"Do MMM YYYY",lll:"Do MMM YYYY, [klo] HH.mm",llll:"ddd, Do MMM YYYY, [klo] HH.mm"},calendar:{sameDay:"[tänään] [klo] LT",nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"},relativeTime:{future:"%s päästä",past:"%s sitten",s:Bd,m:Bd,mm:Bd,h:Bd,hh:Bd,d:Bd,dd:Bd,M:Bd,MM:Bd,y:Bd,yy:Bd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Faroese [fo]
//! author : Ragnar Johannesen : https://github.com/ragnar123
a.defineLocale("fo",{months:"januar_februar_mars_apríl_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan_feb_mar_apr_mai_jun_jul_aug_sep_okt_nov_des".split("_"),weekdays:"sunnudagur_mánadagur_týsdagur_mikudagur_hósdagur_fríggjadagur_leygardagur".split("_"),weekdaysShort:"sun_mán_týs_mik_hós_frí_ley".split("_"),weekdaysMin:"su_má_tý_mi_hó_fr_le".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D. MMMM, YYYY HH:mm"},calendar:{sameDay:"[Í dag kl.] LT",nextDay:"[Í morgin kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[Í gjár kl.] LT",lastWeek:"[síðstu] dddd [kl] LT",sameElse:"L"},relativeTime:{future:"um %s",past:"%s síðani",s:"fá sekund",m:"ein minutt",mm:"%d minuttir",h:"ein tími",hh:"%d tímar",d:"ein dagur",dd:"%d dagar",M:"ein mánaði",MM:"%d mánaðir",y:"eitt ár",yy:"%d ár"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : French (Canada) [fr-ca]
//! author : Jonathan Abourbih : https://github.com/jonbca
a.defineLocale("fr-ca",{months:"janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre".split("_"),monthsShort:"janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.".split("_"),monthsParseExact:!0,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourd'hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},ordinalParse:/\d{1,2}(er|e)/,ordinal:function(a){return a+(1===a?"er":"e")}}),
//! moment.js locale configuration
//! locale : French (Switzerland) [fr-ch]
//! author : Gaspard Bucher : https://github.com/gaspard
a.defineLocale("fr-ch",{months:"janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre".split("_"),monthsShort:"janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.".split("_"),monthsParseExact:!0,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourd'hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},ordinalParse:/\d{1,2}(er|e)/,ordinal:function(a){return a+(1===a?"er":"e")},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : French [fr]
//! author : John Fischer : https://github.com/jfroffice
a.defineLocale("fr",{months:"janvier_février_mars_avril_mai_juin_juillet_août_septembre_octobre_novembre_décembre".split("_"),monthsShort:"janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.".split("_"),monthsParseExact:!0,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"Di_Lu_Ma_Me_Je_Ve_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourd'hui à] LT",nextDay:"[Demain à] LT",nextWeek:"dddd [à] LT",lastDay:"[Hier à] LT",lastWeek:"dddd [dernier à] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},ordinalParse:/\d{1,2}(er|)/,ordinal:function(a){return a+(1===a?"er":"")},week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Frisian [fy]
//! author : Robin van der Vliet : https://github.com/robin0van0der0v
var Tg="jan._feb._mrt._apr._mai_jun._jul._aug._sep._okt._nov._des.".split("_"),Ug="jan_feb_mrt_apr_mai_jun_jul_aug_sep_okt_nov_des".split("_");a.defineLocale("fy",{months:"jannewaris_febrewaris_maart_april_maaie_juny_july_augustus_septimber_oktober_novimber_desimber".split("_"),monthsShort:function(a,b){return/-MMM-/.test(b)?Ug[a.month()]:Tg[a.month()]},monthsParseExact:!0,weekdays:"snein_moandei_tiisdei_woansdei_tongersdei_freed_sneon".split("_"),weekdaysShort:"si._mo._ti._wo._to._fr._so.".split("_"),weekdaysMin:"Si_Mo_Ti_Wo_To_Fr_So".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[hjoed om] LT",nextDay:"[moarn om] LT",nextWeek:"dddd [om] LT",lastDay:"[juster om] LT",lastWeek:"[ôfrûne] dddd [om] LT",sameElse:"L"},relativeTime:{future:"oer %s",past:"%s lyn",s:"in pear sekonden",m:"ien minút",mm:"%d minuten",h:"ien oere",hh:"%d oeren",d:"ien dei",dd:"%d dagen",M:"ien moanne",MM:"%d moannen",y:"ien jier",yy:"%d jierren"},ordinalParse:/\d{1,2}(ste|de)/,ordinal:function(a){return a+(1===a||8===a||a>=20?"ste":"de")},week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Scottish Gaelic [gd]
//! author : Jon Ashdown : https://github.com/jonashdown
var Vg=["Am Faoilleach","An Gearran","Am Màrt","An Giblean","An Cèitean","An t-Ògmhios","An t-Iuchar","An Lùnastal","An t-Sultain","An Dàmhair","An t-Samhain","An Dùbhlachd"],Wg=["Faoi","Gear","Màrt","Gibl","Cèit","Ògmh","Iuch","Lùn","Sult","Dàmh","Samh","Dùbh"],Xg=["Didòmhnaich","Diluain","Dimàirt","Diciadain","Diardaoin","Dihaoine","Disathairne"],Yg=["Did","Dil","Dim","Dic","Dia","Dih","Dis"],Zg=["Dò","Lu","Mà","Ci","Ar","Ha","Sa"];a.defineLocale("gd",{months:Vg,monthsShort:Wg,monthsParseExact:!0,weekdays:Xg,weekdaysShort:Yg,weekdaysMin:Zg,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[An-diugh aig] LT",nextDay:"[A-màireach aig] LT",nextWeek:"dddd [aig] LT",lastDay:"[An-dè aig] LT",lastWeek:"dddd [seo chaidh] [aig] LT",sameElse:"L"},relativeTime:{future:"ann an %s",past:"bho chionn %s",s:"beagan diogan",m:"mionaid",mm:"%d mionaidean",h:"uair",hh:"%d uairean",d:"latha",dd:"%d latha",M:"mìos",MM:"%d mìosan",y:"bliadhna",yy:"%d bliadhna"},ordinalParse:/\d{1,2}(d|na|mh)/,ordinal:function(a){var b=1===a?"d":a%10===2?"na":"mh";return a+b},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Galician [gl]
//! author : Juan G. Hurtado : https://github.com/juanghurtado
a.defineLocale("gl",{months:"xaneiro_febreiro_marzo_abril_maio_xuño_xullo_agosto_setembro_outubro_novembro_decembro".split("_"),monthsShort:"xan._feb._mar._abr._mai._xuñ._xul._ago._set._out._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"domingo_luns_martes_mércores_xoves_venres_sábado".split("_"),weekdaysShort:"dom._lun._mar._mér._xov._ven._sáb.".split("_"),weekdaysMin:"do_lu_ma_mé_xo_ve_sá".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY H:mm",LLLL:"dddd, D [de] MMMM [de] YYYY H:mm"},calendar:{sameDay:function(){return"[hoxe "+(1!==this.hours()?"ás":"á")+"] LT"},nextDay:function(){return"[mañá "+(1!==this.hours()?"ás":"á")+"] LT"},nextWeek:function(){return"dddd ["+(1!==this.hours()?"ás":"a")+"] LT"},lastDay:function(){return"[onte "+(1!==this.hours()?"á":"a")+"] LT"},lastWeek:function(){return"[o] dddd [pasado "+(1!==this.hours()?"ás":"a")+"] LT"},sameElse:"L"},relativeTime:{future:function(a){return 0===a.indexOf("un")?"n"+a:"en "+a},past:"hai %s",s:"uns segundos",m:"un minuto",mm:"%d minutos",h:"unha hora",hh:"%d horas",d:"un día",dd:"%d días",M:"un mes",MM:"%d meses",y:"un ano",yy:"%d anos"},ordinalParse:/\d{1,2}º/,ordinal:"%dº",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Hebrew [he]
//! author : Tomer Cohen : https://github.com/tomer
//! author : Moshe Simantov : https://github.com/DevelopmentIL
//! author : Tal Ater : https://github.com/TalAter
a.defineLocale("he",{months:"ינואר_פברואר_מרץ_אפריל_מאי_יוני_יולי_אוגוסט_ספטמבר_אוקטובר_נובמבר_דצמבר".split("_"),monthsShort:"ינו׳_פבר׳_מרץ_אפר׳_מאי_יוני_יולי_אוג׳_ספט׳_אוק׳_נוב׳_דצמ׳".split("_"),weekdays:"ראשון_שני_שלישי_רביעי_חמישי_שישי_שבת".split("_"),weekdaysShort:"א׳_ב׳_ג׳_ד׳_ה׳_ו׳_ש׳".split("_"),weekdaysMin:"א_ב_ג_ד_ה_ו_ש".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D [ב]MMMM YYYY",LLL:"D [ב]MMMM YYYY HH:mm",LLLL:"dddd, D [ב]MMMM YYYY HH:mm",l:"D/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY HH:mm",llll:"ddd, D MMM YYYY HH:mm"},calendar:{sameDay:"[היום ב־]LT",nextDay:"[מחר ב־]LT",nextWeek:"dddd [בשעה] LT",lastDay:"[אתמול ב־]LT",lastWeek:"[ביום] dddd [האחרון בשעה] LT",sameElse:"L"},relativeTime:{future:"בעוד %s",past:"לפני %s",s:"מספר שניות",m:"דקה",mm:"%d דקות",h:"שעה",hh:function(a){return 2===a?"שעתיים":a+" שעות"},d:"יום",dd:function(a){return 2===a?"יומיים":a+" ימים"},M:"חודש",MM:function(a){return 2===a?"חודשיים":a+" חודשים"},y:"שנה",yy:function(a){return 2===a?"שנתיים":a%10===0&&10!==a?a+" שנה":a+" שנים"}},meridiemParse:/אחה"צ|לפנה"צ|אחרי הצהריים|לפני הצהריים|לפנות בוקר|בבוקר|בערב/i,isPM:function(a){return/^(אחה"צ|אחרי הצהריים|בערב)$/.test(a)},meridiem:function(a,b,c){return a<5?"לפנות בוקר":a<10?"בבוקר":a<12?c?'לפנה"צ':"לפני הצהריים":a<18?c?'אחה"צ':"אחרי הצהריים":"בערב"}});
//! moment.js locale configuration
//! locale : Hindi [hi]
//! author : Mayank Singhal : https://github.com/mayanksinghal
var $g={1:"१",2:"२",3:"३",4:"४",5:"५",6:"६",7:"७",8:"८",9:"९",0:"०"},_g={"१":"1","२":"2","३":"3","४":"4","५":"5","६":"6","७":"7","८":"8","९":"9","०":"0"};a.defineLocale("hi",{months:"जनवरी_फ़रवरी_मार्च_अप्रैल_मई_जून_जुलाई_अगस्त_सितम्बर_अक्टूबर_नवम्बर_दिसम्बर".split("_"),monthsShort:"जन._फ़र._मार्च_अप्रै._मई_जून_जुल._अग._सित._अक्टू._नव._दिस.".split("_"),monthsParseExact:!0,weekdays:"रविवार_सोमवार_मंगलवार_बुधवार_गुरूवार_शुक्रवार_शनिवार".split("_"),weekdaysShort:"रवि_सोम_मंगल_बुध_गुरू_शुक्र_शनि".split("_"),weekdaysMin:"र_सो_मं_बु_गु_शु_श".split("_"),longDateFormat:{LT:"A h:mm बजे",LTS:"A h:mm:ss बजे",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm बजे",LLLL:"dddd, D MMMM YYYY, A h:mm बजे"},calendar:{sameDay:"[आज] LT",nextDay:"[कल] LT",nextWeek:"dddd, LT",lastDay:"[कल] LT",lastWeek:"[पिछले] dddd, LT",sameElse:"L"},relativeTime:{future:"%s में",past:"%s पहले",s:"कुछ ही क्षण",m:"एक मिनट",mm:"%d मिनट",h:"एक घंटा",hh:"%d घंटे",d:"एक दिन",dd:"%d दिन",M:"एक महीने",MM:"%d महीने",y:"एक वर्ष",yy:"%d वर्ष"},preparse:function(a){return a.replace(/[१२३४५६७८९०]/g,function(a){return _g[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return $g[a]})},
// Hindi notation for meridiems are quite fuzzy in practice. While there exists
// a rigid notion of a 'Pahar' it is not used as rigidly in modern Hindi.
meridiemParse:/रात|सुबह|दोपहर|शाम/,meridiemHour:function(a,b){return 12===a&&(a=0),"रात"===b?a<4?a:a+12:"सुबह"===b?a:"दोपहर"===b?a>=10?a:a+12:"शाम"===b?a+12:void 0},meridiem:function(a,b,c){return a<4?"रात":a<10?"सुबह":a<17?"दोपहर":a<20?"शाम":"रात"},week:{dow:0,// Sunday is the first day of the week.
doy:6}}),a.defineLocale("hr",{months:{format:"siječnja_veljače_ožujka_travnja_svibnja_lipnja_srpnja_kolovoza_rujna_listopada_studenoga_prosinca".split("_"),standalone:"siječanj_veljača_ožujak_travanj_svibanj_lipanj_srpanj_kolovoz_rujan_listopad_studeni_prosinac".split("_")},monthsShort:"sij._velj._ožu._tra._svi._lip._srp._kol._ruj._lis._stu._pro.".split("_"),monthsParseExact:!0,weekdays:"nedjelja_ponedjeljak_utorak_srijeda_četvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._čet._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_če_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[jučer u] LT",lastWeek:function(){switch(this.day()){case 0:case 3:return"[prošlu] dddd [u] LT";case 6:return"[prošle] [subote] [u] LT";case 1:case 2:case 4:case 5:return"[prošli] dddd [u] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"par sekundi",m:Dd,mm:Dd,h:Dd,hh:Dd,d:"dan",dd:Dd,M:"mjesec",MM:Dd,y:"godinu",yy:Dd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:7}});
//! moment.js locale configuration
//! locale : Hungarian [hu]
//! author : Adam Brunner : https://github.com/adambrunner
var ah="vasárnap hétfőn kedden szerdán csütörtökön pénteken szombaton".split(" ");a.defineLocale("hu",{months:"január_február_március_április_május_június_július_augusztus_szeptember_október_november_december".split("_"),monthsShort:"jan_feb_márc_ápr_máj_jún_júl_aug_szept_okt_nov_dec".split("_"),weekdays:"vasárnap_hétfő_kedd_szerda_csütörtök_péntek_szombat".split("_"),weekdaysShort:"vas_hét_kedd_sze_csüt_pén_szo".split("_"),weekdaysMin:"v_h_k_sze_cs_p_szo".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY. MMMM D.",LLL:"YYYY. MMMM D. H:mm",LLLL:"YYYY. MMMM D., dddd H:mm"},meridiemParse:/de|du/i,isPM:function(a){return"u"===a.charAt(1).toLowerCase()},meridiem:function(a,b,c){return a<12?c===!0?"de":"DE":c===!0?"du":"DU"},calendar:{sameDay:"[ma] LT[-kor]",nextDay:"[holnap] LT[-kor]",nextWeek:function(){return Fd.call(this,!0)},lastDay:"[tegnap] LT[-kor]",lastWeek:function(){return Fd.call(this,!1)},sameElse:"L"},relativeTime:{future:"%s múlva",past:"%s",s:Ed,m:Ed,mm:Ed,h:Ed,hh:Ed,d:Ed,dd:Ed,M:Ed,MM:Ed,y:Ed,yy:Ed},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Armenian [hy-am]
//! author : Armendarabyan : https://github.com/armendarabyan
a.defineLocale("hy-am",{months:{format:"հունվարի_փետրվարի_մարտի_ապրիլի_մայիսի_հունիսի_հուլիսի_օգոստոսի_սեպտեմբերի_հոկտեմբերի_նոյեմբերի_դեկտեմբերի".split("_"),standalone:"հունվար_փետրվար_մարտ_ապրիլ_մայիս_հունիս_հուլիս_օգոստոս_սեպտեմբեր_հոկտեմբեր_նոյեմբեր_դեկտեմբեր".split("_")},monthsShort:"հնվ_փտր_մրտ_ապր_մյս_հնս_հլս_օգս_սպտ_հկտ_նմբ_դկտ".split("_"),weekdays:"կիրակի_երկուշաբթի_երեքշաբթի_չորեքշաբթի_հինգշաբթի_ուրբաթ_շաբաթ".split("_"),weekdaysShort:"կրկ_երկ_երք_չրք_հնգ_ուրբ_շբթ".split("_"),weekdaysMin:"կրկ_երկ_երք_չրք_հնգ_ուրբ_շբթ".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY թ.",LLL:"D MMMM YYYY թ., HH:mm",LLLL:"dddd, D MMMM YYYY թ., HH:mm"},calendar:{sameDay:"[այսօր] LT",nextDay:"[վաղը] LT",lastDay:"[երեկ] LT",nextWeek:function(){return"dddd [օրը ժամը] LT"},lastWeek:function(){return"[անցած] dddd [օրը ժամը] LT"},sameElse:"L"},relativeTime:{future:"%s հետո",past:"%s առաջ",s:"մի քանի վայրկյան",m:"րոպե",mm:"%d րոպե",h:"ժամ",hh:"%d ժամ",d:"օր",dd:"%d օր",M:"ամիս",MM:"%d ամիս",y:"տարի",yy:"%d տարի"},meridiemParse:/գիշերվա|առավոտվա|ցերեկվա|երեկոյան/,isPM:function(a){return/^(ցերեկվա|երեկոյան)$/.test(a)},meridiem:function(a){return a<4?"գիշերվա":a<12?"առավոտվա":a<17?"ցերեկվա":"երեկոյան"},ordinalParse:/\d{1,2}|\d{1,2}-(ին|րդ)/,ordinal:function(a,b){switch(b){case"DDD":case"w":case"W":case"DDDo":return 1===a?a+"-ին":a+"-րդ";default:return a}},week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Indonesian [id]
//! author : Mohammad Satrio Utomo : https://github.com/tyok
//! reference: http://id.wikisource.org/wiki/Pedoman_Umum_Ejaan_Bahasa_Indonesia_yang_Disempurnakan
a.defineLocale("id",{months:"Januari_Februari_Maret_April_Mei_Juni_Juli_Agustus_September_Oktober_November_Desember".split("_"),monthsShort:"Jan_Feb_Mar_Apr_Mei_Jun_Jul_Ags_Sep_Okt_Nov_Des".split("_"),weekdays:"Minggu_Senin_Selasa_Rabu_Kamis_Jumat_Sabtu".split("_"),weekdaysShort:"Min_Sen_Sel_Rab_Kam_Jum_Sab".split("_"),weekdaysMin:"Mg_Sn_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/pagi|siang|sore|malam/,meridiemHour:function(a,b){return 12===a&&(a=0),"pagi"===b?a:"siang"===b?a>=11?a:a+12:"sore"===b||"malam"===b?a+12:void 0},meridiem:function(a,b,c){return a<11?"pagi":a<15?"siang":a<19?"sore":"malam"},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Besok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kemarin pukul] LT",lastWeek:"dddd [lalu pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lalu",s:"beberapa detik",m:"semenit",mm:"%d menit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:1,// Monday is the first day of the week.
doy:7}}),a.defineLocale("is",{months:"janúar_febrúar_mars_apríl_maí_júní_júlí_ágúst_september_október_nóvember_desember".split("_"),monthsShort:"jan_feb_mar_apr_maí_jún_júl_ágú_sep_okt_nóv_des".split("_"),weekdays:"sunnudagur_mánudagur_þriðjudagur_miðvikudagur_fimmtudagur_föstudagur_laugardagur".split("_"),weekdaysShort:"sun_mán_þri_mið_fim_fös_lau".split("_"),weekdaysMin:"Su_Má_Þr_Mi_Fi_Fö_La".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] H:mm",LLLL:"dddd, D. MMMM YYYY [kl.] H:mm"},calendar:{sameDay:"[í dag kl.] LT",nextDay:"[á morgun kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[í gær kl.] LT",lastWeek:"[síðasta] dddd [kl.] LT",sameElse:"L"},relativeTime:{future:"eftir %s",past:"fyrir %s síðan",s:Hd,m:Hd,mm:Hd,h:"klukkustund",hh:Hd,d:Hd,dd:Hd,M:Hd,MM:Hd,y:Hd,yy:Hd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Italian [it]
//! author : Lorenzo : https://github.com/aliem
//! author: Mattia Larentis: https://github.com/nostalgiaz
a.defineLocale("it",{months:"gennaio_febbraio_marzo_aprile_maggio_giugno_luglio_agosto_settembre_ottobre_novembre_dicembre".split("_"),monthsShort:"gen_feb_mar_apr_mag_giu_lug_ago_set_ott_nov_dic".split("_"),weekdays:"Domenica_Lunedì_Martedì_Mercoledì_Giovedì_Venerdì_Sabato".split("_"),weekdaysShort:"Dom_Lun_Mar_Mer_Gio_Ven_Sab".split("_"),weekdaysMin:"Do_Lu_Ma_Me_Gi_Ve_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Oggi alle] LT",nextDay:"[Domani alle] LT",nextWeek:"dddd [alle] LT",lastDay:"[Ieri alle] LT",lastWeek:function(){switch(this.day()){case 0:return"[la scorsa] dddd [alle] LT";default:return"[lo scorso] dddd [alle] LT"}},sameElse:"L"},relativeTime:{future:function(a){return(/^[0-9].+$/.test(a)?"tra":"in")+" "+a},past:"%s fa",s:"alcuni secondi",m:"un minuto",mm:"%d minuti",h:"un'ora",hh:"%d ore",d:"un giorno",dd:"%d giorni",M:"un mese",MM:"%d mesi",y:"un anno",yy:"%d anni"},ordinalParse:/\d{1,2}º/,ordinal:"%dº",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Japanese [ja]
//! author : LI Long : https://github.com/baryon
a.defineLocale("ja",{months:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),weekdays:"日曜日_月曜日_火曜日_水曜日_木曜日_金曜日_土曜日".split("_"),weekdaysShort:"日_月_火_水_木_金_土".split("_"),weekdaysMin:"日_月_火_水_木_金_土".split("_"),longDateFormat:{LT:"Ah時m分",LTS:"Ah時m分s秒",L:"YYYY/MM/DD",LL:"YYYY年M月D日",LLL:"YYYY年M月D日Ah時m分",LLLL:"YYYY年M月D日Ah時m分 dddd"},meridiemParse:/午前|午後/i,isPM:function(a){return"午後"===a},meridiem:function(a,b,c){return a<12?"午前":"午後"},calendar:{sameDay:"[今日] LT",nextDay:"[明日] LT",nextWeek:"[来週]dddd LT",lastDay:"[昨日] LT",lastWeek:"[前週]dddd LT",sameElse:"L"},ordinalParse:/\d{1,2}日/,ordinal:function(a,b){switch(b){case"d":case"D":case"DDD":return a+"日";default:return a}},relativeTime:{future:"%s後",past:"%s前",s:"数秒",m:"1分",mm:"%d分",h:"1時間",hh:"%d時間",d:"1日",dd:"%d日",M:"1ヶ月",MM:"%dヶ月",y:"1年",yy:"%d年"}}),
//! moment.js locale configuration
//! locale : Javanese [jv]
//! author : Rony Lantip : https://github.com/lantip
//! reference: http://jv.wikipedia.org/wiki/Basa_Jawa
a.defineLocale("jv",{months:"Januari_Februari_Maret_April_Mei_Juni_Juli_Agustus_September_Oktober_Nopember_Desember".split("_"),monthsShort:"Jan_Feb_Mar_Apr_Mei_Jun_Jul_Ags_Sep_Okt_Nop_Des".split("_"),weekdays:"Minggu_Senen_Seloso_Rebu_Kemis_Jemuwah_Septu".split("_"),weekdaysShort:"Min_Sen_Sel_Reb_Kem_Jem_Sep".split("_"),weekdaysMin:"Mg_Sn_Sl_Rb_Km_Jm_Sp".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/enjing|siyang|sonten|ndalu/,meridiemHour:function(a,b){return 12===a&&(a=0),"enjing"===b?a:"siyang"===b?a>=11?a:a+12:"sonten"===b||"ndalu"===b?a+12:void 0},meridiem:function(a,b,c){return a<11?"enjing":a<15?"siyang":a<19?"sonten":"ndalu"},calendar:{sameDay:"[Dinten puniko pukul] LT",nextDay:"[Mbenjang pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kala wingi pukul] LT",lastWeek:"dddd [kepengker pukul] LT",sameElse:"L"},relativeTime:{future:"wonten ing %s",past:"%s ingkang kepengker",s:"sawetawis detik",m:"setunggal menit",mm:"%d menit",h:"setunggal jam",hh:"%d jam",d:"sedinten",dd:"%d dinten",M:"sewulan",MM:"%d wulan",y:"setaun",yy:"%d taun"},week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Georgian [ka]
//! author : Irakli Janiashvili : https://github.com/irakli-janiashvili
a.defineLocale("ka",{months:{standalone:"იანვარი_თებერვალი_მარტი_აპრილი_მაისი_ივნისი_ივლისი_აგვისტო_სექტემბერი_ოქტომბერი_ნოემბერი_დეკემბერი".split("_"),format:"იანვარს_თებერვალს_მარტს_აპრილის_მაისს_ივნისს_ივლისს_აგვისტს_სექტემბერს_ოქტომბერს_ნოემბერს_დეკემბერს".split("_")},monthsShort:"იან_თებ_მარ_აპრ_მაი_ივნ_ივლ_აგვ_სექ_ოქტ_ნოე_დეკ".split("_"),weekdays:{standalone:"კვირა_ორშაბათი_სამშაბათი_ოთხშაბათი_ხუთშაბათი_პარასკევი_შაბათი".split("_"),format:"კვირას_ორშაბათს_სამშაბათს_ოთხშაბათს_ხუთშაბათს_პარასკევს_შაბათს".split("_"),isFormat:/(წინა|შემდეგ)/},weekdaysShort:"კვი_ორშ_სამ_ოთხ_ხუთ_პარ_შაბ".split("_"),weekdaysMin:"კვ_ორ_სა_ოთ_ხუ_პა_შა".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[დღეს] LT[-ზე]",nextDay:"[ხვალ] LT[-ზე]",lastDay:"[გუშინ] LT[-ზე]",nextWeek:"[შემდეგ] dddd LT[-ზე]",lastWeek:"[წინა] dddd LT-ზე",sameElse:"L"},relativeTime:{future:function(a){return/(წამი|წუთი|საათი|წელი)/.test(a)?a.replace(/ი$/,"ში"):a+"ში"},past:function(a){return/(წამი|წუთი|საათი|დღე|თვე)/.test(a)?a.replace(/(ი|ე)$/,"ის წინ"):/წელი/.test(a)?a.replace(/წელი$/,"წლის წინ"):void 0},s:"რამდენიმე წამი",m:"წუთი",mm:"%d წუთი",h:"საათი",hh:"%d საათი",d:"დღე",dd:"%d დღე",M:"თვე",MM:"%d თვე",y:"წელი",yy:"%d წელი"},ordinalParse:/0|1-ლი|მე-\d{1,2}|\d{1,2}-ე/,ordinal:function(a){return 0===a?a:1===a?a+"-ლი":a<20||a<=100&&a%20===0||a%100===0?"მე-"+a:a+"-ე"},week:{dow:1,doy:7}});
//! moment.js locale configuration
//! locale : Kazakh [kk]
//! authors : Nurlan Rakhimzhanov : https://github.com/nurlan
var bh={0:"-ші",1:"-ші",2:"-ші",3:"-ші",4:"-ші",5:"-ші",6:"-шы",7:"-ші",8:"-ші",9:"-шы",10:"-шы",20:"-шы",30:"-шы",40:"-шы",50:"-ші",60:"-шы",70:"-ші",80:"-ші",90:"-шы",100:"-ші"};a.defineLocale("kk",{months:"қаңтар_ақпан_наурыз_сәуір_мамыр_маусым_шілде_тамыз_қыркүйек_қазан_қараша_желтоқсан".split("_"),monthsShort:"қаң_ақп_нау_сәу_мам_мау_шіл_там_қыр_қаз_қар_жел".split("_"),weekdays:"жексенбі_дүйсенбі_сейсенбі_сәрсенбі_бейсенбі_жұма_сенбі".split("_"),weekdaysShort:"жек_дүй_сей_сәр_бей_жұм_сен".split("_"),weekdaysMin:"жк_дй_сй_ср_бй_жм_сн".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Бүгін сағат] LT",nextDay:"[Ертең сағат] LT",nextWeek:"dddd [сағат] LT",lastDay:"[Кеше сағат] LT",lastWeek:"[Өткен аптаның] dddd [сағат] LT",sameElse:"L"},relativeTime:{future:"%s ішінде",past:"%s бұрын",s:"бірнеше секунд",m:"бір минут",mm:"%d минут",h:"бір сағат",hh:"%d сағат",d:"бір күн",dd:"%d күн",M:"бір ай",MM:"%d ай",y:"бір жыл",yy:"%d жыл"},ordinalParse:/\d{1,2}-(ші|шы)/,ordinal:function(a){var b=a%10,c=a>=100?100:null;return a+(bh[a]||bh[b]||bh[c])},week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Cambodian [km]
//! author : Kruy Vanna : https://github.com/kruyvanna
a.defineLocale("km",{months:"មករា_កុម្ភៈ_មីនា_មេសា_ឧសភា_មិថុនា_កក្កដា_សីហា_កញ្ញា_តុលា_វិច្ឆិកា_ធ្នូ".split("_"),monthsShort:"មករា_កុម្ភៈ_មីនា_មេសា_ឧសភា_មិថុនា_កក្កដា_សីហា_កញ្ញា_តុលា_វិច្ឆិកា_ធ្នូ".split("_"),weekdays:"អាទិត្យ_ច័ន្ទ_អង្គារ_ពុធ_ព្រហស្បតិ៍_សុក្រ_សៅរ៍".split("_"),weekdaysShort:"អាទិត្យ_ច័ន្ទ_អង្គារ_ពុធ_ព្រហស្បតិ៍_សុក្រ_សៅរ៍".split("_"),weekdaysMin:"អាទិត្យ_ច័ន្ទ_អង្គារ_ពុធ_ព្រហស្បតិ៍_សុក្រ_សៅរ៍".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[ថ្ងៃនេះ ម៉ោង] LT",nextDay:"[ស្អែក ម៉ោង] LT",nextWeek:"dddd [ម៉ោង] LT",lastDay:"[ម្សិលមិញ ម៉ោង] LT",lastWeek:"dddd [សប្តាហ៍មុន] [ម៉ោង] LT",sameElse:"L"},relativeTime:{future:"%sទៀត",past:"%sមុន",s:"ប៉ុន្មានវិនាទី",m:"មួយនាទី",mm:"%d នាទី",h:"មួយម៉ោង",hh:"%d ម៉ោង",d:"មួយថ្ងៃ",dd:"%d ថ្ងៃ",M:"មួយខែ",MM:"%d ខែ",y:"មួយឆ្នាំ",yy:"%d ឆ្នាំ"},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Korean [ko]
//! author : Kyungwook, Park : https://github.com/kyungw00k
//! author : Jeeeyul Lee <jeeeyul@gmail.com>
a.defineLocale("ko",{months:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),monthsShort:"1월_2월_3월_4월_5월_6월_7월_8월_9월_10월_11월_12월".split("_"),weekdays:"일요일_월요일_화요일_수요일_목요일_금요일_토요일".split("_"),weekdaysShort:"일_월_화_수_목_금_토".split("_"),weekdaysMin:"일_월_화_수_목_금_토".split("_"),longDateFormat:{LT:"A h시 m분",LTS:"A h시 m분 s초",L:"YYYY.MM.DD",LL:"YYYY년 MMMM D일",LLL:"YYYY년 MMMM D일 A h시 m분",LLLL:"YYYY년 MMMM D일 dddd A h시 m분"},calendar:{sameDay:"오늘 LT",nextDay:"내일 LT",nextWeek:"dddd LT",lastDay:"어제 LT",lastWeek:"지난주 dddd LT",sameElse:"L"},relativeTime:{future:"%s 후",past:"%s 전",s:"몇 초",ss:"%d초",m:"일분",mm:"%d분",h:"한 시간",hh:"%d시간",d:"하루",dd:"%d일",M:"한 달",MM:"%d달",y:"일 년",yy:"%d년"},ordinalParse:/\d{1,2}일/,ordinal:"%d일",meridiemParse:/오전|오후/,isPM:function(a){return"오후"===a},meridiem:function(a,b,c){return a<12?"오전":"오후"}});
//! moment.js locale configuration
//! locale : Kyrgyz [ky]
//! author : Chyngyz Arystan uulu : https://github.com/chyngyz
var ch={0:"-чү",1:"-чи",2:"-чи",3:"-чү",4:"-чү",5:"-чи",6:"-чы",7:"-чи",8:"-чи",9:"-чу",10:"-чу",20:"-чы",30:"-чу",40:"-чы",50:"-чү",60:"-чы",70:"-чи",80:"-чи",90:"-чу",100:"-чү"};a.defineLocale("ky",{months:"январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_"),monthsShort:"янв_фев_март_апр_май_июнь_июль_авг_сен_окт_ноя_дек".split("_"),weekdays:"Жекшемби_Дүйшөмбү_Шейшемби_Шаршемби_Бейшемби_Жума_Ишемби".split("_"),weekdaysShort:"Жек_Дүй_Шей_Шар_Бей_Жум_Ише".split("_"),weekdaysMin:"Жк_Дй_Шй_Шр_Бй_Жм_Иш".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Бүгүн саат] LT",nextDay:"[Эртең саат] LT",nextWeek:"dddd [саат] LT",lastDay:"[Кече саат] LT",lastWeek:"[Өткен аптанын] dddd [күнү] [саат] LT",sameElse:"L"},relativeTime:{future:"%s ичинде",past:"%s мурун",s:"бирнече секунд",m:"бир мүнөт",mm:"%d мүнөт",h:"бир саат",hh:"%d саат",d:"бир күн",dd:"%d күн",M:"бир ай",MM:"%d ай",y:"бир жыл",yy:"%d жыл"},ordinalParse:/\d{1,2}-(чи|чы|чү|чу)/,ordinal:function(a){var b=a%10,c=a>=100?100:null;return a+(ch[a]||ch[b]||ch[c])},week:{dow:1,// Monday is the first day of the week.
doy:7}}),a.defineLocale("lb",{months:"Januar_Februar_Mäerz_Abrëll_Mee_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jan._Febr._Mrz._Abr._Mee_Jun._Jul._Aug._Sept._Okt._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Sonndeg_Méindeg_Dënschdeg_Mëttwoch_Donneschdeg_Freideg_Samschdeg".split("_"),weekdaysShort:"So._Mé._Dë._Më._Do._Fr._Sa.".split("_"),weekdaysMin:"So_Mé_Dë_Më_Do_Fr_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm [Auer]",LTS:"H:mm:ss [Auer]",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm [Auer]",LLLL:"dddd, D. MMMM YYYY H:mm [Auer]"},calendar:{sameDay:"[Haut um] LT",sameElse:"L",nextDay:"[Muer um] LT",nextWeek:"dddd [um] LT",lastDay:"[Gëschter um] LT",lastWeek:function(){
// Different date string for 'Dënschdeg' (Tuesday) and 'Donneschdeg' (Thursday) due to phonological rule
switch(this.day()){case 2:case 4:return"[Leschten] dddd [um] LT";default:return"[Leschte] dddd [um] LT"}}},relativeTime:{future:Jd,past:Kd,s:"e puer Sekonnen",m:Id,mm:"%d Minutten",h:Id,hh:"%d Stonnen",d:Id,dd:"%d Deeg",M:Id,MM:"%d Méint",y:Id,yy:"%d Joer"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Lao [lo]
//! author : Ryan Hart : https://github.com/ryanhart2
a.defineLocale("lo",{months:"ມັງກອນ_ກຸມພາ_ມີນາ_ເມສາ_ພຶດສະພາ_ມິຖຸນາ_ກໍລະກົດ_ສິງຫາ_ກັນຍາ_ຕຸລາ_ພະຈິກ_ທັນວາ".split("_"),monthsShort:"ມັງກອນ_ກຸມພາ_ມີນາ_ເມສາ_ພຶດສະພາ_ມິຖຸນາ_ກໍລະກົດ_ສິງຫາ_ກັນຍາ_ຕຸລາ_ພະຈິກ_ທັນວາ".split("_"),weekdays:"ອາທິດ_ຈັນ_ອັງຄານ_ພຸດ_ພະຫັດ_ສຸກ_ເສົາ".split("_"),weekdaysShort:"ທິດ_ຈັນ_ອັງຄານ_ພຸດ_ພະຫັດ_ສຸກ_ເສົາ".split("_"),weekdaysMin:"ທ_ຈ_ອຄ_ພ_ພຫ_ສກ_ສ".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"ວັນdddd D MMMM YYYY HH:mm"},meridiemParse:/ຕອນເຊົ້າ|ຕອນແລງ/,isPM:function(a){return"ຕອນແລງ"===a},meridiem:function(a,b,c){return a<12?"ຕອນເຊົ້າ":"ຕອນແລງ"},calendar:{sameDay:"[ມື້ນີ້ເວລາ] LT",nextDay:"[ມື້ອື່ນເວລາ] LT",nextWeek:"[ວັນ]dddd[ໜ້າເວລາ] LT",lastDay:"[ມື້ວານນີ້ເວລາ] LT",lastWeek:"[ວັນ]dddd[ແລ້ວນີ້ເວລາ] LT",sameElse:"L"},relativeTime:{future:"ອີກ %s",past:"%sຜ່ານມາ",s:"ບໍ່ເທົ່າໃດວິນາທີ",m:"1 ນາທີ",mm:"%d ນາທີ",h:"1 ຊົ່ວໂມງ",hh:"%d ຊົ່ວໂມງ",d:"1 ມື້",dd:"%d ມື້",M:"1 ເດືອນ",MM:"%d ເດືອນ",y:"1 ປີ",yy:"%d ປີ"},ordinalParse:/(ທີ່)\d{1,2}/,ordinal:function(a){return"ທີ່"+a}});
//! moment.js locale configuration
//! locale : Lithuanian [lt]
//! author : Mindaugas Mozūras : https://github.com/mmozuras
var dh={m:"minutė_minutės_minutę",mm:"minutės_minučių_minutes",h:"valanda_valandos_valandą",hh:"valandos_valandų_valandas",d:"diena_dienos_dieną",dd:"dienos_dienų_dienas",M:"mėnuo_mėnesio_mėnesį",MM:"mėnesiai_mėnesių_mėnesius",y:"metai_metų_metus",yy:"metai_metų_metus"};a.defineLocale("lt",{months:{format:"sausio_vasario_kovo_balandžio_gegužės_birželio_liepos_rugpjūčio_rugsėjo_spalio_lapkričio_gruodžio".split("_"),standalone:"sausis_vasaris_kovas_balandis_gegužė_birželis_liepa_rugpjūtis_rugsėjis_spalis_lapkritis_gruodis".split("_"),isFormat:/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?|MMMM?(\[[^\[\]]*\]|\s)+D[oD]?/},monthsShort:"sau_vas_kov_bal_geg_bir_lie_rgp_rgs_spa_lap_grd".split("_"),weekdays:{format:"sekmadienį_pirmadienį_antradienį_trečiadienį_ketvirtadienį_penktadienį_šeštadienį".split("_"),standalone:"sekmadienis_pirmadienis_antradienis_trečiadienis_ketvirtadienis_penktadienis_šeštadienis".split("_"),isFormat:/dddd HH:mm/},weekdaysShort:"Sek_Pir_Ant_Tre_Ket_Pen_Šeš".split("_"),weekdaysMin:"S_P_A_T_K_Pn_Š".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"YYYY [m.] MMMM D [d.]",LLL:"YYYY [m.] MMMM D [d.], HH:mm [val.]",LLLL:"YYYY [m.] MMMM D [d.], dddd, HH:mm [val.]",l:"YYYY-MM-DD",ll:"YYYY [m.] MMMM D [d.]",lll:"YYYY [m.] MMMM D [d.], HH:mm [val.]",llll:"YYYY [m.] MMMM D [d.], ddd, HH:mm [val.]"},calendar:{sameDay:"[Šiandien] LT",nextDay:"[Rytoj] LT",nextWeek:"dddd LT",lastDay:"[Vakar] LT",lastWeek:"[Praėjusį] dddd LT",sameElse:"L"},relativeTime:{future:"po %s",past:"prieš %s",s:Md,m:Nd,mm:Qd,h:Nd,hh:Qd,d:Nd,dd:Qd,M:Nd,MM:Qd,y:Nd,yy:Qd},ordinalParse:/\d{1,2}-oji/,ordinal:function(a){return a+"-oji"},week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Latvian [lv]
//! author : Kristaps Karlsons : https://github.com/skakri
//! author : Jānis Elmeris : https://github.com/JanisE
var eh={m:"minūtes_minūtēm_minūte_minūtes".split("_"),mm:"minūtes_minūtēm_minūte_minūtes".split("_"),h:"stundas_stundām_stunda_stundas".split("_"),hh:"stundas_stundām_stunda_stundas".split("_"),d:"dienas_dienām_diena_dienas".split("_"),dd:"dienas_dienām_diena_dienas".split("_"),M:"mēneša_mēnešiem_mēnesis_mēneši".split("_"),MM:"mēneša_mēnešiem_mēnesis_mēneši".split("_"),y:"gada_gadiem_gads_gadi".split("_"),yy:"gada_gadiem_gads_gadi".split("_")};a.defineLocale("lv",{months:"janvāris_februāris_marts_aprīlis_maijs_jūnijs_jūlijs_augusts_septembris_oktobris_novembris_decembris".split("_"),monthsShort:"jan_feb_mar_apr_mai_jūn_jūl_aug_sep_okt_nov_dec".split("_"),weekdays:"svētdiena_pirmdiena_otrdiena_trešdiena_ceturtdiena_piektdiena_sestdiena".split("_"),weekdaysShort:"Sv_P_O_T_C_Pk_S".split("_"),weekdaysMin:"Sv_P_O_T_C_Pk_S".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY.",LL:"YYYY. [gada] D. MMMM",LLL:"YYYY. [gada] D. MMMM, HH:mm",LLLL:"YYYY. [gada] D. MMMM, dddd, HH:mm"},calendar:{sameDay:"[Šodien pulksten] LT",nextDay:"[Rīt pulksten] LT",nextWeek:"dddd [pulksten] LT",lastDay:"[Vakar pulksten] LT",lastWeek:"[Pagājušā] dddd [pulksten] LT",sameElse:"L"},relativeTime:{future:"pēc %s",past:"pirms %s",s:Ud,m:Td,mm:Sd,h:Td,hh:Sd,d:Td,dd:Sd,M:Td,MM:Sd,y:Td,yy:Sd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Montenegrin [me]
//! author : Miodrag Nikač <miodrag@restartit.me> : https://github.com/miodragnikac
var fh={words:{//Different grammatical cases
m:["jedan minut","jednog minuta"],mm:["minut","minuta","minuta"],h:["jedan sat","jednog sata"],hh:["sat","sata","sati"],dd:["dan","dana","dana"],MM:["mjesec","mjeseca","mjeseci"],yy:["godina","godine","godina"]},correctGrammaticalCase:function(a,b){return 1===a?b[0]:a>=2&&a<=4?b[1]:b[2]},translate:function(a,b,c){var d=fh.words[c];return 1===c.length?b?d[0]:d[1]:a+" "+fh.correctGrammaticalCase(a,d)}};a.defineLocale("me",{months:"januar_februar_mart_april_maj_jun_jul_avgust_septembar_oktobar_novembar_decembar".split("_"),monthsShort:"jan._feb._mar._apr._maj_jun_jul_avg._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedjelja_ponedjeljak_utorak_srijeda_četvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._čet._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_če_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sjutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[juče u] LT",lastWeek:function(){var a=["[prošle] [nedjelje] [u] LT","[prošlog] [ponedjeljka] [u] LT","[prošlog] [utorka] [u] LT","[prošle] [srijede] [u] LT","[prošlog] [četvrtka] [u] LT","[prošlog] [petka] [u] LT","[prošle] [subote] [u] LT"];return a[this.day()]},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"nekoliko sekundi",m:fh.translate,mm:fh.translate,h:fh.translate,hh:fh.translate,d:"dan",dd:fh.translate,M:"mjesec",MM:fh.translate,y:"godinu",yy:fh.translate},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Maori [mi]
//! author : John Corrigan <robbiecloset@gmail.com> : https://github.com/johnideal
a.defineLocale("mi",{months:"Kohi-tāte_Hui-tanguru_Poutū-te-rangi_Paenga-whāwhā_Haratua_Pipiri_Hōngoingoi_Here-turi-kōkā_Mahuru_Whiringa-ā-nuku_Whiringa-ā-rangi_Hakihea".split("_"),monthsShort:"Kohi_Hui_Pou_Pae_Hara_Pipi_Hōngoi_Here_Mahu_Whi-nu_Whi-ra_Haki".split("_"),monthsRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,3}/i,monthsStrictRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,3}/i,monthsShortRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,3}/i,monthsShortStrictRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,2}/i,weekdays:"Rātapu_Mane_Tūrei_Wenerei_Tāite_Paraire_Hātarei".split("_"),weekdaysShort:"Ta_Ma_Tū_We_Tāi_Pa_Hā".split("_"),weekdaysMin:"Ta_Ma_Tū_We_Tāi_Pa_Hā".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [i] HH:mm",LLLL:"dddd, D MMMM YYYY [i] HH:mm"},calendar:{sameDay:"[i teie mahana, i] LT",nextDay:"[apopo i] LT",nextWeek:"dddd [i] LT",lastDay:"[inanahi i] LT",lastWeek:"dddd [whakamutunga i] LT",sameElse:"L"},relativeTime:{future:"i roto i %s",past:"%s i mua",s:"te hēkona ruarua",m:"he meneti",mm:"%d meneti",h:"te haora",hh:"%d haora",d:"he ra",dd:"%d ra",M:"he marama",MM:"%d marama",y:"he tau",yy:"%d tau"},ordinalParse:/\d{1,2}º/,ordinal:"%dº",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Macedonian [mk]
//! author : Borislav Mickov : https://github.com/B0k0
a.defineLocale("mk",{months:"јануари_февруари_март_април_мај_јуни_јули_август_септември_октомври_ноември_декември".split("_"),monthsShort:"јан_фев_мар_апр_мај_јун_јул_авг_сеп_окт_ное_дек".split("_"),weekdays:"недела_понеделник_вторник_среда_четврток_петок_сабота".split("_"),weekdaysShort:"нед_пон_вто_сре_чет_пет_саб".split("_"),weekdaysMin:"нe_пo_вт_ср_че_пе_сa".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"D.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd, D MMMM YYYY H:mm"},calendar:{sameDay:"[Денес во] LT",nextDay:"[Утре во] LT",nextWeek:"[Во] dddd [во] LT",lastDay:"[Вчера во] LT",lastWeek:function(){switch(this.day()){case 0:case 3:case 6:return"[Изминатата] dddd [во] LT";case 1:case 2:case 4:case 5:return"[Изминатиот] dddd [во] LT"}},sameElse:"L"},relativeTime:{future:"после %s",past:"пред %s",s:"неколку секунди",m:"минута",mm:"%d минути",h:"час",hh:"%d часа",d:"ден",dd:"%d дена",M:"месец",MM:"%d месеци",y:"година",yy:"%d години"},ordinalParse:/\d{1,2}-(ев|ен|ти|ви|ри|ми)/,ordinal:function(a){var b=a%10,c=a%100;return 0===a?a+"-ев":0===c?a+"-ен":c>10&&c<20?a+"-ти":1===b?a+"-ви":2===b?a+"-ри":7===b||8===b?a+"-ми":a+"-ти"},week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Malayalam [ml]
//! author : Floyd Pink : https://github.com/floydpink
a.defineLocale("ml",{months:"ജനുവരി_ഫെബ്രുവരി_മാർച്ച്_ഏപ്രിൽ_മേയ്_ജൂൺ_ജൂലൈ_ഓഗസ്റ്റ്_സെപ്റ്റംബർ_ഒക്ടോബർ_നവംബർ_ഡിസംബർ".split("_"),monthsShort:"ജനു._ഫെബ്രു._മാർ._ഏപ്രി._മേയ്_ജൂൺ_ജൂലൈ._ഓഗ._സെപ്റ്റ._ഒക്ടോ._നവം._ഡിസം.".split("_"),monthsParseExact:!0,weekdays:"ഞായറാഴ്ച_തിങ്കളാഴ്ച_ചൊവ്വാഴ്ച_ബുധനാഴ്ച_വ്യാഴാഴ്ച_വെള്ളിയാഴ്ച_ശനിയാഴ്ച".split("_"),weekdaysShort:"ഞായർ_തിങ്കൾ_ചൊവ്വ_ബുധൻ_വ്യാഴം_വെള്ളി_ശനി".split("_"),weekdaysMin:"ഞാ_തി_ചൊ_ബു_വ്യാ_വെ_ശ".split("_"),longDateFormat:{LT:"A h:mm -നു",LTS:"A h:mm:ss -നു",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm -നു",LLLL:"dddd, D MMMM YYYY, A h:mm -നു"},calendar:{sameDay:"[ഇന്ന്] LT",nextDay:"[നാളെ] LT",nextWeek:"dddd, LT",lastDay:"[ഇന്നലെ] LT",lastWeek:"[കഴിഞ്ഞ] dddd, LT",sameElse:"L"},relativeTime:{future:"%s കഴിഞ്ഞ്",past:"%s മുൻപ്",s:"അൽപ നിമിഷങ്ങൾ",m:"ഒരു മിനിറ്റ്",mm:"%d മിനിറ്റ്",h:"ഒരു മണിക്കൂർ",hh:"%d മണിക്കൂർ",d:"ഒരു ദിവസം",dd:"%d ദിവസം",M:"ഒരു മാസം",MM:"%d മാസം",y:"ഒരു വർഷം",yy:"%d വർഷം"},meridiemParse:/രാത്രി|രാവിലെ|ഉച്ച കഴിഞ്ഞ്|വൈകുന്നേരം|രാത്രി/i,meridiemHour:function(a,b){return 12===a&&(a=0),"രാത്രി"===b&&a>=4||"ഉച്ച കഴിഞ്ഞ്"===b||"വൈകുന്നേരം"===b?a+12:a},meridiem:function(a,b,c){return a<4?"രാത്രി":a<12?"രാവിലെ":a<17?"ഉച്ച കഴിഞ്ഞ്":a<20?"വൈകുന്നേരം":"രാത്രി"}});
//! moment.js locale configuration
//! locale : Marathi [mr]
//! author : Harshad Kale : https://github.com/kalehv
//! author : Vivek Athalye : https://github.com/vnathalye
var gh={1:"१",2:"२",3:"३",4:"४",5:"५",6:"६",7:"७",8:"८",9:"९",0:"०"},hh={"१":"1","२":"2","३":"3","४":"4","५":"5","६":"6","७":"7","८":"8","९":"9","०":"0"};a.defineLocale("mr",{months:"जानेवारी_फेब्रुवारी_मार्च_एप्रिल_मे_जून_जुलै_ऑगस्ट_सप्टेंबर_ऑक्टोबर_नोव्हेंबर_डिसेंबर".split("_"),monthsShort:"जाने._फेब्रु._मार्च._एप्रि._मे._जून._जुलै._ऑग._सप्टें._ऑक्टो._नोव्हें._डिसें.".split("_"),monthsParseExact:!0,weekdays:"रविवार_सोमवार_मंगळवार_बुधवार_गुरूवार_शुक्रवार_शनिवार".split("_"),weekdaysShort:"रवि_सोम_मंगळ_बुध_गुरू_शुक्र_शनि".split("_"),weekdaysMin:"र_सो_मं_बु_गु_शु_श".split("_"),longDateFormat:{LT:"A h:mm वाजता",LTS:"A h:mm:ss वाजता",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm वाजता",LLLL:"dddd, D MMMM YYYY, A h:mm वाजता"},calendar:{sameDay:"[आज] LT",nextDay:"[उद्या] LT",nextWeek:"dddd, LT",lastDay:"[काल] LT",lastWeek:"[मागील] dddd, LT",sameElse:"L"},relativeTime:{future:"%sमध्ये",past:"%sपूर्वी",s:Vd,m:Vd,mm:Vd,h:Vd,hh:Vd,d:Vd,dd:Vd,M:Vd,MM:Vd,y:Vd,yy:Vd},preparse:function(a){return a.replace(/[१२३४५६७८९०]/g,function(a){return hh[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return gh[a]})},meridiemParse:/रात्री|सकाळी|दुपारी|सायंकाळी/,meridiemHour:function(a,b){return 12===a&&(a=0),"रात्री"===b?a<4?a:a+12:"सकाळी"===b?a:"दुपारी"===b?a>=10?a:a+12:"सायंकाळी"===b?a+12:void 0},meridiem:function(a,b,c){return a<4?"रात्री":a<10?"सकाळी":a<17?"दुपारी":a<20?"सायंकाळी":"रात्री"},week:{dow:0,// Sunday is the first day of the week.
doy:6}}),
//! moment.js locale configuration
//! locale : Malay [ms-my]
//! note : DEPRECATED, the correct one is [ms]
//! author : Weldan Jamili : https://github.com/weldan
a.defineLocale("ms-my",{months:"Januari_Februari_Mac_April_Mei_Jun_Julai_Ogos_September_Oktober_November_Disember".split("_"),monthsShort:"Jan_Feb_Mac_Apr_Mei_Jun_Jul_Ogs_Sep_Okt_Nov_Dis".split("_"),weekdays:"Ahad_Isnin_Selasa_Rabu_Khamis_Jumaat_Sabtu".split("_"),weekdaysShort:"Ahd_Isn_Sel_Rab_Kha_Jum_Sab".split("_"),weekdaysMin:"Ah_Is_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/pagi|tengahari|petang|malam/,meridiemHour:function(a,b){return 12===a&&(a=0),"pagi"===b?a:"tengahari"===b?a>=11?a:a+12:"petang"===b||"malam"===b?a+12:void 0},meridiem:function(a,b,c){return a<11?"pagi":a<15?"tengahari":a<19?"petang":"malam"},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Esok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kelmarin pukul] LT",lastWeek:"dddd [lepas pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lepas",s:"beberapa saat",m:"seminit",mm:"%d minit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Malay [ms]
//! author : Weldan Jamili : https://github.com/weldan
a.defineLocale("ms",{months:"Januari_Februari_Mac_April_Mei_Jun_Julai_Ogos_September_Oktober_November_Disember".split("_"),monthsShort:"Jan_Feb_Mac_Apr_Mei_Jun_Jul_Ogs_Sep_Okt_Nov_Dis".split("_"),weekdays:"Ahad_Isnin_Selasa_Rabu_Khamis_Jumaat_Sabtu".split("_"),weekdaysShort:"Ahd_Isn_Sel_Rab_Kha_Jum_Sab".split("_"),weekdaysMin:"Ah_Is_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/pagi|tengahari|petang|malam/,meridiemHour:function(a,b){return 12===a&&(a=0),"pagi"===b?a:"tengahari"===b?a>=11?a:a+12:"petang"===b||"malam"===b?a+12:void 0},meridiem:function(a,b,c){return a<11?"pagi":a<15?"tengahari":a<19?"petang":"malam"},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Esok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kelmarin pukul] LT",lastWeek:"dddd [lepas pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lepas",s:"beberapa saat",m:"seminit",mm:"%d minit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:1,// Monday is the first day of the week.
doy:7}});
//! moment.js locale configuration
//! locale : Burmese [my]
//! author : Squar team, mysquar.com
//! author : David Rossellat : https://github.com/gholadr
//! author : Tin Aung Lin : https://github.com/thanyawzinmin
var ih={1:"၁",2:"၂",3:"၃",4:"၄",5:"၅",6:"၆",7:"၇",8:"၈",9:"၉",0:"၀"},jh={"၁":"1","၂":"2","၃":"3","၄":"4","၅":"5","၆":"6","၇":"7","၈":"8","၉":"9","၀":"0"};a.defineLocale("my",{months:"ဇန်နဝါရီ_ဖေဖော်ဝါရီ_မတ်_ဧပြီ_မေ_ဇွန်_ဇူလိုင်_သြဂုတ်_စက်တင်ဘာ_အောက်တိုဘာ_နိုဝင်ဘာ_ဒီဇင်ဘာ".split("_"),monthsShort:"ဇန်_ဖေ_မတ်_ပြီ_မေ_ဇွန်_လိုင်_သြ_စက်_အောက်_နို_ဒီ".split("_"),weekdays:"တနင်္ဂနွေ_တနင်္လာ_အင်္ဂါ_ဗုဒ္ဓဟူး_ကြာသပတေး_သောကြာ_စနေ".split("_"),weekdaysShort:"နွေ_လာ_ဂါ_ဟူး_ကြာ_သော_နေ".split("_"),weekdaysMin:"နွေ_လာ_ဂါ_ဟူး_ကြာ_သော_နေ".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[ယနေ.] LT [မှာ]",nextDay:"[မနက်ဖြန်] LT [မှာ]",nextWeek:"dddd LT [မှာ]",lastDay:"[မနေ.က] LT [မှာ]",lastWeek:"[ပြီးခဲ့သော] dddd LT [မှာ]",sameElse:"L"},relativeTime:{future:"လာမည့် %s မှာ",past:"လွန်ခဲ့သော %s က",s:"စက္ကန်.အနည်းငယ်",m:"တစ်မိနစ်",mm:"%d မိနစ်",h:"တစ်နာရီ",hh:"%d နာရီ",d:"တစ်ရက်",dd:"%d ရက်",M:"တစ်လ",MM:"%d လ",y:"တစ်နှစ်",yy:"%d နှစ်"},preparse:function(a){return a.replace(/[၁၂၃၄၅၆၇၈၉၀]/g,function(a){return jh[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return ih[a]})},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Norwegian Bokmål [nb]
//! authors : Espen Hovlandsdal : https://github.com/rexxars
//!           Sigurd Gartmann : https://github.com/sigurdga
a.defineLocale("nb",{months:"januar_februar_mars_april_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan._feb._mars_april_mai_juni_juli_aug._sep._okt._nov._des.".split("_"),monthsParseExact:!0,weekdays:"søndag_mandag_tirsdag_onsdag_torsdag_fredag_lørdag".split("_"),weekdaysShort:"sø._ma._ti._on._to._fr._lø.".split("_"),weekdaysMin:"sø_ma_ti_on_to_fr_lø".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] HH:mm",LLLL:"dddd D. MMMM YYYY [kl.] HH:mm"},calendar:{sameDay:"[i dag kl.] LT",nextDay:"[i morgen kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[i går kl.] LT",lastWeek:"[forrige] dddd [kl.] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"%s siden",s:"noen sekunder",m:"ett minutt",mm:"%d minutter",h:"en time",hh:"%d timer",d:"en dag",dd:"%d dager",M:"en måned",MM:"%d måneder",y:"ett år",yy:"%d år"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Nepalese [ne]
//! author : suvash : https://github.com/suvash
var kh={1:"१",2:"२",3:"३",4:"४",5:"५",6:"६",7:"७",8:"८",9:"९",0:"०"},lh={"१":"1","२":"2","३":"3","४":"4","५":"5","६":"6","७":"7","८":"8","९":"9","०":"0"};a.defineLocale("ne",{months:"जनवरी_फेब्रुवरी_मार्च_अप्रिल_मई_जुन_जुलाई_अगष्ट_सेप्टेम्बर_अक्टोबर_नोभेम्बर_डिसेम्बर".split("_"),monthsShort:"जन._फेब्रु._मार्च_अप्रि._मई_जुन_जुलाई._अग._सेप्ट._अक्टो._नोभे._डिसे.".split("_"),monthsParseExact:!0,weekdays:"आइतबार_सोमबार_मङ्गलबार_बुधबार_बिहिबार_शुक्रबार_शनिबार".split("_"),weekdaysShort:"आइत._सोम._मङ्गल._बुध._बिहि._शुक्र._शनि.".split("_"),weekdaysMin:"आ._सो._मं._बु._बि._शु._श.".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"Aको h:mm बजे",LTS:"Aको h:mm:ss बजे",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, Aको h:mm बजे",LLLL:"dddd, D MMMM YYYY, Aको h:mm बजे"},preparse:function(a){return a.replace(/[१२३४५६७८९०]/g,function(a){return lh[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return kh[a]})},meridiemParse:/राति|बिहान|दिउँसो|साँझ/,meridiemHour:function(a,b){return 12===a&&(a=0),"राति"===b?a<4?a:a+12:"बिहान"===b?a:"दिउँसो"===b?a>=10?a:a+12:"साँझ"===b?a+12:void 0},meridiem:function(a,b,c){return a<3?"राति":a<12?"बिहान":a<16?"दिउँसो":a<20?"साँझ":"राति"},calendar:{sameDay:"[आज] LT",nextDay:"[भोलि] LT",nextWeek:"[आउँदो] dddd[,] LT",lastDay:"[हिजो] LT",lastWeek:"[गएको] dddd[,] LT",sameElse:"L"},relativeTime:{future:"%sमा",past:"%s अगाडि",s:"केही क्षण",m:"एक मिनेट",mm:"%d मिनेट",h:"एक घण्टा",hh:"%d घण्टा",d:"एक दिन",dd:"%d दिन",M:"एक महिना",MM:"%d महिना",y:"एक बर्ष",yy:"%d बर्ष"},week:{dow:0,// Sunday is the first day of the week.
doy:6}});
//! moment.js locale configuration
//! locale : Dutch (Belgium) [nl-be]
//! author : Joris Röling : https://github.com/jorisroling
//! author : Jacob Middag : https://github.com/middagj
var mh="jan._feb._mrt._apr._mei_jun._jul._aug._sep._okt._nov._dec.".split("_"),nh="jan_feb_mrt_apr_mei_jun_jul_aug_sep_okt_nov_dec".split("_"),oh=[/^jan/i,/^feb/i,/^maart|mrt.?$/i,/^apr/i,/^mei$/i,/^jun[i.]?$/i,/^jul[i.]?$/i,/^aug/i,/^sep/i,/^okt/i,/^nov/i,/^dec/i],ph=/^(januari|februari|maart|april|mei|april|ju[nl]i|augustus|september|oktober|november|december|jan\.?|feb\.?|mrt\.?|apr\.?|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i;a.defineLocale("nl-be",{months:"januari_februari_maart_april_mei_juni_juli_augustus_september_oktober_november_december".split("_"),monthsShort:function(a,b){return/-MMM-/.test(b)?nh[a.month()]:mh[a.month()]},monthsRegex:ph,monthsShortRegex:ph,monthsStrictRegex:/^(januari|februari|maart|mei|ju[nl]i|april|augustus|september|oktober|november|december)/i,monthsShortStrictRegex:/^(jan\.?|feb\.?|mrt\.?|apr\.?|mei|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i,monthsParse:oh,longMonthsParse:oh,shortMonthsParse:oh,weekdays:"zondag_maandag_dinsdag_woensdag_donderdag_vrijdag_zaterdag".split("_"),weekdaysShort:"zo._ma._di._wo._do._vr._za.".split("_"),weekdaysMin:"Zo_Ma_Di_Wo_Do_Vr_Za".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[vandaag om] LT",nextDay:"[morgen om] LT",nextWeek:"dddd [om] LT",lastDay:"[gisteren om] LT",lastWeek:"[afgelopen] dddd [om] LT",sameElse:"L"},relativeTime:{future:"over %s",past:"%s geleden",s:"een paar seconden",m:"één minuut",mm:"%d minuten",h:"één uur",hh:"%d uur",d:"één dag",dd:"%d dagen",M:"één maand",MM:"%d maanden",y:"één jaar",yy:"%d jaar"},ordinalParse:/\d{1,2}(ste|de)/,ordinal:function(a){return a+(1===a||8===a||a>=20?"ste":"de")},week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Dutch [nl]
//! author : Joris Röling : https://github.com/jorisroling
//! author : Jacob Middag : https://github.com/middagj
var qh="jan._feb._mrt._apr._mei_jun._jul._aug._sep._okt._nov._dec.".split("_"),rh="jan_feb_mrt_apr_mei_jun_jul_aug_sep_okt_nov_dec".split("_"),sh=[/^jan/i,/^feb/i,/^maart|mrt.?$/i,/^apr/i,/^mei$/i,/^jun[i.]?$/i,/^jul[i.]?$/i,/^aug/i,/^sep/i,/^okt/i,/^nov/i,/^dec/i],th=/^(januari|februari|maart|april|mei|april|ju[nl]i|augustus|september|oktober|november|december|jan\.?|feb\.?|mrt\.?|apr\.?|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i;a.defineLocale("nl",{months:"januari_februari_maart_april_mei_juni_juli_augustus_september_oktober_november_december".split("_"),monthsShort:function(a,b){return/-MMM-/.test(b)?rh[a.month()]:qh[a.month()]},monthsRegex:th,monthsShortRegex:th,monthsStrictRegex:/^(januari|februari|maart|mei|ju[nl]i|april|augustus|september|oktober|november|december)/i,monthsShortStrictRegex:/^(jan\.?|feb\.?|mrt\.?|apr\.?|mei|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i,monthsParse:sh,longMonthsParse:sh,shortMonthsParse:sh,weekdays:"zondag_maandag_dinsdag_woensdag_donderdag_vrijdag_zaterdag".split("_"),weekdaysShort:"zo._ma._di._wo._do._vr._za.".split("_"),weekdaysMin:"Zo_Ma_Di_Wo_Do_Vr_Za".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[vandaag om] LT",nextDay:"[morgen om] LT",nextWeek:"dddd [om] LT",lastDay:"[gisteren om] LT",lastWeek:"[afgelopen] dddd [om] LT",sameElse:"L"},relativeTime:{future:"over %s",past:"%s geleden",s:"een paar seconden",m:"één minuut",mm:"%d minuten",h:"één uur",hh:"%d uur",d:"één dag",dd:"%d dagen",M:"één maand",MM:"%d maanden",y:"één jaar",yy:"%d jaar"},ordinalParse:/\d{1,2}(ste|de)/,ordinal:function(a){return a+(1===a||8===a||a>=20?"ste":"de")},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Nynorsk [nn]
//! author : https://github.com/mechuwind
a.defineLocale("nn",{months:"januar_februar_mars_april_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan_feb_mar_apr_mai_jun_jul_aug_sep_okt_nov_des".split("_"),weekdays:"sundag_måndag_tysdag_onsdag_torsdag_fredag_laurdag".split("_"),weekdaysShort:"sun_mån_tys_ons_tor_fre_lau".split("_"),weekdaysMin:"su_må_ty_on_to_fr_lø".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] H:mm",LLLL:"dddd D. MMMM YYYY [kl.] HH:mm"},calendar:{sameDay:"[I dag klokka] LT",nextDay:"[I morgon klokka] LT",nextWeek:"dddd [klokka] LT",lastDay:"[I går klokka] LT",lastWeek:"[Føregåande] dddd [klokka] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"%s sidan",s:"nokre sekund",m:"eit minutt",mm:"%d minutt",h:"ein time",hh:"%d timar",d:"ein dag",dd:"%d dagar",M:"ein månad",MM:"%d månader",y:"eit år",yy:"%d år"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Punjabi (India) [pa-in]
//! author : Harpreet Singh : https://github.com/harpreetkhalsagtbit
var uh={1:"੧",2:"੨",3:"੩",4:"੪",5:"੫",6:"੬",7:"੭",8:"੮",9:"੯",0:"੦"},vh={"੧":"1","੨":"2","੩":"3","੪":"4","੫":"5","੬":"6","੭":"7","੮":"8","੯":"9","੦":"0"};a.defineLocale("pa-in",{
// There are months name as per Nanakshahi Calender but they are not used as rigidly in modern Punjabi.
months:"ਜਨਵਰੀ_ਫ਼ਰਵਰੀ_ਮਾਰਚ_ਅਪ੍ਰੈਲ_ਮਈ_ਜੂਨ_ਜੁਲਾਈ_ਅਗਸਤ_ਸਤੰਬਰ_ਅਕਤੂਬਰ_ਨਵੰਬਰ_ਦਸੰਬਰ".split("_"),monthsShort:"ਜਨਵਰੀ_ਫ਼ਰਵਰੀ_ਮਾਰਚ_ਅਪ੍ਰੈਲ_ਮਈ_ਜੂਨ_ਜੁਲਾਈ_ਅਗਸਤ_ਸਤੰਬਰ_ਅਕਤੂਬਰ_ਨਵੰਬਰ_ਦਸੰਬਰ".split("_"),weekdays:"ਐਤਵਾਰ_ਸੋਮਵਾਰ_ਮੰਗਲਵਾਰ_ਬੁਧਵਾਰ_ਵੀਰਵਾਰ_ਸ਼ੁੱਕਰਵਾਰ_ਸ਼ਨੀਚਰਵਾਰ".split("_"),weekdaysShort:"ਐਤ_ਸੋਮ_ਮੰਗਲ_ਬੁਧ_ਵੀਰ_ਸ਼ੁਕਰ_ਸ਼ਨੀ".split("_"),weekdaysMin:"ਐਤ_ਸੋਮ_ਮੰਗਲ_ਬੁਧ_ਵੀਰ_ਸ਼ੁਕਰ_ਸ਼ਨੀ".split("_"),longDateFormat:{LT:"A h:mm ਵਜੇ",LTS:"A h:mm:ss ਵਜੇ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ਵਜੇ",LLLL:"dddd, D MMMM YYYY, A h:mm ਵਜੇ"},calendar:{sameDay:"[ਅਜ] LT",nextDay:"[ਕਲ] LT",nextWeek:"dddd, LT",lastDay:"[ਕਲ] LT",lastWeek:"[ਪਿਛਲੇ] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ਵਿੱਚ",past:"%s ਪਿਛਲੇ",s:"ਕੁਝ ਸਕਿੰਟ",m:"ਇਕ ਮਿੰਟ",mm:"%d ਮਿੰਟ",h:"ਇੱਕ ਘੰਟਾ",hh:"%d ਘੰਟੇ",d:"ਇੱਕ ਦਿਨ",dd:"%d ਦਿਨ",M:"ਇੱਕ ਮਹੀਨਾ",MM:"%d ਮਹੀਨੇ",y:"ਇੱਕ ਸਾਲ",yy:"%d ਸਾਲ"},preparse:function(a){return a.replace(/[੧੨੩੪੫੬੭੮੯੦]/g,function(a){return vh[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return uh[a]})},
// Punjabi notation for meridiems are quite fuzzy in practice. While there exists
// a rigid notion of a 'Pahar' it is not used as rigidly in modern Punjabi.
meridiemParse:/ਰਾਤ|ਸਵੇਰ|ਦੁਪਹਿਰ|ਸ਼ਾਮ/,meridiemHour:function(a,b){return 12===a&&(a=0),"ਰਾਤ"===b?a<4?a:a+12:"ਸਵੇਰ"===b?a:"ਦੁਪਹਿਰ"===b?a>=10?a:a+12:"ਸ਼ਾਮ"===b?a+12:void 0},meridiem:function(a,b,c){return a<4?"ਰਾਤ":a<10?"ਸਵੇਰ":a<17?"ਦੁਪਹਿਰ":a<20?"ਸ਼ਾਮ":"ਰਾਤ"},week:{dow:0,// Sunday is the first day of the week.
doy:6}});
//! moment.js locale configuration
//! locale : Polish [pl]
//! author : Rafal Hirsz : https://github.com/evoL
var wh="styczeń_luty_marzec_kwiecień_maj_czerwiec_lipiec_sierpień_wrzesień_październik_listopad_grudzień".split("_"),xh="stycznia_lutego_marca_kwietnia_maja_czerwca_lipca_sierpnia_września_października_listopada_grudnia".split("_");a.defineLocale("pl",{months:function(a,b){return""===b?"("+xh[a.month()]+"|"+wh[a.month()]+")":/D MMMM/.test(b)?xh[a.month()]:wh[a.month()]},monthsShort:"sty_lut_mar_kwi_maj_cze_lip_sie_wrz_paź_lis_gru".split("_"),weekdays:"niedziela_poniedziałek_wtorek_środa_czwartek_piątek_sobota".split("_"),weekdaysShort:"ndz_pon_wt_śr_czw_pt_sob".split("_"),weekdaysMin:"Nd_Pn_Wt_Śr_Cz_Pt_So".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Dziś o] LT",nextDay:"[Jutro o] LT",nextWeek:"[W] dddd [o] LT",lastDay:"[Wczoraj o] LT",lastWeek:function(){switch(this.day()){case 0:return"[W zeszłą niedzielę o] LT";case 3:return"[W zeszłą środę o] LT";case 6:return"[W zeszłą sobotę o] LT";default:return"[W zeszły] dddd [o] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"%s temu",s:"kilka sekund",m:Xd,mm:Xd,h:Xd,hh:Xd,d:"1 dzień",dd:"%d dni",M:"miesiąc",MM:Xd,y:"rok",yy:Xd},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Portuguese (Brazil) [pt-br]
//! author : Caio Ribeiro Pereira : https://github.com/caio-ribeiro-pereira
a.defineLocale("pt-br",{months:"Janeiro_Fevereiro_Março_Abril_Maio_Junho_Julho_Agosto_Setembro_Outubro_Novembro_Dezembro".split("_"),monthsShort:"Jan_Fev_Mar_Abr_Mai_Jun_Jul_Ago_Set_Out_Nov_Dez".split("_"),weekdays:"Domingo_Segunda-feira_Terça-feira_Quarta-feira_Quinta-feira_Sexta-feira_Sábado".split("_"),weekdaysShort:"Dom_Seg_Ter_Qua_Qui_Sex_Sáb".split("_"),weekdaysMin:"Dom_2ª_3ª_4ª_5ª_6ª_Sáb".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY [às] HH:mm",LLLL:"dddd, D [de] MMMM [de] YYYY [às] HH:mm"},calendar:{sameDay:"[Hoje às] LT",nextDay:"[Amanhã às] LT",nextWeek:"dddd [às] LT",lastDay:"[Ontem às] LT",lastWeek:function(){// Saturday + Sunday
return 0===this.day()||6===this.day()?"[Último] dddd [às] LT":"[Última] dddd [às] LT"},sameElse:"L"},relativeTime:{future:"em %s",past:"%s atrás",s:"poucos segundos",m:"um minuto",mm:"%d minutos",h:"uma hora",hh:"%d horas",d:"um dia",dd:"%d dias",M:"um mês",MM:"%d meses",y:"um ano",yy:"%d anos"},ordinalParse:/\d{1,2}º/,ordinal:"%dº"}),
//! moment.js locale configuration
//! locale : Portuguese [pt]
//! author : Jefferson : https://github.com/jalex79
a.defineLocale("pt",{months:"Janeiro_Fevereiro_Março_Abril_Maio_Junho_Julho_Agosto_Setembro_Outubro_Novembro_Dezembro".split("_"),monthsShort:"Jan_Fev_Mar_Abr_Mai_Jun_Jul_Ago_Set_Out_Nov_Dez".split("_"),weekdays:"Domingo_Segunda-Feira_Terça-Feira_Quarta-Feira_Quinta-Feira_Sexta-Feira_Sábado".split("_"),weekdaysShort:"Dom_Seg_Ter_Qua_Qui_Sex_Sáb".split("_"),weekdaysMin:"Dom_2ª_3ª_4ª_5ª_6ª_Sáb".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY HH:mm",LLLL:"dddd, D [de] MMMM [de] YYYY HH:mm"},calendar:{sameDay:"[Hoje às] LT",nextDay:"[Amanhã às] LT",nextWeek:"dddd [às] LT",lastDay:"[Ontem às] LT",lastWeek:function(){// Saturday + Sunday
return 0===this.day()||6===this.day()?"[Último] dddd [às] LT":"[Última] dddd [às] LT"},sameElse:"L"},relativeTime:{future:"em %s",past:"há %s",s:"segundos",m:"um minuto",mm:"%d minutos",h:"uma hora",hh:"%d horas",d:"um dia",dd:"%d dias",M:"um mês",MM:"%d meses",y:"um ano",yy:"%d anos"},ordinalParse:/\d{1,2}º/,ordinal:"%dº",week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("ro",{months:"ianuarie_februarie_martie_aprilie_mai_iunie_iulie_august_septembrie_octombrie_noiembrie_decembrie".split("_"),monthsShort:"ian._febr._mart._apr._mai_iun._iul._aug._sept._oct._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"duminică_luni_marți_miercuri_joi_vineri_sâmbătă".split("_"),weekdaysShort:"Dum_Lun_Mar_Mie_Joi_Vin_Sâm".split("_"),weekdaysMin:"Du_Lu_Ma_Mi_Jo_Vi_Sâ".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd, D MMMM YYYY H:mm"},calendar:{sameDay:"[azi la] LT",nextDay:"[mâine la] LT",nextWeek:"dddd [la] LT",lastDay:"[ieri la] LT",lastWeek:"[fosta] dddd [la] LT",sameElse:"L"},relativeTime:{future:"peste %s",past:"%s în urmă",s:"câteva secunde",m:"un minut",mm:Yd,h:"o oră",hh:Yd,d:"o zi",dd:Yd,M:"o lună",MM:Yd,y:"un an",yy:Yd},week:{dow:1,// Monday is the first day of the week.
doy:7}});var yh=[/^янв/i,/^фев/i,/^мар/i,/^апр/i,/^ма[йя]/i,/^июн/i,/^июл/i,/^авг/i,/^сен/i,/^окт/i,/^ноя/i,/^дек/i];
// http://new.gramota.ru/spravka/rules/139-prop : § 103
// Сокращения месяцев: http://new.gramota.ru/spravka/buro/search-answer?s=242637
// CLDR data:          http://www.unicode.org/cldr/charts/28/summary/ru.html#1753
a.defineLocale("ru",{months:{format:"января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря".split("_"),standalone:"январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь".split("_")},monthsShort:{
// по CLDR именно "июл." и "июн.", но какой смысл менять букву на точку ?
format:"янв._февр._мар._апр._мая_июня_июля_авг._сент._окт._нояб._дек.".split("_"),standalone:"янв._февр._март_апр._май_июнь_июль_авг._сент._окт._нояб._дек.".split("_")},weekdays:{standalone:"воскресенье_понедельник_вторник_среда_четверг_пятница_суббота".split("_"),format:"воскресенье_понедельник_вторник_среду_четверг_пятницу_субботу".split("_"),isFormat:/\[ ?[Вв] ?(?:прошлую|следующую|эту)? ?\] ?dddd/},weekdaysShort:"вс_пн_вт_ср_чт_пт_сб".split("_"),weekdaysMin:"вс_пн_вт_ср_чт_пт_сб".split("_"),monthsParse:yh,longMonthsParse:yh,shortMonthsParse:yh,
// полные названия с падежами, по три буквы, для некоторых, по 4 буквы, сокращения с точкой и без точки
monthsRegex:/^(январ[ья]|янв\.?|феврал[ья]|февр?\.?|марта?|мар\.?|апрел[ья]|апр\.?|ма[йя]|июн[ья]|июн\.?|июл[ья]|июл\.?|августа?|авг\.?|сентябр[ья]|сент?\.?|октябр[ья]|окт\.?|ноябр[ья]|нояб?\.?|декабр[ья]|дек\.?)/i,
// копия предыдущего
monthsShortRegex:/^(январ[ья]|янв\.?|феврал[ья]|февр?\.?|марта?|мар\.?|апрел[ья]|апр\.?|ма[йя]|июн[ья]|июн\.?|июл[ья]|июл\.?|августа?|авг\.?|сентябр[ья]|сент?\.?|октябр[ья]|окт\.?|ноябр[ья]|нояб?\.?|декабр[ья]|дек\.?)/i,
// полные названия с падежами
monthsStrictRegex:/^(январ[яь]|феврал[яь]|марта?|апрел[яь]|ма[яй]|июн[яь]|июл[яь]|августа?|сентябр[яь]|октябр[яь]|ноябр[яь]|декабр[яь])/i,
// Выражение, которое соотвествует только сокращённым формам
monthsShortStrictRegex:/^(янв\.|февр?\.|мар[т.]|апр\.|ма[яй]|июн[ья.]|июл[ья.]|авг\.|сент?\.|окт\.|нояб?\.|дек\.)/i,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY г.",LLL:"D MMMM YYYY г., HH:mm",LLLL:"dddd, D MMMM YYYY г., HH:mm"},calendar:{sameDay:"[Сегодня в] LT",nextDay:"[Завтра в] LT",lastDay:"[Вчера в] LT",nextWeek:function(a){if(a.week()===this.week())return 2===this.day()?"[Во] dddd [в] LT":"[В] dddd [в] LT";switch(this.day()){case 0:return"[В следующее] dddd [в] LT";case 1:case 2:case 4:return"[В следующий] dddd [в] LT";case 3:case 5:case 6:return"[В следующую] dddd [в] LT"}},lastWeek:function(a){if(a.week()===this.week())return 2===this.day()?"[Во] dddd [в] LT":"[В] dddd [в] LT";switch(this.day()){case 0:return"[В прошлое] dddd [в] LT";case 1:case 2:case 4:return"[В прошлый] dddd [в] LT";case 3:case 5:case 6:return"[В прошлую] dddd [в] LT"}},sameElse:"L"},relativeTime:{future:"через %s",past:"%s назад",s:"несколько секунд",m:$d,mm:$d,h:"час",hh:$d,d:"день",dd:$d,M:"месяц",MM:$d,y:"год",yy:$d},meridiemParse:/ночи|утра|дня|вечера/i,isPM:function(a){return/^(дня|вечера)$/.test(a)},meridiem:function(a,b,c){return a<4?"ночи":a<12?"утра":a<17?"дня":"вечера"},ordinalParse:/\d{1,2}-(й|го|я)/,ordinal:function(a,b){switch(b){case"M":case"d":case"DDD":return a+"-й";case"D":return a+"-го";case"w":case"W":return a+"-я";default:return a}},week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Northern Sami [se]
//! authors : Bård Rolstad Henriksen : https://github.com/karamell
a.defineLocale("se",{months:"ođđajagemánnu_guovvamánnu_njukčamánnu_cuoŋománnu_miessemánnu_geassemánnu_suoidnemánnu_borgemánnu_čakčamánnu_golggotmánnu_skábmamánnu_juovlamánnu".split("_"),monthsShort:"ođđj_guov_njuk_cuo_mies_geas_suoi_borg_čakč_golg_skáb_juov".split("_"),weekdays:"sotnabeaivi_vuossárga_maŋŋebárga_gaskavahkku_duorastat_bearjadat_lávvardat".split("_"),weekdaysShort:"sotn_vuos_maŋ_gask_duor_bear_láv".split("_"),weekdaysMin:"s_v_m_g_d_b_L".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"MMMM D. [b.] YYYY",LLL:"MMMM D. [b.] YYYY [ti.] HH:mm",LLLL:"dddd, MMMM D. [b.] YYYY [ti.] HH:mm"},calendar:{sameDay:"[otne ti] LT",nextDay:"[ihttin ti] LT",nextWeek:"dddd [ti] LT",lastDay:"[ikte ti] LT",lastWeek:"[ovddit] dddd [ti] LT",sameElse:"L"},relativeTime:{future:"%s geažes",past:"maŋit %s",s:"moadde sekunddat",m:"okta minuhta",mm:"%d minuhtat",h:"okta diimmu",hh:"%d diimmut",d:"okta beaivi",dd:"%d beaivvit",M:"okta mánnu",MM:"%d mánut",y:"okta jahki",yy:"%d jagit"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Sinhalese [si]
//! author : Sampath Sitinamaluwa : https://github.com/sampathsris
/*jshint -W100*/
a.defineLocale("si",{months:"ජනවාරි_පෙබරවාරි_මාර්තු_අප්‍රේල්_මැයි_ජූනි_ජූලි_අගෝස්තු_සැප්තැම්බර්_ඔක්තෝබර්_නොවැම්බර්_දෙසැම්බර්".split("_"),monthsShort:"ජන_පෙබ_මාර්_අප්_මැයි_ජූනි_ජූලි_අගෝ_සැප්_ඔක්_නොවැ_දෙසැ".split("_"),weekdays:"ඉරිදා_සඳුදා_අඟහරුවාදා_බදාදා_බ්‍රහස්පතින්දා_සිකුරාදා_සෙනසුරාදා".split("_"),weekdaysShort:"ඉරි_සඳු_අඟ_බදා_බ්‍රහ_සිකු_සෙන".split("_"),weekdaysMin:"ඉ_ස_අ_බ_බ්‍ර_සි_සෙ".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"a h:mm",LTS:"a h:mm:ss",L:"YYYY/MM/DD",LL:"YYYY MMMM D",LLL:"YYYY MMMM D, a h:mm",LLLL:"YYYY MMMM D [වැනි] dddd, a h:mm:ss"},calendar:{sameDay:"[අද] LT[ට]",nextDay:"[හෙට] LT[ට]",nextWeek:"dddd LT[ට]",lastDay:"[ඊයේ] LT[ට]",lastWeek:"[පසුගිය] dddd LT[ට]",sameElse:"L"},relativeTime:{future:"%sකින්",past:"%sකට පෙර",s:"තත්පර කිහිපය",m:"මිනිත්තුව",mm:"මිනිත්තු %d",h:"පැය",hh:"පැය %d",d:"දිනය",dd:"දින %d",M:"මාසය",MM:"මාස %d",y:"වසර",yy:"වසර %d"},ordinalParse:/\d{1,2} වැනි/,ordinal:function(a){return a+" වැනි"},meridiemParse:/පෙර වරු|පස් වරු|පෙ.ව|ප.ව./,isPM:function(a){return"ප.ව."===a||"පස් වරු"===a},meridiem:function(a,b,c){return a>11?c?"ප.ව.":"පස් වරු":c?"පෙ.ව.":"පෙර වරු"}});
//! moment.js locale configuration
//! locale : Slovak [sk]
//! author : Martin Minka : https://github.com/k2s
//! based on work of petrbela : https://github.com/petrbela
var zh="január_február_marec_apríl_máj_jún_júl_august_september_október_november_december".split("_"),Ah="jan_feb_mar_apr_máj_jún_júl_aug_sep_okt_nov_dec".split("_");a.defineLocale("sk",{months:zh,monthsShort:Ah,weekdays:"nedeľa_pondelok_utorok_streda_štvrtok_piatok_sobota".split("_"),weekdaysShort:"ne_po_ut_st_št_pi_so".split("_"),weekdaysMin:"ne_po_ut_st_št_pi_so".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd D. MMMM YYYY H:mm"},calendar:{sameDay:"[dnes o] LT",nextDay:"[zajtra o] LT",nextWeek:function(){switch(this.day()){case 0:return"[v nedeľu o] LT";case 1:case 2:return"[v] dddd [o] LT";case 3:return"[v stredu o] LT";case 4:return"[vo štvrtok o] LT";case 5:return"[v piatok o] LT";case 6:return"[v sobotu o] LT"}},lastDay:"[včera o] LT",lastWeek:function(){switch(this.day()){case 0:return"[minulú nedeľu o] LT";case 1:case 2:return"[minulý] dddd [o] LT";case 3:return"[minulú stredu o] LT";case 4:case 5:return"[minulý] dddd [o] LT";case 6:return"[minulú sobotu o] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"pred %s",s:ae,m:ae,mm:ae,h:ae,hh:ae,d:ae,dd:ae,M:ae,MM:ae,y:ae,yy:ae},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("sl",{months:"januar_februar_marec_april_maj_junij_julij_avgust_september_oktober_november_december".split("_"),monthsShort:"jan._feb._mar._apr._maj._jun._jul._avg._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedelja_ponedeljek_torek_sreda_četrtek_petek_sobota".split("_"),weekdaysShort:"ned._pon._tor._sre._čet._pet._sob.".split("_"),weekdaysMin:"ne_po_to_sr_če_pe_so".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danes ob] LT",nextDay:"[jutri ob] LT",nextWeek:function(){switch(this.day()){case 0:return"[v] [nedeljo] [ob] LT";case 3:return"[v] [sredo] [ob] LT";case 6:return"[v] [soboto] [ob] LT";case 1:case 2:case 4:case 5:return"[v] dddd [ob] LT"}},lastDay:"[včeraj ob] LT",lastWeek:function(){switch(this.day()){case 0:return"[prejšnjo] [nedeljo] [ob] LT";case 3:return"[prejšnjo] [sredo] [ob] LT";case 6:return"[prejšnjo] [soboto] [ob] LT";case 1:case 2:case 4:case 5:return"[prejšnji] dddd [ob] LT"}},sameElse:"L"},relativeTime:{future:"čez %s",past:"pred %s",s:be,m:be,mm:be,h:be,hh:be,d:be,dd:be,M:be,MM:be,y:be,yy:be},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : Albanian [sq]
//! author : Flakërim Ismani : https://github.com/flakerimi
//! author : Menelion Elensúle : https://github.com/Oire
//! author : Oerd Cukalla : https://github.com/oerd
a.defineLocale("sq",{months:"Janar_Shkurt_Mars_Prill_Maj_Qershor_Korrik_Gusht_Shtator_Tetor_Nëntor_Dhjetor".split("_"),monthsShort:"Jan_Shk_Mar_Pri_Maj_Qer_Kor_Gus_Sht_Tet_Nën_Dhj".split("_"),weekdays:"E Diel_E Hënë_E Martë_E Mërkurë_E Enjte_E Premte_E Shtunë".split("_"),weekdaysShort:"Die_Hën_Mar_Mër_Enj_Pre_Sht".split("_"),weekdaysMin:"D_H_Ma_Më_E_P_Sh".split("_"),weekdaysParseExact:!0,meridiemParse:/PD|MD/,isPM:function(a){return"M"===a.charAt(0)},meridiem:function(a,b,c){return a<12?"PD":"MD"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Sot në] LT",nextDay:"[Nesër në] LT",nextWeek:"dddd [në] LT",lastDay:"[Dje në] LT",lastWeek:"dddd [e kaluar në] LT",sameElse:"L"},relativeTime:{future:"në %s",past:"%s më parë",s:"disa sekonda",m:"një minutë",mm:"%d minuta",h:"një orë",hh:"%d orë",d:"një ditë",dd:"%d ditë",M:"një muaj",MM:"%d muaj",y:"një vit",yy:"%d vite"},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Serbian Cyrillic [sr-cyrl]
//! author : Milan Janačković<milanjanackovic@gmail.com> : https://github.com/milan-j
var Bh={words:{//Different grammatical cases
m:["један минут","једне минуте"],mm:["минут","минуте","минута"],h:["један сат","једног сата"],hh:["сат","сата","сати"],dd:["дан","дана","дана"],MM:["месец","месеца","месеци"],yy:["година","године","година"]},correctGrammaticalCase:function(a,b){return 1===a?b[0]:a>=2&&a<=4?b[1]:b[2]},translate:function(a,b,c){var d=Bh.words[c];return 1===c.length?b?d[0]:d[1]:a+" "+Bh.correctGrammaticalCase(a,d)}};a.defineLocale("sr-cyrl",{months:"јануар_фебруар_март_април_мај_јун_јул_август_септембар_октобар_новембар_децембар".split("_"),monthsShort:"јан._феб._мар._апр._мај_јун_јул_авг._сеп._окт._нов._дец.".split("_"),monthsParseExact:!0,weekdays:"недеља_понедељак_уторак_среда_четвртак_петак_субота".split("_"),weekdaysShort:"нед._пон._уто._сре._чет._пет._суб.".split("_"),weekdaysMin:"не_по_ут_ср_че_пе_су".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[данас у] LT",nextDay:"[сутра у] LT",nextWeek:function(){switch(this.day()){case 0:return"[у] [недељу] [у] LT";case 3:return"[у] [среду] [у] LT";case 6:return"[у] [суботу] [у] LT";case 1:case 2:case 4:case 5:return"[у] dddd [у] LT"}},lastDay:"[јуче у] LT",lastWeek:function(){var a=["[прошле] [недеље] [у] LT","[прошлог] [понедељка] [у] LT","[прошлог] [уторка] [у] LT","[прошле] [среде] [у] LT","[прошлог] [четвртка] [у] LT","[прошлог] [петка] [у] LT","[прошле] [суботе] [у] LT"];return a[this.day()]},sameElse:"L"},relativeTime:{future:"за %s",past:"пре %s",s:"неколико секунди",m:Bh.translate,mm:Bh.translate,h:Bh.translate,hh:Bh.translate,d:"дан",dd:Bh.translate,M:"месец",MM:Bh.translate,y:"годину",yy:Bh.translate},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:7}});
//! moment.js locale configuration
//! locale : Serbian [sr]
//! author : Milan Janačković<milanjanackovic@gmail.com> : https://github.com/milan-j
var Ch={words:{//Different grammatical cases
m:["jedan minut","jedne minute"],mm:["minut","minute","minuta"],h:["jedan sat","jednog sata"],hh:["sat","sata","sati"],dd:["dan","dana","dana"],MM:["mesec","meseca","meseci"],yy:["godina","godine","godina"]},correctGrammaticalCase:function(a,b){return 1===a?b[0]:a>=2&&a<=4?b[1]:b[2]},translate:function(a,b,c){var d=Ch.words[c];return 1===c.length?b?d[0]:d[1]:a+" "+Ch.correctGrammaticalCase(a,d)}};a.defineLocale("sr",{months:"januar_februar_mart_april_maj_jun_jul_avgust_septembar_oktobar_novembar_decembar".split("_"),monthsShort:"jan._feb._mar._apr._maj_jun_jul_avg._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedelja_ponedeljak_utorak_sreda_četvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sre._čet._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_če_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedelju] [u] LT";case 3:return"[u] [sredu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[juče u] LT",lastWeek:function(){var a=["[prošle] [nedelje] [u] LT","[prošlog] [ponedeljka] [u] LT","[prošlog] [utorka] [u] LT","[prošle] [srede] [u] LT","[prošlog] [četvrtka] [u] LT","[prošlog] [petka] [u] LT","[prošle] [subote] [u] LT"];return a[this.day()]},sameElse:"L"},relativeTime:{future:"za %s",past:"pre %s",s:"nekoliko sekundi",m:Ch.translate,mm:Ch.translate,h:Ch.translate,hh:Ch.translate,d:"dan",dd:Ch.translate,M:"mesec",MM:Ch.translate,y:"godinu",yy:Ch.translate},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:7}}),
//! moment.js locale configuration
//! locale : siSwati [ss]
//! author : Nicolai Davies<mail@nicolai.io> : https://github.com/nicolaidavies
a.defineLocale("ss",{months:"Bhimbidvwane_Indlovana_Indlov'lenkhulu_Mabasa_Inkhwekhweti_Inhlaba_Kholwane_Ingci_Inyoni_Imphala_Lweti_Ingongoni".split("_"),monthsShort:"Bhi_Ina_Inu_Mab_Ink_Inh_Kho_Igc_Iny_Imp_Lwe_Igo".split("_"),weekdays:"Lisontfo_Umsombuluko_Lesibili_Lesitsatfu_Lesine_Lesihlanu_Umgcibelo".split("_"),weekdaysShort:"Lis_Umb_Lsb_Les_Lsi_Lsh_Umg".split("_"),weekdaysMin:"Li_Us_Lb_Lt_Ls_Lh_Ug".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Namuhla nga] LT",nextDay:"[Kusasa nga] LT",nextWeek:"dddd [nga] LT",lastDay:"[Itolo nga] LT",lastWeek:"dddd [leliphelile] [nga] LT",sameElse:"L"},relativeTime:{future:"nga %s",past:"wenteka nga %s",s:"emizuzwana lomcane",m:"umzuzu",mm:"%d emizuzu",h:"lihora",hh:"%d emahora",d:"lilanga",dd:"%d emalanga",M:"inyanga",MM:"%d tinyanga",y:"umnyaka",yy:"%d iminyaka"},meridiemParse:/ekuseni|emini|entsambama|ebusuku/,meridiem:function(a,b,c){return a<11?"ekuseni":a<15?"emini":a<19?"entsambama":"ebusuku"},meridiemHour:function(a,b){return 12===a&&(a=0),"ekuseni"===b?a:"emini"===b?a>=11?a:a+12:"entsambama"===b||"ebusuku"===b?0===a?0:a+12:void 0},ordinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Swedish [sv]
//! author : Jens Alm : https://github.com/ulmus
a.defineLocale("sv",{months:"januari_februari_mars_april_maj_juni_juli_augusti_september_oktober_november_december".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec".split("_"),weekdays:"söndag_måndag_tisdag_onsdag_torsdag_fredag_lördag".split("_"),weekdaysShort:"sön_mån_tis_ons_tor_fre_lör".split("_"),weekdaysMin:"sö_må_ti_on_to_fr_lö".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [kl.] HH:mm",LLLL:"dddd D MMMM YYYY [kl.] HH:mm",lll:"D MMM YYYY HH:mm",llll:"ddd D MMM YYYY HH:mm"},calendar:{sameDay:"[Idag] LT",nextDay:"[Imorgon] LT",lastDay:"[Igår] LT",nextWeek:"[På] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"för %s sedan",s:"några sekunder",m:"en minut",mm:"%d minuter",h:"en timme",hh:"%d timmar",d:"en dag",dd:"%d dagar",M:"en månad",MM:"%d månader",y:"ett år",yy:"%d år"},ordinalParse:/\d{1,2}(e|a)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"e":1===b?"a":2===b?"a":"e";return a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Swahili [sw]
//! author : Fahad Kassim : https://github.com/fadsel
a.defineLocale("sw",{months:"Januari_Februari_Machi_Aprili_Mei_Juni_Julai_Agosti_Septemba_Oktoba_Novemba_Desemba".split("_"),monthsShort:"Jan_Feb_Mac_Apr_Mei_Jun_Jul_Ago_Sep_Okt_Nov_Des".split("_"),weekdays:"Jumapili_Jumatatu_Jumanne_Jumatano_Alhamisi_Ijumaa_Jumamosi".split("_"),weekdaysShort:"Jpl_Jtat_Jnne_Jtan_Alh_Ijm_Jmos".split("_"),weekdaysMin:"J2_J3_J4_J5_Al_Ij_J1".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[leo saa] LT",nextDay:"[kesho saa] LT",nextWeek:"[wiki ijayo] dddd [saat] LT",lastDay:"[jana] LT",lastWeek:"[wiki iliyopita] dddd [saat] LT",sameElse:"L"},relativeTime:{future:"%s baadaye",past:"tokea %s",s:"hivi punde",m:"dakika moja",mm:"dakika %d",h:"saa limoja",hh:"masaa %d",d:"siku moja",dd:"masiku %d",M:"mwezi mmoja",MM:"miezi %d",y:"mwaka mmoja",yy:"miaka %d"},week:{dow:1,// Monday is the first day of the week.
doy:7}});
//! moment.js locale configuration
//! locale : Tamil [ta]
//! author : Arjunkumar Krishnamoorthy : https://github.com/tk120404
var Dh={1:"௧",2:"௨",3:"௩",4:"௪",5:"௫",6:"௬",7:"௭",8:"௮",9:"௯",0:"௦"},Eh={"௧":"1","௨":"2","௩":"3","௪":"4","௫":"5","௬":"6","௭":"7","௮":"8","௯":"9","௦":"0"};a.defineLocale("ta",{months:"ஜனவரி_பிப்ரவரி_மார்ச்_ஏப்ரல்_மே_ஜூன்_ஜூலை_ஆகஸ்ட்_செப்டெம்பர்_அக்டோபர்_நவம்பர்_டிசம்பர்".split("_"),monthsShort:"ஜனவரி_பிப்ரவரி_மார்ச்_ஏப்ரல்_மே_ஜூன்_ஜூலை_ஆகஸ்ட்_செப்டெம்பர்_அக்டோபர்_நவம்பர்_டிசம்பர்".split("_"),weekdays:"ஞாயிற்றுக்கிழமை_திங்கட்கிழமை_செவ்வாய்கிழமை_புதன்கிழமை_வியாழக்கிழமை_வெள்ளிக்கிழமை_சனிக்கிழமை".split("_"),weekdaysShort:"ஞாயிறு_திங்கள்_செவ்வாய்_புதன்_வியாழன்_வெள்ளி_சனி".split("_"),weekdaysMin:"ஞா_தி_செ_பு_வி_வெ_ச".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, HH:mm",LLLL:"dddd, D MMMM YYYY, HH:mm"},calendar:{sameDay:"[இன்று] LT",nextDay:"[நாளை] LT",nextWeek:"dddd, LT",lastDay:"[நேற்று] LT",lastWeek:"[கடந்த வாரம்] dddd, LT",sameElse:"L"},relativeTime:{future:"%s இல்",past:"%s முன்",s:"ஒரு சில விநாடிகள்",m:"ஒரு நிமிடம்",mm:"%d நிமிடங்கள்",h:"ஒரு மணி நேரம்",hh:"%d மணி நேரம்",d:"ஒரு நாள்",dd:"%d நாட்கள்",M:"ஒரு மாதம்",MM:"%d மாதங்கள்",y:"ஒரு வருடம்",yy:"%d ஆண்டுகள்"},ordinalParse:/\d{1,2}வது/,ordinal:function(a){return a+"வது"},preparse:function(a){return a.replace(/[௧௨௩௪௫௬௭௮௯௦]/g,function(a){return Eh[a]})},postformat:function(a){return a.replace(/\d/g,function(a){return Dh[a]})},
// refer http://ta.wikipedia.org/s/1er1
meridiemParse:/யாமம்|வைகறை|காலை|நண்பகல்|எற்பாடு|மாலை/,meridiem:function(a,b,c){return a<2?" யாமம்":a<6?" வைகறை":a<10?" காலை":a<14?" நண்பகல்":a<18?" எற்பாடு":a<22?" மாலை":" யாமம்"},meridiemHour:function(a,b){return 12===a&&(a=0),"யாமம்"===b?a<2?a:a+12:"வைகறை"===b||"காலை"===b?a:"நண்பகல்"===b&&a>=10?a:a+12},week:{dow:0,// Sunday is the first day of the week.
doy:6}}),
//! moment.js locale configuration
//! locale : Telugu [te]
//! author : Krishna Chaitanya Thota : https://github.com/kcthota
a.defineLocale("te",{months:"జనవరి_ఫిబ్రవరి_మార్చి_ఏప్రిల్_మే_జూన్_జూలై_ఆగస్టు_సెప్టెంబర్_అక్టోబర్_నవంబర్_డిసెంబర్".split("_"),monthsShort:"జన._ఫిబ్ర._మార్చి_ఏప్రి._మే_జూన్_జూలై_ఆగ._సెప్._అక్టో._నవ._డిసె.".split("_"),monthsParseExact:!0,weekdays:"ఆదివారం_సోమవారం_మంగళవారం_బుధవారం_గురువారం_శుక్రవారం_శనివారం".split("_"),weekdaysShort:"ఆది_సోమ_మంగళ_బుధ_గురు_శుక్ర_శని".split("_"),weekdaysMin:"ఆ_సో_మం_బు_గు_శు_శ".split("_"),longDateFormat:{LT:"A h:mm",LTS:"A h:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm",LLLL:"dddd, D MMMM YYYY, A h:mm"},calendar:{sameDay:"[నేడు] LT",nextDay:"[రేపు] LT",nextWeek:"dddd, LT",lastDay:"[నిన్న] LT",lastWeek:"[గత] dddd, LT",sameElse:"L"},relativeTime:{future:"%s లో",past:"%s క్రితం",s:"కొన్ని క్షణాలు",m:"ఒక నిమిషం",mm:"%d నిమిషాలు",h:"ఒక గంట",hh:"%d గంటలు",d:"ఒక రోజు",dd:"%d రోజులు",M:"ఒక నెల",MM:"%d నెలలు",y:"ఒక సంవత్సరం",yy:"%d సంవత్సరాలు"},ordinalParse:/\d{1,2}వ/,ordinal:"%dవ",meridiemParse:/రాత్రి|ఉదయం|మధ్యాహ్నం|సాయంత్రం/,meridiemHour:function(a,b){return 12===a&&(a=0),"రాత్రి"===b?a<4?a:a+12:"ఉదయం"===b?a:"మధ్యాహ్నం"===b?a>=10?a:a+12:"సాయంత్రం"===b?a+12:void 0},meridiem:function(a,b,c){return a<4?"రాత్రి":a<10?"ఉదయం":a<17?"మధ్యాహ్నం":a<20?"సాయంత్రం":"రాత్రి"},week:{dow:0,// Sunday is the first day of the week.
doy:6}}),
//! moment.js locale configuration
//! locale : Tetun Dili (East Timor) [tet]
//! author : Joshua Brooks : https://github.com/joshbrooks
//! author : Onorio De J. Afonso : https://github.com/marobo
a.defineLocale("tet",{months:"Janeiru_Fevereiru_Marsu_Abril_Maiu_Juniu_Juliu_Augustu_Setembru_Outubru_Novembru_Dezembru".split("_"),monthsShort:"Jan_Fev_Mar_Abr_Mai_Jun_Jul_Aug_Set_Out_Nov_Dez".split("_"),weekdays:"Domingu_Segunda_Tersa_Kuarta_Kinta_Sexta_Sabadu".split("_"),weekdaysShort:"Dom_Seg_Ters_Kua_Kint_Sext_Sab".split("_"),weekdaysMin:"Do_Seg_Te_Ku_Ki_Sex_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Ohin iha] LT",nextDay:"[Aban iha] LT",nextWeek:"dddd [iha] LT",lastDay:"[Horiseik iha] LT",lastWeek:"dddd [semana kotuk] [iha] LT",sameElse:"L"},relativeTime:{future:"iha %s",past:"%s liuba",s:"minutu balun",m:"minutu ida",mm:"minutus %d",h:"horas ida",hh:"horas %d",d:"loron ida",dd:"loron %d",M:"fulan ida",MM:"fulan %d",y:"tinan ida",yy:"tinan %d"},ordinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),
//! moment.js locale configuration
//! locale : Thai [th]
//! author : Kridsada Thanabulpong : https://github.com/sirn
a.defineLocale("th",{months:"มกราคม_กุมภาพันธ์_มีนาคม_เมษายน_พฤษภาคม_มิถุนายน_กรกฎาคม_สิงหาคม_กันยายน_ตุลาคม_พฤศจิกายน_ธันวาคม".split("_"),monthsShort:"ม.ค._ก.พ._มี.ค._เม.ย._พ.ค._มิ.ย._ก.ค._ส.ค._ก.ย._ต.ค._พ.ย._ธ.ค.".split("_"),monthsParseExact:!0,weekdays:"อาทิตย์_จันทร์_อังคาร_พุธ_พฤหัสบดี_ศุกร์_เสาร์".split("_"),weekdaysShort:"อาทิตย์_จันทร์_อังคาร_พุธ_พฤหัส_ศุกร์_เสาร์".split("_"),// yes, three characters difference
weekdaysMin:"อา._จ._อ._พ._พฤ._ศ._ส.".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"YYYY/MM/DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY เวลา H:mm",LLLL:"วันddddที่ D MMMM YYYY เวลา H:mm"},meridiemParse:/ก่อนเที่ยง|หลังเที่ยง/,isPM:function(a){return"หลังเที่ยง"===a},meridiem:function(a,b,c){return a<12?"ก่อนเที่ยง":"หลังเที่ยง"},calendar:{sameDay:"[วันนี้ เวลา] LT",nextDay:"[พรุ่งนี้ เวลา] LT",nextWeek:"dddd[หน้า เวลา] LT",lastDay:"[เมื่อวานนี้ เวลา] LT",lastWeek:"[วัน]dddd[ที่แล้ว เวลา] LT",sameElse:"L"},relativeTime:{future:"อีก %s",past:"%sที่แล้ว",s:"ไม่กี่วินาที",m:"1 นาที",mm:"%d นาที",h:"1 ชั่วโมง",hh:"%d ชั่วโมง",d:"1 วัน",dd:"%d วัน",M:"1 เดือน",MM:"%d เดือน",y:"1 ปี",yy:"%d ปี"}}),
//! moment.js locale configuration
//! locale : Tagalog (Philippines) [tl-ph]
//! author : Dan Hagman : https://github.com/hagmandan
a.defineLocale("tl-ph",{months:"Enero_Pebrero_Marso_Abril_Mayo_Hunyo_Hulyo_Agosto_Setyembre_Oktubre_Nobyembre_Disyembre".split("_"),monthsShort:"Ene_Peb_Mar_Abr_May_Hun_Hul_Ago_Set_Okt_Nob_Dis".split("_"),weekdays:"Linggo_Lunes_Martes_Miyerkules_Huwebes_Biyernes_Sabado".split("_"),weekdaysShort:"Lin_Lun_Mar_Miy_Huw_Biy_Sab".split("_"),weekdaysMin:"Li_Lu_Ma_Mi_Hu_Bi_Sab".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"MM/D/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY HH:mm",LLLL:"dddd, MMMM DD, YYYY HH:mm"},calendar:{sameDay:"LT [ngayong araw]",nextDay:"[Bukas ng] LT",nextWeek:"LT [sa susunod na] dddd",lastDay:"LT [kahapon]",lastWeek:"LT [noong nakaraang] dddd",sameElse:"L"},relativeTime:{future:"sa loob ng %s",past:"%s ang nakalipas",s:"ilang segundo",m:"isang minuto",mm:"%d minuto",h:"isang oras",hh:"%d oras",d:"isang araw",dd:"%d araw",M:"isang buwan",MM:"%d buwan",y:"isang taon",yy:"%d taon"},ordinalParse:/\d{1,2}/,ordinal:function(a){return a},week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Klingon [tlh]
//! author : Dominika Kruk : https://github.com/amaranthrose
var Fh="pagh_wa’_cha’_wej_loS_vagh_jav_Soch_chorgh_Hut".split("_");a.defineLocale("tlh",{months:"tera’ jar wa’_tera’ jar cha’_tera’ jar wej_tera’ jar loS_tera’ jar vagh_tera’ jar jav_tera’ jar Soch_tera’ jar chorgh_tera’ jar Hut_tera’ jar wa’maH_tera’ jar wa’maH wa’_tera’ jar wa’maH cha’".split("_"),monthsShort:"jar wa’_jar cha’_jar wej_jar loS_jar vagh_jar jav_jar Soch_jar chorgh_jar Hut_jar wa’maH_jar wa’maH wa’_jar wa’maH cha’".split("_"),monthsParseExact:!0,weekdays:"lojmItjaj_DaSjaj_povjaj_ghItlhjaj_loghjaj_buqjaj_ghInjaj".split("_"),weekdaysShort:"lojmItjaj_DaSjaj_povjaj_ghItlhjaj_loghjaj_buqjaj_ghInjaj".split("_"),weekdaysMin:"lojmItjaj_DaSjaj_povjaj_ghItlhjaj_loghjaj_buqjaj_ghInjaj".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[DaHjaj] LT",nextDay:"[wa’leS] LT",nextWeek:"LLL",lastDay:"[wa’Hu’] LT",lastWeek:"LLL",sameElse:"L"},relativeTime:{future:ce,past:de,s:"puS lup",m:"wa’ tup",mm:ee,h:"wa’ rep",hh:ee,d:"wa’ jaj",dd:ee,M:"wa’ jar",MM:ee,y:"wa’ DIS",yy:ee},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}});
//! moment.js locale configuration
//! locale : Turkish [tr]
//! authors : Erhan Gundogan : https://github.com/erhangundogan,
//!           Burak Yiğit Kaya: https://github.com/BYK
var Gh={1:"'inci",5:"'inci",8:"'inci",70:"'inci",80:"'inci",2:"'nci",7:"'nci",20:"'nci",50:"'nci",3:"'üncü",4:"'üncü",100:"'üncü",6:"'ncı",9:"'uncu",10:"'uncu",30:"'uncu",60:"'ıncı",90:"'ıncı"};
//! moment.js locale configuration
//! locale : Talossan [tzl]
//! author : Robin van der Vliet : https://github.com/robin0van0der0v
//! author : Iustì Canun
// After the year there should be a slash and the amount of years since December 26, 1979 in Roman numerals.
// This is currently too difficult (maybe even impossible) to add.
//! moment.js locale configuration
//! locale : Central Atlas Tamazight Latin [tzm-latn]
//! author : Abdel Said : https://github.com/abdelsaid
//! moment.js locale configuration
//! locale : Central Atlas Tamazight [tzm]
//! author : Abdel Said : https://github.com/abdelsaid
//! moment.js locale configuration
//! locale : Uzbek [uz]
//! author : Sardor Muminov : https://github.com/muminoff
//! moment.js locale configuration
//! locale : Vietnamese [vi]
//! author : Bang Nguyen : https://github.com/bangnk
//! moment.js locale configuration
//! locale : Pseudo [x-pseudo]
//! author : Andrew Hood : https://github.com/andrewhood125
//! moment.js locale configuration
//! locale : Yoruba Nigeria [yo]
//! author : Atolagbe Abisoye : https://github.com/andela-batolagbe
//! moment.js locale configuration
//! locale : Chinese (China) [zh-cn]
//! author : suupic : https://github.com/suupic
//! author : Zeno Zeng : https://github.com/zenozeng
//! moment.js locale configuration
//! locale : Chinese (Hong Kong) [zh-hk]
//! author : Ben : https://github.com/ben-lin
//! author : Chris Lam : https://github.com/hehachris
//! author : Konstantin : https://github.com/skfd
//! moment.js locale configuration
//! locale : Chinese (Taiwan) [zh-tw]
//! author : Ben : https://github.com/ben-lin
//! author : Chris Lam : https://github.com/hehachris
return a.defineLocale("tr",{months:"Ocak_Şubat_Mart_Nisan_Mayıs_Haziran_Temmuz_Ağustos_Eylül_Ekim_Kasım_Aralık".split("_"),monthsShort:"Oca_Şub_Mar_Nis_May_Haz_Tem_Ağu_Eyl_Eki_Kas_Ara".split("_"),weekdays:"Pazar_Pazartesi_Salı_Çarşamba_Perşembe_Cuma_Cumartesi".split("_"),weekdaysShort:"Paz_Pts_Sal_Çar_Per_Cum_Cts".split("_"),weekdaysMin:"Pz_Pt_Sa_Ça_Pe_Cu_Ct".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[bugün saat] LT",nextDay:"[yarın saat] LT",nextWeek:"[haftaya] dddd [saat] LT",lastDay:"[dün] LT",lastWeek:"[geçen hafta] dddd [saat] LT",sameElse:"L"},relativeTime:{future:"%s sonra",past:"%s önce",s:"birkaç saniye",m:"bir dakika",mm:"%d dakika",h:"bir saat",hh:"%d saat",d:"bir gün",dd:"%d gün",M:"bir ay",MM:"%d ay",y:"bir yıl",yy:"%d yıl"},ordinalParse:/\d{1,2}'(inci|nci|üncü|ncı|uncu|ıncı)/,ordinal:function(a){if(0===a)// special case for zero
return a+"'ıncı";var b=a%10,c=a%100-b,d=a>=100?100:null;return a+(Gh[b]||Gh[c]||Gh[d])},week:{dow:1,// Monday is the first day of the week.
doy:7}}),a.defineLocale("tzl",{months:"Januar_Fevraglh_Març_Avrïu_Mai_Gün_Julia_Guscht_Setemvar_Listopäts_Noemvar_Zecemvar".split("_"),monthsShort:"Jan_Fev_Mar_Avr_Mai_Gün_Jul_Gus_Set_Lis_Noe_Zec".split("_"),weekdays:"Súladi_Lúneçi_Maitzi_Márcuri_Xhúadi_Viénerçi_Sáturi".split("_"),weekdaysShort:"Súl_Lún_Mai_Már_Xhú_Vié_Sát".split("_"),weekdaysMin:"Sú_Lú_Ma_Má_Xh_Vi_Sá".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD.MM.YYYY",LL:"D. MMMM [dallas] YYYY",LLL:"D. MMMM [dallas] YYYY HH.mm",LLLL:"dddd, [li] D. MMMM [dallas] YYYY HH.mm"},meridiemParse:/d\'o|d\'a/i,isPM:function(a){return"d'o"===a.toLowerCase()},meridiem:function(a,b,c){return a>11?c?"d'o":"D'O":c?"d'a":"D'A"},calendar:{sameDay:"[oxhi à] LT",nextDay:"[demà à] LT",nextWeek:"dddd [à] LT",lastDay:"[ieiri à] LT",lastWeek:"[sür el] dddd [lasteu à] LT",sameElse:"L"},relativeTime:{future:"osprei %s",past:"ja%s",s:ge,m:ge,mm:ge,h:ge,hh:ge,d:ge,dd:ge,M:ge,MM:ge,y:ge,yy:ge},ordinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("tzm-latn",{months:"innayr_brˤayrˤ_marˤsˤ_ibrir_mayyw_ywnyw_ywlywz_ɣwšt_šwtanbir_ktˤwbrˤ_nwwanbir_dwjnbir".split("_"),monthsShort:"innayr_brˤayrˤ_marˤsˤ_ibrir_mayyw_ywnyw_ywlywz_ɣwšt_šwtanbir_ktˤwbrˤ_nwwanbir_dwjnbir".split("_"),weekdays:"asamas_aynas_asinas_akras_akwas_asimwas_asiḍyas".split("_"),weekdaysShort:"asamas_aynas_asinas_akras_akwas_asimwas_asiḍyas".split("_"),weekdaysMin:"asamas_aynas_asinas_akras_akwas_asimwas_asiḍyas".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[asdkh g] LT",nextDay:"[aska g] LT",nextWeek:"dddd [g] LT",lastDay:"[assant g] LT",lastWeek:"dddd [g] LT",sameElse:"L"},relativeTime:{future:"dadkh s yan %s",past:"yan %s",s:"imik",m:"minuḍ",mm:"%d minuḍ",h:"saɛa",hh:"%d tassaɛin",d:"ass",dd:"%d ossan",M:"ayowr",MM:"%d iyyirn",y:"asgas",yy:"%d isgasn"},week:{dow:6,// Saturday is the first day of the week.
doy:12}}),a.defineLocale("tzm",{months:"ⵉⵏⵏⴰⵢⵔ_ⴱⵕⴰⵢⵕ_ⵎⴰⵕⵚ_ⵉⴱⵔⵉⵔ_ⵎⴰⵢⵢⵓ_ⵢⵓⵏⵢⵓ_ⵢⵓⵍⵢⵓⵣ_ⵖⵓⵛⵜ_ⵛⵓⵜⴰⵏⴱⵉⵔ_ⴽⵟⵓⴱⵕ_ⵏⵓⵡⴰⵏⴱⵉⵔ_ⴷⵓⵊⵏⴱⵉⵔ".split("_"),monthsShort:"ⵉⵏⵏⴰⵢⵔ_ⴱⵕⴰⵢⵕ_ⵎⴰⵕⵚ_ⵉⴱⵔⵉⵔ_ⵎⴰⵢⵢⵓ_ⵢⵓⵏⵢⵓ_ⵢⵓⵍⵢⵓⵣ_ⵖⵓⵛⵜ_ⵛⵓⵜⴰⵏⴱⵉⵔ_ⴽⵟⵓⴱⵕ_ⵏⵓⵡⴰⵏⴱⵉⵔ_ⴷⵓⵊⵏⴱⵉⵔ".split("_"),weekdays:"ⴰⵙⴰⵎⴰⵙ_ⴰⵢⵏⴰⵙ_ⴰⵙⵉⵏⴰⵙ_ⴰⴽⵔⴰⵙ_ⴰⴽⵡⴰⵙ_ⴰⵙⵉⵎⵡⴰⵙ_ⴰⵙⵉⴹⵢⴰⵙ".split("_"),weekdaysShort:"ⴰⵙⴰⵎⴰⵙ_ⴰⵢⵏⴰⵙ_ⴰⵙⵉⵏⴰⵙ_ⴰⴽⵔⴰⵙ_ⴰⴽⵡⴰⵙ_ⴰⵙⵉⵎⵡⴰⵙ_ⴰⵙⵉⴹⵢⴰⵙ".split("_"),weekdaysMin:"ⴰⵙⴰⵎⴰⵙ_ⴰⵢⵏⴰⵙ_ⴰⵙⵉⵏⴰⵙ_ⴰⴽⵔⴰⵙ_ⴰⴽⵡⴰⵙ_ⴰⵙⵉⵎⵡⴰⵙ_ⴰⵙⵉⴹⵢⴰⵙ".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[ⴰⵙⴷⵅ ⴴ] LT",nextDay:"[ⴰⵙⴽⴰ ⴴ] LT",nextWeek:"dddd [ⴴ] LT",lastDay:"[ⴰⵚⴰⵏⵜ ⴴ] LT",lastWeek:"dddd [ⴴ] LT",sameElse:"L"},relativeTime:{future:"ⴷⴰⴷⵅ ⵙ ⵢⴰⵏ %s",past:"ⵢⴰⵏ %s",s:"ⵉⵎⵉⴽ",m:"ⵎⵉⵏⵓⴺ",mm:"%d ⵎⵉⵏⵓⴺ",h:"ⵙⴰⵄⴰ",hh:"%d ⵜⴰⵙⵙⴰⵄⵉⵏ",d:"ⴰⵙⵙ",dd:"%d oⵙⵙⴰⵏ",M:"ⴰⵢoⵓⵔ",MM:"%d ⵉⵢⵢⵉⵔⵏ",y:"ⴰⵙⴳⴰⵙ",yy:"%d ⵉⵙⴳⴰⵙⵏ"},week:{dow:6,// Saturday is the first day of the week.
doy:12}}),a.defineLocale("uk",{months:{format:"січня_лютого_березня_квітня_травня_червня_липня_серпня_вересня_жовтня_листопада_грудня".split("_"),standalone:"січень_лютий_березень_квітень_травень_червень_липень_серпень_вересень_жовтень_листопад_грудень".split("_")},monthsShort:"січ_лют_бер_квіт_трав_черв_лип_серп_вер_жовт_лист_груд".split("_"),weekdays:je,weekdaysShort:"нд_пн_вт_ср_чт_пт_сб".split("_"),weekdaysMin:"нд_пн_вт_ср_чт_пт_сб".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY р.",LLL:"D MMMM YYYY р., HH:mm",LLLL:"dddd, D MMMM YYYY р., HH:mm"},calendar:{sameDay:ke("[Сьогодні "),nextDay:ke("[Завтра "),lastDay:ke("[Вчора "),nextWeek:ke("[У] dddd ["),lastWeek:function(){switch(this.day()){case 0:case 3:case 5:case 6:return ke("[Минулої] dddd [").call(this);case 1:case 2:case 4:return ke("[Минулого] dddd [").call(this)}},sameElse:"L"},relativeTime:{future:"за %s",past:"%s тому",s:"декілька секунд",m:ie,mm:ie,h:"годину",hh:ie,d:"день",dd:ie,M:"місяць",MM:ie,y:"рік",yy:ie},
// M. E.: those two are virtually unused but a user might want to implement them for his/her website for some reason
meridiemParse:/ночі|ранку|дня|вечора/,isPM:function(a){return/^(дня|вечора)$/.test(a)},meridiem:function(a,b,c){return a<4?"ночі":a<12?"ранку":a<17?"дня":"вечора"},ordinalParse:/\d{1,2}-(й|го)/,ordinal:function(a,b){switch(b){case"M":case"d":case"DDD":case"w":case"W":return a+"-й";case"D":return a+"-го";default:return a}},week:{dow:1,// Monday is the first day of the week.
doy:7}}),a.defineLocale("uz",{months:"январ_феврал_март_апрел_май_июн_июл_август_сентябр_октябр_ноябр_декабр".split("_"),monthsShort:"янв_фев_мар_апр_май_июн_июл_авг_сен_окт_ноя_дек".split("_"),weekdays:"Якшанба_Душанба_Сешанба_Чоршанба_Пайшанба_Жума_Шанба".split("_"),weekdaysShort:"Якш_Душ_Сеш_Чор_Пай_Жум_Шан".split("_"),weekdaysMin:"Як_Ду_Се_Чо_Па_Жу_Ша".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"D MMMM YYYY, dddd HH:mm"},calendar:{sameDay:"[Бугун соат] LT [да]",nextDay:"[Эртага] LT [да]",nextWeek:"dddd [куни соат] LT [да]",lastDay:"[Кеча соат] LT [да]",lastWeek:"[Утган] dddd [куни соат] LT [да]",sameElse:"L"},relativeTime:{future:"Якин %s ичида",past:"Бир неча %s олдин",s:"фурсат",m:"бир дакика",mm:"%d дакика",h:"бир соат",hh:"%d соат",d:"бир кун",dd:"%d кун",M:"бир ой",MM:"%d ой",y:"бир йил",yy:"%d йил"},week:{dow:1,// Monday is the first day of the week.
doy:7}}),a.defineLocale("vi",{months:"tháng 1_tháng 2_tháng 3_tháng 4_tháng 5_tháng 6_tháng 7_tháng 8_tháng 9_tháng 10_tháng 11_tháng 12".split("_"),monthsShort:"Th01_Th02_Th03_Th04_Th05_Th06_Th07_Th08_Th09_Th10_Th11_Th12".split("_"),monthsParseExact:!0,weekdays:"chủ nhật_thứ hai_thứ ba_thứ tư_thứ năm_thứ sáu_thứ bảy".split("_"),weekdaysShort:"CN_T2_T3_T4_T5_T6_T7".split("_"),weekdaysMin:"CN_T2_T3_T4_T5_T6_T7".split("_"),weekdaysParseExact:!0,meridiemParse:/sa|ch/i,isPM:function(a){return/^ch$/i.test(a)},meridiem:function(a,b,c){return a<12?c?"sa":"SA":c?"ch":"CH"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM [năm] YYYY",LLL:"D MMMM [năm] YYYY HH:mm",LLLL:"dddd, D MMMM [năm] YYYY HH:mm",l:"DD/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY HH:mm",llll:"ddd, D MMM YYYY HH:mm"},calendar:{sameDay:"[Hôm nay lúc] LT",nextDay:"[Ngày mai lúc] LT",nextWeek:"dddd [tuần tới lúc] LT",lastDay:"[Hôm qua lúc] LT",lastWeek:"dddd [tuần rồi lúc] LT",sameElse:"L"},relativeTime:{future:"%s tới",past:"%s trước",s:"vài giây",m:"một phút",mm:"%d phút",h:"một giờ",hh:"%d giờ",d:"một ngày",dd:"%d ngày",M:"một tháng",MM:"%d tháng",y:"một năm",yy:"%d năm"},ordinalParse:/\d{1,2}/,ordinal:function(a){return a},week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("x-pseudo",{months:"J~áñúá~rý_F~ébrú~árý_~Márc~h_Áp~ríl_~Máý_~Júñé~_Júl~ý_Áú~gúst~_Sép~témb~ér_Ó~ctób~ér_Ñ~óvém~bér_~Décé~mbér".split("_"),monthsShort:"J~áñ_~Féb_~Már_~Ápr_~Máý_~Júñ_~Júl_~Áúg_~Sép_~Óct_~Ñóv_~Déc".split("_"),monthsParseExact:!0,weekdays:"S~úñdá~ý_Mó~ñdáý~_Túé~sdáý~_Wéd~ñésd~áý_T~húrs~dáý_~Fríd~áý_S~átúr~dáý".split("_"),weekdaysShort:"S~úñ_~Móñ_~Túé_~Wéd_~Thú_~Frí_~Sát".split("_"),weekdaysMin:"S~ú_Mó~_Tú_~Wé_T~h_Fr~_Sá".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[T~ódá~ý át] LT",nextDay:"[T~ómó~rró~w át] LT",nextWeek:"dddd [át] LT",lastDay:"[Ý~ést~érdá~ý át] LT",lastWeek:"[L~ást] dddd [át] LT",sameElse:"L"},relativeTime:{future:"í~ñ %s",past:"%s á~gó",s:"á ~féw ~sécó~ñds",m:"á ~míñ~úté",mm:"%d m~íñú~tés",h:"á~ñ hó~úr",hh:"%d h~óúrs",d:"á ~dáý",dd:"%d d~áýs",M:"á ~móñ~th",MM:"%d m~óñt~hs",y:"á ~ýéár",yy:"%d ý~éárs"},ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c},week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("yo",{months:"Sẹ́rẹ́_Èrèlè_Ẹrẹ̀nà_Ìgbé_Èbibi_Òkùdu_Agẹmo_Ògún_Owewe_Ọ̀wàrà_Bélú_Ọ̀pẹ̀̀".split("_"),monthsShort:"Sẹ́r_Èrl_Ẹrn_Ìgb_Èbi_Òkù_Agẹ_Ògú_Owe_Ọ̀wà_Bél_Ọ̀pẹ̀̀".split("_"),weekdays:"Àìkú_Ajé_Ìsẹ́gun_Ọjọ́rú_Ọjọ́bọ_Ẹtì_Àbámẹ́ta".split("_"),weekdaysShort:"Àìk_Ajé_Ìsẹ́_Ọjr_Ọjb_Ẹtì_Àbá".split("_"),weekdaysMin:"Àì_Aj_Ìs_Ọr_Ọb_Ẹt_Àb".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Ònì ni] LT",nextDay:"[Ọ̀la ni] LT",nextWeek:"dddd [Ọsẹ̀ tón'bọ] [ni] LT",lastDay:"[Àna ni] LT",lastWeek:"dddd [Ọsẹ̀ tólọ́] [ni] LT",sameElse:"L"},relativeTime:{future:"ní %s",past:"%s kọjá",s:"ìsẹjú aayá die",m:"ìsẹjú kan",mm:"ìsẹjú %d",h:"wákati kan",hh:"wákati %d",d:"ọjọ́ kan",dd:"ọjọ́ %d",M:"osù kan",MM:"osù %d",y:"ọdún kan",yy:"ọdún %d"},ordinalParse:/ọjọ́\s\d{1,2}/,ordinal:"ọjọ́ %d",week:{dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("zh-cn",{months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"周日_周一_周二_周三_周四_周五_周六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),longDateFormat:{LT:"Ah点mm分",LTS:"Ah点m分s秒",L:"YYYY-MM-DD",LL:"YYYY年MMMD日",LLL:"YYYY年MMMD日Ah点mm分",LLLL:"YYYY年MMMD日ddddAh点mm分",l:"YYYY-MM-DD",ll:"YYYY年MMMD日",lll:"YYYY年MMMD日Ah点mm分",llll:"YYYY年MMMD日ddddAh点mm分"},meridiemParse:/凌晨|早上|上午|中午|下午|晚上/,meridiemHour:function(a,b){return 12===a&&(a=0),"凌晨"===b||"早上"===b||"上午"===b?a:"下午"===b||"晚上"===b?a+12:a>=11?a:a+12},meridiem:function(a,b,c){var d=100*a+b;return d<600?"凌晨":d<900?"早上":d<1130?"上午":d<1230?"中午":d<1800?"下午":"晚上"},calendar:{sameDay:function(){return 0===this.minutes()?"[今天]Ah[点整]":"[今天]LT"},nextDay:function(){return 0===this.minutes()?"[明天]Ah[点整]":"[明天]LT"},lastDay:function(){return 0===this.minutes()?"[昨天]Ah[点整]":"[昨天]LT"},nextWeek:function(){var b,c;return b=a().startOf("week"),c=this.diff(b,"days")>=7?"[下]":"[本]",0===this.minutes()?c+"dddAh点整":c+"dddAh点mm"},lastWeek:function(){var b,c;return b=a().startOf("week"),c=this.unix()<b.unix()?"[上]":"[本]",0===this.minutes()?c+"dddAh点整":c+"dddAh点mm"},sameElse:"LL"},ordinalParse:/\d{1,2}(日|月|周)/,ordinal:function(a,b){switch(b){case"d":case"D":case"DDD":return a+"日";case"M":return a+"月";case"w":case"W":return a+"周";default:return a}},relativeTime:{future:"%s内",past:"%s前",s:"几秒",m:"1 分钟",mm:"%d 分钟",h:"1 小时",hh:"%d 小时",d:"1 天",dd:"%d 天",M:"1 个月",MM:"%d 个月",y:"1 年",yy:"%d 年"},week:{
// GB/T 7408-1994《数据元和交换格式·信息交换·日期和时间表示法》与ISO 8601:1988等效
dow:1,// Monday is the first day of the week.
doy:4}}),a.defineLocale("zh-hk",{months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"週日_週一_週二_週三_週四_週五_週六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),longDateFormat:{LT:"Ah點mm分",LTS:"Ah點m分s秒",L:"YYYY年MMMD日",LL:"YYYY年MMMD日",LLL:"YYYY年MMMD日Ah點mm分",LLLL:"YYYY年MMMD日ddddAh點mm分",l:"YYYY年MMMD日",ll:"YYYY年MMMD日",lll:"YYYY年MMMD日Ah點mm分",llll:"YYYY年MMMD日ddddAh點mm分"},meridiemParse:/凌晨|早上|上午|中午|下午|晚上/,meridiemHour:function(a,b){return 12===a&&(a=0),"凌晨"===b||"早上"===b||"上午"===b?a:"中午"===b?a>=11?a:a+12:"下午"===b||"晚上"===b?a+12:void 0},meridiem:function(a,b,c){var d=100*a+b;return d<600?"凌晨":d<900?"早上":d<1130?"上午":d<1230?"中午":d<1800?"下午":"晚上"},calendar:{sameDay:"[今天]LT",nextDay:"[明天]LT",nextWeek:"[下]ddddLT",lastDay:"[昨天]LT",lastWeek:"[上]ddddLT",sameElse:"L"},ordinalParse:/\d{1,2}(日|月|週)/,ordinal:function(a,b){switch(b){case"d":case"D":case"DDD":return a+"日";case"M":return a+"月";case"w":case"W":return a+"週";default:return a}},relativeTime:{future:"%s內",past:"%s前",s:"幾秒",m:"1 分鐘",mm:"%d 分鐘",h:"1 小時",hh:"%d 小時",d:"1 天",dd:"%d 天",M:"1 個月",MM:"%d 個月",y:"1 年",yy:"%d 年"}}),a.defineLocale("zh-tw",{months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"週日_週一_週二_週三_週四_週五_週六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),longDateFormat:{LT:"Ah點mm分",LTS:"Ah點m分s秒",L:"YYYY年MMMD日",LL:"YYYY年MMMD日",LLL:"YYYY年MMMD日Ah點mm分",LLLL:"YYYY年MMMD日ddddAh點mm分",l:"YYYY年MMMD日",ll:"YYYY年MMMD日",lll:"YYYY年MMMD日Ah點mm分",llll:"YYYY年MMMD日ddddAh點mm分"},meridiemParse:/凌晨|早上|上午|中午|下午|晚上/,meridiemHour:function(a,b){return 12===a&&(a=0),"凌晨"===b||"早上"===b||"上午"===b?a:"中午"===b?a>=11?a:a+12:"下午"===b||"晚上"===b?a+12:void 0},meridiem:function(a,b,c){var d=100*a+b;return d<600?"凌晨":d<900?"早上":d<1130?"上午":d<1230?"中午":d<1800?"下午":"晚上"},calendar:{sameDay:"[今天]LT",nextDay:"[明天]LT",nextWeek:"[下]ddddLT",lastDay:"[昨天]LT",lastWeek:"[上]ddddLT",sameElse:"L"},ordinalParse:/\d{1,2}(日|月|週)/,ordinal:function(a,b){switch(b){case"d":case"D":case"DDD":return a+"日";case"M":return a+"月";case"w":case"W":return a+"週";default:return a}},relativeTime:{future:"%s內",past:"%s前",s:"幾秒",m:"1 分鐘",mm:"%d 分鐘",h:"1 小時",hh:"%d 小時",d:"1 天",dd:"%d 天",M:"1 個月",MM:"%d 個月",y:"1 年",yy:"%d 年"}}),a.locale("en"),a});

if (window) window.__currentScriptPath = "/v2/common/libs/moment/moment-timezone-with-data.min.js";

//! moment-timezone.js
//! version : 0.5.3
//! author : Tim Wood
//! license : MIT
//! github.com/moment/moment-timezone
!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["moment"],b):"object"==typeof module&&module.exports?module.exports=b(require("moment")):b(a.moment)}(this,function(a){"use strict";function b(a){return a>96?a-87:a>64?a-29:a-48}function c(a){var c,d=0,e=a.split("."),f=e[0],g=e[1]||"",h=1,i=0,j=1;for(45===a.charCodeAt(0)&&(d=1,j=-1),d;d<f.length;d++)c=b(f.charCodeAt(d)),i=60*i+c;for(d=0;d<g.length;d++)h/=60,c=b(g.charCodeAt(d)),i+=c*h;return i*j}function d(a){for(var b=0;b<a.length;b++)a[b]=c(a[b])}function e(a,b){for(var c=0;b>c;c++)a[c]=Math.round((a[c-1]||0)+6e4*a[c]);a[b-1]=1/0}function f(a,b){var c,d=[];for(c=0;c<b.length;c++)d[c]=a[b[c]];return d}function g(a){var b=a.split("|"),c=b[2].split(" "),g=b[3].split(""),h=b[4].split(" ");return d(c),d(g),d(h),e(h,g.length),{name:b[0],abbrs:f(b[1].split(" "),g),offsets:f(c,g),untils:h,population:0|b[5]}}function h(a){a&&this._set(g(a))}function i(a){var b=a.toTimeString(),c=b.match(/\([a-z ]+\)/i);c&&c[0]?(c=c[0].match(/[A-Z]/g),c=c?c.join(""):void 0):(c=b.match(/[A-Z]{3,5}/g),c=c?c[0]:void 0),"GMT"===c&&(c=void 0),this.at=+a,this.abbr=c,this.offset=a.getTimezoneOffset()}function j(a){this.zone=a,this.offsetScore=0,this.abbrScore=0}function k(a,b){for(var c,d;d=6e4*((b.at-a.at)/12e4|0);)c=new i(new Date(a.at+d)),c.offset===a.offset?a=c:b=c;return a}function l(){var a,b,c,d=(new Date).getFullYear()-2,e=new i(new Date(d,0,1)),f=[e];for(c=1;48>c;c++)b=new i(new Date(d,c,1)),b.offset!==e.offset&&(a=k(e,b),f.push(a),f.push(new i(new Date(a.at+6e4)))),e=b;for(c=0;4>c;c++)f.push(new i(new Date(d+c,0,1))),f.push(new i(new Date(d+c,6,1)));return f}function m(a,b){return a.offsetScore!==b.offsetScore?a.offsetScore-b.offsetScore:a.abbrScore!==b.abbrScore?a.abbrScore-b.abbrScore:b.zone.population-a.zone.population}function n(a,b){var c,e;for(d(b),c=0;c<b.length;c++)e=b[c],I[e]=I[e]||{},I[e][a]=!0}function o(a){var b,c,d,e=a.length,f={},g=[];for(b=0;e>b;b++){d=I[a[b].offset]||{};for(c in d)d.hasOwnProperty(c)&&(f[c]=!0)}for(b in f)f.hasOwnProperty(b)&&g.push(H[b]);return g}function p(){try{var a=Intl.DateTimeFormat().resolvedOptions().timeZone,b=H[r(a)];if(b)return b;z("Moment Timezone found "+a+" from the Intl api, but did not have that data loaded.")}catch(c){}var d,e,f,g=l(),h=g.length,i=o(g),k=[];for(e=0;e<i.length;e++){for(d=new j(t(i[e]),h),f=0;h>f;f++)d.scoreOffsetAt(g[f]);k.push(d)}return k.sort(m),k.length>0?k[0].zone.name:void 0}function q(a){return D&&!a||(D=p()),D}function r(a){return(a||"").toLowerCase().replace(/\//g,"_")}function s(a){var b,c,d,e;for("string"==typeof a&&(a=[a]),b=0;b<a.length;b++)d=a[b].split("|"),c=d[0],e=r(c),F[e]=a[b],H[e]=c,d[5]&&n(e,d[2].split(" "))}function t(a,b){a=r(a);var c,d=F[a];return d instanceof h?d:"string"==typeof d?(d=new h(d),F[a]=d,d):G[a]&&b!==t&&(c=t(G[a],t))?(d=F[a]=new h,d._set(c),d.name=H[a],d):null}function u(){var a,b=[];for(a in H)H.hasOwnProperty(a)&&(F[a]||F[G[a]])&&H[a]&&b.push(H[a]);return b.sort()}function v(a){var b,c,d,e;for("string"==typeof a&&(a=[a]),b=0;b<a.length;b++)c=a[b].split("|"),d=r(c[0]),e=r(c[1]),G[d]=e,H[d]=c[0],G[e]=d,H[e]=c[1]}function w(a){s(a.zones),v(a.links),A.dataVersion=a.version}function x(a){return x.didShowError||(x.didShowError=!0,z("moment.tz.zoneExists('"+a+"') has been deprecated in favor of !moment.tz.zone('"+a+"')")),!!t(a)}function y(a){return!(!a._a||void 0!==a._tzm)}function z(a){"undefined"!=typeof console&&"function"==typeof console.error&&console.error(a)}function A(b){var c=Array.prototype.slice.call(arguments,0,-1),d=arguments[arguments.length-1],e=t(d),f=a.utc.apply(null,c);return e&&!a.isMoment(b)&&y(f)&&f.add(e.parse(f),"minutes"),f.tz(d),f}function B(a){return function(){return this._z?this._z.abbr(this):a.call(this)}}function C(a){return function(){return this._z=null,a.apply(this,arguments)}}if(void 0!==a.tz)return z("Moment Timezone "+a.tz.version+" was already loaded "+(a.tz.dataVersion?"with data from ":"without any data")+a.tz.dataVersion),a;var D,E="0.5.3",F={},G={},H={},I={},J=a.version.split("."),K=+J[0],L=+J[1];(2>K||2===K&&6>L)&&z("Moment Timezone requires Moment.js >= 2.6.0. You are using Moment.js "+a.version+". See momentjs.com"),h.prototype={_set:function(a){this.name=a.name,this.abbrs=a.abbrs,this.untils=a.untils,this.offsets=a.offsets,this.population=a.population},_index:function(a){var b,c=+a,d=this.untils;for(b=0;b<d.length;b++)if(c<d[b])return b},parse:function(a){var b,c,d,e,f=+a,g=this.offsets,h=this.untils,i=h.length-1;for(e=0;i>e;e++)if(b=g[e],c=g[e+1],d=g[e?e-1:e],c>b&&A.moveAmbiguousForward?b=c:b>d&&A.moveInvalidForward&&(b=d),f<h[e]-6e4*b)return g[e];return g[i]},abbr:function(a){return this.abbrs[this._index(a)]},offset:function(a){return this.offsets[this._index(a)]}},j.prototype.scoreOffsetAt=function(a){this.offsetScore+=Math.abs(this.zone.offset(a.at)-a.offset),this.zone.abbr(a.at).match(/[A-Z]/g).join("")!==a.abbr&&this.abbrScore++},A.version=E,A.dataVersion="",A._zones=F,A._links=G,A._names=H,A.add=s,A.link=v,A.load=w,A.zone=t,A.zoneExists=x,A.guess=q,A.names=u,A.Zone=h,A.unpack=g,A.unpackBase60=c,A.needsOffset=y,A.moveInvalidForward=!0,A.moveAmbiguousForward=!1;var M=a.fn;a.tz=A,a.defaultZone=null,a.updateOffset=function(b,c){var d,e=a.defaultZone;void 0===b._z&&(e&&y(b)&&!b._isUTC&&(b._d=a.utc(b._a)._d,b.utc().add(e.parse(b),"minutes")),b._z=e),b._z&&(d=b._z.offset(b),Math.abs(d)<16&&(d/=60),void 0!==b.utcOffset?b.utcOffset(-d,c):b.zone(d,c))},M.tz=function(b){return b?(this._z=t(b),this._z?a.updateOffset(this):z("Moment Timezone has no data for "+b+". See http://momentjs.com/timezone/docs/#/data-loading/."),this):this._z?this._z.name:void 0},M.zoneName=B(M.zoneName),M.zoneAbbr=B(M.zoneAbbr),M.utc=C(M.utc),a.tz.setDefault=function(b){return(2>K||2===K&&9>L)&&z("Moment Timezone setDefault() requires Moment.js >= 2.9.0. You are using Moment.js "+a.version+"."),a.defaultZone=b?t(b):null,a};var N=a.momentProperties;return"[object Array]"===Object.prototype.toString.call(N)?(N.push("_z"),N.push("_a")):N&&(N._z=null),w({version:"2016c",zones:["Africa/Abidjan|LMT GMT|g.8 0|01|-2ldXH.Q|48e5","Africa/Accra|LMT GMT GHST|.Q 0 -k|012121212121212121212121212121212121212121212121|-26BbX.8 6tzX.8 MnE 1BAk MnE 1BAk MnE 1BAk MnE 1C0k MnE 1BAk MnE 1BAk MnE 1BAk MnE 1C0k MnE 1BAk MnE 1BAk MnE 1BAk MnE 1C0k MnE 1BAk MnE 1BAk MnE 1BAk MnE 1C0k MnE 1BAk MnE 1BAk MnE 1BAk MnE 1C0k MnE 1BAk MnE 1BAk MnE|41e5","Africa/Nairobi|LMT EAT BEAT BEAUT|-2r.g -30 -2u -2J|01231|-1F3Cr.g 3Dzr.g okMu MFXJ|47e5","Africa/Algiers|PMT WET WEST CET CEST|-9.l 0 -10 -10 -20|0121212121212121343431312123431213|-2nco9.l cNb9.l HA0 19A0 1iM0 11c0 1oo0 Wo0 1rc0 QM0 1EM0 UM0 DA0 Imo0 rd0 De0 9Xz0 1fb0 1ap0 16K0 2yo0 mEp0 hwL0 jxA0 11A0 dDd0 17b0 11B0 1cN0 2Dy0 1cN0 1fB0 1cL0|26e5","Africa/Lagos|LMT WAT|-d.A -10|01|-22y0d.A|17e6","Africa/Bissau|LMT WAT GMT|12.k 10 0|012|-2ldWV.E 2xonV.E|39e4","Africa/Maputo|LMT CAT|-2a.k -20|01|-2GJea.k|26e5","Africa/Cairo|EET EEST|-20 -30|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-1bIO0 vb0 1ip0 11z0 1iN0 1nz0 12p0 1pz0 10N0 1pz0 16p0 1jz0 s3d0 Vz0 1oN0 11b0 1oO0 10N0 1pz0 10N0 1pb0 10N0 1pb0 10N0 1pb0 10N0 1pz0 10N0 1pb0 10N0 1pb0 11d0 1oL0 11d0 1pb0 11d0 1oL0 11d0 1oL0 11d0 1oL0 11d0 1pb0 11d0 1oL0 11d0 1oL0 11d0 1oL0 11d0 1pb0 11d0 1oL0 11d0 1oL0 11d0 1oL0 11d0 1pb0 11d0 1oL0 11d0 1WL0 rd0 1Rz0 wp0 1pb0 11d0 1oL0 11d0 1oL0 11d0 1oL0 11d0 1pb0 11d0 1qL0 Xd0 1oL0 11d0 1oL0 11d0 1pb0 11d0 1oL0 11d0 1oL0 11d0 1ny0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 WL0 1qN0 Rb0 1wp0 On0 1zd0 Lz0 1EN0 Fb0 c10 8n0 8Nd0 gL0 e10 mn0|15e6","Africa/Casablanca|LMT WET WEST CET|u.k 0 -10 -10|0121212121212121213121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2gMnt.E 130Lt.E rb0 Dd0 dVb0 b6p0 TX0 EoB0 LL0 gnd0 rz0 43d0 AL0 1Nd0 XX0 1Cp0 pz0 dEp0 4mn0 SyN0 AL0 1Nd0 wn0 1FB0 Db0 1zd0 Lz0 1Nf0 wM0 co0 go0 1o00 s00 dA0 vc0 11A0 A00 e00 y00 11A0 uM0 e00 Dc0 11A0 s00 e00 IM0 WM0 mo0 gM0 LA0 WM0 jA0 e00 Rc0 11A0 e00 e00 U00 11A0 8o0 e00 11A0 11A0 5A0 e00 17c0 1fA0 1a00 1a00 1fA0 17c0 1io0 14o0 1lc0 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1lc0 14o0 1fA0|32e5","Africa/Ceuta|WET WEST CET CEST|0 -10 -10 -20|010101010101010101010232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-25KN0 11z0 drd0 18o0 3I00 17c0 1fA0 1a00 1io0 1a00 1y7p0 LL0 gnd0 rz0 43d0 AL0 1Nd0 XX0 1Cp0 pz0 dEp0 4VB0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|85e3","Africa/El_Aaiun|LMT WAT WET WEST|Q.M 10 0 -10|01232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-1rDz7.c 1GVA7.c 6L0 AL0 1Nd0 XX0 1Cp0 pz0 1cBB0 AL0 1Nd0 wn0 1FB0 Db0 1zd0 Lz0 1Nf0 wM0 co0 go0 1o00 s00 dA0 vc0 11A0 A00 e00 y00 11A0 uM0 e00 Dc0 11A0 s00 e00 IM0 WM0 mo0 gM0 LA0 WM0 jA0 e00 Rc0 11A0 e00 e00 U00 11A0 8o0 e00 11A0 11A0 5A0 e00 17c0 1fA0 1a00 1a00 1fA0 17c0 1io0 14o0 1lc0 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1lc0 14o0 1fA0|20e4","Africa/Johannesburg|SAST SAST SAST|-1u -20 -30|012121|-2GJdu 1Ajdu 1cL0 1cN0 1cL0|84e5","Africa/Khartoum|LMT CAT CAST EAT|-2a.8 -20 -30 -30|01212121212121212121212121212121213|-1yW2a.8 1zK0a.8 16L0 1iN0 17b0 1jd0 17b0 1ip0 17z0 1i10 17X0 1hB0 18n0 1hd0 19b0 1gp0 19z0 1iN0 17b0 1ip0 17z0 1i10 18n0 1hd0 18L0 1gN0 19b0 1gp0 19z0 1iN0 17z0 1i10 17X0 yGd0|51e5","Africa/Monrovia|MMT LRT GMT|H.8 I.u 0|012|-23Lzg.Q 29s01.m|11e5","Africa/Ndjamena|LMT WAT WAST|-10.c -10 -20|0121|-2le10.c 2J3c0.c Wn0|13e5","Africa/Tripoli|LMT CET CEST EET|-Q.I -10 -20 -20|012121213121212121212121213123123|-21JcQ.I 1hnBQ.I vx0 4iP0 xx0 4eN0 Bb0 7ip0 U0n0 A10 1db0 1cN0 1db0 1dd0 1db0 1eN0 1bb0 1e10 1cL0 1c10 1db0 1dd0 1db0 1cN0 1db0 1q10 fAn0 1ep0 1db0 AKq0 TA0 1o00|11e5","Africa/Tunis|PMT CET CEST|-9.l -10 -20|0121212121212121212121212121212121|-2nco9.l 18pa9.l 1qM0 DA0 3Tc0 11B0 1ze0 WM0 7z0 3d0 14L0 1cN0 1f90 1ar0 16J0 1gXB0 WM0 1rA0 11c0 nwo0 Ko0 1cM0 1cM0 1rA0 10M0 zuM0 10N0 1aN0 1qM0 WM0 1qM0 11A0 1o00|20e5","Africa/Windhoek|SWAT SAST SAST CAT WAT WAST|-1u -20 -30 -20 -10 -20|012134545454545454545454545454545454545454545454545454545454545454545454545454545454545454545|-2GJdu 1Ajdu 1cL0 1SqL0 9NA0 11D0 1nX0 11B0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 11B0 1nX0 11B0|32e4","America/Adak|NST NWT NPT BST BDT AHST HST HDT|b0 a0 a0 b0 a0 a0 a0 90|012034343434343434343434343434343456767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676|-17SX0 8wW0 iB0 Qlb0 52O0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 cm0 10q0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|326","America/Anchorage|CAT CAWT CAPT AHST AHDT YST AKST AKDT|a0 90 90 a0 90 90 90 80|012034343434343434343434343434343456767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676|-17T00 8wX0 iA0 Qlb0 52O0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 cm0 10q0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|30e4","America/Port_of_Spain|LMT AST|46.4 40|01|-2kNvR.U|43e3","America/Araguaina|LMT BRT BRST|3c.M 30 20|0121212121212121212121212121212121212121212121212121|-2glwL.c HdKL.c 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 dMN0 Lz0 1zd0 Rb0 1wN0 Wn0 1tB0 Rb0 1tB0 WL0 1tB0 Rb0 1zd0 On0 1HB0 FX0 ny10 Lz0|14e4","America/Argentina/Buenos_Aires|CMT ART ARST ART ARST|4g.M 40 30 30 20|0121212121212121212121212121212121212121213434343434343234343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Rb0 1wp0 Rb0 1wp0 TX0 g0p0 10M0 j3c0 uL0 1qN0 WL0","America/Argentina/Catamarca|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|0121212121212121212121212121212121212121213434343454343235343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Rb0 1wq0 Ra0 1wp0 TX0 g0p0 10M0 ako0 7B0 8zb0 uL0","America/Argentina/Cordoba|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|0121212121212121212121212121212121212121213434343454343234343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Rb0 1wq0 Ra0 1wp0 TX0 g0p0 10M0 j3c0 uL0 1qN0 WL0","America/Argentina/Jujuy|CMT ART ARST ART ARST WART WARST|4g.M 40 30 30 20 40 30|01212121212121212121212121212121212121212134343456543432343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1ze0 TX0 1ld0 WK0 1wp0 TX0 g0p0 10M0 j3c0 uL0","America/Argentina/La_Rioja|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|01212121212121212121212121212121212121212134343434534343235343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Qn0 qO0 16n0 Rb0 1wp0 TX0 g0p0 10M0 ako0 7B0 8zb0 uL0","America/Argentina/Mendoza|CMT ART ARST ART ARST WART WARST|4g.M 40 30 30 20 40 30|0121212121212121212121212121212121212121213434345656543235343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1u20 SL0 1vd0 Tb0 1wp0 TW0 g0p0 10M0 agM0 Op0 7TX0 uL0","America/Argentina/Rio_Gallegos|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|0121212121212121212121212121212121212121213434343434343235343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Rb0 1wp0 Rb0 1wp0 TX0 g0p0 10M0 ako0 7B0 8zb0 uL0","America/Argentina/Salta|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|01212121212121212121212121212121212121212134343434543432343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Rb0 1wq0 Ra0 1wp0 TX0 g0p0 10M0 j3c0 uL0","America/Argentina/San_Juan|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|01212121212121212121212121212121212121212134343434534343235343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Qn0 qO0 16n0 Rb0 1wp0 TX0 g0p0 10M0 ak00 m10 8lb0 uL0","America/Argentina/San_Luis|CMT ART ARST ART ARST WART WARST|4g.M 40 30 30 20 40 30|01212121212121212121212121212121212121212134343456536353465653|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 XX0 1q20 SL0 AN0 kin0 10M0 ak00 m10 8lb0 8L0 jd0 1qN0 WL0 1qN0","America/Argentina/Tucuman|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|012121212121212121212121212121212121212121343434345434323534343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Rb0 1wq0 Ra0 1wp0 TX0 g0p0 10M0 ako0 4N0 8BX0 uL0 1qN0 WL0","America/Argentina/Ushuaia|CMT ART ARST ART ARST WART|4g.M 40 30 30 20 40|0121212121212121212121212121212121212121213434343434343235343|-20UHH.c pKnH.c Mn0 1iN0 Tb0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 1C10 LX0 1C10 LX0 1C10 LX0 1C10 Mn0 MN0 2jz0 MN0 4lX0 u10 5Lb0 1pB0 Fnz0 u10 uL0 1vd0 SL0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 zvd0 Bz0 1tB0 TX0 1wp0 Rb0 1wp0 Rb0 1wp0 TX0 g0p0 10M0 ajA0 8p0 8zb0 uL0","America/Curacao|LMT ANT AST|4z.L 4u 40|012|-2kV7o.d 28KLS.d|15e4","America/Asuncion|AMT PYT PYT PYST|3O.E 40 30 30|012131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313|-1x589.k 1DKM9.k 3CL0 3Dd0 10L0 1pB0 10n0 1pB0 10n0 1pB0 1cL0 1dd0 1db0 1dd0 1cL0 1dd0 1cL0 1dd0 1cL0 1dd0 1db0 1dd0 1cL0 1dd0 1cL0 1dd0 1cL0 1dd0 1db0 1dd0 1cL0 1lB0 14n0 1dd0 1cL0 1fd0 WL0 1rd0 1aL0 1dB0 Xz0 1qp0 Xb0 1qN0 10L0 1rB0 TX0 1tB0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1qN0 1cL0 WN0 1qL0 11B0 1nX0 1ip0 WL0 1qN0 WL0 1qN0 WL0 1tB0 TX0 1tB0 TX0 1tB0 19X0 1a10 1fz0 1a10 1fz0 1cN0 17b0 1ip0 17b0 1ip0 17b0 1ip0 19X0 1fB0 19X0 1fB0 19X0 1ip0 17b0 1ip0 17b0 1ip0 19X0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1ip0 17b0 1ip0 17b0 1ip0 19X0 1fB0 19X0 1fB0 19X0 1ip0 17b0 1ip0 17b0 1ip0 19X0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1ip0 17b0 1ip0 17b0 1ip0|28e5","America/Atikokan|CST CDT CWT CPT EST|60 50 50 50 50|0101234|-25TQ0 1in0 Rnb0 3je0 8x30 iw0|28e2","America/Bahia|LMT BRT BRST|2y.4 30 20|01212121212121212121212121212121212121212121212121212121212121|-2glxp.U HdLp.U 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 1EN0 Lz0 1C10 IL0 1HB0 Db0 1HB0 On0 1zd0 On0 1zd0 Lz0 1zd0 Rb0 1wN0 Wn0 1tB0 Rb0 1tB0 WL0 1tB0 Rb0 1zd0 On0 1HB0 FX0 l5B0 Rb0|27e5","America/Bahia_Banderas|LMT MST CST PST MDT CDT|71 70 60 80 60 50|0121212131414141414141414141414141414152525252525252525252525252525252525252525252525252525252|-1UQF0 deL0 8lc0 17c0 10M0 1dd0 otX0 gmN0 P2N0 13Vd0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nW0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0|84e3","America/Barbados|LMT BMT AST ADT|3W.t 3W.t 40 30|01232323232|-1Q0I1.v jsM0 1ODC1.v IL0 1ip0 17b0 1ip0 17b0 1ld0 13b0|28e4","America/Belem|LMT BRT BRST|3d.U 30 20|012121212121212121212121212121|-2glwK.4 HdKK.4 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0|20e5","America/Belize|LMT CST CHDT CDT|5Q.M 60 5u 50|01212121212121212121212121212121212121212121212121213131|-2kBu7.c fPA7.c Onu 1zcu Rbu 1wou Rbu 1wou Rbu 1zcu Onu 1zcu Onu 1zcu Rbu 1wou Rbu 1wou Rbu 1wou Rbu 1zcu Onu 1zcu Onu 1zcu Rbu 1wou Rbu 1wou Rbu 1zcu Onu 1zcu Onu 1zcu Onu 1zcu Rbu 1wou Rbu 1wou Rbu 1zcu Onu 1zcu Onu 1zcu Rbu 1wou Rbu 1f0Mu qn0 lxB0 mn0|57e3","America/Blanc-Sablon|AST ADT AWT APT|40 30 30 30|010230|-25TS0 1in0 UGp0 8x50 iu0|11e2","America/Boa_Vista|LMT AMT AMST|42.E 40 30|0121212121212121212121212121212121|-2glvV.k HdKV.k 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 smp0 WL0 1tB0 2L0|62e2","America/Bogota|BMT COT COST|4U.g 50 40|0121|-2eb73.I 38yo3.I 2en0|90e5","America/Boise|PST PDT MST MWT MPT MDT|80 70 70 60 60 60|0101023425252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252|-261q0 1nX0 11B0 1nX0 8C10 JCL0 8x20 ix0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 Dd0 1Kn0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|21e4","America/Cambridge_Bay|zzz MST MWT MPT MDDT MDT CST CDT EST|0 70 60 60 50 60 60 50 50|0123141515151515151515151515151515151515151515678651515151515151515151515151515151515151515151515151515151515151515151515151|-21Jc0 RO90 8x20 ix0 LCL0 1fA0 zgO0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11A0 1nX0 2K0 WQ0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|15e2","America/Campo_Grande|LMT AMT AMST|3C.s 40 30|012121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212|-2glwl.w HdLl.w 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 1EN0 Lz0 1C10 IL0 1HB0 Db0 1HB0 On0 1zd0 On0 1zd0 Lz0 1zd0 Rb0 1wN0 Wn0 1tB0 Rb0 1tB0 WL0 1tB0 Rb0 1zd0 On0 1HB0 FX0 1C10 Lz0 1Ip0 HX0 1zd0 On0 1HB0 IL0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 Rb0 1zd0 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 Rb0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10 Lz0 1C10 On0 1zd0 Rb0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0|77e4","America/Cancun|LMT CST EST EDT CDT|5L.4 60 50 40 50|0123232341414141414141414141414141414141412|-1UQG0 2q2o0 yLB0 1lb0 14p0 1lb0 14p0 Lz0 xB0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 Dd0|63e4","America/Caracas|CMT VET VET|4r.E 4u 40|0121|-2kV7w.k 28KM2.k 1IwOu|29e5","America/Cayenne|LMT GFT GFT|3t.k 40 30|012|-2mrwu.E 2gWou.E|58e3","America/Panama|CMT EST|5j.A 50|01|-2uduE.o|15e5","America/Chicago|CST CDT EST CWT CPT|60 50 50 50 50|01010101010101010101010101010101010102010101010103401010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261s0 1nX0 11B0 1nX0 1wp0 TX0 WN0 1qL0 1cN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 11B0 1Hz0 14p0 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 RB0 8x30 iw0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|92e5","America/Chihuahua|LMT MST CST CDT MDT|74.k 70 60 50 60|0121212323241414141414141414141414141414141414141414141414141414141414141414141414141414141|-1UQF0 deL0 8lc0 17c0 10M0 1dd0 2zQN0 1lb0 14p0 1lb0 14q0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0|81e4","America/Costa_Rica|SJMT CST CDT|5A.d 60 50|0121212121|-1Xd6n.L 2lu0n.L Db0 1Kp0 Db0 pRB0 15b0 1kp0 mL0|12e5","America/Creston|MST PST|70 80|010|-29DR0 43B0|53e2","America/Cuiaba|LMT AMT AMST|3I.k 40 30|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212|-2glwf.E HdLf.E 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 1EN0 Lz0 1C10 IL0 1HB0 Db0 1HB0 On0 1zd0 On0 1zd0 Lz0 1zd0 Rb0 1wN0 Wn0 1tB0 Rb0 1tB0 WL0 1tB0 Rb0 1zd0 On0 1HB0 FX0 4a10 HX0 1zd0 On0 1HB0 IL0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 Rb0 1zd0 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 Rb0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10 Lz0 1C10 On0 1zd0 Rb0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0|54e4","America/Danmarkshavn|LMT WGT WGST GMT|1e.E 30 20 0|01212121212121212121212121212121213|-2a5WJ.k 2z5fJ.k 19U0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 DC0|8","America/Dawson|YST YDT YWT YPT YDDT PST PDT|90 80 80 80 70 80 70|0101023040565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565|-25TN0 1in0 1o10 13V0 Ser0 8x00 iz0 LCL0 1fA0 jrA0 fNd0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|13e2","America/Dawson_Creek|PST PDT PWT PPT MST|80 70 70 70 70|0102301010101010101010101010101010101010101010101010101014|-25TO0 1in0 UGp0 8x10 iy0 3NB0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 ML0|12e3","America/Denver|MST MDT MWT MPT|70 60 60 60|01010101023010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261r0 1nX0 11B0 1nX0 11B0 1qL0 WN0 mn0 Ord0 8x20 ix0 LCN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|26e5","America/Detroit|LMT CST EST EWT EPT EDT|5w.b 60 50 40 40 40|01234252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252|-2Cgir.N peqr.N 156L0 8x40 iv0 6fd0 11z0 Jy10 SL0 dnB0 1cL0 s10 1Vz0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|37e5","America/Edmonton|LMT MST MDT MWT MPT|7x.Q 70 60 60 60|01212121212121341212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2yd4q.8 shdq.8 1in0 17d0 hz0 2dB0 1fz0 1a10 11z0 1qN0 WL0 1qN0 11z0 IGN0 8x20 ix0 3NB0 11z0 LFB0 1cL0 3Cp0 1cL0 66N0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|10e5","America/Eirunepe|LMT ACT ACST AMT|4D.s 50 40 40|0121212121212121212121212121212131|-2glvk.w HdLk.w 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 dPB0 On0 yTd0 d5X0|31e3","America/El_Salvador|LMT CST CDT|5U.M 60 50|012121|-1XiG3.c 2Fvc3.c WL0 1qN0 WL0|11e5","America/Tijuana|LMT MST PST PDT PWT PPT|7M.4 70 80 70 70 70|012123245232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-1UQE0 4PX0 8mM0 8lc0 SN0 1cL0 pHB0 83r0 zI0 5O10 1Rz0 cOP0 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 BUp0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 U10 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|20e5","America/Fort_Nelson|PST PDT PWT PPT MST|80 70 70 70 70|01023010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010104|-25TO0 1in0 UGp0 8x10 iy0 3NB0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0|39e2","America/Fort_Wayne|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|010101023010101010101010101040454545454545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 QI10 Db0 RB0 8x30 iw0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 5Tz0 1o10 qLb0 1cL0 1cN0 1cL0 1qhd0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Fortaleza|LMT BRT BRST|2y 30 20|0121212121212121212121212121212121212121|-2glxq HdLq 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 nsp0 WL0 1tB0 5z0 2mN0 On0|34e5","America/Glace_Bay|LMT AST ADT AWT APT|3X.M 40 30 30 30|012134121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2IsI0.c CwO0.c 1in0 UGp0 8x50 iu0 iq10 11z0 Jg10 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|19e3","America/Godthab|LMT WGT WGST|3q.U 30 20|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2a5Ux.4 2z5dx.4 19U0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|17e3","America/Goose_Bay|NST NDT NST NDT NWT NPT AST ADT ADDT|3u.Q 2u.Q 3u 2u 2u 2u 40 30 20|010232323232323245232323232323232323232323232323232323232326767676767676767676767676767676767676767676768676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676|-25TSt.8 1in0 DXb0 2HbX.8 WL0 1qN0 WL0 1qN0 WL0 1tB0 TX0 1tB0 WL0 1qN0 WL0 1qN0 7UHu itu 1tB0 WL0 1qN0 WL0 1qN0 WL0 1qN0 WL0 1tB0 WL0 1ld0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 S10 g0u 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14n1 1lb0 14p0 1nW0 11C0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zcX Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|76e2","America/Grand_Turk|KMT EST EDT AST|57.b 50 40 40|0121212121212121212121212121212121212121212121212121212121212121212121212123|-2l1uQ.N 2HHBQ.N 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|37e2","America/Guatemala|LMT CST CDT|62.4 60 50|0121212121|-24KhV.U 2efXV.U An0 mtd0 Nz0 ifB0 17b0 zDB0 11z0|13e5","America/Guayaquil|QMT ECT|5e 50|01|-1yVSK|27e5","America/Guyana|LMT GBGT GYT GYT GYT|3Q.E 3J 3J 30 40|01234|-2dvU7.k 24JzQ.k mlc0 Bxbf|80e4","America/Halifax|LMT AST ADT AWT APT|4e.o 40 30 30 30|0121212121212121212121212121212121212121212121212134121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2IsHJ.A xzzJ.A 1db0 3I30 1in0 3HX0 IL0 1E10 ML0 1yN0 Pb0 1Bd0 Mn0 1Bd0 Rz0 1w10 Xb0 1w10 LX0 1w10 Xb0 1w10 Lz0 1C10 Jz0 1E10 OL0 1yN0 Un0 1qp0 Xb0 1qp0 11X0 1w10 Lz0 1HB0 LX0 1C10 FX0 1w10 Xb0 1qp0 Xb0 1BB0 LX0 1td0 Xb0 1qp0 Xb0 Rf0 8x50 iu0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 3Qp0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 3Qp0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 6i10 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|39e4","America/Havana|HMT CST CDT|5t.A 50 40|012121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1Meuu.o 72zu.o ML0 sld0 An0 1Nd0 Db0 1Nd0 An0 6Ep0 An0 1Nd0 An0 JDd0 Mn0 1Ap0 On0 1fd0 11X0 1qN0 WL0 1wp0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 14n0 1ld0 14L0 1kN0 15b0 1kp0 1cL0 1cN0 1fz0 1a10 1fz0 1fB0 11z0 14p0 1nX0 11B0 1nX0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 14n0 1ld0 14n0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 1a10 1in0 1a10 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 17c0 1o00 11A0 1qM0 11A0 1o00 11A0 1o00 14o0 1lc0 14o0 1lc0 11A0 6i00 Rc0 1wo0 U00 1tA0 Rc0 1wo0 U00 1wo0 U00 1zc0 U00 1qM0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0|21e5","America/Hermosillo|LMT MST CST PST MDT|7n.Q 70 60 80 60|0121212131414141|-1UQF0 deL0 8lc0 17c0 10M0 1dd0 otX0 gmN0 P2N0 13Vd0 1lb0 14p0 1lb0 14p0 1lb0|64e4","America/Indiana/Knox|CST CDT CWT CPT EST|60 50 50 50 50|0101023010101010101010101010101010101040101010101010101010101010101010101010101010101010141010101010101010101010101010101010101010101010101010101010101010|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 3NB0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 1cL0 1cN0 11z0 1o10 11z0 1o10 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 3Cn0 8wp0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 z8o0 1o00 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Indiana/Marengo|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|0101023010101010101010104545454545414545454545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 dyN0 11z0 6fd0 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 jrz0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1VA0 LA0 1BX0 1e6p0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Indiana/Petersburg|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|01010230101010101010101010104010101010101010101010141014545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 njX0 WN0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 3Fb0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 19co0 1o00 Rd0 1zb0 Oo0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Indiana/Tell_City|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|01010230101010101010101010101010454541010101010101010101010101010101010101010101010101010101010101010|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 1o10 11z0 g0p0 11z0 1o10 11z0 1qL0 WN0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 WL0 1qN0 1cL0 1cN0 1cL0 1cN0 caL0 1cL0 1cN0 1cL0 1qhd0 1o00 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Indiana/Vevay|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|010102304545454545454545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 kPB0 Awn0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1lnd0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Indiana/Vincennes|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|01010230101010101010101010101010454541014545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 1o10 11z0 g0p0 11z0 1o10 11z0 1qL0 WN0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 WL0 1qN0 1cL0 1cN0 1cL0 1cN0 caL0 1cL0 1cN0 1cL0 1qhd0 1o00 Rd0 1zb0 Oo0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Indiana/Winamac|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|01010230101010101010101010101010101010454541054545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 1cL0 1cN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 jrz0 1cL0 1cN0 1cL0 1qhd0 1o00 Rd0 1za0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Inuvik|zzz PST PDDT MST MDT|0 80 60 70 60|0121343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343|-FnA0 tWU0 1fA0 wPe0 2pz0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|35e2","America/Iqaluit|zzz EWT EPT EST EDDT EDT CST CDT|0 40 40 50 30 40 60 50|01234353535353535353535353535353535353535353567353535353535353535353535353535353535353535353535353535353535353535353535353|-16K00 7nX0 iv0 LCL0 1fA0 zgO0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11C0 1nX0 11A0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|67e2","America/Jamaica|KMT EST EDT|57.b 50 40|0121212121212121212121|-2l1uQ.N 2uM1Q.N 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0|94e4","America/Juneau|PST PWT PPT PDT YDT YST AKST AKDT|80 70 70 70 80 90 90 80|01203030303030303030303030403030356767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676|-17T20 8x10 iy0 Vo10 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cM0 1cM0 1cL0 1cN0 1fz0 1a10 1fz0 co0 10q0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|33e3","America/Kentucky/Louisville|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|0101010102301010101010101010101010101454545454545414545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 3Fd0 Nb0 LPd0 11z0 RB0 8x30 iw0 Bb0 10N0 2bB0 8in0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 xz0 gso0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1VA0 LA0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Kentucky/Monticello|CST CDT CWT CPT EST EDT|60 50 50 50 50 40|0101023010101010101010101010101010101010101010101010101010101010101010101454545454545454545454545454545454545454545454545454545454545454545454545454|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 SWp0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11A0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/La_Paz|CMT BOST BOT|4w.A 3w.A 40|012|-1x37r.o 13b0|19e5","America/Lima|LMT PET PEST|58.A 50 40|0121212121212121|-2tyGP.o 1bDzP.o zX0 1aN0 1cL0 1cN0 1cL0 1PrB0 zX0 1O10 zX0 6Gp0 zX0 98p0 zX0|11e6","America/Los_Angeles|PST PDT PWT PPT|80 70 70 70|010102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261q0 1nX0 11B0 1nX0 SgN0 8x10 iy0 5Wp0 1Vb0 3dB0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|15e6","America/Maceio|LMT BRT BRST|2m.Q 30 20|012121212121212121212121212121212121212121|-2glxB.8 HdLB.8 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 dMN0 Lz0 8Q10 WL0 1tB0 5z0 2mN0 On0|93e4","America/Managua|MMT CST EST CDT|5J.c 60 50 50|0121313121213131|-1quie.M 1yAMe.M 4mn0 9Up0 Dz0 1K10 Dz0 s3F0 1KH0 DB0 9In0 k8p0 19X0 1o30 11y0|22e5","America/Manaus|LMT AMT AMST|40.4 40 30|01212121212121212121212121212121|-2glvX.U HdKX.U 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 dPB0 On0|19e5","America/Martinique|FFMT AST ADT|44.k 40 30|0121|-2mPTT.E 2LPbT.E 19X0|39e4","America/Matamoros|LMT CST CDT|6E 60 50|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1UQG0 2FjC0 1nX0 i6p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 U10 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|45e4","America/Mazatlan|LMT MST CST PST MDT|75.E 70 60 80 60|0121212131414141414141414141414141414141414141414141414141414141414141414141414141414141414141|-1UQF0 deL0 8lc0 17c0 10M0 1dd0 otX0 gmN0 P2N0 13Vd0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0|44e4","America/Menominee|CST CDT CWT CPT EST|60 50 50 50 50|01010230101041010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 1o10 11z0 LCN0 1fz0 6410 9Jb0 1cM0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|85e2","America/Merida|LMT CST EST CDT|5W.s 60 50 50|0121313131313131313131313131313131313131313131313131313131313131313131313131313131313131|-1UQG0 2q2o0 2hz0 wu30 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0|11e5","America/Metlakatla|PST PWT PPT PDT AKST AKDT|80 70 70 70 90 80|0120303030303030303030303030303030454545454545454545454545454545454545454545454|-17T20 8x10 iy0 Vo10 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1hU10 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|14e2","America/Mexico_City|LMT MST CST CDT CWT|6A.A 70 60 50 50|012121232324232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-1UQF0 deL0 8lc0 17c0 10M0 1dd0 gEn0 TX0 3xd0 Jb0 6zB0 SL0 e5d0 17b0 1Pff0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0|20e6","America/Miquelon|LMT AST PMST PMDT|3I.E 40 30 20|012323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-2mKkf.k 2LTAf.k gQ10 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|61e2","America/Moncton|EST AST ADT AWT APT|50 40 30 30 30|012121212121212121212134121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2IsH0 CwN0 1in0 zAo0 An0 1Nd0 An0 1Nd0 An0 1Nd0 An0 1Nd0 An0 1Nd0 An0 1K10 Lz0 1zB0 NX0 1u10 Wn0 S20 8x50 iu0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 3Cp0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14n1 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 ReX 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|64e3","America/Monterrey|LMT CST CDT|6F.g 60 50|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1UQG0 2FjC0 1nX0 i6p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0|41e5","America/Montevideo|MMT UYT UYHST UYST UYT UYHST|3I.I 3u 30 20 30 2u|012121212121212121212121213434343434345454543453434343434343434343434343434343434343434|-20UIf.g 8jzJ.g 1cLu 1dcu 1cLu 1dcu 1cLu ircu 11zu 1o0u 11zu 1o0u 11zu 1qMu WLu 1qMu WLu 1qMu WLu 1qMu 11zu 1o0u 11zu NAu 11bu 2iMu zWu Dq10 19X0 pd0 jz0 cm10 19X0 1fB0 1on0 11d0 1oL0 1nB0 1fzu 1aou 1fzu 1aou 1fzu 3nAu Jb0 3MN0 1SLu 4jzu 2PB0 Lb0 3Dd0 1pb0 ixd0 An0 1MN0 An0 1wp0 On0 1wp0 Rb0 1zd0 On0 1wp0 Rb0 s8p0 1fB0 1ip0 11z0 1ld0 14n0 1o10 11z0 1o10 11z0 1o10 14n0 1ld0 14n0 1ld0 14n0 1o10 11z0 1o10 11z0 1o10 11z0|17e5","America/Toronto|EST EDT EWT EPT|50 40 40 40|01010101010101010101010101010101010101010101012301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-25TR0 1in0 11Wu 1nzu 1fD0 WJ0 1wr0 Nb0 1Ap0 On0 1zd0 On0 1wp0 TX0 1tB0 TX0 1tB0 TX0 1tB0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 4kM0 8x40 iv0 1o10 11z0 1nX0 11z0 1o10 11z0 1o10 1qL0 11D0 1nX0 11B0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|65e5","America/Nassau|LMT EST EDT|59.u 50 40|012121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2kNuO.u 26XdO.u 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|24e4","America/New_York|EST EDT EWT EPT|50 40 40 40|01010101010101010101010101010101010101010101010102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261t0 1nX0 11B0 1nX0 11B0 1qL0 1a10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 RB0 8x40 iv0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|21e6","America/Nipigon|EST EDT EWT EPT|50 40 40 40|010123010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-25TR0 1in0 Rnb0 3je0 8x40 iv0 19yN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|16e2","America/Nome|NST NWT NPT BST BDT YST AKST AKDT|b0 a0 a0 b0 a0 90 90 80|012034343434343434343434343434343456767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676767676|-17SX0 8wW0 iB0 Qlb0 52O0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 cl0 10q0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|38e2","America/Noronha|LMT FNT FNST|29.E 20 10|0121212121212121212121212121212121212121|-2glxO.k HdKO.k 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 nsp0 WL0 1tB0 2L0 2pB0 On0|30e2","America/North_Dakota/Beulah|MST MDT MWT MPT CST CDT|70 60 60 60 60 50|010102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101014545454545454545454545454545454545454545454545454545454|-261r0 1nX0 11B0 1nX0 SgN0 8x20 ix0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Oo0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/North_Dakota/Center|MST MDT MWT MPT CST CDT|70 60 60 60 60 50|010102301010101010101010101010101010101010101010101010101014545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454|-261r0 1nX0 11B0 1nX0 SgN0 8x20 ix0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14o0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/North_Dakota/New_Salem|MST MDT MWT MPT CST CDT|70 60 60 60 60 50|010102301010101010101010101010101010101010101010101010101010101010101010101010101454545454545454545454545454545454545454545454545454545454545454545454|-261r0 1nX0 11B0 1nX0 SgN0 8x20 ix0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14o0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","America/Ojinaga|LMT MST CST CDT MDT|6V.E 70 60 50 60|0121212323241414141414141414141414141414141414141414141414141414141414141414141414141414141|-1UQF0 deL0 8lc0 17c0 10M0 1dd0 2zQN0 1lb0 14p0 1lb0 14q0 1lb0 14p0 1nX0 11B0 1nX0 1fB0 WL0 1fB0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 U10 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|23e3","America/Pangnirtung|zzz AST AWT APT ADDT ADT EDT EST CST CDT|0 40 30 30 20 30 40 50 60 50|012314151515151515151515151515151515167676767689767676767676767676767676767676767676767676767676767676767676767676767676767|-1XiM0 PnG0 8x50 iu0 LCL0 1fA0 zgO0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1o00 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11C0 1nX0 11A0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|14e2","America/Paramaribo|LMT PMT PMT NEGT SRT SRT|3E.E 3E.Q 3E.A 3u 3u 30|012345|-2nDUj.k Wqo0.c qanX.I 1dmLN.o lzc0|24e4","America/Phoenix|MST MDT MWT|70 60 60|01010202010|-261r0 1nX0 11B0 1nX0 SgN0 4Al1 Ap0 1db0 SWqX 1cL0|42e5","America/Port-au-Prince|PPMT EST EDT|4N 50 40|01212121212121212121212121212121212121212121|-28RHb 2FnMb 19X0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14q0 1o00 11A0 1o00 11A0 1o00 14o0 1lc0 14o0 1lc0 14o0 1o00 11A0 1o00 11A0 1o00 14o0 1lc0 14o0 1lc0 i6n0 1nX0 11B0 1nX0 d430 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|23e5","America/Rio_Branco|LMT ACT ACST AMT|4v.c 50 40 40|01212121212121212121212121212131|-2glvs.M HdLs.M 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 NBd0 d5X0|31e4","America/Porto_Velho|LMT AMT AMST|4f.A 40 30|012121212121212121212121212121|-2glvI.o HdKI.o 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0|37e4","America/Puerto_Rico|AST AWT APT|40 30 30|0120|-17lU0 7XT0 iu0|24e5","America/Rainy_River|CST CDT CWT CPT|60 50 50 50|010123010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-25TQ0 1in0 Rnb0 3je0 8x30 iw0 19yN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|842","America/Rankin_Inlet|zzz CST CDDT CDT EST|0 60 40 50 50|012131313131313131313131313131313131313131313431313131313131313131313131313131313131313131313131313131313131313131313131|-vDc0 keu0 1fA0 zgO0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|26e2","America/Recife|LMT BRT BRST|2j.A 30 20|0121212121212121212121212121212121212121|-2glxE.o HdLE.o 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 nsp0 WL0 1tB0 2L0 2pB0 On0|33e5","America/Regina|LMT MST MDT MWT MPT CST|6W.A 70 60 60 60 60|012121212121212121212121341212121212121212121212121215|-2AD51.o uHe1.o 1in0 s2L0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 66N0 1cL0 1cN0 19X0 1fB0 1cL0 1fB0 1cL0 1cN0 1cL0 M30 8x20 ix0 1ip0 1cL0 1ip0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 3NB0 1cL0 1cN0|19e4","America/Resolute|zzz CST CDDT CDT EST|0 60 40 50 50|012131313131313131313131313131313131313131313431313131313431313131313131313131313131313131313131313131313131313131313131|-SnA0 GWS0 1fA0 zgO0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|229","America/Santarem|LMT AMT AMST BRT|3C.M 40 30 30|0121212121212121212121212121213|-2glwl.c HdLl.c 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 qe10 xb0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 NBd0|21e4","America/Santiago|SMT CLT CLT CLST CLST|4G.K 50 40 40 30|010203131313131212421242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424|-2q2jh.e fJAh.e 5knG.K 1Vzh.e jRAG.K 1pbh.e 11d0 1oL0 11d0 1oL0 11d0 1oL0 11d0 1pb0 11d0 nHX0 op0 9Bz0 jb0 1oN0 ko0 Qeo0 WL0 1zd0 On0 1ip0 11z0 1o10 11z0 1qN0 WL0 1ld0 14n0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 WL0 1qN0 1cL0 1cN0 11z0 1o10 11z0 1qN0 WL0 1fB0 19X0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 17b0 1ip0 11z0 1ip0 1fz0 1fB0 11z0 1qN0 WL0 1qN0 WL0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 17b0 1ip0 11z0 1o10 19X0 1fB0 1nX0 G10 1EL0 Op0 1zb0 Rd0 1wn0 Rd0 46n0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0|62e5","America/Santo_Domingo|SDMT EST EDT EHDT AST|4E 50 40 4u 40|01213131313131414|-1ttjk 1lJMk Mn0 6sp0 Lbu 1Cou yLu 1RAu wLu 1QMu xzu 1Q0u xXu 1PAu 13jB0 e00|29e5","America/Sao_Paulo|LMT BRT BRST|36.s 30 20|012121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212|-2glwR.w HdKR.w 1cc0 1e10 1bX0 Ezd0 So0 1vA0 Mn0 1BB0 ML0 1BB0 zX0 pTd0 PX0 2ep0 nz0 1C10 zX0 1C10 LX0 1C10 Mn0 H210 Rb0 1tB0 IL0 1Fd0 FX0 1EN0 FX0 1HB0 Lz0 1EN0 Lz0 1C10 IL0 1HB0 Db0 1HB0 On0 1zd0 On0 1zd0 Lz0 1zd0 Rb0 1wN0 Wn0 1tB0 Rb0 1tB0 WL0 1tB0 Rb0 1zd0 On0 1HB0 FX0 1C10 Lz0 1Ip0 HX0 1zd0 On0 1HB0 IL0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 Rb0 1zd0 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 Rb0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0 On0 1zd0 On0 1zd0 On0 1C10 Lz0 1C10 Lz0 1C10 Lz0 1C10 On0 1zd0 Rb0 1wp0 On0 1C10 Lz0 1C10 On0 1zd0|20e6","America/Scoresbysund|LMT CGT CGST EGST EGT|1r.Q 20 10 0 10|0121343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434|-2a5Ww.8 2z5ew.8 1a00 1cK0 1cL0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|452","America/Sitka|PST PWT PPT PDT YST AKST AKDT|80 70 70 70 90 90 80|01203030303030303030303030303030345656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565|-17T20 8x10 iy0 Vo10 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 co0 10q0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|90e2","America/St_Johns|NST NDT NST NDT NWT NPT NDDT|3u.Q 2u.Q 3u 2u 2u 2u 1u|01010101010101010101010101010101010102323232323232324523232323232323232323232323232323232323232323232323232323232323232323232323232323232326232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-28oit.8 14L0 1nB0 1in0 1gm0 Dz0 1JB0 1cL0 1cN0 1cL0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1fB0 1cL0 1cN0 1cL0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1fB0 19X0 1fB0 1cL0 1fB0 19X0 1fB0 19X0 10O0 eKX.8 19X0 1iq0 WL0 1qN0 WL0 1qN0 WL0 1tB0 TX0 1tB0 WL0 1qN0 WL0 1qN0 7UHu itu 1tB0 WL0 1qN0 WL0 1qN0 WL0 1qN0 WL0 1tB0 WL0 1ld0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14n1 1lb0 14p0 1nW0 11C0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zcX Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|11e4","America/Swift_Current|LMT MST MDT MWT MPT CST|7b.k 70 60 60 60 60|012134121212121212121215|-2AD4M.E uHdM.E 1in0 UGp0 8x20 ix0 1o10 17b0 1ip0 11z0 1o10 11z0 1o10 11z0 isN0 1cL0 3Cp0 1cL0 1cN0 11z0 1qN0 WL0 pMp0|16e3","America/Tegucigalpa|LMT CST CDT|5M.Q 60 50|01212121|-1WGGb.8 2ETcb.8 WL0 1qN0 WL0 GRd0 AL0|11e5","America/Thule|LMT AST ADT|4z.8 40 30|012121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2a5To.Q 31NBo.Q 1cL0 1cN0 1cL0 1fB0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|656","America/Thunder_Bay|CST EST EWT EPT EDT|60 50 40 40 40|0123141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141|-2q5S0 1iaN0 8x40 iv0 XNB0 1cL0 1cN0 1fz0 1cN0 1cL0 3Cp0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|11e4","America/Vancouver|PST PDT PWT PPT|80 70 70 70|0102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-25TO0 1in0 UGp0 8x10 iy0 1o10 17b0 1ip0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|23e5","America/Whitehorse|YST YDT YWT YPT YDDT PST PDT|90 80 80 80 70 80 70|0101023040565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565|-25TN0 1in0 1o10 13V0 Ser0 8x00 iz0 LCL0 1fA0 3NA0 vrd0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|23e3","America/Winnipeg|CST CDT CWT CPT|60 50 50 50|010101023010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aIi0 WL0 3ND0 1in0 Jap0 Rb0 aCN0 8x30 iw0 1tB0 11z0 1ip0 11z0 1o10 11z0 1o10 11z0 1rd0 10L0 1op0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 1cL0 1cN0 11z0 6i10 WL0 6i10 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1a00 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1a00 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 14o0 1lc0 14o0 1o00 11A0 1o00 11A0 1o00 14o0 1lc0 14o0 1lc0 14o0 1o00 11A0 1o00 11A0 1o00 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1o00 11A0 1o00 11A0 1o00 14o0 1lc0 14o0 1lc0 14o0 1o00 11A0 1o00 11A0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|66e4","America/Yakutat|YST YWT YPT YDT AKST AKDT|90 80 80 80 90 80|01203030303030303030303030303030304545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454|-17T10 8x00 iz0 Vo10 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 cn0 10q0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|642","America/Yellowknife|zzz MST MWT MPT MDDT MDT|0 70 60 60 50 60|012314151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151515151|-1pdA0 hix0 8x20 ix0 LCL0 1fA0 zgO0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|19e3","Antarctica/Casey|zzz AWST CAST|0 -80 -b0|012121|-2q00 1DjS0 T90 40P0 KL0|10","Antarctica/Davis|zzz DAVT DAVT|0 -70 -50|01012121|-vyo0 iXt0 alj0 1D7v0 VB0 3Wn0 KN0|70","Antarctica/DumontDUrville|zzz PMT DDUT|0 -a0 -a0|0102|-U0o0 cfq0 bFm0|80","Antarctica/Macquarie|AEST AEDT zzz MIST|-a0 -b0 0 -b0|0102010101010101010101010101010101010101010101010101010101010101010101010101010101010101013|-29E80 19X0 4SL0 1ayy0 Lvs0 1cM0 1o00 Rc0 1wo0 Rc0 1wo0 U00 1wo0 LA0 1C00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 11A0 1qM0 WM0 1qM0 Oo0 1zc0 Oo0 1zc0 Oo0 1wo0 WM0 1tA0 WM0 1tA0 U00 1tA0 U00 1tA0 11A0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 11A0 1o00 1io0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1cM0 1a00 1io0 1cM0 1cM0 1cM0 1cM0 1cM0|1","Antarctica/Mawson|zzz MAWT MAWT|0 -60 -50|012|-CEo0 2fyk0|60","Pacific/Auckland|NZMT NZST NZST NZDT|-bu -cu -c0 -d0|01020202020202020202020202023232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323|-1GCVu Lz0 1tB0 11zu 1o0u 11zu 1o0u 11zu 1o0u 14nu 1lcu 14nu 1lcu 1lbu 11Au 1nXu 11Au 1nXu 11Au 1nXu 11Au 1nXu 11Au 1qLu WMu 1qLu 11Au 1n1bu IM0 1C00 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1qM0 14o0 1lc0 14o0 1lc0 14o0 1lc0 17c0 1io0 17c0 1io0 17c0 1io0 17c0 1lc0 14o0 1lc0 14o0 1lc0 17c0 1io0 17c0 1io0 17c0 1lc0 14o0 1lc0 14o0 1lc0 17c0 1io0 17c0 1io0 17c0 1io0 17c0 1io0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1io0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00|14e5","Antarctica/Palmer|zzz ARST ART ART ARST CLT CLST|0 30 40 30 20 40 30|0121212121234356565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656|-cao0 nD0 1vd0 SL0 1vd0 17z0 1cN0 1fz0 1cN0 1cL0 1cN0 asn0 Db0 jsN0 14N0 11z0 1o10 11z0 1qN0 WL0 1qN0 WL0 1qN0 1cL0 1cN0 11z0 1o10 11z0 1qN0 WL0 1fB0 19X0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 17b0 1ip0 11z0 1ip0 1fz0 1fB0 11z0 1qN0 WL0 1qN0 WL0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 17b0 1ip0 11z0 1o10 19X0 1fB0 1nX0 G10 1EL0 Op0 1zb0 Rd0 1wn0 Rd0 46n0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0|40","Antarctica/Rothera|zzz ROTT|0 30|01|gOo0|130","Antarctica/Syowa|zzz SYOT|0 -30|01|-vs00|20","Antarctica/Troll|zzz UTC CEST|0 0 -20|01212121212121212121212121212121212121212121212121212121212121212121|1puo0 hd0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|40","Antarctica/Vostok|zzz VOST|0 -60|01|-tjA0|25","Europe/Oslo|CET CEST|-10 -20|010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2awM0 Qm0 W6o0 5pf0 WM0 1fA0 1cM0 1cM0 1cM0 1cM0 wJc0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1qM0 WM0 zpc0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|62e4","Asia/Riyadh|LMT AST|-36.Q -30|01|-TvD6.Q|57e5","Asia/Almaty|LMT ALMT ALMT ALMST|-57.M -50 -60 -70|0123232323232323232323232323232323232323232323232|-1Pc57.M eUo7.M 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 3Cl0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0|15e5","Asia/Amman|LMT EET EEST|-2n.I -20 -30|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1yW2n.I 1HiMn.I KL0 1oN0 11b0 1oN0 11b0 1pd0 1dz0 1cp0 11b0 1op0 11b0 fO10 1db0 1e10 1cL0 1cN0 1cL0 1cN0 1fz0 1pd0 10n0 1ld0 14n0 1hB0 15b0 1ip0 19X0 1cN0 1cL0 1cN0 17b0 1ld0 14o0 1lc0 17c0 1io0 17c0 1io0 17c0 1So0 y00 1fc0 1dc0 1co0 1dc0 1cM0 1cM0 1cM0 1o00 11A0 1lc0 17c0 1cM0 1cM0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 4bX0 Dd0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0|25e5","Asia/Anadyr|LMT ANAT ANAT ANAST ANAST ANAST ANAT|-bN.U -c0 -d0 -e0 -d0 -c0 -b0|01232414141414141414141561414141414141414141414141414141414141561|-1PcbN.U eUnN.U 23CL0 1db0 1cN0 1dc0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qN0 WM0|13e3","Asia/Aqtau|LMT FORT FORT SHET SHET SHEST AQTT AQTST AQTST AQTT|-3l.4 -40 -50 -50 -60 -60 -50 -60 -50 -40|012345353535353535353536767676898989898989898989896|-1Pc3l.4 eUnl.4 1jcL0 JDc0 1cL0 1dc0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 2UK0 Fz0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cN0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 RW0|15e4","Asia/Aqtobe|LMT AKTT AKTT AKTST AKTT AQTT AQTST|-3M.E -40 -50 -60 -60 -50 -60|01234323232323232323232565656565656565656565656565|-1Pc3M.E eUnM.E 23CL0 1db0 1cM0 1dc0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 2UK0 Fz0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0|27e4","Asia/Ashgabat|LMT ASHT ASHT ASHST ASHST TMT TMT|-3R.w -40 -50 -60 -50 -40 -50|012323232323232323232324156|-1Pc3R.w eUnR.w 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 ba0 xC0|41e4","Asia/Baghdad|BMT AST ADT|-2V.A -30 -40|012121212121212121212121212121212121212121212121212121|-26BeV.A 2ACnV.A 11b0 1cp0 1dz0 1dd0 1db0 1cN0 1cp0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1de0 1dc0 1dc0 1dc0 1cM0 1dc0 1cM0 1dc0 1cM0 1dc0 1dc0 1dc0 1cM0 1dc0 1cM0 1dc0 1cM0 1dc0 1dc0 1dc0 1cM0 1dc0 1cM0 1dc0 1cM0 1dc0 1dc0 1dc0 1cM0 1dc0 1cM0 1dc0 1cM0 1dc0|66e5","Asia/Qatar|LMT GST AST|-3q.8 -40 -30|012|-21Jfq.8 27BXq.8|96e4","Asia/Baku|LMT BAKT BAKT BAKST BAKST AZST AZT AZT AZST|-3j.o -30 -40 -50 -40 -40 -30 -40 -50|01232323232323232323232456578787878787878787878787878787878787878787|-1Pc3j.o 1jUoj.o WCL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 10K0 c30 1cJ0 1cL0 8wu0 1o00 11z0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00|27e5","Asia/Bangkok|BMT ICT|-6G.4 -70|01|-218SG.4|15e6","Asia/Barnaul|LMT +06 +07 +08|-5z -60 -70 -80|0123232323232323232323212323232321212121212121212121212121212121212|-21S5z pCnz 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 2pB0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 p90 LE0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0 3rd0","Asia/Beirut|EET EEST|-20 -30|010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-21aq0 1on0 1410 1db0 19B0 1in0 1ip0 WL0 1lQp0 11b0 1oN0 11b0 1oN0 11b0 1pd0 11b0 1oN0 11b0 q6N0 En0 1oN0 11b0 1oN0 11b0 1oN0 11b0 1pd0 11b0 1oN0 11b0 1op0 11b0 dA10 17b0 1iN0 17b0 1iN0 17b0 1iN0 17b0 1vB0 SL0 1mp0 13z0 1iN0 17b0 1iN0 17b0 1jd0 12n0 1a10 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0|22e5","Asia/Bishkek|LMT FRUT FRUT FRUST FRUST KGT KGST KGT|-4W.o -50 -60 -70 -60 -50 -60 -60|01232323232323232323232456565656565656565656565656567|-1Pc4W.o eUnW.o 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 11c0 1tX0 17b0 1ip0 17b0 1ip0 17b0 1ip0 17b0 1ip0 19X0 1cPu 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 T8u|87e4","Asia/Brunei|LMT BNT BNT|-7D.E -7u -80|012|-1KITD.E gDc9.E|42e4","Asia/Kolkata|HMT BURT IST IST|-5R.k -6u -5u -6u|01232|-18LFR.k 1unn.k HB0 7zX0|15e6","Asia/Chita|LMT YAKT YAKT YAKST YAKST YAKT IRKT|-7x.Q -80 -90 -a0 -90 -a0 -80|0123232323232323232323241232323232323232323232323232323232323232562|-21Q7x.Q pAnx.Q 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0 3re0|33e4","Asia/Choibalsan|LMT ULAT ULAT CHOST CHOT CHOT CHOST|-7C -70 -80 -a0 -90 -80 -90|0123434343434343434343434343434343434343434343456565656565656565656565656565656565656565656565|-2APHC 2UkoC cKn0 1da0 1dd0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 1cL0 1cN0 1cL0 1cN0 1cL0 6hD0 11z0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 3Db0 h1f0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0|38e3","Asia/Shanghai|CST CDT|-80 -90|01010101010101010|-1c1I0 LX0 16p0 1jz0 1Myp0 Rb0 1o10 11z0 1o10 11z0 1qN0 11z0 1o10 11z0 1o10 11z0|23e6","Asia/Colombo|MMT IST IHST IST LKT LKT|-5j.w -5u -60 -6u -6u -60|01231451|-2zOtj.w 1rFbN.w 1zzu 7Apu 23dz0 11zu n3cu|22e5","Asia/Dhaka|HMT BURT IST DACT BDT BDST|-5R.k -6u -5u -60 -60 -70|01213454|-18LFR.k 1unn.k HB0 m6n0 LqMu 1x6n0 1i00|16e6","Asia/Damascus|LMT EET EEST|-2p.c -20 -30|01212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-21Jep.c Hep.c 17b0 1ip0 17b0 1ip0 17b0 1ip0 19X0 1xRB0 11X0 1oN0 10L0 1pB0 11b0 1oN0 10L0 1mp0 13X0 1oN0 11b0 1pd0 11b0 1oN0 11b0 1oN0 11b0 1oN0 11b0 1pd0 11b0 1oN0 11b0 1oN0 11b0 1oN0 11b0 1pd0 11b0 1oN0 Nb0 1AN0 Nb0 bcp0 19X0 1gp0 19X0 3ld0 1xX0 Vd0 1Bz0 Sp0 1vX0 10p0 1dz0 1cN0 1cL0 1db0 1db0 1g10 1an0 1ap0 1db0 1fd0 1db0 1cN0 1db0 1dd0 1db0 1cp0 1dz0 1c10 1dX0 1cN0 1db0 1dd0 1db0 1cN0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1db0 1cN0 1db0 1cN0 19z0 1fB0 1qL0 11B0 1on0 Wp0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 1qL0 WN0 1qL0|26e5","Asia/Dili|LMT TLT JST TLT WITA|-8m.k -80 -90 -90 -80|012343|-2le8m.k 1dnXm.k 8HA0 1ew00 Xld0|19e4","Asia/Dubai|LMT GST|-3F.c -40|01|-21JfF.c|39e5","Asia/Dushanbe|LMT DUST DUST DUSST DUSST TJT|-4z.c -50 -60 -70 -60 -50|0123232323232323232323245|-1Pc4z.c eUnz.c 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 14N0|76e4","Asia/Gaza|EET EET EEST IST IDT|-20 -30 -30 -20 -30|010101010102020202020202020202023434343434343434343434343430202020202020202020202020202020202020202020202020202020202020202020202020202020202020|-1c2q0 5Rb0 10r0 1px0 10N0 1pz0 16p0 1jB0 16p0 1jx0 pBd0 Vz0 1oN0 11b0 1oO0 10N0 1pz0 10N0 1pb0 10N0 1pb0 10N0 1pb0 10N0 1pz0 10N0 1pb0 10N0 1pb0 11d0 1oL0 dW0 hfB0 Db0 1fB0 Rb0 npB0 11z0 1C10 IL0 1s10 10n0 1o10 WL0 1zd0 On0 1ld0 11z0 1o10 14n0 1o10 14n0 1nd0 12n0 1nd0 Xz0 1q10 12n0 M10 C00 17c0 1io0 17c0 1io0 17c0 1o00 1cL0 1fB0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 17c0 1io0 18N0 1bz0 19z0 1gp0 1610 1iL0 11z0 1o10 14o0 1lA1 SKX 1xd1 MKX 1AN0 1a00 1fA0 1cL0 1cN0 1nX0 1210 1nz0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0|18e5","Asia/Hebron|EET EET EEST IST IDT|-20 -30 -30 -20 -30|01010101010202020202020202020202343434343434343434343434343020202020202020202020202020202020202020202020202020202020202020202020202020202020202020|-1c2q0 5Rb0 10r0 1px0 10N0 1pz0 16p0 1jB0 16p0 1jx0 pBd0 Vz0 1oN0 11b0 1oO0 10N0 1pz0 10N0 1pb0 10N0 1pb0 10N0 1pb0 10N0 1pz0 10N0 1pb0 10N0 1pb0 11d0 1oL0 dW0 hfB0 Db0 1fB0 Rb0 npB0 11z0 1C10 IL0 1s10 10n0 1o10 WL0 1zd0 On0 1ld0 11z0 1o10 14n0 1o10 14n0 1nd0 12n0 1nd0 Xz0 1q10 12n0 M10 C00 17c0 1io0 17c0 1io0 17c0 1o00 1cL0 1fB0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 17c0 1io0 18N0 1bz0 19z0 1gp0 1610 1iL0 12L0 1mN0 14o0 1lc0 Tb0 1xd1 MKX bB0 cn0 1cN0 1a00 1fA0 1cL0 1cN0 1nX0 1210 1nz0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1ny0 1220 1qm0 1220 1ny0 1220 1ny0 1220 1ny0|25e4","Asia/Ho_Chi_Minh|LMT PLMT ICT IDT JST|-76.E -76.u -70 -80 -90|0123423232|-2yC76.E bK00.a 1h7b6.u 5lz0 18o0 3Oq0 k5b0 aW00 BAM0|90e5","Asia/Hong_Kong|LMT HKT HKST JST|-7A.G -80 -90 -90|0121312121212121212121212121212121212121212121212121212121212121212121|-2CFHA.G 1sEP6.G 1cL0 ylu 93X0 1qQu 1tX0 Rd0 1In0 NB0 1cL0 11B0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1kL0 14N0 1nX0 U10 1tz0 U10 1wn0 Rd0 1wn0 U10 1tz0 U10 1tz0 U10 1tz0 U10 1wn0 Rd0 1wn0 Rd0 1wn0 U10 1tz0 U10 1tz0 17d0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 s10 1Vz0 1cN0 1cL0 1cN0 1cL0 6fd0 14n0|73e5","Asia/Hovd|LMT HOVT HOVT HOVST|-66.A -60 -70 -80|012323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-2APG6.A 2Uko6.A cKn0 1db0 1dd0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 1cL0 1cN0 1cL0 1cN0 1cL0 6hD0 11z0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 kEp0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0|81e3","Asia/Irkutsk|IMT IRKT IRKT IRKST IRKST IRKT|-6V.5 -70 -80 -90 -80 -90|012323232323232323232324123232323232323232323232323232323232323252|-21zGV.5 pjXV.5 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|60e4","Europe/Istanbul|IMT EET EEST TRST TRT|-1U.U -20 -30 -40 -30|012121212121212121212121212121212121212121212121212121234343434342121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2ogNU.U dzzU.U 11b0 8tB0 1on0 1410 1db0 19B0 1in0 3Rd0 Un0 1oN0 11b0 zSp0 CL0 mN0 1Vz0 1gN0 1pz0 5Rd0 1fz0 1yp0 ML0 1kp0 17b0 1ip0 17b0 1fB0 19X0 1jB0 18L0 1ip0 17z0 qdd0 xX0 3S10 Tz0 dA10 11z0 1o10 11z0 1qN0 11z0 1ze0 11B0 WM0 1qO0 WI0 1nX0 1rB0 10L0 11B0 1in0 17d0 1in0 2pX0 19E0 1fU0 16Q0 1iI0 16Q0 1iI0 1Vd0 pb0 3Kp0 14o0 1df0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cL0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WO0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 Xc0 1qo0 WM0 1qM0 11A0 1o00 1200 1nA0 11A0 1tA0 U00 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|13e6","Asia/Jakarta|BMT JAVT WIB JST WIB WIB|-77.c -7k -7u -90 -80 -70|01232425|-1Q0Tk luM0 mPzO 8vWu 6kpu 4PXu xhcu|31e6","Asia/Jayapura|LMT WIT ACST|-9m.M -90 -9u|0121|-1uu9m.M sMMm.M L4nu|26e4","Asia/Jerusalem|JMT IST IDT IDDT|-2k.E -20 -30 -40|01212121212132121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-26Bek.E SyMk.E 5Rb0 10r0 1px0 10N0 1pz0 16p0 1jB0 16p0 1jx0 3LB0 Em0 or0 1cn0 1dB0 16n0 10O0 1ja0 1tC0 14o0 1cM0 1a00 11A0 1Na0 An0 1MP0 AJ0 1Kp0 LC0 1oo0 Wl0 EQN0 Db0 1fB0 Rb0 npB0 11z0 1C10 IL0 1s10 10n0 1o10 WL0 1zd0 On0 1ld0 11z0 1o10 14n0 1o10 14n0 1nd0 12n0 1nd0 Xz0 1q10 12n0 1hB0 1dX0 1ep0 1aL0 1eN0 17X0 1nf0 11z0 1tB0 19W0 1e10 17b0 1ep0 1gL0 18N0 1fz0 1eN0 17b0 1gq0 1gn0 19d0 1dz0 1c10 17X0 1hB0 1gn0 19d0 1dz0 1c10 17X0 1kp0 1dz0 1c10 1aL0 1eN0 1oL0 10N0 1oL0 10N0 1oL0 10N0 1rz0 W10 1rz0 W10 1rz0 10N0 1oL0 10N0 1oL0 10N0 1rz0 W10 1rz0 W10 1rz0 10N0 1oL0 10N0 1oL0 10N0 1oL0 10N0 1rz0 W10 1rz0 W10 1rz0 10N0 1oL0 10N0 1oL0 10N0 1rz0 W10 1rz0 W10 1rz0 W10 1rz0 10N0 1oL0 10N0 1oL0|81e4","Asia/Kabul|AFT AFT|-40 -4u|01|-10Qs0|46e5","Asia/Kamchatka|LMT PETT PETT PETST PETST|-ay.A -b0 -c0 -d0 -c0|01232323232323232323232412323232323232323232323232323232323232412|-1SLKy.A ivXy.A 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qN0 WM0|18e4","Asia/Karachi|LMT IST IST KART PKT PKST|-4s.c -5u -6u -50 -50 -60|012134545454|-2xoss.c 1qOKW.c 7zX0 eup0 LqMu 1fy00 1cL0 dK10 11b0 1610 1jX0|24e6","Asia/Urumqi|LMT XJT|-5O.k -60|01|-1GgtO.k|32e5","Asia/Kathmandu|LMT IST NPT|-5F.g -5u -5J|012|-21JhF.g 2EGMb.g|12e5","Asia/Khandyga|LMT YAKT YAKT YAKST YAKST VLAT VLAST VLAT YAKT|-92.d -80 -90 -a0 -90 -a0 -b0 -b0 -a0|01232323232323232323232412323232323232323232323232565656565656565782|-21Q92.d pAp2.d 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 qK0 yN0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 17V0 7zD0|66e2","Asia/Krasnoyarsk|LMT KRAT KRAT KRAST KRAST KRAT|-6b.q -60 -70 -80 -70 -80|012323232323232323232324123232323232323232323232323232323232323252|-21Hib.q prAb.q 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|10e5","Asia/Kuala_Lumpur|SMT MALT MALST MALT MALT JST MYT|-6T.p -70 -7k -7k -7u -90 -80|01234546|-2Bg6T.p 17anT.p 7hXE dM00 17bO 8Fyu 1so1u|71e5","Asia/Kuching|LMT BORT BORT BORTST JST MYT|-7l.k -7u -80 -8k -90 -80|01232323232323232425|-1KITl.k gDbP.k 6ynu AnE 1O0k AnE 1NAk AnE 1NAk AnE 1NAk AnE 1O0k AnE 1NAk AnE pAk 8Fz0 1so10|13e4","Asia/Macau|LMT MOT MOST CST|-7y.k -80 -90 -80|0121212121212121212121212121212121212121213|-2le7y.k 1XO34.k 1wn0 Rd0 1wn0 R9u 1wqu U10 1tz0 TVu 1tz0 17gu 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cJu 1cL0 1cN0 1fz0 1cN0 1cOu 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cJu 1cL0 1cN0 1fz0 1cN0 1cL0 KEp0|57e4","Asia/Magadan|LMT MAGT MAGT MAGST MAGST MAGT|-a3.c -a0 -b0 -c0 -b0 -c0|012323232323232323232324123232323232323232323232323232323232323251|-1Pca3.c eUo3.c 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|95e3","Asia/Makassar|LMT MMT WITA JST|-7V.A -7V.A -80 -90|01232|-21JjV.A vfc0 myLV.A 8ML0|15e5","Asia/Manila|PHT PHST JST|-80 -90 -90|010201010|-1kJI0 AL0 cK10 65X0 mXB0 vX0 VK10 1db0|24e6","Asia/Nicosia|LMT EET EEST|-2d.s -20 -30|01212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1Vc2d.s 2a3cd.s 1cL0 1qp0 Xz0 19B0 19X0 1fB0 1db0 1cp0 1cL0 1fB0 19X0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 1cL0 1cN0 1cL0 1cN0 1o30 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|32e4","Asia/Novokuznetsk|LMT KRAT KRAT KRAST KRAST NOVST NOVT NOVT|-5M.M -60 -70 -80 -70 -70 -60 -70|012323232323232323232324123232323232323232323232323232323232325672|-1PctM.M eULM.M 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qN0 WM0 8Hz0|55e4","Asia/Novosibirsk|LMT NOVT NOVT NOVST NOVST|-5v.E -60 -70 -80 -70|0123232323232323232323241232341414141414141414141414141414141414121|-21Qnv.E pAFv.E 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 ml0 Os0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|15e5","Asia/Omsk|LMT OMST OMST OMSST OMSST OMST|-4R.u -50 -60 -70 -60 -70|012323232323232323232324123232323232323232323232323232323232323252|-224sR.u pMLR.u 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|12e5","Asia/Oral|LMT URAT URAT URAST URAT URAST ORAT ORAST ORAT|-3p.o -40 -50 -60 -60 -50 -40 -50 -50|012343232323232323251516767676767676767676767676768|-1Pc3p.o eUnp.o 23CL0 1db0 1cM0 1dc0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1fA0 2UK0 Fz0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 RW0|27e4","Asia/Pontianak|LMT PMT WIB JST WIB WITA WIB|-7h.k -7h.k -7u -90 -80 -80 -70|012324256|-2ua7h.k XE00 munL.k 8Rau 6kpu 4PXu xhcu Wqnu|23e4","Asia/Pyongyang|LMT KST JCST JST KST|-8n -8u -90 -90 -90|012341|-2um8n 97XR 12FXu jdA0 2Onc0|29e5","Asia/Qyzylorda|LMT KIZT KIZT KIZST KIZT QYZT QYZT QYZST|-4l.Q -40 -50 -60 -60 -50 -60 -70|012343232323232323232325676767676767676767676767676|-1Pc4l.Q eUol.Q 23CL0 1db0 1cM0 1dc0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 2UK0 dC0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0|73e4","Asia/Rangoon|RMT BURT JST MMT|-6o.E -6u -90 -6u|0123|-21Jio.E SmnS.E 7j9u|48e5","Asia/Sakhalin|LMT JCST JST SAKT SAKST SAKST SAKT|-9u.M -90 -90 -b0 -c0 -b0 -a0|01234343434343434343434356343434343435656565656565656565656565656363|-2AGVu.M 1iaMu.M je00 1qFa0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o10 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0 3rd0|58e4","Asia/Samarkand|LMT SAMT SAMT SAMST TAST UZST UZT|-4r.R -40 -50 -60 -60 -60 -50|01234323232323232323232356|-1Pc4r.R eUor.R 23CL0 1db0 1cM0 1dc0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 11x0 bf0|36e4","Asia/Seoul|LMT KST JCST JST KST KDT KDT|-8r.Q -8u -90 -90 -90 -9u -a0|01234151515151515146464|-2um8r.Q 97XV.Q 12FXu jjA0 kKo0 2I0u OL0 1FB0 Rb0 1qN0 TX0 1tB0 TX0 1tB0 TX0 1tB0 TX0 2ap0 12FBu 11A0 1o00 11A0|23e6","Asia/Singapore|SMT MALT MALST MALT MALT JST SGT SGT|-6T.p -70 -7k -7k -7u -90 -7u -80|012345467|-2Bg6T.p 17anT.p 7hXE dM00 17bO 8Fyu Mspu DTA0|56e5","Asia/Srednekolymsk|LMT MAGT MAGT MAGST MAGST MAGT SRET|-ae.Q -a0 -b0 -c0 -b0 -c0 -b0|012323232323232323232324123232323232323232323232323232323232323256|-1Pcae.Q eUoe.Q 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|35e2","Asia/Taipei|JWST JST CST CDT|-80 -90 -80 -90|01232323232323232323232323232323232323232|-1iw80 joM0 1yo0 Tz0 1ip0 1jX0 1cN0 11b0 1oN0 11b0 1oN0 11b0 1oN0 11b0 10N0 1BX0 10p0 1pz0 10p0 1pz0 10p0 1db0 1dd0 1db0 1cN0 1db0 1cN0 1db0 1cN0 1db0 1BB0 ML0 1Bd0 ML0 uq10 1db0 1cN0 1db0 97B0 AL0|74e5","Asia/Tashkent|LMT TAST TAST TASST TASST UZST UZT|-4B.b -50 -60 -70 -60 -60 -50|01232323232323232323232456|-1Pc4B.b eUnB.b 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 11y0 bf0|23e5","Asia/Tbilisi|TBMT TBIT TBIT TBIST TBIST GEST GET GET GEST|-2X.b -30 -40 -50 -40 -40 -30 -40 -50|0123232323232323232323245656565787878787878787878567|-1Pc2X.b 1jUnX.b WCL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 3y0 19f0 1cK0 1cL0 1cN0 1cL0 1cN0 1cL0 1cM0 1cL0 1fB0 3Nz0 11B0 1nX0 11B0 1qL0 WN0 1qL0 WN0 1qL0 11B0 1nX0 11B0 1nX0 11B0 An0 Os0 WM0|11e5","Asia/Tehran|LMT TMT IRST IRST IRDT IRDT|-3p.I -3p.I -3u -40 -50 -4u|01234325252525252525252525252525252525252525252525252525252525252525252525252525252525252525252525252|-2btDp.I 1d3c0 1huLT.I TXu 1pz0 sN0 vAu 1cL0 1dB0 1en0 pNB0 UL0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 64p0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0 1cN0 1dz0 1cp0 1dz0 1cp0 1dz0 1cp0 1dz0|14e6","Asia/Thimphu|LMT IST BTT|-5W.A -5u -60|012|-Su5W.A 1BGMs.A|79e3","Asia/Tokyo|JCST JST JDT|-90 -90 -a0|0121212121|-1iw90 pKq0 QL0 1lB0 13X0 1zB0 NX0 1zB0 NX0|38e6","Asia/Ulaanbaatar|LMT ULAT ULAT ULAST|-77.w -70 -80 -90|012323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-2APH7.w 2Uko7.w cKn0 1db0 1dd0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 1cL0 1cN0 1cL0 1cN0 1cL0 6hD0 11z0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 kEp0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1fx0 1cP0 1cJ0 1cP0 1cJ0 1cP0 1cJ0|12e5","Asia/Ust-Nera|LMT YAKT YAKT MAGST MAGT MAGST MAGT MAGT VLAT VLAT|-9w.S -80 -90 -c0 -b0 -b0 -a0 -c0 -b0 -a0|0123434343434343434343456434343434343434343434343434343434343434789|-21Q9w.S pApw.S 23CL0 1d90 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 17V0 7zD0|65e2","Asia/Vladivostok|LMT VLAT VLAT VLAST VLAST VLAT|-8L.v -90 -a0 -b0 -a0 -b0|012323232323232323232324123232323232323232323232323232323232323252|-1SJIL.v itXL.v 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|60e4","Asia/Yakutsk|LMT YAKT YAKT YAKST YAKST YAKT|-8C.W -80 -90 -a0 -90 -a0|012323232323232323232324123232323232323232323232323232323232323252|-21Q8C.W pAoC.W 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|28e4","Asia/Yekaterinburg|LMT PMT SVET SVET SVEST SVEST YEKT YEKST YEKT|-42.x -3J.5 -40 -50 -60 -50 -50 -60 -60|0123434343434343434343435267676767676767676767676767676767676767686|-2ag42.x 7mQh.s qBvJ.5 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|14e5","Asia/Yerevan|LMT YERT YERT YERST YERST AMST AMT AMT AMST|-2W -30 -40 -50 -40 -40 -30 -40 -50|0123232323232323232323245656565657878787878787878787878787878787|-1Pc2W 1jUnW WCL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1am0 2r0 1cJ0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 3Fb0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0|13e5","Atlantic/Azores|HMT AZOT AZOST AZOMT AZOT AZOST WET|1S.w 20 10 0 10 0 0|01212121212121212121212121212121212121212121232123212321232121212121212121212121212121212121212121454545454545454545454545454545456545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454|-2ldW5.s aPX5.s Sp0 LX0 1vc0 Tc0 1uM0 SM0 1vc0 Tc0 1vc0 SM0 1vc0 6600 1co0 3E00 17c0 1fA0 1a00 1io0 1a00 1io0 17c0 3I00 17c0 1cM0 1cM0 3Fc0 1cM0 1a00 1fA0 1io0 17c0 1cM0 1cM0 1a00 1fA0 1io0 1qM0 Dc0 1tA0 1cM0 1dc0 1400 gL0 IM0 s10 U00 dX0 Rc0 pd0 Rc0 gL0 Oo0 pd0 Rc0 gL0 Oo0 pd0 14o0 1cM0 1cP0 1cM0 1cM0 1cM0 1cM0 1cM0 3Co0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 qIl0 1cM0 1fA0 1cM0 1cM0 1cN0 1cL0 1cN0 1cM0 1cM0 1cM0 1cM0 1cN0 1cL0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cL0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|25e4","Atlantic/Bermuda|LMT AST ADT|4j.i 40 30|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1BnRE.G 1LTbE.G 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0|65e3","Atlantic/Canary|LMT CANT WET WEST|11.A 10 0 -10|01232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-1UtaW.o XPAW.o 1lAK0 1a10 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|54e4","Atlantic/Cape_Verde|LMT CVT CVST CVT|1y.4 20 10 10|01213|-2xomp.U 1qOMp.U 7zX0 1djf0|50e4","Atlantic/Faroe|LMT WET WEST|r.4 0 -10|01212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2uSnw.U 2Wgow.U 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|49e3","Atlantic/Madeira|FMT MADT MADST MADMT WET WEST|17.A 10 0 -10 0 -10|01212121212121212121212121212121212121212121232123212321232121212121212121212121212121212121212121454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454|-2ldWQ.o aPWQ.o Sp0 LX0 1vc0 Tc0 1uM0 SM0 1vc0 Tc0 1vc0 SM0 1vc0 6600 1co0 3E00 17c0 1fA0 1a00 1io0 1a00 1io0 17c0 3I00 17c0 1cM0 1cM0 3Fc0 1cM0 1a00 1fA0 1io0 17c0 1cM0 1cM0 1a00 1fA0 1io0 1qM0 Dc0 1tA0 1cM0 1dc0 1400 gL0 IM0 s10 U00 dX0 Rc0 pd0 Rc0 gL0 Oo0 pd0 Rc0 gL0 Oo0 pd0 14o0 1cM0 1cP0 1cM0 1cM0 1cM0 1cM0 1cM0 3Co0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 qIl0 1cM0 1fA0 1cM0 1cM0 1cN0 1cL0 1cN0 1cM0 1cM0 1cM0 1cM0 1cN0 1cL0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|27e4","Atlantic/Reykjavik|LMT IST ISST GMT|1s 10 0 0|012121212121212121212121212121212121212121212121212121212121212121213|-2uWmw mfaw 1Bd0 ML0 1LB0 Cn0 1LB0 3fX0 C10 HrX0 1cO0 LB0 1EL0 LA0 1C00 Oo0 1wo0 Rc0 1wo0 Rc0 1wo0 Rc0 1zc0 Oo0 1zc0 14o0 1lc0 14o0 1lc0 14o0 1o00 11A0 1lc0 14o0 1o00 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1o00 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1o00 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1lc0 14o0 1o00 14o0|12e4","Atlantic/South_Georgia|GST|20|0||30","Atlantic/Stanley|SMT FKT FKST FKT FKST|3P.o 40 30 30 20|0121212121212134343212121212121212121212121212121212121212121212121212|-2kJw8.A 12bA8.A 19X0 1fB0 19X0 1ip0 19X0 1fB0 19X0 1fB0 19X0 1fB0 Cn0 1Cc10 WL0 1qL0 U10 1tz0 U10 1qM0 WN0 1qL0 WN0 1qL0 WN0 1qL0 WN0 1tz0 U10 1tz0 WN0 1qL0 WN0 1qL0 WN0 1qL0 WN0 1qL0 WN0 1tz0 WN0 1qL0 WN0 1qL0 WN0 1qL0 WN0 1qL0 WN0 1qN0 U10 1wn0 Rd0 1wn0 U10 1tz0 U10 1tz0 U10 1tz0 U10 1tz0 U10 1wn0 U10 1tz0 U10 1tz0 U10|21e2","Australia/Sydney|AEST AEDT|-a0 -b0|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101|-293lX xcX 10jd0 yL0 1cN0 1cL0 1fB0 19X0 17c10 LA0 1C00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 14o0 1o00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 U00 1qM0 WM0 1tA0 WM0 1tA0 U00 1tA0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 11A0 1o00 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 WM0 1qM0 14o0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0|40e5","Australia/Adelaide|ACST ACDT|-9u -au|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101|-293lt xcX 10jd0 yL0 1cN0 1cL0 1fB0 19X0 17c10 LA0 1C00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 U00 1qM0 WM0 1tA0 WM0 1tA0 U00 1tA0 U00 1tA0 Oo0 1zc0 WM0 1qM0 Rc0 1zc0 U00 1tA0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 WM0 1qM0 14o0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0|11e5","Australia/Brisbane|AEST AEDT|-a0 -b0|01010101010101010|-293lX xcX 10jd0 yL0 1cN0 1cL0 1fB0 19X0 17c10 LA0 H1A0 Oo0 1zc0 Oo0 1zc0 Oo0|20e5","Australia/Broken_Hill|ACST ACDT|-9u -au|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101|-293lt xcX 10jd0 yL0 1cN0 1cL0 1fB0 19X0 17c10 LA0 1C00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 14o0 1o00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 U00 1qM0 WM0 1tA0 WM0 1tA0 U00 1tA0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 WM0 1qM0 14o0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0|18e3","Australia/Currie|AEST AEDT|-a0 -b0|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101|-29E80 19X0 10jd0 yL0 1cN0 1cL0 1fB0 19X0 17c10 LA0 1C00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 11A0 1qM0 WM0 1qM0 Oo0 1zc0 Oo0 1zc0 Oo0 1wo0 WM0 1tA0 WM0 1tA0 U00 1tA0 U00 1tA0 11A0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 11A0 1o00 1io0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1cM0 1a00 1io0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0|746","Australia/Darwin|ACST ACDT|-9u -au|010101010|-293lt xcX 10jd0 yL0 1cN0 1cL0 1fB0 19X0|12e4","Australia/Eucla|ACWST ACWDT|-8J -9J|0101010101010101010|-293kI xcX 10jd0 yL0 1cN0 1cL0 1gSp0 Oo0 l5A0 Oo0 iJA0 G00 zU00 IM0 1qM0 11A0 1o00 11A0|368","Australia/Hobart|AEST AEDT|-a0 -b0|010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101|-29E80 19X0 10jd0 yL0 1cN0 1cL0 1fB0 19X0 VfB0 1cM0 1o00 Rc0 1wo0 Rc0 1wo0 U00 1wo0 LA0 1C00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 11A0 1qM0 WM0 1qM0 Oo0 1zc0 Oo0 1zc0 Oo0 1wo0 WM0 1tA0 WM0 1tA0 U00 1tA0 U00 1tA0 11A0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 11A0 1o00 1io0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1cM0 1a00 1io0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0|21e4","Australia/Lord_Howe|AEST LHST LHDT LHDT|-a0 -au -bu -b0|0121212121313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313131313|raC0 1zdu Rb0 1zd0 On0 1zd0 On0 1zd0 On0 1zd0 TXu 1qMu WLu 1tAu WLu 1tAu TXu 1tAu Onu 1zcu Onu 1zcu Onu 1zcu Rbu 1zcu Onu 1zcu Onu 1zcu 11zu 1o0u 11zu 1o0u 11zu 1o0u 11zu 1qMu WLu 11Au 1nXu 1qMu 11zu 1o0u 11zu 1o0u 11zu 1qMu WLu 1qMu 11zu 1o0u WLu 1qMu 14nu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1fAu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1fAu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1fzu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1fAu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1cMu 1cLu 1fAu 1cLu 1cMu 1cLu 1cMu|347","Australia/Lindeman|AEST AEDT|-a0 -b0|010101010101010101010|-293lX xcX 10jd0 yL0 1cN0 1cL0 1fB0 19X0 17c10 LA0 H1A0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0|10","Australia/Melbourne|AEST AEDT|-a0 -b0|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101|-293lX xcX 10jd0 yL0 1cN0 1cL0 1fB0 19X0 17c10 LA0 1C00 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 U00 1qM0 WM0 1qM0 11A0 1tA0 U00 1tA0 U00 1tA0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 11A0 1o00 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 WM0 1qM0 14o0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0|39e5","Australia/Perth|AWST AWDT|-80 -90|0101010101010101010|-293jX xcX 10jd0 yL0 1cN0 1cL0 1gSp0 Oo0 l5A0 Oo0 iJA0 G00 zU00 IM0 1qM0 11A0 1o00 11A0|18e5","CET|CET CEST|-10 -20|01010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aFe0 11d0 1iO0 11A0 1o00 11A0 Qrc0 6i00 WM0 1fA0 1cM0 1cM0 1cM0 16M0 1gMM0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00","CST6CDT|CST CDT CWT CPT|60 50 50 50|010102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261s0 1nX0 11B0 1nX0 SgN0 8x30 iw0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","Pacific/Easter|EMT EAST EASST EAST EASST|7h.s 70 60 60 50|0121212121212121212121212121234343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434|-1uSgG.w 1s4IG.w WL0 1zd0 On0 1ip0 11z0 1o10 11z0 1qN0 WL0 1ld0 14n0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 WL0 1qN0 1cL0 1cN0 11z0 1o10 11z0 1qN0 WL0 1fB0 19X0 1qN0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 17b0 1ip0 11z0 1ip0 1fz0 1fB0 11z0 1qN0 WL0 1qN0 WL0 1qN0 WL0 1qN0 11z0 1o10 11z0 1o10 11z0 1qN0 WL0 1qN0 17b0 1ip0 11z0 1o10 19X0 1fB0 1nX0 G10 1EL0 Op0 1zb0 Rd0 1wn0 Rd0 46n0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Dd0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0 1Nb0 Ap0|30e2","EET|EET EEST|-20 -30|010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|hDB0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00","EST|EST|50|0|","EST5EDT|EST EDT EWT EPT|50 40 40 40|010102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261t0 1nX0 11B0 1nX0 SgN0 8x40 iv0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","Europe/Dublin|DMT IST GMT BST IST|p.l -y.D 0 -10 -10|01232323232324242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242424242|-2ax9y.D Rc0 1fzy.D 14M0 1fc0 1g00 1co0 1dc0 1co0 1oo0 1400 1dc0 19A0 1io0 1io0 WM0 1o00 14o0 1o00 17c0 1io0 17c0 1fA0 1a00 1lc0 17c0 1io0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1cM0 1io0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1a00 1io0 1qM0 Dc0 g5X0 14p0 1wn0 17d0 1io0 11A0 1o00 17c0 1fA0 1a00 1fA0 1cM0 1fA0 1a00 17c0 1fA0 1a00 1io0 17c0 1lc0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1a00 1a00 1qM0 WM0 1qM0 11A0 1o00 WM0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1tA0 IM0 90o0 U00 1tA0 U00 1tA0 U00 1tA0 U00 1tA0 WM0 1qM0 WM0 1qM0 WM0 1tA0 U00 1tA0 U00 1tA0 11z0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 14o0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|12e5","Etc/GMT+0|GMT|0|0|","Etc/GMT+1|GMT+1|10|0|","Etc/GMT+10|GMT+10|a0|0|","Etc/GMT+11|GMT+11|b0|0|","Etc/GMT+12|GMT+12|c0|0|","Etc/GMT+2|GMT+2|20|0|","Etc/GMT+3|GMT+3|30|0|","Etc/GMT+4|GMT+4|40|0|","Etc/GMT+5|GMT+5|50|0|","Etc/GMT+6|GMT+6|60|0|","Etc/GMT+7|GMT+7|70|0|","Etc/GMT+8|GMT+8|80|0|","Etc/GMT+9|GMT+9|90|0|","Etc/GMT-1|GMT-1|-10|0|","Etc/GMT-10|GMT-10|-a0|0|","Etc/GMT-11|GMT-11|-b0|0|","Etc/GMT-12|GMT-12|-c0|0|","Etc/GMT-13|GMT-13|-d0|0|","Etc/GMT-14|GMT-14|-e0|0|","Etc/GMT-2|GMT-2|-20|0|","Etc/GMT-3|GMT-3|-30|0|","Etc/GMT-4|GMT-4|-40|0|","Etc/GMT-5|GMT-5|-50|0|","Etc/GMT-6|GMT-6|-60|0|","Etc/GMT-7|GMT-7|-70|0|","Etc/GMT-8|GMT-8|-80|0|","Etc/GMT-9|GMT-9|-90|0|","Etc/UCT|UCT|0|0|","Etc/UTC|UTC|0|0|","Europe/Amsterdam|AMT NST NEST NET CEST CET|-j.w -1j.w -1k -k -20 -10|010101010101010101010101010101010101010101012323234545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545|-2aFcj.w 11b0 1iP0 11A0 1io0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1co0 1io0 1yo0 Pc0 1a00 1fA0 1Bc0 Mo0 1tc0 Uo0 1tA0 U00 1uo0 W00 1s00 VA0 1so0 Vc0 1sM0 UM0 1wo0 Rc0 1u00 Wo0 1rA0 W00 1s00 VA0 1sM0 UM0 1w00 fV0 BCX.w 1tA0 U00 1u00 Wo0 1sm0 601k WM0 1fA0 1cM0 1cM0 1cM0 16M0 1gMM0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|16e5","Europe/Andorra|WET CET CEST|0 -10 -20|012121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-UBA0 1xIN0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|79e3","Europe/Astrakhan|LMT +03 +04 +05|-3c.c -30 -40 -50|012323232323232323212121212121212121212121212121212121212121212|-1Pcrc.c eUMc.c 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 2pB0 1cM0 1fA0 1cM0 3Ck0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0 3rd0","Europe/Athens|AMT EET EEST CEST CET|-1y.Q -20 -30 -20 -10|012123434121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2a61x.Q CNbx.Q mn0 kU10 9b0 3Es0 Xa0 1fb0 1dd0 k3X0 Nz0 SCp0 1vc0 SO0 1cM0 1a00 1ao0 1fc0 1a10 1fG0 1cg0 1dX0 1bX0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|35e5","Europe/London|GMT BST BDST|0 -10 -20|0101010101010101010101010101010101010101010101010121212121210101210101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2axa0 Rc0 1fA0 14M0 1fc0 1g00 1co0 1dc0 1co0 1oo0 1400 1dc0 19A0 1io0 1io0 WM0 1o00 14o0 1o00 17c0 1io0 17c0 1fA0 1a00 1lc0 17c0 1io0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1cM0 1io0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1a00 1io0 1qM0 Dc0 2Rz0 Dc0 1zc0 Oo0 1zc0 Rc0 1wo0 17c0 1iM0 FA0 xB0 1fA0 1a00 14o0 bb0 LA0 xB0 Rc0 1wo0 11A0 1o00 17c0 1fA0 1a00 1fA0 1cM0 1fA0 1a00 17c0 1fA0 1a00 1io0 17c0 1lc0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1a00 1a00 1qM0 WM0 1qM0 11A0 1o00 WM0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1tA0 IM0 90o0 U00 1tA0 U00 1tA0 U00 1tA0 U00 1tA0 WM0 1qM0 WM0 1qM0 WM0 1tA0 U00 1tA0 U00 1tA0 11z0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1o00 14o0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|10e6","Europe/Belgrade|CET CEST|-10 -20|01010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-19RC0 3IP0 WM0 1fA0 1cM0 1cM0 1rc0 Qo0 1vmo0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|12e5","Europe/Berlin|CET CEST CEMT|-10 -20 -30|01010101010101210101210101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aFe0 11d0 1iO0 11A0 1o00 11A0 Qrc0 6i00 WM0 1fA0 1cM0 1cM0 1cM0 kL0 Nc0 m10 WM0 1ao0 1cp0 dX0 jz0 Dd0 1io0 17c0 1fA0 1a00 1ehA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|41e5","Europe/Prague|CET CEST|-10 -20|010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aFe0 11d0 1iO0 11A0 1o00 11A0 Qrc0 6i00 WM0 1fA0 1cM0 16M0 1lc0 1tA0 17A0 11c0 1io0 17c0 1io0 17c0 1fc0 1ao0 1bNc0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|13e5","Europe/Brussels|WET CET CEST WEST|0 -10 -20 -10|0121212103030303030303030303030303030303030303030303212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2ehc0 3zX0 11c0 1iO0 11A0 1o00 11A0 my0 Ic0 1qM0 Rc0 1EM0 UM0 1u00 10o0 1io0 1io0 17c0 1a00 1fA0 1cM0 1cM0 1io0 17c0 1fA0 1a00 1io0 1a30 1io0 17c0 1fA0 1a00 1io0 17c0 1cM0 1cM0 1a00 1io0 1cM0 1cM0 1a00 1fA0 1io0 17c0 1cM0 1cM0 1a00 1fA0 1io0 1qM0 Dc0 y00 5Wn0 WM0 1fA0 1cM0 16M0 1iM0 16M0 1C00 Uo0 1eeo0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|21e5","Europe/Bucharest|BMT EET EEST|-1I.o -20 -30|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1xApI.o 20LI.o RA0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1Axc0 On0 1fA0 1a10 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cK0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cL0 1cN0 1cL0 1fB0 1nX0 11E0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|19e5","Europe/Budapest|CET CEST|-10 -20|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aFe0 11d0 1iO0 11A0 1ip0 17b0 1op0 1tb0 Q2m0 3Ne0 WM0 1fA0 1cM0 1cM0 1oJ0 1dc0 1030 1fA0 1cM0 1cM0 1cM0 1cM0 1fA0 1a00 1iM0 1fA0 8Ha0 Rb0 1wN0 Rb0 1BB0 Lz0 1C20 LB0 SNX0 1a10 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|17e5","Europe/Zurich|CET CEST|-10 -20|01010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-19Lc0 11A0 1o00 11A0 1xG10 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|38e4","Europe/Chisinau|CMT BMT EET EEST CEST CET MSK MSD|-1T -1I.o -20 -30 -20 -10 -30 -40|012323232323232323234545467676767676767676767323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232|-26jdT wGMa.A 20LI.o RA0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 27A0 2en0 39g0 WM0 1fA0 1cM0 V90 1t7z0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 gL0 WO0 1cM0 1cM0 1cK0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 1nX0 11D0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|67e4","Europe/Copenhagen|CET CEST|-10 -20|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2azC0 Tz0 VuO0 60q0 WM0 1fA0 1cM0 1cM0 1cM0 S00 1HA0 Nc0 1C00 Dc0 1Nc0 Ao0 1h5A0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|12e5","Europe/Gibraltar|GMT BST BDST CET CEST|0 -10 -20 -10 -20|010101010101010101010101010101010101010101010101012121212121010121010101010101010101034343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343|-2axa0 Rc0 1fA0 14M0 1fc0 1g00 1co0 1dc0 1co0 1oo0 1400 1dc0 19A0 1io0 1io0 WM0 1o00 14o0 1o00 17c0 1io0 17c0 1fA0 1a00 1lc0 17c0 1io0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1cM0 1io0 17c0 1fA0 1a00 1io0 17c0 1io0 17c0 1fA0 1a00 1io0 1qM0 Dc0 2Rz0 Dc0 1zc0 Oo0 1zc0 Rc0 1wo0 17c0 1iM0 FA0 xB0 1fA0 1a00 14o0 bb0 LA0 xB0 Rc0 1wo0 11A0 1o00 17c0 1fA0 1a00 1fA0 1cM0 1fA0 1a00 17c0 1fA0 1a00 1io0 17c0 1lc0 17c0 1fA0 10Jz0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|30e3","Europe/Helsinki|HMT EET EEST|-1D.N -20 -30|0121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-1WuND.N OULD.N 1dA0 1xGq0 1cM0 1cM0 1cM0 1cN0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|12e5","Europe/Kaliningrad|CET CEST CET CEST MSK MSD EEST EET FET|-10 -20 -20 -30 -30 -40 -30 -20 -30|0101010101010232454545454545454546767676767676767676767676767676767676767676787|-2aFe0 11d0 1iO0 11A0 1o00 11A0 Qrc0 6i00 WM0 1fA0 1cM0 1cM0 Am0 Lb0 1en0 op0 1pNz0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1fA0 1cM0 1cM0 1cJ0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|44e4","Europe/Kiev|KMT EET MSK CEST CET MSD EEST|-22.4 -20 -30 -20 -10 -40 -30|0123434252525252525252525256161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161|-1Pc22.4 eUo2.4 rnz0 2Hg0 WM0 1fA0 da0 1v4m0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 Db0 3220 1cK0 1cL0 1cN0 1cL0 1cN0 1cL0 1cQ0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|34e5","Europe/Lisbon|LMT WET WEST WEMT CET CEST|A.J 0 -10 -20 -10 -20|012121212121212121212121212121212121212121212321232123212321212121212121212121212121212121212121214121212121212121212121212121212124545454212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2ldXn.f aPWn.f Sp0 LX0 1vc0 Tc0 1uM0 SM0 1vc0 Tc0 1vc0 SM0 1vc0 6600 1co0 3E00 17c0 1fA0 1a00 1io0 1a00 1io0 17c0 3I00 17c0 1cM0 1cM0 3Fc0 1cM0 1a00 1fA0 1io0 17c0 1cM0 1cM0 1a00 1fA0 1io0 1qM0 Dc0 1tA0 1cM0 1dc0 1400 gL0 IM0 s10 U00 dX0 Rc0 pd0 Rc0 gL0 Oo0 pd0 Rc0 gL0 Oo0 pd0 14o0 1cM0 1cP0 1cM0 1cM0 1cM0 1cM0 1cM0 3Co0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 pvy0 1cM0 1cM0 1fA0 1cM0 1cM0 1cN0 1cL0 1cN0 1cM0 1cM0 1cM0 1cM0 1cN0 1cL0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|27e5","Europe/Luxembourg|LMT CET CEST WET WEST WEST WET|-o.A -10 -20 0 -10 -20 -10|0121212134343434343434343434343434343434343434343434565651212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2DG0o.A t6mo.A TB0 1nX0 Up0 1o20 11A0 rW0 CM0 1qP0 R90 1EO0 UK0 1u20 10m0 1ip0 1in0 17e0 19W0 1fB0 1db0 1cp0 1in0 17d0 1fz0 1a10 1in0 1a10 1in0 17f0 1fA0 1a00 1io0 17c0 1cM0 1cM0 1a00 1io0 1cM0 1cM0 1a00 1fA0 1io0 17c0 1cM0 1cM0 1a00 1fA0 1io0 1qM0 Dc0 vA0 60L0 WM0 1fA0 1cM0 17c0 1io0 16M0 1C00 Uo0 1eeo0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|54e4","Europe/Madrid|WET WEST WEMT CET CEST|0 -10 -20 -10 -20|01010101010101010101010121212121234343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343|-28dd0 11A0 1go0 19A0 1co0 1dA0 b1A0 18o0 3I00 17c0 1fA0 1a00 1io0 1a00 1io0 17c0 iyo0 Rc0 18o0 1hc0 1io0 1a00 14o0 5aL0 MM0 1vc0 17A0 1i00 1bc0 1eo0 17d0 1in0 17A0 6hA0 10N0 XIL0 1a10 1in0 17d0 19X0 1cN0 1fz0 1a10 1fX0 1cp0 1cO0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|62e5","Europe/Malta|CET CEST|-10 -20|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2as10 M00 1cM0 1cM0 14o0 1o00 WM0 1qM0 17c0 1cM0 M3A0 5M20 WM0 1fA0 1cM0 1cM0 1cM0 16m0 1de0 1lc0 14m0 1lc0 WO0 1qM0 GTW0 On0 1C10 Lz0 1C10 Lz0 1EN0 Lz0 1C10 Lz0 1zd0 Oo0 1C00 On0 1cp0 1cM0 1lA0 Xc0 1qq0 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1o10 11z0 1iN0 19z0 1fB0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|42e4","Europe/Minsk|MMT EET MSK CEST CET MSD EEST FET|-1O -20 -30 -20 -10 -40 -30 -30|012343432525252525252525252616161616161616161616161616161616161616172|-1Pc1O eUnO qNX0 3gQ0 WM0 1fA0 1cM0 Al0 1tsn0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 3Fc0 1cN0 1cK0 1cM0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hy0|19e5","Europe/Monaco|PMT WET WEST WEMT CET CEST|-9.l 0 -10 -20 -10 -20|01212121212121212121212121212121212121212121212121232323232345454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454|-2nco9.l cNb9.l HA0 19A0 1iM0 11c0 1oo0 Wo0 1rc0 QM0 1EM0 UM0 1u00 10o0 1io0 1wo0 Rc0 1a00 1fA0 1cM0 1cM0 1io0 17c0 1fA0 1a00 1io0 1a00 1io0 17c0 1fA0 1a00 1io0 17c0 1cM0 1cM0 1a00 1io0 1cM0 1cM0 1a00 1fA0 1io0 17c0 1cM0 1cM0 1a00 1fA0 1io0 1qM0 Df0 2RV0 11z0 11B0 1ze0 WM0 1fA0 1cM0 1fa0 1aq0 16M0 1ekn0 1cL0 1fC0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|38e3","Europe/Moscow|MMT MMT MST MDST MSD MSK MSM EET EEST MSK|-2u.h -2v.j -3v.j -4v.j -40 -30 -50 -20 -30 -40|012132345464575454545454545454545458754545454545454545454545454545454545454595|-2ag2u.h 2pyW.W 1bA0 11X0 GN0 1Hb0 c20 imv.j 3DA0 dz0 15A0 c10 2q10 iM10 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|16e6","Europe/Paris|PMT WET WEST CEST CET WEMT|-9.l 0 -10 -20 -10 -20|0121212121212121212121212121212121212121212121212123434352543434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434343434|-2nco8.l cNb8.l HA0 19A0 1iM0 11c0 1oo0 Wo0 1rc0 QM0 1EM0 UM0 1u00 10o0 1io0 1wo0 Rc0 1a00 1fA0 1cM0 1cM0 1io0 17c0 1fA0 1a00 1io0 1a00 1io0 17c0 1fA0 1a00 1io0 17c0 1cM0 1cM0 1a00 1io0 1cM0 1cM0 1a00 1fA0 1io0 17c0 1cM0 1cM0 1a00 1fA0 1io0 1qM0 Df0 Ik0 5M30 WM0 1fA0 1cM0 Vx0 hB0 1aq0 16M0 1ekn0 1cL0 1fC0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|11e6","Europe/Riga|RMT LST EET MSK CEST CET MSD EEST|-1A.y -2A.y -20 -30 -20 -10 -40 -30|010102345454536363636363636363727272727272727272727272727272727272727272727272727272727272727272727272727272727272727272727272|-25TzA.y 11A0 1iM0 ko0 gWm0 yDXA.y 2bX0 3fE0 WM0 1fA0 1cM0 1cM0 4m0 1sLy0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cN0 1o00 11A0 1o00 11A0 1qM0 3oo0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|64e4","Europe/Rome|CET CEST|-10 -20|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2as10 M00 1cM0 1cM0 14o0 1o00 WM0 1qM0 17c0 1cM0 M3A0 5M20 WM0 1fA0 1cM0 16K0 1iO0 16m0 1de0 1lc0 14m0 1lc0 WO0 1qM0 GTW0 On0 1C10 Lz0 1C10 Lz0 1EN0 Lz0 1C10 Lz0 1zd0 Oo0 1C00 On0 1C10 Lz0 1zd0 On0 1C10 LA0 1C00 LA0 1zc0 Oo0 1C00 Oo0 1zc0 Oo0 1fC0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|39e5","Europe/Samara|LMT SAMT SAMT KUYT KUYST MSD MSK EEST SAMST SAMST|-3k.k -30 -40 -40 -50 -40 -30 -30 -50 -40|012343434343434343435656712828282828282828282828282828282828282912|-22WNk.k qHak.k bcn0 1Qqo0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1fA0 1cM0 1cN0 8o0 14j0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qN0 WM0|12e5","Europe/Simferopol|SMT EET MSK CEST CET MSD EEST MSK|-2g -20 -30 -20 -10 -40 -30 -40|012343432525252525252525252161616525252616161616161616161616161616161616172|-1Pc2g eUog rEn0 2qs0 WM0 1fA0 1cM0 3V0 1u0L0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1Q00 4eL0 1cL0 1cN0 1cL0 1cN0 dX0 WL0 1cN0 1cL0 1fB0 1o30 11B0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11z0 1nW0|33e4","Europe/Sofia|EET CET CEST EEST|-20 -10 -20 -30|01212103030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030|-168L0 WM0 1fA0 1cM0 1cM0 1cN0 1mKH0 1dd0 1fb0 1ap0 1fb0 1a20 1fy0 1a30 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cK0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 1nX0 11E0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|12e5","Europe/Stockholm|CET CEST|-10 -20|01010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2azC0 TB0 2yDe0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|15e5","Europe/Tallinn|TMT CET CEST EET MSK MSD EEST|-1D -10 -20 -20 -30 -40 -30|012103421212454545454545454546363636363636363636363636363636363636363636363636363636363636363636363636363636363636363636363|-26oND teD 11A0 1Ta0 4rXl KSLD 2FX0 2Jg0 WM0 1fA0 1cM0 18J0 1sTX0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o10 11A0 1qM0 5QM0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|41e4","Europe/Tirane|LMT CET CEST|-1j.k -10 -20|01212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2glBj.k 14pcj.k 5LC0 WM0 4M0 1fCK0 10n0 1op0 11z0 1pd0 11z0 1qN0 WL0 1qp0 Xb0 1qp0 Xb0 1qp0 11z0 1lB0 11z0 1qN0 11z0 1iN0 16n0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|42e4","Europe/Ulyanovsk|LMT +03 +04 +05 +02|-3d.A -30 -40 -50 -20|01232323232323232321214121212121212121212121212121212121212121212|-22WNd.A qHad.A 23CL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 2pB0 1cM0 1fA0 2pB0 IM0 rU0 1cL0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0 3rd0","Europe/Uzhgorod|CET CEST MSK MSD EET EEST|-10 -20 -30 -40 -20 -30|010101023232323232323232320454545454545454545454545454545454545454545454545454545454545454545454545454545454545454545454|-1cqL0 6i00 WM0 1fA0 1cM0 1ml0 1Cp0 1r3W0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1Q00 1Nf0 2pw0 1cL0 1cN0 1cL0 1cN0 1cL0 1cQ0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|11e4","Europe/Vienna|CET CEST|-10 -20|0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aFe0 11d0 1iO0 11A0 1o00 11A0 3KM0 14o0 LA00 6i00 WM0 1fA0 1cM0 1cM0 1cM0 400 2qM0 1a00 1cM0 1cM0 1io0 17c0 1gHa0 19X0 1cP0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|18e5","Europe/Vilnius|WMT KMT CET EET MSK CEST MSD EEST|-1o -1z.A -10 -20 -30 -20 -40 -30|012324525254646464646464646473737373737373737352537373737373737373737373737373737373737373737373737373737373737373737373|-293do 6ILM.o 1Ooz.A zz0 Mfd0 29W0 3is0 WM0 1fA0 1cM0 LV0 1tgL0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11B0 1o00 11A0 1qM0 8io0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|54e4","Europe/Volgograd|LMT TSAT STAT STAT VOLT VOLST VOLST VOLT MSD MSK MSK|-2V.E -30 -30 -40 -40 -50 -40 -30 -40 -30 -40|0123454545454545454676767489898989898989898989898989898989898989a9|-21IqV.E cLXV.E cEM0 1gqn0 Lco0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1cM0 1cM0 1fA0 1cM0 2pz0 1cJ0 1cQ0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 8Hz0|10e5","Europe/Warsaw|WMT CET CEST EET EEST|-1o -10 -20 -20 -30|012121234312121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121|-2ctdo 1LXo 11d0 1iO0 11A0 1o00 11A0 1on0 11A0 6zy0 HWP0 5IM0 WM0 1fA0 1cM0 1dz0 1mL0 1en0 15B0 1aq0 1nA0 11A0 1io0 17c0 1fA0 1a00 iDX0 LA0 1cM0 1cM0 1C00 Oo0 1cM0 1cM0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1C00 LA0 uso0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cN0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|17e5","Europe/Zaporozhye|CUT EET MSK CEST CET MSD EEST|-2k -20 -30 -20 -10 -40 -30|01234342525252525252525252526161616161616161616161616161616161616161616161616161616161616161616161616161616161616161616161|-1Pc2k eUok rdb0 2RE0 WM0 1fA0 8m0 1v9a0 1db0 1cN0 1db0 1cN0 1db0 1dd0 1cO0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cK0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cQ0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00|77e4","HST|HST|a0|0|","Indian/Chagos|LMT IOT IOT|-4N.E -50 -60|012|-2xosN.E 3AGLN.E|30e2","Indian/Christmas|CXT|-70|0||21e2","Indian/Cocos|CCT|-6u|0||596","Indian/Kerguelen|zzz TFT|0 -50|01|-MG00|130","Indian/Mahe|LMT SCT|-3F.M -40|01|-2yO3F.M|79e3","Indian/Maldives|MMT MVT|-4S -50|01|-olgS|35e4","Indian/Mauritius|LMT MUT MUST|-3O -40 -50|012121|-2xorO 34unO 14L0 12kr0 11z0|15e4","Indian/Reunion|LMT RET|-3F.Q -40|01|-2mDDF.Q|84e4","Pacific/Kwajalein|MHT KWAT MHT|-b0 c0 -c0|012|-AX0 W9X0|14e3","MET|MET MEST|-10 -20|01010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-2aFe0 11d0 1iO0 11A0 1o00 11A0 Qrc0 6i00 WM0 1fA0 1cM0 1cM0 1cM0 16M0 1gMM0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00","MST|MST|70|0|","MST7MDT|MST MDT MWT MPT|70 60 60 60|010102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261r0 1nX0 11B0 1nX0 SgN0 8x20 ix0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","Pacific/Chatham|CHAST CHAST CHADT|-cf -cJ -dJ|012121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212121212|-WqAf 1adef IM0 1C00 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Oo0 1zc0 Rc0 1zc0 Oo0 1qM0 14o0 1lc0 14o0 1lc0 14o0 1lc0 17c0 1io0 17c0 1io0 17c0 1io0 17c0 1lc0 14o0 1lc0 14o0 1lc0 17c0 1io0 17c0 1io0 17c0 1lc0 14o0 1lc0 14o0 1lc0 17c0 1io0 17c0 1io0 17c0 1io0 17c0 1io0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1io0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00|600","PST8PDT|PST PDT PWT PPT|80 70 70 70|010102301010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|-261q0 1nX0 11B0 1nX0 SgN0 8x10 iy0 QwN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1cN0 1cL0 1cN0 1cL0 s10 1Vz0 LB0 1BX0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1fz0 1a10 1fz0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 14p0 1lb0 14p0 1lb0 14p0 1nX0 11B0 1nX0 11B0 1nX0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Rd0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0 Op0 1zb0","Pacific/Apia|LMT WSST SST SDT WSDT WSST|bq.U bu b0 a0 -e0 -d0|01232345454545454545454545454545454545454545454545454545454|-2nDMx.4 1yW03.4 2rRbu 1ff0 1a00 CI0 AQ0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1io0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1a00 1fA0 1cM0 1fA0 1a00 1fA0 1a00|37e3","Pacific/Bougainville|PGT JST BST|-a0 -90 -b0|0102|-16Wy0 7CN0 2MQp0|18e4","Pacific/Chuuk|CHUT|-a0|0||49e3","Pacific/Efate|LMT VUT VUST|-bd.g -b0 -c0|0121212121212121212121|-2l9nd.g 2Szcd.g 1cL0 1oN0 10L0 1fB0 19X0 1fB0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1cN0 1cL0 1fB0 Lz0 1Nd0 An0|66e3","Pacific/Enderbury|PHOT PHOT PHOT|c0 b0 -d0|012|nIc0 B8n0|1","Pacific/Fakaofo|TKT TKT|b0 -d0|01|1Gfn0|483","Pacific/Fiji|LMT FJT FJST|-bT.I -c0 -d0|0121212121212121212121212121212121212121212121212121212121212121|-2bUzT.I 3m8NT.I LA0 1EM0 IM0 nJc0 LA0 1o00 Rc0 1wo0 Ao0 1Nc0 Ao0 1Q00 xz0 1SN0 uM0 1SM0 uM0 1VA0 s00 1VA0 uM0 1SM0 uM0 1SM0 uM0 1SM0 uM0 1VA0 s00 1VA0 s00 1VA0 uM0 1SM0 uM0 1SM0 uM0 1SM0 uM0 1VA0 s00 1VA0 uM0 1SM0 uM0 1SM0 uM0 1SM0 uM0 1VA0 s00 1VA0 s00 1VA0 uM0 1SM0 uM0 1SM0 uM0 1SM0 uM0|88e4","Pacific/Funafuti|TVT|-c0|0||45e2","Pacific/Galapagos|LMT ECT GALT|5W.o 50 60|012|-1yVS1.A 2dTz1.A|25e3","Pacific/Gambier|LMT GAMT|8X.M 90|01|-2jof0.c|125","Pacific/Guadalcanal|LMT SBT|-aD.M -b0|01|-2joyD.M|11e4","Pacific/Guam|GST ChST|-a0 -a0|01|1fpq0|17e4","Pacific/Honolulu|HST HDT HST|au 9u a0|010102|-1thLu 8x0 lef0 8Pz0 46p0|37e4","Pacific/Kiritimati|LINT LINT LINT|aE a0 -e0|012|nIaE B8nk|51e2","Pacific/Kosrae|KOST KOST|-b0 -c0|010|-AX0 1bdz0|66e2","Pacific/Majuro|MHT MHT|-b0 -c0|01|-AX0|28e3","Pacific/Marquesas|LMT MART|9i 9u|01|-2joeG|86e2","Pacific/Pago_Pago|LMT NST BST SST|bm.M b0 b0 b0|0123|-2nDMB.c 2gVzB.c EyM0|37e2","Pacific/Nauru|LMT NRT JST NRT|-b7.E -bu -90 -c0|01213|-1Xdn7.E PvzB.E 5RCu 1ouJu|10e3","Pacific/Niue|NUT NUT NUT|bk bu b0|012|-KfME 17y0a|12e2","Pacific/Norfolk|NMT NFT NFST NFT|-bc -bu -cu -b0|01213|-Kgbc W01G On0 1COp0|25e4","Pacific/Noumea|LMT NCT NCST|-b5.M -b0 -c0|01212121|-2l9n5.M 2EqM5.M xX0 1PB0 yn0 HeP0 Ao0|98e3","Pacific/Palau|PWT|-90|0||21e3","Pacific/Pitcairn|PNT PST|8u 80|01|18Vku|56","Pacific/Pohnpei|PONT|-b0|0||34e3","Pacific/Port_Moresby|PGT|-a0|0||25e4","Pacific/Rarotonga|CKT CKHST CKT|au 9u a0|012121212121212121212121212|lyWu IL0 1zcu Onu 1zcu Onu 1zcu Rbu 1zcu Onu 1zcu Onu 1zcu Onu 1zcu Onu 1zcu Onu 1zcu Rbu 1zcu Onu 1zcu Onu 1zcu Onu|13e3","Pacific/Tahiti|LMT TAHT|9W.g a0|01|-2joe1.I|18e4","Pacific/Tarawa|GILT|-c0|0||29e3","Pacific/Tongatapu|TOT TOT TOST|-ck -d0 -e0|01212121|-1aB0k 2n5dk 15A0 1wo0 xz0 1Q10 xz0|75e3","Pacific/Wake|WAKT|-c0|0||16e3","Pacific/Wallis|WFT|-c0|0||94","WET|WET WEST|0 -10|010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010|hDB0 1a00 1fA0 1cM0 1cM0 1cM0 1fA0 1a00 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1cM0 1fA0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00 11A0 1qM0 WM0 1qM0 WM0 1qM0 WM0 1qM0 11A0 1o00 11A0 1o00"],
links:["Africa/Abidjan|Africa/Bamako","Africa/Abidjan|Africa/Banjul","Africa/Abidjan|Africa/Conakry","Africa/Abidjan|Africa/Dakar","Africa/Abidjan|Africa/Freetown","Africa/Abidjan|Africa/Lome","Africa/Abidjan|Africa/Nouakchott","Africa/Abidjan|Africa/Ouagadougou","Africa/Abidjan|Africa/Sao_Tome","Africa/Abidjan|Africa/Timbuktu","Africa/Abidjan|Atlantic/St_Helena","Africa/Cairo|Egypt","Africa/Johannesburg|Africa/Maseru","Africa/Johannesburg|Africa/Mbabane","Africa/Khartoum|Africa/Juba","Africa/Lagos|Africa/Bangui","Africa/Lagos|Africa/Brazzaville","Africa/Lagos|Africa/Douala","Africa/Lagos|Africa/Kinshasa","Africa/Lagos|Africa/Libreville","Africa/Lagos|Africa/Luanda","Africa/Lagos|Africa/Malabo","Africa/Lagos|Africa/Niamey","Africa/Lagos|Africa/Porto-Novo","Africa/Maputo|Africa/Blantyre","Africa/Maputo|Africa/Bujumbura","Africa/Maputo|Africa/Gaborone","Africa/Maputo|Africa/Harare","Africa/Maputo|Africa/Kigali","Africa/Maputo|Africa/Lubumbashi","Africa/Maputo|Africa/Lusaka","Africa/Nairobi|Africa/Addis_Ababa","Africa/Nairobi|Africa/Asmara","Africa/Nairobi|Africa/Asmera","Africa/Nairobi|Africa/Dar_es_Salaam","Africa/Nairobi|Africa/Djibouti","Africa/Nairobi|Africa/Kampala","Africa/Nairobi|Africa/Mogadishu","Africa/Nairobi|Indian/Antananarivo","Africa/Nairobi|Indian/Comoro","Africa/Nairobi|Indian/Mayotte","Africa/Tripoli|Libya","America/Adak|America/Atka","America/Adak|US/Aleutian","America/Anchorage|US/Alaska","America/Argentina/Buenos_Aires|America/Buenos_Aires","America/Argentina/Catamarca|America/Argentina/ComodRivadavia","America/Argentina/Catamarca|America/Catamarca","America/Argentina/Cordoba|America/Cordoba","America/Argentina/Cordoba|America/Rosario","America/Argentina/Jujuy|America/Jujuy","America/Argentina/Mendoza|America/Mendoza","America/Atikokan|America/Coral_Harbour","America/Chicago|US/Central","America/Curacao|America/Aruba","America/Curacao|America/Kralendijk","America/Curacao|America/Lower_Princes","America/Denver|America/Shiprock","America/Denver|Navajo","America/Denver|US/Mountain","America/Detroit|US/Michigan","America/Edmonton|Canada/Mountain","America/Fort_Wayne|America/Indiana/Indianapolis","America/Fort_Wayne|America/Indianapolis","America/Fort_Wayne|US/East-Indiana","America/Halifax|Canada/Atlantic","America/Havana|Cuba","America/Indiana/Knox|America/Knox_IN","America/Indiana/Knox|US/Indiana-Starke","America/Jamaica|Jamaica","America/Kentucky/Louisville|America/Louisville","America/Los_Angeles|US/Pacific","America/Los_Angeles|US/Pacific-New","America/Manaus|Brazil/West","America/Mazatlan|Mexico/BajaSur","America/Mexico_City|Mexico/General","America/New_York|US/Eastern","America/Noronha|Brazil/DeNoronha","America/Panama|America/Cayman","America/Phoenix|US/Arizona","America/Port_of_Spain|America/Anguilla","America/Port_of_Spain|America/Antigua","America/Port_of_Spain|America/Dominica","America/Port_of_Spain|America/Grenada","America/Port_of_Spain|America/Guadeloupe","America/Port_of_Spain|America/Marigot","America/Port_of_Spain|America/Montserrat","America/Port_of_Spain|America/St_Barthelemy","America/Port_of_Spain|America/St_Kitts","America/Port_of_Spain|America/St_Lucia","America/Port_of_Spain|America/St_Thomas","America/Port_of_Spain|America/St_Vincent","America/Port_of_Spain|America/Tortola","America/Port_of_Spain|America/Virgin","America/Regina|Canada/East-Saskatchewan","America/Regina|Canada/Saskatchewan","America/Rio_Branco|America/Porto_Acre","America/Rio_Branco|Brazil/Acre","America/Santiago|Chile/Continental","America/Sao_Paulo|Brazil/East","America/St_Johns|Canada/Newfoundland","America/Tijuana|America/Ensenada","America/Tijuana|America/Santa_Isabel","America/Tijuana|Mexico/BajaNorte","America/Toronto|America/Montreal","America/Toronto|Canada/Eastern","America/Vancouver|Canada/Pacific","America/Whitehorse|Canada/Yukon","America/Winnipeg|Canada/Central","Asia/Ashgabat|Asia/Ashkhabad","Asia/Bangkok|Asia/Phnom_Penh","Asia/Bangkok|Asia/Vientiane","Asia/Dhaka|Asia/Dacca","Asia/Dubai|Asia/Muscat","Asia/Ho_Chi_Minh|Asia/Saigon","Asia/Hong_Kong|Hongkong","Asia/Jerusalem|Asia/Tel_Aviv","Asia/Jerusalem|Israel","Asia/Kathmandu|Asia/Katmandu","Asia/Kolkata|Asia/Calcutta","Asia/Macau|Asia/Macao","Asia/Makassar|Asia/Ujung_Pandang","Asia/Nicosia|Europe/Nicosia","Asia/Qatar|Asia/Bahrain","Asia/Riyadh|Asia/Aden","Asia/Riyadh|Asia/Kuwait","Asia/Seoul|ROK","Asia/Shanghai|Asia/Chongqing","Asia/Shanghai|Asia/Chungking","Asia/Shanghai|Asia/Harbin","Asia/Shanghai|PRC","Asia/Singapore|Singapore","Asia/Taipei|ROC","Asia/Tehran|Iran","Asia/Thimphu|Asia/Thimbu","Asia/Tokyo|Japan","Asia/Ulaanbaatar|Asia/Ulan_Bator","Asia/Urumqi|Asia/Kashgar","Atlantic/Faroe|Atlantic/Faeroe","Atlantic/Reykjavik|Iceland","Australia/Adelaide|Australia/South","Australia/Brisbane|Australia/Queensland","Australia/Broken_Hill|Australia/Yancowinna","Australia/Darwin|Australia/North","Australia/Hobart|Australia/Tasmania","Australia/Lord_Howe|Australia/LHI","Australia/Melbourne|Australia/Victoria","Australia/Perth|Australia/West","Australia/Sydney|Australia/ACT","Australia/Sydney|Australia/Canberra","Australia/Sydney|Australia/NSW","Etc/GMT+0|Etc/GMT","Etc/GMT+0|Etc/GMT-0","Etc/GMT+0|Etc/GMT0","Etc/GMT+0|Etc/Greenwich","Etc/GMT+0|GMT","Etc/GMT+0|GMT+0","Etc/GMT+0|GMT-0","Etc/GMT+0|GMT0","Etc/GMT+0|Greenwich","Etc/UCT|UCT","Etc/UTC|Etc/Universal","Etc/UTC|Etc/Zulu","Etc/UTC|UTC","Etc/UTC|Universal","Etc/UTC|Zulu","Europe/Belgrade|Europe/Ljubljana","Europe/Belgrade|Europe/Podgorica","Europe/Belgrade|Europe/Sarajevo","Europe/Belgrade|Europe/Skopje","Europe/Belgrade|Europe/Zagreb","Europe/Chisinau|Europe/Tiraspol","Europe/Dublin|Eire","Europe/Helsinki|Europe/Mariehamn","Europe/Istanbul|Asia/Istanbul","Europe/Istanbul|Turkey","Europe/Lisbon|Portugal","Europe/London|Europe/Belfast","Europe/London|Europe/Guernsey","Europe/London|Europe/Isle_of_Man","Europe/London|Europe/Jersey","Europe/London|GB","Europe/London|GB-Eire","Europe/Moscow|W-SU","Europe/Oslo|Arctic/Longyearbyen","Europe/Oslo|Atlantic/Jan_Mayen","Europe/Prague|Europe/Bratislava","Europe/Rome|Europe/San_Marino","Europe/Rome|Europe/Vatican","Europe/Warsaw|Poland","Europe/Zurich|Europe/Busingen","Europe/Zurich|Europe/Vaduz","Pacific/Auckland|Antarctica/McMurdo","Pacific/Auckland|Antarctica/South_Pole","Pacific/Auckland|NZ","Pacific/Chatham|NZ-CHAT","Pacific/Chuuk|Pacific/Truk","Pacific/Chuuk|Pacific/Yap","Pacific/Easter|Chile/EasterIsland","Pacific/Guam|Pacific/Saipan","Pacific/Honolulu|Pacific/Johnston","Pacific/Honolulu|US/Hawaii","Pacific/Kwajalein|Kwajalein","Pacific/Pago_Pago|Pacific/Midway","Pacific/Pago_Pago|Pacific/Samoa","Pacific/Pago_Pago|US/Samoa","Pacific/Pohnpei|Pacific/Ponape"]}),a});


!!!moment || moment.tz.link(["Europe/Moscow|Europe/Kirov","Asia/Bangkok|Asia/Tomsk","Asia/Rangoon|Asia/Yangon","Asia/Riyadh|Asia/Riyadh89","Asia/Riyadh|Asia/Riyadh88","Asia/Riyadh|Asia/Riyadh87","Asia/Riyadh|Mideast/Riyadh89","Asia/Riyadh|Mideast/Riyadh88","Asia/Riyadh|Mideast/Riyadh87","America/Bahia|America/Punta_Arenas","Africa/Cairo|Asia/Famagusta","Asia/Dubai|Europe/Saratov","Asia/Oral|Asia/Atyrau","Etc/GMT-6|BST","EST|SystemV/EST5", "PST8PDT|SystemV/PST8PDT","EST5EDT|SystemV/EST5EDT","MST|SystemV/MST7","MST7MDT|SystemV/MST7MDT","Etc/GMT+9|SystemV/YST9","HST|SystemV/HST10", "America/Curacao|SystemV/AST4","America/Curacao|SystemV/AST4ADT","Etc/GMT+9|SystemV/YST9YDT","CST6CDT|SystemV/CST6CDT","Etc/GMT+8|SystemV/PST8","Etc/GMT+6|SystemV/CST6","Etc/GMT-2|ART","Etc/GMT-2|CAT","Etc/GMT+9|AST","Etc/GMT-9|JST","Etc/GMT-8|CTT","Etc/GMT-5|PLT","Etc/GMT+5|IET","Etc/GMT-3|EAT","Etc/GMT-1|ECT","Etc/GMT-4|NET","Australia/Darwin|ACT","Etc/GMT+2|BET","Etc/GMT-11|AET","Etc/GMT+3|AGT","Etc/GMT-14|MIT","America/St_Johns|CNT","Etc/GMT+7|PNT","Etc/GMT-7|VST","Etc/GMT-11|SST","Asia/Colombo|IST","Etc/GMT+4|PRT","Etc/GMT-13|NST","Etc/GMT+6|CST","Etc/GMT+8|PST"]);


if (window) window.__currentScriptPath = "/cms/scripts/CMSCommon.js";

var CMSCommon = {
    loadTeamLocale: function (url) {
    },
    getString: function(key, defaultValue) {
        if (!window.LOCALE_RAW_DATA) return defaultValue || key;
        return window.LOCALE_RAW_DATA[key] || defaultValue || key;
    },
    getMomentFormat: function(key) {
        var javaFormat = this.getString(key);
        return FormatUtil.javaToMomentFormat(javaFormat);

    },
    DateFormatter: {
        _format: function (date, initialFormat) {

        },
        long: function (date) {

        }
    },
    checkValidHtml: function(html, onCoolCallback) {
        $cmsService.getInvalidHtmlTags(html, function(tags) {
            if (tags) {
                var warningDialog = new HTMLWarningDialog(tags).callback(function (rs) {
                    if (rs && onCoolCallback) {
                        onCoolCallback();
                    }
                });
                warningDialog.open();
            } else {
                if (onCoolCallback) onCoolCallback();
            }
        });
    },
    em: function em(el) {
        if (!el) return Util.em();
        var size = parseFloat(window.getComputedStyle(el).fontSize);
        return size;
    }
};

CMSCommon.context = typeof(ADMIN_CONTEXT) != "undefined" ? ADMIN_CONTEXT :
	typeof(CONTEXT) != "undefined" ? CONTEXT : {localeUrl: ""};


if (window) window.__currentScriptPath = "/cms/scripts/analytics.js";

function sendAnalyticEvent(event, callback) {
    if (typeof(event) == "undefined") return;
    var thiz = this;
    var teamAlias = (typeof(TEAM_INFO) != "undefined" && TEAM_INFO.alias)
                 || (typeof(CONTEXT) != "undefined" && CONTEXT.teamAlias);
    var sendImpl = function(data) {
        ga(function() {
          // Logs an array of all tracker objects.
            var trackers = ga.getAll();
            if (!trackers || trackers.length == 0) {
                console.log("No trackers found to send ", event);
                if (callback) callback();
                return;
            }
            console.log("Start send tracking events....");
            for (var i = 0; i < trackers.length; i++) {
                var tracker = trackers[i];
                var name = tracker.get('name');
                if (name != "tuTracker") {
                    continue;
                }
                tracker.set("eventAction", data.action || "NoAction");
                tracker.set("eventCategory", data.category || "NoCategory");
                tracker.set("eventLabel", data.label || "NoLabel");
                if (typeof(data.value) != "undefined") {
                    tracker.set("eventValue", data.value);
                }
                console.log("Sending event ", data);
                ga(name  + ".send", "event");
            }
            if (callback) callback();
        });
    };
    var run = function() {
        if (window.ga && window.ga.loaded) {
            sendImpl(event);
        } else {
            if (callback) callback();
        }
    }
    if (typeof(AdminConsole) != "undefined") {
        run();
    } else {
        if (thiz._analyticsScriptLoaded || (window.ga && window.ga.loaded)) {
            run();
        } else {
            widget.__loadScript("/team/" + teamAlias +"/controller/cms/admin/analytics", function(res) {
                thiz._analyticsScriptLoaded = true;
                run();
            });
        }
    }
};

var googleAnalyticsService = {
    CATEGORY: {
        SIGNIN_START: "sso_signin_start",
        FIRSTTIME_SIGNIN: "sso_firsttime_signin",
        STOPSIGN_SIGNIN: "sso_stopsign_signin",
        SIGNIN_ORIGIN: "sso_signin_origin",
        ACCOUNT_PROFILE: "sso_account_profile"
    },
    teamAlias: (typeof(TEAM_INFO) != "undefined" && TEAM_INFO.alias) || (typeof(CONTEXT) != "undefined" && CONTEXT.teamAlias),
    sendAnalyticEvent: sendAnalyticEvent,
    sendSigninClickedEvent: function () {
        this.sendAnalyticEvent({
            category: this.CATEGORY.SIGNIN_START,
            action: "signin_clicked",
            label: this.teamAlias
        });
    },
    sendFirstTimeEvent: function (action, accountId) {
        this.sendAnalyticEvent({
            category: this.CATEGORY.FIRSTTIME_SIGNIN,
            action: action,
            label: this.teamAlias,
            value: accountId
        });
    },
    sendStopSignEvent: function (action, callback) {
        this.sendAnalyticEvent({
            category: this.CATEGORY.STOPSIGN_SIGNIN,
            action: action,
            label: this.teamAlias
        }, callback);
    },
    sendSigninOriginEvent: function (action, callback) {
        this.sendAnalyticEvent({
            category: this.CATEGORY.SIGNIN_ORIGIN,
            action: action,
            label: this.teamAlias
        }, callback);
    },
    sendMainSigninEvent: function(callback) {
        this.sendSigninOriginEvent("main_signin", callback);
    },
    sendMemberRegSigninEvent: function (callback) {
        this.sendSigninOriginEvent("memreg_signin", callback);
    },
    sendClassSigninEvent: function (callback) {
        this.sendSigninOriginEvent("class_signin", callback);
    },
    sendAccountProfileEvent: function (action, accountId) {
        this.sendAnalyticEvent({
            category: this.CATEGORY.ACCOUNT_PROFILE,
            action: action,
            label: this.teamAlias,
            value: accountId
        });
    }
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/AddResourceDialog.js";

function AddResourceDialog() {
	Dialog.call(this);
    this.title = "Create resource";

    this.bind("change", this.toggleInputType, this.typeDocument);
    this.bind("change", this.toggleInputType, this.typeUrl);
}
__extend(Dialog, AddResourceDialog);

AddResourceDialog.prototype.setup = function(contentPageId) {
    this.dataId.value = contentPageId;
    this.forData.value = "link";
}

AddResourceDialog.prototype.install = function () {
    var name = "callback" + (new Date().getTime());
    var thiz = this;
    window[name] = function (result) {
        delete window[name];
        thiz.onInstallResult(result);
    };
    this.callbackHiddenField.value = name;
    this.resourceUploadForm.submit();
};

AddResourceDialog.prototype.onInstallResult = function (result) {
    console.log("Result", result);
    if (!result.success) {
        Dialog.error("Error adding resource", result.message);
    } else {
        var thiz = this;
        Dialog.alert("Success!", "Resouce was successfully added.", function () {
            thiz.close(result);
        });
    }
};

AddResourceDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            isApplicable: function () {
                return true;
            },
            run: function () { return true; }
        },
        {
            type: "accept", title: "Create",
            isApplicable: function () {
                return true;
            },
            run: function() {
                this.createLink();
                return false;
            }
        }
    ]
};

AddResourceDialog.prototype.createLink = function() {
    var thiz = this;
    var type = this.resourceUploadForm.linkType;
    if (type == 0) {
        this.install();
    } else {
        if (this.urlTitle.value == "" || this.urlDescription == "") {
            Dialog.error("Please check input data.");
        }
        var link = {
            title: this.urlTitle.value,
            url: this.urlDescription.value
        };
        $icms.addLink(this.dataId.value, link, function(result) {
            console.log("new link is added.");
            thiz.close(result);
        }, function(error) {
            console.log("Create Link fail: ", error.message ? error.message : error);
        });
    }
}

AddResourceDialog.prototype.toggleInputType = function(event) {
    if (event.target.value == 0) {
        Dom.setEnabled(true, this.documentFile);
        Dom.setEnabled(false, this.urlDescription);
        this.urlDescription.value = "";
    } else {
        Dom.setEnabled(false, this.documentFile);
        this.documentFile.value = "";
        Dom.setEnabled(true, this.urlDescription);
    }
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/ContentPageDialog.js";

function ContentPageDialog(options) {
    this.options = options || {};
    ModificationWatchDialog.call(this);
    this.title = this.options.title || "Manage Pages";
    this.bind("p:onDataChanged", this.notifyDataChanged, this.contentPageView.node());
    this.bind("p:PageSelected", this.onPageSelected, this.contentPageView.node());
    var thiz = this;
    this.navigationModule = {
        navigate: function (name, callback) {
            console.log("Navigate called for: " + name);
            var id = parseInt(name, 10);
            console.log("Parsed id: " + id);
            if (isNaN(id) || id <= 0) {
                callback(null);
            } else {
                thiz.contentPageView.displayPageContent({id: id});
                callback(thiz.contentPageView.getNavigationModule());
            }
        },
        close: function() {
        }
    };
}
__extend(ModificationWatchDialog, ContentPageDialog);

ContentPageDialog.prototype.getDialogActions = function() {
    if (this.options.actions) {
        return this.options.actions;
    } else {
        return ModificationWatchDialog.prototype.getDialogActions.call(this);
    }
}
ContentPageDialog.prototype.onPageSelected = function(e) {
    var id = e.id;
    if (!this.isEmbedded()) return
    console.log("Nav to page:  " + id);
    CommonNavigation.onNavigateToChildModule(this.navigationModule, id > 0 ? "" + id : "", this.contentPageView.navigationModule);
}
ContentPageDialog.prototype.onShown = function() {
    this.contentPageView.setIndicator(this);
    //enable search content page
    this.contentPageView.setSearchEnabled(true);
    this.setSnapshotInputValues(this.getCurrentInputValues());
}
ContentPageDialog.prototype.onDetached = function() {
    if (!this.isEmbedded()) return;
    CommonNavigation.onNavigationModuleClosed(this.navigationModule);
}
ContentPageDialog.prototype.getNavigationModule = function() {
    return this.navigationModule;
}

ContentPageDialog.prototype.getCurrentInputValues = function() {
    return this.contentPageView.getCurrentPageIdByOrder();
}

ContentPageDialog.prototype.notifyDataChanged = function() {
    this.emitChangeEvent();
}
ContentPageDialog.prototype.close = function(data) {
    if (this.isEmbedded()) {
        this.revertDataChange();
    } else {
        Dialog.prototype.close.call(this, data);
    }
}
ContentPageDialog.prototype.revertDataChange = function() {
    this.contentPageView.requestPageContentList(this);
    this.clearUnsavedNotify();
}

ContentPageDialog.prototype.save = function(callback) {
    var thiz = this;
    this.contentPageView.updatePageOrder(function () {
        thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
        thiz.clearUnsavedNotify();
        if (callback) callback();
    }, function(e){}, this);
}
ContentPageDialog.prototype.confirmClosing = function (callback) {
    if (!this.modified) {
        callback();
        return;
    }
    Dialog.confirm("Are you sure you want to leave?", "Leaving this page now may cause losing of unsaved data that you have made.", "Leave", callback, "Cancel");
};

ContentPageDialog.prototype.choose = function() {
    var selectedPage = this.contentPageView.getSelectedPage();
    if (selectedPage == null) {
        Dialog.error("No page is selected. Please select ContentPage first.");
        return;
    }
    this.close(selectedPage);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/ContentPageEditDialog.js";

function ContentPageEditDialog() {
    this.grabHeight = true;
    this.dontStretchBody = true;
    ModificationWatchDialog.call(this);

    this.bind("p:onLoaded", function() {
        this.registerUnsavedChanges(true);
    }, this.pageView);
}
__extend(ModificationWatchDialog, ContentPageEditDialog);

ContentPageEditDialog.prototype.getSnapShotValues = function() {
    var snapshotValues = this.pageView.getSnapShotValues();
    return snapshotValues;
}

ContentPageEditDialog.prototype.getChangeEventNames = function () {
    return this.pageView.getChangeEventNames();
}

ContentPageEditDialog.prototype.setup = function(contentPage) {
    this.registerUnsavedChanges(false);

    this.title = contentPage && contentPage.id > 0 ? "Edit Page" : "New Page";
    this.pageView.setup(contentPage, this.isEmbedded() ? AdminConsole.instance : this);
}
ContentPageEditDialog.prototype.confirmClosing = function (callback) {
    if (!this.modified) {
        callback();
        return;
    }
    Dialog.confirm("Are you sure you want to leave?", "Leaving this page now may cause losing of unsaved data that you have made.", "Leave", callback, "Cancel");
};
ContentPageEditDialog.prototype.close = function(data) {
    if (this.isEmbedded()) {
        if (!this.modified) return;
        this.clearUnsavedNotify();
        this.pageView.fireAdminConsoleEvent();
    } else {
        Dialog.prototype.close.call(this, data);
    }
}
ContentPageEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if (!ValidationManager.run(this.pageView.validationRules)) return false;

    var finish = function(data) {

        thiz.clearUnsavedNotify();
        thiz.close(data);

        if (callback) callback(data);
    }
    this.pageView.save(finish);
    return false;
}

ContentPageEditDialog.prototype.getCurrentInputValues = function() {
    return this.pageView.getCurrentInputValues();
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/ContentPagePreview.js";

function ContentPagePreview() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.setupLinkTable();

    this.bind("click", this.handleEditButtonClick, this.editButton);

}
__extend(BaseTemplatedWidget, ContentPagePreview);

ContentPagePreview.prototype.handleEditButtonClick = function () {
    var thiz = this;
    new ContentPageEditDialog().callback(function (result) {
        if (!result) return;
        thiz.create(result);
    }).open(this.contentPage);
};


ContentPagePreview.prototype.onAttached = function () {
    // DO SOMETHING
}
ContentPagePreview.prototype.getSystemToolbar = function () {
    return this.toolbar;
};

ContentPagePreview.prototype.setupLinkTable = function() {
    var thiz = this;
    this.linkTable.column(new DataTable.PlainTextColumn("Title", function (data) {
        return (data.title);
    }).width("10em"));

    this.linkTable.column(new DataTable.LinkColumn("URL",
    function (data, row, col) {
        return (data.url);
    },
    function (data, row, col) {
        return (data.url);
    }, "URL").width("1*"));

    this.linkTable.column(new DataTable.PlainTextColumn("File Size", function (data) {
        return (data.fileSize ? data.fileSize : "-");
    }).width("7em"));
    this.linkTable.column(new DataTable.PlainTextColumn("Last Updated", function (data) {
        return data.lastUpdated ? moment(data.lastUpdated).format("YYYY/MM/DD hh:mm:ss a") : "";
    }).width("10em"));

    this.linkTable.selector(false, false);
    this.linkTable.setDefaultSelectionHandler({
        run: function (link) {
            /*var editLinkDialog = new EditLinkDialog(link, function(link) {
                thiz.addLink(link);
            });
            editLinkDialog.open();*/
        }
    });
}
ContentPagePreview.prototype.processStylesheet = function (content, prefix) {
    var css = ("\n" + content).replace(/([\r\n ]+)([^\{\}\$;]+)\{/g, function (zero, leading, selectors) {
        selectors = selectors.replace(/[ \r\n\t]\,[ \r\n\t]+/g, ",");
        if (!selectors.match(/^[ \t]*body[ \.\[:]/)
                && !selectors.match(/^[ \t]*@media /)
                && !selectors.match(/^[ \t]*#sys-/)) {
            selectors = prefix + " " + selectors.replace(/\,/g, ",\n" + prefix + " ");
        }

        var modified = leading + selectors + "{";

        return modified;
    });

    return css;
};

ContentPagePreview.FIXED_TABLE_WRAPPER_START = "<div class=\"TableWrapper FixedTableWrapper\">";
ContentPagePreview.NORMAL_TABLE_WRAPPER_START = "<div class=\"TableWrapper\">";
ContentPagePreview.TABLE_WRAPPER_END = "</div>";
ContentPagePreview.STYLE_TAG = ".*style=\"[^\"]*width:([^\";]+).*\"";

ContentPagePreview.prototype.processContent = function (content) {
    var newContent = ("" + content).replace(/<table([^/<>]*)/g, function (zero, leading, selectors) {
    var wrapper = ContentPagePreview.FIXED_TABLE_WRAPPER_START;
    var m = leading.match(ContentPagePreview.STYLE_TAG);
        if (m) {
            var width = m[1];
             if (width && width.indexOf("%") == width.length - 1) {
                 var p = parseFloat(width.substring(0, width.length - 1).trim());
                 if (p <= 100) {
                     wrapper = ContentPagePreview.NORMAL_TABLE_WRAPPER_START;
                 }
            }
        }
        return wrapper + zero;
    });
    newContent = newContent.replace(/(<\/(table\|TABLE)>)/g, function (zero, leading, selectors) {
        return leading + ContentPagePreview.TABLE_WRAPPER_END;
    });
    return newContent;
};

ContentPagePreview.prototype.create = function(contentPage) {
    var thiz = this;
    this.contentPage = contentPage;
    this.refresh();
}
ContentPagePreview.prototype.refresh = function() {
    var thiz = this;
    var render = function() {
        if (thiz.contentPage.isLink) {
            Dom.addClass(thiz.linkContentBox, "EditLink");
        } else {
            Dom.removeClass(thiz.linkContentBox, "EditLink");
        }
        thiz.updateContentView();

        if (thiz.contentPage.isLink) {
            thiz.linkTable.setup();
            $icms.getAllContentLinkByContentPageId(thiz.contentPage.id, function(links) {
                thiz.linkTable.setItems(links.result);
            }, function(error) {
                console.log("Error load contentPageLink:", error.message ? error.message : error);
            });
        };
        var ok = (AdminConsole.instance.isLoggedWithRole(Role.NotAnAdmin)
            && thiz.assigned()) ||  AdminConsole.instance.isAdminTypeAtLeast(Role.Webmaster);
        console.log("Can edit ", ok);
        Dom.doOnSelector(thiz.toolbar, "button", function(b){
            Dom.removeClass(b, "Denied");
            if (!ok) Dom.addClass(b, "Denied");
        });
    }
    var loadFull = !this.contentPage.editableEntries || !this.contentPage.editableEntries.result;

    if (!loadFull) {
        render();
        return;
    }
    $icms.getContentPageById(this.contentPage.id, function(data) {
        if (data) {
            thiz.contentPage = data;
            render();
        }
    }, function (error) {});

}
ContentPagePreview.prototype.assigned = function() {
    if (!this.contentPage.editableEntries || !this.contentPage.editableEntries.result) return false;
    var items = this.contentPage.editableEntries.result;
    if (items.length == 0 || !AdminConsole.instance.userSession) return false;
    for (var i = 0; i < items.length; i++) {
        var e = items[i];
        if (e.accountId == AdminConsole.instance.userSession.accountID) return true;
    }
    return false;
}
ContentPagePreview.prototype.into = function(container, data) {
    container.appendChild(this.node());
    if (data) {
        this.create(data);
    }
    return this;
}
ContentPagePreview.prototype.updateContentView = function () {
    var id = "contentPreview" + (new Date().getTime());
    var html = "<style type=\"text/css\">\n" + this.processStylesheet(this.contentPage.contentStylesheet, "#" + id + " ") + "</style>";
    html += "<div id=\"" + id + "\">" + this.processContent(this.contentPage.content) + "</div>";
    this.itemPageContent.innerHTML = html;
    this.title.innerHTML = this.contentPage.name;
    this.lastUpdated.innerHTML = "Last updated " +
    (typeof(this.contentPage.lastUpdated) != "undefined" ?
        moment(this.contentPage.lastUpdated).format(CMSCommon.getMomentFormat("MMM DD YYYY h:mm a")) : "") + " by " + this.contentPage.lastUpdatedByName + ".";
}

ContentPagePreview.prototype.getContentPage = function() {
    return this.contentPage;
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/ContentPagePreviewDialog.js";

function ContentPagePreviewDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    this.title = "Preview";
}
__extend(Dialog, ContentPagePreviewDialog);
ContentPagePreviewDialog.prototype.getDialogActions = function () {
    return [
        Dialog.ACTION_CLOSE
    ]
};
ContentPagePreviewDialog.prototype.setup = function (contentPage) {
    this._contentPage = contentPage;
}
ContentPagePreviewDialog.prototype.onShown = function() {
    this.contentPageView.create(this._contentPage);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/ContentPageView.js";

function ContentPageView() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.selectedPage = null;

    this.bind("click", function() {
        this.editContentPage({});
    }, this.btnAddContentPage);

    this.bind("click", function() {
        var selectedPage = this.getSelectedPage();
        if (selectedPage == null) {
            Dialog.error("No page is selected. Please select ContentPage first.");
            return;
        }
        this.editContentPage(selectedPage);
    }, this.btnEditContentPage);

    this.bind("click", function() {
        var selectedPage = this.getSelectedPage();
        $icms.getContentPageLinkMapById(selectedPage.id, function (data){
            var host = window.location.protocol + "//" + window.location.host;
            thiz.privateLink.value = host + window.location.pathname + "#/res-" + selectedPage.id;
            thiz.publicLink.value = host + (ADMIN_CONTEXT.isUsingCustomDomain ? "" : ("/team/" + ADMIN_CONTEXT.teamAlias)) + "/page/system/res/" + selectedPage.id;
            thiz.publicLinkVisiblity.checked = data.publicLink ?  true : false;

            Dom.toggleClass(thiz.linkListContainer, "TeamResource", data.privateLink ? true : false);
            Dom.toggleClass(thiz.linkListContainer, "PublicPage", data.publicLink ? true : false);

            thiz.pageLinksPopup.show(thiz.pageLinksButton, "left", "bottom", -Dom.getOffsetWidth(thiz.pageLinksButton), Dom.getOffsetHeight(thiz.pageLinksButton) / 2, false);
        }, thiz.getIndicator());
    }, this.pageLinksButton);

    var policies = ["Private", "Public"];
    policies.forEach(function (item) {
        var run = function () {
            var link = thiz[item.toLowerCase() + "Link"].value;
            MainNavigatorSetting.copyClipboard(link);
        }

        thiz.bind("click", function () {
            run();
        }, thiz["copy" + item + "LinkButton"]);

        // thiz.bind("dblclick", function () {
        //     run();
        // }, thiz[item.toLowerCase() + "Link"]);
    });

    this.bind("click", function () {
        this.pageLinksPopup.close();
    }.bind(this), this.pageLinksCloseButton);

    this.bind("click", function () {
        $icms.setTeamResources(thiz.getSelectedPage().id, true, function () {
            thiz.requestPageContentList();
            thiz.selectedPage.teamResource = true;
            Dom.addClass(thiz.linkListContainer, "TeamResource");
        }, function (err) {
            console.log(err);
        },thiz.getIndicator());
    }, this.enableLink);

    this.bind("click", this.registContentPageEvent, this.customPageRepeaterView);

    this.bind("keypress", function (event) {
        if (event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN){
            this.requestPageContentList();
            Dom.cancelEvent(event);
        }
    }.bind(this), this.customPageSearchTerm);

    this.bind("click", function(event) {
        this.requestPageContentList();
        Dom.cancelEvent(event);
    }.bind(this), this.searchButton);

    this.bind("p:onAttached", this.setupReordering, this.customPageRepeaterView.node());

    this.customPageRepeaterView.populator = function (data, binding) {
        Dom.setInnerText(binding.itemTitle, data.name);
        if (data.teamResource) Dom.addClass(binding._node, "TeamResource");
        if (data.draft) Dom.addClass(binding._node, "Draft");
        binding._node._data = data;
    };
    Dom.addClass(this.btnEditContentPage, "Hidden");

    this.bind("change", function(){
        var visible = this.publicLinkVisiblity.checked;
        $icms.setPublicLinkVisiblity(thiz.getSelectedPage().id, visible, function (){
            Dom.toggleClass(thiz.linkListContainer, "PublicPage", visible);
        }, function(err) {
            console.log(err);
        }, thiz.getIndicator());

    }.bind(this),this.publicLinkVisiblity);

    this.navigationModule = {
        navigate: function (name, callback) {
            callback(null);
        },
        close: function () {
            delete thiz.selectedPage;
        }
    };

}
__extend(BaseTemplatedWidget, ContentPageView);

ContentPageView.prototype.onAttached = function() {
    var temp = localStorage.getItem(ContentPageView.STORAGE_KEY_LAST_SEARCH);
    if (temp && temp.length > 0) {
        this.customPageSearchTerm.value = localStorage.getItem(ContentPageView.STORAGE_KEY_LAST_SEARCH);
    }
    this.requestPageContentList();

    localStorage.removeItem(ContentPageView.STORAGE_KEY_LAST_SEARCH);
}
ContentPageView.prototype.onDetached = function() {
    CommonNavigation.onNavigationModuleClosed(this.navigationModule);
}

ContentPageView.prototype.setSearchEnabled = function(enabled) {
    Dom.removeClass(this.customPageListHeader, "Hidden");
    Dom.removeClass(this.searchGroup, "Hidden");
    if (enabled) {
        Dom.addClass(this.customPageListHeader, "Hidden");
    } else {
        Dom.addClass(this.searchGroup, "Hidden");
    }
}
ContentPageView.prototype.setIndicator = function(indicator) {
    this._indicator = indicator;
}
ContentPageView.prototype.requestPageContentList = function(indicator) {
    var thiz = this;
    this.term = thiz.customPageSearchTerm.value.trim();
    $icms.getAllCustomPages(this.term, function(result) {
        thiz.customPageRepeaterView.setItems(result.result);
        if (thiz.selectedPage) {
            thiz.displayPageContent(thiz.selectedPage);
        }
    }, function(error) {
        console.log("Get PageContentList Error:", error.message ? error.message : error);
    }, indicator ? indicator : this.getIndicator());
}
ContentPageView.prototype.getIndicator = function() {
    return this._indicator ? this._indicator : AdminConsole.instance;
}
ContentPageView.prototype.getNavigationModule = function() {
    return this.navigationModule;
}
ContentPageView.prototype.displayPageContent = function (contentPage) {
    if (!contentPage || contentPage.id == 0 || (this.selectedPage && this.selectedPage.id == contentPage.id)) {
        this.invalidateSelectedPage();
        return;
    }
    var thiz = this;

    $icms.getContentPageById(contentPage.id, function(data) {
        if (!data) {
            Dom.removeClass(thiz.displayContent, "PreviewMode");
        } else {
            thiz.contentPagePreview.create(data);
            Dom.addClass(thiz.displayContent, "PreviewMode");
        }
        thiz.selectedPage = data;
        thiz.invalidateSelectedPage();
        Dom.emitEvent("p:PageSelected", thiz.node(), {id: thiz.selectedPage ? thiz.selectedPage.id : 0 });
    }, function (error) {}, thiz.getIndicator());
}
ContentPageView.prototype.invalidateSelectedPage = function() {
    var thiz = this;
    Dom.doOnSelector(thiz.customPageRepeaterView.node(), ".PageItem" , function(d) {
        var page = d._data;
        var selected = thiz.selectedPage && page && page.id == thiz.selectedPage.id;
        if (selected) {
            Dom.addClass(d, "Active");
            Dom.toggleClass(thiz.pageLinksButton, "Hidden", page.draft ? true : false);
        } else {
            Dom.removeClass(d, "Active");
        }
        Dom.removeClass(thiz.btnEditContentPage, "Hidden");
    });
}

ContentPageView.prototype.getCurrentPageIdByOrder = function() {
    var currentOrder = [];
    var pages = Dom.findChildrenWithClass(this.customPageRepeaterView.node(), "PageItem");
    // this.saveSettings(callback);
    for (var i = 0; i < pages.length; i++ ) {
        var data = pages[i]._data;
        currentOrder.push(data.id);
    }
    return currentOrder;
}

ContentPageView.prototype.getSelectedPage = function() {
    return this.contentPagePreview.getContentPage();
}

ContentPageView.prototype.draftContentPage = function(contentPage, draft) {
    var thiz = this;
    $icms.setDraftContentPage(contentPage.id, draft, function(){
        SnackBar.show(draft ? ("Page \"" + contentPage.name + "\" is saved as draft successfully.") : ("Page \"" + contentPage.name + "\" is published successfully."));

        //thiz.selectedPage = contentPage;
        thiz.customPageSearchTerm.value = thiz.term || "";
        thiz.requestPageContentList();
        if (!thiz.term) {
            thiz.fireAdminConsoleEvent();
        }

    }, function(e) {
        console.log((draft ? "Draft" : "Publish") + " ContentPage Error:", e);
    }, this.getIndicator());
}

ContentPageView.STORAGE_KEY_LAST_SEARCH = "last_search_custom_page";
ContentPageView.prototype.editContentPage = function(contentPage, callback) {
    var thiz = this;
    var editDialog = new ContentPageEditDialog().callback(function (result) {
        if (result) {
            if (thiz.term && thiz.term.length > 0) {
                localStorage.setItem(ContentPageView.STORAGE_KEY_LAST_SEARCH, thiz.term);
            } else {
                localStorage.removeItem(ContentPageView.STORAGE_KEY_LAST_SEARCH);
            }
            thiz.selectedPage = result;
            thiz.requestPageContentList();
            Dom.emitEvent("p:PageSelected", thiz.node(), {id: result.id});
        }
        if (callback) callback(result);
    });
    editDialog.open(contentPage);
}

ContentPageView.prototype.updatePageOrder = function(callback) {
        var thiz = this;
        var saveData = [];
        var pages = Dom.findChildrenWithClass(this.customPageRepeaterView.node(), "PageItem");
        // this.saveSettings(callback);
        for (var i = 0; i < pages.length; i++ ) {
            var data = pages[i]._data;
            saveData.push(data);
        }
        $icms.updateContentPageOrder(saveData, function(result) {
            if (result) {
                SnackBar.show("Pages order are updated successfully.");
                // thiz.signalDesignChanged();
                thiz.fireAdminConsoleEvent();
                if (callback) callback();
            }
        }, function(err) {
            console.log("Update Pages order fail");
        }, this.getIndicator());
}

ContentPageView.prototype.fireAdminConsoleEvent = function() {
    var adminConsole = BaseWidget.findUpward(this.node(), AdminConsole);
    if (!adminConsole) return;
    Dom.emitEvent("p:ContentPageChanged", adminConsole.node());
}

ContentPageView.prototype.registContentPageEvent = function(event) {
    var thiz = this;
    var itemContainer = Dom.findUpwardForNodeWithData(event.target, "_data");
    if (!itemContainer || !itemContainer._data) return;
    var data = itemContainer._data;
    if (Dom.hasClass(event.target, "EditButton")) {
        this.editContentPage(data);
    } else if (Dom.hasClass(event.target, "DeleteButton")) {

        Dialog.confirm("Would you like to delete this item?", "",
            "Delete", function() {
                $icms.removeContentPage(data.id, function() {
                    SnackBar.show("Page \"" + data.name + "\" was deleted successfully.");

                    thiz.customPageSearchTerm.value = thiz.term || "";
                    if (!thiz.term) {
                        thiz.fireAdminConsoleEvent();
                    }

                    itemContainer.remove();

                    Dom.removeClass(thiz.displayContent, "PreviewMode");
                    Dom.addClass(thiz.btnEditContentPage, "Hidden");
                    delete thiz.selectedPage;

                }, function(err) {
                    Dialog.error(err.message);
                }, thiz.getIndicator());
            },
            "Cancel", function() {
                console.log("Cancel");
            });
    } else if (Dom.hasClass(event.target, "DraftButton")) {
        this.draftContentPage(data, true);
    } else if (Dom.hasClass(event.target, "PublishButton")) {
        this.draftContentPage(data, false);
    } else {
        thiz.displayPageContent(data);
    }
}

ContentPageView.prototype.setupReordering = function () {
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
        .source(this.customPageRepeaterView.node())
        .anchor(function (node) {
            return Dom.hasClass(node, "DragButton");
        })
        .itemInfo(function (anchor) {
            var item = Dom.findParentWithClass(anchor, "PageItem");
            if (!item) return null;
            return {
                element: item,
                data: item._data
            };
        })
        .destination(this.customPageRepeaterView.node())
        .canDrop(function (data) {
            return true;
        }
        .bind(this))
        .dropAt(dropTargetFinderFunction)
        .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "FileUploadViewDragImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        Dom.emitEvent("p:onDataChanged", this.node());
    }.bind(this);
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/EditContentPageView.js";

function EditContentPageView() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.bind("click", function(e) {
        InfoTip.show(this.helpInfo, "Enable this option, this Content Page is drafting and invisible on the site, only admin can view and edit until this option is disabled.", false, null, "tooltip", "right-inside", -(Dom.getOffsetWidth(this.helpInfo)/2 + 7));
    }, this.helpInfo);
    this.bind("click", function() {
        InfoTip.show(this.helpResourceTip, "This toggle will make pages appear in the Team Resources section of the logged-in site. Use this to allow your team to access this page easily from the logged-in navigation menu.", false, null, "tooltip", "right-inside", -(Dom.getOffsetWidth(this.helpResourceTip)/2 + 7));
    }, this.helpResourceTip);
    this.bind("click", function() {
        if(this.contentPage.id) {
            var addResourceDialog = new AddResourceDialog().callback(function (link) {
                if (link) thiz.loadLinkList(thiz.contentPage.id);
            });
            addResourceDialog.open(this.contentPage.id);
        } else {
            Dialog.confirm("You can only add new link when your content page is saved.\nWould you like to save your content page and continues?", "",
                "Create Content Page", function() {
                    var contentPage = {
                        // id: this.contentPage.id,
                        isLink: this.contentPage.isLink,
                        name: this.itemPageTitle.value,
                        content: this.itemPageContent.getContent(),
                        teamResource: this.teamResource,
                        draft: true
                    }

                    this.saveContentPage(contentPage, function(contentId) {
                        this.contentPage.id = contentId;
                        var addResourceDialog = new AddResourceDialog().callback(function (link) {
                            thiz.loadLinkList(contentId);
                        });
                        addResourceDialog.open(contentId);
                    }, thiz);
                }, "Cancel", function() {
                    // console.log("Cancel job.");
                });
        }
    }, this.addLinkButton);

    this.itemPageTitle.value = "";

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemPageTitle, "Please input 'Page Title'");
        //.required(this.itemPageContent, "Please input 'Page Content'");
}
__extend(BaseTemplatedWidget, EditContentPageView);

EditContentPageView.prototype.refreshAccounts = function(onDone, indicator) {
    var thiz = this;

    if (!CMSAuthUtils.canCreateEditDeleteCustomPage()) {
        thiz.accountChipList._users = [];
        if (onDone) onDone();
        return;
    }

    if (thiz.accountChipList._users && thiz.accountChipList._users.length > 0) {
        if (onDone) onDone();
        return;
    }

    var source = function (term, callback) {
        window.setTimeout(function () {
            var selectedUsers = thiz.accountChipList.getItems();
            var users = !thiz.accountChipList._users ? [] : thiz.accountChipList._users.filter(function (u) {
                if (selectedUsers.indexOf(u) >= 0) return false;
                return !term || (u.firstName && u.firstName.toLowerCase().indexOf(term.toLowerCase().trim()) >= 0)
                    || (u.mi && u.mi.toLowerCase().indexOf(term.toLowerCase().trim()) >= 0)
                    || (u.lastName && u.lastName.toLowerCase().indexOf(term.toLowerCase().trim()) >= 0);
            });
            callback(users);
        }, 100);
    };
    var renderer = function (user) {
        return (user.lastName + ", " || "")  + (user.mi || "")  + " " + (user.firstName || "");
    };

    $icms.getUneditableContentAccounts(function(r) {
        thiz.accountChipList._users = r.result || [];
        thiz.accountChipList.setup(source, renderer);
        if (onDone) onDone();
    }, function(error) {}, indicator ? indicator : AdminConsole.instance);
}

EditContentPageView.prototype.setup = function(contentPage, indicator) {
    this.contentPage = contentPage;
    var thiz = this;
    this.refreshAccounts(function(){

        var loadFull = thiz.contentPage && thiz.contentPage.id > 0 && (!thiz.contentPage.editableEntries
            || !thiz.contentPage.editableEntries.result);
        var load = function(editableEntries) {
            var accounts = [];
            for (var i = 0; i < editableEntries.length; i++) {
                var matched = thiz.accountChipList._users.filter(function(u) {
                    return u.id == editableEntries[i].accountId;
                });
                if (matched) {
                    accounts = accounts.concat(matched);
                }
            }
            thiz.accountChipList.setItems(accounts);
        }

        if (!loadFull) {
            load(thiz.contentPage.editableEntries ? thiz.contentPage.editableEntries.result : []);
            thiz.render();
            return;
        }
        $icms.getContentPageById(thiz.contentPage.id, function(contentPage) {
            load(contentPage.editableEntries.result);
            thiz.contentPage = contentPage;
            thiz.render();
        }, function (error) {
            this.fireLoadedEvent();
        }, indicator ? indicator : AdminConsole.instance);
    }, indicator);
}

EditContentPageView.prototype.render = function() {
    if (!this.contentPage) {
        this.fireLoadedEvent();
        return;
    }
    var thiz = this;
    if (this.contentPage.isLink) {
        Dom.addClass(thiz.linkContentBox, "EditLink");
    } else {
        Dom.removeClass(thiz.linkContentBox, "EditLink");
    }
    if (!CMSAuthUtils.canCreateEditDeleteCustomPage()) {
        Dom.addClass(this.accountBox, "Invalid");
        Dom.addClass(this.draftBox, "Invalid");
        Dom.addClass(this.teamResourceBox, "Invalid");
    }
    if (this.contentPage.id) {
        if (this.contentPage.isLink) {
            this.loadLinkList(this.contentPage.id);
        }

        this.itemPageTitle.value = this.contentPage.name;
        this.teamResource.checked = this.contentPage.teamResource;
        this.draftCheckBox.checked = this.contentPage.draft;
        this.itemPageContent.setContent({
            html: this.contentPage.content || "",
            css: this.contentPage.contentStylesheet || ""
        }, this.fireLoadedEvent.bind(this));
    } else {
        if (this.contentPage.isLink) {
            setTimeout(function() {
                thiz.linkTable.setup();
                thiz.linkTable.setItems([]);
            }, 50);
        }
        this.teamResource.checked = false;
        this.fireLoadedEvent();
    }
    // this.setupLinkTable();
}

EditContentPageView.prototype.fireLoadedEvent = function () {
    if (!this.itemPageContent.initialized) {
        this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, function() {
            Dom.emitEvent("p:onLoaded", this.node());
        }, this.itemPageContent.node());
    } else {
        Dom.emitEvent("p:onLoaded", this.node());
    }
};

EditContentPageView.prototype.getChangeEventNames = function () {
    return [RichTextEditor.TEXT_CHANGE_EVENT_NAME].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES);
}

EditContentPageView.prototype.getCurrentInputValues = function() {
    var current = {
        id: this.contentPage.id,
        isLink: this.contentPage.isLink || false,
        name: this.itemPageTitle.value,
        content: this.itemPageContent.getContent().trim(),
        contentStylesheet: this.itemPageContent.getContentStylesheet(),
        teamResource: this.teamResource.checked,
        draft: this.draftCheckBox.checked,
        editableAccountIds: this.getAccountIds(this.accountChipList.getItems())
    };
    //console.log("Current", current);
    return current;
}
EditContentPageView.prototype.getSnapShotValues = function() {
    var page = this.contentPage;
    if (!page) return {};
    //console.log("Custom page", page);
    var snap =  {
        id: page.id,
        isLink: page.isLink || false,
        name: page.name,
        content: page.content,
        contentStylesheet: page.contentStylesheet,
        teamResource: page.teamResource,
        draft: page.draft,
        editableAccountIds: this.getAccountIds(page.editableEntries && page.editableEntries.result ?
            page.editableEntries.result : [])
    };
    //console.log("Snap", snap);
    return snap;
}
EditContentPageView.prototype.save = function(callback) {
    if (!ValidationManager.run(this.validationRules)) return false;
    var thiz = this;
    var contentPage = this.getCurrentInputValues();
    //Send original value
    contentPage.content = this.itemPageContent.getContent().trim();
    delete contentPage.editableAccountIds;

    $cmsService.getInvalidHtmlTags(contentPage.content, function(tags) {
        if (tags) {
            var warningDialog = new HTMLWarningDialog(tags).callback(function (rs) {
                if (rs) {
                    thiz.saveContentPage(contentPage, callback);
                }
            });
            warningDialog.open();
        } else {
            thiz.saveContentPage(contentPage, callback);
        }
    });
}

EditContentPageView.prototype.setupLinkTable = function() {
    var thiz = this;
    this.linkTable.column(new DataTable.PlainTextColumn("Title", function (data) {
        return (data.title);
    }).width("10em"));
    this.linkTable.column(new DataTable.LinkColumn("URL",
	function (data, row, col) {
        return (data.url);
    },
	function (data, row, col) {
        return (data.url);
    }, "URL").width("15em"));
    this.linkTable.column(new DataTable.PlainTextColumn("File Size", function (data) {
        return (data.fileSize ? data.fileSize + " bytes" : "-");
    }).width("7em"));
    this.linkTable.column(new DataTable.PlainTextColumn("Last Updated", function (data) {
        return data.lastUpdated ? moment(data.lastUpdated).format("YYYY/MM/DD hh:mm:ss a") : "";
    }).width("10em"));

    var actions = [ {
            id: "edit", type: "pencil", title: "Edit Link",
            isApplicable: function(item) {
                return true;
            },
            handler: function (item) {
                var editLinkDialog = new EditLinkDialog().callback(function(result) {
                    if (result) thiz.loadLinkList(thiz.contentPage.id);
                });
                editLinkDialog.open(item);
            }
        },{
            id: "delete", type: "delete", title: "Delete Link",
            isApplicable: function(item) {
                return true;
            },
            handler: function (item) {
                Dialog.confirm("Are you sure you want to delete this link?", null, "Delete", function () {
                    thiz.deleteLink(item);
                }, "Cancel", function () {
                    // console.log("Cancel delete link.");
                });
            }
        }];
    this.linkTable.column(new DataTable.ActionColumn(actions).width("7em"));

    this.linkTable.selector(true, false);
    this.linkTable.setDefaultSelectionHandler({
        run: function (link) {
            // console.log("do nothing");
        }
    });
}

EditContentPageView.prototype.loadLinkList = function(contentPageId) {
    var thiz = this;
    $icms.getAllContentLinkByContentPageId(contentPageId, function(links) {
        thiz.linkTable.setup();
        thiz.linkTable.setItems(links.result);
    }, function(err) {
        console.log("Error load contentPageLink:", err);
    });
}

EditContentPageView.prototype.deleteLink = function(link) {
    var thiz = this;
    if (link && link.id) {
        $icms.removeLink(link.id, function(result) {
            if (result) {
                thiz.loadLinkList(link.contentPageId);
                Dialog.alert("The selected patient has been deleted.");
            }
        }, function(err) {
            console.log("Error delete link address:", err);
        });
    }
}

EditContentPageView.prototype.saveContentPage = function(contentPage, callback) {
    var thiz = this;
    if (contentPage.id) {
        $icms.editContentPage(contentPage, function(result) {
            thiz.updateEditableAccounts(contentPage.id, thiz.accountChipList.getItems(), function() {
                if (callback) callback(contentPage);
                thiz.fireAdminConsoleEvent();
            });
        }, function(err) {
            Dialog.error("Edit ContentPage Error:", err.message);
            if (callback) callback(false);
        });
    } else {
        $icms.createContentPage(contentPage, function(result) {
            contentPage.id = result;
            thiz.updateEditableAccounts(contentPage.id, thiz.accountChipList.getItems(), function() {
                if (callback) callback(contentPage);
                thiz.fireAdminConsoleEvent();
            });
        }, function(err) {
            Dialog.error("Edit ContentPage Error:", err.message);
            if (callback) callback(false);
        });
    }
}
EditContentPageView.prototype.updateEditableAccounts = function(contentPageId, accounts, callback) {
    if (!contentPageId || !CMSAuthUtils.canCreateEditDeleteCustomPage()) {
        if (callback) callback();
        return;
    }

    var ids = this.getAccountIds(accounts);
    $icms.updateEditableAccountsForContentPage(contentPageId, ids, function(result) {
        if (callback) callback();
    }, function(e){}, AdminConsole.instance);
}

EditContentPageView.prototype.getAccountIds = function(accounts) {
    var ids = [];
    if (!accounts) return ids;
    for (var i = 0; i < accounts.length; i++) {
        ids.push(accounts[i].accountId || accounts[i].id);
    }
    return ids;
}

EditContentPageView.prototype.fireAdminConsoleEvent = function() {
    var fireEvent = Dom.getAttributeAsBoolean(this.node(), "fire-content-changed-event", true);
    if (!fireEvent) return;

    var adminConsole = Dom.findChild(document.body, {
        eval: function(node) {
            return node.__widget && node.__widget instanceof AdminConsole;
        }
    });
    if (!adminConsole && AdminConsole && AdminConsole.instance) {
        adminConsole = AdminConsole.instance;
    }
    if (!adminConsole)  {
        return;
    }
    Dom.emitEvent("p:ContentPageChanged", adminConsole);
}

EditContentPageView.prototype.disabledDraftBox = function() {
    Dom.addClass(this.draftBox, "Disabled")
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/content-page/EditLinkDialog.js";

function EditLinkDialog() {
	Dialog.call(this);
    this.title = "Edit link";
}
__extend(Dialog, EditLinkDialog);

EditLinkDialog.prototype.setup = function(link) {
    console.log("setup link", link);
    this.link = link;
    if (link) {
        this.itemTitle.value = link.title ? link.title : "";
        this.itemUrl.value = link.url ? link.url : "";
        if (link.fileSize) {
            Dom.setEnabled(false, this.itemUrl);
            this.itemFileSize.textContent = link.fileSize + " bytes";
            Dom.show(this.resourceArea);
        } else {
            Dom.setEnabled(true, this.itemUrl);
            Dom.hide(this.resourceArea);
        }
    }
}

EditLinkDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            isApplicable: function () {
                return true;
            },
            run: function () { return true; }
        },
        {
            type: "accept", title: "Save",
            isApplicable: function () {
                return true;
            },
            run: function() {
                var link = {
                    id: this.link.id,
                    contentPageId: this.link.contentPageId,
                    title: this.itemTitle.value,
                    url: this.itemUrl.value
                };
                this.saveLink(link, function(result) {
                    thiz.close(result);
                });
                return false;
            }
        }
    ]
}

EditLinkDialog.prototype.saveLink = function(link, callback) {
    if (!link.contentPageId || !link.title || !link.url) {
        Dialog.error("Please input page title and page content.");
        return false;
    }
    $icms.updateLink(link.contentPageId, link, function(result) {
        if (callback) callback(result);
    }, function() {
        console.log("Save Link Error:", err);
        if (callback) callback(false);
    });
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/news/NewsAdminPane.js";

function NewsAdminPane() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.bind("click", function () {
        new NewsDetailDialog().callback(function (changed) {
            if (changed) {
                thiz.reload();
            }
         }).open();
    }, this.createNewsButton);
    Dom.toggleClass(this.node(), "HasManageAllNewsPermission", PermissionUtils.hasAllPermissions(PERMISSION_KEY.OrgTool_News_ManageAll));
    this.bind("e:TabChange", function () {
        var activeTab = this.mainTab.getActiveTabPane();
        var id = activeTab.getAttribute("tab-id");
        var view = ("current" == id) ? this.currentNewsListView : this.archivedNewsListView;

        CommonNavigation.onNavigateToChildModule(this.navigationModule, id, view.navigationModule);
    }, this.mainTab.node());

    this.navigationModule = {
        navigate: function (name, callback) {
            console.log("Navigate called for: " + name);
            if (name == "current") {
                thiz.mainTab.setActiveTabPane(thiz.currentNewsListView.node().parentNode);
                callback(thiz.currentNewsListView.navigationModule);
            } else if (name == "archived") {
                console.log("Setting active tab pane to archived", thiz.archivedTab);
                thiz.mainTab.setActiveTabPane(thiz.archivedNewsListView.node().parentNode);
                callback(thiz.archivedNewsListView.navigationModule);
            } else {
                var id = parseInt(name, 10);
                if (isNaN(id)) {
                    callback(null);
                } else {
                    $newsService.getNewsItemById(id, function (data) {
                        thiz.openNewsReadingView(data);
                        callback(thiz.newsReadingView.navigationModule);
                    });
                }
            }
        },
        close: function() {}
    };
}

__extend(BaseTemplatedWidget, NewsAdminPane);

NewsAdminPane.prototype.openNewsReadingView = function (newsItem) {
    if (this.newsReadingView) this.closeNewsReadingView();
    var thiz = this;

    this.newsReadingView = new NewsReadingView().into(this.node());
    this.newsReadingView.onCloseCallback = function (changed) {
        thiz.closeNewsReadingView();
        if (changed) {
            thiz.reload("all");
        }
    };

    this.newsReadingView.setNewsItem(newsItem);
};
NewsAdminPane.prototype.onAttached = function (newsItem) {
    CommonNavigation.onNavigateToChildModule(this.navigationModule, "current", this.currentNewsListView.navigationModule, "auto");
};

NewsAdminPane.prototype.reload = function(all) {
    var activeTab = this.mainTab.getActiveTabPane();
    if (!activeTab) return;
    var id = activeTab.getAttribute("tab-id");
    if (this.currentNewsListView && (all || "current" == id)) this.currentNewsListView.performSearch();
    if (this.archivedNewsListView && (all || "archived" == id)) this.archivedNewsListView.performSearch();
}
NewsAdminPane.prototype.closeNewsReadingView = function () {
    if (this.newsReadingView) {
        var parentNode = this.newsReadingView.node().parentNode;
        if (parentNode) parentNode.removeChild(this.newsReadingView.node());

        CommonNavigation.onNavigationModuleClosed(this.newsReadingView.navigationModule);
        this.newsReadingView = null;
    }
};

NewsAdminPane.prototype.getNavigationModule = function () {
    return this.navigationModule;
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/news/NewsDetailDialog.js";

function NewsDetailDialog() {
    Dialog.call(this);

    this.dataUUID = Util.newUUID();
    this.photoFileUploadView.dataUUID = this.voiceFileUploadView.dataUUID = this.dataUUID;
    this.photoFileUploadView.dataType = this.voiceFileUploadView.dataType = "news";

    this.contentEditor.setContent("");
    this.emailingOptions = null;
    var thiz = this;
    this.validationRules = new RuleSet()
                    .live(true)
                    .required(this.titleInput, "Please enter the news title")
                    .required(this.startDateInput, "Please specify the date when this news get listed.")
                    //.required(this.expirationDateInput, "Please specify the date when this news get expired.")
                    //.dateAfter(this.expirationDateInput ? this.expirationDateInput : this.startDateInput.get, this.startDateInput, "Expiration date must be after start date.")
                    .custom(new GenericRule(this.expirationDateInput, function(context) {
                        if (!this.getValue()) return true;
                        return this.getValue() && thiz.startDateInput.getDate() && this.getValue().getTime() > thiz.startDateInput.getDate().getTime() ? true : false;
                    },"Expiration date must be after start date."))
                    .required(this.contentEditor, "Please enter the news item content.");

    this.startDateInput.getFormat = function() {
        return CMSCommon.getMomentFormat("MMM DD YYYY h:mm a");
    }
    this.expirationDateInput.getFormat = function() {
        return CMSCommon.getMomentFormat("MMM DD YYYY h:mm a");
    }
}

__extend(Dialog, NewsDetailDialog);

NewsDetailDialog.prototype.setup = function (newsItem) {
    this.newsItem = newsItem;

    this.title = newsItem ? "Edit News" : "Create News";

    if (this.newsItem) {
        this.titleInput.value = newsItem.title;
        this.startDateInput.setDate(newsItem.startDate);
        this.expirationDateInput.setDate(newsItem.expirationDate);

        this.showHomepageCheckbox.checked = newsItem.showOnHomepage;

        if (newsItem.photoList) this.photoFileUploadView.setCommaSeparatedStoragePaths(newsItem.photoList);
        if (newsItem.audioList) this.voiceFileUploadView.setCommaSeparatedStoragePaths(newsItem.audioList);

        this.contentEditor.setContent(newsItem.content);
    }
};

NewsDetailDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: this.newsItem ? "Save" : "Create",
            run: function () { this.save(); return false; }
        }
    ]
};

NewsDetailDialog.prototype.initializeWithNewsItem = function (newsItem) {
    this.photoFileUploadView.dataUUID = this.voiceFileUploadView.dataUUID = news.dataUUID;
};
NewsDetailDialog.prototype.save = function () {
    var newsItem = {};

    if (!ValidationManager.run(this.validationRules)) return;

    newsItem.title = this.titleInput.value.trim();
    newsItem.content = this.contentEditor.getContent();
    newsItem.startDate = this.startDateInput.getDate();
    newsItem.expirationDate = this.expirationDateInput.getDate();
    newsItem.showOnHomepage = this.showHomepageCheckbox.checked;
    newsItem.photoList = this.photoFileUploadView.getCommaSeparatedStoragePaths();
    newsItem.audioList = this.voiceFileUploadView.getCommaSeparatedStoragePaths();
    var thiz = this;
    $cmsService.getInvalidHtmlTags(newsItem.content, function(tags) {
        if (tags) {
            var warningDialog = new HTMLWarningDialog(tags).callback(function (rs) {
                if (rs) {
                    thiz.saveItem(newsItem);
                }
            });
            warningDialog.open();
        } else {
            thiz.saveItem(newsItem);
        }
    }, this);
};

NewsDetailDialog.prototype.saveItem = function (newsItem) {
    var thiz = this;
    if (this.newsItem) {
        newsItem.id = this.newsItem.id;
        $newsService.updateNewsItem(newsItem, this.emailingOptions, function () {
            thiz.close("updated");
        }, this);
    } else {
        $newsService.createNewsItem(newsItem, this.emailingOptions, function () {
            thiz.close("created");
        }, this);
    }
}

NewsDetailDialog.prototype.onShown = function () {
    if (!PermissionUtils.hasAllPermissions(PERMISSION_KEY.AMA_AccountMember_EmailSMSPush)) return;
    Dom.empty(this.dialogFooterStartPane);
    var id = Util.newUUID();
    this.dialogFooterMiddlePane.appendChild(Dom.newDOMElement({
        _name: "hbox",
        _id: "emailingOptionRow",
        "class": "NewsDetailEmailingOptionRow",
        _children: [{
            _name: "hbox",
            _children: [
                {_name: "input", type: "checkbox", id: id, _id: "emailNewsCheckbox"},
                {_name: "label", "for": id, _text: "Send News Emails", _id: "emailNewsLabel"}
            ]
        }, {
            _name: "hbox",
            "class": "SelectionDetails",
            _children: [
                {_name: "span", _text: "", _id: "emailNewsSelectionLabel"},
                {_name: "a", _text: "Change...", _id: "emailNewsChangeLink", href: "#"}
            ]
        }]
    }, document, this));

    Dom.registerEvent(this.emailNewsCheckbox, "click", function () {
        if (this.emailNewsCheckbox.checked) {
            this.editEmailingOptions();
        } else {
            this.emailingOptions = null;
            this.invalidateEmailingDisplay();
        }
    }.bind(this));

    Dom.registerEvent(this.emailNewsChangeLink, "click", function (e) {
        Dom.cancelEvent(e);
        this.editEmailingOptions();
    }.bind(this));

    this.invalidateEmailingDisplay();
};
NewsDetailDialog.prototype.invalidateEmailingDisplay = function () {
    Dom.toggleClass(this.emailingOptionRow, "EmailingEnabled", this.emailingOptions ? true : false);

    if (!this.emailingOptions) return;
    var details = null;
    if (this.emailingOptions.mode == "AllActiveAccounts") {
        details = "All active accounts";
    } else {
        var items = [];
        var name = null;

        name = this._generateTargetDetails(FormatUtil.term("Member Groups"), this.emailingOptions.rosters);
        if (name) items.push(name);
        name = this._generateTargetDetails("Billing Groups", this.emailingOptions.billings);
        if (name) items.push(name);
        name = this._generateTargetDetails("SubBilling Groups", this.emailingOptions.subBillings);
        if (name) items.push(name);
        name = this._generateTargetDetails("Locations", this.emailingOptions.locations);
        if (name) items.push(name);

        details = items.join(", ");
    }

    Dom.setInnerText(this.emailNewsSelectionLabel, "To: " + details + ".");
};
NewsDetailDialog.prototype._generateTargetDetails = function (name, selection) {
    if (!selection || selection.length <= 0) return null;
    if (selection.length == 1 && selection[0] == "*") return "All " + name;
    return selection.length + " " + name;
};
NewsDetailDialog.prototype.editEmailingOptions = function () {
    new NewsEmailSelectionDialog().callback(function (options) {
        if (options) this.emailingOptions = options;
        this.invalidateEmailingDisplay();
        if (!this.emailingOptions) this.emailNewsCheckbox.checked = false;

    }.bind(this)).open(this.emailingOptions || {mode: "All"});
}

function NewsDetailDialog_start(options, callback) {
    $newsService.getNewsItemById(options.data.newsId, function (newsItem) {
        new NewsDetailDialog().callback(callback).open(newsItem);
    });
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/news/NewsEmailSelectionDialog.js";

function NewsEmailSelectionDialog() {
    Dialog.call(this);
    this.title = this.getDialogTitle();
}

__extend(Dialog, NewsEmailSelectionDialog);


NewsEmailSelectionDialog.prototype.checkIfEmptyGroups = function () {
    var recipients = this.propertiesWidget.getValue();
    if (recipients.mode === "OnlyToTheseGroups" &&
        ['billings', 'locations', 'orders', 'rosters', 'subBillings'].every(key => recipients[key].length === 0)) {
        return true;
    }

    return false;
}

NewsEmailSelectionDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                this.cancel();
                return true;
            }
        },
        {
            type: "accept", title: "Save",
            id: "newsEmailSelectionDialogSaveButton",
            name: "newsEmailSelectionDialogSaveButton",
            anonid: "newsEmailSelectionDialogSaveButton",
            isDisabled: function () {
                return this.checkIfEmptyGroups();
            },
            run: function () {
                this.save();
                return false;
            }
        }
    ]
}

NewsEmailSelectionDialog.prototype.asyncSetup = function (recipients, callback) {
    $cmsService.getRecipientsSetting(function (schemas) {
        schemas.forEach(function (schema) {
            if (schema.type == "Enum") {
                schema.allIndicationValue = "*";
            }
        });

        this.schemas = schemas;
        this.loadSettings(recipients);
        this.updateHintVisibility();
        this.updateSaveButtonState(false);
        callback();
    }.bind(this));
}

NewsEmailSelectionDialog.prototype.onValueChanged = function () {
    this.updateHintVisibility();
    this.updateSaveButtonState(false);
}

NewsEmailSelectionDialog.prototype.save = function () {
    var recipients = this.propertiesWidget.getValue();
    if (this.checkIfEmptyGroups()) {
        return;
    }
    delete recipients.orders;
    this.close(recipients);
}

NewsEmailSelectionDialog.prototype.cancel = function () {
    this.updateSaveButtonState(true);
}

NewsEmailSelectionDialog.prototype.getDialogTitle = function () {
    return "Select Emails";
}

NewsEmailSelectionDialog.prototype.updateHintVisibility = function () {
    var recipients = this.propertiesWidget.getValue();
    var hintBox = this.dialogFooter.querySelector(".HintBox");
    if (!hintBox) return;

    var shouldShow = recipients.mode === "OnlyToTheseGroups";
    hintBox.style.display = shouldShow ? "block" : "none";
}

NewsEmailSelectionDialog.prototype.updateSaveButtonState = function (isCancelAction) {
    var thiz = this;
    var saveButtons = this.dialogFooter.querySelectorAll("button[mode=accept]");
    if (!saveButtons) return;
    saveButtons.forEach(function (button) {
        if (isCancelAction) {
            button.disabled = false;
        } else {
            button.disabled = thiz.checkIfEmptyGroups();
        }
    });
}


NewsEmailSelectionDialog.prototype.loadSettings = function (recipients) {
    this.propertiesWidget = new PropertiesWidget();
    this.propertiesWidget.setSchemas(this.schemas);
    Dom.empty(this.container);
    this.propertiesWidget.into(this.container);
    if (recipients) this.propertiesWidget.setValue(recipients);
    this.propertiesWidget.onValueChanged = this.onValueChanged.bind(this);
}


if (window) window.__currentScriptPath = "/cms/admin/widgets/news/NewsEmailingOptionDialog.js";

function NewsEmailingOptionDialog() {
    Dialog.call(this);
    this.title = "Email News";
    
    this.rosterGroupSelectBox.getData = function () {
        
    }
}

__extend(Dialog, NewsEmailingOptionDialog);

NewsEmailingOptionDialog.prototype.setupAsync = function (option, callback) {
    
};

NewsEmailingOptionDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Select",
            run: function () { this.save(); return false; }
        }
    ];
};

NewsEmailingOptionDialog.prototype.save = function () {
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/news/NewsListView.js";

function NewsListView(node) {
    BaseTemplatedWidget.call(this);

    this.isArchived = node.getAttribute("archived") == "true";

    this.bind("click", this.performSearch, this.searchButton);
    this.bind("keypress", function (event) {
        if (event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN) this.performSearch();
    }, this.keywordsInput);

    this.listView.populator = function (data, binding, node) {
        var hasPhotoList = data.photoList && data.photoList.length > 0;
        Dom.toggleClass(binding._node, "WithPhotos", hasPhotoList ? true : false);
        if (data.photoList) {
            var url = data.photoList.split(",")[0];
            var thumbUrl = url.replace(/(\.[a-z]+)$/, "-thumb$1");
            binding.primaryPhoto.setUrl(thumbUrl, url);
        }
        var hasAudioList = data.audioList && data.audioList.length > 0;
        Dom.toggleClass(binding._node, "WithVoice", hasAudioList ? true : false);
        Dom.toggleClass(binding._node, "WithAuthor", data.author ? true : false);

        Dom.setInnerText(binding.author, data.author ? (data.author.firstName + " " + data.author.lastName) : "");

        Dom.setInnerText(binding.date, typeof(data.startDate) != "undefined" ?
            FormatUtil.formatDate(data.startDate, "datetime_standard", "local") : "");
        Dom.setInnerText(binding.title, data.title);
        Dom.setInnerText(binding.content, data.briefText);
    };

    this.listView.setSource(this.createSource(""));

    this.bind("click", function (event) {
        var newsAdminPane = this.findUpward(NewsAdminPane);
        if (!newsAdminPane) return;

        var title = Dom.findParentWithClass(event.target, "AnonId_title");
        if (!title) return;
        var newsItem = Dom.findUpwardForData(title, "_data");
        if (!newsItem) return;

        newsAdminPane.openNewsReadingView(newsItem);
        CommonNavigation.onNavigateToChildModule(this.navigationModule, "" + newsItem.id, newsAdminPane.newsReadingView.navigationModule);
    }, this.listView.node());


    var thiz = this;

    this.editActionMenu.register({
        title: "Edit News",
        icon: "pencil",
        run: function () { thiz.editFirstSelectedItem() },
        applicable: function () { return thiz.listView.getSelectedItems().length == 1;}
    });

    this.editActionMenu.register({
        title: this.isArchived ? "Unarchive" : "Archive",
        icon: this.isArchived ? "package-up" : "package-down",
        run: function () { thiz.toggleArchivingForSelectedItems() },
        applicable: function () { return thiz.listView.getSelectedItems().length > 0;},
        group: "Archiving"
    });
    this.editActionMenu.register({
        title: "Delete",
        icon: "delete",
        run: function () {
            Dialog.confirm("Delete selected items?", "Selected items will be deleted without recovery. Are you sure you want to delete this?", "Delete",
                function () {
                    var ids = thiz.listView.getSelectedItems().map(Util.idMapFunction);
                    $newsService.deleteNewsItems(ids, function () {
                        thiz.listView.reload();
                    });
                },
                "Cancel"
            );
        },
        applicable: function () { return thiz.listView.getSelectedItems().length > 0;},
        group: "Archiving"
    });

    this.bind("p:SelectionChanged", function () {
        this.editActionMenu.invalidate();
    }, this.listView);

    this.navigationModule = {
        navigate: function (name, callback) {
            var id = parseInt(name, 10);
            if (isNaN(id)) {
                callback(null);
            } else {
                $newsService.getNewsItemById(id, function (data) {
                    var newsAdminPane = thiz.findUpward(NewsAdminPane);
                    newsAdminPane.openNewsReadingView(data);
                    callback(newsAdminPane.newsReadingView.navigationModule);
                });
            }
        },
        close: function () {

        }
    }
}

__extend(BaseTemplatedWidget, NewsListView);

NewsListView.prototype.editFirstSelectedItem = function () {
    var thiz = this;
    new NewsDetailDialog().callback(function (changed) { if (changed) thiz.listView.reload(); }).open(this.listView.getSelectedItems()[0]);
};
NewsListView.prototype.toggleArchivingForSelectedItems = function () {
    var thiz = this;
    Dialog.confirm(
        this.isArchived ? "Unarchive selected items?" : "Archive selected items?",
        this.isArchived ? "Unarchiving items make them accessible from the public website." : "Archiving items make them no longer accessible from the public website.",
        this.isArchived ? "Unarchive" : "Archive",
        function () {
            var ids = thiz.listView.getSelectedItems().map(Util.idMapFunction);
            if (thiz.isArchived) {
                $newsService.unarchiveNewsItems(ids, function () {
                    thiz.findUpward(NewsAdminPane).reload("all");
                });
            } else {
                $newsService.archiveNewsItems(ids, function () {
                    thiz.findUpward(NewsAdminPane).reload("all");
                });
            }
        },
        "Cancel"
    );
};
NewsListView.prototype.createSource = function (keywords) {
    var thiz = this;
    return {
        keywords: keywords,
        loadPage: function (start, count, handler, failed) {
            $newsService.getNewsItems(ADMIN_CONTEXT.teamId, this.keywords, start, count, thiz.isArchived, Order.desc("startDate"), function (list) {
                console.log(list.result);
                handler(list.result, list.count);
            });
        }
    };
};
NewsListView.prototype.performSearch = function () {
    this.listView.setSource(this.createSource(this.keywordsInput.value.trim()));
};

NewsListView.prototype.onAttached = function () {
};


if (window) window.__currentScriptPath = "/cms/admin/widgets/news/NewsReadingView.js";

function NewsReadingView() {
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.modified = false;

    this.bind("click", function () {
        thiz.back();
    }, this.backButton);
    this.bind("click", function () {
        new NewsDetailDialog().callback(function (changed) {
            if (changed) {
                thiz.modified = true;
                thiz.reload();
            }
         }).open(this.newsItem);
    }, this.editButton);

    this.bind("click", function () {
        thiz.toggleArchivingForNewsItem();
    }, this.archiveButton);

    this.bind("click", function () {
        thiz.toggleArchivingForNewsItem();
    }, this.unarchiveButton);

    this.bind("click", function () {
        Dialog.confirm("Delete news item?", "This news item will be deleted without recovery. Are you sure you want to delete this?", "Delete",
            function () {
                var ids = [];
                ids.push(thiz.newsItem.id);
                $newsService.deleteNewsItems(ids, function () {
                    thiz.back("deleted");
                });
            },
            "Cancel"
        );
    }, this.deleteButton);

    this.navigationModule = {
        navigate: function (name, callback) {
            callback(null);
        },
        close: function () {
            thiz.back();
        }
    };
}

__extend(BaseTemplatedWidget, NewsReadingView);

NewsReadingView.prototype.onAttached = function () {
};
NewsReadingView.prototype.reload = function() {
    var thiz = this;
    $newsService.getNewsItemById(thiz.newsItem.id, function (data) {
        thiz.setNewsItem(data);

    });
}
NewsReadingView.prototype.toggleArchivingForNewsItem = function () {
    var thiz = this;
    Dialog.confirm(
        this.newsItem.archived ? "Unarchive news item?" : "Archive news item?",
        this.newsItem.archived ? "Unarchiving news item make it accessible from the public website." : "Archiving news item make it no longer accessible from the public website.",
        this.newsItem.archived ? "Unarchive" : "Archive",
        function () {
            var ids = [];
            ids.push(thiz.newsItem.id);

            if (thiz.newsItem.archived) {
                $newsService.unarchiveNewsItems(ids, function () {
                    thiz.modified = true;
                    thiz.reload();
                });
            } else {
                $newsService.archiveNewsItems(ids, function () {
                    thiz.modified = true;
                    thiz.reload();
                });
            }
        },
        "Cancel"
    );
};
NewsReadingView.prototype.back = function(changed) {
    var modified = changed || this.modified;
    if (this.onCloseCallback) this.onCloseCallback(modified);
}
NewsReadingView.prototype.setNewsItem = function (newsItem) {
    Dom.setInnerText(this.title, newsItem.title);
    Dom.setInnerText(this.dateLabel, typeof(newsItem.startDate) != "undefined" ?
        FormatUtil.formatDate(newsItem.startDate, "datetime_standard", "local") : "");

    var hasPhotoList = newsItem.photoList && newsItem.photoList.length > 0;
    Dom.toggleClass(this.node(), "WithPhotos", hasPhotoList ? true : false);

    var urls = [];
    if (newsItem.photoList) {
        urls = newsItem.photoList.split(",");
        var url = urls.shift();
        this.primaryPhoto.src = url;
    }

    this.contentPane.innerHTML = newsItem.content;
    if (urls.length > 0) {
        this.mediaCollectionView.setUrls(urls);
    }
    Dom.toggleClass(this.node(), "WithExtraPhotos", urls.length > 0);

    var withAuthor = newsItem.author && newsItem.author.id > 0;
    Dom.toggleClass(this.node(), "WithAuthor", withAuthor);

    if (withAuthor) {
        this.authorImageView.setUrl("/rest/accounts/avatar/cdn/" + ADMIN_CONTEXT.teamAlias + "/" + newsItem.author.id + "?w=150&t=" + (new Date().getTime()));
        Dom.setInnerText(this.authorLabel, newsItem.author.firstName + " " + newsItem.author.lastName);
    }
    var hasAudioList = newsItem.audioList && newsItem.audioList.length > 0;
    Dom.toggleClass(this.node(), "WithAudios", hasAudioList ? true : false);
    if (hasAudioList) {
        this.audioPlayer.setAttribute("src", newsItem.audioList);
    }
    Dom.toggleClass(this.node(), "Archived", newsItem.archived);
    Dom.toggleClass(this.node(), "Expired", newsItem.expirationDate < new Date());
    this.newsItem = newsItem;
    BaseWidget.signalOnSizeChangedRecursively(this.node());
};


if (window) window.__currentScriptPath = "/cms/admin/scripts/MenuByRoleProvider.js";

function MenuByRoleProvider(minimumRole, feature) {
    this.role = minimumRole;
    this.feature = feature;
}

function Role() {
}
Role.NotAnAdmin = "NotAnAdmin";
Role.EmailOnly = "EmailOnly";
Role.WebOnly = "WebOnly";
Role.EmailPrint = "EmailPrint";
Role.Webmaster = "Webmaster";
Role.SuperUser = "SuperUser";

MenuByRoleProvider.prototype.getMenus = function (callback) {
    var r = AdminConsole.instance.isAdminTypeAtLeast(this.role);
    if (!r) {
        console.log("Access denied " + this.feature.id);
        callback(undefined);
        return;
    }
    callback(this.feature);
}

MenuByRoleProvider.prototype.getRoleValue = function(role) {
    return AdminType[role].code;
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/MenuByEvalProvider.js";

function MenuByEvalProvider(eval, feature) {
    this.eval = eval;
    this.feature = feature;
}
MenuByEvalProvider.prototype.getMenus = function (callback) {
    var thiz = this;
    var result = function(ok) {
        callback(ok ? thiz.feature : undefined);
    }
    this.eval(result);
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/YMCAMenuProvider.js";

function YMCAMenuProvider() {
    
}

YMCAMenuProvider.prototype.YMCA_ADMIN_PERMISSIONS = [
    PERMISSION_KEY.YMCAAdmin_Home_View, PERMISSION_KEY.YMCAAdmin_TeamProfile_ViewUpdate, PERMISSION_KEY.YMCAAdmin_Coach_ManageAll,
    PERMISSION_KEY.YMCAAdmin_MeetSanction_ViewRequestEditDeleteExport, PERMISSION_KEY.YMCAAdmin_Invoice_View
];
YMCAMenuProvider.prototype.YMCA_TEAMS_ADMIN_PERMISSIONS = [
    PERMISSION_KEY.YMCATeamsAdmin_Dashboard_View, PERMISSION_KEY.YMCATeamsAdmin_Coach_ViewAll, PERMISSION_KEY.YMCATeamsAdmin_TeamReg_ViewAll, 
    PERMISSION_KEY.YMCATeamsAdmin_MeetSanction_ViewAll, PERMISSION_KEY.YMCATeamsAdmin_Invoice_ViewAll, 
    PERMISSION_KEY.YMCATeamsAdmin_Statistic_View, PERMISSION_KEY.YMCATeamsAdmin_FeeSetup_Update, PERMISSION_KEY.YMCATeamsAdmin_COA_ManageAll, 
    PERMISSION_KEY.YMCATeamsAdmin_AvailableAccount_ReceiveSystemNotification
];

YMCAMenuProvider.prototype.checkYMCAAccessible = function() {
    if (!AdminConsole.instance.userSession) return false;
    if (!AdminConsole.instance.userSession.ymcaRelated) return false;
    if (!AdminConsole.instance.userSession.ymcacoach && !PermissionUtils.hasAnyPermission(this.YMCA_ADMIN_PERMISSIONS) && !PermissionUtils.hasAnyPermission(this.YMCA_TEAMS_ADMIN_PERMISSIONS)) {
        return false;
    }

    return true;
}

YMCAMenuProvider.prototype.getMenus = function(callback) {
    var accessible = this.checkYMCAAccessible();
    if (!accessible) {
        callback([]);
        return;
    }

    var ADMIN_LEGACY_PARAMS = "use-empty-layout=true&team=" + ADMIN_CONTEXT.teamAlias;
    var URL = "/Ymca.jsp?" + ADMIN_LEGACY_PARAMS;

    var ymcaCoach = AdminConsole.instance.userSession.ymcacoach;
    $teamInfoService.getYMCATeamInfo(function(info){
        var features = [];

        if (info.ymcateam) {
            if (ymcaCoach || PermissionUtils.hasAllPermissions(PERMISSION_KEY.YMCAAdmin_Home_View)) {
                features.push({
                    id: "yusa-home", name: "Home",
                    implementation: {src: URL},
                    enhanceSrc: function (name) {
                        if (name && name.match(/tu_tab=([a-z0-9]+)$/i)) {
                            var tabName = RegExp.$1;
                            return URL + "#/" + tabName;
                        }
                        return URL;
                    }
                });
            }
            if (ymcaCoach || PermissionUtils.hasAllPermissions(PERMISSION_KEY.YMCAAdmin_Coach_ManageAll)) {
                features.push({
                    id: "yusa-coaches", name: "Coaches",
                    implementation: {src: URL + "#/coaches"}
                });
            }
            if (ymcaCoach || PermissionUtils.hasAllPermissions(PERMISSION_KEY.YMCAAdmin_TeamProfile_ViewUpdate)) {
                features.push({
                    id: "yusa-my-team", name: "My Team",
                    implementation: {src: URL + "#/myTeam/" + ADMIN_CONTEXT.teamId}
                });
            }
            if (ymcaCoach || PermissionUtils.hasAllPermissions(PERMISSION_KEY.YMCAAdmin_MeetSanction_ViewRequestEditDeleteExport)) {
                features.push({
                    id: "yusa-meet-sanctions", name: "Meet Sanctions",
                    implementation: {src: URL + "#/meets"}
                });
            }
            if (ymcaCoach || PermissionUtils.hasAllPermissions(PERMISSION_KEY.YMCAAdmin_Invoice_View)) {
                features.push({
                    id: "yusa-invoices", name: "YMCA Invoices",
                    implementation: {src: URL + "#/invoices"}
                });
            }
        } else {
            if (info.regionTeam || info.yusateam) {
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_Dashboard_View)) {
                    features.push({
                        id: "yusa-dashboard", name: "Dashboard",
                        implementation: {src: URL + "#/approvals"}
                    });
                }
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_Coach_ViewAll)) {
                    features.push({
                        id: "yusa-coaches", name: "Coaches",
                        implementation: {src: URL + "#/coaches"}
                    });
                }
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_TeamReg_ViewAll)) {
                    features.push({
                        id: "yusa-teams", name: "Teams",
                        implementation: {src: URL + "#/teams"}
                    });
                }
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_MeetSanction_ViewAll)) {
                    features.push({
                        id: "yusa-meet-sanctions", name: "Meet Sanctions",
                        implementation: {src: URL + "#/meets"}
                    });
                }
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_Invoice_ViewAll)) {
                    features.push({
                        id: "yusa-invoices", name: "Invoices",
                        implementation: {src: URL + "#/invoices"}
                    });
                }
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_Statistic_View)) {
                    features.push({
                        id: "yusa-stats", name: "Statistics",
                        implementation: {src: URL + "#/stats"}
                    });
                }
            }
            if (info.yusateam) {
                if (AdminConsole.instance && AdminConsole.instance.isTUAdmin()) {
                    features.push({
                        id: "yusa-new-account", name: "New Accounts Approval",
                        implementation: {src: URL + "#/newAccountsApproval"},
                        enhanceSrc: function (name) {
                            if (name && name.match(/id=([a-z0-9]+)$/i)) {
                                var id = RegExp.$1;
                                return URL + "&id=" + id + "#/newAccountsApproval/edit/" + id;
                            }
                            return URL + "#/newAccountsApproval";
                        }
                    });
                }
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_FeeSetup_Update)) {
                    features.push({
                        id: "yusa-fee-setup", name: "Fee Setup",
                        implementation: {src: URL + "#/feeSetup"}
                    });
                }
                if (PermissionUtils.hasAnyPermission(PERMISSION_KEY.YMCATeamsAdmin_COA_ManageAll)) {
                    features.push({
                        id: "yusa-coa-setup", name: "COA Setup",
                        implementation: {src: URL + "#/coaSetup"}
                    });
                }
            }
        }
        callback(features);
    }, function (e) {
        callback([]);
    });


}


if (window) window.__currentScriptPath = "/cms/admin/scripts/TeamResourcesProvider.js";

function TeamResourcesProvider() {

}
TeamResourcesProvider.prototype.getMenus = function (callback) {
    $icms.getAllResourcePages(function (data) {
        var results = data.result || [];
        if (!results || results.length == 0) {
            callback([]);
            return;
        }
        var menus = [];
        for (var i =0; i < results.length; i++) {
            var page = results[i];
            menus.push({
                id: "res-" + page.id,
                name: page.name,
                data: page,
                implementation: PermissionUtils.hasAnyPermission(PERMISSION_KEY.OrgResource_CustomPage_CreateEditDelete) ? ContentPageEditDialog : ContentPagePreview,
            });
        }
        callback(menus);
    }, function(error) {
        callback([]);
    });

}


if (window) window.__currentScriptPath = "/cms/admin/scripts/CalendarMenuItemProvider.js";

function CalendarMenuItemProvider() {

}
CalendarMenuItemProvider.prototype.getMenus = function (callback) {
    var menuItems = [];
    var thiz = this;
    CommonNet.get("/rest/calendar/setting", "", function(data){
        if (!data || data.length == 0) {
            callback([]);
            return;
        }
        data.sort(function(a, b) {
            return a.orderNo - b.orderNo;
        });
        for (var index in data) {
            var spec = data[index];
            if (!spec.visibleTab) continue;
            var m = thiz.createMenuItem(spec.id, spec.name);
            if (m) {
                menuItems.push(m);
            }
        }
        console.log("menuItems menuItems: ", menuItems);
        callback(menuItems);
    });
}
CalendarMenuItemProvider.prototype.createMenuItem = function(type, text) {
    var menuItem = undefined;
    if (type == 5) {
        menuItem = {
            id: "calendar-team-events", name: text || (SERVER_FLAVOR == "SO" ? "Team Events" : "Events"),
            implementation: {src: "/CalendarSO.jsp?" + ADMIN_LEGACY_PARAMS + "#/team-events/upcoming"},
            getSubPageUrl: function (name) {
                console.log("getSubPageUrl: ", name);
                if (name.match(/^ev:([0-9]+)$/)) {
                    var eventId = RegExp.$1;
                    return "/EvSignup.jsp?" + ADMIN_LEGACY_PARAMS + "&event_id=" + eventId;
                }
                if (name.match(/^job:([0-9]+)$/)) {
                    var eventId = RegExp.$1;
                    return "/EvJobSignup.jsp?" + ADMIN_LEGACY_PARAMS + "&event_id=" + eventId;
                }
                return null;
            }
        };
    } else if (type == 2) {
        menuItem = {
            id: "calendar-practices", name: text || "Practices",
            featureKey: "practices",
            implementation: {src: "/CalendarSO.jsp?" + ADMIN_LEGACY_PARAMS + "#/practices/list"}
        };
    } else if (type == 3) {
        menuItem = {
            id: "events-calendar", name: text || "General",
            implementation: {src: "/CalendarSO.jsp?" + ADMIN_LEGACY_PARAMS + "#/views/list"}
        };
    }
    return menuItem;
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/TUUpdateNotificationMenuProvider.js";

function TUUpdateNotificationMenuProvider(ref) {
    this.ref = ref;
};
TUUpdateNotificationMenuProvider.prototype.getNotificationInfo = function (callback) {
    var thiz = this;
    $tuUpdateService.getNotificationMap(function (data) {
        var count = 0;
        var extra = {};
        if (!data) {
            callback(thiz.ref, {count: 0});
        } else {
            if (data.alerts) {
                count += data.alerts;
            }
            if (PermissionUtils.hasAllPermissions(PERMISSION_KEY.TUUpdate_TUUpdate_ViewAll) && data.updates) {
                count += data.updates;
            }
            extra.count = count;
            callback(thiz.ref, extra);
        }
    }, function(e) {
        callback(thiz.ref, {count: 0});
    });
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/MemberUnsignedAgreementNotificationMenuProvider.js";

function MemberUnsignedAgreementNotificationMenuProvider(ref) {
    this.ref = ref;
};
MemberUnsignedAgreementNotificationMenuProvider.prototype.getNotificationInfo = function (callback) {
    var thiz = this;
    $waiverService.countRequiredUnsignedAgreements(0, function(res){
        $stripeIntegrationService.countPaymentVerification(function(total){
            if (res || total > 0) {
                callback(thiz.ref, {count: "!"});
            } else {
                callback(thiz.ref, {count: 0});
            }
        });
    }, function (e) {
        callback(thiz.ref, {count: 0});
    });
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/SEPaymentSettingNotificationMenuProvider.js";

function SEPaymentSettingNotificationMenuProvider(ref) {
    this.ref = ref;
};

SEPaymentSettingNotificationMenuProvider.prototype.getNotificationInfo = function (callback) {
    /*var thiz = this;
    $stripeIntegrationService.getTotalNotification(function (total) {
        callback(thiz.ref, {count: total});
    }, function(e) {
        callback(thiz.ref, {count: 0});
    });*/
    callback(this.ref, {count: (PermissionUtils.hasAllPermissions(PERMISSION_KEY.SEPayment_SEPayment_Access) && ADMIN_CONTEXT.isSEPayments && (TEAM_INFO.sepaymentDisplayNotificationJewel || TEAM_INFO.sepaymentNavigateToDisputeTab)) ? "!" : ""});
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/USASOMRMenuProvider.js";

function USASOMRMenuProvider(ref) {
    this.ref = ref;
};
USASOMRMenuProvider.prototype.getNotificationInfo = function (callback) {
    var thiz = this;
    var ok = PermissionUtils.hasAllPermissions(PERMISSION_KEY.USAS_Registration_ManageAll)
                                        && (ADMIN_CONTEXT.isUSASwimming || ADMIN_CONTEXT.isRECSwimming);
    var enabled = ok && ADMIN_CONTEXT.enabledBetaFeatures && ADMIN_CONTEXT.enabledBetaFeatures.indexOf("usas_omr_integration") >= 0;
    if (!enabled) {
        callback(thiz.ref, {count: ""});
    } else {
        $usasOMRService.getOMROnboardingInfo(function(info) {
            callback(thiz.ref, {count: (!info || info.status) == "Done" ? "" : "!"});
        }, function(e) {
            callback(thiz.ref, {count: ""});
        });
    }
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/TeamToolsMenuProvider.js";

function TeamToolsMenuProvider(ref) {
    this.ref = ref;
};
TeamToolsMenuProvider.prototype.getNotificationInfo = function (callback) {
    var thiz = this;
    var ok = ADMIN_CONTEXT.registrationEnabled && PermissionUtils.hasAllPermissions(PERMISSION_KEY.USAS_Registration_ManageAll)
                                        && (ADMIN_CONTEXT.isUSASwimming || ADMIN_CONTEXT.isRECSwimming)
                                        && !TEAM_INFO.isNonTUTeam;
    var enabled = ok && ADMIN_CONTEXT.enabledBetaFeatures && ADMIN_CONTEXT.enabledBetaFeatures.indexOf("usas_omr_integration") >= 0;
    if (!enabled) {
        callback(thiz.ref, {count: ""});
    } else {
        $usasOMRService.getOMROnboardingInfo(function(info) {
            callback(thiz.ref, {count: (!info || info.status == "Done") ? "" : "!"});
        }, function(e) {
            callback(thiz.ref, {count: ""});
        });
    }
}


if (window) window.__currentScriptPath = "/cms/admin/scripts/IconData.js";

var MATERIAL_ICONS = [
{name:"access-point", value:"F002"},
{name:"access-point-network", value:"F003"},
{name:"account", value:"F004"},
{name:"account-alert", value:"F005"},
{name:"account-box", value:"F006"},
{name:"account-box-outline", value:"F007"},
{name:"account-card-details", value:"F5D2"},
{name:"account-check", value:"F008"},
{name:"account-circle", value:"F009"},
{name:"account-convert", value:"F00A"},
{name:"account-edit", value:"F6BB"},
{name:"account-key", value:"F00B"},
{name:"account-location", value:"F00C"},
{name:"account-minus", value:"F00D"},
{name:"account-multiple", value:"F00E"},
{name:"account-multiple-minus", value:"F5D3"},
{name:"account-multiple-outline", value:"F00F"},
{name:"account-multiple-plus", value:"F010"},
{name:"account-multiple-plus-outline", value:"F7FF"},
{name:"account-network", value:"F011"},
{name:"account-off", value:"F012"},
{name:"account-outline", value:"F013"},
{name:"account-plus", value:"F014"},
{name:"account-plus-outline", value:"F800"},
{name:"account-remove", value:"F015"},
{name:"account-search", value:"F016"},
{name:"account-settings", value:"F630"},
{name:"account-settings-variant", value:"F631"},
{name:"account-star", value:"F017"},
{name:"account-switch", value:"F019"},
{name:"adjust", value:"F01A"},
{name:"air-conditioner", value:"F01B"},
{name:"airballoon", value:"F01C"},
{name:"airplane", value:"F01D"},
{name:"airplane-landing", value:"F5D4"},
{name:"airplane-off", value:"F01E"},
{name:"airplane-takeoff", value:"F5D5"},
{name:"airplay", value:"F01F"},
{name:"alarm", value:"F020"},
{name:"alarm-bell", value:"F78D"},
{name:"alarm-check", value:"F021"},
{name:"alarm-light", value:"F78E"},
{name:"alarm-multiple", value:"F022"},
{name:"alarm-off", value:"F023"},
{name:"alarm-plus", value:"F024"},
{name:"alarm-snooze", value:"F68D"},
{name:"album", value:"F025"},
{name:"alert", value:"F026"},
{name:"alert-box", value:"F027"},
{name:"alert-circle", value:"F028"},
{name:"alert-circle-outline", value:"F5D6"},
{name:"alert-decagram", value:"F6BC"},
{name:"alert-octagon", value:"F029"},
{name:"alert-octagram", value:"F766"},
{name:"alert-outline", value:"F02A"},
{name:"all-inclusive", value:"F6BD"},
{name:"allo", value:"F801"},
{name:"alpha", value:"F02B"},
{name:"alphabetical", value:"F02C"},
{name:"altimeter", value:"F5D7"},
{name:"amazon", value:"F02D"},
{name:"amazon-clouddrive", value:"F02E"},
{name:"ambulance", value:"F02F"},
{name:"amplifier", value:"F030"},
{name:"anchor", value:"F031"},
{name:"android", value:"F032"},
{name:"android-debug-bridge", value:"F033"},
{name:"android-head", value:"F78F"},
{name:"android-studio", value:"F034"},
{name:"angular", value:"F6B1"},
{name:"angularjs", value:"F6BE"},
{name:"animation", value:"F5D8"},
{name:"apple", value:"F035"},
{name:"apple-finder", value:"F036"},
{name:"apple-ios", value:"F037"},
{name:"apple-keyboard-caps", value:"F632"},
{name:"apple-keyboard-command", value:"F633"},
{name:"apple-keyboard-control", value:"F634"},
{name:"apple-keyboard-option", value:"F635"},
{name:"apple-keyboard-shift", value:"F636"},
{name:"apple-mobileme", value:"F038"},
{name:"apple-safari", value:"F039"},
{name:"application", value:"F614"},
{name:"approval", value:"F790"},
{name:"apps", value:"F03B"},
{name:"archive", value:"F03C"},
{name:"arrange-bring-forward", value:"F03D"},
{name:"arrange-bring-to-front", value:"F03E"},
{name:"arrange-send-backward", value:"F03F"},
{name:"arrange-send-to-back", value:"F040"},
{name:"arrow-all", value:"F041"},
{name:"arrow-bottom-left", value:"F042"},
{name:"arrow-bottom-right", value:"F043"},
{name:"arrow-collapse", value:"F615"},
{name:"arrow-collapse-all", value:"F044"},
{name:"arrow-collapse-down", value:"F791"},
{name:"arrow-collapse-left", value:"F792"},
{name:"arrow-collapse-right", value:"F793"},
{name:"arrow-collapse-up", value:"F794"},
{name:"arrow-down", value:"F045"},
{name:"arrow-down-bold", value:"F72D"},
{name:"arrow-down-bold-box", value:"F72E"},
{name:"arrow-down-bold-box-outline", value:"F72F"},
{name:"arrow-down-bold-circle", value:"F047"},
{name:"arrow-down-bold-circle-outline", value:"F048"},
{name:"arrow-down-bold-hexagon-outline", value:"F049"},
{name:"arrow-down-box", value:"F6BF"},
{name:"arrow-down-drop-circle", value:"F04A"},
{name:"arrow-down-drop-circle-outline", value:"F04B"},
{name:"arrow-down-thick", value:"F046"},
{name:"arrow-expand", value:"F616"},
{name:"arrow-expand-all", value:"F04C"},
{name:"arrow-expand-down", value:"F795"},
{name:"arrow-expand-left", value:"F796"},
{name:"arrow-expand-right", value:"F797"},
{name:"arrow-expand-up", value:"F798"},
{name:"arrow-left", value:"F04D"},
{name:"arrow-left-bold", value:"F730"},
{name:"arrow-left-bold-box", value:"F731"},
{name:"arrow-left-bold-box-outline", value:"F732"},
{name:"arrow-left-bold-circle", value:"F04F"},
{name:"arrow-left-bold-circle-outline", value:"F050"},
{name:"arrow-left-bold-hexagon-outline", value:"F051"},
{name:"arrow-left-box", value:"F6C0"},
{name:"arrow-left-drop-circle", value:"F052"},
{name:"arrow-left-drop-circle-outline", value:"F053"},
{name:"arrow-left-thick", value:"F04E"},
{name:"arrow-right", value:"F054"},
{name:"arrow-right-bold", value:"F733"},
{name:"arrow-right-bold-box", value:"F734"},
{name:"arrow-right-bold-box-outline", value:"F735"},
{name:"arrow-right-bold-circle", value:"F056"},
{name:"arrow-right-bold-circle-outline", value:"F057"},
{name:"arrow-right-bold-hexagon-outline", value:"F058"},
{name:"arrow-right-box", value:"F6C1"},
{name:"arrow-right-drop-circle", value:"F059"},
{name:"arrow-right-drop-circle-outline", value:"F05A"},
{name:"arrow-right-thick", value:"F055"},
{name:"arrow-top-left", value:"F05B"},
{name:"arrow-top-right", value:"F05C"},
{name:"arrow-up", value:"F05D"},
{name:"arrow-up-bold", value:"F736"},
{name:"arrow-up-bold-box", value:"F737"},
{name:"arrow-up-bold-box-outline", value:"F738"},
{name:"arrow-up-bold-circle", value:"F05F"},
{name:"arrow-up-bold-circle-outline", value:"F060"},
{name:"arrow-up-bold-hexagon-outline", value:"F061"},
{name:"arrow-up-box", value:"F6C2"},
{name:"arrow-up-drop-circle", value:"F062"},
{name:"arrow-up-drop-circle-outline", value:"F063"},
{name:"arrow-up-thick", value:"F05E"},
{name:"artist", value:"F802"},
{name:"assistant", value:"F064"},
{name:"asterisk", value:"F6C3"},
{name:"at", value:"F065"},
{name:"atlassian", value:"F803"},
{name:"atom", value:"F767"},
{name:"attachment", value:"F066"},
{name:"audiobook", value:"F067"},
{name:"auto-fix", value:"F068"},
{name:"auto-upload", value:"F069"},
{name:"autorenew", value:"F06A"},
{name:"av-timer", value:"F06B"},
{name:"azure", value:"F804"},
{name:"baby", value:"F06C"},
{name:"baby-buggy", value:"F68E"},
{name:"backburger", value:"F06D"},
{name:"backspace", value:"F06E"},
{name:"backup-restore", value:"F06F"},
{name:"bandcamp", value:"F674"},
{name:"bank", value:"F070"},
{name:"barcode", value:"F071"},
{name:"barcode-scan", value:"F072"},
{name:"barley", value:"F073"},
{name:"barrel", value:"F074"},
{name:"basecamp", value:"F075"},
{name:"basket", value:"F076"},
{name:"basket-fill", value:"F077"},
{name:"basket-unfill", value:"F078"},
{name:"basketball", value:"F805"},
{name:"battery", value:"F079"},
{name:"battery-10", value:"F07A"},
{name:"battery-20", value:"F07B"},
{name:"battery-30", value:"F07C"},
{name:"battery-40", value:"F07D"},
{name:"battery-50", value:"F07E"},
{name:"battery-60", value:"F07F"},
{name:"battery-70", value:"F080"},
{name:"battery-80", value:"F081"},
{name:"battery-90", value:"F082"},
{name:"battery-alert", value:"F083"},
{name:"battery-charging", value:"F084"},
{name:"battery-charging-100", value:"F085"},
{name:"battery-charging-20", value:"F086"},
{name:"battery-charging-30", value:"F087"},
{name:"battery-charging-40", value:"F088"},
{name:"battery-charging-60", value:"F089"},
{name:"battery-charging-80", value:"F08A"},
{name:"battery-charging-90", value:"F08B"},
{name:"battery-charging-wireless", value:"F806"},
{name:"battery-charging-wireless-10", value:"F807"},
{name:"battery-charging-wireless-20", value:"F808"},
{name:"battery-charging-wireless-30", value:"F809"},
{name:"battery-charging-wireless-40", value:"F80A"},
{name:"battery-charging-wireless-50", value:"F80B"},
{name:"battery-charging-wireless-60", value:"F80C"},
{name:"battery-charging-wireless-70", value:"F80D"},
{name:"battery-charging-wireless-80", value:"F80E"},
{name:"battery-charging-wireless-90", value:"F80F"},
{name:"battery-charging-wireless-alert", value:"F810"},
{name:"battery-charging-wireless-outline", value:"F811"},
{name:"battery-minus", value:"F08C"},
{name:"battery-negative", value:"F08D"},
{name:"battery-outline", value:"F08E"},
{name:"battery-plus", value:"F08F"},
{name:"battery-positive", value:"F090"},
{name:"battery-unknown", value:"F091"},
{name:"beach", value:"F092"},
{name:"beaker", value:"F68F"},
{name:"beats", value:"F097"},
{name:"beer", value:"F098"},
{name:"behance", value:"F099"},
{name:"bell", value:"F09A"},
{name:"bell-off", value:"F09B"},
{name:"bell-outline", value:"F09C"},
{name:"bell-plus", value:"F09D"},
{name:"bell-ring", value:"F09E"},
{name:"bell-ring-outline", value:"F09F"},
{name:"bell-sleep", value:"F0A0"},
{name:"beta", value:"F0A1"},
{name:"bible", value:"F0A2"},
{name:"bike", value:"F0A3"},
{name:"bing", value:"F0A4"},
{name:"binoculars", value:"F0A5"},
{name:"bio", value:"F0A6"},
{name:"biohazard", value:"F0A7"},
{name:"bitbucket", value:"F0A8"},
{name:"bitcoin", value:"F812"},
{name:"black-mesa", value:"F0A9"},
{name:"blackberry", value:"F0AA"},
{name:"blender", value:"F0AB"},
{name:"blinds", value:"F0AC"},
{name:"block-helper", value:"F0AD"},
{name:"blogger", value:"F0AE"},
{name:"bluetooth", value:"F0AF"},
{name:"bluetooth-audio", value:"F0B0"},
{name:"bluetooth-connect", value:"F0B1"},
{name:"bluetooth-off", value:"F0B2"},
{name:"bluetooth-settings", value:"F0B3"},
{name:"bluetooth-transfer", value:"F0B4"},
{name:"blur", value:"F0B5"},
{name:"blur-linear", value:"F0B6"},
{name:"blur-off", value:"F0B7"},
{name:"blur-radial", value:"F0B8"},
{name:"bomb", value:"F690"},
{name:"bomb-off", value:"F6C4"},
{name:"bone", value:"F0B9"},
{name:"book", value:"F0BA"},
{name:"book-minus", value:"F5D9"},
{name:"book-multiple", value:"F0BB"},
{name:"book-multiple-variant", value:"F0BC"},
{name:"book-open", value:"F0BD"},
{name:"book-open-page-variant", value:"F5DA"},
{name:"book-open-variant", value:"F0BE"},
{name:"book-plus", value:"F5DB"},
{name:"book-secure", value:"F799"},
{name:"book-unsecure", value:"F79A"},
{name:"book-variant", value:"F0BF"},
{name:"bookmark", value:"F0C0"},
{name:"bookmark-check", value:"F0C1"},
{name:"bookmark-music", value:"F0C2"},
{name:"bookmark-outline", value:"F0C3"},
{name:"bookmark-plus", value:"F0C5"},
{name:"bookmark-plus-outline", value:"F0C4"},
{name:"bookmark-remove", value:"F0C6"},
{name:"boombox", value:"F5DC"},
{name:"bootstrap", value:"F6C5"},
{name:"border-all", value:"F0C7"},
{name:"border-bottom", value:"F0C8"},
{name:"border-color", value:"F0C9"},
{name:"border-horizontal", value:"F0CA"},
{name:"border-inside", value:"F0CB"},
{name:"border-left", value:"F0CC"},
{name:"border-none", value:"F0CD"},
{name:"border-outside", value:"F0CE"},
{name:"border-right", value:"F0CF"},
{name:"border-style", value:"F0D0"},
{name:"border-top", value:"F0D1"},
{name:"border-vertical", value:"F0D2"},
{name:"bow-tie", value:"F677"},
{name:"bowl", value:"F617"},
{name:"bowling", value:"F0D3"},
{name:"box", value:"F0D4"},
{name:"box-cutter", value:"F0D5"},
{name:"box-shadow", value:"F637"},
{name:"bridge", value:"F618"},
{name:"briefcase", value:"F0D6"},
{name:"briefcase-check", value:"F0D7"},
{name:"briefcase-download", value:"F0D8"},
{name:"briefcase-outline", value:"F813"},
{name:"briefcase-upload", value:"F0D9"},
{name:"brightness-1", value:"F0DA"},
{name:"brightness-2", value:"F0DB"},
{name:"brightness-3", value:"F0DC"},
{name:"brightness-4", value:"F0DD"},
{name:"brightness-5", value:"F0DE"},
{name:"brightness-6", value:"F0DF"},
{name:"brightness-7", value:"F0E0"},
{name:"brightness-auto", value:"F0E1"},
{name:"broom", value:"F0E2"},
{name:"brush", value:"F0E3"},
{name:"buffer", value:"F619"},
{name:"bug", value:"F0E4"},
{name:"bulletin-board", value:"F0E5"},
{name:"bullhorn", value:"F0E6"},
{name:"bullseye", value:"F5DD"},
{name:"bus", value:"F0E7"},
{name:"bus-articulated-end", value:"F79B"},
{name:"bus-articulated-front", value:"F79C"},
{name:"bus-double-decker", value:"F79D"},
{name:"bus-school", value:"F79E"},
{name:"bus-side", value:"F79F"},
{name:"cached", value:"F0E8"},
{name:"cake", value:"F0E9"},
{name:"cake-layered", value:"F0EA"},
{name:"cake-variant", value:"F0EB"},
{name:"calculator", value:"F0EC"},
{name:"calendar", value:"F0ED"},
{name:"calendar-blank", value:"F0EE"},
{name:"calendar-check", value:"F0EF"},
{name:"calendar-clock", value:"F0F0"},
{name:"calendar-multiple", value:"F0F1"},
{name:"calendar-multiple-check", value:"F0F2"},
{name:"calendar-plus", value:"F0F3"},
{name:"calendar-question", value:"F691"},
{name:"calendar-range", value:"F678"},
{name:"calendar-remove", value:"F0F4"},
{name:"calendar-text", value:"F0F5"},
{name:"calendar-today", value:"F0F6"},
{name:"call-made", value:"F0F7"},
{name:"call-merge", value:"F0F8"},
{name:"call-missed", value:"F0F9"},
{name:"call-received", value:"F0FA"},
{name:"call-split", value:"F0FB"},
{name:"camcorder", value:"F0FC"},
{name:"camcorder-box", value:"F0FD"},
{name:"camcorder-box-off", value:"F0FE"},
{name:"camcorder-off", value:"F0FF"},
{name:"camera", value:"F100"},
{name:"camera-burst", value:"F692"},
{name:"camera-enhance", value:"F101"},
{name:"camera-front", value:"F102"},
{name:"camera-front-variant", value:"F103"},
{name:"camera-gopro", value:"F7A0"},
{name:"camera-iris", value:"F104"},
{name:"camera-metering-center", value:"F7A1"},
{name:"camera-metering-matrix", value:"F7A2"},
{name:"camera-metering-partial", value:"F7A3"},
{name:"camera-metering-spot", value:"F7A4"},
{name:"camera-off", value:"F5DF"},
{name:"camera-party-mode", value:"F105"},
{name:"camera-rear", value:"F106"},
{name:"camera-rear-variant", value:"F107"},
{name:"camera-switch", value:"F108"},
{name:"camera-timer", value:"F109"},
{name:"cancel", value:"F739"},
{name:"candle", value:"F5E2"},
{name:"candycane", value:"F10A"},
{name:"cannabis", value:"F7A5"},
{name:"car", value:"F10B"},
{name:"car-battery", value:"F10C"},
{name:"car-connected", value:"F10D"},
{name:"car-convertible", value:"F7A6"},
{name:"car-estate", value:"F7A7"},
{name:"car-hatchback", value:"F7A8"},
{name:"car-pickup", value:"F7A9"},
{name:"car-side", value:"F7AA"},
{name:"car-sports", value:"F7AB"},
{name:"car-wash", value:"F10E"},
{name:"caravan", value:"F7AC"},
{name:"cards", value:"F638"},
{name:"cards-outline", value:"F639"},
{name:"cards-playing-outline", value:"F63A"},
{name:"cards-variant", value:"F6C6"},
{name:"carrot", value:"F10F"},
{name:"cart", value:"F110"},
{name:"cart-off", value:"F66B"},
{name:"cart-outline", value:"F111"},
{name:"cart-plus", value:"F112"},
{name:"case-sensitive-alt", value:"F113"},
{name:"cash", value:"F114"},
{name:"cash-100", value:"F115"},
{name:"cash-multiple", value:"F116"},
{name:"cash-usd", value:"F117"},
{name:"cast", value:"F118"},
{name:"cast-connected", value:"F119"},
{name:"cast-off", value:"F789"},
{name:"castle", value:"F11A"},
{name:"cat", value:"F11B"},
{name:"cctv", value:"F7AD"},
{name:"ceiling-light", value:"F768"},
{name:"cellphone", value:"F11C"},
{name:"cellphone-android", value:"F11D"},
{name:"cellphone-basic", value:"F11E"},
{name:"cellphone-dock", value:"F11F"},
{name:"cellphone-iphone", value:"F120"},
{name:"cellphone-link", value:"F121"},
{name:"cellphone-link-off", value:"F122"},
{name:"cellphone-settings", value:"F123"},
{name:"cellphone-wireless", value:"F814"},
{name:"certificate", value:"F124"},
{name:"chair-school", value:"F125"},
{name:"chart-arc", value:"F126"},
{name:"chart-areaspline", value:"F127"},
{name:"chart-bar", value:"F128"},
{name:"chart-bar-stacked", value:"F769"},
{name:"chart-bubble", value:"F5E3"},
{name:"chart-donut", value:"F7AE"},
{name:"chart-donut-variant", value:"F7AF"},
{name:"chart-gantt", value:"F66C"},
{name:"chart-histogram", value:"F129"},
{name:"chart-line", value:"F12A"},
{name:"chart-line-stacked", value:"F76A"},
{name:"chart-line-variant", value:"F7B0"},
{name:"chart-pie", value:"F12B"},
{name:"chart-scatterplot-hexbin", value:"F66D"},
{name:"chart-timeline", value:"F66E"},
{name:"check", value:"F12C"},
{name:"check-all", value:"F12D"},
{name:"check-circle", value:"F5E0"},
{name:"check-circle-outline", value:"F5E1"},
{name:"checkbox-blank", value:"F12E"},
{name:"checkbox-blank-circle", value:"F12F"},
{name:"checkbox-blank-circle-outline", value:"F130"},
{name:"checkbox-blank-outline", value:"F131"},
{name:"checkbox-marked", value:"F132"},
{name:"checkbox-marked-circle", value:"F133"},
{name:"checkbox-marked-circle-outline", value:"F134"},
{name:"checkbox-marked-outline", value:"F135"},
{name:"checkbox-multiple-blank", value:"F136"},
{name:"checkbox-multiple-blank-circle", value:"F63B"},
{name:"checkbox-multiple-blank-circle-outline", value:"F63C"},
{name:"checkbox-multiple-blank-outline", value:"F137"},
{name:"checkbox-multiple-marked", value:"F138"},
{name:"checkbox-multiple-marked-circle", value:"F63D"},
{name:"checkbox-multiple-marked-circle-outline", value:"F63E"},
{name:"checkbox-multiple-marked-outline", value:"F139"},
{name:"checkerboard", value:"F13A"},
{name:"chemical-weapon", value:"F13B"},
{name:"chevron-double-down", value:"F13C"},
{name:"chevron-double-left", value:"F13D"},
{name:"chevron-double-right", value:"F13E"},
{name:"chevron-double-up", value:"F13F"},
{name:"chevron-down", value:"F140"},
{name:"chevron-left", value:"F141"},
{name:"chevron-right", value:"F142"},
{name:"chevron-up", value:"F143"},
{name:"chili-hot", value:"F7B1"},
{name:"chili-medium", value:"F7B2"},
{name:"chili-mild", value:"F7B3"},
{name:"chip", value:"F61A"},
{name:"church", value:"F144"},
{name:"circle", value:"F764"},
{name:"circle-outline", value:"F765"},
{name:"cisco-webex", value:"F145"},
{name:"city", value:"F146"},
{name:"clipboard", value:"F147"},
{name:"clipboard-account", value:"F148"},
{name:"clipboard-alert", value:"F149"},
{name:"clipboard-arrow-down", value:"F14A"},
{name:"clipboard-arrow-left", value:"F14B"},
{name:"clipboard-check", value:"F14C"},
{name:"clipboard-flow", value:"F6C7"},
{name:"clipboard-outline", value:"F14D"},
{name:"clipboard-plus", value:"F750"},
{name:"clipboard-text", value:"F14E"},
{name:"clippy", value:"F14F"},
{name:"clock", value:"F150"},
{name:"clock-alert", value:"F5CE"},
{name:"clock-end", value:"F151"},
{name:"clock-fast", value:"F152"},
{name:"clock-in", value:"F153"},
{name:"clock-out", value:"F154"},
{name:"clock-start", value:"F155"},
{name:"close", value:"F156"},
{name:"close-box", value:"F157"},
{name:"close-box-outline", value:"F158"},
{name:"close-circle", value:"F159"},
{name:"close-circle-outline", value:"F15A"},
{name:"close-network", value:"F15B"},
{name:"close-octagon", value:"F15C"},
{name:"close-octagon-outline", value:"F15D"},
{name:"close-outline", value:"F6C8"},
{name:"closed-caption", value:"F15E"},
{name:"cloud", value:"F15F"},
{name:"cloud-braces", value:"F7B4"},
{name:"cloud-check", value:"F160"},
{name:"cloud-circle", value:"F161"},
{name:"cloud-download", value:"F162"},
{name:"cloud-off-outline", value:"F164"},
{name:"cloud-outline", value:"F163"},
{name:"cloud-print", value:"F165"},
{name:"cloud-print-outline", value:"F166"},
{name:"cloud-sync", value:"F63F"},
{name:"cloud-tags", value:"F7B5"},
{name:"cloud-upload", value:"F167"},
{name:"clover", value:"F815"},
{name:"code-array", value:"F168"},
{name:"code-braces", value:"F169"},
{name:"code-brackets", value:"F16A"},
{name:"code-equal", value:"F16B"},
{name:"code-greater-than", value:"F16C"},
{name:"code-greater-than-or-equal", value:"F16D"},
{name:"code-less-than", value:"F16E"},
{name:"code-less-than-or-equal", value:"F16F"},
{name:"code-not-equal", value:"F170"},
{name:"code-not-equal-variant", value:"F171"},
{name:"code-parentheses", value:"F172"},
{name:"code-string", value:"F173"},
{name:"code-tags", value:"F174"},
{name:"code-tags-check", value:"F693"},
{name:"codepen", value:"F175"},
{name:"coffee", value:"F176"},
{name:"coffee-outline", value:"F6C9"},
{name:"coffee-to-go", value:"F177"},
{name:"coin", value:"F178"},
{name:"coins", value:"F694"},
{name:"collage", value:"F640"},
{name:"color-helper", value:"F179"},
{name:"comment", value:"F17A"},
{name:"comment-account", value:"F17B"},
{name:"comment-account-outline", value:"F17C"},
{name:"comment-alert", value:"F17D"},
{name:"comment-alert-outline", value:"F17E"},
{name:"comment-check", value:"F17F"},
{name:"comment-check-outline", value:"F180"},
{name:"comment-multiple-outline", value:"F181"},
{name:"comment-outline", value:"F182"},
{name:"comment-plus-outline", value:"F183"},
{name:"comment-processing", value:"F184"},
{name:"comment-processing-outline", value:"F185"},
{name:"comment-question", value:"F816"},
{name:"comment-question-outline", value:"F186"},
{name:"comment-remove", value:"F5DE"},
{name:"comment-remove-outline", value:"F187"},
{name:"comment-text", value:"F188"},
{name:"comment-text-outline", value:"F189"},
{name:"compare", value:"F18A"},
{name:"compass", value:"F18B"},
{name:"compass-outline", value:"F18C"},
{name:"console", value:"F18D"},
{name:"console-line", value:"F7B6"},
{name:"contact-mail", value:"F18E"},
{name:"contacts", value:"F6CA"},
{name:"content-copy", value:"F18F"},
{name:"content-cut", value:"F190"},
{name:"content-duplicate", value:"F191"},
{name:"content-paste", value:"F192"},
{name:"content-save", value:"F193"},
{name:"content-save-all", value:"F194"},
{name:"content-save-outline", value:"F817"},
{name:"content-save-settings", value:"F61B"},
{name:"contrast", value:"F195"},
{name:"contrast-box", value:"F196"},
{name:"contrast-circle", value:"F197"},
{name:"cookie", value:"F198"},
{name:"copyright", value:"F5E6"},
{name:"corn", value:"F7B7"},
{name:"counter", value:"F199"},
{name:"cow", value:"F19A"},
{name:"creation", value:"F1C9"},
{name:"credit-card", value:"F19B"},
{name:"credit-card-multiple", value:"F19C"},
{name:"credit-card-off", value:"F5E4"},
{name:"credit-card-plus", value:"F675"},
{name:"credit-card-scan", value:"F19D"},
{name:"crop", value:"F19E"},
{name:"crop-free", value:"F19F"},
{name:"crop-landscape", value:"F1A0"},
{name:"crop-portrait", value:"F1A1"},
{name:"crop-rotate", value:"F695"},
{name:"crop-square", value:"F1A2"},
{name:"crosshairs", value:"F1A3"},
{name:"crosshairs-gps", value:"F1A4"},
{name:"crown", value:"F1A5"},
{name:"cube", value:"F1A6"},
{name:"cube-outline", value:"F1A7"},
{name:"cube-send", value:"F1A8"},
{name:"cube-unfolded", value:"F1A9"},
{name:"cup", value:"F1AA"},
{name:"cup-off", value:"F5E5"},
{name:"cup-water", value:"F1AB"},
{name:"currency-btc", value:"F1AC"},
{name:"currency-chf", value:"F7B8"},
{name:"currency-cny", value:"F7B9"},
{name:"currency-eth", value:"F7BA"},
{name:"currency-eur", value:"F1AD"},
{name:"currency-gbp", value:"F1AE"},
{name:"currency-inr", value:"F1AF"},
{name:"currency-jpy", value:"F7BB"},
{name:"currency-krw", value:"F7BC"},
{name:"currency-ngn", value:"F1B0"},
{name:"currency-rub", value:"F1B1"},
{name:"currency-sign", value:"F7BD"},
{name:"currency-try", value:"F1B2"},
{name:"currency-twd", value:"F7BE"},
{name:"currency-usd", value:"F1B3"},
{name:"currency-usd-off", value:"F679"},
{name:"cursor-default", value:"F1B4"},
{name:"cursor-default-outline", value:"F1B5"},
{name:"cursor-move", value:"F1B6"},
{name:"cursor-pointer", value:"F1B7"},
{name:"cursor-text", value:"F5E7"},
{name:"database", value:"F1B8"},
{name:"database-minus", value:"F1B9"},
{name:"database-plus", value:"F1BA"},
{name:"debug-step-into", value:"F1BB"},
{name:"debug-step-out", value:"F1BC"},
{name:"debug-step-over", value:"F1BD"},
{name:"decagram", value:"F76B"},
{name:"decagram-outline", value:"F76C"},
{name:"decimal-decrease", value:"F1BE"},
{name:"decimal-increase", value:"F1BF"},
{name:"delete", value:"F1C0"},
{name:"delete-circle", value:"F682"},
{name:"delete-empty", value:"F6CB"},
{name:"delete-forever", value:"F5E8"},
{name:"delete-restore", value:"F818"},
{name:"delete-sweep", value:"F5E9"},
{name:"delete-variant", value:"F1C1"},
{name:"delta", value:"F1C2"},
{name:"deskphone", value:"F1C3"},
{name:"desktop-classic", value:"F7BF"},
{name:"desktop-mac", value:"F1C4"},
{name:"desktop-tower", value:"F1C5"},
{name:"details", value:"F1C6"},
{name:"developer-board", value:"F696"},
{name:"deviantart", value:"F1C7"},
{name:"dialpad", value:"F61C"},
{name:"diamond", value:"F1C8"},
{name:"dice-1", value:"F1CA"},
{name:"dice-2", value:"F1CB"},
{name:"dice-3", value:"F1CC"},
{name:"dice-4", value:"F1CD"},
{name:"dice-5", value:"F1CE"},
{name:"dice-6", value:"F1CF"},
{name:"dice-d10", value:"F76E"},
{name:"dice-d20", value:"F5EA"},
{name:"dice-d4", value:"F5EB"},
{name:"dice-d6", value:"F5EC"},
{name:"dice-d8", value:"F5ED"},
{name:"dice-multiple", value:"F76D"},
{name:"dictionary", value:"F61D"},
{name:"dip-switch", value:"F7C0"},
{name:"directions", value:"F1D0"},
{name:"directions-fork", value:"F641"},
{name:"discord", value:"F66F"},
{name:"disk", value:"F5EE"},
{name:"disk-alert", value:"F1D1"},
{name:"disqus", value:"F1D2"},
{name:"disqus-outline", value:"F1D3"},
{name:"division", value:"F1D4"},
{name:"division-box", value:"F1D5"},
{name:"dna", value:"F683"},
{name:"dns", value:"F1D6"},
{name:"do-not-disturb", value:"F697"},
{name:"do-not-disturb-off", value:"F698"},
{name:"dolby", value:"F6B2"},
{name:"domain", value:"F1D7"},
{name:"donkey", value:"F7C1"},
{name:"door", value:"F819"},
{name:"door-closed", value:"F81A"},
{name:"door-open", value:"F81B"},
{name:"dots-horizontal", value:"F1D8"},
{name:"dots-horizontal-circle", value:"F7C2"},
{name:"dots-vertical", value:"F1D9"},
{name:"dots-vertical-circle", value:"F7C3"},
{name:"douban", value:"F699"},
{name:"download", value:"F1DA"},
{name:"download-network", value:"F6F3"},
{name:"drag", value:"F1DB"},
{name:"drag-horizontal", value:"F1DC"},
{name:"drag-vertical", value:"F1DD"},
{name:"drawing", value:"F1DE"},
{name:"drawing-box", value:"F1DF"},
{name:"dribbble", value:"F1E0"},
{name:"dribbble-box", value:"F1E1"},
{name:"drone", value:"F1E2"},
{name:"dropbox", value:"F1E3"},
{name:"drupal", value:"F1E4"},
{name:"duck", value:"F1E5"},
{name:"dumbbell", value:"F1E6"},
{name:"ear-hearing", value:"F7C4"},
{name:"earth", value:"F1E7"},
{name:"earth-box", value:"F6CC"},
{name:"earth-box-off", value:"F6CD"},
{name:"earth-off", value:"F1E8"},
{name:"edge", value:"F1E9"},
{name:"eject", value:"F1EA"},
{name:"elephant", value:"F7C5"},
{name:"elevation-decline", value:"F1EB"},
{name:"elevation-rise", value:"F1EC"},
{name:"elevator", value:"F1ED"},
{name:"email", value:"F1EE"},
{name:"email-alert", value:"F6CE"},
{name:"email-open", value:"F1EF"},
{name:"email-open-outline", value:"F5EF"},
{name:"email-outline", value:"F1F0"},
{name:"email-secure", value:"F1F1"},
{name:"email-variant", value:"F5F0"},
{name:"emby", value:"F6B3"},
{name:"emoticon", value:"F1F2"},
{name:"emoticon-cool", value:"F1F3"},
{name:"emoticon-dead", value:"F69A"},
{name:"emoticon-devil", value:"F1F4"},
{name:"emoticon-excited", value:"F69B"},
{name:"emoticon-happy", value:"F1F5"},
{name:"emoticon-neutral", value:"F1F6"},
{name:"emoticon-poop", value:"F1F7"},
{name:"emoticon-sad", value:"F1F8"},
{name:"emoticon-tongue", value:"F1F9"},
{name:"engine", value:"F1FA"},
{name:"engine-outline", value:"F1FB"},
{name:"equal", value:"F1FC"},
{name:"equal-box", value:"F1FD"},
{name:"eraser", value:"F1FE"},
{name:"eraser-variant", value:"F642"},
{name:"escalator", value:"F1FF"},
{name:"ethernet", value:"F200"},
{name:"ethernet-cable", value:"F201"},
{name:"ethernet-cable-off", value:"F202"},
{name:"etsy", value:"F203"},
{name:"ev-station", value:"F5F1"},
{name:"eventbrite", value:"F7C6"},
{name:"evernote", value:"F204"},
{name:"exclamation", value:"F205"},
{name:"exit-to-app", value:"F206"},
{name:"export", value:"F207"},
{name:"eye", value:"F208"},
{name:"eye-off", value:"F209"},
{name:"eye-off-outline", value:"F6D0"},
{name:"eye-outline", value:"F6CF"},
{name:"eyedropper", value:"F20A"},
{name:"eyedropper-variant", value:"F20B"},
{name:"face", value:"F643"},
{name:"face-profile", value:"F644"},
{name:"facebook", value:"F20C"},
{name:"facebook-box", value:"F20D"},
{name:"facebook-messenger", value:"F20E"},
{name:"factory", value:"F20F"},
{name:"fan", value:"F210"},
{name:"fan-off", value:"F81C"},
{name:"fast-forward", value:"F211"},
{name:"fast-forward-outline", value:"F6D1"},
{name:"fax", value:"F212"},
{name:"feather", value:"F6D2"},
{name:"ferry", value:"F213"},
{name:"file", value:"F214"},
{name:"file-account", value:"F73A"},
{name:"file-chart", value:"F215"},
{name:"file-check", value:"F216"},
{name:"file-cloud", value:"F217"},
{name:"file-delimited", value:"F218"},
{name:"file-document", value:"F219"},
{name:"file-document-box", value:"F21A"},
{name:"file-excel", value:"F21B"},
{name:"file-excel-box", value:"F21C"},
{name:"file-export", value:"F21D"},
{name:"file-find", value:"F21E"},
{name:"file-hidden", value:"F613"},
{name:"file-image", value:"F21F"},
{name:"file-import", value:"F220"},
{name:"file-lock", value:"F221"},
{name:"file-multiple", value:"F222"},
{name:"file-music", value:"F223"},
{name:"file-outline", value:"F224"},
{name:"file-pdf", value:"F225"},
{name:"file-pdf-box", value:"F226"},
{name:"file-percent", value:"F81D"},
{name:"file-plus", value:"F751"},
{name:"file-powerpoint", value:"F227"},
{name:"file-powerpoint-box", value:"F228"},
{name:"file-presentation-box", value:"F229"},
{name:"file-restore", value:"F670"},
{name:"file-send", value:"F22A"},
{name:"file-tree", value:"F645"},
{name:"file-video", value:"F22B"},
{name:"file-word", value:"F22C"},
{name:"file-word-box", value:"F22D"},
{name:"file-xml", value:"F22E"},
{name:"film", value:"F22F"},
{name:"filmstrip", value:"F230"},
{name:"filmstrip-off", value:"F231"},
{name:"filter", value:"F232"},
{name:"filter-outline", value:"F233"},
{name:"filter-remove", value:"F234"},
{name:"filter-remove-outline", value:"F235"},
{name:"filter-variant", value:"F236"},
{name:"finance", value:"F81E"},
{name:"find-replace", value:"F6D3"},
{name:"fingerprint", value:"F237"},
{name:"fire", value:"F238"},
{name:"firefox", value:"F239"},
{name:"fish", value:"F23A"},
{name:"flag", value:"F23B"},
{name:"flag-checkered", value:"F23C"},
{name:"flag-outline", value:"F23D"},
{name:"flag-triangle", value:"F23F"},
{name:"flag-variant", value:"F240"},
{name:"flag-variant-outline", value:"F23E"},
{name:"flash", value:"F241"},
{name:"flash-auto", value:"F242"},
{name:"flash-circle", value:"F81F"},
{name:"flash-off", value:"F243"},
{name:"flash-outline", value:"F6D4"},
{name:"flash-red-eye", value:"F67A"},
{name:"flashlight", value:"F244"},
{name:"flashlight-off", value:"F245"},
{name:"flask", value:"F093"},
{name:"flask-empty", value:"F094"},
{name:"flask-empty-outline", value:"F095"},
{name:"flask-outline", value:"F096"},
{name:"flattr", value:"F246"},
{name:"flip-to-back", value:"F247"},
{name:"flip-to-front", value:"F248"},
{name:"floor-plan", value:"F820"},
{name:"floppy", value:"F249"},
{name:"flower", value:"F24A"},
{name:"folder", value:"F24B"},
{name:"folder-account", value:"F24C"},
{name:"folder-download", value:"F24D"},
{name:"folder-google-drive", value:"F24E"},
{name:"folder-image", value:"F24F"},
{name:"folder-lock", value:"F250"},
{name:"folder-lock-open", value:"F251"},
{name:"folder-move", value:"F252"},
{name:"folder-multiple", value:"F253"},
{name:"folder-multiple-image", value:"F254"},
{name:"folder-multiple-outline", value:"F255"},
{name:"folder-open", value:"F76F"},
{name:"folder-outline", value:"F256"},
{name:"folder-plus", value:"F257"},
{name:"folder-remove", value:"F258"},
{name:"folder-star", value:"F69C"},
{name:"folder-upload", value:"F259"},
{name:"font-awesome", value:"F03A"},
{name:"food", value:"F25A"},
{name:"food-apple", value:"F25B"},
{name:"food-croissant", value:"F7C7"},
{name:"food-fork-drink", value:"F5F2"},
{name:"food-off", value:"F5F3"},
{name:"food-variant", value:"F25C"},
{name:"football", value:"F25D"},
{name:"football-australian", value:"F25E"},
{name:"football-helmet", value:"F25F"},
{name:"forklift", value:"F7C8"},
{name:"format-align-bottom", value:"F752"},
{name:"format-align-center", value:"F260"},
{name:"format-align-justify", value:"F261"},
{name:"format-align-left", value:"F262"},
{name:"format-align-middle", value:"F753"},
{name:"format-align-right", value:"F263"},
{name:"format-align-top", value:"F754"},
{name:"format-annotation-plus", value:"F646"},
{name:"format-bold", value:"F264"},
{name:"format-clear", value:"F265"},
{name:"format-color-fill", value:"F266"},
{name:"format-color-text", value:"F69D"},
{name:"format-float-center", value:"F267"},
{name:"format-float-left", value:"F268"},
{name:"format-float-none", value:"F269"},
{name:"format-float-right", value:"F26A"},
{name:"format-font", value:"F6D5"},
{name:"format-header-1", value:"F26B"},
{name:"format-header-2", value:"F26C"},
{name:"format-header-3", value:"F26D"},
{name:"format-header-4", value:"F26E"},
{name:"format-header-5", value:"F26F"},
{name:"format-header-6", value:"F270"},
{name:"format-header-decrease", value:"F271"},
{name:"format-header-equal", value:"F272"},
{name:"format-header-increase", value:"F273"},
{name:"format-header-pound", value:"F274"},
{name:"format-horizontal-align-center", value:"F61E"},
{name:"format-horizontal-align-left", value:"F61F"},
{name:"format-horizontal-align-right", value:"F620"},
{name:"format-indent-decrease", value:"F275"},
{name:"format-indent-increase", value:"F276"},
{name:"format-italic", value:"F277"},
{name:"format-line-spacing", value:"F278"},
{name:"format-line-style", value:"F5C8"},
{name:"format-line-weight", value:"F5C9"},
{name:"format-list-bulleted", value:"F279"},
{name:"format-list-bulleted-type", value:"F27A"},
{name:"format-list-checks", value:"F755"},
{name:"format-list-numbers", value:"F27B"},
{name:"format-page-break", value:"F6D6"},
{name:"format-paint", value:"F27C"},
{name:"format-paragraph", value:"F27D"},
{name:"format-pilcrow", value:"F6D7"},
{name:"format-quote-close", value:"F27E"},
{name:"format-quote-open", value:"F756"},
{name:"format-rotate-90", value:"F6A9"},
{name:"format-section", value:"F69E"},
{name:"format-size", value:"F27F"},
{name:"format-strikethrough", value:"F280"},
{name:"format-strikethrough-variant", value:"F281"},
{name:"format-subscript", value:"F282"},
{name:"format-superscript", value:"F283"},
{name:"format-text", value:"F284"},
{name:"format-textdirection-l-to-r", value:"F285"},
{name:"format-textdirection-r-to-l", value:"F286"},
{name:"format-title", value:"F5F4"},
{name:"format-underline", value:"F287"},
{name:"format-vertical-align-bottom", value:"F621"},
{name:"format-vertical-align-center", value:"F622"},
{name:"format-vertical-align-top", value:"F623"},
{name:"format-wrap-inline", value:"F288"},
{name:"format-wrap-square", value:"F289"},
{name:"format-wrap-tight", value:"F28A"},
{name:"format-wrap-top-bottom", value:"F28B"},
{name:"forum", value:"F28C"},
{name:"forum-outline", value:"F821"},
{name:"forward", value:"F28D"},
{name:"foursquare", value:"F28E"},
{name:"fridge", value:"F28F"},
{name:"fridge-filled", value:"F290"},
{name:"fridge-filled-bottom", value:"F291"},
{name:"fridge-filled-top", value:"F292"},
{name:"fuel", value:"F7C9"},
{name:"fullscreen", value:"F293"},
{name:"fullscreen-exit", value:"F294"},
{name:"function", value:"F295"},
{name:"gamepad", value:"F296"},
{name:"gamepad-variant", value:"F297"},
{name:"garage", value:"F6D8"},
{name:"garage-open", value:"F6D9"},
{name:"gas-cylinder", value:"F647"},
{name:"gas-station", value:"F298"},
{name:"gate", value:"F299"},
{name:"gauge", value:"F29A"},
{name:"gavel", value:"F29B"},
{name:"gender-female", value:"F29C"},
{name:"gender-male", value:"F29D"},
{name:"gender-male-female", value:"F29E"},
{name:"gender-transgender", value:"F29F"},
{name:"gesture", value:"F7CA"},
{name:"gesture-double-tap", value:"F73B"},
{name:"gesture-swipe-down", value:"F73C"},
{name:"gesture-swipe-left", value:"F73D"},
{name:"gesture-swipe-right", value:"F73E"},
{name:"gesture-swipe-up", value:"F73F"},
{name:"gesture-tap", value:"F740"},
{name:"gesture-two-double-tap", value:"F741"},
{name:"gesture-two-tap", value:"F742"},
{name:"ghost", value:"F2A0"},
{name:"gift", value:"F2A1"},
{name:"git", value:"F2A2"},
{name:"github-box", value:"F2A3"},
{name:"github-circle", value:"F2A4"},
{name:"github-face", value:"F6DA"},
{name:"glass-flute", value:"F2A5"},
{name:"glass-mug", value:"F2A6"},
{name:"glass-stange", value:"F2A7"},
{name:"glass-tulip", value:"F2A8"},
{name:"glassdoor", value:"F2A9"},
{name:"glasses", value:"F2AA"},
{name:"gmail", value:"F2AB"},
{name:"gnome", value:"F2AC"},
{name:"golf", value:"F822"},
{name:"gondola", value:"F685"},
{name:"google", value:"F2AD"},
{name:"google-analytics", value:"F7CB"},
{name:"google-assistant", value:"F7CC"},
{name:"google-cardboard", value:"F2AE"},
{name:"google-chrome", value:"F2AF"},
{name:"google-circles", value:"F2B0"},
{name:"google-circles-communities", value:"F2B1"},
{name:"google-circles-extended", value:"F2B2"},
{name:"google-circles-group", value:"F2B3"},
{name:"google-controller", value:"F2B4"},
{name:"google-controller-off", value:"F2B5"},
{name:"google-drive", value:"F2B6"},
{name:"google-earth", value:"F2B7"},
{name:"google-glass", value:"F2B8"},
{name:"google-home", value:"F823"},
{name:"google-keep", value:"F6DB"},
{name:"google-maps", value:"F5F5"},
{name:"google-nearby", value:"F2B9"},
{name:"google-pages", value:"F2BA"},
{name:"google-photos", value:"F6DC"},
{name:"google-physical-web", value:"F2BB"},
{name:"google-play", value:"F2BC"},
{name:"google-plus", value:"F2BD"},
{name:"google-plus-box", value:"F2BE"},
{name:"google-translate", value:"F2BF"},
{name:"google-wallet", value:"F2C0"},
{name:"gradient", value:"F69F"},
{name:"grease-pencil", value:"F648"},
{name:"grid", value:"F2C1"},
{name:"grid-large", value:"F757"},
{name:"grid-off", value:"F2C2"},
{name:"group", value:"F2C3"},
{name:"guitar-acoustic", value:"F770"},
{name:"guitar-electric", value:"F2C4"},
{name:"guitar-pick", value:"F2C5"},
{name:"guitar-pick-outline", value:"F2C6"},
{name:"guy-fawkes-mask", value:"F824"},
{name:"hackernews", value:"F624"},
{name:"hamburger", value:"F684"},
{name:"hand-pointing-right", value:"F2C7"},
{name:"hanger", value:"F2C8"},
{name:"hangouts", value:"F2C9"},
{name:"harddisk", value:"F2CA"},
{name:"headphones", value:"F2CB"},
{name:"headphones-box", value:"F2CC"},
{name:"headphones-off", value:"F7CD"},
{name:"headphones-settings", value:"F2CD"},
{name:"headset", value:"F2CE"},
{name:"headset-dock", value:"F2CF"},
{name:"headset-off", value:"F2D0"},
{name:"heart", value:"F2D1"},
{name:"heart-box", value:"F2D2"},
{name:"heart-box-outline", value:"F2D3"},
{name:"heart-broken", value:"F2D4"},
{name:"heart-half", value:"F6DE"},
{name:"heart-half-full", value:"F6DD"},
{name:"heart-half-outline", value:"F6DF"},
{name:"heart-off", value:"F758"},
{name:"heart-outline", value:"F2D5"},
{name:"heart-pulse", value:"F5F6"},
{name:"help", value:"F2D6"},
{name:"help-box", value:"F78A"},
{name:"help-circle", value:"F2D7"},
{name:"help-circle-outline", value:"F625"},
{name:"help-network", value:"F6F4"},
{name:"hexagon", value:"F2D8"},
{name:"hexagon-multiple", value:"F6E0"},
{name:"hexagon-outline", value:"F2D9"},
{name:"high-definition", value:"F7CE"},
{name:"highway", value:"F5F7"},
{name:"history", value:"F2DA"},
{name:"hololens", value:"F2DB"},
{name:"home", value:"F2DC"},
{name:"home-account", value:"F825"},
{name:"home-assistant", value:"F7CF"},
{name:"home-automation", value:"F7D0"},
{name:"home-circle", value:"F7D1"},
{name:"home-heart", value:"F826"},
{name:"home-map-marker", value:"F5F8"},
{name:"home-modern", value:"F2DD"},
{name:"home-outline", value:"F6A0"},
{name:"home-variant", value:"F2DE"},
{name:"hook", value:"F6E1"},
{name:"hook-off", value:"F6E2"},
{name:"hops", value:"F2DF"},
{name:"hospital", value:"F2E0"},
{name:"hospital-building", value:"F2E1"},
{name:"hospital-marker", value:"F2E2"},
{name:"hot-tub", value:"F827"},
{name:"hotel", value:"F2E3"},
{name:"houzz", value:"F2E4"},
{name:"houzz-box", value:"F2E5"},
{name:"hulu", value:"F828"},
{name:"human", value:"F2E6"},
{name:"human-child", value:"F2E7"},
{name:"human-female", value:"F649"},
{name:"human-greeting", value:"F64A"},
{name:"human-handsdown", value:"F64B"},
{name:"human-handsup", value:"F64C"},
{name:"human-male", value:"F64D"},
{name:"human-male-female", value:"F2E8"},
{name:"human-pregnant", value:"F5CF"},
{name:"humble-bundle", value:"F743"},
{name:"ice-cream", value:"F829"},
{name:"image", value:"F2E9"},
{name:"image-album", value:"F2EA"},
{name:"image-area", value:"F2EB"},
{name:"image-area-close", value:"F2EC"},
{name:"image-broken", value:"F2ED"},
{name:"image-broken-variant", value:"F2EE"},
{name:"image-filter", value:"F2EF"},
{name:"image-filter-black-white", value:"F2F0"},
{name:"image-filter-center-focus", value:"F2F1"},
{name:"image-filter-center-focus-weak", value:"F2F2"},
{name:"image-filter-drama", value:"F2F3"},
{name:"image-filter-frames", value:"F2F4"},
{name:"image-filter-hdr", value:"F2F5"},
{name:"image-filter-none", value:"F2F6"},
{name:"image-filter-tilt-shift", value:"F2F7"},
{name:"image-filter-vintage", value:"F2F8"},
{name:"image-multiple", value:"F2F9"},
{name:"image-off", value:"F82A"},
{name:"import", value:"F2FA"},
{name:"inbox", value:"F686"},
{name:"inbox-arrow-down", value:"F2FB"},
{name:"inbox-arrow-up", value:"F3D1"},
{name:"incognito", value:"F5F9"},
{name:"infinity", value:"F6E3"},
{name:"information", value:"F2FC"},
{name:"information-outline", value:"F2FD"},
{name:"information-variant", value:"F64E"},
{name:"instagram", value:"F2FE"},
{name:"instapaper", value:"F2FF"},
{name:"internet-explorer", value:"F300"},
{name:"invert-colors", value:"F301"},
{name:"itunes", value:"F676"},
{name:"jeepney", value:"F302"},
{name:"jira", value:"F303"},
{name:"jsfiddle", value:"F304"},
{name:"json", value:"F626"},
{name:"karate", value:"F82B"},
{name:"keg", value:"F305"},
{name:"kettle", value:"F5FA"},
{name:"key", value:"F306"},
{name:"key-change", value:"F307"},
{name:"key-minus", value:"F308"},
{name:"key-plus", value:"F309"},
{name:"key-remove", value:"F30A"},
{name:"key-variant", value:"F30B"},
{name:"keyboard", value:"F30C"},
{name:"keyboard-backspace", value:"F30D"},
{name:"keyboard-caps", value:"F30E"},
{name:"keyboard-close", value:"F30F"},
{name:"keyboard-off", value:"F310"},
{name:"keyboard-return", value:"F311"},
{name:"keyboard-tab", value:"F312"},
{name:"keyboard-variant", value:"F313"},
{name:"kickstarter", value:"F744"},
{name:"kodi", value:"F314"},
{name:"label", value:"F315"},
{name:"label-outline", value:"F316"},
{name:"ladybug", value:"F82C"},
{name:"lambda", value:"F627"},
{name:"lamp", value:"F6B4"},
{name:"lan", value:"F317"},
{name:"lan-connect", value:"F318"},
{name:"lan-disconnect", value:"F319"},
{name:"lan-pending", value:"F31A"},
{name:"language-c", value:"F671"},
{name:"language-cpp", value:"F672"},
{name:"language-csharp", value:"F31B"},
{name:"language-css3", value:"F31C"},
{name:"language-go", value:"F7D2"},
{name:"language-html5", value:"F31D"},
{name:"language-javascript", value:"F31E"},
{name:"language-php", value:"F31F"},
{name:"language-python", value:"F320"},
{name:"language-python-text", value:"F321"},
{name:"language-r", value:"F7D3"},
{name:"language-swift", value:"F6E4"},
{name:"language-typescript", value:"F6E5"},
{name:"laptop", value:"F322"},
{name:"laptop-chromebook", value:"F323"},
{name:"laptop-mac", value:"F324"},
{name:"laptop-off", value:"F6E6"},
{name:"laptop-windows", value:"F325"},
{name:"lastfm", value:"F326"},
{name:"lastpass", value:"F446"},
{name:"launch", value:"F327"},
{name:"lava-lamp", value:"F7D4"},
{name:"layers", value:"F328"},
{name:"layers-off", value:"F329"},
{name:"lead-pencil", value:"F64F"},
{name:"leaf", value:"F32A"},
{name:"led-off", value:"F32B"},
{name:"led-on", value:"F32C"},
{name:"led-outline", value:"F32D"},
{name:"led-strip", value:"F7D5"},
{name:"led-variant-off", value:"F32E"},
{name:"led-variant-on", value:"F32F"},
{name:"led-variant-outline", value:"F330"},
{name:"library", value:"F331"},
{name:"library-books", value:"F332"},
{name:"library-music", value:"F333"},
{name:"library-plus", value:"F334"},
{name:"lightbulb", value:"F335"},
{name:"lightbulb-on", value:"F6E7"},
{name:"lightbulb-on-outline", value:"F6E8"},
{name:"lightbulb-outline", value:"F336"},
{name:"link", value:"F337"},
{name:"link-off", value:"F338"},
{name:"link-variant", value:"F339"},
{name:"link-variant-off", value:"F33A"},
{name:"linkedin", value:"F33B"},
{name:"linkedin-box", value:"F33C"},
{name:"linux", value:"F33D"},
{name:"loading", value:"F771"},
{name:"lock", value:"F33E"},
{name:"lock-open", value:"F33F"},
{name:"lock-open-outline", value:"F340"},
{name:"lock-outline", value:"F341"},
{name:"lock-pattern", value:"F6E9"},
{name:"lock-plus", value:"F5FB"},
{name:"lock-reset", value:"F772"},
{name:"locker", value:"F7D6"},
{name:"locker-multiple", value:"F7D7"},
{name:"login", value:"F342"},
{name:"login-variant", value:"F5FC"},
{name:"logout", value:"F343"},
{name:"logout-variant", value:"F5FD"},
{name:"looks", value:"F344"},
{name:"loop", value:"F6EA"},
{name:"loupe", value:"F345"},
{name:"lumx", value:"F346"},
{name:"magnet", value:"F347"},
{name:"magnet-on", value:"F348"},
{name:"magnify", value:"F349"},
{name:"magnify-minus", value:"F34A"},
{name:"magnify-minus-outline", value:"F6EB"},
{name:"magnify-plus", value:"F34B"},
{name:"magnify-plus-outline", value:"F6EC"},
{name:"mail-ru", value:"F34C"},
{name:"mailbox", value:"F6ED"},
{name:"map", value:"F34D"},
{name:"map-marker", value:"F34E"},
{name:"map-marker-circle", value:"F34F"},
{name:"map-marker-minus", value:"F650"},
{name:"map-marker-multiple", value:"F350"},
{name:"map-marker-off", value:"F351"},
{name:"map-marker-outline", value:"F7D8"},
{name:"map-marker-plus", value:"F651"},
{name:"map-marker-radius", value:"F352"},
{name:"margin", value:"F353"},
{name:"markdown", value:"F354"},
{name:"marker", value:"F652"},
{name:"marker-check", value:"F355"},
{name:"martini", value:"F356"},
{name:"material-ui", value:"F357"},
{name:"math-compass", value:"F358"},
{name:"matrix", value:"F628"},
{name:"maxcdn", value:"F359"},
{name:"medical-bag", value:"F6EE"},
{name:"medium", value:"F35A"},
{name:"memory", value:"F35B"},
{name:"menu", value:"F35C"},
{name:"menu-down", value:"F35D"},
{name:"menu-down-outline", value:"F6B5"},
{name:"menu-left", value:"F35E"},
{name:"menu-right", value:"F35F"},
{name:"menu-up", value:"F360"},
{name:"menu-up-outline", value:"F6B6"},
{name:"message", value:"F361"},
{name:"message-alert", value:"F362"},
{name:"message-bulleted", value:"F6A1"},
{name:"message-bulleted-off", value:"F6A2"},
{name:"message-draw", value:"F363"},
{name:"message-image", value:"F364"},
{name:"message-outline", value:"F365"},
{name:"message-plus", value:"F653"},
{name:"message-processing", value:"F366"},
{name:"message-reply", value:"F367"},
{name:"message-reply-text", value:"F368"},
{name:"message-settings", value:"F6EF"},
{name:"message-settings-variant", value:"F6F0"},
{name:"message-text", value:"F369"},
{name:"message-text-outline", value:"F36A"},
{name:"message-video", value:"F36B"},
{name:"meteor", value:"F629"},
{name:"metronome", value:"F7D9"},
{name:"metronome-tick", value:"F7DA"},
{name:"micro-sd", value:"F7DB"},
{name:"microphone", value:"F36C"},
{name:"microphone-off", value:"F36D"},
{name:"microphone-outline", value:"F36E"},
{name:"microphone-settings", value:"F36F"},
{name:"microphone-variant", value:"F370"},
{name:"microphone-variant-off", value:"F371"},
{name:"microscope", value:"F654"},
{name:"microsoft", value:"F372"},
{name:"minecraft", value:"F373"},
{name:"minus", value:"F374"},
{name:"minus-box", value:"F375"},
{name:"minus-box-outline", value:"F6F1"},
{name:"minus-circle", value:"F376"},
{name:"minus-circle-outline", value:"F377"},
{name:"minus-network", value:"F378"},
{name:"mixcloud", value:"F62A"},
{name:"mixer", value:"F7DC"},
{name:"monitor", value:"F379"},
{name:"monitor-multiple", value:"F37A"},
{name:"more", value:"F37B"},
{name:"motorbike", value:"F37C"},
{name:"mouse", value:"F37D"},
{name:"mouse-off", value:"F37E"},
{name:"mouse-variant", value:"F37F"},
{name:"mouse-variant-off", value:"F380"},
{name:"move-resize", value:"F655"},
{name:"move-resize-variant", value:"F656"},
{name:"movie", value:"F381"},
{name:"movie-roll", value:"F7DD"},
{name:"multiplication", value:"F382"},
{name:"multiplication-box", value:"F383"},
{name:"mushroom", value:"F7DE"},
{name:"mushroom-outline", value:"F7DF"},
{name:"music", value:"F759"},
{name:"music-box", value:"F384"},
{name:"music-box-outline", value:"F385"},
{name:"music-circle", value:"F386"},
{name:"music-note", value:"F387"},
{name:"music-note-bluetooth", value:"F5FE"},
{name:"music-note-bluetooth-off", value:"F5FF"},
{name:"music-note-eighth", value:"F388"},
{name:"music-note-half", value:"F389"},
{name:"music-note-off", value:"F38A"},
{name:"music-note-quarter", value:"F38B"},
{name:"music-note-sixteenth", value:"F38C"},
{name:"music-note-whole", value:"F38D"},
{name:"music-off", value:"F75A"},
{name:"nature", value:"F38E"},
{name:"nature-people", value:"F38F"},
{name:"navigation", value:"F390"},
{name:"near-me", value:"F5CD"},
{name:"needle", value:"F391"},
{name:"nest-protect", value:"F392"},
{name:"nest-thermostat", value:"F393"},
{name:"netflix", value:"F745"},
{name:"network", value:"F6F2"},
{name:"new-box", value:"F394"},
{name:"newspaper", value:"F395"},
{name:"nfc", value:"F396"},
{name:"nfc-tap", value:"F397"},
{name:"nfc-variant", value:"F398"},
{name:"ninja", value:"F773"},
{name:"nintendo-switch", value:"F7E0"},
{name:"nodejs", value:"F399"},
{name:"note", value:"F39A"},
{name:"note-multiple", value:"F6B7"},
{name:"note-multiple-outline", value:"F6B8"},
{name:"note-outline", value:"F39B"},
{name:"note-plus", value:"F39C"},
{name:"note-plus-outline", value:"F39D"},
{name:"note-text", value:"F39E"},
{name:"notebook", value:"F82D"},
{name:"notification-clear-all", value:"F39F"},
{name:"npm", value:"F6F6"},
{name:"nuke", value:"F6A3"},
{name:"null", value:"F7E1"},
{name:"numeric", value:"F3A0"},
{name:"numeric-0-box", value:"F3A1"},
{name:"numeric-0-box-multiple-outline", value:"F3A2"},
{name:"numeric-0-box-outline", value:"F3A3"},
{name:"numeric-1-box", value:"F3A4"},
{name:"numeric-1-box-multiple-outline", value:"F3A5"},
{name:"numeric-1-box-outline", value:"F3A6"},
{name:"numeric-2-box", value:"F3A7"},
{name:"numeric-2-box-multiple-outline", value:"F3A8"},
{name:"numeric-2-box-outline", value:"F3A9"},
{name:"numeric-3-box", value:"F3AA"},
{name:"numeric-3-box-multiple-outline", value:"F3AB"},
{name:"numeric-3-box-outline", value:"F3AC"},
{name:"numeric-4-box", value:"F3AD"},
{name:"numeric-4-box-multiple-outline", value:"F3AE"},
{name:"numeric-4-box-outline", value:"F3AF"},
{name:"numeric-5-box", value:"F3B0"},
{name:"numeric-5-box-multiple-outline", value:"F3B1"},
{name:"numeric-5-box-outline", value:"F3B2"},
{name:"numeric-6-box", value:"F3B3"},
{name:"numeric-6-box-multiple-outline", value:"F3B4"},
{name:"numeric-6-box-outline", value:"F3B5"},
{name:"numeric-7-box", value:"F3B6"},
{name:"numeric-7-box-multiple-outline", value:"F3B7"},
{name:"numeric-7-box-outline", value:"F3B8"},
{name:"numeric-8-box", value:"F3B9"},
{name:"numeric-8-box-multiple-outline", value:"F3BA"},
{name:"numeric-8-box-outline", value:"F3BB"},
{name:"numeric-9-box", value:"F3BC"},
{name:"numeric-9-box-multiple-outline", value:"F3BD"},
{name:"numeric-9-box-outline", value:"F3BE"},
{name:"numeric-9-plus-box", value:"F3BF"},
{name:"numeric-9-plus-box-multiple-outline", value:"F3C0"},
{name:"numeric-9-plus-box-outline", value:"F3C1"},
{name:"nut", value:"F6F7"},
{name:"nutrition", value:"F3C2"},
{name:"oar", value:"F67B"},
{name:"octagon", value:"F3C3"},
{name:"octagon-outline", value:"F3C4"},
{name:"octagram", value:"F6F8"},
{name:"octagram-outline", value:"F774"},
{name:"odnoklassniki", value:"F3C5"},
{name:"office", value:"F3C6"},
{name:"oil", value:"F3C7"},
{name:"oil-temperature", value:"F3C8"},
{name:"omega", value:"F3C9"},
{name:"onedrive", value:"F3CA"},
{name:"onenote", value:"F746"},
{name:"opacity", value:"F5CC"},
{name:"open-in-app", value:"F3CB"},
{name:"open-in-new", value:"F3CC"},
{name:"openid", value:"F3CD"},
{name:"opera", value:"F3CE"},
{name:"orbit", value:"F018"},
{name:"ornament", value:"F3CF"},
{name:"ornament-variant", value:"F3D0"},
{name:"owl", value:"F3D2"},
{name:"package", value:"F3D3"},
{name:"package-down", value:"F3D4"},
{name:"package-up", value:"F3D5"},
{name:"package-variant", value:"F3D6"},
{name:"package-variant-closed", value:"F3D7"},
{name:"page-first", value:"F600"},
{name:"page-last", value:"F601"},
{name:"page-layout-body", value:"F6F9"},
{name:"page-layout-footer", value:"F6FA"},
{name:"page-layout-header", value:"F6FB"},
{name:"page-layout-sidebar-left", value:"F6FC"},
{name:"page-layout-sidebar-right", value:"F6FD"},
{name:"palette", value:"F3D8"},
{name:"palette-advanced", value:"F3D9"},
{name:"panda", value:"F3DA"},
{name:"pandora", value:"F3DB"},
{name:"panorama", value:"F3DC"},
{name:"panorama-fisheye", value:"F3DD"},
{name:"panorama-horizontal", value:"F3DE"},
{name:"panorama-vertical", value:"F3DF"},
{name:"panorama-wide-angle", value:"F3E0"},
{name:"paper-cut-vertical", value:"F3E1"},
{name:"paperclip", value:"F3E2"},
{name:"parking", value:"F3E3"},
{name:"passport", value:"F7E2"},
{name:"pause", value:"F3E4"},
{name:"pause-circle", value:"F3E5"},
{name:"pause-circle-outline", value:"F3E6"},
{name:"pause-octagon", value:"F3E7"},
{name:"pause-octagon-outline", value:"F3E8"},
{name:"paw", value:"F3E9"},
{name:"paw-off", value:"F657"},
{name:"pen", value:"F3EA"},
{name:"pencil", value:"F3EB"},
{name:"pencil-box", value:"F3EC"},
{name:"pencil-box-outline", value:"F3ED"},
{name:"pencil-circle", value:"F6FE"},
{name:"pencil-circle-outline", value:"F775"},
{name:"pencil-lock", value:"F3EE"},
{name:"pencil-off", value:"F3EF"},
{name:"pentagon", value:"F6FF"},
{name:"pentagon-outline", value:"F700"},
{name:"percent", value:"F3F0"},
{name:"periodic-table-co2", value:"F7E3"},
{name:"periscope", value:"F747"},
{name:"pharmacy", value:"F3F1"},
{name:"phone", value:"F3F2"},
{name:"phone-bluetooth", value:"F3F3"},
{name:"phone-classic", value:"F602"},
{name:"phone-forward", value:"F3F4"},
{name:"phone-hangup", value:"F3F5"},
{name:"phone-in-talk", value:"F3F6"},
{name:"phone-incoming", value:"F3F7"},
{name:"phone-locked", value:"F3F8"},
{name:"phone-log", value:"F3F9"},
{name:"phone-minus", value:"F658"},
{name:"phone-missed", value:"F3FA"},
{name:"phone-outgoing", value:"F3FB"},
{name:"phone-paused", value:"F3FC"},
{name:"phone-plus", value:"F659"},
{name:"phone-return", value:"F82E"},
{name:"phone-settings", value:"F3FD"},
{name:"phone-voip", value:"F3FE"},
{name:"pi", value:"F3FF"},
{name:"pi-box", value:"F400"},
{name:"piano", value:"F67C"},
{name:"pig", value:"F401"},
{name:"pill", value:"F402"},
{name:"pillar", value:"F701"},
{name:"pin", value:"F403"},
{name:"pin-off", value:"F404"},
{name:"pine-tree", value:"F405"},
{name:"pine-tree-box", value:"F406"},
{name:"pinterest", value:"F407"},
{name:"pinterest-box", value:"F408"},
{name:"pipe", value:"F7E4"},
{name:"pipe-disconnected", value:"F7E5"},
{name:"pistol", value:"F702"},
{name:"pizza", value:"F409"},
{name:"plane-shield", value:"F6BA"},
{name:"play", value:"F40A"},
{name:"play-box-outline", value:"F40B"},
{name:"play-circle", value:"F40C"},
{name:"play-circle-outline", value:"F40D"},
{name:"play-pause", value:"F40E"},
{name:"play-protected-content", value:"F40F"},
{name:"playlist-check", value:"F5C7"},
{name:"playlist-minus", value:"F410"},
{name:"playlist-play", value:"F411"},
{name:"playlist-plus", value:"F412"},
{name:"playlist-remove", value:"F413"},
{name:"playstation", value:"F414"},
{name:"plex", value:"F6B9"},
{name:"plus", value:"F415"},
{name:"plus-box", value:"F416"},
{name:"plus-box-outline", value:"F703"},
{name:"plus-circle", value:"F417"},
{name:"plus-circle-multiple-outline", value:"F418"},
{name:"plus-circle-outline", value:"F419"},
{name:"plus-network", value:"F41A"},
{name:"plus-one", value:"F41B"},
{name:"plus-outline", value:"F704"},
{name:"pocket", value:"F41C"},
{name:"pokeball", value:"F41D"},
{name:"poker-chip", value:"F82F"},
{name:"polaroid", value:"F41E"},
{name:"poll", value:"F41F"},
{name:"poll-box", value:"F420"},
{name:"polymer", value:"F421"},
{name:"pool", value:"F606"},
{name:"popcorn", value:"F422"},
{name:"pot", value:"F65A"},
{name:"pot-mix", value:"F65B"},
{name:"pound", value:"F423"},
{name:"pound-box", value:"F424"},
{name:"power", value:"F425"},
{name:"power-plug", value:"F6A4"},
{name:"power-plug-off", value:"F6A5"},
{name:"power-settings", value:"F426"},
{name:"power-socket", value:"F427"},
{name:"power-socket-eu", value:"F7E6"},
{name:"power-socket-uk", value:"F7E7"},
{name:"power-socket-us", value:"F7E8"},
{name:"prescription", value:"F705"},
{name:"presentation", value:"F428"},
{name:"presentation-play", value:"F429"},
{name:"printer", value:"F42A"},
{name:"printer-3d", value:"F42B"},
{name:"printer-alert", value:"F42C"},
{name:"printer-settings", value:"F706"},
{name:"priority-high", value:"F603"},
{name:"priority-low", value:"F604"},
{name:"professional-hexagon", value:"F42D"},
{name:"projector", value:"F42E"},
{name:"projector-screen", value:"F42F"},
{name:"publish", value:"F6A6"},
{name:"pulse", value:"F430"},
{name:"puzzle", value:"F431"},
{name:"qqchat", value:"F605"},
{name:"qrcode", value:"F432"},
{name:"qrcode-scan", value:"F433"},
{name:"quadcopter", value:"F434"},
{name:"quality-high", value:"F435"},
{name:"quicktime", value:"F436"},
{name:"radar", value:"F437"},
{name:"radiator", value:"F438"},
{name:"radio", value:"F439"},
{name:"radio-handheld", value:"F43A"},
{name:"radio-tower", value:"F43B"},
{name:"radioactive", value:"F43C"},
{name:"radiobox-blank", value:"F43D"},
{name:"radiobox-marked", value:"F43E"},
{name:"raspberrypi", value:"F43F"},
{name:"ray-end", value:"F440"},
{name:"ray-end-arrow", value:"F441"},
{name:"ray-start", value:"F442"},
{name:"ray-start-arrow", value:"F443"},
{name:"ray-start-end", value:"F444"},
{name:"ray-vertex", value:"F445"},
{name:"react", value:"F707"},
{name:"read", value:"F447"},
{name:"receipt", value:"F449"},
{name:"record", value:"F44A"},
{name:"record-rec", value:"F44B"},
{name:"recycle", value:"F44C"},
{name:"reddit", value:"F44D"},
{name:"redo", value:"F44E"},
{name:"redo-variant", value:"F44F"},
{name:"refresh", value:"F450"},
{name:"regex", value:"F451"},
{name:"relative-scale", value:"F452"},
{name:"reload", value:"F453"},
{name:"remote", value:"F454"},
{name:"rename-box", value:"F455"},
{name:"reorder-horizontal", value:"F687"},
{name:"reorder-vertical", value:"F688"},
{name:"repeat", value:"F456"},
{name:"repeat-off", value:"F457"},
{name:"repeat-once", value:"F458"},
{name:"replay", value:"F459"},
{name:"reply", value:"F45A"},
{name:"reply-all", value:"F45B"},
{name:"reproduction", value:"F45C"},
{name:"resize-bottom-right", value:"F45D"},
{name:"responsive", value:"F45E"},
{name:"restart", value:"F708"},
{name:"restore", value:"F6A7"},
{name:"rewind", value:"F45F"},
{name:"rewind-outline", value:"F709"},
{name:"rhombus", value:"F70A"},
{name:"rhombus-outline", value:"F70B"},
{name:"ribbon", value:"F460"},
{name:"rice", value:"F7E9"},
{name:"ring", value:"F7EA"},
{name:"road", value:"F461"},
{name:"road-variant", value:"F462"},
{name:"robot", value:"F6A8"},
{name:"rocket", value:"F463"},
{name:"roomba", value:"F70C"},
{name:"rotate-3d", value:"F464"},
{name:"rotate-left", value:"F465"},
{name:"rotate-left-variant", value:"F466"},
{name:"rotate-right", value:"F467"},
{name:"rotate-right-variant", value:"F468"},
{name:"rounded-corner", value:"F607"},
{name:"router-wireless", value:"F469"},
{name:"routes", value:"F46A"},
{name:"rowing", value:"F608"},
{name:"rss", value:"F46B"},
{name:"rss-box", value:"F46C"},
{name:"ruler", value:"F46D"},
{name:"run", value:"F70D"},
{name:"run-fast", value:"F46E"},
{name:"sale", value:"F46F"},
{name:"sass", value:"F7EB"},
{name:"satellite", value:"F470"},
{name:"satellite-variant", value:"F471"},
{name:"saxophone", value:"F609"},
{name:"scale", value:"F472"},
{name:"scale-balance", value:"F5D1"},
{name:"scale-bathroom", value:"F473"},
{name:"scanner", value:"F6AA"},
{name:"school", value:"F474"},
{name:"screen-rotation", value:"F475"},
{name:"screen-rotation-lock", value:"F476"},
{name:"screwdriver", value:"F477"},
{name:"script", value:"F478"},
{name:"sd", value:"F479"},
{name:"seal", value:"F47A"},
{name:"search-web", value:"F70E"},
{name:"seat-flat", value:"F47B"},
{name:"seat-flat-angled", value:"F47C"},
{name:"seat-individual-suite", value:"F47D"},
{name:"seat-legroom-extra", value:"F47E"},
{name:"seat-legroom-normal", value:"F47F"},
{name:"seat-legroom-reduced", value:"F480"},
{name:"seat-recline-extra", value:"F481"},
{name:"seat-recline-normal", value:"F482"},
{name:"security", value:"F483"},
{name:"security-home", value:"F689"},
{name:"security-network", value:"F484"},
{name:"select", value:"F485"},
{name:"select-all", value:"F486"},
{name:"select-inverse", value:"F487"},
{name:"select-off", value:"F488"},
{name:"selection", value:"F489"},
{name:"selection-off", value:"F776"},
{name:"send", value:"F48A"},
{name:"send-secure", value:"F7EC"},
{name:"serial-port", value:"F65C"},
{name:"server", value:"F48B"},
{name:"server-minus", value:"F48C"},
{name:"server-network", value:"F48D"},
{name:"server-network-off", value:"F48E"},
{name:"server-off", value:"F48F"},
{name:"server-plus", value:"F490"},
{name:"server-remove", value:"F491"},
{name:"server-security", value:"F492"},
{name:"set-all", value:"F777"},
{name:"set-center", value:"F778"},
{name:"set-center-right", value:"F779"},
{name:"set-left", value:"F77A"},
{name:"set-left-center", value:"F77B"},
{name:"set-left-right", value:"F77C"},
{name:"set-none", value:"F77D"},
{name:"set-right", value:"F77E"},
{name:"settings", value:"F493"},
{name:"settings-box", value:"F494"},
{name:"shape", value:"F830"},
{name:"shape-circle-plus", value:"F65D"},
{name:"shape-outline", value:"F831"},
{name:"shape-plus", value:"F495"},
{name:"shape-polygon-plus", value:"F65E"},
{name:"shape-rectangle-plus", value:"F65F"},
{name:"shape-square-plus", value:"F660"},
{name:"share", value:"F496"},
{name:"share-variant", value:"F497"},
{name:"shield", value:"F498"},
{name:"shield-half-full", value:"F77F"},
{name:"shield-outline", value:"F499"},
{name:"ship-wheel", value:"F832"},
{name:"shopping", value:"F49A"},
{name:"shopping-music", value:"F49B"},
{name:"shovel", value:"F70F"},
{name:"shovel-off", value:"F710"},
{name:"shredder", value:"F49C"},
{name:"shuffle", value:"F49D"},
{name:"shuffle-disabled", value:"F49E"},
{name:"shuffle-variant", value:"F49F"},
{name:"sigma", value:"F4A0"},
{name:"sigma-lower", value:"F62B"},
{name:"sign-caution", value:"F4A1"},
{name:"sign-direction", value:"F780"},
{name:"sign-text", value:"F781"},
{name:"signal", value:"F4A2"},
{name:"signal-2g", value:"F711"},
{name:"signal-3g", value:"F712"},
{name:"signal-4g", value:"F713"},
{name:"signal-hspa", value:"F714"},
{name:"signal-hspa-plus", value:"F715"},
{name:"signal-off", value:"F782"},
{name:"signal-variant", value:"F60A"},
{name:"silverware", value:"F4A3"},
{name:"silverware-fork", value:"F4A4"},
{name:"silverware-spoon", value:"F4A5"},
{name:"silverware-variant", value:"F4A6"},
{name:"sim", value:"F4A7"},
{name:"sim-alert", value:"F4A8"},
{name:"sim-off", value:"F4A9"},
{name:"sitemap", value:"F4AA"},
{name:"skip-backward", value:"F4AB"},
{name:"skip-forward", value:"F4AC"},
{name:"skip-next", value:"F4AD"},
{name:"skip-next-circle", value:"F661"},
{name:"skip-next-circle-outline", value:"F662"},
{name:"skip-previous", value:"F4AE"},
{name:"skip-previous-circle", value:"F663"},
{name:"skip-previous-circle-outline", value:"F664"},
{name:"skull", value:"F68B"},
{name:"skype", value:"F4AF"},
{name:"skype-business", value:"F4B0"},
{name:"slack", value:"F4B1"},
{name:"sleep", value:"F4B2"},
{name:"sleep-off", value:"F4B3"},
{name:"smoking", value:"F4B4"},
{name:"smoking-off", value:"F4B5"},
{name:"snapchat", value:"F4B6"},
{name:"snowflake", value:"F716"},
{name:"snowman", value:"F4B7"},
{name:"soccer", value:"F4B8"},
{name:"soccer-field", value:"F833"},
{name:"sofa", value:"F4B9"},
{name:"solid", value:"F68C"},
{name:"sort", value:"F4BA"},
{name:"sort-alphabetical", value:"F4BB"},
{name:"sort-ascending", value:"F4BC"},
{name:"sort-descending", value:"F4BD"},
{name:"sort-numeric", value:"F4BE"},
{name:"sort-variant", value:"F4BF"},
{name:"soundcloud", value:"F4C0"},
{name:"source-branch", value:"F62C"},
{name:"source-commit", value:"F717"},
{name:"source-commit-end", value:"F718"},
{name:"source-commit-end-local", value:"F719"},
{name:"source-commit-local", value:"F71A"},
{name:"source-commit-next-local", value:"F71B"},
{name:"source-commit-start", value:"F71C"},
{name:"source-commit-start-next-local", value:"F71D"},
{name:"source-fork", value:"F4C1"},
{name:"source-merge", value:"F62D"},
{name:"source-pull", value:"F4C2"},
{name:"soy-sauce", value:"F7ED"},
{name:"speaker", value:"F4C3"},
{name:"speaker-off", value:"F4C4"},
{name:"speaker-wireless", value:"F71E"},
{name:"speedometer", value:"F4C5"},
{name:"spellcheck", value:"F4C6"},
{name:"spotify", value:"F4C7"},
{name:"spotlight", value:"F4C8"},
{name:"spotlight-beam", value:"F4C9"},
{name:"spray", value:"F665"},
{name:"square", value:"F763"},
{name:"square-inc", value:"F4CA"},
{name:"square-inc-cash", value:"F4CB"},
{name:"square-outline", value:"F762"},
{name:"square-root", value:"F783"},
{name:"stack-overflow", value:"F4CC"},
{name:"stackexchange", value:"F60B"},
{name:"stadium", value:"F71F"},
{name:"stairs", value:"F4CD"},
{name:"standard-definition", value:"F7EE"},
{name:"star", value:"F4CE"},
{name:"star-circle", value:"F4CF"},
{name:"star-half", value:"F4D0"},
{name:"star-off", value:"F4D1"},
{name:"star-outline", value:"F4D2"},
{name:"steam", value:"F4D3"},
{name:"steering", value:"F4D4"},
{name:"step-backward", value:"F4D5"},
{name:"step-backward-2", value:"F4D6"},
{name:"step-forward", value:"F4D7"},
{name:"step-forward-2", value:"F4D8"},
{name:"stethoscope", value:"F4D9"},
{name:"sticker", value:"F5D0"},
{name:"sticker-emoji", value:"F784"},
{name:"stocking", value:"F4DA"},
{name:"stop", value:"F4DB"},
{name:"stop-circle", value:"F666"},
{name:"stop-circle-outline", value:"F667"},
{name:"store", value:"F4DC"},
{name:"store-24-hour", value:"F4DD"},
{name:"stove", value:"F4DE"},
{name:"subdirectory-arrow-left", value:"F60C"},
{name:"subdirectory-arrow-right", value:"F60D"},
{name:"subway", value:"F6AB"},
{name:"subway-variant", value:"F4DF"},
{name:"summit", value:"F785"},
{name:"sunglasses", value:"F4E0"},
{name:"surround-sound", value:"F5C5"},
{name:"surround-sound-2-0", value:"F7EF"},
{name:"surround-sound-3-1", value:"F7F0"},
{name:"surround-sound-5-1", value:"F7F1"},
{name:"surround-sound-7-1", value:"F7F2"},
{name:"svg", value:"F720"},
{name:"swap-horizontal", value:"F4E1"},
{name:"swap-vertical", value:"F4E2"},
{name:"swim", value:"F4E3"},
{name:"switch", value:"F4E4"},
{name:"sword", value:"F4E5"},
{name:"sword-cross", value:"F786"},
{name:"sync", value:"F4E6"},
{name:"sync-alert", value:"F4E7"},
{name:"sync-off", value:"F4E8"},
{name:"tab", value:"F4E9"},
{name:"tab-plus", value:"F75B"},
{name:"tab-unselected", value:"F4EA"},
{name:"table", value:"F4EB"},
{name:"table-column", value:"F834"},
{name:"table-column-plus-after", value:"F4EC"},
{name:"table-column-plus-before", value:"F4ED"},
{name:"table-column-remove", value:"F4EE"},
{name:"table-column-width", value:"F4EF"},
{name:"table-edit", value:"F4F0"},
{name:"table-large", value:"F4F1"},
{name:"table-of-contents", value:"F835"},
{name:"table-row", value:"F836"},
{name:"table-row-height", value:"F4F2"},
{name:"table-row-plus-after", value:"F4F3"},
{name:"table-row-plus-before", value:"F4F4"},
{name:"table-row-remove", value:"F4F5"},
{name:"table-settings", value:"F837"},
{name:"tablet", value:"F4F6"},
{name:"tablet-android", value:"F4F7"},
{name:"tablet-ipad", value:"F4F8"},
{name:"taco", value:"F761"},
{name:"tag", value:"F4F9"},
{name:"tag-faces", value:"F4FA"},
{name:"tag-heart", value:"F68A"},
{name:"tag-multiple", value:"F4FB"},
{name:"tag-outline", value:"F4FC"},
{name:"tag-plus", value:"F721"},
{name:"tag-remove", value:"F722"},
{name:"tag-text-outline", value:"F4FD"},
{name:"target", value:"F4FE"},
{name:"taxi", value:"F4FF"},
{name:"teamviewer", value:"F500"},
{name:"telegram", value:"F501"},
{name:"television", value:"F502"},
{name:"television-box", value:"F838"},
{name:"television-classic", value:"F7F3"},
{name:"television-classic-off", value:"F839"},
{name:"television-guide", value:"F503"},
{name:"television-off", value:"F83A"},
{name:"temperature-celsius", value:"F504"},
{name:"temperature-fahrenheit", value:"F505"},
{name:"temperature-kelvin", value:"F506"},
{name:"tennis", value:"F507"},
{name:"tent", value:"F508"},
{name:"terrain", value:"F509"},
{name:"test-tube", value:"F668"},
{name:"text-shadow", value:"F669"},
{name:"text-to-speech", value:"F50A"},
{name:"text-to-speech-off", value:"F50B"},
{name:"textbox", value:"F60E"},
{name:"textbox-password", value:"F7F4"},
{name:"texture", value:"F50C"},
{name:"theater", value:"F50D"},
{name:"theme-light-dark", value:"F50E"},
{name:"thermometer", value:"F50F"},
{name:"thermometer-lines", value:"F510"},
{name:"thought-bubble", value:"F7F5"},
{name:"thought-bubble-outline", value:"F7F6"},
{name:"thumb-down", value:"F511"},
{name:"thumb-down-outline", value:"F512"},
{name:"thumb-up", value:"F513"},
{name:"thumb-up-outline", value:"F514"},
{name:"thumbs-up-down", value:"F515"},
{name:"ticket", value:"F516"},
{name:"ticket-account", value:"F517"},
{name:"ticket-confirmation", value:"F518"},
{name:"ticket-percent", value:"F723"},
{name:"tie", value:"F519"},
{name:"tilde", value:"F724"},
{name:"timelapse", value:"F51A"},
{name:"timer", value:"F51B"},
{name:"timer-10", value:"F51C"},
{name:"timer-3", value:"F51D"},
{name:"timer-off", value:"F51E"},
{name:"timer-sand", value:"F51F"},
{name:"timer-sand-empty", value:"F6AC"},
{name:"timer-sand-full", value:"F78B"},
{name:"timetable", value:"F520"},
{name:"toggle-switch", value:"F521"},
{name:"toggle-switch-off", value:"F522"},
{name:"tooltip", value:"F523"},
{name:"tooltip-edit", value:"F524"},
{name:"tooltip-image", value:"F525"},
{name:"tooltip-outline", value:"F526"},
{name:"tooltip-outline-plus", value:"F527"},
{name:"tooltip-text", value:"F528"},
{name:"tooth", value:"F529"},
{name:"tor", value:"F52A"},
{name:"tower-beach", value:"F680"},
{name:"tower-fire", value:"F681"},
{name:"towing", value:"F83B"},
{name:"trackpad", value:"F7F7"},
{name:"traffic-light", value:"F52B"},
{name:"train", value:"F52C"},
{name:"tram", value:"F52D"},
{name:"transcribe", value:"F52E"},
{name:"transcribe-close", value:"F52F"},
{name:"transfer", value:"F530"},
{name:"transit-transfer", value:"F6AD"},
{name:"translate", value:"F5CA"},
{name:"treasure-chest", value:"F725"},
{name:"tree", value:"F531"},
{name:"trello", value:"F532"},
{name:"trending-down", value:"F533"},
{name:"trending-neutral", value:"F534"},
{name:"trending-up", value:"F535"},
{name:"triangle", value:"F536"},
{name:"triangle-outline", value:"F537"},
{name:"trophy", value:"F538"},
{name:"trophy-award", value:"F539"},
{name:"trophy-outline", value:"F53A"},
{name:"trophy-variant", value:"F53B"},
{name:"trophy-variant-outline", value:"F53C"},
{name:"truck", value:"F53D"},
{name:"truck-delivery", value:"F53E"},
{name:"truck-fast", value:"F787"},
{name:"truck-trailer", value:"F726"},
{name:"tshirt-crew", value:"F53F"},
{name:"tshirt-v", value:"F540"},
{name:"tumblr", value:"F541"},
{name:"tumblr-reblog", value:"F542"},
{name:"tune", value:"F62E"},
{name:"tune-vertical", value:"F66A"},
{name:"twitch", value:"F543"},
{name:"twitter", value:"𝕏"},
{name:"twitter-box", value:"F545"},
{name:"twitter-circle", value:"F546"},
{name:"twitter-retweet", value:"F547"},
{name:"uber", value:"F748"},
{name:"ubuntu", value:"F548"},
{name:"ultra-high-definition", value:"F7F8"},
{name:"umbraco", value:"F549"},
{name:"umbrella", value:"F54A"},
{name:"umbrella-outline", value:"F54B"},
{name:"undo", value:"F54C"},
{name:"undo-variant", value:"F54D"},
{name:"unfold-less-horizontal", value:"F54E"},
{name:"unfold-less-vertical", value:"F75F"},
{name:"unfold-more-horizontal", value:"F54F"},
{name:"unfold-more-vertical", value:"F760"},
{name:"ungroup", value:"F550"},
{name:"unity", value:"F6AE"},
{name:"untappd", value:"F551"},
{name:"update", value:"F6AF"},
{name:"upload", value:"F552"},
{name:"upload-multiple", value:"F83C"},
{name:"upload-network", value:"F6F5"},
{name:"usb", value:"F553"},
{name:"van-passenger", value:"F7F9"},
{name:"van-utility", value:"F7FA"},
{name:"vanish", value:"F7FB"},
{name:"vector-arrange-above", value:"F554"},
{name:"vector-arrange-below", value:"F555"},
{name:"vector-circle", value:"F556"},
{name:"vector-circle-variant", value:"F557"},
{name:"vector-combine", value:"F558"},
{name:"vector-curve", value:"F559"},
{name:"vector-difference", value:"F55A"},
{name:"vector-difference-ab", value:"F55B"},
{name:"vector-difference-ba", value:"F55C"},
{name:"vector-intersection", value:"F55D"},
{name:"vector-line", value:"F55E"},
{name:"vector-point", value:"F55F"},
{name:"vector-polygon", value:"F560"},
{name:"vector-polyline", value:"F561"},
{name:"vector-radius", value:"F749"},
{name:"vector-rectangle", value:"F5C6"},
{name:"vector-selection", value:"F562"},
{name:"vector-square", value:"F001"},
{name:"vector-triangle", value:"F563"},
{name:"vector-union", value:"F564"},
{name:"venmo", value:"F578"},
{name:"verified", value:"F565"},
{name:"vibrate", value:"F566"},
{name:"video", value:"F567"},
{name:"video-3d", value:"F7FC"},
{name:"video-4k-box", value:"F83D"},
{name:"video-input-antenna", value:"F83E"},
{name:"video-input-component", value:"F83F"},
{name:"video-input-hdmi", value:"F840"},
{name:"video-input-svideo", value:"F841"},
{name:"video-off", value:"F568"},
{name:"video-switch", value:"F569"},
{name:"view-agenda", value:"F56A"},
{name:"view-array", value:"F56B"},
{name:"view-carousel", value:"F56C"},
{name:"view-column", value:"F56D"},
{name:"view-dashboard", value:"F56E"},
{name:"view-dashboard-variant", value:"F842"},
{name:"view-day", value:"F56F"},
{name:"view-grid", value:"F570"},
{name:"view-headline", value:"F571"},
{name:"view-list", value:"F572"},
{name:"view-module", value:"F573"},
{name:"view-parallel", value:"F727"},
{name:"view-quilt", value:"F574"},
{name:"view-sequential", value:"F728"},
{name:"view-stream", value:"F575"},
{name:"view-week", value:"F576"},
{name:"vimeo", value:"F577"},
{name:"violin", value:"F60F"},
{name:"visualstudio", value:"F610"},
{name:"vk", value:"F579"},
{name:"vk-box", value:"F57A"},
{name:"vk-circle", value:"F57B"},
{name:"vlc", value:"F57C"},
{name:"voice", value:"F5CB"},
{name:"voicemail", value:"F57D"},
{name:"volume-high", value:"F57E"},
{name:"volume-low", value:"F57F"},
{name:"volume-medium", value:"F580"},
{name:"volume-minus", value:"F75D"},
{name:"volume-mute", value:"F75E"},
{name:"volume-off", value:"F581"},
{name:"volume-plus", value:"F75C"},
{name:"vpn", value:"F582"},
{name:"vuejs", value:"F843"},
{name:"walk", value:"F583"},
{name:"wall", value:"F7FD"},
{name:"wallet", value:"F584"},
{name:"wallet-giftcard", value:"F585"},
{name:"wallet-membership", value:"F586"},
{name:"wallet-travel", value:"F587"},
{name:"wan", value:"F588"},
{name:"washing-machine", value:"F729"},
{name:"watch", value:"F589"},
{name:"watch-export", value:"F58A"},
{name:"watch-import", value:"F58B"},
{name:"watch-vibrate", value:"F6B0"},
{name:"water", value:"F58C"},
{name:"water-off", value:"F58D"},
{name:"water-percent", value:"F58E"},
{name:"water-pump", value:"F58F"},
{name:"watermark", value:"F612"},
{name:"waves", value:"F78C"},
{name:"weather-cloudy", value:"F590"},
{name:"weather-fog", value:"F591"},
{name:"weather-hail", value:"F592"},
{name:"weather-lightning", value:"F593"},
{name:"weather-lightning-rainy", value:"F67D"},
{name:"weather-night", value:"F594"},
{name:"weather-partlycloudy", value:"F595"},
{name:"weather-pouring", value:"F596"},
{name:"weather-rainy", value:"F597"},
{name:"weather-snowy", value:"F598"},
{name:"weather-snowy-rainy", value:"F67E"},
{name:"weather-sunny", value:"F599"},
{name:"weather-sunset", value:"F59A"},
{name:"weather-sunset-down", value:"F59B"},
{name:"weather-sunset-up", value:"F59C"},
{name:"weather-windy", value:"F59D"},
{name:"weather-windy-variant", value:"F59E"},
{name:"web", value:"F59F"},
{name:"webcam", value:"F5A0"},
{name:"webhook", value:"F62F"},
{name:"webpack", value:"F72A"},
{name:"wechat", value:"F611"},
{name:"weight", value:"F5A1"},
{name:"weight-kilogram", value:"F5A2"},
{name:"whatsapp", value:"F5A3"},
{name:"wheelchair-accessibility", value:"F5A4"},
{name:"white-balance-auto", value:"F5A5"},
{name:"white-balance-incandescent", value:"F5A6"},
{name:"white-balance-iridescent", value:"F5A7"},
{name:"white-balance-sunny", value:"F5A8"},
{name:"widgets", value:"F72B"},
{name:"wifi", value:"F5A9"},
{name:"wifi-off", value:"F5AA"},
{name:"wii", value:"F5AB"},
{name:"wiiu", value:"F72C"},
{name:"wikipedia", value:"F5AC"},
{name:"window-close", value:"F5AD"},
{name:"window-closed", value:"F5AE"},
{name:"window-maximize", value:"F5AF"},
{name:"window-minimize", value:"F5B0"},
{name:"window-open", value:"F5B1"},
{name:"window-restore", value:"F5B2"},
{name:"windows", value:"F5B3"},
{name:"wordpress", value:"F5B4"},
{name:"worker", value:"F5B5"},
{name:"wrap", value:"F5B6"},
{name:"wrench", value:"F5B7"},
{name:"wunderlist", value:"F5B8"},
{name:"xamarin", value:"F844"},
{name:"xamarin-outline", value:"F845"},
{name:"xaml", value:"F673"},
{name:"xbox", value:"F5B9"},
{name:"xbox-controller", value:"F5BA"},
{name:"xbox-controller-battery-alert", value:"F74A"},
{name:"xbox-controller-battery-empty", value:"F74B"},
{name:"xbox-controller-battery-full", value:"F74C"},
{name:"xbox-controller-battery-low", value:"F74D"},
{name:"xbox-controller-battery-medium", value:"F74E"},
{name:"xbox-controller-battery-unknown", value:"F74F"},
{name:"xbox-controller-off", value:"F5BB"},
{name:"xda", value:"F5BC"},
{name:"xing", value:"F5BD"},
{name:"xing-box", value:"F5BE"},
{name:"xing-circle", value:"F5BF"},
{name:"xml", value:"F5C0"},
{name:"xmpp", value:"F7FE"},
{name:"yammer", value:"F788"},
{name:"yeast", value:"F5C1"},
{name:"yelp", value:"F5C2"},
{name:"yin-yang", value:"F67F"},
{name:"youtube-creator-studio", value:"F846"},
{name:"youtube-gaming", value:"F847"},
{name:"youtube-play", value:"F5C3"},
{name:"youtube-tv", value:"F448"},
{name:"zip-box", value:"F5C4"}];

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/cm-commons.js";

if (typeof Object.assign != 'function') {
    Object.defineProperty(Object, "assign", {
        value: function assign(target, varArgs) {
            'use strict';
            if (typeof target != "object") {
                throw new TypeError('Target must be an object');
            }

            var to = Object(target);

            for (var index = 1; index < arguments.length; index++) {
                var nextSource = arguments[index];

                if (typeof nextSource == "object") {
                    for (var nextKey in nextSource) {
                        // Avoid bugs when hasOwnProperty is shadowed
                        if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                            to[nextKey] = nextSource[nextKey];
                        }
                    }
                }
            }
            return to;
        },
        writable: true,
        configurable: true
    });
}

var ClassUtils = (function () {
    function transformToTimeZone (date, timezone){
        if(!date || !moment) return null;
        if(!timezone) timezone = moment.tz.guess();
        var r = moment.tz(moment(date).format('YYYY-MM-DD HH:mm'), timezone).toDate();
        return r;
    }
    function transformTimeZoneToTimeZone (date, oldTimezone, newTimezone){
        if(!date || !moment) return null;
        if(!oldTimezone) timezone = moment.tz.guess();
        if(!newTimezone) timezone = moment.tz.guess();
        var d = moment.tz(date, oldTimezone).format("YYYY-MM-DD HH:mm");
        var r = moment.tz(d, newTimezone).toDate();
        return r;
    }
    function transformClassTimezoneToLocal (date, classTimezone){
        if(!date || !classTimezone || !moment) return null;
        var localTimezone = moment.tz.guess();
        var r = moment.tz(moment.tz(date, classTimezone).format('YYYY-MM-DD HH:mm'), localTimezone).toDate();
        return r;
    }
    function toCurrency(num) {
        return Util.toCurrency(num);//num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, "$&,");
    }

    function showAlternativeCost(val) {
        var currencySign = (window.LOCALE && window.LOCALE.currencySign) || "$";
        return currencySign + "--";
    }

    function round(value, fractionDigits) {
        if(isNaN(fractionDigits)) fractionDigits = 2;
        var divisor = 1.0;
        var fudgeFactor = 0.001;
        if (fractionDigits > 0) {
            divisor = Math.pow(10, fractionDigits);
            fudgeFactor = 1 / Math.pow(10, fractionDigits + 3);
        }
        return Math.round(value * divisor + fudgeFactor) / divisor;
    }

    function getDaySuffix (d, tzid) {
        return moment.tz(d, tzid).format('Do');
    }

    function isSameObject (obj1, obj2, comparator) {
        if (!obj1) return;
        if (!obj2) return;
        var isSame = true;
        var currentKey = "";
        for (var key in obj1) {
            currentKey = key;
            // console.log("compare: ", key, obj1[key], obj2[key]);

            if (comparator && typeof(comparator[key]) == "function") {
                isSame = comparator[key](obj1[key], obj2[key]);
                if (isSame) {
                    continue;
                } else {
                    break;
                }
            }

            if (obj2[key] == "undefined") {
                isSame = false;
                break;
            } else {
                if (obj1[key] instanceof Date && obj2[key] instanceof Date) {
                    if (obj1[key].getTime() != obj2[key].getTime()) {
                        isSame = false;
                        console.log("----> FAILED", key, obj1[key], obj2[key], (obj1[key].getTime() != obj2[key].getTime()) );
                        break;
                    }
                } else if (obj1[key] instanceof Array && obj2[key] instanceof Array) {
                    if (obj1[key].length != obj2[key].length) {
                        isSame = false;
                        break;
                    }
                    for (var i = 0; i < obj1[key].length; i ++) {
                        var value1 = obj1[key][i];
                        var value2 = obj2[key][i];
                        if (value1 instanceof Date && value2 instanceof Date) {
                            if (value1.getTime() != value2.getTime()) {
                                isSame = false;
                                break;
                            }
                        }
                    }
                } else {
                    if (obj1[key] != obj2[key]) {
                       isSame = false;
                       break;
                   }
                }
            }
        }
        if(!isSame) console.log("====> FAILE AT KEY", currentKey, obj1[key], obj2[key]);
        return isSame;
    }

    var registrationsTracking = {
        consts : {
            action : {
                selectedMembers: "selected_members",
                saveMembers: "save_members",
                saveMembersFeeWaived: "save_members_fee_waived",
                saveMembersWaitlist: "save_members_waitlist",
                saveMembersOffline: "save_members_offline",
                saveMembersCc: "save_members_cc",
                saveMembersOverride: "save_members_override",
                startClassSelect: "start_class_select",
                startClassExpand: "start_class_expand"
            }
        },
        send: function(options) {
            if (typeof(window.ga) == "function") {
                window.ga("send", options);
            }
        },
        sendEvent: function(action, label, value, soLevel) {
            var options = {
                hitType : "event",
                eventCategory : "class_member_add"
            };
            options["eventAction"] = action;
            options["eventLabel"] = label;
            options["eventValue"] = value;
            registrationsTracking.send(options);
        }
    };

    function compareDateValue(value1, value2, timezoneId) {
        if (value1 && value2) {
            var date1 = timezoneId? moment.tz(value1, timezoneId) : moment(value1);
            var date2 = timezoneId? moment.tz(value2, timezoneId) : moment(value2);
            console.log("Compare", timezoneId, date1, date2);
            if (date1.date() != date2.date() || date1.month() != date2.month() || date1.year() != date2.year()) {
                return false;
            }
            return true;
        }
        if (!value1 && !value2) {
            return true;
        }
        return false;
    }

    function compareDateTimeValue(value1, value2, timezoneId) {
        if (value1 && value2) {
            var date1 = timezoneId? moment.tz(value1, timezoneId) : moment(value1);
            var date2 = timezoneId? moment.tz(value2, timezoneId) : moment(value2);
            console.log("Compare timezne, value 1, value 2", timezoneId, date1, date2);
            if (date1.date() != date2.date() || date1.month() != date2.month() || date1.year() != date2.year()
                    || date1.hour() != date2.hour() || date1.minute() != date2.minute()) {
                return false;
            }
            return true;
        }
        if (!value1 && !value2) {
            return true;
        }
        return false;
    }

    function isEmpty(obj) {
        for(var key in obj) {
            if(obj.hasOwnProperty(key))
                return false;
        }
        return true;
    }

    function isIOSDevice() {
        //var iOS = /(iPad|iPhone|iPod)/g.test(navigator.userAgent);
        console.log("Check iOS device", navigator.platform, navigator.userAgent);
        return [
            'iPad Simulator',
            'iPhone Simulator',
            'iPod Simulator',
            'iPad',
            'iPhone',
            'iPod'
          ].includes(navigator.platform)
          // iPad on iOS 13 detection
          || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
    }

    function getClassStartTime(startMin) {
        var TIME_OFFERED_NOON = 60 * 12;
        var h = Math.floor(startMin / 60);
        var m = startMin % 60;
        var indicator = startMin >= TIME_OFFERED_NOON ? "PM" : "AM";
        h = (h > 12)? (h - 12): h;
        h = (h == 0)? 12 : h;
        return h + ":"  + String(m).padStart(2, "0") + " " + indicator;
    }

    function getAreementEmailContentTemaplate (teamAlias, myAccountAgreementLink) {
        return "Hello! <br/><br/> We are writing to let you know that you can log in to your SportsEngine Motion account to review " +
        "all required Agreements and Waivers assigned to you. Please follow the link below and log in with your email " +
        "and password to ensure that you have electronically signed all necessary documents for participation in our programs." +
        "<br/><br/><a href=\"Login5.jsp?team=" + teamAlias + "&_tu_Login_Redirect_=" + encodeURIComponent(myAccountAgreementLink) + "\">Log In</a> <br/><br/>Thank you!"
    };

    function getGenderByCode(code, defaultValue) {
        if (typeof code == "undefined") return defaultValue;
        if (code == 0) return Gender.Female;
        var gender = getGender(function(gender) {
            return gender.code == code;
        });
        return gender ? gender : defaultValue;
    };

    function getGenderByType(type, defaultValue) {
        var gender = getGender(function(gender) {
            return gender.type == type;
        });
        return gender ? gender : defaultValue;
    };

    function getGender(evaluator) {
        var selectedGenders = Object.values(Gender).filter(function(gender) {
            return gender.type != "Mixed" && evaluator(gender);
        });
        if (!selectedGenders || selectedGenders.length < 1) return undefined;
        return selectedGenders[0];
    };

    function isMyInstructorAssigned(classInfo, accountId) {
        if (!classInfo) return false;
        if (!accountId) return false;
        var isAssigned = false;
        if (classInfo.slots && classInfo.slots.length > 0) {
            for (var i = 0; i < classInfo.slots.length; i ++) {
                var slotInfo = classInfo.slots[i];
                if (slotInfo.instructorIds
                    && slotInfo.instructorIds.length > 0
                    && slotInfo.instructorIds.indexOf(accountId) >= 0) {
                    isAssigned = true;
                    break;
                }
            }
        }
        return isAssigned;
    };
    
    function getNoClassDaysInRange(noClassDays, classDateEnd, classTimezoneId) {
        var dates = [];
        if (noClassDays && noClassDays.length) {
            var today = moment().tz(classTimezoneId).startOf('day');
            for (var i = 0; i < noClassDays.length; i++) {
                if (noClassDays[i] >= today && noClassDays[i] <= classDateEnd) {
                    dates.push(FormatUtil.formatDate(noClassDays[i], "date_standard", "local"));
                }    
            }
        }
        return dates;
    };

    function getNoClassDaysInRangeWithSlots(slots, noClassDays, classDateStart, classDateEnd, classTimezoneId) {
        var dates = [];
        if (noClassDays && noClassDays.length) {
            var today = moment().tz(classTimezoneId).startOf('day');
            for (var i = 0; i < noClassDays.length; i++) {
                if (noClassDays[i] >= today && noClassDays[i] >= classDateStart && noClassDays[i] <= classDateEnd) {
                    var formattedDate = FormatUtil.formatDate(noClassDays[i], "date_standard", "local");
                    if (slots && slots.length > 0) {
                        for (var j = 0; j < slots.length; j++) {
                            var slotDays = [];
                            for (var k = 0; k < slots[j].slotTimes.length; k++) {
                                var s = slots[j].slotTimes[k];
                                var day = s.split(" ")[0].toUpperCase();
                                slotDays.push(day);
                            }
                            var dayOfWeek = new Date(noClassDays[i]).toLocaleDateString("en-US", { weekday: "short"}).toUpperCase();
                            if (slotDays.includes(dayOfWeek) && dates.indexOf(formattedDate) === -1) {
                                dates.push(formattedDate);
                            }
                        }
                    } else {
                        dates.push(formattedDate);
                    }
                }
            }
        }
        return dates;
    };
    
    function pluralize(value, singular, plural = null) {
        if (value === 1) return `${value} ${singular}`;
        return `${value} ${plural || singular + "s"}`;
    }

    function formatDurationInMonths(months) {
        if (months <= 14) return pluralize(months, "month");
        var years = Math.floor(months / 12);
        var remainingMonths = months % 12;
        var parts = [];
        if (years > 0) parts.push(pluralize(years, "year"));
        if (remainingMonths > 0) parts.push(pluralize(remainingMonths, "month"));
        return parts.join(" ");
    }

    function getGenders(limitGenders, includedGenderCodes) {
        var limitGenderCodes = (limitGenders || []).map(g => g.code);
        return Object.values(Gender).filter((gender) => {
            if (gender == Gender.Mixed) return false;
            if (includedGenderCodes && includedGenderCodes.includes(gender.code)) return true;
            return limitGenderCodes.length == 0 || limitGenderCodes.includes(gender.code);
        });
    };
    
    function isValidGender(gender, limitGenders) {
        var limitGenderCodes = (limitGenders || []).map((g) => g.code);
        return limitGenderCodes.length == 0 || limitGenderCodes.includes(gender.code || gender);
    }

    return {
        MODULE_CLASSMGMT: "classmgmt",
        EVENT_REGISTRATION_DATA_CHANGED: "class_registration_data_changed",
        transformToTimeZone: transformToTimeZone,
        transformTimeZoneToTimeZone: transformTimeZoneToTimeZone,
        transformClassTimezoneToLocal: transformClassTimezoneToLocal,
        getDaySuffix: getDaySuffix,
        toCurrency: toCurrency,
        showAlternativeCost: showAlternativeCost,
        isSameObject: isSameObject,
        WEEKDAYS_SHORT: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat",  "Sun"],
        registrationsTracking: registrationsTracking,
        CLASS_VISIBILITY: {0: "Not Logged In", 10: "Logged In", 20: "Granted Accounts Only"},
        CHARGE_TIME_TYPE: { REGISTRATION: "REGISTRATION", CLASS_START: "CLASS_START",
                            SPECIFIC_DATE: "SPECIFIC_DATE",
                            NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY: "NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY",
                            NEXT_CHARGE_DATE_AFTER_FIRST_CLASS_DAY: "NEXT_CHARGE_DATE_AFTER_FIRST_CLASS_DAY",
                            CLASS_END: "CLASS_END"},
        DUE_TIME_TYPE: { SYSTEM_DEFAULT: "SYSTEM_DEFAULT", REGISTRATION: "REGISTRATION", CLASS_END: "CLASS_END", SPECIFIC_DATE: "SPECIFIC_DATE", DAY_DIFF: "DAY_DIFF"},
        PAYMENT_SCHEDULE_TYPE: { MANUAL: "MANUAL", RECURRING: "RECURRING", RATE_PLAN: "RATE_PLAN", INSTALLMENT_PLAN: "INSTALLMENT_PLAN"},
        PAYMENT_RECURRING_MODE: { MONTHLY: "MONTHLY", WEEKLY: "WEEKLY", EVERY_FIXED_PERIOD: "EVERY_FIXED_PERIOD"},
        PRORATION_MODE: {SESSION: "SESSION", CYCLE: "CYCLE", FORCE_FULL_CYCLE: "FORCE_FULL_CYCLE"},
        INSTALLMENT_MODE: { FLAT_RATE: "FLAT_RATE", PERCENTAGE: "PERCENTAGE" },
        PAYMENT_AUTHORIZED_STATUS: {PENDING: {key:1, name: "Pending", msg: "Payment is awaiting authorization"},
                                    APPROVED: {key: 2, name: "", msg: ""},
                                    REJECTED:  {key: 3, name: "Rejected", msg: "Payment authorization was rejected"}},
        compareDateValue: compareDateValue,
        compareDateTimeValue: compareDateTimeValue,
        isEmpty: isEmpty,
        isIOSDevice: isIOSDevice,
        ATTENDANCE_RANGE_OPTIONS: [{key: "today", title: "Today"},
                                  {key: "next7days", title: "Next 7 days"},
                                  {key: "next30days", title: "Next 30 days"},
                                  {key: "thismonth", title: "This month"},
                                  {key: "lastmonth", title: "Last month"},
                                  {key: "fullclass", title: "Full Class"}],
        round: round,
        getClassStartTime: getClassStartTime,
        getAreementEmailContentTemaplate: getAreementEmailContentTemaplate,
        getGenderByType: getGenderByType,
        getGenderByCode: getGenderByCode,
        getGender: getGender,
        getGenders: getGenders,
        isValidGender: isValidGender,
        isMyInstructorAssigned: isMyInstructorAssigned,
        getNoClassDaysInRange: getNoClassDaysInRange,
        getNoClassDaysInRangeWithSlots: getNoClassDaysInRangeWithSlots,
        pluralize: pluralize,
        formatDurationInMonths: formatDurationInMonths,
    }
})();
/*if(window.$ && $.fn && $.fn.modal) {
    $.fn.modal.Constructor.prototype.enforceFocus = function () {
        $(document)
        .off('focusin.bs.modal')
        .on('focusin.bs.modal', $.proxy(function (e) {
            if(Dom.findParentWithClass(e.target, "DialogFrame")) return;
            if (this.$element[0] !== e.target && !this.$element.has(e.target).length) {
                this.$element.trigger('focus');
            }
        }, this));
    };
}*/


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/ClassAuthUtils.js";

var ClassAuthUtils = (function () {
    return {
        canViewClassAdminList: function (accountInfo) {
            return PermissionSetUtils.isSatisfied(PERMISSION_SET_KEY.Class_AdminList_Access, accountInfo);
        },
        canViewAssignInstructor: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassInstructor_ViewAssign);
        },
        canViewAtLeastReports: function (accountInfo) {
            return PermissionSetUtils.isSatisfied(PERMISSION_SET_KEY.Class_Report_Access);
        },
        canViewClassSettings: function (accountInfo) {
            return PermissionUtils.isAccountWithAnyPermission(accountInfo,
                        PERMISSION_KEY.Class_ClassSetting_ViewGeneralSetting,
                        PERMISSION_KEY.Class_ClassSetting_ManageWithoutGeneralSetting
                    );
        },
        canViewAllReports: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassReport_ViewAll);
        },
        canViewHeatMapReport: function (accountInfo) {
            return PermissionUtils.isAccountWithAnyPermission(accountInfo,
                        PERMISSION_KEY.Class_ClassReport_ViewAll,
                        PERMISSION_KEY.Class_ClassReport_ViewHeatMapReport
                    );
        },
        canViewInstructorReport: function (accountInfo) {
            return PermissionUtils.isAccountWithAnyPermission(accountInfo,
                        PERMISSION_KEY.Class_ClassReport_ViewAll,
                        PERMISSION_KEY.Class_ClassReport_ViewInstrutorReport
                    );
        },
        canViewGeneralSettings: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassSetting_ViewGeneralSetting);
        },
        canUpdateGeneralSettings: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassSetting_UpdateGeneralSetting);
        },
        canUpdateClassMetaOrders: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassSetting_ManageWithoutGeneralSetting);
        },
        canManageWithoutGeneralSetting: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassSetting_ManageWithoutGeneralSetting);
        },
        canCreateEditDeleteClass: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_Class_CreateEditDeleteAll);
        },
        canAddRegistrationForMember: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_Class_AddRegistrationForMember);
        },
        canEmailSMSPushAccountMember: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.AMA_AccountMember_EmailSMSPush);
        },
        canAddNewAccountMember: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.AMA_AccountMember_CreateEditDelete);
        },
        canViewClassAttendance: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassAttendance_ViewAll);
        },
        canManageClassCostumes: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassCostume_ManageAll);
        },
        canViewAllClassMemberSizes: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassMemberSizing_ViewAll);
        },
        canViewClassSizes: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassMemberSizing_View);
        },
        canViewAMAMemberSizes: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MemberSizing_View);
        },
        canPostCostumeCharges: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Costume_CostumeChange_HandlePosting, PERMISSION_KEY.Finance_Charge_Create);
        },
        canUpdateMemberSizingInfo: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MemberSizing_UpdateInfo);
        },
        canUpdateMemberSizingStatus: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MemberSizing_UpdateInfoStatus);
        },
        canMoveReenrollClass: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassRegistration_MoveReenroll);
        },
        canDenyWaitlistCancelRegsitration: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassRegistration_DenyCancel);
        },
        canChangeSlotPaymentPlanStartDropDate: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassRegistration_ChangeSlotPaymentPlanStartDropDate);
        },
        canViewBilling: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Finance_AccountBillingSummary_View);
        },
        canApproveWaitlistRegistration: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassRegistration_ApproveWaitlist);
        },
        canViewAccountMemberDetail: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.AMA_AccountMember_ViewStandardInfo);
        },
        canViewLimitBasicAccountMemberInfo: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.AMA_AccountMember_ViewLimitBasicInfo);
        },
        canEditAccountMemberAnnualRegFee: function (accountInfo, editedAccountId) {
            var loginInfo = accountInfo || PermissionUtils.getCurrentLoginAccountInfo();
            if (!loginInfo) return false;
            var loginAccountId = loginInfo.accountId || loginInfo.id;
            return PermissionSetUtils.isSatisfied(PERMISSION_SET_KEY.AMA_AnnualRegistrationFee_ManageAllAccounts, loginInfo)
                || PermissionSetUtils.isSatisfied(PERMISSION_SET_KEY.AMA_MyAnnualRegistrationFee_Manage, loginInfo) && (loginAccountId == editedAccountId);
        },
        canTakeAttendanceSkill: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassAttendance_TakeAttendanceSkill);
        },
        isAffiliationFeatureEnabled: function(featureName) {
            if (TEAM_INFO && TEAM_INFO.enabledAffiliationFeatures && TEAM_INFO.enabledAffiliationFeatures.indexOf(featureName) >= 0) return true;
            return false;
        },
        canViewCreateEditProgram: function (accountInfo) {
            if (ClassAuthUtils.isAffiliationFeatureEnabled("CLASS")) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.SharedSettings_Program_ViewCreateEdit);
        },
        canManageProgram: function (accountInfo) {
            if (ClassAuthUtils.isAffiliationFeatureEnabled("CLASS")) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.SharedSettings_Program_ManageAll);
        },
        canViewCreateEditSubProgram: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_SubProgram_ViewCreateEdit);
        },
        canManageSubProgram: function (accountInfo) {
            if (ClassAuthUtils.isAffiliationFeatureEnabled("CLASS")) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_SubProgram_ManageAll);
        },
        canViewCreateEditSession: function (accountInfo) {
            if (ClassAuthUtils.isAffiliationFeatureEnabled("CLASS")) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_Session_ViewCreateEdit);
        },
        canManageSession: function (accountInfo) {
            if (ClassAuthUtils.isAffiliationFeatureEnabled("CLASS")) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_Session_ManageAll);
        },
        canViewCreateEditCoupon: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_Coupon_ViewCreateEdit);
        },
        canManageCoupon: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_Coupon_ManageAll);
        },
        canSendAgreementReviewReminder: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.OrgTool_Agreement_SendEditAgreementReviewReminder);
        },
        canExportClassRegistrations: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassRegistration_Export);
        },
        canManageMyInstructorClass: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClass_ManageClass);
        },
        canViewMyInstructorClassGeneralInfo: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClassGeneralInfo_View);
        },
        canManageMyInstructorClassSchedule: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClassSchedule_Manage);
        },
        canViewMyInstructorClassPaymentInfo: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClassPaymentInfo_View);
        },
        canViewClassRegistration: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassRegistration_View);
        },        
        canExportMyInstructorClassRegistration: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClassRegistration_Export);
        },
        canViewClassMyInstructorClassRegistration: function (accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClassRegistration_View);
        },
        canSubstituteInstructor: function (accountInfo, instructorId) {
            return this.canCreateEditDeleteClass(accountInfo) || (this.canManageMyInstructorClass(accountInfo) && accountInfo.id == instructorId);
        },
        onlyEmailSMSPushMyInstructorClassAccountMember: function(accountInfo) {
            if (this.canEmailSMSPushAccountMember()) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClassAccountMember_EmailSMSPush);
        },
        canOpenClassDetail: function (accountInfo, instructorIds) {
            return this.canCreateEditDeleteClass(accountInfo) || (this.canManageMyInstructorClass(accountInfo) && instructorIds && instructorIds.includes(accountInfo.id));
        },
        canViewAnnualRegistration: function(accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.AMA_AnnualRegistrationFee_ManageAll);
        },
        isAbleToPrintAllAttendanceReport: function(accountInfo) {
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_ClassAttendance_ViewAll);
        },
        isAbleToPrintAttendanceReportOfMyInstructorClass: function(accountInfo) {
            return ClassAuthUtils.onlyViewClassAttendanceOfMyInstructorClass();
        },
        onlyViewRegistrationReportOfMyLocationClass: function(accountInfo) {
            if (ClassAuthUtils.canViewAllReports()) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyLocationClassReport_ViewRegistrationReport);
        },
        onlyViewInstructorReportOfMyInstructorClass: function(accountInfo) {
            if (ClassAuthUtils.canViewInstructorReport()) return false;
            return PermissionUtils.isAccountWithAllPermissions(accountInfo, PERMISSION_KEY.Class_MyInstructorClassReport_ViewInstructorReport);
        },
        onlyViewClassAttendanceOfMyInstructorClass: function(accountInfo) {
            if (ClassAuthUtils.canViewClassAttendance()) return false;
            return PermissionUtils.isAccountWithAnyPermission(accountInfo, PERMISSION_KEY.Class_MyInstructorClassAttendance_ViewLimit);
        },
        onlyViewAccountMemberClassAtMyLocations: function(accountInfo) {
            if (PermissionUtils.isAccountWithAnyPermission(accountInfo, PERMISSION_KEY.Class_ClassAccountMember_View)) return false;
            return PermissionUtils.isAccountWithAnyPermission(accountInfo, PERMISSION_KEY.Class_MyLocationClassAccountMember_ViewLimit);
        },
        canViewClassRegistrationFinancialInfo: function (accountInfo) {
            return PermissionUtils.isAccountWithAnyPermission(accountInfo, PERMISSION_KEY.Class_ClassRegistrationFinancialInfo_View);
        },
        canViewAccountBalanceOfAttendance: function (accountInfo) {
            return ClassAuthUtils.canTakeAttendanceSkill(accountInfo)
                    || PermissionUtils.isAccountWithAnyPermission(accountInfo, PERMISSION_KEY.Finance_AccountBillingSummary_View);
        },
        canEditAttendanceNotes: function (accountInfo) {
            return ClassAuthUtils.canManageMyInstructorClass(accountInfo)
                    || PermissionUtils.isAccountWithAnyPermission(accountInfo, PERMISSION_KEY.Class_ClassSetting_ManageWithoutGeneralSetting);
        },
        canManageAnnualKitDates: function (accountInfo) {
            return PermissionUtils.isAccountWithAnyPermission(accountInfo, PERMISSION_KEY.AMA_AnnualKit_ManageAll);
        },
        canTakeAttendance: function (accountInfo) {
            return PermissionUtils.isAccountWithAnyPermission(accountInfo,
                        PERMISSION_KEY.Class_ClassAttendance_TakeAttendanceSkill,
                        PERMISSION_KEY.Class_MyInstructorClass_TakeAttendance
                    );
        },
        canUpdateCalendarNote: function (accountInfo) {
            return PermissionUtils.isAccountWithAnyPermission(accountInfo,PERMISSION_KEY.CalEvent_NoteSetting_Update);
        }
    }
})();


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/AnnualFeesSettingWidget.js";

function AnnualFeesSettingWidget() {
    BaseTemplatedWidget.call(this);
    this.modified = false;

    var comparer = function (a, b) {
        return a.id === b.id;
    };
    var renderer = function (data) {
        return data.name;
    };

    this.selectFamilyChartOfAccount.comparer = comparer;
    this.selectFamilyChartOfAccount.renderer = renderer;

    this.selectStudentChartOfAccount.comparer = comparer;
    this.selectStudentChartOfAccount.renderer = renderer;

    this.feeCalculationCombo.renderer = function (data) {
        return data.desc;
    };

    var dataChangeHandler = function(event) {
        if (typeof(event.fromUser) != "undefined") {
            if (!event.fromUser) return;
        }
        
        if (this._snapshotInputValues === null) {
            this.showUnsavedNotify();
            return;
        }
        this._validateInputValues();
    };

    var names = AnnualFeesSettingWidget.ALL_CHANGED_EVENTS;
    for (var i = 0; i < names.length; i ++) {
        this.bind(names[i], dataChangeHandler, this.node());
    }

    this.bind("change", this.validateSubformData.bind(this), this.ckbFamilyAnnualRegistration);
    this.bind("change", this.validateSubformData.bind(this), this.ckbStudentAnnualRegistration);
    this.bind("click", this.saveSettingHandler.bind(this), this.saveButton);
    this.bind("click", this.performCancel.bind(this), this.resetButton);
}

__extend(BaseTemplatedWidget, AnnualFeesSettingWidget);

AnnualFeesSettingWidget.ALL_CHANGED_EVENTS = ["p:ItemSelected", "change", "input"];

AnnualFeesSettingWidget.prototype.onAttached = function (firstAttached) {
    if (!firstAttached) return;

    this.fetchSettingInfo();
};

AnnualFeesSettingWidget.prototype.fetchSettingInfo = function (callback) {
    var thiz = this;
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        thiz.annualCalculatingOptions = cm.ModuleData.ANNUAL_CALCULATING_OPTIONS;
        thiz.feeCalculationCombo.setItems(thiz.annualCalculatingOptions);

        $classMetaService.getAnnualCalculationSetting(function (annualSetting) {
            thiz.annualSetting = annualSetting;

            $classAdminService.getAdminSetting(function (adminSetting) {
                thiz.adminSetting = adminSetting;
                thiz.coaSettingList = adminSetting.coaSettingList.filter(item => !item.hidden);
                
                thiz.selectFamilyChartOfAccount.setItems(thiz.coaSettingList);
                thiz.selectStudentChartOfAccount.setItems(thiz.coaSettingList);
    
                thiz.setupView();
                callback && callback();
            }, function (error) {
                Dialog.error(error.message);
            }, "Loading...");
        }, function (e) {
            Dialog.error(e.message);
        });
    });
};

AnnualFeesSettingWidget.prototype.setupView = function () {
    this.populateSettingsInfo();
    this.clearUnsavedNotify();
    this.setSnapshotInputValues(this.getCurrentSettingInfo());
    this.invalidateUIByPermissions();
};

AnnualFeesSettingWidget.prototype.invalidateUIByPermissions = function () {
    Dom.toggleClass(this.container, "ViewOnly", !ClassAuthUtils.canUpdateGeneralSettings(LOGIN_INFO));
    Dom.toggleClass(this.footerPane, "Inapplicable", !ClassAuthUtils.canUpdateGeneralSettings(LOGIN_INFO));
};

AnnualFeesSettingWidget.prototype.populateSettingsInfo = function () {
    var thiz = this;
    this.feeCalculationCombo.selectItemById(this.annualCalculatingOptions.find((item) => item.name == (this.annualSetting?.annualFeeCalculatingOption || "EVERY_12_MONTHS")).id);
    Dom.doOnSelector(this.node(), "input[type='radio'][name='FeeDateCalculationType']", (input) => {
        if (input.value == (thiz.annualSetting?.annualFeeBasedDateOption || "REGISTRATION_DATE")) {
            input.checked = true;
        } else {
            input.checked = false;
        }
    });

    if (this.adminSetting) {
        if (this.adminSetting.familyAnnualCoAId > 0 && this.checkExistsCoA(this.coaSettingList, this.adminSetting.familyAnnualCoAId)) {
            this.ckbFamilyAnnualRegistration.checked = true;
            Dom.emitEvent("change", this.ckbFamilyAnnualRegistration);
            this.itemFamilyAnnualFeeAmount.setValue(this.adminSetting.familyAnnualFeeAmount);
            this.selectFamilyChartOfAccount.selectItemIfContains({id: this.adminSetting.familyAnnualCoAId});
        } else {
            this.ckbFamilyAnnualRegistration.checked = false;
            Dom.emitEvent("change", this.ckbFamilyAnnualRegistration);
        }

        if (this.adminSetting.studentAnnualCoAId > 0 && this.checkExistsCoA(this.coaSettingList, this.adminSetting.studentAnnualCoAId)) {
            this.ckbStudentAnnualRegistration.checked = true;
            Dom.emitEvent("change", this.ckbStudentAnnualRegistration);
            this.itemStudentAnnualFeeAmount.setValue(this.adminSetting.studentAnnualFeeAmount);
            this.selectStudentChartOfAccount.selectItemIfContains({id: this.adminSetting.studentAnnualCoAId});
        } else {
            this.ckbStudentAnnualRegistration.checked = false;
            Dom.emitEvent("change", this.ckbStudentAnnualRegistration);
        }

        if (LOGIN_INFO.allowClassPaymentPlan) {
            this.ckbApplyMultiAthleteDiscount.checked = this.adminSetting.studentAnnualFeeMultiDiscEnable;
        } else {
            Dom.addClass(this.applyMultiAthleteDiscountWrapper, "Inapplicable");
        }
    }

    Dom.doOnSelector(this.container, ".AnnualKitEntry", (item) => {
        Dom.toggleClass(item, "Disabled", TEAM_INFO && TEAM_INFO.isAffiliateTeam && this.annualSetting && this.annualSetting.annualFeeSettingShared);
    });
};

AnnualFeesSettingWidget.prototype.getCurrentSettingInfo = function () {
    var data = {
        annualFeeCalculatingOption: this.feeCalculationCombo.getSelectedItem().name,
        annualFeeBasedDateOption: this.feeRegistrationOption.checked ? "REGISTRATION_DATE" : "CLASS_START_DATE"
    };

    if (this.ckbFamilyAnnualRegistration.checked && this.selectFamilyChartOfAccount.getSelectedItem().id > 0) {
        data.familyAnnualFeeAmount = this.itemFamilyAnnualFeeAmount.getValue();
        data.familyAnnualCoAId = this.selectFamilyChartOfAccount.getSelectedItem().id;
    }
    if (this.ckbStudentAnnualRegistration.checked && this.selectStudentChartOfAccount.getSelectedItem().id > 0) {
        data.studentAnnualFeeAmount = this.itemStudentAnnualFeeAmount.getValue();
        data.studentAnnualCoAId = this.selectStudentChartOfAccount.getSelectedItem().id;
    }

    if (LOGIN_INFO.allowClassPaymentPlan) {
        data.studentAnnualFeeMultiDiscEnable = this.ckbApplyMultiAthleteDiscount.checked;
    } else {
        data.studentAnnualFeeMultiDiscEnable = false;
    }

    return data;
};

AnnualFeesSettingWidget.prototype.getValidationRuleSet = function () {
    var ruleSet = new RuleSet().live(true)
        .required(this.itemFamilyAnnualFeeAmount, "Please input Fee amount", Condition.checked(this.ckbFamilyAnnualRegistration))
        .required(this.itemStudentAnnualFeeAmount, "Please input Fee amount", Condition.checked(this.ckbStudentAnnualRegistration));
    
    return ruleSet;    
};

AnnualFeesSettingWidget.prototype.saveSettingHandler = function () {
    if (!ValidationManager.run(this.getValidationRuleSet())) return;
    var setting = this.getCurrentSettingInfo();

    $classAdminService.saveAnnualFeeSetting(setting, function () {
        this.fetchSettingInfo(function () {
            SnackBar.show("All changes has been saved!");
        });
    }.bind(this), function (e) {
        Dialog.error(e.message);
    }, "Saving...");
};

AnnualFeesSettingWidget.prototype.validateSubformData = function (event) {
    var targetName = Dom.getAttributeAsString(event.target, "toggle-target");
    Dom.toggleClass(this[targetName], "Inapplicable", !event.target.checked)
};

AnnualFeesSettingWidget.prototype.checkExistsCoA = function (coaSettingList, coaId) {
    for (var i = 0; i < coaSettingList.length; i++) {
        if (coaSettingList[i].id == coaId) {
            return true;
        }
    }
    return false;
};

AnnualFeesSettingWidget.prototype.showUnsavedNotify = function () {
    this.resetButton.removeAttribute("disabled");
    this.saveButton.removeAttribute("disabled");
    Dom.setInnerText(this.footerStatus, "Unsaved Changes");
    Dom.addClass(this.footerStatus, "Danger");
};

AnnualFeesSettingWidget.prototype.clearUnsavedNotify = function () {
    this.resetButton.setAttribute("disabled", true);
    this.saveButton.setAttribute("disabled", true);
    Dom.setInnerText(this.footerStatus, "Unmodified");
    Dom.removeClass(this.footerStatus, "Danger");
};

AnnualFeesSettingWidget.prototype.setSnapshotInputValues = function (values) {
    if(values && typeof (values) == "object") {
        this._snapshotInputValues = JSON.parse(JSON.stringify(values));
    } else {
        this._snapshotInputValues = values;
    }
};

AnnualFeesSettingWidget.prototype._validateInputValues = function () {
    var curValues = this.getCurrentSettingInfo() || {};
    var snapshotValues = this._snapshotInputValues || {};
    
    if (JSON.stringify(snapshotValues) !== JSON.stringify(curValues)) {
        this.modified = true;
        this.showUnsavedNotify();
    } else {
        this.modified = false;
        this.clearUnsavedNotify();
    }
};

AnnualFeesSettingWidget.prototype.performCancel = function() {
    var thiz = this;
    if (!this.modified) return;
    Dialog.confirm("Discard changes?", "Are you sure you want to discard the unsaved changes?", "Discard changes", function () {
        thiz.fetchSettingInfo(function () {
            ValidationManager.run(thiz.getValidationRuleSet());
        });
    }, "Cancel");
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassAdminWidget.js";

function ClassAdminWidget() {
    window.TEAM_INFO = window.TEAM_INFO || {};
    window.LOGIN_INFO = window.LOGIN_INFO || {};
    window.LOGIN_INFO.isClassSetupDone = false
    BaseTemplatedWidget.call(this);
    var thiz = this;

    thiz._selfScrollManaged = true;

    thiz.tabToChange = "ClassesTabPane";

    this.DEFAULT_TAB_RENDERERS = {
        "ClassesTabPane": function(thiz){
            thiz.classesTabPaneContent.innerHTML = "";
            return new ClassListWidget().into(thiz.classesTabPaneContent);
        },
        "PaymentPlansTabPane": function(thiz){
            thiz.paymentPlansTabPaneContent.innerHTML = "";
            return new PaymentPlansAdminWidget().into(thiz.paymentPlansTabPaneContent);
        },
        "InstructorsTabPane": function(thiz){
            thiz.instructorsTabPaneContent.innerHTML = "";
            return new InstructorsManagementWidget().into(thiz.instructorsTabPaneContent);
        },
        "StudentTabPane": function(thiz) {
            thiz.studentTabPaneContent.innerHTML = "";
            return new LegacyIframeWidget({reportType: "student", showExpandAction: true}).into(thiz.studentTabPaneContent);
        },
        "SettingsTabPane": function(thiz){
            thiz.classesTabSettingContent.innerHTML = "";
            var classSettingWidget = new ClassSettingWidget().into(thiz.classesTabSettingContent);
            thiz.classesTabSettingContent.parentNode.__widget = classSettingWidget.membershipTabPane;
            return classSettingWidget;
        },
        "ReportsTabPane": function(thiz){
            thiz.reportsTabContent.innerHTML = "";
            var height = thiz.node().offsetHeight - 80;
            thiz.reportsTabContent.style.height = height + "px";
            return new ReportsWidget().into(thiz.reportsTabContent);
        }
    };
    
    var registerTabNavigationModule = (tabName) => {
        var tab = this.tabPane.findTabByName(tabName);
        if (tab) {
            tab.getNavigationModuleAsync = function (callback) {
                (function check() {
                    if (thiz._initialized) {
                        callback(tab.__tabWidget && tab.__tabWidget.getNavigationModule && tab.__tabWidget.getNavigationModule() || tab[TabPane.KEY_NAVIGATION_MODULE]);
                    } else {
                        setTimeout(check, 200);
                    }
                })();
            };
        }
    }
    registerTabNavigationModule("reports");
    registerTabNavigationModule("settings");

    this.TAB_RENDERERS = {};//this.DEFAULT_TAB_RENDERERS;
    thiz.bind("e:TabChange", function() {
        var thiz = this;
        if (!thiz._initialized) return;
        thiz.renderActiveTabPane();
    }, thiz.tabPane.node());
}
__extend(BaseTemplatedWidget, ClassAdminWidget);
ClassAdminWidget.prototype.setupGlobalInfo = function (info) {
    ClassAdminWidget._setupGlobalInfo(info, this);
};
ClassAdminWidget._setupGlobalInfo = function (info, thiz) {
    thiz.isFinishedSetup = true;
    ClassAdminWidget._setupGlobalInfoPublic(info);
};

ClassAdminWidget._setupGlobalInfoPublic = function (info, thiz) {
    window.TEAM_ALIAS = info.teamAlias;


    window.TEAM_INFO.id = info.teamId;
    window.TEAM_INFO.alias = info.teamAlias;
    window.TEAM_INFO.name = info.teamName;


    window.LOGIN_INFO.accountId = info.accountId;
    window.LOGIN_INFO.permissionKeys = info.permissionKeys;

    window.LOGIN_INFO.isClassInstructor = info.isClassInstructor;
    window.LOGIN_INFO.isClassSetupDone = true;
    window.LOGIN_INFO.allowClassToolAddNewRegistrations = info.allowClassToolAddNewRegistrations;
    window.LOGIN_INFO.allowClassPaymentPlan = info.allowClassPaymentPlan;
    window.LOGIN_INFO.allowAutoWaitlist = info.allowAutoWaitlist;
    window.LOGIN_INFO.allowStartDropDates = info.allowStartDropDates;
    window.LOGIN_INFO.allowWaiver = info.allowWaiver;
    window.LOGIN_INFO.discountApplicationTypes = info.discountApplicationTypes;
    window.LOGIN_INFO.discountOrderTypes = info.discountOrderTypes;
    window.LOGIN_INFO.classRegistrationLink = info.classRegistrationLink;
    window.LOGIN_INFO.classRegShoppingLink = info.classRegShoppingLink;
    window.LOGIN_INFO.myAccountAgreementLink = info.myAccountAgreementLink;
    window.LOGIN_INFO.allowCheck = info.allowCheck;
    window.LOGIN_INFO.allowRatePlan = info.allowRatePlan;
    window.LOGIN_INFO.allowDressCode = info.allowDressCode;
    window.LOCALE = window.LOCALE || {};
    window.LOCALE.CURRENCY = info.currency;
    window.LOCALE.WEEKDAYS_SHORT = info.shortWeekdays;
    window.LOGIN_INFO.isAbleTakeAttendance = info.isAbleTakeAttendance;
    window.LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass = info.isAbleTakeAttendanceOnMyInstructorClass;
    window.LOGIN_INFO.isAbleTakeSkill = info.isAbleTakeSkill;
    window.LOGIN_INFO.allowCostume = info.allowCostume;
    window.LOGIN_INFO.costumeModuleName = info.costumeModuleName;
    
    window.LOGIN_INFO.enableGroupAttendanceNote = info.enableGroupAttendanceNote;
    window.LOGIN_INFO.enableClassRooomAttendanceNote = info.enableClassRooomAttendanceNote;
    window.LOGIN_INFO.classRoomAttendanceNoteLabel = info.classRoomAttendanceNoteLabel;    
};
ClassAdminWidget.prototype.onAttached = function() {
    var thiz = this;
    Dom.addClass(this.containerWrapper, "Pending");
    window.setTimeout(function(){
        thiz.onAttachedDelayed();
    }, 200)

};

ClassAdminWidget.prototype.canViewClassAdminList = function(accountInfo) {
    return ClassAuthUtils.canViewClassAdminList(accountInfo);
}

ClassAdminWidget.prototype.onAttachedDelayed = function() {
    var thiz = this;
    $classAdminService.getAccountInfo(function(res) {
        Dom.removeClass(thiz.containerWrapper, "Pending");
        thiz.setupGlobalInfo(res);
        var tabKeys = [];
        if (thiz.canViewClassAdminList(LOGIN_INFO)) {
            thiz.TAB_RENDERERS["ClassesTabPane"] = thiz.DEFAULT_TAB_RENDERERS["ClassesTabPane"];
            tabKeys.push("classes");
        }
        if (window.LOGIN_INFO.allowClassPaymentPlan) {
            thiz.TAB_RENDERERS["PaymentPlansTabPane"] = thiz.DEFAULT_TAB_RENDERERS["PaymentPlansTabPane"];
            tabKeys.push("paymentPlans");
        }
        if (ClassAuthUtils.canViewAllReports(LOGIN_INFO) && !window.LOGIN_INFO.allowClassPaymentPlan) {
            thiz.TAB_RENDERERS["StudentTabPane"] = thiz.DEFAULT_TAB_RENDERERS["StudentTabPane"];
            tabKeys.push("students");
        }
        if (ClassAuthUtils.canViewAssignInstructor(LOGIN_INFO)) {
            thiz.TAB_RENDERERS["InstructorsTabPane"] = thiz.DEFAULT_TAB_RENDERERS["InstructorsTabPane"];
            tabKeys.push("instructors");
        }

        if (ClassAuthUtils.canViewAtLeastReports(LOGIN_INFO)) {
            thiz.TAB_RENDERERS["ReportsTabPane"] = thiz.DEFAULT_TAB_RENDERERS["ReportsTabPane"];
            tabKeys.push("reports");
        }
        if (ClassAuthUtils.canViewClassSettings(LOGIN_INFO)) {
            thiz.TAB_RENDERERS["SettingsTabPane"] = thiz.DEFAULT_TAB_RENDERERS["SettingsTabPane"];
            tabKeys.push("settings");
        }
        // var tabName = thiz.getTabFromHash();
        // var hasTab = false;
        // for(var t in thiz.TAB_RENDERERS) {
        //     if (t == tabName) {
        //         hasTab = true;
        //         break;
        //     }
        // }
        // hasTab || (tabName = "ClassesTabPane");
        // var tabs = thiz.tabPane.getTabs();
        // for(var i = 0; i++; i < tabs.length) {
        //     var tab = tabs[i];
        //     if (tab.contentNode.className.indexOf(tabName) >= 0) {
        //         thiz.tabPane.activeTab(tab);
        //         break;
        //     }
        // }
        
        if (!ClassAuthUtils.canViewAtLeastReports(LOGIN_INFO)) {
            var studenTab = thiz.tabPane.getTabs()[1];
            if(studenTab) thiz.tabPane._removeTabByHeader(studenTab.header);
        }
        if (window.LOGIN_INFO.allowCostume) {
            widget.__ensureNamespaceLoaded("costume", function (ns) {});
        }
        var i = 0;
        while (i < thiz.tabPane.getTabs().length) {
            var t = thiz.tabPane.getTabs()[i];
            var k = t.header.getAttribute("tab-key");
            if(tabKeys.indexOf(k) == -1) {
                thiz.tabPane.removeTabByContentNode(t.contentNode);
                continue;
            }
            i++;

        }

        if (typeof(AdminConsole) == "undefined" || !thiz.findUpward(AdminConsole)) {
            CommonNavigation.setRoot(thiz.tabPane.getNavigationModule());
        }
        
        thiz.renderActiveTabPane();
        thiz._initialized = true;

    }, function(err) {}, "Loading...");

};

ClassAdminWidget.prototype.renderActiveTabPane = function() {
    var activeTab = this.tabPane.getActiveTabPane();
    if(!activeTab) return;
    for(var tab in this.DEFAULT_TAB_RENDERERS){
        if (Dom.hasClass(activeTab, tab) && this.TAB_RENDERERS[tab]){
            this.tabToChange = tab;
            this.moveToTab(tab, activeTab);
            return;
        }
    }
};

ClassAdminWidget.prototype.moveToTab = function(tab, activeTab){
    if (!tab || !this.DEFAULT_TAB_RENDERERS[tab]) tab = "ClassesTabPane";
    if (!this.TAB_RENDERERS[tab]) {
        tab = Object.keys(this.TAB_RENDERERS)[0];
    }
    var f = this.DEFAULT_TAB_RENDERERS[tab];
    var widget = f(this);
    if (widget.getNavigationModule) {
        activeTab[TabPane.KEY_NAVIGATION_MODULE] = widget.getNavigationModule();
    }
    activeTab.__tabWidget = widget;
    
};

// ClassAdminWidget.prototype.getTabFromHash = function(){
//     var h = window.location.hash;
//     if(!h) return "";
//     h = h.replace("#", "").replace("/", "") + "TabPane";
//     return h;
// };
//
// ClassAdminWidget.prototype.getHashFromTab = function(tab){
//     return "/" + tab.replace("TabPane", "");
// };

ClassAdminWidget.prototype.getNavigationModule = function () {
    return this.tabPane.getNavigationModule();
};

ClassAdminWidget._ensureConfiguration = function (callback) {
    if (ClassAdminWidget._configurationLoaded) {
        callback();
        return;
    }
    $classAdminService.getAccountInfo(function(res) {
        ClassAdminWidget._setupGlobalInfo(res);
        callback();
    });
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditDateTimeTab.js";

function ClassEditDateTimeTab(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
    this.classInfo = options.data;
    var thiz = this;
    this.timeZoneCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.fullName;
    };
    this.changedFields = [];
    this.comparators = {};
    this.CUSTOM_COMPARATOR_KEYS = ["dateStart", "dateEnd", "date4See", "date4Register", "date4RegisterEnd", "date4Return", "date4ReturnEnd", "date4New", "date4NewEnd"];

    this.policyCombo.useHtml = true;
    this.policyCombo.setPopupClass("PolicyComboPopup");
    this.policyCombo.renderer = function (item) {
        if(!item) return "&nbsp;";
        return "<strong>" + item.name + "</strong>";
    };
    
    this.noClassScheduleCombo.useHtml = true;
    this.noClassScheduleCombo.setPopupClass("ScheduleComboPopup");
    this.noClassScheduleCombo.renderer = function (item) {
        if(!item) return "&nbsp;";
        return "<strong>" + item.scheduleName + "</strong>";
    };
    this.noClassScheduleCombo.comparer = function(selected, item) {
        return selected.id == item.id;
    };

    this.bind("p:ItemSelected", this.policyComboChangedHandler, this.policyCombo);
    this.bind("click", this.newPolicyButtonClickHandler, this.newPolicyButton);
    this.bind("click", this.editPolicyButtonClickHandler, this.editPolicyButton);

    this.bind("change", this.policySettingChangedHandler, this.policySetting);
    this.bind("p:ItemSelected", this.timeZoneComboChangedHandler, this.timeZoneCombo);
    this.bind("p:ValueUpdated", function () {
        Dom.emitEvent(ClassEditDialog.START_END_DATE_UPDATED, thiz.node(),
            {selectedDate: thiz.classStartDate.getDate(), fieldName: "classStartDate"});
        Dom.emitEvent(ClassEditDialog.CLASS_DATE_TIME_INFO_UPDATED, thiz.node(),{});
            
    }, this.classStartDate);
    this.bind("p:ValueUpdated", function () {
        Dom.emitEvent(ClassEditDialog.START_END_DATE_UPDATED, thiz.node(),
            {selectedDate: thiz.classEndDate.getDate(), fieldName: "classEndDate"});
        Dom.emitEvent(ClassEditDialog.CLASS_DATE_TIME_INFO_UPDATED, thiz.node(),{});
    }, this.classEndDate);
    this.bind("p:ValueUpdated", function () {
        Dom.emitEvent(ClassEditDialog.START_END_DATE_UPDATED, thiz.node(),
            {selectedDate: thiz.registrationStartDate.getDate(), fieldName: "registrationStartDate"});
    }, this.registrationStartDate);
    
    this.bind("input", function () {
        Dom.emitEvent(ClassEditDialog.CLASS_DATE_TIME_INFO_UPDATED, thiz.node(),{});
    }, this.classLength);
    
    this.bind("p:ItemSelected", this.scheduleComboChangedHandler, this.noClassScheduleCombo);
    this.bind("click", this.newScheduleButtonClickHandler, this.newSchedule);
    this.bind("click", this.editScheduleButtonClickHandler, this.editSchedule);
}
__extend(BaseTemplatedWidget, ClassEditDateTimeTab);

ClassEditDateTimeTab.prototype.onAttached = function (firstTime) {
    if (!firstTime) return;
    var thiz = this;
    this.startDropPoliciesObject = {};
    if (window.LOGIN_INFO.allowStartDropDates) {
        this.loaded = false;
        Dom.removeClass(this.policySetting, "Hidden");
    } else {
        Dom.addClass(this.policySetting, "Hidden");
    }
    this.renderDateTimeTab();
    this.validateUIWithPermission();
};

ClassEditDateTimeTab.prototype.renderDateTimeTab = function () {
    this.setDatePickerMinDate();
    if(!this.options) return;
    var filters = this.options.filters;
    var timeZones = filters.timeZones,
        localTimeZoneId = moment.tz.guess();
    if(!timeZones) timeZones = [];
    if(timeZones.indexOf(localTimeZoneId) == -1){
        timeZones.push(localTimeZoneId);
    }

    var zones = [];
    for(var i = 0; i < timeZones.length; i ++) {
        var momentZone = moment.tz(timeZones[i]);
        zones.push({
            id: timeZones[i],
            fullName: timeZones[i] + " (GMT" + momentZone.format("Z") + ")"
        });
    }

    var itemData = this.classInfo;
    if(!itemData) {
        this.timeZoneCombo.setItems(zones);
        if(filters.teamTimeZone){
            this.timeZoneCombo.selectItemByKey("id", filters.teamTimeZone);
        }
        this.loadExtraInfo();
        this.lastSelectedDataTimezoneId = this.timeZoneCombo.getSelectedItem().id;
        return;
    }
    this.backupDateTimeData(itemData);
    if(itemData.timezoneId && timeZones.indexOf(itemData.timezoneId) == -1){
        timeZones.push(itemData.timezoneId);
        var momentZone = moment.tz(itemData.timezoneId);
        zones.push({
            id: itemData.timezoneId,
            fullName: itemData.timezoneId + " (GMT" + momentZone.format("Z") + ")"
        });
    }
    this.timeZoneCombo.setItems(zones);
    this.timeZoneCombo.selectItemByKey("id", itemData.timezoneId);

    this.lastSelectedDataTimezoneId = itemData.timezoneId;
    if (!this.lastSelectedDataTimezoneId) {
        this.lastSelectedDataTimezoneId = this.timeZoneCombo.getSelectedItem().id;
    }

    this.classStartDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.dateStart, itemData.timezoneId));
    this.classEndDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.dateEnd, itemData.timezoneId));
    this.displayStarting.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.date4See, itemData.timezoneId));
    this.classLength.value = itemData.duration;
    
    this.additionalNoClassDayFormat.innerHTML = FormatUtil.getFormatDescription("date_standard");
    if (itemData.additionalNoClassDays && itemData.additionalNoClassDays.length > 0) {
        var dates = [];
        for (var i = 0; i < itemData.additionalNoClassDays.length; i++) {
            dates.push(ClassUtils.transformClassTimezoneToLocal(itemData.additionalNoClassDays[i], itemData.timezoneId));
        }
        this.additionalNoClassDays.setDates(dates);
    }

    this.registrationStartDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.date4Register, itemData.timezoneId));
    this.registrationEndDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.date4RegisterEnd, itemData.timezoneId));
    this.forReturningMembersStartDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.date4Return, itemData.timezoneId));
    this.forReturningMembersEndDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.date4ReturnEnd, itemData.timezoneId));
    this.forNewMembersStartDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.date4New, itemData.timezoneId));
    this.forNewMembersEndDate.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.date4NewEnd, itemData.timezoneId));
    if(itemData.minTakenDate && itemData.hasAttendance) {
        var d = ClassUtils.transformClassTimezoneToLocal(itemData.minTakenDate, itemData.timezoneId);
        this.classStartDate.setMaxDate(d);
    }

    if(itemData.maxTakenDate && itemData.hasAttendance){
        var d = ClassUtils.transformClassTimezoneToLocal(itemData.maxTakenDate, itemData.timezoneId);
        d.setHours(0, 0, 0, 0);
        this.classEndDate.setMinDate(d);
    }
    var today = new Date();
    today.setHours(today.getHours() - 24);
    //this.timeZoneCombo.setEnable(!itemData.hasAttendance && (itemData.dateEnd.getTime() > today.getTime()));

    var textInputs = this.node().querySelectorAll("input[type='text']");
    this.changedFields = [];
    this.comparators = {};
    if (textInputs) {
        var thiz = this;
        var f = function(e) {
            var target = Dom.getTarget(e);
            var classFieldKey = target.getAttribute("class-field-key");
            if (classFieldKey) {
                thiz.changedFields.push(classFieldKey);
                return;
            }
            var parent = target? target.parentNode : null;
            if (!parent) return;
            classFieldKey = parent.getAttribute("class-field-key");
            if (!classFieldKey) return;
            thiz.changedFields.push(classFieldKey);
        }
        for (var i = 0; i < textInputs.length; i++) {
            this.bind("change", function(e) {
                f(e);
            }, textInputs[i]);
            if (textInputs[i].parentNode)
                this.bind("p:ValueUpdated", function(e) {
                    f(e);
                }, textInputs[i].parentNode);
        }

        var comparators = {};
        var thiz = this;
        thiz.CUSTOM_COMPARATOR_KEYS.forEach(function(k) {
            comparators[k] = function(value1, value2) {
                if (thiz.changedFields.indexOf(k) == -1) return true;
                return thiz.compareDateValue(value1, value2, thiz.getTimezoneId());
            }
        });
        thiz.comparators = comparators;
    }

    if (window.LOGIN_INFO.allowStartDropDates) {
        if (itemData.overrideSubProgPolicy) {
            this.overrideSubProgPolicyItem.checked = true;
        } else if (itemData.startDropDatePolicyId > 0) {
            this.useCustomPolicyItem.checked = true;
        } else {
            this.dontUsePolicyItem.checked = true;
        }
        this.policySettingChangedHandler();
    }
    
    this.loadExtraInfo();
};

ClassEditDateTimeTab.prototype.updateClassData = function(data) {
    if(!data || !this.loaded) return;
    data.timezoneId = this.timeZoneCombo.getSelectedItem() ? this.timeZoneCombo.getSelectedItem().id : "";
    var d = this.classStartDate.getDate();
    if (!d && this.dateTimeData) {
        d = this.dateTimeData.dateStart;
    }
    data.dateStart = ClassUtils.transformToTimeZone(d, data.timezoneId);
    d = this.classEndDate.getDate();
    if (!d && this.dateTimeData) {
        d = this.dateTimeData.dateEnd;
    }
    data.dateEnd = ClassUtils.transformToTimeZone(d, data.timezoneId);
    data.date4See = ClassUtils.transformToTimeZone(this.displayStarting.getDate(), data.timezoneId);
    data.duration = this.classLength.value;
    data.date4Register = ClassUtils.transformToTimeZone(this.registrationStartDate.getDate(), data.timezoneId);
    data.date4RegisterEnd = ClassUtils.transformToTimeZone(this.registrationEndDate.getDate(), data.timezoneId);
    data.date4Return = ClassUtils.transformToTimeZone(this.forReturningMembersStartDate.getDate(), data.timezoneId);
    data.date4ReturnEnd = ClassUtils.transformToTimeZone(this.forReturningMembersEndDate.getDate(), data.timezoneId);
    data.date4New = ClassUtils.transformToTimeZone(this.forNewMembersStartDate.getDate(), data.timezoneId);
    data.date4NewEnd = ClassUtils.transformToTimeZone(this.forNewMembersEndDate.getDate(), data.timezoneId);
    var selectedSchedule = this.noClassScheduleCombo.getSelectedItem();
    data.noClassScheduleId = selectedSchedule ? selectedSchedule.id : 0;
    
    data.additionalNoClassDays = [];
    var noClassDays = this.additionalNoClassDays.getDates();
    if (noClassDays && noClassDays.length > 0) {
        for (var i = 0; i < noClassDays.length; i ++) {
            var d = ClassUtils.transformToTimeZone(noClassDays[i], data.timezoneId);
            data.additionalNoClassDays.push(d);
        }
    }
    
    data.minTakenDate = new Date();
    data.maxTakenDate = new Date();
    if (this.overrideSubProgPolicyItem.checked) {
        data.overrideSubProgPolicy = true;
        data.startDropDatePolicyId = 0;
    } else {
        data.overrideSubProgPolicy = false;
        if (this.useCustomPolicyItem.checked) {
            data.startDropDatePolicyId = this.policyCombo.getSelectedItem() ? this.policyCombo.getSelectedItem().id : 0;
        } else {
            data.startDropDatePolicyId = 0;
        }
    }
};

ClassEditDateTimeTab.prototype.setDatePickerMinDate = function () {
    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.classStartDate.setMinDate(minDate);
    this.classEndDate.setMinDate(minDate);
    this.displayStarting.setMinDate(minDate);
    this.registrationStartDate.setMinDate(minDate);
    this.registrationEndDate.setMinDate(minDate);
    this.forReturningMembersStartDate.setMinDate(minDate);
    this.forReturningMembersEndDate.setMinDate(minDate);
    this.forNewMembersStartDate.setMinDate(minDate);
    this.forNewMembersEndDate.setMinDate(minDate);
};

ClassEditDateTimeTab.prototype.backupDateTimeData = function (itemData) {
    if (!itemData) return;
    this.dateTimeData = {};
    this.dateTimeData.timezoneId = itemData.timezoneId;
    this.dateTimeData.dateStart = itemData.dateStart;
    this.dateTimeData.dateEnd = itemData.dateEnd;
    this.dateTimeData.date4See = itemData.date4See;
    this.dateTimeData.duration = itemData.duration;
    //this.dateTimeData.noClassDays = itemData.noClassDays;
    this.dateTimeData.date4Register = itemData.date4Register;
    this.dateTimeData.date4RegisterEnd = itemData.date4RegisterEnd;
    this.dateTimeData.date4Return = itemData.date4Return;
    this.dateTimeData.date4ReturnEnd = itemData.date4ReturnEnd;
    this.dateTimeData.date4New = itemData.date4New;
    this.dateTimeData.date4NewEnd = itemData.date4NewEnd;
    this.dateTimeData.startDropDatePolicyId = itemData.startDropDatePolicyId;
    this.dateTimeData.overrideSubProgPolicy = itemData.overrideSubProgPolicy;
    this.dateTimeData.noClassScheduleId = itemData.noClassScheduleId;

    this.classStartDate._lastGoodValue = itemData.dateStart;
    this.classEndDate._lastGoodValue = itemData.dateEnd;
    this.registrationStartDate._lastGoodValue = itemData.date4Register;
};

ClassEditDateTimeTab.prototype.isDataChanged = function () {
    if (!this.dateTimeData) return;
    var thiz = this;
    var newData = {};
    this.updateClassData(newData);

    //console.log("DATETIME TAB old/new", this.getTimezoneId(), this.dateTimeData, newData);
    //console.log("CURRENT FIELD CHANGED/ COMPARATOR", thiz.changedFields, this.comparators);
    return !ClassUtils.isSameObject(this.dateTimeData, newData, this.comparators);
};

ClassEditDateTimeTab.prototype.getTimezoneId = function() {
    return this.timeZoneCombo.getSelectedItem() ? this.timeZoneCombo.getSelectedItem().id : null;
};

ClassEditDateTimeTab.prototype.compareDateValue = function (value1, value2, timezoneId) {
    return ClassUtils.compareDateValue(value1, value2, timezoneId);
};

ClassEditDateTimeTab.prototype.policyComboChangedHandler = function () {
    var selectedItem = this.policyCombo.getSelectedItem();
    if (selectedItem) {
        if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
            this.editPolicyButton.removeAttribute("disabled");
        }
    } else {
        this.editPolicyButton.setAttribute("disabled", "disabled");
    }
};

ClassEditDateTimeTab.prototype.newPolicyButtonClickHandler = function () {
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
        var policy = {key: Util.newUUID()};
        this.openPolicyDialog(policy)
    }
};

ClassEditDateTimeTab.prototype.editPolicyButtonClickHandler = function () {
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
        var policy = this.policyCombo.getSelectedItem();
        if (!policy) return;
        policy.key = Util.newUUID();
        this.openPolicyDialog(policy)
    }
};

ClassEditDateTimeTab.prototype.openPolicyDialog = function (policyData) {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
        new StartDropPolicyDialog().callback(function (data) {
            if (data) {
                $classStartDropDateService.getAllStartDropDatePolicy(function (policies) {
                    thiz.startDropPolicies = policies.result;
                    thiz.policyCombo.setItems([null].concat(thiz.startDropPolicies), true);
                    thiz.policyCombo.selectItemByKey("id", data.id, true);
                }, function (err) {});
            }
        }).open({policyData: policyData});
    }
};

ClassEditDateTimeTab.prototype.policySettingChangedHandler = function () {
    Dom.doOnSelector(this.policySetting, "input[name=radioUsePolicy]", function (el) {
        if (el.checked) {
            Dom.removeClass(el.parentNode.parentNode, "Disabled");
        } else {
            Dom.addClass(el.parentNode.parentNode, "Disabled");
        }
    });
};

ClassEditDateTimeTab.prototype.fillSubProgPolicy = function () {
    if (!this.classInfo) return;
    this.subProgName.innerHTML = this.classInfo.subProgName;
    if (this.classInfo.subProgStartDropDatePolicyId && this.startDropPoliciesObject[this.classInfo.subProgStartDropDatePolicyId]) {
        this.subProgPolicyName.innerHTML = this.startDropPoliciesObject[this.classInfo.subProgStartDropDatePolicyId].name;
    } else {
        this.subProgPolicyName.innerHTML = "No Assigned Policy";
    }
};

ClassEditDateTimeTab.prototype.loadNoClassScheduleList = function (schedule, isLastSelectedItem) {
    var thiz = this;
    thiz.noClassScheduleCombo.setEnable(true);
    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        thiz.newSchedule.removeAttribute("disabled");
    }
    var selectedSchedule = thiz.noClassScheduleCombo.getSelectedItem();
    var isChangedSchedule = false;
    if (!this.classInfo && selectedSchedule) this.isChangedSchedule = true;
    if (selectedSchedule && this.classInfo 
        && selectedSchedule.id != this.classInfo.noClassScheduleId) {
        isChangedSchedule = true;
    }
    var classId = 0;
    if (this.classInfo) classId = this.classInfo.id;     
    var classTimeZoneId = this.timeZoneCombo.getSelectedItem().id;
    $noClassSchedulesService.loadSchedulesByTimezone(classId, classTimeZoneId, function (results) {
        thiz.noClassScheduleCombo.setItems([null].concat(results), true);
        var applyAllClassScheduleId = 0;
        var selectedId = 0;
        results.forEach(function (schedule) {
            if (schedule.appliedAllClass) applyAllClassScheduleId = schedule.id;
            if (thiz.classInfo && schedule.classIds.indexOf(thiz.classInfo.id) >= 0) {
                selectedId = schedule.id;
            }
        });
        if (applyAllClassScheduleId > 0) {
            thiz.noClassScheduleCombo.selectItemByKey("id", applyAllClassScheduleId);
            if (thiz.dateTimeData) thiz.dateTimeData.noClassScheduleId = applyAllClassScheduleId;
            thiz.noClassScheduleCombo.setEnable(false);
            thiz.newSchedule.setAttribute("disabled", "disabled");
        } else if (isLastSelectedItem) {
            if (schedule) thiz.noClassScheduleCombo.selectItemByKey("id", selectedSchedule.id);
        } else if (selectedId > 0) {
            thiz.noClassScheduleCombo.selectItemByKey("id", selectedId);
        } else if (schedule) {
            if (isChangedSchedule) {
                thiz.noClassScheduleCombo.selectItemByKey("id", selectedSchedule.id);
            } else {
                thiz.noClassScheduleCombo.selectItem(null);
            }
        }
        thiz.loaded = true;
    }, function (err) {}, "Loading...");
};

ClassEditDateTimeTab.prototype.loadExtraInfo = function () {
    if (window.LOGIN_INFO.allowStartDropDates) {
        var thiz = this;
        $classStartDropDateService.getAllStartDropDatePolicy(function (policies) {
            thiz.startDropPolicies = policies.result;
            thiz.startDropPolicies.forEach(function (p) {
                thiz.startDropPoliciesObject[p.id] = p;
            });
            thiz.policyCombo.setItems(thiz.startDropPolicies);
            if (thiz.classInfo && thiz.classInfo.startDropDatePolicyId) thiz.policyCombo.selectItemByKey("id", thiz.classInfo.startDropDatePolicyId);
            thiz.fillSubProgPolicy();
            thiz.loadNoClassScheduleList();
        }, function (err) {});
    } else {
        thiz.loadNoClassScheduleList();
    }
};


ClassEditDateTimeTab.prototype.syncClassData = function (classInfo) {
    this.classInfo = classInfo;
    this.fillSubProgPolicy();
};

ClassEditDateTimeTab.prototype.timeZoneComboChangedHandler = function () {
    if (!this.lastSelectedDataTimezoneId) return;
    this.loadNoClassScheduleList(this.noClassScheduleCombo.getSelectedItem(), true);
    var selectedTimezone = this.timeZoneCombo.getSelectedItem();
    if (selectedTimezone.id != this.lastSelectedDataTimezoneId) {
        Dom.emitEvent(ClassEditDialog.EVT_UPDATE_PAYMENT_PLAN_ITEM_TIMEZONE, this.node(),
            {oldTimezoneId: this.lastSelectedDataTimezoneId, newTimezoneId: selectedTimezone.id});
        this.lastSelectedDataTimezoneId = selectedTimezone.id;
        
        Dom.emitEvent(ClassEditDialog.CLASS_DATE_TIME_INFO_UPDATED, this.node(),{});
    }
};

ClassEditDateTimeTab.prototype.scheduleComboChangedHandler = function () {
    var selectedItem = this.noClassScheduleCombo.getSelectedItem();
    if (selectedItem) {
        if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
            this.editSchedule.removeAttribute("disabled");
        }
        if (this.classInfo) {
            this.classInfo.noClassDays = selectedItem.editingClassNoClassDays;
            this.enhanceNoClassDays();
        }
    } else {
        if (this.classInfo) {
            this.classInfo.noClassDays = [];
            this.enhanceNoClassDays();
        }        
        this.editSchedule.setAttribute("disabled", "disabled");
    }
};

ClassEditDateTimeTab.prototype.enhanceNoClassDays = function () {
    var noClassDays = this.additionalNoClassDays.getDates();
    if (noClassDays && noClassDays.length > 0) {
        for (var i = 0; i < noClassDays.length; i ++) {
            var d = ClassUtils.transformToTimeZone(noClassDays[i], this.classInfo.timezoneId);
            
            const exists = this.classInfo.noClassDays.some(date => date.getTime() === d.getTime());
            if (!exists) this.classInfo.noClassDays.push(d);
        }
    }
};

ClassEditDateTimeTab.prototype.newScheduleButtonClickHandler = function () {
    this.openScheduleDialog([]);
};

ClassEditDateTimeTab.prototype.editScheduleButtonClickHandler = function () {
    var schedule = this.noClassScheduleCombo.getSelectedItem();
    if (!schedule) return;
    this.openScheduleDialog([schedule.id]);
};

ClassEditDateTimeTab.prototype.openScheduleDialog = function (ids) {
    var thiz = this;
    new ScheduleEditDialog().callback(function(data) {
        if(!data) return;
        $noClassSchedulesService.saveSchedule(data, function(jobId) {
            thiz._onSaveScheduleJobExecuted(jobId, function (schedule) {
                thiz.loadNoClassScheduleList(schedule);
            }, function (err) {
                thiz.loadNoClassScheduleList();
                Dialog.error(err.errorMessage || "Error when saving Schedule.");
            });
        }, function(err) {}, "Saving...");
    }).open({ids: ids});
};

ClassEditDateTimeTab.prototype._onSaveScheduleJobExecuted = function(jobId, onSuccess, onError) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var busyIndicator = new Spinner("Generating slot instance...");
    busyIndicator.busy();
    
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                        busyIndicator.done();
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        busyIndicator.done();
                        onError({errorMessage: job.errorMessage});
                    }
                } else {
                    busyIndicator.done();
                    onFailed({errorMessage: "Job not found."});
                }
            }, function (error) {
                busyIndicator.done();
                onFailed(error);
            });
        }, 1000);
    })();
};

ClassEditDateTimeTab.prototype.validateUIWithPermission = function () {
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        this.editPolicyButton.setAttribute("disabled", "disabled");
        this.newPolicyButton.setAttribute("disabled", "disabled");
        this.editSchedule.setAttribute("disabled", "disabled");
        this.newSchedule.setAttribute("disabled", "disabled");
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditDialog.js";

function ClassEditDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    var thiz = this;
    this.bind("click", this.indexActionNextClickHandler, this.indexActionNext);
    this.bind("click", this.indexActionPrevClickHandler, this.indexActionPrev);
    this.bind("p:ItemSelected", this.classesComboChangeHandler, this.classesCombo.node());
    this.bind(ClassEditDialog.EVT_CHANGE_TAB, function(event) {
        var tabName = event.tabName;
        thiz.tabPane.setActiveTabPane(thiz[tabName]);
    }, this.tabPane);

    this.bind(ClassEditDialog.EVT_UPDATE_PAYMENT_PLAN_ITEM_TIMEZONE, function(event) {
        thiz.updatePaymentPlanItemTimezone(event.oldTimezoneId, event.newTimezoneId);
    }, this.containerWrapper);

    this.bind(ClassEditDialog.START_END_DATE_UPDATED, function(event) {
        thiz.startEndDateUpdatedHandler(event);
    }, this.containerWrapper);

    this.bind(ClassEditDialog.INSTRUCTOR_CONFLICTS_UPDATED, function(event) {
        thiz.isDateTimeInfoChanged = false;
    }, this.containerWrapper);

    this.bind(ClassEditDialog.CLASS_DATE_TIME_INFO_UPDATED, function(event) {
        if (!thiz.classEditDateTimeTab) return;
        if (!thiz.classEditRegSlotTab) return;
        thiz.isDateTimeInfoChanged = false;
        var editingTimezoneId = thiz.classEditDateTimeTab.timeZoneCombo.getSelectedItem() ;
        var editingStartDate = thiz.classEditDateTimeTab.classStartDate.getDate();
        var editingEndDate = thiz.classEditDateTimeTab.classEndDate.getDate();
        var editingClassLength = thiz.classEditDateTimeTab.classLength.value || 0;

        if (!editingTimezoneId) return;
        if (!editingStartDate) return;
        if (!editingEndDate) return;

        thiz.isDateTimeInfoChanged = true;
    }, this.containerWrapper);

    this.classesCombo.renderer = function(item, select) {
        if(!item) return "";
        return "" + item.title;
    }

    this.currentClass = {id: 0};
    this.defaultMakeups = 0;

    this.weekdayName = {
        Mon: "Monday",
        Tue: "Tuesday",
        Wed: "Wednesday",
        Thu: "Thursday",
        Fri: "Friday",
        Sat: "Saturday",
        Sun: "Sunday"
    };
    this.reloadOnClose = false;

    this.reload = function (options) {
        var activeTabName = thiz.tabPane._getTabName(thiz.tabPane.getActiveTabPane());
        var ppTabClazz = thiz.classEditPaymentPlanTab;
        var activePaymentPlanKey = "";
        if(ppTabClazz && typeof(ppTabClazz.getFocusPaymentPlanKey) == "function") {
            activePaymentPlanKey = ppTabClazz.getFocusPaymentPlanKey();
        }
        console.log("RELOAD ACTIVES:", activeTabName, activePaymentPlanKey, options);

        thiz.doOnAllAsyncTab(function(tab) {
            if (typeof(tab.isClassDataChanged) == "undefined") return;
            if (typeof(tab.discardChanges) == "undefined") return;
            if (tab.isClassDataChanged()) tab.discardChanges();
        })

        window.defaultIndicator.busy("Loading...");
        $classAdminService.getClassDetailById(thiz.currentClassId, function(classInfo) {
            thiz.currentClassId = classInfo.id;
            thiz.options.activePaymentPlanKey = activePaymentPlanKey;
            thiz.options.activeTab = activeTabName;
            thiz._resetClassDialog();
            thiz._renderEditingClassInfo(classInfo, (activeTabName == "registrationTab" || activeTabName == "attendanceTab")? {reloadOneTime: (options && options.reloadOneTime? options.reloadOneTime : false)}: null);
            console.log("SAVE CLASS ERROR & RESPONSE DONE",  classInfo);
            thiz.reloadOnClose = true;
        }, function(err) {
            console.log("RELOAD CLASS ERROR", data.classData, err);
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
            Dialog.error("There was an error when reloading this class.");
        });
    };
    this._reload = this.reload.bind(this);

    this.validateChange = function() {
        return thiz.isClassDataChanged();
    }

    this.saveAndContinue = function(options) {
        thiz.saveAndContinueHandler(options);
    }
    CommonEvent.listener(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED, this._reload);
}

__extend(Dialog, ClassEditDialog);

ClassEditDialog.EVT_CHANGE_TAB = "evt:change_tab";
ClassEditDialog.RELOAD_CLASS = "evt:ReloadClass";
ClassEditDialog.EVT_UPDATE_PAYMENT_PLAN_ITEM_TIMEZONE = "evt:update_payment_plan_item_timezone";
ClassEditDialog.START_END_DATE_UPDATED = "evt:start_end_date_upated";
ClassEditDialog.CLASS_DATE_TIME_INFO_UPDATED = "evt:class_date_time_info_updated";
ClassEditDialog.INSTRUCTOR_CONFLICTS_UPDATED = "evt:instructor_conflicts_updated";



ClassEditDialog.ERROR_CODE = {
    CONFLICT_TIME: "CONFLICT_TIME",
    INSTRUCTOR_NOT_AVAILABLE: "INSTRUCTOR_NOT_AVAILABLE",
    NOT_FULL_DURATION: "NOT_FULL_DURATION",
    DELETE_PAYMENT_PLAN: "DELETE_PAYMENT_PLAN"
};


ClassEditDialog.prototype.asyncSetup = function (options, dialogCallback) {
    var thiz = this;
    if (window.LOGIN_INFO) {
        this.setupClassEditDialog(options, dialogCallback);
    } else {
        $classAdminService.getAccountInfo(function(loginInfo) {
            window.LOGIN_INFO = loginInfo;
            window.LOCALE = window.LOCALE || {};
            window.LOCALE.CURRENCY = loginInfo.currency;
            window.LOCALE.WEEKDAYS_SHORT = loginInfo.shortWeekdays;
            thiz.setupClassEditDialog(options, dialogCallback);
        }, function(error) { reject(error); }, "Loading...");
    }
};
ClassEditDialog.prototype.bindTabChangeEvent = function () {
    var thiz = this;
    var previousTab = null;
    this.bind("e:TabChange", function (e) {
        var tabName = thiz.tabPane._getTabName(thiz.tabPane.getActiveTabPane());
        if (previousTab == "registrationTab") {
            if(thiz.registrationTab && typeof(thiz.registrationTab.isDataChanged) == "function") {
                if (thiz.registrationTab.isDataChanged()) {
                    thiz.options.activeTab = tabName;
                    console.log("FORCE RELOAD BECAUSE REGISTRATION CHANGE");
                    thiz.reload();
                    return;
                }
            }
        } else if (previousTab == "attendanceTab") {
            if (thiz.trackAttendanceTab && typeof(thiz.trackAttendanceTab.isDataChanged) == "function") {
                if (thiz.trackAttendanceTab.isDataChanged()) {
                    Dialog.confirm("Some attendances are changed and haven't been saved yet. Please save to continue", "",
                            "Save Attendance", function() {
                                if (!thiz.trackAttendanceTab) return;
                                thiz.trackAttendanceTab.updateAttendanceHandler(function (isUpdateAttendanceNote) {
                                    if (isUpdateAttendanceNote) thiz.registrationTab.reload();
                                });
                            },
                            "Discard Change", function() {
                                if (!thiz.trackAttendanceTab) return;
                                thiz.trackAttendanceTab.renderAttendanceTable();
                            });
                }
            }
        }
        var activeTabClazz = thiz.tabNames[tabName];
        var classInfo = thiz.getClassData();
        console.log("previsou tab", previousTab, activeTabClazz, tabName, thiz.tabNames);
        if(activeTabClazz && typeof(activeTabClazz.syncClassData) == "function") {
            activeTabClazz.syncClassData(classInfo, (previousTab == tabName));
        }
        thiz.doOnAllAsyncTab(function(tab, asyncTabName) {
            if (asyncTabName != tabName || typeof(tab.asyncLoadClassData) != "function") return;
            tab.asyncLoadClassData();
        });
        previousTab = tabName;
        thiz.previousTab = previousTab;

        if (thiz.isDateTimeInfoChanged && tabName == "regSlotTab") {
            if (thiz.classEditRegSlotTab) thiz.classEditRegSlotTab.refreshInsConflicts();
        }
        thiz.invalidateElements();

    }, this.tabPane.node());
};

ClassEditDialog.prototype.setupClassEditDialog = function(options, dialogCallback) {
    console.log("OPEN", options, dialogCallback);
    var thiz = this;
    this.classIdIndex = 0;
    this.options = options;
    if(options.ids) {
        this.title = "Edit Class";
        if(options.ids.length > 1) {
            this.classesCombo.setItems(options.memberClasses);
            this.classesCombo.selectItemByKey("id", options.ids[this.classIdIndex]);
        } else {
            this.classesCombo.node().style.display = "none";
        }
    } else {
        this.title = "Add Class";
        this.paneTitle.innerHTML = "Add Class";
        this.classesCombo.node().style.display = "none";
    }

    Dom.toggleClass(thiz.containerWrapper, "class-costume", window.LOGIN_INFO.allowCostume ? true : false);
    var thiz = this;
    $classAdminService.getClassConfiguration(function (res) {
        thiz.filters = res;
        thiz.defaultMakeups = res.lessonTeamMakeups;
        thiz.classRegistrationLink = res.classRegistrationLink;
        thiz.classRegShoppingLink = res.classRegShoppingLink;
        thiz.myAccountAgreementLink = res.myAccountAgreementLink;
        thiz.isBookingEnabled = res.isBookingEnabled;
	    if (window.LOGIN_INFO.allowDressCode) {
            thiz.setupDressCodeTab(function() {
                thiz.renderClassEditDialog(thiz.filters, options.ids, thiz.classIdIndex, dialogCallback);
            })
            return;
        }
	    thiz.renderClassEditDialog(thiz.filters, options.ids, thiz.classIdIndex, dialogCallback);
    }, function (err) {
        dialogCallback();
    }, "Loading...");
};

ClassEditDialog.prototype.setupDressCodeTab = function(callback) {
    var thiz = this;
    var tab = Dom.newDOMElement({
        "tab-name": "dresscode",
        _name: "vbox",
        "flex": 1
    });
    var options = {
        "errorValidationHandler": function(error, input) {
            thiz.showErrorMessage(error, tab, input);
        }
    }
    widget.createWidgetAsync("discountdance", "ClassDressCodeSettingWidget", options, function(dressCodeWg) {
        if (!dressCodeWg) {
            if (callback) callback();
            return;
        }

        dressCodeWg.into(tab);
        dressCodeWg.setup(callback);
        tab._widget = dressCodeWg;
        tab._isAsyncTab = true;
        thiz.tabPane.addTab("Dress Code", tab);
        thiz.tabPane.setHeaderOrder("dresscode", 4);
        thiz.tabPane.invalidateHeaders();
    })
}

ClassEditDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var body = document.getElementsByTagName("body")[0];
    var actions = [
        {
            type: "accept", title: "Save Attendance",
            isApplicable: function () {
                return thiz.invalidateSaveAttendanceButtons();
            },
            run: function () {
                thiz.saveAttendanceHandler();
            }
        },
        {
            type: "accept", title: "Save",
            isApplicable: function () {
                return thiz.invalidateActionButtons();
            },
            run: function () {
                thiz.saveAndContinueHandler();
            }
        },
        {
            type: "accept", title: "Save & Close",
            isApplicable: function () {
                return thiz.invalidateActionButtons();
            },
            run: function () {
                // if (thiz.currentClass && thiz.currentClass.dateStart
                //     && thiz.classEditDateTimeTab && thiz.classEditDateTimeTab.classStartDate.getDate())
                // console.log(thiz.currentClass.dateStart);
                // console.log(thiz.classEditDateTimeTab.classStartDate.getDate());
                thiz.saveAndCloseHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                if (thiz.trackAttendanceTab && typeof(thiz.trackAttendanceTab.isDataChanged) == "function" && thiz.trackAttendanceTab.isDataChanged()) {
                    Dialog.confirm("Some attendances are changed and haven't been saved yet. Do you want to quit?", "",
                    "Close without saving", function() {
                        thiz.close();
                    },
                    "Cancel", function() {
                    });
                } else {
                    if(thiz.isClassDataChanged()){
                        Dialog.confirm("All changes are not saved. Do you want to quit?", null, "Close without saving", function(){
                             thiz.close({reloadOnClose: thiz.reloadOnClose});
                        },
                        "Cancel", function() {
                        }, null, null);
                        return false;
                    }
                    if (thiz.reloadOnClose) {
                        thiz.close({reloadOnClose: thiz.reloadOnClose});
                        return false;
                    }
                    return true;
                }
            }
        }
    ];

    if(this.options && this.options.ids && this.options.ids.length > 0) {
        if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
            actions.push({
                type: "accept", title: "Save Change to a New Class (Clone)",
                isApplicable: function () {
                    return thiz.invalidateExtraActionButtons();
                },
                order: -1,
                run: function () {
                    thiz.saveAndCloneButtonClickHandler();
                }
            });
        }

        actions.push(this._getSizeAllMembersButton());
        actions.push({
            type: "extra", title: "Share", icon: "share",
            order: -3,
            run: function () {
                new ShareClassDialog().open({type: "Class", name: thiz.currentClass.title, data: {classId: thiz.currentClass.id, subProgId: thiz.currentClass.subProgId}});
            }
        });
    }
    return actions;
};

ClassEditDialog.prototype._getSizeAllMembersButton = function() {
    var thiz = this;

    return {
        type: "accept",
        title: "Size All Members",
        isApplicable: function() {
            return thiz._getActiveTabName() == "sizesTab";
        },
        order: -2,
        run: function() {
            thiz.memberSizingListViewTab.openMemberSizingDialog();
        }
    }
}

ClassEditDialog.prototype._getActiveTabName = function() {
    return this.tabPane._getTabName(this.tabPane.getActiveTabPane());
}

ClassEditDialog.prototype.shouldShowUnapplicableButtons = function () {
    return false;
};

ClassEditDialog.prototype.renderClassEditDialog = function (filters, ids, index, dialogCallback, forceReloadTab) {
    var thiz = this;
    var editClassId = 0;
    if(ids) {
        if(ids.length > 1) {
            this.paneTitle.innerHTML = "Edit Class";
            this.editClassIndex.innerHTML = "Class " + (this.classIdIndex + 1) + " of " + ids.length;
            this.editClassIndex.parentNode.style.display = "flex";
        } else {
            this.indexAction.parentNode.removeChild(this.indexAction);
        }
        if(this.classIdIndex == 0) {
            Dom.addClass(this.indexActionPrev, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionPrev, "action-disabled");
        }
        if(this.classIdIndex == ids.length - 1) {
            Dom.addClass(this.indexActionNext, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionNext, "action-disabled");
        }
        editClassId = ids[this.classIdIndex];
        //this.cloneButton.style.display = "inline-block";
    } else {
        this.indexAction.parentNode.removeChild(this.indexAction);
    }
    thiz._resetClassDialog();
    if(editClassId && editClassId > 0) {
        this.currentClassId = editClassId;
        window.defaultIndicator.busy("Loading...");
        $classAdminService.getClassDetailById(editClassId, function(res) {
            thiz._renderEditingClassInfo(res, {forceReloadTab: forceReloadTab});
            if (typeof(dialogCallback) == "function") dialogCallback();
            thiz.bindTabChangeEvent();
        }, function(err) {
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
            if (typeof(dialogCallback) == "function") dialogCallback();
            thiz.bindTabChangeEvent();
        });
    } else {
        this.classEditGeneralTab = new ClassEditGeneralTab({filters: filters,
                                                            defaultMakeups: thiz.defaultMakeups,
                                                            isBookingEnabled: thiz.isBookingEnabled,
                                                            timezoneCallback: thiz.getTimezoneCallback}).into(this.generalInfoTabContent);
        this.classEditDateTimeTab = new ClassEditDateTimeTab({filters: filters}).into(this.dateTimeInfoTabContent);
        if (window.LOGIN_INFO.allowClassPaymentPlan) {
            this.classEditPaymentPlanTab = new ClassEditPaymentPlanTab({filters: filters,
                                                    reloadCallback: thiz.reload,
                                                    validateChangeCallback: thiz.validateChange,
                                                    saveCallback: thiz.saveAndContinue}).into(this.paymentPlanTabContent);

            this.classEditDiscountPlanTab = new ClassEditDiscountPlanTab({filters: filters,
                                                    reloadCallback: thiz.reload,
                                                    validateChangeCallback: thiz.validateChange,
                                                    saveCallback: thiz.saveAndContinue}).into(this.discountPlanTabContent);
        }

        this.classEditRegSlotTab = new ClassEditRegSlotTab({
            filters: filters,
            buildClassData: function () {
                return thiz.buildClassData(true);
            }
        }).into(this.regSlotTabContent);

        this.classEditQuestionTab = new ClassEditQuestionTab({filters: filters,
                                                reloadCallback: thiz.reload,
                                                validateChangeCallback: thiz.validateChange,
                                                saveCallback: thiz.saveAndContinue}).into(this.questionTabContent);

        this.sizesTab = this.tabPane.getTabs().filter(function(tab) { return tab.title == "Sizes"})[0];
        this.tabPane._removeTabByHeader(this.sizesTab.header);

        this.costumesTab = this.tabPane.getTabs().filter(function(tab) {return tab.title == "Costumes";})[0];
        this.tabPane._removeTabByHeader(this.costumesTab.header);

        this.trackAttendance = this.tabPane.getTabs()[this.tabPane.getTabs().length - 1];
        this.tabPane._removeTabByHeader(this.trackAttendance.header);
        this.registrationTab = this.tabPane.getTabs()[this.tabPane.getTabs().length - 1];
        this.removedRegTab = this.tabPane.getTabs()[this.tabPane.getTabs().length - 1];
        this.tabPane._removeTabByHeader(this.registrationTab.header);

        if (window.LOGIN_INFO.allowCostume) this._loadCostumeTabs();

        this.bind("change", this.allowWaitListChangeHandler, this.classEditGeneralTab.allowWaitList);
        this.setupTabs();

        this.doOnAllAsyncTab(function(tab) {
            tab.setClassData({id: 0});
        });
        this.bindTabChangeEvent();
        dialogCallback();
    }

};
ClassEditDialog.prototype._resetClassDialog = function() {
    this.generalInfoTabContent.innerHTML = "";
    this.dateTimeInfoTabContent.innerHTML = "";
    this.discountPlanTabContent.innerHTML = "";
    this.paymentPlanTabContent.innerHTML = "";
    this.regSlotTabContent.innerHTML = "";
    console.log("### resetClassDialog:", this.options.activeTab, this.registrationTab);
    if (this.registrationTab && this.options.activeTab != "registrationTab") {
        this.registrationTabContent.innerHTML = "";
        this.registrationTab = null;
    }
    this.questionTabContent.innerHTML = "";
    this.attendanceTabContent.innerHTML = "";
    this.costumesContent.innerHTML = "";
    this.sizesContent.innerHTML = "";
}

ClassEditDialog.prototype._renderEditingClassInfo = function(classInfo, options) {
    var thiz = this;
    $classAdminService.validateClassInstructorsOnSched(classInfo, [], [], -1, -1, -1, function (res) {
        thiz.filters.validatedInstructor = res.validatedInstructors;
        var filters = thiz.filters;
        var ids = thiz.options.ids;
        var slot = -1;
        if(thiz.options && thiz.options.slot >= 0) slot = thiz.options.slot;
        var fromClassRegistration = thiz.options ? thiz.options.fromClassRegistration : false;
        thiz.firstTimeDateStart = classInfo.dateStart;
        thiz.currentClass = classInfo;
        thiz.currentClass.orgTimezoneId = classInfo.timezoneId;
        var editClassId = classInfo.id;
        thiz.classEditGeneralTab = new ClassEditGeneralTab({filters: filters,
                                                            data: classInfo,
                                                            defaultMakeups: thiz.defaultMakeups,
                                                            fromClassRegistration: fromClassRegistration,
                                                            isBookingEnabled: thiz.isBookingEnabled,
                                                            timezoneCallback: thiz.getTimezoneCallback}).into(thiz.generalInfoTabContent);
        thiz.classEditDateTimeTab = new ClassEditDateTimeTab({filters: filters, data: classInfo}).into(thiz.dateTimeInfoTabContent);
        thiz.classEditRegSlotTab = new ClassEditRegSlotTab({
            filters: filters,
            data: classInfo,
            buildClassData: function () {
                return thiz.buildClassData(true);
            }
        }).into(thiz.regSlotTabContent);
        if (window.LOGIN_INFO.allowClassPaymentPlan) {
            thiz.classEditPaymentPlanTab = new ClassEditPaymentPlanTab({currentClassId: editClassId,
                                                                    filters: filters,
                                                                    data: classInfo,
                                                                    activePaymentPlanKey: (options && options.activePaymentPlanKey? options.activePaymentPlanKey : thiz.options.activePaymentPlanKey),
                                                                    reloadCallback: thiz.reload,
                                                                    openAssign: (options? options.openAssign: false),
                                                                    validateChangeCallback: thiz.validateChange,
                                                                    saveCallback: thiz.saveAndContinue}).into(thiz.paymentPlanTabContent);

            thiz.classEditDiscountPlanTab = new ClassEditDiscountPlanTab({data: classInfo}).into(thiz.discountPlanTabContent);

            if (options && options.forceReloadTab && thiz.options.activeTab == "paymentPlanTab")  {
                setTimeout(function() {
                    thiz.classEditPaymentPlanTab.syncClassData(classInfo);
                }, 100);
            }

        }
        var noRegTab = !(((thiz.tabPane.getTabs()[thiz.tabPane.getTabs().length - 3]).title == "Registrations")
                        || ((thiz.tabPane.getTabs()[thiz.tabPane.getTabs().length - 2]).title == "Registrations")
                        || ((thiz.tabPane.getTabs()[thiz.tabPane.getTabs().length - 1]).title == "Registrations"));
        var regTabOptions = {currentClassId: editClassId,
                slot: slot,
                classInfo: thiz.currentClass,
                reloadCallback: thiz.reload,
                validateChangeCallback: thiz.validateChange,
                enableAutoWaitlistOnTeam: filters.enableAutoWaitlistOnTeam,
                hasJustReloaded: (options && options.reloadOneTime? options.reloadOneTime: false),
                saveCallback: thiz.saveAndContinue};
        if (options && thiz.options.from == "ClassList" && thiz.options.activeTab == "registrationTab")  {
            regTabOptions.hasJustReloaded = true;
        }
        if (!thiz.registrationTab || !thiz.registrationTab.rendered) {
            thiz.registrationTabContent.innerHTML = "";
            thiz.registrationTab = new ClassEditRegistrationTab(regTabOptions).into(thiz.registrationTabContent);
        } else {
            thiz.registrationTab.reloadClassInfo(thiz.currentClass);
        }

        if(noRegTab && thiz.removedRegTab) {
            thiz.tabPane.addTab("Registrations", thiz.removedRegTab.contentNode);
        }

        var canViewClassAttendance = ClassAuthUtils.canViewClassAttendance(window.LOGIN_INFO) || (window.LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass && thiz.currentClass && ClassUtils.isMyInstructorAssigned(thiz.currentClass, window.LOGIN_INFO.accountId));
        if (thiz.currentClass && thiz.currentClass.slots && thiz.currentClass.slots.length > 0 && canViewClassAttendance) {
            var slotItems = thiz.currentClass.slots || [];
            if (!ClassAuthUtils.canViewClassAttendance(window.LOGIN_INFO) && (slotItems.length > 0)) {
                slotItems = slotItems.filter(function(slot) {
                    return slot.instructorIds && slot.instructorIds.includes(window.LOGIN_INFO.accountId);
                });
            }

            thiz.trackAttendanceTab = new TrackAttendanceContent({
                classList: [{
                    id: thiz.currentClass.id,
                    progName: thiz.currentClass.progName,
                    subProgName: thiz.currentClass.subProgName,
                    duration: thiz.currentClass.duration,
                    instructorNames: thiz.currentClass.instructorNames,
                    slots: slotItems,
                    detail: thiz.currentClass,
                    deletedSlotsHasAttendance: thiz.currentClass.deletedSlotsHasAttendance? thiz.currentClass.deletedSlotsHasAttendance : null,
                    googleMapLink: thiz.currentClass.googleMapLink,
                    lessonLocId: thiz.currentClass.lessonLocId,
                    lessonLocName: thiz.currentClass.lessonLocName
                }],
                defaultDate: "currentMonth",
                reloadCallback: thiz.reload,
                validateChangeCallback: thiz.validateChange,
                hasJustReloaded: false,
                saveCallback: thiz.saveAndContinue,
                enableGroupAttendanceNote: thiz.options.enableGroupAttendanceNote,
                enableClassRooomAttendanceNote: thiz.options.enableClassRooomAttendanceNote,
                classRoomAttendanceNoteLabel: thiz.options.classRoomAttendanceNoteLabel
            }).into(thiz.attendanceTabContent);
        } else {
            thiz._removeTab("Attendance");
        }

        if (window.LOGIN_INFO.allowCostume) {
            thiz._loadCostumeTabs();
        }

        thiz.bind("change", thiz.allowWaitListChangeHandler, thiz.classEditGeneralTab.allowWaitList);
        thiz.classEditRegSlotTab._allowWaitlist = classInfo.isWaitlist;
        if (ids && ids.length == 1 || classInfo.id > 0) {
            thiz.paneTitle.innerHTML = classInfo.title;
            if (thiz.title == "Add Class") {
                thiz.title = "Edit Class";
                thiz.invalidateElements();
            }
        }
        
        thiz.classEditQuestionTab = new ClassEditQuestionTab({data: classInfo}).into(thiz.questionTabContent);
        
        console.log("_renderEditingClassInfo", thiz.currentClass);
        thiz.setupTabs();
        thiz.validateUIWithPermission();
        thiz.doOnAllAsyncTab(function(tab) {
            tab.setClassData(thiz.currentClass);
        });
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    }, function (err) {}, "Loading...");
}
ClassEditDialog.prototype.doOnAllAsyncTab = function(worker) {
    var asyncTabMap = this.getAsyncTabMap();
    if (!asyncTabMap) return;
    for (var key in asyncTabMap) {
        var tab = asyncTabMap[key];
        if (!tab || !worker) continue;
        worker(tab, key);
    }
}

ClassEditDialog.prototype.getAsyncTabMap = function() {
    var thiz = this;
    var asyncMap = undefined;
    var tabs = this.tabPane.getTabs();
    if (tabs) {
        tabs.forEach(function(t) {
            if (!t.contentNode._isAsyncTab) return;
            var tabName = thiz.tabPane._getTabName(t.contentNode);
            if (!tabName) return;
            if (!asyncMap) asyncMap = {};
            asyncMap[tabName] = t.contentNode._widget;
        })
    }
    return asyncMap;
}

ClassEditDialog.prototype._removeTab = function (tabTitle) {
    var tab = this.tabPane.getTabs().filter(function(tab) { return tab.title == tabTitle})[0];
    if (tab) this.tabPane._removeTabByHeader(tab.header);
};
ClassEditDialog.prototype._loadCostumeTabs = function () {
    var canManageClassCostumes = ClassAuthUtils.canManageClassCostumes(window.LOGIN_INFO);
    var canViewClassSizes = ClassAuthUtils.canViewAllClassMemberSizes(window.LOGIN_INFO);

    if (!canManageClassCostumes) {
        this._removeTab("Costumes");
    }

    if (!canViewClassSizes) {
        this._removeTab("Sizes");
    }

    if (!canManageClassCostumes && !canViewClassSizes) return;

    var tabTitles = this.tabPane.getTabs().map(function(tab) {
        return tab.title;
    });

    if (canManageClassCostumes && tabTitles.indexOf("Costumes") < 0 && this.costumesTab) {
        this.tabPane.addTab("Costumes", this.costumesTab.contentNode);
    }

    if (canViewClassSizes && tabTitles.indexOf("Sizes") < 0 && this.sizesTab) {
        this.tabPane.addTab("Sizes", this.sizesTab.contentNode);
    }

    var thiz = this;
    widget.__ensureNamespaceLoaded("costume", function (ns) {
        if (canManageClassCostumes) {
            thiz.costumeListViewTab = new ns.CostumeListView({
                classInfo: thiz.currentClass
            }).into(thiz.costumesContent);
            thiz.tabPane.setTabTitleByName("costumesTab", ns.util.getPreferredCostumeModuleName("plural"));
        }

        if (canViewClassSizes) {
            thiz.memberSizingListViewTab = new ns.MemberSizingListView({
                classInfo: thiz.currentClass,
                isParentsSizingToolEnabled: ns.util.isParentsSizingToolEnabled()
            }).into(thiz.sizesContent);
        }
    });
}

ClassEditDialog.prototype.setupTabs = function() {
    var thiz = this;
    this.tabNames = {};
    this.tabNames["generalInfoTab"] = this.classEditGeneralTab;
    this.tabNames["dateTimeInfoTab"] = this.classEditDateTimeTab;
    this.tabNames["discountPlanTab"] = this.classEditDiscountPlanTab;
    this.tabNames["paymentPlanTab"] = this.classEditPaymentPlanTab;
    this.tabNames["regSlotTab"] = this.classEditRegSlotTab;
    this.tabNames["registrationTab"] = this.registrationTab;
    this.tabNames["questionTab"] = this.classEditQuestionTab;
    this.tabNames["attendanceTab"] = this.trackAttendanceTab;
    this.tabNames["costumesTab"] = this.costumeListViewTab;
    this.tabNames["sizesTab"] = this.memberSizingListViewTab;

    if (this.options.activeTab) {
        setTimeout(function(){
            var tab = thiz.tabPane.findTabByName(thiz.options.activeTab);
            thiz.tabPane.setActiveTabPane(tab);
        }, 200);
    }
}

ClassEditDialog.prototype.buildClassData = function(ignoreError) {
    var thiz = this;
    if(this.validateFormData(ignoreError)) {
        var classData = this.getClassData();
        if (classData.dateAgeUp) {
            classData.dateAgeUp = ClassUtils.transformToTimeZone(classData.dateAgeUp, classData.timezoneId);
        }

        if (!(window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) && classData.isChargeMonthly) {
            if(this.classEditDateTimeTab.classStartDate.getDate().getDate() != 1) {
                if (!ignoreError) {
                    this.showErrorMessage("Monthly class MUST start on the 1st of the month.", this.dateTimeInfoTab, this.classEditDateTimeTab.classStartDate.input);
                    return;
                }
            }
        }

        var slots = [];
        var hasError = false, errorMessage = "";
        for(var i = 0; i < classData.slots.length; i ++) {
            if(hasError) break;
            var slot = classData.slots[i],
                hasCorrectValue = false,
                schedByWeekdayName = {};
            for(var key in slot.schedByWeekdayName) {
                var hasInstructors = false;
                if(slot.schedByWeekdayName[key].instructors.length > 0) {
                    hasInstructors = true;
                    schedByWeekdayName[key] = {
                        instructors: slot.schedByWeekdayName[key].instructors
                    };
                }
                if(slot.schedByWeekdayName[key].startTime.length > 0) {
                    var startTime = slot.schedByWeekdayName[key].startTime.trim();
                    if(startTime.length != 8) {
                        hasError = true;
                        errorMessage = String.format("Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots (#{0}) and try to save again.", slot.slotOrder);
                        break;
                    } else {
                        if(startTime.indexOf(":") != 2) {
                            hasError = true;
                            errorMessage = String.format("Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots (#{0}) and try to save again.", slot.slotOrder);
                            break;
                        }
                        var hour = parseInt(startTime.substring(0, 2), 10);
                            minute = parseInt(startTime.substring(3, 5), 10);
                        if(isNaN(hour) || isNaN(minute) || hour < 0 || hour > 12 || minute < 0 || minute > 59) {
                            hasError = true;
                            errorMessage = String.format("Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots (#{0}) and try to save again.", slot.slotOrder);
                            break;
                        }
                    }
                    hasCorrectValue = true;
                    schedByWeekdayName[key] = slot.schedByWeekdayName[key];
                } else if (hasInstructors) {
                    hasError = true;
                    errorMessage = String.format("[Slot Time] is required for [Slot #{0}] on [{1}]", slot.slotOrder, this.weekdayName[key]);
                    break;
                }
            }
            if(hasError) break;
            if(slot.maxLimit.length == 0) slot.maxLimit = 0;
            if(hasCorrectValue && (isNaN(slot.maxLimit) || slot.maxLimit < 0)) {
                hasError = true;
                errorMessage = String.format("[Slot Limit] is required for [Slot #{0}]", slot.slotOrder);
                break;
            }
            if(hasCorrectValue) {
                slot.schedByWeekdayName = schedByWeekdayName;
                slots.push(slot);
            }
        }

        if(hasError && errorMessage.length > 0) {
            if (!ignoreError) {
                this.showErrorMessage(errorMessage, this.regSlotTab, null);
                return;
            }
        }
        classData.slots = slots;

        if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
            var paymentPlanItemsError = this.validatePaymentPlanItems(classData);
            if (paymentPlanItemsError.hasError) {
                if (classData.id > 0) paymentPlanItemsError.errorMessage += "</br> Class data will be reloaded.";
                if (!ignoreError) {
                    Dialog.alertHtmlMessage("Error", paymentPlanItemsError.errorMessage, function () {
                        if (classData.id > 0) thiz.reload();
                    });
                    return;
                }
            }
        }

        return classData;
    }
}

ClassEditDialog.prototype.saveAndCloseHandler = function () {
    var classData = this.buildClassData();
    if(classData && classData.hasError) {
        delete classData.hasError;
        return;
    }
    if (classData && classData.hasSlotError && classData.errorMessage) {
        Dialog.error(classData.errorMessage, "", function() {});
        delete classData.hasSlotError;
        delete classData.errorMessage;
        return;
    }

    if(classData) {
        delete classData.hasError;
        var thiz = this;
        this.doOnAllAsyncTab(function(tab) {
            if (tab.isClassDataChanged()) tab.updateClassData(classData);
        })
        if (classData.id > 0 && classData.hasRegister > 0 && this.firstTimeDateStart
            && this.firstTimeDateStart.getTime() != classData.dateStart.getTime()) {
                Dialog.confirm("Changing class start date may affect scheduled " + "payment plan charges" + ". Are you sure you want to proceed?", "", "Continue", function() {
                    thiz.doSaveAndClose(classData, function (res) {
                        if (res) {
                            res.reloadOnClose = true;
                            thiz.close(res);
                        }
                    });
                }, "Cancel");
        } else {
            thiz.doSaveAndClose(classData, function (res) {
                if (res) {
                    res.reloadOnClose = true;
                    thiz.close(res);
                }
            });
        }
    }
};

ClassEditDialog.prototype.doSaveAndClose = function (classData, callback) {
    var thiz = this;
    $classAdminService.saveClassInfoAsync(classData, function (jobId) {
        thiz._onJobExecuted(jobId, function (results) {
            var classInfo = results.CLASS_INFO;
            if (classInfo) {
                callback({success: true, classData: classData});
            } else {
                thiz.handlerSaveClassError(results, function () {
                    classData.overrideInstructorDurationConflicts = true;
                    thiz.doSaveAndClose(classData, callback);
                }, false);
            }
        }, function (err) {
            Dialog.error("There was an error when saving this class.");
        }, "Saving...");
    }, function(err) {
        Dialog.error(err.errorMessage || "There was an error when saving this class.");
    });
};


ClassEditDialog.prototype.saveAndContinueHandler = function (options) {
    var classData = this.buildClassData();
    if(classData && classData.hasError) {
        delete classData.hasError;
        return;
    }

    if (classData && classData.hasSlotError && classData.errorMessage) {
        Dialog.error(classData.errorMessage, "", function() {});
        delete classData.hasSlotError;
        delete classData.errorMessage;
        return;
    }
    if(classData) {
        delete classData.hasError;
        var thiz = this;
        if (classData.id > 0 && classData.hasRegister > 0 && this.firstTimeDateStart
            && this.firstTimeDateStart.getTime() != classData.dateStart.getTime()) {
                Dialog.confirm("Changing class start date may affect scheduled " + "payment plan charges" + ". Are you sure you want to proceed?", "", "Continue", function() {
                    thiz.doSaveAndContinue(options, classData);
                }, "Cancel");
        } else {
            this.doSaveAndContinue(options, classData);
        }
    }
};

ClassEditDialog.prototype.doSaveAndContinue = function (options, classData) {
    if(classData) {
        delete classData.hasError;
        var thiz = this;
        var activeTabName = thiz.tabPane._getTabName(thiz.tabPane.getActiveTabPane());
        var activePaymentPlanKey = "";
        var ppOptions = null;
        var ppTabClazz = this.classEditPaymentPlanTab;
        if (options && options.openedPaymentPlanKey && thiz.classEditPaymentPlanTab) {
            activePaymentPlanKey = options.openedPaymentPlanKey;
            activeTabName = "paymentPlanTab";
            ppOptions = {openAssign: options.openAssign, activePaymentPlanKey: options.openedPaymentPlanKey};
        } else if(ppTabClazz && typeof(ppTabClazz.getFocusPaymentPlanKey) == "function") {
            activePaymentPlanKey = ppTabClazz.getFocusPaymentPlanKey();
        }
        if (options && options.reloadOneTime) {
            ppOptions = ppOptions || {};
            ppOptions.reloadOneTime = true;
        }
        $classAdminService.saveClassInfoAsync(classData, function (jobId) {
            thiz._onJobExecuted(jobId, function (results) {
                var classInfo = results.CLASS_INFO;
                if (classInfo) {
                    console.log("CLASS SAVE CONT/ SUBMIT DATA", classInfo, classData);
                    thiz.currentClassId = classInfo.id;
                    thiz._resetClassDialog();
                    thiz.options.activePaymentPlanKey = activePaymentPlanKey;
                    thiz.options.activeTab = activeTabName;
                    thiz._renderEditingClassInfo(classInfo, ppOptions);
                    thiz.reloadOnClose = true;

                    thiz.doOnAllAsyncTab(function (tab) {
                        if (tab.isClassDataChanged()) tab.save();
                    })
                } else {
                    thiz.handlerSaveClassError(results, function () {
                        classData.overrideInstructorDurationConflicts = true;
                        thiz.doSaveAndContinue(options, classData);
                    }, true);
                }
            }, function (err) {
                Dialog.error("There was an error when saving this class.");
            }, "Saving...");
        }, function(err) {
            Dialog.error("There was an error when saving this class.");
        });
    }
};


ClassEditDialog.prototype.saveAndCloneButtonClickHandler = function () {
    var thiz = this;
    if (!this.classEditGeneralTab) return;
    if (!this.classEditGeneralTab.generalData) return;
    var classData = thiz.buildClassData();
    var oldTile = this.classEditGeneralTab.generalData.title;
    var newTile = classData.title;
    var clonedClassTitle = newTile;
    if (oldTile === newTile) clonedClassTitle += " Clone";

    new ConfirmCloneClassDialog().callback(function(data) {
        if (!data) return;
        if(classData && classData.hasError) {
            delete classData.hasError;
            return;
        }
        if (classData && classData.hasSlotError && classData.errorMessage) {
            Dialog.error(classData.errorMessage, "", function() {});
            delete classData.hasSlotError;
            delete classData.errorMessage;
            return;
        }
        classData.title = data.clonedClassTitle;
        if (classData.hasRegister > 0 && thiz.firstTimeDateStart
            && thiz.firstTimeDateStart.getTime() != classData.dateStart.getTime()) {
                Dialog.confirm("Changing class start date may affect scheduled " + "payment plan charges" + ". Are you sure you want to proceed?", "", "Continue", function() {
                    thiz.saveAndClone(classData);
                }, "Cancel");
        } else {
            thiz.saveAndClone(classData);
        }
    }).open({clonedClassTitle: clonedClassTitle, showCloneButton: false});
};

ClassEditDialog.prototype.saveAndClone = function (classData) {
    var thiz = this;
    if (!classData) return;
    var oldClassId = classData.id;
    classData.id = 0;
    if (classData.oldThumnailFilePath && classData.oldThumnailFilePath == classData.thumbnailFilePath) {
        classData.thumbnailFilePath = "";
    }

    for(var i = 0; i < classData.slots.length; i++) {
        var s = classData.slots[i];
        s.id = 0;
        s.oldPregeneratingKey = "";
        for(var k in s.schedByWeekdayName) {
            var sched = s.schedByWeekdayName[k];
            sched.id = 0;
            sched.oldPregeneratingKey = "";
            for(var j = 0; j < sched.instructors.length; j++){
                sched.instructors[j].instructorId = 0;
            }
        }
    }
    if (classData && classData.paymentPlans && classData.paymentPlans.length) {
        classData.paymentPlans.forEach(function(cpp) {
            cpp.id = 0;
            cpp.assignedStudents = [];
            if (cpp.items && cpp.items.length) {
                cpp.items.forEach(function(item) {
                    item.id = 0;
                });
            }
        });
    }
    if (!classData) return;
    if (!this.classEditGeneralTab) return;
    if (!this.classEditGeneralTab.generalData) return;
    var oldTile = this.classEditGeneralTab.generalData.title;

    classData.overrideInstructorDurationConflicts = true;
    classData.clonedFrom = oldClassId;
    $classAdminService.saveClassInfoAsync(classData, function (jobId) {
        thiz._onJobExecuted(jobId, function (results) {
            var classInfo = results.CLASS_INFO;
            if (classInfo) {
                SnackBar.show("[" + oldTile + "] cloned to new class [" + classData.title + "]");
                thiz.gotoNewClass(classInfo.id);
                thiz.reloadOnClose = true;
                thiz.doOnAllAsyncTab(function(tab) {
                    if (typeof(tab.performClone) == "undefined") return;
                    tab.performClone(oldClassId, classInfo.id);
                })
            } else {
                Dialog.error("There was an error when cloning this class.", results.ERROR_MESSAGE || "");
            }
        }, function (err) {
            Dialog.error("There was an error when cloning this class.");
        }, "Saving...");
    }, function(err) {
        Dialog.error("There was an error when saving this class.");
    });
};

ClassEditDialog.prototype.cancelButtonClickHandler = function () {
    this.close();
};

ClassEditDialog.prototype.getClassData = function () {
    var classData = this.currentClass;
    classData.oldPregeneratingKey = this.currentClass.pregeneratingKey;
    var oldNoClassDays = classData.noClassDays? classData.noClassDays.concat() : [];

    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        this.classEditGeneralTab.updateClassData(classData);
        if (window.LOGIN_INFO.allowClassPaymentPlan) {
            this.classEditPaymentPlanTab.updateClassData(classData);
            this.classEditDiscountPlanTab.updateClassData(classData);
        }
        
        this.classEditQuestionTab.updateClassData(classData);
    }

    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)
        || ClassAuthUtils.canManageMyInstructorClassSchedule(window.LOGIN_INFO)) {
        this.classEditDateTimeTab.updateClassData(classData);
        var newNoClassDays = classData.noClassDays? classData.noClassDays.concat() : [];
        var isSameNoClassDays = ClassUtils.isSameObject({noClassDays: oldNoClassDays}, {noClassDays: newNoClassDays});
        if (!isSameNoClassDays) {
            classData.oldPregeneratingKey += "_NOCLASSDAYS";
        }
        this.classEditRegSlotTab.updateClassData(classData);
    }

    if (this.memberSizingListViewTab) {
        this.memberSizingListViewTab.updateClassData(classData);
    }

    return classData;
};

ClassEditDialog.prototype.validateFormData = function (ignoreError) {
    if (ignoreError) return true;
    var thiz = this;

    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        if(this.classEditGeneralTab.classTitle.value.trim().length == 0) {
            this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Class title"),
                this.generalInfoTab, this.classEditGeneralTab.classTitle);
            return false;
        }
        if(!this.classEditGeneralTab.statusCombo.getSelectedItem()) {
            this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Status"),
                this.generalInfoTab, this.classEditGeneralTab.statusCombo.node());
            return false;
        }
        if(!this.classEditGeneralTab.programCombo.getSelectedItem()) {
            this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Program"),
                this.generalInfoTab, this.classEditGeneralTab.programCombo.node());
            return false;
        }
        if(!this.classEditGeneralTab.subProgramCombo.getSelectedItem()) {
            this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Sub Program"),
                this.generalInfoTab, this.classEditGeneralTab.subProgramCombo.node());
            return false;
        }
        if(this.classEditGeneralTab.allowRegisterCall.checked) {
            if(this.classEditGeneralTab.registerCallText.value.trim().length == 0) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Custom text"),
                    this.generalInfoTab, this.classEditGeneralTab.registerCallText);
                return false;
            }
        }

        if (this.classEditGeneralTab.allowRegisterCall.checked && this.classEditGeneralTab.showRegisterCallInstruction.checked) {
            if(this.classEditGeneralTab.registerCallInstruction.value.trim().length == 0) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "instructions"),
                    this.generalInfoTab, this.classEditGeneralTab.registerCallInstruction);
                return false;
            }
        }

        if (this.classEditGeneralTab.allowRegisterCall.checked && this.classEditGeneralTab.showLinkToExternalPage.checked) {
            var errorMsg = "";
            var link = this.classEditGeneralTab.linkExternalPage.value;
            if (link.trim().length == 0) {
                errorMsg = String.format("[{0}] is a required field; please do not leave blank.", "Link External Page");
            } else if (!ValidationManager.patterns.RELATIVE_URL_REGEX.test(link)) {
                if (!link.startsWith('https://') && !link.startsWith('http://')) {
                    errorMsg = String.format("[{0}] is a required field; please enter the link with http:\/\/ or https:\/\/ prefix.", "Link External Page");
                } else {
                    errorMsg = String.format("[{0}] is a required field; please enter the correct url format.", "Link External Page");
                }
            }
            if (errorMsg) {
                this.showErrorMessage(errorMsg, this.generalInfoTab, this.classEditGeneralTab.linkExternalPage);
                return false;
            }
        }

        var isAgeLimitInputIntegerValue = function (inputNode, maxValue) {
            var value = inputNode.value;
            if (value.length > 0 && !isNaN(value)) {
                var floatValue = parseFloat(value);
                if (!Number.isInteger(floatValue)) return false;
                if (maxValue && parseInt(value) > maxValue) return false;
            }
            return true;
        }

        if (!isAgeLimitInputIntegerValue(this.classEditGeneralTab.studentAgeLimitLowYear)) {
            this.showErrorMessage(String.format("{0} must be an integer.", "Athlete Age Limit Low Year"), this.generalInfoTab, this.classEditGeneralTab.studentAgeLimitLowYear);
            return false;
        }
        if (!isAgeLimitInputIntegerValue(this.classEditGeneralTab.studentAgeLimitLowMonth, 11)) {
            this.showErrorMessage(String.format("{0} must be an integer and less than or equal to 11.", "Athlete Age Limit Low Month"), this.generalInfoTab, this.classEditGeneralTab.studentAgeLimitLowMonth);
            return false;
        }

        if (!isAgeLimitInputIntegerValue(this.classEditGeneralTab.studentAgeLimitHighYear)) {
            this.showErrorMessage(String.format("{0} must be an integer.", "Athlete Age Limit High Year"), this.generalInfoTab, this.classEditGeneralTab.studentAgeLimitHighYear);
            return false;
        }
        if (!isAgeLimitInputIntegerValue(this.classEditGeneralTab.studentAgeLimitHighMonth, 11)) {
            this.showErrorMessage(String.format("{0} must be an integer and less than or equal to 11.", "Athlete Age Limit High Month"), this.generalInfoTab, this.classEditGeneralTab.studentAgeLimitHighMonth);
            return false;
        }

        var ageLowInMonth = this.classEditGeneralTab.getStudentAgeLimitValueInMonth("low", false);
        var ageHiInMonth = this.classEditGeneralTab.getStudentAgeLimitValueInMonth("high", false);
        if (ageLowInMonth != null && ageHiInMonth != null && ageLowInMonth > ageHiInMonth) {
            this.showErrorMessage(String.format("[{0}] must be less than [Athlete Age Limit High].", "Athlete Age Limit Low"),
                this.generalInfoTab, this.classEditGeneralTab.studentAgeLimitLowYear);
                return false;
        }
        var limitGenderTypes = (this.filters.limitGenders || []).map((g) => g.type);
        var genderValues = this.classEditGeneralTab.gendersSelectBox.getValues();
        if (limitGenderTypes.length && genderValues.length && !genderValues.every((g) => limitGenderTypes.includes(g))) {
            this.showErrorMessage(
                "Class is limited to genders not supported by this organization. Please update the genders limited to register for this class.",
                this.generalInfoTab,
                this.classEditGeneralTab.gendersSelectBox.statusBox
            );
            return false;
        }
    }

    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)
        || ClassAuthUtils.canManageMyInstructorClassSchedule(window.LOGIN_INFO)) {
            if (this.currentClassId && !this.classEditDateTimeTab.classStartDate.getDate()) {
                this.showErrorMessage(String.format("[{0}] cannot be later than a member\u2019s registration date for this class", "Class Start Date"),
                    this.dateTimeInfoTab, this.classEditDateTimeTab.classStartDate.input);
                return false;
            }

            if(!this.classEditDateTimeTab.classStartDate.getDate()) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Class Start Date"),
                    this.dateTimeInfoTab, this.classEditDateTimeTab.classStartDate.input);
                return false;
            }

            if (this.currentClassId && !this.classEditDateTimeTab.classEndDate.getDate()) {
                this.showErrorMessage(String.format("[{0}] cannot be earlier than a member\u2019s registration date for this class", "Class End Date"),
                    this.dateTimeInfoTab, this.classEditDateTimeTab.classEndDate.input);
                return false;
            }
            if(!this.classEditDateTimeTab.classEndDate.getDate()) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Class End Date"),
                    this.dateTimeInfoTab, this.classEditDateTimeTab.classEndDate.input);
                return false;
            }
            var classEndDate = new Date(this.classEditDateTimeTab.classEndDate.getDate().getTime());
            classEndDate.setHours(23, 59, 59, 00);

            var classStartDate = this.classEditDateTimeTab.classStartDate.getDate(),
                displayStarting = this.classEditDateTimeTab.displayStarting.getDate(),
                registrationStartDate = this.classEditDateTimeTab.registrationStartDate.getDate(),
                registrationEndDate = this.classEditDateTimeTab.registrationEndDate.getDate(),
                forReturningMembersStartDate = this.classEditDateTimeTab.forReturningMembersStartDate.getDate(),
                forReturningMembersEndDate = this.classEditDateTimeTab.forReturningMembersEndDate.getDate(),
                forNewMembersStartDate = this.classEditDateTimeTab.forNewMembersStartDate.getDate(),
                forNewMembersEndDate = this.classEditDateTimeTab.forNewMembersEndDate.getDate();

            if(classStartDate.getTime() > classEndDate.getTime()) {
                this.showErrorMessage("[Class Start Date] must be earlier than the end of Class.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.classStartDate.input);
                return false;
            }
            if(!displayStarting) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Display Starting From Date"),
                    this.dateTimeInfoTab, this.classEditDateTimeTab.displayStarting.input);
                return false;
            }
            if(displayStarting.getTime() > classEndDate.getTime()) {
                this.showErrorMessage("[Display Starting From Date] must be earlier than the end of Class.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.displayStarting.input);
                return false;
            }
            if(this.classEditDateTimeTab.classLength.value.trim().length <= 0) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Class Length"),
                    this.dateTimeInfoTab, this.classEditDateTimeTab.classLength);
                return false;
            }
            if(!registrationStartDate) {
                this.showErrorMessage(String.format("[{0}] Start Date is a required field; please enter the correct value.", "Class Registration"),
                this.dateTimeInfoTab, this.classEditDateTimeTab.registrationStartDate.input);
                return false;
            }
            if(registrationStartDate.getTime() > classEndDate.getTime()) {
                this.showErrorMessage("[Class Registration] Start Date must be earlier than the end of Class.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.registrationStartDate.input);
                return false;
            }
            if(displayStarting.getTime() > registrationStartDate.getTime()) {
                this.showErrorMessage("[Display starting from] must be earlier than or equal to Start Date of [Open for Registration].",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.displayStarting.input);
                return false;
            }
            if(!registrationEndDate) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "Class Registration End Date"),
                    this.dateTimeInfoTab, this.classEditDateTimeTab.registrationEndDate.input);
                return false;
            }
            if(registrationEndDate.getTime() > classEndDate.getTime()) {
                this.showErrorMessage("[Class Registration] End Date must be earlier than the end of Class.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.registrationEndDate.input);
                return false;
            }
            if(registrationStartDate.getTime() > registrationEndDate.getTime()) {
                this.showErrorMessage("[Class Registration] Start Date must be earlier than the end of Class Registration.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.registrationStartDate.input);
                return false;
            }
            if(forReturningMembersStartDate && forReturningMembersStartDate.getTime() < registrationStartDate.getTime()) {
                this.showErrorMessage("[Open for Return Members] Start Date must be later than or equal to Start Date of [Open for Registration].",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forReturningMembersStartDate.input);
                return false;
            }
            if(forReturningMembersEndDate && forReturningMembersEndDate.getTime() > registrationEndDate.getTime()) {
                this.showErrorMessage("[Open for Return Members] End Date must be earlier than or equal to End Date of [Open for Registration].",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forReturningMembersEndDate.input);
                return false;
            }
            if(forReturningMembersStartDate && forReturningMembersEndDate && forReturningMembersStartDate.getTime() > forReturningMembersEndDate.getTime()) {
                this.showErrorMessage("[Open for Return Members] Start Date must be earlier than the end of Open for Return Members.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forReturningMembersStartDate.input);
                return false;
            }
            if(forNewMembersStartDate && forNewMembersEndDate && forNewMembersStartDate.getTime() > forNewMembersEndDate.getTime()) {
                this.showErrorMessage("[Open for New Members] Start Date must be earlier than the end of Open for New Members.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forNewMembersStartDate.input);
                return false;
            }
            if(forNewMembersStartDate && forNewMembersStartDate.getTime() < registrationStartDate.getTime()) {
                this.showErrorMessage("[Open for Return Members] Start Date must be later than or equal to Start Date of [Open for Registration].",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forNewMembersStartDate.input);
                return false;
            }
            if(forNewMembersEndDate && forNewMembersEndDate.getTime() > registrationEndDate.getTime()) {
                this.showErrorMessage("[Open for New Members] End Date must be earlier than or equal to End Date [Open for Registration].",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forNewMembersEndDate.input);
                return false;
            }
            if(forReturningMembersStartDate && !forReturningMembersEndDate) {
                this.showErrorMessage("[Open for Returning Members] End Date is a required field; please enter the correct value.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forReturningMembersEndDate.input);
                return false;
            }
            if(!forReturningMembersStartDate && forReturningMembersEndDate) {
                this.showErrorMessage("[Open for Returning Members] Start Date is a required field; please enter the correct value.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forReturningMembersStartDate.input);
                return false;
            }
            if(forNewMembersStartDate && !forNewMembersEndDate) {
                this.showErrorMessage("[Open for New Members] End Date is a required field; please enter the correct value.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forNewMembersEndDate.input);
                return false;
            }
            if(!forNewMembersStartDate && forNewMembersEndDate) {
                this.showErrorMessage("[Open for New Members] Start Date is a required field; please enter the correct value.",
                    this.dateTimeInfoTab, this.classEditDateTimeTab.forNewMembersStartDate.input);
                return false;
            }
    }


    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        if (window.LOGIN_INFO.allowClassPaymentPlan) {
            if(this.classEditPaymentPlanTab) {
                if(!this.classEditPaymentPlanTab.validateClassData()) {
                    return false;
                }
            }
        }
    }

    if(this.currentClass.editable) return true;
    if(this.currentClass.totalSlotRegister > 0 && this.classEditGeneralTab.statusCombo.getSelectedItem()
        && this.classEditGeneralTab.statusCombo.getSelectedItem().id == 0) {
        this.classEditGeneralTab.statusCombo.selectItemByKey("id", 1);
        Dialog.error("", "Cannot set this class status to OFF when there are registered members.", null);
        return false;
    }
    return true;

};

ClassEditDialog.prototype.showErrorMessage = function (message, activeTab, inputToFocus) {
    var thiz = this;
    Dialog.error(message, "", function() {
        thiz.tabPane.setActiveTabPane(activeTab);
        if(inputToFocus) {
            window.setTimeout(function() {
                inputToFocus.focus();
            }, 200);
        }
    });
};

ClassEditDialog.prototype.indexActionNextClickHandler = function () {
    var thiz = this;
    if (this.isClassDataChanged()) {
        Dialog.confirm("The class has changed but unsaved. Would you like to save the changes of class?", "", "YES", function() {
            var classData = thiz.buildClassData();
            if(classData && classData.hasError) {
                delete classData.hasError;
                return;
            }
            if (classData && classData.hasSlotError && classData.errorMessage) {
                Dialog.error(classData.errorMessage, "", function() {});
                delete classData.hasSlotError;
                delete classData.errorMessage;
                return;
            }

            if(classData) {
                delete classData.hasError;
                thiz.reloadOnClose = true;
                $classAdminService.saveClassInfoAsync(classData, function(jobId) {
                    thiz._onJobExecuted(jobId, function (results) {
                        var classInfo = results.CLASS_INFO;
                        console.log(results);
                        if (classInfo) {
                            thiz.updateMemberClassesComboItems(classInfo);
                            thiz.gotoNext();
                        } else {
                            thiz.handlerSaveClassError(results, function () {
                                classData.overrideInstructorDurationConflicts = true;
                                thiz.doSaveAndContinue(options, classData);
                            }, true);
                        }
                    }, function (err) {
                        Dialog.error("There was an error when saving this class.");
                    }, "Saving...");
                }, function(err) {
                    Dialog.error("There was an error when cloning this class.");
                });
            } else {
                thiz.classesCombo.selectItemByKey("id", thiz.options.ids[thiz.classIdIndex]);
            }
        }, "NO", function() {
            thiz.gotoNext();
        });
    } else {
        this.gotoNext();
    }
};

ClassEditDialog.prototype.gotoNext = function () {
    if(this.classIdIndex == this.options.ids.length - 1) return;
    this.classIdIndex ++;
    this.classesCombo.selectItemByKey("id", this.options.ids[this.classIdIndex]);
    var tabName = this.tabPane._getTabName(this.tabPane.getActiveTabPane());
    this.options.activeTab = tabName;
    this.renderClassEditDialog(this.filters, this.options.ids, this.classIdIndex, null, true);
}

ClassEditDialog.prototype.indexActionPrevClickHandler = function () {
    var thiz = this;
    if (this.isClassDataChanged()) {
        Dialog.confirm("The class has changed but unsaved. Would you like to save the changes of class?", "", "YES", function() {
            var classData = thiz.buildClassData();
            if(classData && classData.hasError) {
                delete classData.hasError;
                return;
            }

            if (classData && classData.hasSlotError && classData.errorMessage) {
                Dialog.error(classData.errorMessage, "", function() {});
                delete classData.hasSlotError;
                delete classData.errorMessage;
                return;
            }

            if(classData) {
                delete classData.hasError;
                thiz.reloadOnClose = true;
                $classAdminService.saveClassInfoAsync(classData, function (jobId) {
                    thiz._onJobExecuted(jobId, function (results) {
                        var classInfo = results.CLASS_INFO;
                        if (classInfo) {
                            thiz.updateMemberClassesComboItems(classInfo);
                            thiz.gotoPrev();
                        } else {
                            thiz.handlerSaveClassError(results, function () {
                                classData.overrideInstructorDurationConflicts = true;
                                thiz.doSaveAndContinue(options, classData);
                            }, true);
                        }
                    }, function (err) {
                        Dialog.error("There was an error when saving this class.");
                    }, "Saving...");
                }, function(err) {
                    Dialog.error("There was an error when saving this class.");
                });
            } else {
                thiz.classesCombo.selectItemByKey("id", thiz.options.ids[thiz.classIdIndex]);
            }
        }, "NO", function() {
            thiz.gotoPrev();
        });
    } else {
        this.gotoPrev();
    }
};
ClassEditDialog.prototype.gotoPrev = function () {
    if(this.classIdIndex == 0) return;
    this.classIdIndex --;
    this.classesCombo.selectItemByKey("id", this.options.ids[this.classIdIndex]);
    var tabName = this.tabPane._getTabName(this.tabPane.getActiveTabPane());
    this.options.activeTab = tabName;
    this.renderClassEditDialog(this.filters, this.options.ids, this.classIdIndex, null, true);
};

ClassEditDialog.prototype.classesComboChangeHandler = function () {
    if(!this.classesCombo.selectedItem) return;
    var classId = this.classesCombo.selectedItem.id;
    if(!this.options.ids) return;
    var classIdIndex = this.options.ids.indexOf(classId);
    if(classIdIndex == this.classIdIndex) return;
    var thiz = this;

    if (this.isClassDataChanged()) {
        Dialog.confirm("The class has changed but unsaved. Would you like to save the changes of class?", "", "YES", function() {
            var classData = thiz.buildClassData();
            if(classData && classData.hasError) {
                delete classData.hasError;
                return;
            }

            if (classData && classData.hasSlotError && classData.errorMessage) {
                Dialog.error(classData.errorMessage, "", function() {});
                delete classData.hasSlotError;
                delete classData.errorMessage;
                return;
            }

            if(classData) {
                delete classData.hasError;
                thiz.reloadOnClose = true;
                $classAdminService.saveClassInfoAsync(classData, function (jobId) {
                    thiz._onJobExecuted(jobId, function (results) {
                        var classInfo = results.CLASS_INFO;
                        if (classInfo) {
                            thiz.gotoSelectedClass();
                            thiz.updateMemberClassesComboItems(classInfo);
                        } else {
                            thiz.handlerSaveClassError(results, function () {
                                classData.overrideInstructorDurationConflicts = true;
                                thiz.doSaveAndContinue(options, classData);
                            }, true);
                        }
                    }, function (err) {
                        Dialog.error("There was an error when saving this class.");
                    }, "Saving...");
                }, function(err) {
                    Dialog.error("There was an error when saving this class.");
                });
            } else {
                thiz.classesCombo.selectItemByKey("id", thiz.options.ids[thiz.classIdIndex]);
            }
        }, "NO", function() {
            thiz.gotoSelectedClass();
        });
    } else {
        this.gotoSelectedClass();
    }
};

ClassEditDialog.prototype.gotoSelectedClass = function () {
    var classId = this.classesCombo.selectedItem.id;
    if(!this.options.ids) return;
    var classIdIndex = this.options.ids.indexOf(classId);
    if(classIdIndex == this.classIdIndex) return;
    this.classIdIndex = classIdIndex ? classIdIndex : 0
    var tabName = this.tabPane._getTabName(this.tabPane.getActiveTabPane());
    this.options.activeTab = tabName;
    this.renderClassEditDialog(this.filters, this.options.ids, this.classIdIndex, null, true);
};

ClassEditDialog.prototype.allowWaitListChangeHandler = function (e) {
    var regSlotTab = this.classEditRegSlotTab;
    if (!regSlotTab) return;
    regSlotTab._allowWaitlist = e.target.checked;
    var slotContentTable = regSlotTab.slotContentTable;
    if (!slotContentTable) return;
    var waitlistLimitInputs = slotContentTable.getElementsByClassName("WaitlistLimitInput");
    if (waitlistLimitInputs && waitlistLimitInputs.length > 0) {
        if (e.target.checked) {
            for ( var i = 0; i < waitlistLimitInputs.length; i ++) {
                waitlistLimitInputs[i].removeAttribute("disabled");
            }
        } else {
            for ( var i = 0; i < waitlistLimitInputs.length; i ++) {
                waitlistLimitInputs[i].value = 0;
                waitlistLimitInputs[i].setAttribute("disabled", "disabled");
            }
        }
    }
};

ClassEditDialog.prototype.isClassDataChanged = function () {
    var generalDataChanged = false;
    var paymentPlanDataChanged = false;
    var discountPlanDataChanged = false;
    var feeDataChanged = false;
    var slotDataChanged = false;
    var dateTimeDataChanged = false;
    var registrationChanged = false;
    var questionDataChanged = false;
    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        generalDataChanged = this.classEditGeneralTab.isDataChanged();
        if (window.LOGIN_INFO.allowClassPaymentPlan) {
            if (this.classEditPaymentPlanTab) {
                paymentPlanDataChanged = this.classEditPaymentPlanTab.isClassDataChanged();
                discountPlanDataChanged = this.classEditDiscountPlanTab.isClassDataChanged();
            }
        }
        questionDataChanged = this.classEditQuestionTab.isClassDataChanged();
    }

    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)
        || ClassAuthUtils.canManageMyInstructorClassSchedule(window.LOGIN_INFO)) {

        dateTimeDataChanged = this.classEditDateTimeTab.isDataChanged();
        slotDataChanged = this.classEditRegSlotTab.isDataChanged();
    }

    var asyncTabsChanged = false;
    this.doOnAllAsyncTab(function(tab) {
        if (asyncTabsChanged) return;
        if (typeof(tab.isClassDataChanged) == "undefined") return;
        asyncTabsChanged = tab.isClassDataChanged();
    });


    registrationChanged = this.registrationTab && typeof(this.registrationTab.isDataChanged) == "function"? this.registrationTab.isDataChanged() : false;
    if(registrationChanged) {
        this.reloadOnClose = true;
    }
    if (window.LOGIN_INFO.allowCostume) {
        var costumeChanged = this.costumeListViewTab && typeof(this.costumeListViewTab.isDataChanged) == "function"? this.costumeListViewTab.isDataChanged() : false;
        if (costumeChanged) {
            this.reloadOnClose = true;
        }
    }
    var attendanceChanged = false;
    return (generalDataChanged || dateTimeDataChanged || feeDataChanged || slotDataChanged
            || paymentPlanDataChanged || discountPlanDataChanged || attendanceChanged || asyncTabsChanged || questionDataChanged);
};

ClassEditDialog.prototype.updateMemberClassesComboItems = function (item) {
    if (!this.options) return;
    if (!this.options.memberClasses) return;
    for (var i = 0; i < this.options.memberClasses.length; i ++) {
        var memberClass = this.options.memberClasses[i];
        if (memberClass.id == item.id) {
            memberClass.title = item.title;
            this.classesCombo.setItems(this.options.memberClasses, true);
            break;
        }
    }
};

ClassEditDialog.prototype.getTimezoneCallback = function() {
    if (this.classEditDateTimeTab) {
        return this.classEditDateTimeTab.getTimezoneId();
    }
    return null;
}

ClassEditDialog.prototype.invalidateActionButtons = function () {
    var previousTabCond = this.previousTab == "registrationTab";
    previousTabCond = previousTabCond || this.previousTab == "attendanceTab"
                                      || (this.previousTab == "costumesTab" && this.currentClass.id > 0);
    if (previousTabCond) return false;
    return true;
};

ClassEditDialog.prototype.invalidateExtraActionButtons = function () {
    var previousTabCond = this.previousTab == "registrationTab";

    previousTabCond = previousTabCond || this.previousTab == "attendanceTab";
    previousTabCond = previousTabCond || this.previousTab == "costumesTab";
    previousTabCond = previousTabCond || this.previousTab == "sizesTab";

    if (previousTabCond) return false;
    return true;
};

ClassEditDialog.prototype.invalidateSaveAttendanceButtons = function () {
    if (this.previousTab == "attendanceTab") return true;
    return false;
};

ClassEditDialog.prototype.onHide = function() {
    CommonEvent.removeEvent(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED, this._reload);
};

ClassEditDialog.prototype.saveAttendanceHandler = function () {
    if (!this.trackAttendanceTab) return;
    this.trackAttendanceTab.updateAttendanceHandler(null, true);
};

ClassEditDialog.prototype.updatePaymentPlanItemTimezone = function (oldTimezoneId, newTimezoneId) {
    if (this.classEditPaymentPlanTab) {
        this.classEditPaymentPlanTab.updatePaymentPlanItemTimezone(this.currentClass.paymentPlans, oldTimezoneId, newTimezoneId);
    }
};

ClassEditDialog.prototype.validatePaymentPlanItems = function (classData) {
    var hasError = false, errorHtml = "", errorMsg = "", hasDueDateError = false;;
    var paymentPlans = classData.paymentPlans;
    var minDate = classData.dateStart;
    if (classData.date4Register && classData.dateStart && classData.date4Register.getTime() < classData.dateStart.getTime()) {
        minDate = classData.date4Register;
    }
    var maxDate = classData.dateEnd;
    var numberPpError = 0;
    var MAX_ITEMS = 5;
    var numberErrorItems = 1;
    if (paymentPlans && paymentPlans.length > 0) {
        for (var i = 0; i < paymentPlans.length; i++) {
            var paymentPlan = paymentPlans[i];
            var planError = "<div class=\"ClassPaymentPlan Error ChargeDate\">Payment plan <strong>" + paymentPlan.name + "</strong> </br><ul>";
            var planHasError = false;
            for (var j = 0; j < paymentPlan.items.length; j++) {
                var paymentPlanItem = paymentPlan.items[j];
                if (paymentPlanItem.manualChargeDates && paymentPlanItem.manualChargeDates.length > 0) {
                    var itemError = "";
                    for (var k = 0; k < paymentPlanItem.manualChargeDates.length; k++) {
                        var manualChargeDate = paymentPlanItem.manualChargeDates[k];
                        var invalidChargeDate = manualChargeDate.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE
                                        && manualChargeDate.specificChargeDate
                                        && (manualChargeDate.specificChargeDate.getTime() < minDate.getTime()
                                                || manualChargeDate.specificChargeDate.getTime() > maxDate.getTime());

                        var invalidDueDate = manualChargeDate.dueTimeType == ClassUtils.DUE_TIME_TYPE.SPECIFIC_DATE
                                        && manualChargeDate.specificDueDate
                                        && (manualChargeDate.specificDueDate.getTime() < minDate.getTime()
                                                || manualChargeDate.specificDueDate.getTime() > maxDate.getTime());

                        console.log("manualChargeDate", manualChargeDate, invalidChargeDate, invalidDueDate);

                        if (invalidChargeDate || invalidDueDate){
                            var chargeDate = FormatUtil.formatDateWithTZID(manualChargeDate.specificChargeDate, "date_standard", classData.timezoneId);
                            var dueDate = invalidDueDate?  FormatUtil.formatDateWithTZID(manualChargeDate.specificDueDate, "date_standard", classData.timezoneId) : "";
                            hasDueDateError = !invalidDueDate;
                            if (itemError) itemError += "; ";
                            itemError += "Charge date: " + chargeDate + (dueDate? " (Due date: " + dueDate + ")" : "");
                            hasError = true;
                            planHasError = true;
                        }
                    }
                    if (itemError) {
                        itemError = "<strong>" + paymentPlanItem.name + "</strong>: " + itemError;
                        planError += "<li>" + itemError + "</li>";
                        numberErrorItems++;
                        if (numberErrorItems >= MAX_ITEMS) break;
                    }
                    console.log("item", numberErrorItems, numberErrorItems >= MAX_ITEMS, itemError);

                }
                if (numberErrorItems >= MAX_ITEMS) break;
            }
            planError += "</ul></div>";
            if (planHasError) {
                errorMsg += planError;
                numberPpError++;
            }
            console.log("planError", numberPpError, planError);
        }

        if (hasError) {
            var minDateText = FormatUtil.formatDateWithTZID(minDate, "date_standard", classData.timezoneId);
            var maxDateText = FormatUtil.formatDateWithTZID(maxDate, "date_standard", classData.timezoneId);
            var extra = "invalid Change Date(s) " + (hasDueDateError? " and Due Date(s)" : "") + ". They must be from " + minDateText+ " to " + maxDateText;
            if (numberPpError > 1 || (numberErrorItems >= MAX_ITEMS)) {
                extra = "Some payment plans have " + extra;
            } else {
                extra = "This payment plan below has " + extra;
            }
            errorMsg = "<p><strong>" + extra + "</strong></p></br>" + errorMsg;
            if (numberErrorItems >= MAX_ITEMS) {
                errorMsg += "and more...</br>";
            }
            errorHtml = errorMsg;
        }
    }
    return {
        hasError: hasError,
        errorMessage: errorHtml
    }
};

ClassEditDialog.prototype.startEndDateUpdatedHandler = function (event) {
    if (!window.LOGIN_INFO.allowClassPaymentPlan) return;
    if (!event.selectedDate) return;
    var thiz = this;
    var classData = {
        paymentPlans: thiz.currentClass.paymentPlans
    };
    this.classEditDateTimeTab.updateClassData(classData);
    this.classEditPaymentPlanTab.updateClassData(classData);

    var paymentPlanItemsError = this.validatePaymentPlanItems(classData);
    var extra = "";
    if (paymentPlanItemsError.hasError) {
        if (event.fieldName == "registrationStartDate") {
            extra = "Open for Registration will be reloaded";
        } else if (event.fieldName == "classStartDate") {
            extra = "Class Start Date will be reloaded";
        } else if (event.fieldName == "classEndDate") {
            extra = "Class End Date will be reloaded";
        } else {
            extra += "This class will be reloaded."
        }
        extra = paymentPlanItemsError.errorMessage + "</br>" + "<strong>" + extra + "</strong>";
        Dialog.alertHtmlMessage("Error", extra, function () {
            thiz.classEditDateTimeTab[event.fieldName].setDate(thiz.classEditDateTimeTab[event.fieldName]._lastGoodValue);
        });
    } else {
        thiz.classEditDateTimeTab[event.fieldName]._lastGoodValue = event.selectedDate;
    }
};

ClassEditDialog.prototype.gotoNewClass = function (classId) {
    if (this.options.ids) this.options.ids.push(classId);
    this.classIdIndex = this.options.ids.length - 1;
    var tabName = this.tabPane._getTabName(this.tabPane.getActiveTabPane());
    this.options.activeTab = tabName;
    this.renderClassEditDialog(this.filters, this.options.ids, this.classIdIndex, null, true);
}

ClassEditDialog.prototype._onJobExecuted = function(jobId, onSuccess, onError, executingMessage) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var busyIndicator = new Spinner(executingMessage);
    busyIndicator.busy();

    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                        busyIndicator.done();
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        busyIndicator.done();
                        onError({errorMessage: job.errorMessage});
                    }
                } else {
                    busyIndicator.done();
                    onFailed({errorMessage: "Job not found."});
                }
            }, function (error) {
                busyIndicator.done();
                onFailed(error);
            });
        }, 1000);
    })();
};

ClassEditDialog.prototype.validateUIWithPermission = function () {
    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) return;
    var isMyInstructorAssigned = ClassUtils.isMyInstructorAssigned(this.currentClass, LOGIN_INFO.accountId);
    if (!isMyInstructorAssigned || !ClassAuthUtils.canManageMyInstructorClass(LOGIN_INFO)) {
        Dialog.error("Access Denied", "The operation you requested was denied by the system. This may be caused by a system restriction or due to insufficient privileges.");
        this.close();
        return;
    }

    var activeTab = "generalInfoTab";
    if (!ClassAuthUtils.canViewMyInstructorClassGeneralInfo(window.LOGIN_INFO)) {
        this.hideTabByName("generalInfoTab");
        activeTab = "dateTimeInfoTab";
    }

    if (!ClassAuthUtils.canManageMyInstructorClassSchedule(window.LOGIN_INFO)) {
        this.hideTabByName("dateTimeInfoTab");
        this.hideTabByName("regSlotTab");
        if (activeTab == "dateTimeInfoTab") {
            activeTab = "discountPlanTab";
        }
    }

    if (!ClassAuthUtils.canViewMyInstructorClassPaymentInfo(window.LOGIN_INFO)) {
        this.hideTabByName("discountPlanTab");
        this.hideTabByName("paymentPlanTab");
        if (activeTab == "discountPlanTab") {
            activeTab = "registrationTab";
        }
    }

    if (!ClassAuthUtils.canViewClassRegistration(window.LOGIN_INFO)
        && !ClassAuthUtils.canViewClassMyInstructorClassRegistration(window.LOGIN_INFO)) {
        this.hideTabByName("registrationTab");
        if (activeTab == "registrationTab") {
            activeTab = "";
        }
    }
    
    this.hideTabByName("questionTab");

    var thiz = this;
    if (activeTab == "") {
        Dom.hide(this.generalInfoTabContent);
    } else if (activeTab != "generalInfoTab") {
        setTimeout(function(){
            thiz.tabPane.setActiveTabPane(thiz[activeTab]);
        }, 500);
    }
};

ClassEditDialog.prototype.hideTabByName = function (tabName) {
    var tabPane = this.tabPane.getTabs().filter(function(tab) {
        return tab.contentNode.getAttribute("tab-name") == tabName;
    })[0];
    if (tabPane) Dom.hide(tabPane.header);
};

ClassEditDialog.prototype.handlerSaveClassError = function (results, callback, reloadClass) {
    var thiz = this;
    if (results.ERROR_CODE == ClassEditDialog.ERROR_CODE.INSTRUCTOR_NOT_AVAILABLE
        || results.ERROR_CODE == ClassEditDialog.ERROR_CODE.CONFLICT_TIME
        || results.ERROR_CODE == ClassEditDialog.ERROR_CODE.NOT_FULL_DURATION) {
        Dialog.confirmHtmlMessage("", results.ERROR_MESSAGE.replaceAll("\n","<br>"), "Continue Saving", function() {
            if (callback) callback();
        }, "Cancel");
        return;
    }

    if (results.ERROR_CODE == ClassEditDialog.ERROR_CODE.DELETE_PAYMENT_PLAN) {
        if (reloadClass) {
            Dialog.error(results.ERROR_MESSAGE,  "This class cannot be saved and will be reloaded.", function() {
                thiz.reload();
            });
            return;
        } else {
            Dialog.error(results.ERROR_MESSAGE,  "The class cannot be saved.", function() {});
            return;
        }
    }
    
    if (results.ERROR_CODE == "SAVING_CLASS") {
        var msg = String.format("This class cannot be saved{0}.", reloadClass && " and will be reloaded" || "");
        Dialog.error(msg, results.ERROR_MESSAGE, function () {
            reloadClass && thiz.reload();
        });
        return;
    }
    Dialog.error("There was an error when saving this class.");
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditDiscountPlanTab.js";

function ClassEditDiscountPlanTab(options) {
    BaseTemplatedWidget.call(this);
    this.loaded = false;
    this.classInfo = options.data;
    this.selectedDiscountPlanId = 0;
    this.discountPlanList = [];
    this.updatedData = {discountPlanId: 0};
    this.discountPlanCombo.useHtml = true;
    this.discountPlanCombo.setPopupClass("DiscountPlansPopup");
    this.discountPlanCombo.renderer = function(item) {
        var html = "<vbox class=\"InfoGroup\">"
                + "<hbox class=\"DiscountPlanName\">" + item.name + "</hbox>"
                + "<hbox>"
                + "<span>Multi-Class Discount:"
                + "<span class=\"DisplayValue " + (item.allowMultiClassDiscount ? "" : "OFF") + "\">" + (item.allowMultiClassDiscount ? "Yes" : "No")
                + "</span></span>"
                + "<span> - Multi-Athlete Discount:"
                + "<span class=\"DisplayValue " + (item.allowMultiStudentDiscount ? "" : "OFF") + "\">" + (item.allowMultiStudentDiscount ? "Yes" : "No")
                + "</span></span>"
                + "<span> - Coupons: "
                + "<span class=\"DisplayValue " + (item.allowCoupon ? "" : "OFF") + "\">" + (item.allowCoupon ? "Yes" : "No")
                + "</span></span>"
                + "</hbox>"
                + "</vbox>";
        return html;
    };
    this.discountPlanCombo.comparer = Util.sameId;

    var thiz = this;
    this.bind("click", function(event) {
        this.toggleDiscountPlanOption(event.target.value);
    }.bind(this), this.overrideSubProgDiscountPlanItem);
    this.bind("click", function(event) {
        this.toggleDiscountPlanOption(event.target.value);
    }.bind(this), this.useCustomDiscountPlanItem);
    this.bind("click", function(event) {
        this.toggleDiscountPlanOption(event.target.value);
    }.bind(this), this.useNoDiscountPlan);

    this.bind("click", function(target) {
        var filterPlan = thiz.discountPlanList.filter(function(plan) {
            return plan.id == thiz.classInfo.subProgDiscountPlanId;
        });
        if (filterPlan && filterPlan.length) {
            thiz.editDiscountPlanButtonClickHandler(filterPlan[0]);
        }
    }, this.editSubProgDiscountPlanLink);
    this.bind("click", function() {
        var discountPlan = thiz.discountPlanCombo.getSelectedItem();
        thiz.editDiscountPlanButtonClickHandler(discountPlan);
    }, this.editDiscountPlanButton);
    this.bind("click", function() {
        thiz.editDiscountPlanButtonClickHandler({
            key: Util.newUUID(),
            allowMultiClassDiscount: true,
            allowMultiStudentDiscount: true,
            allowCoupon: true,
            classDiscountItems: [],
            athleteDiscountItems: []
        });
    }, this.newDiscountPlanButton);
    this.bind("p:ItemSelected", function (event) {
        if (!event.fromUser) return;
        thiz.updatedData.discountPlanId = thiz.discountPlanCombo.getSelectedItem().id;
        console.log("## discountPlan change: ", thiz.updatedData.discountPlanId);
    }, this.discountPlanCombo);
    this._setupInfoTips();
}
__extend(BaseTemplatedWidget, ClassEditDiscountPlanTab);

ClassEditDiscountPlanTab.prototype.onAttached = function(firstTime) {
    if (!firstTime) return;
    var thiz = this;
    this.selectedDiscountPlanId = this.classInfo ? this.classInfo.discountPlanId : 0;
    this.subProgName.innerText = this.classInfo ? this.classInfo.subProgName : "";
    (this.classInfo ? (this.classInfo.overrideSubProgDiscountPlan == true ? (this.overrideSubProgDiscountPlanItem.checked = true)
            : (this.classInfo.discountPlanId ? (this.useCustomDiscountPlanItem.checked = true) : (this.useNoDiscountPlan.checked = true)))
            : (this.overrideSubProgDiscountPlanItem.checked = true));
    if (this.classInfo) {
        if (this.classInfo.allowDiscountCalculation) {
            this.includedDiscount.checked = true;
            this.noIncludedDiscount.checked = false;
        } else {
            this.includedDiscount.checked = false;
            this.noIncludedDiscount.checked = true;
        }
    }


    this.toggleDiscountPlanOption(this.classInfo ? (this.classInfo.overrideSubProgDiscountPlan
            ? 0 : (this.classInfo.discountPlanId ? 1 : 2)) : 0);
    this.loadDiscountPlanList();
};

ClassEditDiscountPlanTab.prototype._setupInfoTips = function () {
    var showTips = function() {
        if (this._dicountPlanToolTip) {
            this._dicountPlanToolTip.kill();
        }
        this._dicountPlanToolTip = InfoTip.show(this.discountPlanTooltip, "Rate Plan pricing will receive the Discount Rate set at the Rate Plan.", false, null, "tooltip", "left-inside", -(Dom.getOffsetWidth(this.discountPlanTooltip)/2 + 7));
    }
    var hideTips = function() {
        if(this.discountPlanTooltip && this.discountPlanTooltip.__tip) {
            this.discountPlanTooltip.__tip.isVisible = function(){
                return true;
            };
            InfoTip.show(this.discountPlanTooltip);
            if (this._dicountPlanToolTip) {
                this._dicountPlanToolTip.kill();
            }
        }
    }
    this.bind("mouseover", showTips, this.discountPlanTooltip);
    this.bind("mouseout", hideTips, this.discountPlanTooltip);
};

ClassEditDiscountPlanTab.prototype.editDiscountPlanButtonClickHandler = function (discountPlan) {
    if (!discountPlan) return;
    discountPlan.key = Util.newUUID();


    this.openDiscountPlanDialog(discountPlan);
};

ClassEditDiscountPlanTab.prototype.openDiscountPlanDialog = function (discountPlanData) {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        var discountPlanOptions = {
            discountPlan: discountPlanData,
            discountConfiguration: {
                discountApplicationTypes: window.LOGIN_INFO.discountApplicationTypes,
                discountOrderTypes: window.LOGIN_INFO.discountOrderTypes
            }
        };
        new DiscountPlanDialog().callback(function (discountData) {
            if (discountData) thiz.loadDiscountPlanList();
        }).open(discountPlanOptions);
    }
};

ClassEditDiscountPlanTab.prototype.loadDiscountPlanList = function () {
    var thiz = this;
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) return;
    $classAdminService.getDiscountPlans(function(data) {
        thiz.discountPlanList = data.result;
        thiz.discountPlanCombo.setItems(data.result);
        if (thiz.useCustomDiscountPlanItem.checked) {
            var filterPlans = data.result.filter(function(plan) {
                return plan.id == thiz.selectedDiscountPlanId;
            });
            if (!filterPlans.length && !thiz.loaded) {
                thiz.selectedDiscountPlanId = 0;
                thiz.useNoDiscountPlan.checked = true;
                thiz.toggleDiscountPlanOption(thiz.useNoDiscountPlan.value);
            } else {
                thiz.discountPlanCombo.selectItemById(thiz.updatedData.discountPlanId ? thiz.updatedData.discountPlanId : thiz.selectedDiscountPlanId);
                thiz.discountPlanCombo.setDisabled(false);
                thiz.editDiscountPlanButton.removeAttribute("disabled");
            }
        }
        thiz.fillSubProgDiscountPlan();
        if (!thiz.loaded) thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
        thiz.loaded = true;
        thiz.validateUIWithPermission();
    },
    function(error) {
        console.error("Fail to get DiscountPlans with error: ", (error && error.message ? error.message : error));
    });
};

ClassEditDiscountPlanTab.prototype.fillSubProgDiscountPlan = function() {
    var thiz = this;
    if (!this.classInfo) return;
    this.subProgName.innerText = this.classInfo ? this.classInfo.subProgName : "";
    var filterData = this.discountPlanList.filter(function(plan) {
        return plan.id == thiz.classInfo.subProgDiscountPlanId;
    });
    Dom.toggleClass(this.subProbDiscountPlanInfo, "NoSubProgDiscountPlan", !this.classInfo.subProgDiscountPlanId || filterData.length == 0);
    if (filterData.length == 0) return;
    var discountPlan = filterData[0];
    this.subProgDiscountPlanName.innerText = discountPlan.name;
    this.multiStudentDiscountItem.innerText = (discountPlan.allowMultiStudentDiscount ? "Yes" : "No");
    Dom.toggleClass(this.multiStudentDiscountItem, "OFF", !discountPlan.allowMultiStudentDiscount);
    this.multiClassDiscountItem.innerText = (discountPlan.allowMultiClassDiscount ? "Yes" : "No");
    Dom.toggleClass(this.multiClassDiscountItem, "OFF", !discountPlan.allowMultiClassDiscount);
    this.allowCouponItem.innerText = (discountPlan.allowCoupon ? "Yes" : "No");
    Dom.toggleClass(this.allowCouponItem, "OFF", !discountPlan.allowCoupon);
};

ClassEditDiscountPlanTab.prototype.toggleDiscountPlanOption = function(value) {
    Dom.toggleClass(this.overrideSubProgDiscountPlanItem.parentNode.parentNode, "Disabled", value != 0);

    this.discountPlanCombo.setDisabled(value != 1 || !this.discountPlanCombo.items || this.discountPlanCombo.items.length == 0);
    Dom.setEnabled(value == 1 && this.discountPlanCombo.items && this.discountPlanCombo.items.length > 0, this.editDiscountPlanButton);
    Dom.setEnabled(value == 1, this.newDiscountPlanButton);
};

ClassEditDiscountPlanTab.prototype.syncClassData = function(classInfo) {
    console.log("# Sync Class Data:", classInfo);
    this.classInfo = classInfo;
    this.fillSubProgDiscountPlan();
};

ClassEditDiscountPlanTab.prototype.getCurrentInputValues = function() {
    var selectedDiscount = this.discountPlanCombo.getSelectedItem();
    var selectedDiscPlanId = (this.useNoDiscountPlan.checked ? 0 : (selectedDiscount ? selectedDiscount.id : 0));
    var values = {
        overrideSubProgDiscountPlan: this.overrideSubProgDiscountPlanItem.checked,
        discountPlanId: selectedDiscPlanId
    };
    return values;
}

ClassEditDiscountPlanTab.prototype.setSnapshotInputValues = function(values) {
    if(values && typeof (values) == "object") {
        this._snapshotInputValues = JSON.parse(JSON.stringify(values));
    } else {
        this._snapshotInputValues = values;
    }
}

ClassEditDiscountPlanTab.prototype.isClassDataChanged  = function() {
    if (!this.classInfo) return false;
    var curValues = this.getCurrentInputValues() || {};
    var snapshotValues = this._snapshotInputValues || {};
    return JSON.stringify(snapshotValues) !== JSON.stringify(curValues);
};

ClassEditDiscountPlanTab.prototype.updateClassData = function(data) {
    if (!data || !this.loaded) return;
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) return;
    data.overrideSubProgDiscountPlan = this.overrideSubProgDiscountPlanItem.checked;
    var selectedDiscount = this.useCustomDiscountPlanItem.checked ? this.discountPlanCombo.getSelectedItem() : null;
    data.discountPlanId = (this.useCustomDiscountPlanItem.checked && selectedDiscount) ? selectedDiscount.id : 0;
    data.allowMultiClassDiscount = (this.useCustomDiscountPlanItem.checked && selectedDiscount) ? selectedDiscount.allowMultiClassDiscount : false;
    data.allowMultiStudentDiscount = (this.useCustomDiscountPlanItem.checked && selectedDiscount) ? selectedDiscount.allowMultiStudentDiscount : false;
    data.isDiscMultiClasses = data.overrideSubProgDiscountPlan? (this.classInfo && this.classInfo.subProgAllowMultiStudentDiscount ? this.classInfo.subProgAllowMultiStudentDiscount : false) : data.allowMultiClassDiscount;
    data.isDiscMultiStudents = data.overrideSubProgDiscountPlan? (this.classInfo && this.classInfo.subProgAllowMultiClassDiscount ? this.classInfo.subProgAllowMultiClassDiscount : false) : data.allowMultiStudentDiscount;
    if (this.includedDiscount.checked) {
        data.allowDiscountCalculation = true;
    } else {
        data.allowDiscountCalculation = false;
    }
};

ClassEditDiscountPlanTab.prototype.validateUIWithPermission = function () {
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        this.overrideSubProgDiscountPlanItem.setAttribute("disabled", "disabled");
        this.useCustomDiscountPlanItem.setAttribute("disabled", "disabled");
        this.useNoDiscountPlan.setAttribute("disabled", "disabled");
        this.discountPlanCombo.setDisabled(true);
        this.editDiscountPlanButton.setAttribute("disabled", "disabled");
        this.newDiscountPlanButton.setAttribute("disabled", "disabled");
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditGeneralTab.js";

function ClassEditGeneralTab(options) {
    var thiz = this;
    BaseTemplatedWidget.call(this);
    this.options = options;
    this.statusCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    this.programCombo.renderer = function(item, selected) {
        if(!item) return "--Select--";
        return "" + item.title;
    };
    this.subProgramCombo.renderer = function(item, selected) {
        if(!item) return "--Select--";
        return "" + item.title;
    };
    this.curriculumCombo.renderer = function(item, selected) {
        if(!item) return "--Select--";
        return "" + item.name;
    };
    this.sessionCombo.renderer = function(item, selected) {
        if(!item) return "--Select--";
        return "" + item.name;
    };
    this.lessonLocCombo.renderer = function(item, selected) {
        if(!item) return "--Select--";
        return "" + item.name;
    };
    this.lessonZoneCombo.renderer = function(item, selected) {
        if(!item) return "--Select--";
        return "" + item.name;
    };
    this.insuranceCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    this.emergencyCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    this.classVisibilityCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    this.registrationVisibilityCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    
    this.clothingOptionsCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };

    this.bind("p:ItemSelected", this.programComboSelectedHandler, this.programCombo.node());
    this.bind("p:ItemSelected", this.subProgramComboSelectedHandler, this.subProgramCombo.node());
    this.bind("p:ItemSelected", this.statusComboSelectedHandler, this.statusCombo.node());
    this.bind("change", this.unlimitedChangeHandler, this.unlimited);
    this.bind("change", this.allowRegisterCallChangeHandler, this.allowRegisterCall);
    this.bind("change", this.showLinkToExternalPageChangeHandler, this.showLinkToExternalPage);
    this.bind("change", function () {
        this.includeAnnualFeeCheckboxChanged = true;
    }.bind(this), this.includeAnnualFeeCheckbox);
    this.bind("change", function () {
        this.includeAnnualKitCheckboxChanged = true;
    }.bind(this), this.includeAnnualKitCheckbox);

    this.bind("click", this.waiverTitleClickedHandler, this.waiver1Title);
    this.bind("click", this.waiverTitleClickedHandler, this.waiver2Title);
    this.bind("click", this.waiverTitleClickedHandler, this.waiver3Title);
    this.bind("click", this.waiverTitleClickedHandler, this.waiver4Title);
    this.bind("click", this.waiverTitleClickedHandler, this.waiver5Title);
    this.bind("click", this.editWaiverButtonClickedHandler, this.editWaiverButton);

    this.bind("p:ItemSelected", this.classVisibilityComboChangedHandler, this.classVisibilityCombo);
    this.bind("p:ItemSelected", this.registrationVisibilityComboChangedHandler, this.registrationVisibilityCombo);
    this.bind("change", this.allowMakeupChangedHandler, this.unlimited);
    this.bind("click", this.classVisibilityDescriptionClickedHandler, this.classVisibilityDescription);
    this.bind("click", this.registrationVisibilityDescriptionClickedHandler, this.registrationVisibilityDescription);
    this.bind("click", this.editProgramClickedHandler, this.editProgramButton);
    this.bind("click", this.addProgramClickedHandler, this.addProgramButton);
    this.bind("click", this.editSubProgramClickedHandler, this.editSubProgramButton);
    this.bind("click", this.addSubProgramClickedHandler, this.addSubProgramButton);
    this.bind(RichTextEditor.TEXT_CHANGE_EVENT_NAME, function() {
        this.descriptionChange = true;
    }.bind(this), this.description.node());

    this.changedFields = [];
    this.comparators = {};
    this.CUSTOM_COMPARATOR_KEYS = ["dateAgeUp"];
    this.VISIBILITY_TYPE = {SHARED_ONLY: 5};
}
__extend(BaseTemplatedWidget, ClassEditGeneralTab);

ClassEditGeneralTab.prototype.onAttached = function(firstTime) {
    if (!firstTime) return;
    if(!this.options) return;

    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.dateAgeUp.setMinDate(minDate);

    var filters = this.options.filters;
    var itemData = this.options.data;
    this.statusCombo.setItems([{
        id: 1,
        name: "ON"
    }, {
        id: 0,
        name: "OFF - Disabled"
    }]);
    this.programCombo.setItems([null].concat(filters.programs));
    this.buildSubProgramObject();
    this.programComboSelectedHandler();
    if(filters.curriculums) {
        this.curriculumCombo.setItems([null].concat(filters.curriculums));
    }
    if(filters.sessions) {
        this.sessionCombo.setItems([null].concat(filters.sessions));
    }
    if(filters.lessonLocs) {
        this.lessonLocCombo.setItems([null].concat(filters.lessonLocs));
    }
    if(filters.lessonZones) {
        this.lessonZoneCombo.setItems([null].concat(filters.lessonZones));
    }
    
    var insuranceOptions = [{
        id: 0,
        name: "Optional"
    }, {
        id: 1,
        name: "Required"
    }, {
        id: 2,
        name: "Hidden"
    }];
    this.insuranceCombo.setItems(insuranceOptions);
    this.emergencyCombo.setItems(insuranceOptions);
    this.clothingOptionsCombo.setItems(insuranceOptions);
    this.classImageFileUploadView.dataType = "__lesson__";
    this.classImageFileUploadView.dataUUID = "class";
    this.registerCallBgcolor.setEnable(false);
    this.makeups.value = 0;
    this.makeups.setAttribute("disabled", "disabled");
    this.unlimited.checked = true;
    this.classVisibilityCombo.setItems(filters.visibilityTypes);
    var registrationVisibilityItems = [];
    var thiz = this;
    filters.visibilityTypes.forEach(function (item) {
        if (item.id != thiz.VISIBILITY_TYPE.SHARED_ONLY) registrationVisibilityItems.push(item);
    });
    this.registrationVisibilityCombo.setItems(registrationVisibilityItems);

    if (window.LOGIN_INFO.allowWaiver) {
        Dom.hide(this.waiverContainerWrapper);
        this.rerenderWaiverAgreementCombo(filters.waiverAgreements.result, itemData);
    } else {
        Dom.hide(this.waiverAgreementWrapper);
    }

    this.rerenderGenderSelectBox(this.options.filters.limitGenders, itemData);

    if(itemData && itemData.id > 0) {
        this.backupGeneralData(itemData);
        this.timezoneId = itemData.timezoneId;
        this.classTitle.value = itemData.title;
        this.statusCombo.selectItemByKey("id", itemData.status);
        this.programCombo.selectItemByKey("id", itemData.progId);
        this.subProgramCombo.selectItemByKey("id", itemData.subProgId);
        this.curriculumCombo.selectItemByKey("id", itemData.currId);
        if(itemData.sessionId > 0) {
            this.sessionCombo.selectItemByKey("id", itemData.sessionId);
        }
        this.lessonLocCombo.selectItemByKey("id", itemData.lessonLocId);
        this.lessonZoneCombo.selectItemByKey("id", itemData.pzoneId);
        this.insuranceCombo.selectItemByKey("id", itemData.insuranceOptions);
        this.clothingOptionsCombo.selectItemByKey("id", itemData.clothingOptions);
        this.emergencyCombo.selectItemByKey("id", itemData.emergencyOptions);
        this.allowWaitList.checked = itemData.isWaitlist;
        
        this._updateStudentAgeLimitUI(itemData);

        if(itemData.dateAgeUp) {
            this.dateAgeUp.setDate(ClassUtils.transformClassTimezoneToLocal(itemData.dateAgeUp, itemData.timezoneId));
        }
        this.description.setContent(itemData.description, function() {
            this.descriptionChange = false;
        }.bind(this));
        if(itemData.thumbnailFilePath && itemData.thumbnailFilePath.length > 0) {
            var previewWrappers = this.classImageFileUploadView.node().getElementsByClassName("PreviewWrapper");
            if(previewWrappers && previewWrappers.length > 0) {
                for(var i = 0; i < previewWrappers.length; i ++) {
                    previewWrappers[i].parentNode.removeChild(previewWrappers[i]);
                }
            }
            var thumbnailFilePath = itemData.thumbnailFilePath;
            var markPos = thumbnailFilePath.lastIndexOf("?");
            thumbnailFilePath = markPos > 0? thumbnailFilePath.substring(0, markPos) : thumbnailFilePath;
            this.classImageFileUploadView.setCommaSeparatedStoragePaths(thumbnailFilePath);
            this.classImageFileUploadView.rebuildFileInfoList();
            this.classImageFileUploadView.invalidateStatus();
            this.classImageFileUploadView.fireFileModified();
        }

        this.makeups.value = itemData.makeups;
        this.statusCombo.selectItemByKey("id", itemData.status);
        if(!itemData.makeups) {
            this.makeups.value = 0;
            this.makeups.setAttribute("disabled", "disabled");
            this.unlimited.checked = false;
            Dom.addClass(this.resetMakeupWrapper, "Disabled");
        } else {
            this.makeups.removeAttribute("disabled");
            this.unlimited.checked = true;
            this.resetMakeupMonthly.checked = itemData.resetMakeupMonthly;
            Dom.removeClass(this.resetMakeupWrapper, "Disabled");
        }
        this.allowRegisterCall.checked = itemData.allowRegisterCall;
        this.registerCallText.value = itemData.registerCallText;
        this.allowRegisterCallChangeHandler();
        if(itemData.registerCallBgcolor && itemData.registerCallBgcolor.length > 0) this.registerCallBgcolor.setColor("#" + itemData.registerCallBgcolor);
        if(itemData.hasRegister || itemData.hasAttendance) {
            this.statusCombo.setEnable(false);
        }
        this.showAvailabelRegSlots.checked = itemData.isShowedAvailableRegSlots;
        this.allowDisplayHomepage.checked = itemData.allowDisplayHomepage;
        this.allowOverlapToAnyClass.checked = itemData.allowOverlapToAnyClass;
        this.allowOverlapToAnyBooking.checked = itemData.allowOverlapToAnyBooking;

        this.classVisibilityCombo.selectItemByKey("id", itemData.classVisibility);
        this.registrationVisibilityCombo.selectItemByKey("id", itemData.registrationVisibility);

        this.showRegisterCallInstruction.checked = itemData.showRegisterCallInstruction;
        this.registerCallInstruction.value = itemData.registerCallInstruction;
        
        this.showLinkToExternalPage.checked = itemData.showLinkToExternalPage;
        this.linkExternalPage.value = itemData.linkExternalPage;

        this.includeAnnualFeeCheckbox.checked = !TEAM_INFO.isInAffiliation ? true : itemData.includedAnnualFee;
        this.includeAnnualKitCheckbox.checked = !TEAM_INFO.isInAffiliation ? true : itemData.includedAnnualKit;

        this.showLinkToExternalPageChangeHandler();
    } else {
        this.allowOverlapToAnyBooking.checked = true;
        if(!this.options.defaultMakeups) {
            this.makeups.value = 0;
            this.makeups.setAttribute("disabled", "disabled");
            this.unlimited.checked = false;
        } else {
            this.makeups.value = this.options.defaultMakeups;
            this.makeups.removeAttribute("disabled");
            this.unlimited.checked = true;
        }
        this.allowDisplayHomepage.checked = true;
        this.emergencyCombo.selectItemByKey("id", filters.emergencyOptions || 0);
        this.clothingOptionsCombo.selectItemByKey("id", filters.clothingOptions || 0);

        this.includeAnnualFeeCheckbox.checked = !TEAM_INFO.isInAffiliation;
        this.includeAnnualKitCheckbox.checked = !TEAM_INFO.isInAffiliation;
    }

    if (filters.waiver.agree1Title.length > 0) {
        this.ckbWaiver1.checked = itemData ? itemData.enableWaiver1 : false;
        this.waiver1Title.innerHTML = filters.waiver.agree1Title;
    } else {
        this.ckbWaiver1.disabled = true;
    }
    if (filters.waiver.agree2Title.length > 0) {
        this.ckbWaiver2.checked = itemData ? itemData.enableWaiver2 : false;
        this.waiver2Title.innerHTML = filters.waiver.agree2Title;
    } else {
        this.ckbWaiver2.disabled = true;
    }
    if (filters.waiver.agree3Title.length > 0) {
        this.ckbWaiver3.checked = itemData ? itemData.enableWaiver3 : false;
        this.waiver3Title.innerHTML = filters.waiver.agree3Title;
    } else {
        this.ckbWaiver3.disabled = true;
    }
    if (filters.waiver.agree4Title.length > 0) {
        this.ckbWaiver4.checked = itemData ? itemData.enableWaiver4 : false;
        this.waiver4Title.innerHTML = filters.waiver.agree4Title;
    } else {
        this.ckbWaiver4.disabled = true;
    }
    if (filters.waiver.agree5Title.length > 0) {
        this.ckbWaiver5.checked = itemData ? itemData.enableWaiver5 : false;
        this.waiver5Title.innerHTML = filters.waiver.agree5Title;
    } else {
        this.ckbWaiver5.disabled = true;
    }

    var textInputs = this.node().querySelectorAll("input[type='text']");
    this.changedFields = [];
    this.comparators = {};
    if (textInputs) {
        var thiz = this;
        var f = function(e) {
            var target = Dom.getTarget(e);
            var classFieldKey = target.getAttribute("class-field-key");
            if (classFieldKey) {
                thiz.changedFields.push(classFieldKey);
                return;
            }
            var parent = target? target.parentNode : null;
            if (!parent) return;
            classFieldKey = parent.getAttribute("class-field-key");
            if (!classFieldKey) return;
            thiz.changedFields.push(classFieldKey);
        }
        for (var i = 0; i < textInputs.length; i++) {
            this.bind("change", function(e) {
                f(e);
            }, textInputs[i]);
            if (textInputs[i].parentNode)
                this.bind("p:ValueUpdated", function(e) {
                    f(e);
                }, textInputs[i].parentNode);
        }

        var comparators = {};
        var thiz = this;
        thiz.CUSTOM_COMPARATOR_KEYS.forEach(function(k) {
            comparators[k] = function(value1, value2) {
                if (thiz.changedFields.indexOf(k) == -1) return true;
                return thiz.compareDateValue(value1, value2, timezoneId);
            }
        });
        thiz.comparators = comparators;
    }

    if (!filters.waitlistabilityNoteVisible) Dom.hide(this.waitlistNote);
    if (!this.options.isBookingEnabled) Dom.hide(this.allowOverlapToAnyBookingWrapper);
    if (!filters.enableLinktoExternalPage) Dom.hide(this.externalPage);
    this.validateUIWithPermission();

    widget.__ensureNamespaceLoaded("cm", function (cm) {
        ClientPropertyUtil.invalidateElements(thiz.node(), cm.ModuleData.__propertySpec);
    });

    if (!TEAM_INFO.isAffiliateTeam) {
        Dom.hide(this.includeAnnualFeeSettingWrapper);
        Dom.hide(this.includeAnnualKitSettingWrapper);
    }
};
ClassEditGeneralTab.prototype._updateStudentAgeLimitUI = function (itemData) {
    if(itemData.ageLow > 0) {
        var lowYearMonth = this._getYearMonthFromValue(itemData.ageLow, itemData.ageUnit);
        this.studentAgeLimitLowYear.value = lowYearMonth.year;
        this.studentAgeLimitLowMonth.value = lowYearMonth.month;
    }
    
    if(itemData.ageHi > 0) {
        var highYearMonth = this._getYearMonthFromValue(itemData.ageHi, itemData.ageUnit);
        this.studentAgeLimitHighYear.value = highYearMonth.year;
        this.studentAgeLimitHighMonth.value = highYearMonth.month;
    }
};
ClassEditGeneralTab.prototype._getYearMonthFromValue = function (value, unit) {
    var year = 0;
    var month = 0;
    if (unit == 0) {
        year = value;
    } else {
        year = Math.floor(value / 12);
        month = value % 12;
    }
    
    return {
        year: year,
        month: month
    };
};

ClassEditGeneralTab.prototype.programComboSelectedHandler = function () {
    var selectedProgram = this.programCombo.getSelectedItem();
    if (selectedProgram && this.subProgramObject && this.subProgramObject[selectedProgram.id]) {
        this.subProgramCombo.setItems(this.subProgramObject[selectedProgram.id]);
    } else {
        this.subProgramCombo.setItems([null]);
    }
};

ClassEditGeneralTab.prototype.subProgramComboSelectedHandler = function () {
    if (this.subProgramComboChangedTimeout) window.clearTimeout(this.subProgramComboChangedTimeout);
    var thiz = this;
    this.subProgramComboChangedTimeout = window.setTimeout(function () {
        var filters = thiz.options.filters,
            selectedSubProg = thiz.subProgramCombo.getSelectedItem(),
            classData = thiz.options.data;
        
        thiz.invalidateAnnualFeeAndKitToggles(selectedSubProg);
            
        if (!classData || !classData.id) {
            thiz.showAvailabelRegSlots.checked = selectedSubProg && selectedSubProg.enableShowOpenSlot;
        }
        if (!filters || !filters.lessonTeam || !selectedSubProg || !classData) return;

        classData.subProgName = selectedSubProg.name;
        classData.subProgId = selectedSubProg.id;

        classData.subProgDiscountPlanId = selectedSubProg.discountPlanId;
        classData.subProgAllowMultiClassDiscount = selectedSubProg.discountPlanAllowMultiClassDiscount;
        classData.subProgAllowMultiStudentDiscount = selectedSubProg.discountPlanAllowMultiStudentDiscount;
        classData.enableAnnualRegStudent = selectedSubProg.enableAnnualRegStudent && thiz.includeAnnualFeeCheckbox.checked;
        classData.enableAnnualRegAccount = selectedSubProg.enableAnnualRegAccount && thiz.includeAnnualFeeCheckbox.checked;
        classData.annualRegAccountAmt = thiz.options.filters.annualRegAccountAmt;
        classData.annualRegStudentAmt = thiz.options.filters.annualRegStudentAmt;
        classData.subProgStartDropDatePolicyId = selectedSubProg.startDropPolicyId;
    }, 100);
};

ClassEditGeneralTab.prototype.invalidateAnnualFeeAndKitToggles = function (selectedSubProg) {
    var classData = this.options.data;
    Dom.toggleClass(this.includeAnnualFeeSettingWrapper, "Disabled", !selectedSubProg || (!selectedSubProg.enableAnnualRegAccount && !selectedSubProg.enableAnnualRegStudent));
    Dom.toggleClass(this.includeAnnualKitSettingWrapper, "Disabled", !selectedSubProg || (!selectedSubProg.annualKitsCategoryId));
    
    this.includeAnnualKitCheckbox.checked = selectedSubProg && selectedSubProg.annualKitsCategoryId && (!classData || classData.includedAnnualKit || (this.generalData && this.generalData.includedAnnualKit));
    this.includeAnnualFeeCheckbox.checked = selectedSubProg && (selectedSubProg.enableAnnualRegStudent || selectedSubProg.enableAnnualRegAccount) && (!classData || classData.includedAnnualFee || (this.generalData && this.generalData.includedAnnualFee));
};

ClassEditGeneralTab.prototype.updateClassData = function (data) {
    if (!data) return;
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) return;
    data.title = this.classTitle.value;
    data.description = this.description.getContent();
    data.status = this.statusCombo.getSelectedItem() ? this.statusCombo.getSelectedItem().id : 0;
    data.progId = this.programCombo.getSelectedItem() ? this.programCombo.getSelectedItem().id : 0;
    var selectedSubProg = this.subProgramCombo.getSelectedItem();
    data.subProgId = selectedSubProg ? selectedSubProg.id : 0;
    data.subProgName = selectedSubProg ? selectedSubProg.name : "";
    if (data.subProgId > 0) {
        data.enableAnnualRegAccount = selectedSubProg.enableAnnualRegAccount && this.includeAnnualFeeCheckbox.checked;
        data.enableAnnualRegStudent = selectedSubProg.enableAnnualRegStudent && this.includeAnnualFeeCheckbox.checked;
        data.annualRegAccountAmt = this.options.filters.annualRegAccountAmt;
        data.annualRegStudentAmt = this.options.filters.annualRegStudentAmt;
        data.subProgAllowMultiClassDiscount = selectedSubProg.discountPlanAllowMultiClassDiscount;
        data.subProgAllowMultiStudentDiscount = selectedSubProg.discountPlanAllowMultiStudentDiscount;
        data.subProgDiscountPlanId = selectedSubProg.discountPlanId;
        data.subProgStartDropDatePolicyId = selectedSubProg.startDropPolicyId;
    }
    data.currId = this.curriculumCombo.getSelectedItem() ? this.curriculumCombo.getSelectedItem().id : 0;
    data.sessionId = this.sessionCombo.getSelectedItem() ? this.sessionCombo.getSelectedItem().id : 0;
    data.lessonLocId = this.lessonLocCombo.getSelectedItem() ? this.lessonLocCombo.getSelectedItem().id : 0;
    data.pzoneId = this.lessonZoneCombo.getSelectedItem() ? this.lessonZoneCombo.getSelectedItem().id : 0;
    data.insuranceOptions = this.insuranceCombo.getSelectedItem() ? this.insuranceCombo.getSelectedItem().id : 0;
    data.clothingOptions = this.clothingOptionsCombo.getSelectedItem() ? this.clothingOptionsCombo.getSelectedItem().id : 0;
    data.emergencyOptions = this.emergencyCombo.getSelectedItem() ? this.emergencyCombo.getSelectedItem().id : 0;
    data.isWaitlist = this.allowWaitList.checked;
    data.ageLow = this.getStudentAgeLimitValueInMonth("low");
    data.ageHi = this.getStudentAgeLimitValueInMonth("high");
    data.ageUnit = 1;
    data.dateAgeUp = this.dateAgeUp.getDate();
    var thumbnailFilePath = this.options.data? this.options.data.thumbnailFilePath : "";
    if (thumbnailFilePath) {
        data.oldThumnailFilePath = thumbnailFilePath.substring(0, thumbnailFilePath.lastIndexOf("?"));
    }

    data.thumbnailFilePath = this.classImageFileUploadView.getCommaSeparatedStoragePaths();

    data.makeups = this.makeups.value? parseInt(this.makeups.value): 0;
    data.allowRegisterCall = this.allowRegisterCall.checked;
    if(data.allowRegisterCall) {
        data.registerCallText = this.registerCallText.value;
        data.registerCallBgcolor = this.registerCallBgcolor.getRGBColorString().replace("#", "");
        data.showRegisterCallInstruction = this.showRegisterCallInstruction.checked;
        data.registerCallInstruction = this.registerCallInstruction.value;
        data.showLinkToExternalPage = this.showLinkToExternalPage.checked;
        data.linkExternalPage = this.showLinkToExternalPage.checked ? this.linkExternalPage.value : "";
    } else {
        data.registerCallText = "";
        data.registerCallBgcolor = "";
        data.showRegisterCallInstruction = false;
        data.registerCallInstruction = "";
        data.showLinkToExternalPage = false;
        data.linkExternalPage = "";
    }
    var isAllowAllGendersSelected = (this.gendersSelectBox.getSelectedData() || []).length == 0;
    if (!isAllowAllGendersSelected) {
        var genders = this.gendersSelectBox.getSelectedData().map(function(item) {
            return item.type;
        });
        data.allowedGenders = genders;
    } else {
        data.allowedGenders = null;
    }
    data.isAllowAllGendersSelected = isAllowAllGendersSelected;

    data.isShowedAvailableRegSlots = this.showAvailabelRegSlots.checked;
    data.allowOverlapToAnyClass = this.allowOverlapToAnyClass.checked;
    data.allowOverlapToAnyBooking = this.allowOverlapToAnyBooking.checked;
    data.classVisibility = this.classVisibilityCombo.getSelectedItem() ? this.classVisibilityCombo.getSelectedItem().id : 0;
    data.registrationVisibility = this.registrationVisibilityCombo.getSelectedItem() ? this.registrationVisibilityCombo.getSelectedItem().id : 0;
    if (this.unlimited.checked && parseInt(this.makeups.value, 10) > 0) {
        data.resetMakeupMonthly = this.resetMakeupMonthly.checked;
    } else {
        data.resetMakeupMonthly = false;
    }
    data.allowDisplayHomepage = this.allowDisplayHomepage.checked;

    data.agreementKeys = [];
    if (window.LOGIN_INFO.allowWaiver) {
        var selectedItems = this.agreementSelectBox.getSelectedData();
        if (selectedItems && selectedItems.length) {
            selectedItems.forEach(function (item) {
                data.agreementKeys.push(item.key);
            });
        }
    }

    data.enableWaiver1 = this.ckbWaiver1.checked;
    data.enableWaiver2 = this.ckbWaiver2.checked;
    data.enableWaiver3 = this.ckbWaiver3.checked;
    data.enableWaiver4 = this.ckbWaiver4.checked;
    data.enableWaiver5 = this.ckbWaiver5.checked;

    if (!TEAM_INFO.isInAffiliation) {
        data.includedAnnualFee = true;
        data.includedAnnualKit = true;
    } else {
        data.includedAnnualFee = !this.includeAnnualFeeCheckboxChanged ? null : ((selectedSubProg && (selectedSubProg.enableAnnualRegAccount || selectedSubProg.enableAnnualRegStudent) && this.includeAnnualFeeCheckbox.checked) || false);
        data.includedAnnualKit = !this.includeAnnualKitCheckboxChanged ? null : ((selectedSubProg && selectedSubProg.annualKitsCategoryId && this.includeAnnualKitCheckbox.checked) || false);
    }
};

ClassEditGeneralTab.prototype.getStudentAgeLimitValueInMonth = function (limitValueType, zeroIfBlank) {
    var isLowInput = limitValueType == "low";
    var yearInput = isLowInput ? this.studentAgeLimitLowYear : this.studentAgeLimitHighYear;
    var monthInput = isLowInput ? this.studentAgeLimitLowMonth : this.studentAgeLimitHighMonth;
    
    if (typeof(zeroIfBlank) != "undefined" && !zeroIfBlank) {
        if (yearInput.value.length <= 0 && monthInput.value.length <= 0) return null;
    }
    
    return (parseInt(yearInput.value) || 0) * 12 + (parseInt(monthInput.value) || 0);
};

ClassEditGeneralTab.prototype.unlimitedChangeHandler = function () {
    if(!this.unlimited.checked) {
        this.makeups.value = 0;
        this.makeups.setAttribute("disabled", "disabled");
    } else {
        this.makeups.removeAttribute("disabled");
    }
};

ClassEditGeneralTab.prototype.allowRegisterCallChangeHandler = function () {
    if(this.allowRegisterCall.checked) {
        Dom.removeClass(this.registerCallText.parentNode, "disabled-control");
        this.registerCallText.removeAttribute("disabled");
        this.registerCallBgcolor.setEnable(true);
        if(this.registerCallBgcolor.getRGBColorString() == "#FFFFFF") {
            this.registerCallBgcolor.setColor("#84C55F");
        }
        Dom.removeClass(this.showRegisterCallInstruction.parentNode.parentNode, "disabled-control");
        Dom.removeClass(this.showLinkToExternalPage.parentNode.parentNode, "disabled-control");
    } else {
        Dom.addClass(this.registerCallText.parentNode, "disabled-control");
        this.registerCallText.setAttribute("disabled", "disabled");
        this.registerCallText.value = "";
        this.registerCallBgcolor.setEnable(false);
        this.registerCallBgcolor.setColor("#FFFFFF");

        Dom.addClass(this.showRegisterCallInstruction.parentNode.parentNode, "disabled-control");
        Dom.addClass(this.showLinkToExternalPage.parentNode.parentNode, "disabled-control");
    }
    this.showLinkToExternalPageChangeHandler();
};

ClassEditGeneralTab.prototype.showLinkToExternalPageChangeHandler = function() {
    if (this.showLinkToExternalPage.checked || Dom.hasClass(this.linkExternalPage.parentNode.parentNode, "disabled-control")) {
        Dom.removeClass(this.linkExternalPage.parentNode, "disabled-control");
    } else {
        Dom.addClass(this.linkExternalPage.parentNode, "disabled-control");
    }
};

ClassEditGeneralTab.prototype.statusComboSelectedHandler = function  () {
    var itemData = this.options.data;
    if(!itemData) return;
    if(itemData.totalSlotRegister > 0) {
        if(this.statusCombo.getSelectedItem() && this.statusCombo.getSelectedItem().id == 0) {
            this.statusCombo.selectItemByKey("id", 1);
            Dialog.error("", "Cannot set this class status to OFF when there are registered members.", null);
        }
    }
};

ClassEditGeneralTab.prototype.waiverTitleClickedHandler = function(e) {
    if(this.options && this.options.filters) {
        var filterWaiver = this.options.filters.waiver,
            waiverData, agreeNo = 0;

        if(Dom.hasClass(e.currentTarget, "Waiver1Title")) {
            agreeNo = 1;
            waiverData = {
                agreeTitle: filterWaiver.agree1Title,
                agreeOptional: filterWaiver.agree1Optional
            };
        } else if(Dom.hasClass(e.currentTarget, "Waiver2Title")) {
            agreeNo = 2;
            waiverData = {
                agreeTitle: filterWaiver.agree2Title,
                agreeOptional: filterWaiver.agree2Optional
            };
        } else if(Dom.hasClass(e.currentTarget, "Waiver3Title")) {
            agreeNo = 3;
            waiverData = {
                agreeTitle: filterWaiver.agree3Title,
                agreeOptional: filterWaiver.agree3Optional
            };
        } else if(Dom.hasClass(e.currentTarget, "Waiver4Title")) {
            agreeNo = 4;
            waiverData = {
                agreeTitle: filterWaiver.agree4Title,
                agreeOptional: filterWaiver.agree4Optional
            };
        } else if(Dom.hasClass(e.currentTarget, "Waiver5Title")) {
            agreeNo = 5;
            waiverData = {
                agreeTitle: filterWaiver.agree5Title,
                agreeOptional: filterWaiver.agree5Optional
            };
        }
        if (agreeNo == 0) return;
        window.defaultIndicator.busy("Loading...");
        $classAdminService.getAgreeContent(agreeNo, function (res) {
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
            waiverData.agreeMessage = res;
            if(waiverData && waiverData.agreeTitle.length > 0) {
                new WaiverDetailDialog().callback(function(data) {}).open({waiverData: waiverData});
            }
        }, function (err) {
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
        });
    }
    e.stopPropagation();
    e.preventDefault();
};

ClassEditGeneralTab.prototype.editWaiverButtonClickedHandler = function() {
    if(!this.options) return;
    var filters = this.options.filters;
    var body = document.getElementsByTagName("body")[0];
    if (body && Dom.hasClass(body, "ClassicLayout")) {
        window.open("/TeamProfilePortal.jsp?act=edit&id=" + filters.lessonTeamId + "&team=" + filters.teamAlias + "&#/membrship/waivers", "_blank");
    } else {
        window.open("/team/"+ filters.teamAlias + "/controller/cms/admin/index#/class-admin/settings/waiver", "_blank");
    }
};

ClassEditGeneralTab.prototype.backupGeneralData = function (itemData) {
    if (!itemData) return;
    this.generalData = {};
    this.generalData.title = itemData.title;
    this.generalData.status = itemData.status;
    this.generalData.progId = itemData.progId;
    this.generalData.subProgId = itemData.subProgId;
    this.generalData.currId = itemData.currId;
    this.generalData.sessionId = itemData.sessionId;
    this.generalData.lessonLocId = itemData.lessonLocId;
    this.generalData.pzoneId = itemData.pzoneId;
    this.generalData.insuranceOptions = itemData.insuranceOptions;
    this.generalData.emergencyOptions = itemData.emergencyOptions;
    this.generalData.clothingOptions = itemData.clothingOptions;
    this.generalData.isWaitlist = itemData.isWaitlist;
    this.generalData.ageLow = itemData.ageLow;
    this.generalData.ageHi = itemData.ageHi;
    this.generalData.ageUnit = itemData.ageUnit;
    this.generalData.dateAgeUp = itemData.dateAgeUp;
    this.generalData.description = itemData.description;
    if (itemData.thumbnailFilePath && itemData.thumbnailFilePath.length > 0) {
        var thumbnailFilePath = itemData.thumbnailFilePath;
        var markPos = thumbnailFilePath.lastIndexOf("?");
        thumbnailFilePath = markPos > 0? thumbnailFilePath.substring(0, markPos) : thumbnailFilePath;
        this.generalData.thumbnailFilePath = thumbnailFilePath;
    }
    this.generalData.makeups = itemData.makeups;
    this.generalData.unlimited = itemData.unlimited;
    this.generalData.allowRegisterCall = itemData.allowRegisterCall;
    this.generalData.registerCallText = itemData.registerCallText;
    this.generalData.registerCallBgcolor = itemData.registerCallBgcolor;
    this.generalData.isShowedAvailableRegSlots = itemData.isShowedAvailableRegSlots;
    this.generalData.allowOverlapToAnyClass = itemData.allowOverlapToAnyClass;
    this.generalData.allowOverlapToAnyBooking = itemData.allowOverlapToAnyBooking;
    this.generalData.enableWaiver1 = itemData.enableWaiver1;
    this.generalData.enableWaiver2 = itemData.enableWaiver2;
    this.generalData.enableWaiver3 = itemData.enableWaiver3;
    this.generalData.enableWaiver4 = itemData.enableWaiver4;
    this.generalData.enableWaiver5 = itemData.enableWaiver5;
    this.generalData.classVisibility = itemData.classVisibility;
    this.generalData.registrationVisibility = itemData.registrationVisibility;
    if (!this.generalData.thumbnailFilePath) this.generalData.thumbnailFilePath = "";
    this.generalData.resetMakeupMonthly = itemData.resetMakeupMonthly;
    this.generalData.showRegisterCallInstruction = itemData.showRegisterCallInstruction;
    this.generalData.agreementKeys = itemData.agreementKeys ? itemData.agreementKeys : [];
    this.generalData.registerCallInstruction = itemData.registerCallInstruction ? itemData.registerCallInstruction : "";
    this.generalData.isAllowAllGendersSelected = itemData.isAllowAllGendersSelected;
    this.generalData.allowedGenders = itemData.allowedGenders;
    this.generalData.showLinkToExternalPage = itemData.showLinkToExternalPage;
    this.generalData.linkExternalPage = itemData.linkExternalPage ? itemData.linkExternalPage : "";
    this.generalData.includedAnnualFee = itemData.includedAnnualFee;
    this.generalData.includedAnnualKit = itemData.includedAnnualKit;
};

ClassEditGeneralTab.prototype.isDataChanged = function () {
    if (!this.generalData) return;
    var newData = {};
    this.updateClassData(newData);
    if (newData.dateAgeUp) {
        var tz = this.getTimezoneId();
        this.timezoneId = tz? tz : this.timezoneId;
        newData.dateAgeUp = ClassUtils.transformToTimeZone(newData.dateAgeUp, this.timezoneId);
    }
    var thiz = this;
    this.comparators["dateAgeUp"] = function (value1, value2) {
                                        return ClassUtils.compareDateValue(value1, value2, thiz.timezoneId);
                                    }
    this.comparators["description"] = function () {
        return !thiz.descriptionChange;
    };

    this.comparators["includedAnnualFee"] = function (left, right) {
        if (!TEAM_INFO.isAffiliateTeam) return true;
        if (!this.includeAnnualFeeCheckboxChanged) return true;
        return left == right;
    }.bind(this);

    this.comparators["includedAnnualKit"] = function (left, right) {
        if (!TEAM_INFO.isAffiliateTeam) return true;
        if (!this.includeAnnualKitCheckboxChanged) return true;
        return left == right;
    }.bind(this);
    
    return !ClassUtils.isSameObject(this.generalData, newData, this.comparators);
};

ClassEditGeneralTab.prototype.getTimezoneId = function() {
    return this.options.timezoneCallback? this.options.timezoneCallback() : this.timezoneId;
};

ClassEditGeneralTab.prototype.classVisibilityComboChangedHandler = function () {
    var selectedItem = this.classVisibilityCombo.getSelectedItem();
    if (!selectedItem) return;
    var registrationVisibilityItem = this.registrationVisibilityCombo.getSelectedItem();
    if (registrationVisibilityItem && registrationVisibilityItem.id < selectedItem.id) {
        this.registrationVisibilityCombo.selectItemByKey("id", selectedItem.id);
    }
};

ClassEditGeneralTab.prototype.registrationVisibilityComboChangedHandler = function () {
    var selectedItem = this.registrationVisibilityCombo.getSelectedItem();
    if (!selectedItem) return;
    var classVisibilityItem = this.classVisibilityCombo.getSelectedItem();
    if (classVisibilityItem && classVisibilityItem.id != this.VISIBILITY_TYPE.SHARED_ONLY && classVisibilityItem.id > selectedItem.id) {
        if (this._backupRegistrationVisibility) {
            Dialog.warning("", "Registration Visibility must be at least as restrictive as Class Visibility.", null);
            this.registrationVisibilityCombo.selectItemByKey("id", this._backupRegistrationVisibility.id, true);
            return;
        }
    }
    this._backupRegistrationVisibility = selectedItem;
};

ClassEditGeneralTab.prototype.allowMakeupChangedHandler = function () {
    if (this.unlimited.checked) {
        Dom.removeClass(this.resetMakeupWrapper, "Disabled");
    } else {
        Dom.addClass(this.resetMakeupWrapper, "Disabled");
    }
};

ClassEditGeneralTab.prototype.classVisibilityDescriptionClickedHandler = function () {
    var selectedItem = this.classVisibilityCombo.getSelectedItem();
    if (!selectedItem) return;
    var description = "";
    switch (selectedItem.id) {
        case 0:
            description = "This class will be visible to all users on the Class Registration page.";
            break;
        case 5:
            description = "This class will be visible only to users who access the shared link.";
            break;
        case 10:
            description = "This class will be visible to only authenticated users on the Class Registration page.";
            break;
        case 20:
            description = "This class will be visible to only users that can access restricted classes on the Class Registration page.";
            break;
        default:
            break;
    }
    InfoTip.show(this.classVisibilityDescription, description , false, null, "tooltip", "left-inside", -20);
};

ClassEditGeneralTab.prototype.registrationVisibilityDescriptionClickedHandler = function () {
    var selectedItem = this.registrationVisibilityCombo.getSelectedItem();
    if (!selectedItem) return;
    var description = "";
    switch (selectedItem.id) {
        case 0:
            description = "The Call to Action buttons for this class will be available to all users on the Class Registration page.";
            break;
        case 10:
            description = "The Call to Action buttons for this class will be available to only authenticated users on the Class Registration page.";
            break;
        case 20:
            description = "Only an account having granted permissions can register a member for a class.";
            break;
        default:
            break;
    }
    InfoTip.show(this.registrationVisibilityDescription, description , false, null, "tooltip", "left-inside", -20);
};


ClassEditGeneralTab.prototype.rerenderWaiverAgreementCombo = function (filterItems, classData) {
    if (!filterItems) return;
    var agreementKeys = [];
    if (classData && classData.agreementKeys) agreementKeys = classData.agreementKeys;
    if (!classData || !classData.id) {
        filterItems.forEach(function (item, i) {
            if (item && item.readOnly && item.enabled && item.autoAppliedModules && item.autoAppliedModules.indexOf("CLASS") >= 0) {
                agreementKeys.push(item.key);
            }
        });
    }
    this.waiverAgreement.innerHTML = "";
    var thiz = this;
    this.agreementSelectBox = new SelectBox();
    this.agreementSelectBox._superCreateOptionElement = this.agreementSelectBox._createOptionElement;
    this.agreementSelectBox._createOptionElement = function (option, type) {
        var container = thiz.agreementSelectBox._superCreateOptionElement(option, type);
        Dom.addClass(container, "Agreement");
        if (option._data && !option._data.enabled) {
            Dom.addClass(container, "Disabled");
        }
        return container;
    }
    this.agreementSelectBox.getConfigs = function () {
        return {
            name: "selectBox",
            mode: SelectBox.MODE_DROPDOWN,
            direction: SelectBox.DIRECTION_COLUMN,
            multipleSelect: true,
            optionSelectAll: false,
            optionSelectAllText: ""
        }
    };

    this.agreementSelectBox.getData = function (items) {
        var result = []
        filterItems.forEach(function (item, i) {
            if (item.enabled || agreementKeys.indexOf(item.key) >= 0) {
                result.push(item);
            }
        });


        return result;
    };
    this.agreementSelectBox.parseData = function(object) {
        return {
            value: object.key,
            text: object.title,
            checked: agreementKeys.indexOf(object.key) >= 0 ? true : false
        };
    }

    this.agreementSelectBox._setSelectedStatus = function () {
        thiz.agreementSelectBox.statusItem.innerHTML = "";
        var selectedItems = thiz.agreementSelectBox.getSelectedData();
        if (selectedItems && selectedItems.length > 0) {
            selectedItems.forEach(function (item) {
                thiz.agreementSelectBox.statusItem.appendChild(Dom.newDOMElement({
                    _name: "span",
                    "class": "StatusItem " + (item.enabled? "": "Disabled"),
                    _html: item.title,
                    "title": item.title
                }));
            });
        } else {
            thiz.agreementSelectBox.statusItem.innerHTML = "<span class=\"NoItem\">(0) item is selected</span>";
        }
    };



    this.agreementSelectBox.into(this.waiverAgreement);
    this.agreementSelectBox._options =  {
        onSelectionChanged: function(fromUserAction) {
            if (!fromUserAction) return;
        },
    };
    this.agreementSelectBox.setup();
};

ClassEditGeneralTab.prototype.rerenderGenderSelectBox = function (limitGenders, classInfo) {
    var oldGenders = classInfo && !classInfo.isAllowAllGendersSelected && classInfo.allowedGenders || [];
    var genderItems = ClassUtils.getGenders(limitGenders, oldGenders.map(type => Gender[type].code));
    this.gendersSelectBox.getConfigs = function() {
        return {
            mode: SelectBox.MODE_DROPDOWN,
            multipleSelect: true,
            useExplicitSelectLinks: false,
            noneSelectionText: "All Genders",
            checkboxDisplayType: SelectBox.HORIZONTAL_BUTTON,
        };
    };
    this.gendersSelectBox.parseData = function(data) {
        return {
            value: data.type,
            text: data.displayName,
            key: data.code
        };
    };
    this.gendersSelectBox.getData = (items) => {
        return genderItems;
    };
    this.gendersSelectBox._options = {
        onSelectionChanged: function (fromUserAction) {
            if (!fromUserAction) return;
        },
    };
    this.gendersSelectBox.decorator = function (node, option, checkbox, label) {
        var valid = ClassUtils.isValidGender(option.key, limitGenders);
        Dom.toggleClass(node, "Valid", valid);
        if (!valid) {
            label.appendChild(Dom.newDOMElement({ _name: "icon", title: "Invalid Gender", class: "alert" }));
        }
    };
    this.gendersSelectBox.setup();
    if (classInfo && !classInfo.isAllowAllGendersSelected) this.gendersSelectBox.setValuesSelected(oldGenders, true);
    this.gendersSelectBox.setPopupClass("ClassEditGeneralTab_GenderPopup");
};

ClassEditGeneralTab.prototype.editProgramClickedHandler = function () {
    var thiz = this;
    var selectedProgram = this.programCombo.getSelectedItem();
    if (!selectedProgram) return;
    new __pkg.ProgramEditDialog().callback(function(programData) {
        if(!programData) return;
        $classMetaService.saveProgram(programData, function(res) {            
            $classMetaService.getAvailablePrograms(function (progs) {
                thiz.options.filters.programs = progs;
                thiz.programCombo.setItems(progs);
                thiz.programCombo.selectItemByKey("id", res.id);
            }, function (err) {}, "Loading...");            
        }, function(err) {}, "Saving...");
    }).open({ids: [selectedProgram.id]});
};

ClassEditGeneralTab.prototype.addProgramClickedHandler = function () {
    var thiz = this;    
    new __pkg.ProgramEditDialog().callback(function(programData) {
        if(!programData) return;
        $classMetaService.saveProgram(programData, function(res) {            
            $classMetaService.getAvailablePrograms(function (progs) {
                thiz.options.filters.programs = progs;
                thiz.programCombo.setItems(progs);
                thiz.programCombo.selectItemByKey("id", res.id);
            }, function (err) {}, "Loading...");            
        }, function(err) {}, "Saving...");
    }).open({ids: []});
};

ClassEditGeneralTab.prototype.editSubProgramClickedHandler = function () {
    var thiz = this;
    var selectedSubProgram = this.subProgramCombo.getSelectedItem();
    if (!selectedSubProgram) return;
    new __pkg.SubProgramEditDialog().callback(function(subProgramData) {
        if(!subProgramData) return;
	$classMetaService.getAvailableSubPrograms(function (subProgs) {
            thiz.options.filters.subPrograms = subProgs;
            thiz.buildSubProgramObject();
            thiz.subProgramCombo.setItems(subProgs);
            thiz.subProgramCombo.selectItemByKey("id", subProgramData.id);
        }, function (err) {}, "Loading...");
    }).open({ids: [selectedSubProgram.id]});
};

ClassEditGeneralTab.prototype.addSubProgramClickedHandler = function () {
    var thiz = this;
    var selectedProgram = this.programCombo.getSelectedItem();
    var selectedProgramId = selectedProgram ? selectedProgram.id : 0;
    new __pkg.SubProgramEditDialog().callback(function(programData) {
        if(!programData) return;
        $classMetaService.getAvailableSubPrograms(function (subProgs) {
            thiz.options.filters.subPrograms = subProgs;
            thiz.buildSubProgramObject();
            thiz.subProgramCombo.setItems(subProgs);
            thiz.subProgramCombo.selectItemByKey("id", programData.id);
        }, function (err) {}, "Loading...");
    }).open({ids: [], programId: selectedProgramId});
};

ClassEditGeneralTab.prototype.buildSubProgramObject = function () {
    var filters = this.options.filters;
    var subProgramObject = {};
    if(filters.subPrograms) {
        for(var i = 0; i < filters.subPrograms.length; i ++) {
            var subProgram = filters.subPrograms[i];
            if(!subProgramObject[subProgram.progId]) {
                subProgramObject[subProgram.progId] = [];
            }
            subProgramObject[subProgram.progId].push(subProgram);
        }
    }
    this.subProgramObject = subProgramObject;
};

ClassEditGeneralTab.prototype.validateUIWithPermission = function () {
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        var inputs = Dom.getTags("input", this.node());
        for (var i = 0; i < inputs.length; i ++) {
            inputs[i].setAttribute("disabled", "disabled");
        }
        
        var buttons = Dom.getTags("button", this.node());
        for (var i = 0; i < buttons.length; i ++) {
            buttons[i].setAttribute("disabled", "disabled");
        }
        
        this.registerCallInstruction.setAttribute("disabled", "disabled");
        this.description.setReadOnly(true);
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditPaymentPlanTab.js";

function ClassEditPaymentPlanTab(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.options = options;
    this.classId = 0;
    this.classInfo = {};
    this.paymentPlans = [];
    this.paymentPlansMap = {};
    this._isModified = false;
    if(options) {
        this.classId = options.currentClassId;
        this.classInfo = options.data;
        this.paymentPlans = (this.classInfo && this.classInfo.paymentPlans)? this.classInfo.paymentPlans : [];
        for (var i = 0; i < this.paymentPlans.length; i++) {
            this.paymentPlansMap[this.paymentPlans[i].key] = this.paymentPlans[i];
        }
    }
    this.currentSelectedPaymentPlanKey = null;
    this.currentSelectedPaymentPlan = null;
    this.bind("click", this.addPaymentPlanHandlerFromBlank, this.btnNewPaymentPlanFromBlank);
    this.bind("click", this.addPaymentPlanHandler, this.btnNewPaymentPlan);
    this.bind("click", this.copyFromExistingPlan.bind(this), this.btnCopyPaymentPlan);
    this.bind("click", this.editClassRegFee, this.editClassRegFeeLink);
    this.bind("click", function() {
        Dom.emitEvent(ClassEditDialog.EVT_CHANGE_TAB, thiz.node(), {tabName: "regSlotTab"});
    }, this.regSlotTabLink);
    this.revenueOverview.innerHTML = Util.toCurrency(0);

    this.bind(ClassEditPaymentPlanTab.CPP_DELETE_PLAN, function (event) {
        if(event.paymentPlan) {
            thiz._isModified = true;
            if (thiz.emptyNamePaymentPlanKey == event.paymentPlan.key) thiz.emptyNamePaymentPlanKey = null;
            delete thiz.paymentPlansMap[event.paymentPlan.key];
            thiz.fillPaymentPlanList();
            thiz.updateClassSummary();
            thiz.currentSelectedPaymentPlanKey = (thiz.currentSelectedPaymentPlanKey == event.paymentPlan.key? "" : thiz.currentSelectedPaymentPlanKey);
        }
        thiz.paymentPlanDetailContainer.innerHTML = "";
        if (thiz.currentSelectedPaymentPlanKey) {
            thiz.openPaymentPlanDetail(thiz.currentSelectedPaymentPlan);
        } else {
            thiz._init()
        }
        if (this.needToAddDefaultPaymentPlan()) this.openSelectDefaultPaymentPlan();
    });

    this.bind(ClassEditPaymentPlanTab.CPP_SAVE_PLAN, function (event) {
        if(!event.isFirstSetup) thiz._isModified = true;
        thiz.paymentPlansMap[event.paymentPlan.key] = event.paymentPlan;
        if (!event.paymentPlan.name) {
            this.emptyNamePaymentPlanKey = event.paymentPlan.key;
        }
        if(thiz.currentSelectedPaymentPlanKey != event.paymentPlan.Key) {
            thiz.currentSelectedPaymentPlanKey = event.paymentPlan.Key;
            //thiz.editPaymentPlan(event.paymentPlan.key);
        }
        thiz.fillPaymentPlanList(event.paymentPlan.key, event.isEditing);
        thiz.updateClassSummary();
        if (!thiz.paymentPlansMap[thiz.emptyNamePaymentPlanKey] || !thiz.paymentPlansMap[thiz.emptyNamePaymentPlanKey] || thiz.paymentPlansMap[thiz.emptyNamePaymentPlanKey].name) {
            thiz.btnNewPaymentPlan.removeAttribute("disabled");
        } else {
            thiz.btnNewPaymentPlan.setAttribute("disabled", true);
        }
    });


    this.bind(ClassEditPaymentPlanTab.CPP_CHANGE_REGISTRATION_DEFAULT, function (event) {
        var thiz = this;
        if (event.paymentPlan.defaultInRegistration) {
            for (key in thiz.paymentPlansMap) {
                if (key != event.paymentPlan.key) thiz.paymentPlansMap[key].defaultInRegistration = false;
            }
        }
        if (this.needToAddDefaultPaymentPlan()) this.openSelectDefaultPaymentPlan();
    });


    this.bind(ClassEditPaymentPlanTab.SAVE_GOTO_ASSIGN_STUDENT, function(event) {
        if (event.fromClassTool && typeof(thiz.options.reloadCallback) == "function") {
            thiz.options.reloadCallback({from: "assignStudent"});
            return;
        }
        if ((typeof(thiz.options.saveCallback) == "function") && !!!event.fromClassTool) {
            thiz.options.saveCallback({openAssign: true, openedPaymentPlanKey: event.openedPaymentPlanKey});
        }
    });

    this.setupPaymentPlanList();
}

ClassEditPaymentPlanTab.CPP_DELETE_PLAN = "cpp::DeletePan";
ClassEditPaymentPlanTab.CPP_SAVE_PLAN = "cpp::SavePlan";
ClassEditPaymentPlanTab.CPP_CHANGE_REGISTRATION_DEFAULT = "cpp::ChangeRegistrationDefault";

// ClassEditPaymentPlanTab.CPP_ASSIGNED_STUDENT_CHANGE = "cpp::AssignedStudentsChange";
ClassEditPaymentPlanTab.CPP_REVENUE_CHANGE = "cpp::PaymentPlanRevenueChange";
ClassEditPaymentPlanTab.SAVE_GOTO_ASSIGN_STUDENT = "cpp::saveAndContinueAssign";
ClassEditPaymentPlanTab.RATE_PLAN_CHANGE = "cpp::ratePlanChange";

__extend(BaseTemplatedWidget, ClassEditPaymentPlanTab);

ClassEditPaymentPlanTab.prototype.onAttached = function() {
    window.setTimeout(this.onAttachedDelayed.bind(this), 10);
};

ClassEditPaymentPlanTab.prototype.reloadClass = function (event) {
    console.log("ClassEditPaymentPlanTab reloadClass with data:", event.data);
    if (event.data.reloadClass && typeof(this.options.reloadCallback) == "function") {
        this.options.reloadCallback({from: "assignStudent"});
    }
};

ClassEditPaymentPlanTab.prototype.syncClassData = function(classInfo) {
    this.classInfo = classInfo;
    console.log("SYNC ClassEditPaymentPlanTab", this.classInfo);
    window.setTimeout(this._init.bind(this), 10);
};

ClassEditPaymentPlanTab.prototype.onAttachedDelayed = function() {
    //this._init();
};
ClassEditPaymentPlanTab.prototype.openAssign = function(options) {
    !this.paymentPlanWidget || this.paymentPlanWidget.openAssign(options);
};
ClassEditPaymentPlanTab.prototype.requestSettingData = function() {
    var thiz = this;
    $classAdminService.getAdminSetting(function(data) {
        thiz.coaSettingList = data.coaSettingList.filter(function(item) {
            return item.hidden == false;
        });
    });
};

ClassEditPaymentPlanTab.prototype.getFocusPaymentPlanKey = function() {
    return this.currentSelectedPaymentPlanKey;
};

ClassEditPaymentPlanTab.prototype.isClassDataChanged = function() {
    return this._isModified;
};

ClassEditPaymentPlanTab.prototype._init = function (){
    var notEnoughInfo = (!this.classInfo.progId || !this.classInfo.subProgId || !this.classInfo.dateStart ||  !this.classInfo.dateEnd ||
         !this.classInfo.slots || (this.classInfo.slots && this.classInfo.slots.length == 0)) && (!this.classInfo.paymentPlans || !this.classInfo.paymentPlans.length);
    var noSlotFound = this.classInfo.paymentPlans && this.classInfo.paymentPlans.length && (!this.classInfo.slots || (this.classInfo.slots && this.classInfo.slots.length == 0));

    Dom.hasClass(this.paymentPlansContainer, "PaymentPlanError") || Dom.addClass(this.paymentPlansContainer, "PaymentPlanError");
    if (this.classInfo && this.classInfo.paymentPlans && this.classInfo.paymentPlans.length && !notEnoughInfo && !noSlotFound) {
        Dom.removeClass(this.paymentPlansContainer, "PaymentPlanError");
    }

    this.updateClassOverviewHeader();
    if (this.classInfo.familyRegFee > 0) {
        Dom.removeClass(this.editClassRegFeeLink, "Hidden");
    } else {
        Dom.addClass(this.editClassRegFeeLink, "Hidden");
    }

    if(notEnoughInfo) {
        Dom.hasClass(this.paymentPlansContainer, "NotEnoughInfo") || Dom.addClass(this.paymentPlansContainer, "NotEnoughInfo");
        this.btnNewPaymentPlanFromBlank.setAttribute("disabled", true);
        var p = this.paymentPlansContainer.querySelector(".NoPaymentPlansPane .Warning.NotEnoughInfo");
        (!p || !Dom.hasClass(p, "Hidden")) || Dom.removeClass(p, "Hidden");
        p = this.paymentPlansContainer.querySelector(".NoPaymentPlansPane .Warning.NoSlot");
        (!p || Dom.hasClass(p, "Hidden")) || Dom.addClass(p, "Hidden");
        return;
    } else if (noSlotFound){
        Dom.hasClass(this.paymentPlansContainer, "NotEnoughInfo") || Dom.addClass(this.paymentPlansContainer, "NotEnoughInfo");
        var p = this.paymentPlansContainer.querySelector(".NoPaymentPlansPane .Warning.NotEnoughInfo");
        (!p || Dom.hasClass(p, "Hidden")) || Dom.addClass(p, "Hidden");
        p = this.paymentPlansContainer.querySelector(".NoPaymentPlansPane .Warning.NoSlot");
        (!p || !Dom.hasClass(p, "Hidden")) || Dom.removeClass(p, "Hidden");
        return;
    } else {
        Dom.removeClass(this.paymentPlansContainer, "NotEnoughInfo");
        this.btnNewPaymentPlanFromBlank.removeAttribute("disabled");
        this.updatePaymentPlanOfClass(this.options.activePaymentPlanKey? this.options.activePaymentPlanKey : null);
        this.options.activePaymentPlanKey = null;
        return;
    }
};

ClassEditPaymentPlanTab.prototype.openPaymentPlanDetail = function(pp) {
    var thiz = this;
    this.currentSelectedPaymentPlan = pp;
    this.paymentPlanDetailContainer.innerHTML = "";
    var data = {classId: this.classId,
        classInfo: this.classInfo,
        filters: this.options.filters,
        validateChangeCallback: this.options.validateChangeCallback};

    var key = Util.newUUID();
    if (!pp) {
        pp = {
            visibleInRegistration: true,
            key: key,
            name: ""
        };
        thiz.paymentPlansMap[key] = pp;
    }
    /*
    if (window.LOGIN_INFO.allowWaiver) {
        if ((this.needToAddDefaultPaymentPlan() || Object.keys(thiz.paymentPlansMap).length === 0) && !pp.id && (!pp.name || !pp.name.length)) pp.defaultInRegistration = true;
    }*/
    if ((this.needToAddDefaultPaymentPlan() || Object.keys(thiz.paymentPlansMap).length === 0) && !pp.id && (!pp.name || !pp.name.length)) pp.defaultInRegistration = true;

    data["paymentPlan"] = pp;

    if (!thiz.emptyNamePaymentPlanKey || !thiz.paymentPlansMap[thiz.emptyNamePaymentPlanKey] || thiz.paymentPlansMap[thiz.emptyNamePaymentPlanKey].name) {
        thiz.btnNewPaymentPlan.removeAttribute("disabled");
    } else {
        thiz.btnNewPaymentPlan.setAttribute("disabled", true);
    }
    var thiz = this;
    widget.__ensureNamespaceLoaded("clpayplan", function (clpayplan) {
        thiz.paymentPlanWidget = new clpayplan.PaymentPlanWidget(data).into(thiz.paymentPlanDetailContainer);
        var o = null;
        if (thiz.options && thiz.options.openAssign && thiz.options.activePaymentPlanKey) {
            o = {openAssign: true, activePaymentPlanKey: thiz.options.activePaymentPlanKey};
        }
        thiz.paymentPlanWidget.setup(o);
    });
};

ClassEditPaymentPlanTab.prototype.needToAddDefaultPaymentPlan = function () {
//    if (!window.LOGIN_INFO.allowWaiver) return false;
    var hasDefaultPaymentPlan = false, hasVisiblePaymentPlan = false;
    for (var key in this.paymentPlansMap) {
        if (this.paymentPlansMap[key] && this.paymentPlansMap[key].visibleInRegistration) {
            hasVisiblePaymentPlan = true;
            if (this.paymentPlansMap[key] && this.paymentPlansMap[key].defaultInRegistration) {
                hasDefaultPaymentPlan = true;
            }
        }
    }
    return hasVisiblePaymentPlan && !hasDefaultPaymentPlan;
};

ClassEditPaymentPlanTab.prototype.updateClassOverviewHeader = function(){
    this.paymentPlansOverview.innerHTML = (this.classInfo && this.classInfo.paymentPlans && this.classInfo.paymentPlans.length)? this.classInfo.paymentPlans.length : 0;
    if(this.classInfo.paymentPlans) {
        var totalStudents = 0;
        var totalRevenue = 0;
        for (var i =0; i < this.classInfo.paymentPlans.length; i++){
            var p = this.classInfo.paymentPlans[i];
            totalStudents += (p.assignedStudents? p.assignedStudents.length : 0);
            totalRevenue += p.revenue;
        }
        this.studentsOverview.innerHTML = totalStudents;
        this.revenueOverview.innerHTML = Util.toCurrency(totalRevenue);
    } else {
        this.studentsOverview.innerHTML = 0;
        this.revenueOverview.innerHTML = Util.toCurrency(0);
    }
}

ClassEditPaymentPlanTab.prototype.validateClassData = function(){
    if(this.getPaymentPlans() && this.getPaymentPlans().length && this.paymentPlanWidget && !this.paymentPlanWidget.validate()) return false;
    var paymentPlans = this.getPaymentPlans();
    if (!paymentPlans || !paymentPlans.length) return true;
    for (var i = 0; i < paymentPlans.length; i++) {
        var pp = paymentPlans[i];
        if (!pp.name) {
            Dialog.error("There is a payment plan without name. Please update it before saving");
            return false;
        }
    }

    return true;
}

ClassEditPaymentPlanTab.prototype.getPaymentPlans =  function() {
    var pps = [];
    for(var k in this.paymentPlansMap) {
        pps.push(this.paymentPlansMap[k]);
    }
    return pps;
}

ClassEditPaymentPlanTab.prototype.updateClassData = function(classData){
};

ClassEditPaymentPlanTab.prototype.updateClassSummary = function() {
    this.paymentPlans = this.getPaymentPlans();
    this.classInfo["paymentPlans"] = this.paymentPlans;
    this.updateClassOverviewHeader();
}

ClassEditPaymentPlanTab.prototype.addPaymentPlanHandlerFromBlank = function () {
    Dom.removeClass(this.paymentPlansContainer, "PaymentPlanError");
    Dom.addClass(this.paymentPlansContainer, "Editing NewPaymentPlan");
    this.btnNewPaymentPlan.setAttribute("disabled", true);
    this.openPaymentPlanDetail();
};

ClassEditPaymentPlanTab.prototype.addPaymentPlanHandler = function () {
    this.btnNewPaymentPlan.setAttribute("disabled", true);
    this.openPaymentPlanDetail();
    var activePP = this.paymentPlanList.node().querySelector(".PaymentPlan.Active");
    if(activePP) Dom.removeClass(activePP, "Active");
};

ClassEditPaymentPlanTab.prototype.copyFromExistingPlan = function() {
    var thiz = this;
    widget.__ensureNamespaceLoaded("clpayplan", function (clpayplan) {
        new clpayplan.PaymentPlanSelectorDialog().callback(function(plans) {
            if (!plans) return;
            plans.forEach(function(plan) {
                thiz.paymentPlansMap[plan.key] = plan;
                thiz.fillPaymentPlanList(plan.key, false);
            });
            thiz.currentSelectedPaymentPlanKey = plans[plans.length - 1].key;
            thiz._isModified = true;
            thiz.updateClassSummary();
            if (thiz.needToAddDefaultPaymentPlan()) thiz.openSelectDefaultPaymentPlan();

        }).open(thiz.classInfo);
    });
};

ClassEditPaymentPlanTab.prototype.savePlan = function(plan) {
    thiz.paymentPlansMap[plan.key] = plan;
    if (!plan.name) {
        this.emptyNamePaymentPlanKey = plan.key;
    }
    if (thiz.currentSelectedPaymentPlanKey != plan.Key) {
        thiz.currentSelectedPaymentPlanKey = plan.Key;
    }
    thiz._isModified = true;
    thiz.fillPaymentPlanList(plan.key, false);
    thiz.updateClassSummary();
}

ClassEditPaymentPlanTab.prototype.editPaymentPlan = function (ppKey) {
    var pp = this.paymentPlansMap[ppKey];
    if (pp) {
        this.openPaymentPlanDetail(pp);
    }
};

ClassEditPaymentPlanTab.prototype.editClassRegFee = function() {
    var thiz = this;
    widget.__ensureNamespaceLoaded("clpayplan", function (clpayplan) {
        new clpayplan.ClassRegFeeEditDialog().callback(function(data) {
            if (!data) return;
            var isFeeChange = thiz.classInfo.familyRegFee != data.familyRegFee;
            if(isFeeChange || thiz.classInfo.familyRegCoaId != data.familyRegCoaId) {
                thiz._isModified = true;
            }
            thiz.classInfo.familyRegFee = data.familyRegFee;
            thiz.classInfo.familyRegCoaId = data.familyRegCoaId;
            if (isFeeChange && thiz.paymentPlanWidget) {
                thiz.updatePaymentPlanOfClass();
                thiz.paymentPlanWidget.updateClassInfo(thiz.classInfo);
                thiz.paymentPlanWidget.updateProjectorHandler();
            }
        }).open({classInfo: thiz.classInfo, filters: thiz.options.filters});
    });
};

ClassEditPaymentPlanTab.prototype.updatePaymentPlanOfClass = function(selectedKey, isEditing) {
    if (!this.classInfo.paymentPlans || !this.classInfo.paymentPlans.length){
        return;
    }
    for(var i = 0; i < this.classInfo.paymentPlans.length; i++) {
        var pp = this.classInfo.paymentPlans[i];
        if (!selectedKey && !this.currentSelectedPaymentPlanKey) {
            selectedKey = pp.key;
        }
        //if (pp.key == this.currentSelectedPaymentPlanKey) continue;
        if (!pp.items || !pp.items.length) {
            pp.items = [];
            if (this.classInfo.familyRegFee){
                pp.items.push(PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.FAMILY_REG_FEE, this.classInfo.familyRegFee));
            }
            if (this.classInfo.enableAnnualRegAccount && this.options.filters.annualRegAccountAmt > 0){
                pp.items.push(PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.ANNUAL_REG_ACCOUNT, this.options.filters.annualRegAccountAmt));
            }
            if (this.classInfo.enableAnnualRegStudent && this.options.filters.annualRegStudentAmt > 0){
                pp.items.push(PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.ANNUAL_REG_STUDENT, this.options.filters.annualRegStudentAmt));
            }
            continue;
        }
        var newItems = [];
        var existingFamilyRegFee = false,
            existingAnnualRegAccount = false,
            existingAnnualRegStudent = false;
        for(var j = 0; j < pp.items.length; j++) {
            var item = pp.items[j];
            if (item.key == PaymentPlanItemGrid.FAMILY_REG_FEE) {
                if (!this.classInfo.familyRegFee) continue;
                item.amount = this.classInfo.familyRegFee;
                item.totalAmount = this.classInfo.familyRegFee;
                existingFamilyRegFee = true;
            }
            if (item.key == PaymentPlanItemGrid.ANNUAL_REG_ACCOUNT) {
                if (!this.classInfo.enableAnnualRegAccount) continue;
                existingAnnualRegAccount = true;
            }
            if (item.key == PaymentPlanItemGrid.ANNUAL_REG_STUDENT){
                if (!this.classInfo.enableAnnualRegStudent) continue;
                existingAnnualRegStudent = true;
            }
            newItems.push(item);
        }
        if(!existingFamilyRegFee && this.classInfo.familyRegFee) {
            newItems.push(PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.FAMILY_REG_FEE, this.classInfo.familyRegFee));
        }
        if(!existingAnnualRegAccount && this.classInfo.enableAnnualRegAccount && this.options.filters.annualRegAccountAmt > 0) {
            newItems.push(PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.ANNUAL_REG_ACCOUNT, this.classInfo.annualRegAccountAmt));
        }
        if(!existingAnnualRegStudent && this.classInfo.enableAnnualRegStudent && this.options.filters.annualRegStudentAmt > 0) {
            newItems.push(PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.ANNUAL_REG_STUDENT, this.classInfo.annualRegStudentAmt));
        }
        pp.items = newItems;
    }
    this.fillPaymentPlanList(selectedKey? selectedKey : this.currentSelectedPaymentPlanKey, isEditing? true: false);
}

ClassEditPaymentPlanTab.prototype.setupPaymentPlanList = function() {
    var thiz = this;
    this.bind("click", function() {
        var target = Dom.getTarget(event);
        var itemContainer = Dom.findUpwardForNodeWithData( target, "_data");
        if (!itemContainer) return;
        var data = itemContainer._data;
        if(!data || !data.key) return;
        var activeItem = itemContainer.parentNode.querySelector(".Active");
        if(activeItem) Dom.removeClass(activeItem, "Active");
        Dom.addClass(itemContainer, "Active");
        thiz.currentSelectedPaymentPlanKey = data.key;
        thiz.editPaymentPlan(data.key);
    }, this.paymentPlanList.node());

    this.paymentPlanList.populator = function(data, binding, node, index) {
        node._data = data;
        binding.paymentPlanName.innerHTML = data.name;
        binding.paymentPlanName.title = data.name;
        binding.totalItems.innerText = data.totalItems;
        binding.totalStudents.innerText = data.totalStudents;
        binding.totalRevenue.innerText = Util.toCurrency(data.totalRevenue);
        if (data.isActive) {
            Dom.addClass(binding._node, "Active");
        }
    };
};

ClassEditPaymentPlanTab.prototype.fillPaymentPlanList = function(key, isEditing) {
    var items = [];
    var thiz = this;
    var isFirst = true;
    key = "" + key;
    for (var k in this.paymentPlansMap) {
        var pp = this.paymentPlansMap[k];
        var isActive = (!key? isFirst : (pp.key == key));
        items.push({id: (pp.id? pp.id : 0),
            name: pp.name? pp.name : "<i>[No Plan Name]</i>",
            key: pp.key,
            isActive: isActive,
            totalRevenue: pp.revenue,
            totalStudents: (pp.assignedStudents? pp.assignedStudents.length: 0),
            totalItems: (pp.items? pp.items.length: 0)
        });
        isFirst = false;
    }
    if(items.length) {
        var activeKey = "";
        if (key && this.paymentPlansMap[key]) activeKey = key;
        else {
            activeKey = items[0].key;
            items[0].isActive = true;
        }
        this.currentSelectedPaymentPlanKey = activeKey;
        this.paymentPlanList.setItems(items);
        Dom.removeClass(this.paymentPlanList.node(), "PaymentPlanError");
        if (!isEditing) {
            this.editPaymentPlan(activeKey);
        }
        return;
    }
    Dom.addClass(this.paymentPlanList.node(), "PaymentPlanError");
};


ClassEditPaymentPlanTab.prototype.openSelectDefaultPaymentPlan = function () {
    var thiz = this;
    widget.__ensureNamespaceLoaded("clpayplan", function (clpayplan) {
        var visibledPlans = [], listPaymentPlanItems = thiz.paymentPlanList.getItems();

        for (var i = 0; i < listPaymentPlanItems.length; i++) {
            var planItem = thiz.paymentPlansMap[listPaymentPlanItems[i].key];
            if (planItem && planItem.visibleInRegistration) visibledPlans.push(planItem)
        }
        var options = {paymentPlanListItems: visibledPlans};
        new clpayplan.SelectDefaultPaymentPlanDialog().callback(function(plans) {
            if (plans) {
                for (key in thiz.paymentPlansMap) {
                    if (key == plans.key) {
                        thiz.paymentPlansMap[key].defaultInRegistration = true;
                        if (key == thiz.currentSelectedPaymentPlanKey) {
                            thiz.paymentPlanWidget.defaultInRegistration.checked = true;
                        }
                    }
                }
            }
        }).open(options);
    });
};


ClassEditPaymentPlanTab.prototype.updatePaymentPlanItemTimezone = function (paymentPlans, oldTimezoneId, newTimezoneId) {
    if (!paymentPlans) return;
    for (var i = 0; i < paymentPlans.length; i++) {
        var paymentPlan = paymentPlans[i];
        for (var j = 0; j < paymentPlan.items.length; j++) {
            var paymentPlanItem = paymentPlan.items[j];

            if (paymentPlanItem.chargeOverrides && paymentPlanItem.chargeOverrides.length > 0) {
                for (var k = 0; k < paymentPlanItem.chargeOverrides.length; k ++) {
                    var chargeOverride = paymentPlanItem.chargeOverrides[k];
                    if (chargeOverride.fromDate) {
                        chargeOverride.fromDate = ClassUtils.transformTimeZoneToTimeZone(chargeOverride.fromDate, oldTimezoneId, newTimezoneId);
                    }

                    if (chargeOverride.overrideDate) {
                        chargeOverride.overrideDate = ClassUtils.transformTimeZoneToTimeZone(chargeOverride.overrideDate, oldTimezoneId, newTimezoneId);
                    }

                    if (chargeOverride.overrideDueDate) {
                        chargeOverride.overrideDueDate = ClassUtils.transformTimeZoneToTimeZone(chargeOverride.overrideDueDate, oldTimezoneId, newTimezoneId);
                    }
                }
            }

            if (paymentPlanItem.manualChargeDates && paymentPlanItem.manualChargeDates.length > 0) {
                for (var k = 0; k < paymentPlanItem.manualChargeDates.length; k ++) {
                    var manualChargeDate = paymentPlanItem.manualChargeDates[k];
                    if (manualChargeDate.specificChargeDate) {
                        manualChargeDate.specificChargeDate = ClassUtils.transformTimeZoneToTimeZone(manualChargeDate.specificChargeDate, oldTimezoneId, newTimezoneId);
                    }

                    if (manualChargeDate.specificDueDate) {
                        manualChargeDate.specificDueDate = ClassUtils.transformTimeZoneToTimeZone(manualChargeDate.specificDueDate, oldTimezoneId, newTimezoneId);
                    }
                }
            }

            if (paymentPlanItem.specificEndDate) {
                paymentPlanItem.specificEndDate = ClassUtils.transformTimeZoneToTimeZone(paymentPlanItem.specificEndDate, oldTimezoneId, newTimezoneId);
            }
        }
    }
};

ClassEditPaymentPlanTab.prototype.validateUIWithPermission = function () {
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {

    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditQuestionTab.js";

function ClassEditQuestionTab(options) {
    BaseTemplatedWidget.call(this);
    this.loaded = false;
    this.classInfo = options.data;
    this.updatedData = {overrideSubProgQuestion: true};
    this.bind("click", this.invalidateQuestionOptionInfoElements.bind(this), this.useSubProgQuestionRadio);
    this.bind("click", this.invalidateQuestionOptionInfoElements.bind(this), this.useClassCustomQuestionRadio);
    this.bind("click", () => {
        var subProgramQuestionIds = this.subProgramQuestionSettingView.getSelectedQuestionIds();
        this.classQuestionSettingView.setSelectedQuestionIds(subProgramQuestionIds || []);
    }, this.syncWithSubProgramButton);
}
__extend(BaseTemplatedWidget, ClassEditQuestionTab);

ClassEditQuestionTab.prototype.onAttached = function(firstTime) {
    if (!firstTime) return;
    var thiz = this;
    this.subProgName.innerText = this.classInfo ? this.classInfo.subProgName : "";
    
    var selectedUseOptionValue = this.getQuestionUseValue(this.classInfo && this.classInfo.overrideSubProgQuestions);
    this.questionSettingContainer.querySelectorAll(":scope input.QuestionUseOption").forEach((input, i) => {
        input.checked = input.value == selectedUseOptionValue;
    });
    
    this.initQuestionSettingViews(() => {
        if (!thiz.loaded) thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
        thiz.loaded = true;
        thiz.validateUIWithPermission();
        this.invalidateQuestionOptionInfoElements(selectedUseOptionValue);
    });
};

ClassEditQuestionTab.prototype.getClassSubProgramId = function () {
    return this.classInfo && this.classInfo.subProgId || 0;
};

ClassEditQuestionTab.prototype.getClassId = function () {
    return this.classInfo && this.classInfo.id || 0;
};

ClassEditQuestionTab.prototype.updateSubProgQuestionsInfo = function() {
    var thiz = this;
    if (!this.classInfo) return;
    this.subProgName.innerText = this.classInfo ? this.classInfo.subProgName : "";
    thiz.subProgramQuestionSettingView.updateWith(this.getClassSubProgramId());
};

ClassEditQuestionTab.prototype.invalidateQuestionOptionInfoElements = function() {
    var selectedOptionValue = this.getQuestionUseValue(this.useClassCustomQuestionRadio.checked);
    var isClassQuestionUse = this.isClassQuestionUseSelected(selectedOptionValue);
    this.subProgramQuestionSettingView.setEnabled(!isClassQuestionUse);
    this.classQuestionSettingView.setEnabled(isClassQuestionUse);
    this.syncWithSubProgramButton.disabled = !isClassQuestionUse;
};

ClassEditQuestionTab.prototype.getQuestionUseValue = function(overrideSubProgQuestions) {
    return overrideSubProgQuestions ? "CLASS" : "CLASS_SUBPROGRAM";
};

ClassEditQuestionTab.prototype.isClassQuestionUseSelected = function(useValue) {
    return useValue == "CLASS";
};

ClassEditQuestionTab.prototype.initQuestionSettingViews = function(callback) {
    var thiz = this;
    this.subProgramQuestionSettingWrapper.innerHTML = "";
    this.classQuestionSettingWrapper.innerHTML = "";
    widget.__ensureNamespaceLoaded("customquestion", (cqPkg) => {
        var initSubProgramQuestionSettingView = new Promise(function(resolve, reject) {
            thiz.subProgramQuestionSettingView = new cqPkg.QuestionApplicationSettingView({
                "application-type": cqPkg.ModuleData.QUESTION_APPLICATION_TYPE.CLASS_SUBPROGRAM.type,
                "applied-question-only": true
            }).into(thiz.subProgramQuestionSettingWrapper);
            thiz.subProgramQuestionSettingView.initWith(thiz.getClassSubProgramId(), () => resolve());
        });
        
        var initClassQuestionSettingView = new Promise(function(resolve, reject) {
            thiz.classQuestionSettingView = new cqPkg.QuestionApplicationSettingView({
                "application-type": cqPkg.ModuleData.QUESTION_APPLICATION_TYPE.CLASS.type
            }).into(thiz.classQuestionSettingWrapper);
            thiz.classQuestionSettingView.initWith(thiz.getClassId(), () => resolve());
        });
        
        Promise.all([initSubProgramQuestionSettingView, initClassQuestionSettingView]).then(function () {
            callback && callback();
        });
    });
};

ClassEditQuestionTab.prototype.syncClassData = function(classInfo) {
    console.log("# Sync Class Data:", classInfo);
    this.classInfo = classInfo;
    this.updateSubProgQuestionsInfo();
};

ClassEditQuestionTab.prototype.getCurrentInputValues = function() {
    var overrideSubProgQuestions = this.useClassCustomQuestionRadio.checked;
    var questionIds = overrideSubProgQuestions ? this.classQuestionSettingView.getSelectedQuestionIds() : null;
    return {
        overrideSubProgQuestions: overrideSubProgQuestions,
        questionIds: questionIds
    };
}

ClassEditQuestionTab.prototype.setSnapshotInputValues = function(values) {
    if(values && typeof (values) == "object") {
        this._snapshotInputValues = JSON.parse(JSON.stringify(values));
    } else {
        this._snapshotInputValues = values;
    }
}

ClassEditQuestionTab.prototype.isClassDataChanged  = function() {
    if (!this.classInfo) return false;
    var curValues = this.getCurrentInputValues() || {};
    var snapshotValues = this._snapshotInputValues || {};
    return JSON.stringify(snapshotValues) !== JSON.stringify(curValues);
};

ClassEditQuestionTab.prototype.updateClassData = function(data) {
    if (!data || !this.loaded) return;
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) return;
    data.overrideSubProgQuestions = this.useClassCustomQuestionRadio.checked;
    data.questionIds =  data.overrideSubProgQuestions ? this.classQuestionSettingView.getSelectedQuestionIds() : null;
};

ClassEditQuestionTab.prototype.validateUIWithPermission = function () {
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        this.questionSettingContainer.querySelectorAll(":scope input.QuestionUseOption").forEach((input, i) => {
            input.setAttribute("disabled", "disabled");
        });
        this.subProgramQuestionSettingView.setEnabled(false);
        this.classQuestionSettingView.setEnabled(false);
        this.syncWithSubProgramButton.disabled = true;
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditRegSlotTab.js";

function ClassEditRegSlotTab(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
    this.filters = options.filters;
    this.isEditRegSlotDialog = options.isEditRegSlotDialog;
    var thiz = this;
    this.weekdays = LOCALE.WEEKDAYS_SHORT;
    Dom.registerEvent(this.slotContentTable, "focus", this.slotContentTableFocusHandler.bind(this), true);
    Dom.registerEvent(this.slotContentTable, "blur", this.slotContentTableBlurHandler.bind(this), true);
    Dom.registerEvent(this.slotContentTable, "input", this.slotContentTableInputHandler.bind(this), true);
    Dom.registerEvent(this.instructorsPopupContainer, "change", this.selectInstructorHandler.bind(this), true);
    Dom.registerEvent(this.selectAllSlot, "change", this.selectAllSlotChangeHandler.bind(this), true);
    this.bind("click", this.slotContentTableClickHandler, this.slotContentTable);
    this.bind("click", this.applyInstructorButtonClickHandler, this.applyInstructorButton);
    this.bind("click", this.newRegSlotButtonClickHandler, this.newRegSlotButton);
    this.bind("click", this.editRegSlotButtonClickHandler, this.editRegSlotButton);
    this.bind("click", this.clearRegSlotInfoActionClickHandler, this.clearRegSlotInfoAction);
    this.bind("click", this.showInstructorsActionClickHandler, this.showInstructorsAction);
    this.bind("click", this.hideInstructorsActionClickHandler, this.hideInstructorsAction);
    this.bind("click", this.deleteRegSlotActionClickHandler, this.deleteRegSlotAction);
    this.bind("click", this.noLimitSelectionClickHandler, this.noLimitSelection);

    this.bind("p:PopupHidden", function() {
        if(!thiz.instructorsPopup.opener) return;
        Dom.removeClass(thiz.instructorsPopup.opener, "inputing");
        var instructorInput = thiz.instructorsPopup.opener.getElementsByClassName("instructor-input");
        if(instructorInput && instructorInput[0]) {
            instructorInput[0].value = "";
            instructorInput[0].blur();
        }

    }, this.instructorsPopup.node());

    this.bind("click", function(){
        if(Dom.hasClass(thiz.instructionPane, "Collapse")){
            Dom.removeClass(thiz.instructionPane, "Collapse");
            Dom.addClass(thiz.instructionPane, "Expand");
        } else {
            Dom.removeClass(thiz.instructionPane, "Expand");
            Dom.addClass(thiz.instructionPane, "Collapse");
        }

    }, this.instructionAction);
    
    this.bind("p:PopupShown", function (event) {
        if (!event.target) return;
        if (!event.target.__widget) return;
        var popupContainer = event.target.__widget.popupContainer;
        if (!popupContainer) return;
        if (!Dom.hasClass(popupContainer, "AssignedInstructorPopup")) return;
        thiz.bind("mouseover", thiz.showInstructorConflictPopup, popupContainer);
        thiz.bind("mouseout", thiz.hideInstructorConflictPopup, popupContainer);
    }, this.node());
    
    this.bind("mouseover", this.showInstructorConflictPopup, this.slotContentTable);
    this.bind("mouseout", this.hideInstructorConflictPopup, this.slotContentTable);
    this.CONFLICT_CODE = this.options.filters.instructorConflictCode;
    this.CONFLICT_KEY_PATTERN = "{0}_{1}_{2}_{3}";

}
__extend(BaseTemplatedWidget, ClassEditRegSlotTab);

ClassEditRegSlotTab.prototype.onDetached = function() {
    this.instructorsPopup.kill();
    this.actionMenuPopup.kill();
    this.noLimitPopup.kill();
};

ClassEditRegSlotTab.prototype.onAttached = function(firstTime) {
    if (!firstTime) return;
    this.validatedInstructor = this.options.filters.validatedInstructor || {};
    this.classInfo = this.options.data || {id: 0};
    this.renderRegSlotTab();
    this.validateUIWithPermission();
};

ClassEditRegSlotTab.prototype.renderRegSlotTab = function () {
    var thiz = this;
    if (this.isEditRegSlotDialog) {
        Dom.addClass(this.instructionPane, "Hidden");
        Dom.addClass(this.thWaitlistLimit, "Hidden");
        Dom.addClass(this.tdDragDrogCol, "Hidden");
        Dom.addClass(this.thSlotNumber, "EditRegSlotDialog");
    }

    var instructorObject = {};
    for(var i = 0; i < this.filters.instructors.length ; i ++) {
        instructorObject[this.filters.instructors[i].id] = this.filters.instructors[i];
    }
    this.instructorObject = instructorObject;
    var slotInfos = [];
    if(this.options.data && this.options.data.slots && this.options.data.slots.length > 0) {
        slotInfos = this.options.data.slots;
        this.backupSlotData(slotInfos);
    } else {
        var newRegSlot = this.getNewRegSlot();
        newRegSlot.slotOrder = 1;
        slotInfos = [newRegSlot];
    }
    this.selectedSlotCount = 0;
    this.slotInfos = slotInfos;

    for(var i = 0; i < slotInfos.length; i ++) {
        this.renderSlotInfo(slotInfos[i]);
    }
    this.instructorsPopupContainer.parentNode.style.padding = "0 0.5em";
    this.instructorsPopupContainer.parentNode.style.background = "#EEE";
    // this.instructorsPopup.shouldCloseOnBlur = function (e) {
    //     return !Dom.hasClass(e.target, "instructor-input");
    // }

    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
        var dropTargetFinderFunction = function (event, manager) {
            var target = baseFunction(event, manager);
            return target;
        }.bind(this);
        this.dnd = new DragAndDropManager()
        .source(this.slotContentTableBody)
        .anchor(function (node) {
            return Dom.hasClass(node, "DragDrogCol");
        })
        .itemInfo(function (anchor) {
            var item = Dom.findParentByTagName(anchor, "tr");
            if (!item) return null;
            return {
                element: item,
                data: item._rowData
            };
        })
        .destination(this.slotContentTableBody)
        .canDrop(function (data) {
            return true;
        }
        .bind(this))
        .dropAt(dropTargetFinderFunction)
        .setup();

        this.dnd.createDragImageNode = function () {
            var node = Dom.newDOMElement({
                _name: "div",
                "class": "ColumnDrag"
            });
            node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
            node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
            node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
            return node;
        };

        this.dnd.createDropHintNode = function () {
            var node = Dom.newDOMElement({
                _name: "tr",
                "class": "DropHint",
                _children: [{
                    _name: "td",
                    colspan: 13
                }]
            });
            return node;
        };

        this.dnd.onDrop = function (draggable, draggedData, target) {
            if (!draggable || !target) return;
            if (target.mode == DragAndDropManager.DROP_APPEND) {
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                target.element.appendChild(draggable);
            } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
                if (target.element != draggable) {
                    var container = target.element.parentNode;
                    if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                    container.insertBefore(draggable, target.element);
                }
            }
            Dom.addClass(draggable, "JustDropped");

            window.setTimeout(function () {
                Dom.removeClass(draggable, "JustDropped");
            }, 100);

            var rows = thiz.slotContentTableBody.getElementsByTagName("tr");
            for (var i = 0; i < rows.length; i++) {
                rows[i]._rowData.orderNo = i;
            }
            thiz.slotInfos.sort(function(a, b) {
                return a.orderNo - b.orderNo;
            });

        }.bind(this);
    }
};

ClassEditRegSlotTab.prototype.buildSlotTimes = function(){
    var result = {};
    var weekdayIndex = 2;
    for(var i = 0; i < this.weekdays.length; i++){
        if( i == (this.weekdays.length - 1)){ //SUN
            weekdayIndex = 1;
        }
        result[this.weekdays[i]] = {
                classWeekday: i + 1,
                duration: 0,
                id: 0,
                startMin: 0,
                startTime: "",
                weekday: weekdayIndex,
                weekdayName: this.weekdays[i],
                instructors: [],
                editable: true
        };
        weekdayIndex++;
    }
    return result;
};

ClassEditRegSlotTab.prototype.getNewRegSlot = function () {
    return {
        id: 0,
        checked: false,
        maxLimit: "",
        slot: 0,
        slotOpen: 0,
        slotRegister: 0,
        schedByWeekdayName: this.buildSlotTimes(),
        deletable: true,
        editable: true,
        allowShowInstructors: true,
        wailistLimit: 0
    }
};

ClassEditRegSlotTab.prototype.renderSlotInfo = function (slotInfo) {
    var thiz = this;
    if(!slotInfo) return;

    var slotRows = this.slotContentTableBody.getElementsByTagName("tr");
    slotInfo.orderNo = slotRows.length;
    var slotContentTableBody = this.slotContentTableBody;
    var newRow = document.createElement("tr");
    newRow._rowData = slotInfo;
    var selectionCol = document.createElement("td");
    Dom.addClass(selectionCol, "selection");
    var selectionCheckbox = document.createElement("input");
    Dom.addClass(selectionCheckbox, "item-selection");
    selectionCheckbox.setAttribute("type", "checkbox");
    if(slotInfo.checked) {
        selectionCheckbox.setAttribute("checked", "true");
        this.selectedSlotCount ++;
    }
    if(this.selectedSlotCount == this.slotInfos.length) {
        this.selectAllSlot.checked = true;
    } else {
        this.selectAllSlot.checked = false;
    }
    selectionCol.appendChild(selectionCheckbox);
    newRow.appendChild(selectionCol);

    //slot number
    var slotNumberCol = document.createElement("td");
    Dom.addClass(slotNumberCol, "slot-number");
    if (this.isEditRegSlotDialog) {
        var slotNumberInput = document.createElement("input");
        slotNumberInput.setAttribute("type", "text");
        slotNumberInput.setAttribute("length", "3");
        slotNumberInput.value = slotInfo.slotOrder;
        Dom.addClass(slotNumberInput, "InputSlotNumber");
        slotNumberCol.appendChild(slotNumberInput);
        Dom.addClass(slotNumberCol, "EditRegSlotDialog");
    } else {
        var slotIndex = document.createElement("div");
        Dom.addClass(slotIndex, "slot-index");
        slotIndex.innerHTML = slotInfo.slotOrder;
        slotNumberCol.appendChild(slotIndex);
    }
    newRow.appendChild(slotNumberCol);

    var dragSlotSpan = document.createElement("div");
    Dom.addClass(dragSlotSpan, "drag-slot-indicator");
    var dragIcon = document.createElement("icon");
    Dom.addClass(dragIcon, "drag");
    dragSlotSpan.appendChild(dragIcon);

    var slotLimitCol = document.createElement("td");
    Dom.addClass(slotLimitCol, "slot-limit");
    var slotLimitInput = document.createElement("input");
    slotLimitInput.setAttribute("type", "text");
    Dom.addClass(slotLimitInput, "input-slot-limit");
    slotLimitInput.value = slotInfo.maxLimit;
    slotLimitInput._lastGoodValue = slotInfo.maxLimit;
    if (slotInfo.maxLimit == 99999) slotLimitInput.value = "No Limit";
    slotLimitCol.appendChild(slotLimitInput);
    newRow.appendChild(slotLimitCol);
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        slotLimitInput.setAttribute("disabled", "disabled");
    }
    var waitlistLimitCol = document.createElement("td");
    Dom.addClass(waitlistLimitCol, "WaitlistLimit");
    if (this.isEditRegSlotDialog) Dom.addClass(waitlistLimitCol, "Hidden");
    var waitlistLimitInput = document.createElement("input");
    waitlistLimitInput.setAttribute("type", "text");
    Dom.addClass(waitlistLimitInput, "WaitlistLimitInput");
    waitlistLimitInput.value = slotInfo.wailistLimit;
    waitlistLimitCol.appendChild(waitlistLimitInput);
    newRow.appendChild(waitlistLimitCol);
    if (!this._allowWaitlist) {
        waitlistLimitInput.value = 0;
        waitlistLimitInput.setAttribute("disabled", "disabled");
    }
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        waitlistLimitInput.setAttribute("disabled", "disabled");
    }

    for(var i = 0; i < this.weekdays.length; i++){
        this.renderSlotDayInfo(newRow, slotInfo, this.weekdays[i]);
    }

    var showInstructorsCol = document.createElement("td");
    Dom.addClass(showInstructorsCol, "ShowInstructorsCol");
    var showInstructorsIcon = document.createElement("icon");
    if (slotInfo.allowShowInstructors) {
        Dom.addClass(showInstructorsIcon, "eye");
    } else {
        Dom.addClass(showInstructorsIcon, "eye-off");
    }
    showInstructorsCol.appendChild(showInstructorsIcon);
    newRow.appendChild(showInstructorsCol);
    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        var dragDrogCol = document.createElement("td");
        if (this.isEditRegSlotDialog) Dom.addClass(dragDrogCol, "Hidden");
        Dom.addClass(dragDrogCol, "DragDrogCol");
        var dragSlotSpan = document.createElement("div");
        Dom.addClass(dragSlotSpan, "drag-slot-indicator");
        var dragIcon = document.createElement("icon");
        Dom.addClass(dragIcon, "menu");
        dragSlotSpan.appendChild(dragIcon);
        dragDrogCol.appendChild(dragSlotSpan);
        newRow.appendChild(dragDrogCol);
    } else {
        Dom.hide(this.tdDragDrogCol);
    }
    slotContentTableBody.appendChild(newRow);
};

ClassEditRegSlotTab.prototype.renderSlotDayInfo = function (row, slotInfo, dayName) {
    if(!row) return;
    var dayInfo = slotInfo.schedByWeekdayName[dayName];
    if(!dayInfo) {
        var newSlot = this.getNewRegSlot();
        //dayInfo = Object.assign({}, newSlot.schedByWeekdayName[dayName]);
        dayInfo = {};
        for(var key in newSlot.schedByWeekdayName[dayName]){
            dayInfo[key] = newSlot.schedByWeekdayName[dayName][key];
        }
        slotInfo.schedByWeekdayName[dayName] = dayInfo;
    };
    var col = document.createElement("td");
    col._colName = dayName;
    Dom.addClass(col, "slot-info");
    Dom.addClass(col, dayName);
    
    var slotTimeWrapper = document.createElement("div");
    Dom.addClass(slotTimeWrapper, "slot-time");
    
    var canEditSchedTime = false;
    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO) ||
        (dayInfo.instructorIds && dayInfo.instructorIds.indexOf(window.LOGIN_INFO.accountId) >= 0)) {
        canEditSchedTime = true;
    }
        
    var slotTimeInput = document.createElement("input");
    slotTimeInput.setAttribute("type", "text");
    slotTimeInput.setAttribute("maxlength", 5);
    Dom.addClass(slotTimeInput, "slot-time-input");
    if (!canEditSchedTime) {
        slotTimeInput.setAttribute("disabled", "disabled");
        Dom.addClass(slotTimeWrapper, "disabled-control");
    }
    var slotTime = "";
    if(dayInfo.startTime && dayInfo.startTime.length >= 5) {
        slotTime = dayInfo.startTime.substring(0, 5);
        Dom.addClass(slotTimeWrapper, "has-value");
        Dom.addClass(col, "has-time-value");
    }
    slotTimeInput.value = slotTime;
    slotTimeInput._lastGoodValue = slotTime;
    dayInfo.slotTime = slotTime;
    slotTimeWrapper.appendChild(slotTimeInput);
    //watch icon
    var watchIcon = document.createElement("icon");
    Dom.addClass(watchIcon, "clock");
    slotTimeWrapper.appendChild(watchIcon);
    //marker
    var amMarker = document.createElement("span");
    Dom.addClass(amMarker, "time-marker marker-am");
    amMarker.innerHTML = "AM";
    slotTimeWrapper.appendChild(amMarker);
    var pmMarker = document.createElement("span");
    Dom.addClass(pmMarker, "time-marker marker-pm");
    pmMarker.innerHTML = "PM";
    slotTimeWrapper.appendChild(pmMarker);
    var timeMarker = "AM";
    if(dayInfo.startTime && dayInfo.startTime.length >= 8) {
        timeMarker = dayInfo.startTime.substring(6, 8);
    }
    if(timeMarker == "PM") {
        Dom.addClass(slotTimeWrapper, "marker-pm");
    }
    dayInfo.timeMarker = timeMarker;
    col.appendChild(slotTimeWrapper);

    var instructorWrapper = document.createElement("div");
    Dom.addClass(instructorWrapper, "instructors-wrapper");
    if(dayInfo.instructors && dayInfo.instructors.length > 0) {
        Dom.addClass(instructorWrapper, "has-data");
    }
    var selectedInstructorsWrapper = document.createElement("div");
    Dom.addClass(selectedInstructorsWrapper, "selected-instructors-wrapper");
    if(!dayInfo.instructors) dayInfo.instructors = [];
    
    this.renderSelectedInstructors(selectedInstructorsWrapper, slotInfo.slot, dayInfo);
    instructorWrapper.appendChild(selectedInstructorsWrapper);
    
    var instructorInputWrapper = document.createElement("div");
    Dom.addClass(instructorInputWrapper, "instructor-input-wrapper");
    if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        var instructorInput = document.createElement("input");
        instructorInput.setAttribute("type", "text");
        Dom.addClass(instructorInput, "instructor-input");
        instructorInputWrapper.appendChild(instructorInput);
        var iconMdi = document.createElement("icon");
        Dom.addClass(iconMdi, "account-multiple");
        instructorInputWrapper.appendChild(iconMdi);
    }
    
    instructorWrapper.appendChild(instructorInputWrapper);
    col.appendChild(instructorWrapper);
    row.appendChild(col);
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)
        && dayInfo.instructors.length == 0) {
        Dom.hide(instructorWrapper);
    }
};

ClassEditRegSlotTab.prototype.renderSelectedInstructors = function (selectedInstructorsWrapper, slotNo, dayInfo) {
    if(!selectedInstructorsWrapper) return;
    selectedInstructorsWrapper.innerHTML = "";
    if(!dayInfo.instructors) return;
    for (var i = 0; i < dayInfo.instructors.length; i ++) {
        var ins = dayInfo.instructors[i];
        var classId = 0;
        if (this.options.data && this.options.data.id) classId = this.options.data.id;
        var validatedInsKey = String.format(this.CONFLICT_KEY_PATTERN, 
            ins.id, classId, slotNo, dayInfo.classWeekday);
        
        var insEl = this.renderInstructorItem(validatedInsKey, ins);
        selectedInstructorsWrapper.appendChild(insEl);
    }
};

ClassEditRegSlotTab.prototype.renderInstructorItem = function (validatedInsKey, instructor) {
    var validateIns = this.validatedInstructor[validatedInsKey];
    var insEl = Dom.get(validatedInsKey);
    if (!insEl) {
        insEl = Dom.newDOMElement({
            _name: "hbox",
            "class": "InstructorItem",
            "id": validatedInsKey
        });
    }
    
    insEl.innerHTML = "";
    insEl.appendChild(Dom.newDOMElement({
        _name: "div",
        "flex": 1,
        title: instructor.fullName,
        _text: instructor.fullName
    }));
    
    if (!this.isEditRegSlotDialog) {
        Dom.removeClass(insEl, this.CONFLICT_CODE.INSTRUCTOR_NOT_AVAILABLE.key.toLowerCase());
        Dom.removeClass(insEl, this.CONFLICT_CODE.CONFLICT_TIME.key.toLowerCase());
        Dom.removeClass(insEl, this.CONFLICT_CODE.NOT_FULL_DURATION.key.toLowerCase());
        if (ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
            insEl.appendChild(Dom.newDOMElement({
                _name: "icon",
                "class": "RemoveInstructorIcon close-circle"
            }));
        }
        var infoIcon = Dom.newDOMElement({
            _name: "icon",
            "class": "InstructorConflictInfo alert-circle"
        });
        if (validateIns && validateIns.conflictCode) {
            infoIcon.setAttribute("conflictDesc", 
                validateIns.conflictedCustomMessage ? validateIns.conflictedCustomMessage : this.CONFLICT_CODE[validateIns.conflictCode].desc);
            Dom.addClass(insEl, validateIns.conflictCode.toLowerCase());
        }
        insEl.appendChild(infoIcon);
    }
    insEl._instructorId = instructor.id;
    insEl._instructorFullName = instructor.fullName;
    return insEl;
};


ClassEditRegSlotTab.prototype.slotContentTableClickHandler = function (e) {
    var removeInsIcon = Dom.findParentWithClass(e.target, "RemoveInstructorIcon");
    if(Dom.hasClass(e.target, "time-marker")) {
        this.timeMarkerClickHandler(e.target);
    } else if(Dom.hasClass(e.target, "item-selection")) {
        this.selectItemClickHandler(e.target);
    } else if(Dom.hasClass(e.target, "instructor-input")) {
        e.stopPropagation();
    } else if (Dom.hasClass(e.target, "eye") || Dom.hasClass(e.target, "eye-off")) {
        this.toggleShowInstructorsHandler(e.target);
    } else if (removeInsIcon) {
        var _colName = Dom.findUpwardForData(removeInsIcon, "_colName");
        var _slotData = Dom.findUpwardForData(removeInsIcon, "_rowData");
        var _instructorId = Dom.findUpwardForData(removeInsIcon, "_instructorId");
        var insEl = Dom.findParentWithClass(removeInsIcon, "InstructorItem");
        if (!_colName) return;
        if (!_slotData) return;
        if (!_instructorId) return;
        var _schedData = _slotData.schedByWeekdayName[_colName];
        if (!_schedData) return;
        
        var instructors = _schedData.instructors;
        var instructorIds = _schedData.instructorIds;
        var newInstructors = [];
        var newInstructorIds = [];
        if (instructors && instructors.length > 0) {
            for (var i = 0; i < instructors.length; i ++) {
                if (instructors[i].id != _instructorId) {
                    newInstructors.push(instructors[i]);
                    newInstructorIds.push(instructors[i].id);
                }
            }
        }
        _schedData.instructors = newInstructors;
        _schedData.instructorIds = newInstructorIds;
        if (newInstructors.length > 0) {
            Dom.addClass(insEl.parentNode.parentNode, "has-data");
        } else {
            Dom.removeClass(insEl.parentNode.parentNode, "has-data");
        }
        if (insEl) insEl.parentNode.removeChild(insEl);
        
        var thiz = this;
        this.validateClassInstructorsOnSched(newInstructorIds, [_instructorId], _slotData.slot, _schedData.classWeekday, _schedData.startMin, function (res) {
            if (res && res.validatedInstructors) thiz.renderInstructorsOnSched(res.validatedInstructors);
        });
    } else {
        var selectedInstructorsWrapper = Dom.findParentWithClass(e.target, "selected-instructors-wrapper");
        if(selectedInstructorsWrapper) {
            Dom.addClass(selectedInstructorsWrapper.parentNode, "inputing");
            var instructorInput = selectedInstructorsWrapper.parentNode.getElementsByClassName("instructor-input");
            if(instructorInput && instructorInput.length > 0) {
                window.setTimeout(function() {
                    instructorInput[0].focus();
                }, 200);
            }
        }
    }
};

ClassEditRegSlotTab.prototype.newRegSlotButtonClickHandler = function (e) {
    var slotOrder = 1;
    var slotRows = this.slotContentTableBody.getElementsByTagName("tr");
    for (var i = 0; i < slotRows.length; i++) {
        if(slotRows[i]._rowData.slotOrder >= slotOrder) {
            slotOrder = slotRows[i]._rowData.slotOrder + 1;
        }
    }
    var newRegSlotItem = this.getNewRegSlot();
    newRegSlotItem.slotOrder = slotOrder;
    newRegSlotItem.slot = slotOrder - 1;
    this.slotInfos.push(newRegSlotItem);
    this.renderSlotInfo(newRegSlotItem);
    this.selectAllSlot.checked = false;
};

ClassEditRegSlotTab.prototype.timeMarkerClickHandler = function (target) {
    var slotTimeWrapper = Dom.findParentWithClass(target, "slot-time");
    if(!slotTimeWrapper) return;
    var _colName = Dom.findUpwardForData(slotTimeWrapper, "_colName");
    var _slotData = Dom.findUpwardForData(slotTimeWrapper, "_rowData");
    if (!_colName) return;
    if (!_slotData) return;
    var _schedData = _slotData.schedByWeekdayName[_colName];
    if (!_schedData) return;
    var timeMarker;
    if(Dom.hasClass(target, "marker-am")) {
        Dom.removeClass(slotTimeWrapper, "marker-am");
        Dom.addClass(slotTimeWrapper, "marker-pm");
        timeMarker = "PM";
    } else {
        Dom.addClass(slotTimeWrapper, "marker-am");
        Dom.removeClass(slotTimeWrapper, "marker-pm");
        timeMarker = "AM";
    }
    _schedData.timeMarker = timeMarker;
    var thiz = this;
    this.validateClassInstructorsOnSched(_schedData.instructorIds, [], _slotData.slot, _schedData.classWeekday, _schedData.startMin, function (res) {
        if (res && res.validatedInstructors) thiz.renderInstructorsOnSched(res.validatedInstructors);
    });
};

ClassEditRegSlotTab.prototype.selectItemClickHandler = function (target) {
    var slotData = Dom.findUpwardForNodeWithData(target, "_rowData");
    if(!slotData) return;
    slotData._rowData.checked = target.checked;
    if(target.checked) {
        this.selectedSlotCount ++;
    } else {
        this.selectedSlotCount --;
    }
    if(this.selectedSlotCount == this.slotInfos.length) {
        this.selectAllSlot.checked = true;
    } else {
        this.selectAllSlot.checked = false;
    }
    if(this.selectedSlotCount > 0) {
        this.editRegSlotButton.removeAttribute("disabled");
    } else {
        this.editRegSlotButton.setAttribute("disabled", "disabled");
    }
};

ClassEditRegSlotTab.prototype.slotContentTableFocusHandler = function (e) {
    var thiz = this;
    if(Dom.hasClass(e.target, "slot-time-input")) {
        var slotTimeWrapper = Dom.findParentWithClass(e.target, "slot-time");
        if(slotTimeWrapper) Dom.addClass(slotTimeWrapper, "inputing");
    } else if(Dom.hasClass(e.target, "instructor-input")) {
        if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) return
        var instructorWrapper = Dom.findParentWithClass(e.target, "instructors-wrapper");
        if(instructorWrapper) Dom.addClass(instructorWrapper, "inputing");
        var instructorInput = instructorWrapper.getElementsByClassName("instructor-input");
        if(!instructorInput) return;
        if(instructorInput.length <= 0) return;
        this.instructorsPopup.opener = instructorWrapper;
        var row = Dom.findUpwardForNodeWithData(instructorWrapper, "_rowData");
        var col = Dom.findUpwardForNodeWithData(instructorWrapper, "_colName");
        this.instructorsPopup._selectedInstructors = [];
        this.instructorsPopup._selectedTempInstructors = [];
        if(row && col && row._rowData.schedByWeekdayName[col._colName]) {
            if(row._rowData.schedByWeekdayName[col._colName].instructors && row._rowData.schedByWeekdayName[col._colName].instructors.length > 0) {
                for(var i = 0; i < row._rowData.schedByWeekdayName[col._colName].instructors.length; i ++) {
                    this.instructorsPopup._selectedInstructors.push(row._rowData.schedByWeekdayName[col._colName].instructors[i]);
                    this.instructorsPopup._selectedTempInstructors.push(row._rowData.schedByWeekdayName[col._colName].instructors[i]);
                }
            }
            this.renderInstructorPopupContent(this.filters.instructors, 
                this.instructorsPopup._selectedInstructors, function () {
                    thiz.instructorsPopup.show(instructorInput[0], "left-inside", "top", 0, 5, true);
                    thiz.instructorsPopup.setPopupClass("AssignedInstructorPopup");
            });
        }
    } else if (Dom.hasClass(e.target, "input-slot-limit")) {
        var row = Dom.findUpwardForNodeWithData(e.target, "_rowData");
        if(e.target.value.length == 0) {
            this.openedNoLimitPopupRow = row;
            this.noLimitPopup.show(e.target, "left-inside", "top", 0, 5, true);
        }
        if(row && row._rowData && row._rowData.maxLimit == 99999) {
            e.target.value = row._rowData.maxLimit;
        }
    }
};

ClassEditRegSlotTab.prototype.slotContentTableBlurHandler = function (e) {
    if (Dom.hasClass(e.target, "slot-time-input")) {
        var slotTimeWrapper = Dom.findParentWithClass(e.target, "slot-time");
        if (!slotTimeWrapper) return;
        var _colName = Dom.findUpwardForData(slotTimeWrapper, "_colName");
        var _slotData = Dom.findUpwardForData(slotTimeWrapper, "_rowData");
        if (!_colName) return;
        if (!_slotData) return;
        var _schedData = _slotData.schedByWeekdayName[_colName];
        if (!_schedData) return;
        if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
            if (e.target.value.trim().length == 0) {
                Dialog.error("You aren't allowed to clear this slot's time.");
                e.target.value = _schedData.slotTime;
                e.target._lastGoodValue = _schedData.slotTime;
                return;
            }
        }
        var oldStartMin = Util.clone(_schedData.startMin);
        if (!this.calSlotTimeValue(e.target)) return;
        Dom.removeClass(slotTimeWrapper, "inputing");
        if (e.target.value.length > 0) {
            Dom.addClass(slotTimeWrapper, "has-value");
            Dom.addClass(slotTimeWrapper.parentNode, "has-time-value");
        } else {
            Dom.removeClass(slotTimeWrapper, "has-value");
            Dom.removeClass(slotTimeWrapper.parentNode, "has-time-value");
            _schedData.instructors = [];
            _schedData.instructorIds = [];
            _schedData.instructorNames = [];
            instructorsWrapper = slotTimeWrapper.parentNode.getElementsByClassName("instructors-wrapper");
            if (instructorsWrapper.length > 0){
                Dom.removeClass(instructorsWrapper[0], "has-data");
                instructorsWrapper[0].firstChild.innerHTML = "";
            }
        }
        var thiz = this;
        if (oldStartMin != _schedData.startMin) {
            this.validateClassInstructorsOnSched(_schedData.instructorIds, [], _slotData.slot, _schedData.classWeekday, _schedData.startMin, function (res) {
                if (res && res.validatedInstructors) thiz.renderInstructorsOnSched(res.validatedInstructors);
            });
        }
    } else if(Dom.hasClass(e.target, "instructor-input")) {
        var instructorWrapper = Dom.findParentWithClass(e.target, "instructors-wrapper");
    } else if(Dom.hasClass(e.target, "input-slot-limit")) {
        if(e.target.value == "99999") e.target.value = "No Limit";
    }
};

ClassEditRegSlotTab.prototype.slotContentTableInputHandler = function (e) {
    var thiz = this;
    if(Dom.hasClass(e.target, "input-slot-limit")) {
        if(e.target.value.length > 5 || isNaN(e.target.value)) {
            if(!e.target._lastGoodValue) e.target._lastGoodValue = "";
            e.target.value = e.target._lastGoodValue;
            return;
        } else {
            e.target._lastGoodValue = e.target.value;
        }
        var row = Dom.findUpwardForNodeWithData(e.target, "_rowData");
        if(row && row._rowData) row._rowData.maxLimit = e.target.value;
        if(e.target.value.length == 0) {
            this.openedNoLimitPopupRow = row;
            this.noLimitPopup.show(e.target, "left-inside", "top", 0, 5, true);
        } else {
            this.openedNoLimitPopupRow = null;
            this.noLimitPopup.hide();
        }
    } else if(Dom.hasClass(e.target, "InputSlotNumber")) {
        var row = Dom.findUpwardForNodeWithData(e.target, "_rowData");
        if (e.target.value.length == 0) {
            row._rowData.slot = -1;
            return;
        }
        if(isNaN(e.target.value)) {
            if(!e.target._lastGoodValue) e.target._lastGoodValue = "";
            e.target.value = e.target._lastGoodValue;
            return;
        } else {
            e.target._lastGoodValue = e.target.value;
        }
        if(row && row._rowData) {
            var s = parseInt(e.target.value);
            row._rowData.slot = s > 0 ? s - 1: 0;
        }
    } else if(Dom.hasClass(e.target, "slot-time-input")) {
        var row = Dom.findUpwardForNodeWithData(e.target, "_rowData");
        var col = Dom.findUpwardForNodeWithData(e.target, "_colName");
        if(e.target.value.trim().length == 4 && e.target.value.trim().indexOf(":") < 0) {
            e.target.value = e.target.value.trim().substring(0, 2) + ":" + e.target.value.trim().substring(2, 4);
        }
        var re = new RegExp(":", "g");
        var timeValue = e.target.value.trim().replace(re, '');
        if(isNaN(timeValue)) {
            if(!e.target._lastGoodValue) e.target._lastGoodValue = "";
            e.target.value = e.target._lastGoodValue;
            return;
        } else {
            e.target._lastGoodValue = e.target.value.trim();
        }
    } else if(Dom.hasClass(e.target, "instructor-input")) {
        if(this.inputingInstructorTimeout) {
            clearTimeout(this.inputingInstructorTimeout);
        }
        this.inputingInstructorTimeout = window.setTimeout(function() {
            thiz.filterInstructors(e.target);
        }, 200);
    } else if(Dom.hasClass(e.target, "WaitlistLimitInput")) {
        if(e.target.value.length > 5 || isNaN(e.target.value)) {
            if(!e.target._lastGoodValue) e.target._lastGoodValue = "";
            e.target.value = e.target._lastGoodValue;
            return;
        } else {
            e.target._lastGoodValue = e.target.value;
        }
        var row = Dom.findUpwardForNodeWithData(e.target, "_rowData");
        if(row && row._rowData) row._rowData.wailistLimit = e.target.value;
    }
};

ClassEditRegSlotTab.prototype.calSlotTimeValue = function(target) {
    var row = Dom.findUpwardForNodeWithData(target, "_rowData");
    var col = Dom.findUpwardForNodeWithData(target, "_colName");
    if(!(row && col && row._rowData.schedByWeekdayName[col._colName])) return;
    var colValue = row._rowData.schedByWeekdayName[col._colName];
    if(target.value.length == 0) {
        if(colValue.hasAttendance) {
            if(colValue.startTime && colValue.startTime.length >= 5) {
                slotTime = colValue.startTime.substring(0, 5);
            }
            target.value = slotTime;
            target._lastGoodValue = slotTime;
            var timeMarker = "AM";
            if(colValue.startTime && colValue.startTime.length >= 8) {
                timeMarker = colValue.startTime.substring(6, 8);
            }
            Dom.removeClass(target.parentNode, "marker-am");
            Dom.removeClass(target.parentNode, "marker-pm");
            if(timeMarker == "PM") {
                Dom.addClass(target.parentNode, "marker-pm");
            } else {
                Dom.addClass(target.parentNode, "marker-am");
            }
            var message = "You cannot delete this time slot because attendance has already been taken.";
            Dialog.error(message, "", function() {
                window.setTimeout(function() {
                    target.select();
                }, 200);
            });
            return false;
        }
        colValue.startMin = 0;
        colValue.slotTime = "";
        colValue.startTime = "";
        return true;
    }
    if(target.value.length > 0 && target.value.length <= 2) {
        var hoursValue = this.calHourValue(target.value, target);
        if(hoursValue == null) return false;
        if(hoursValue >= 12) {
            colValue.timeMarker = "PM";
            if(hoursValue > 12) hoursValue = hoursValue - 12;
        } else {
            colValue.timeMarker = "AM";
        }
        if(hoursValue < 10) hoursValue = "0" + hoursValue;
        hoursValue = hoursValue + ":00";
        target.value = hoursValue;
    } else if(target.value.length == 5 && target.value.indexOf(":") < 0) {
        if(target.value.indexOf(":") < 0) {
            var message = "Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots and try to save again.";
            Dialog.error(message, "", function() {
                window.setTimeout(function() {
                    target.select();
                }, 200);
            });
            return false;
        }
    } else if(target.value.length > 0) {
        var hour = target.value.substring(0, 1),
            minute = target.value.substring(1, target.value.length);

        if(target.value.indexOf(":") > 0) {
            hour = target.value.substring(0, target.value.indexOf(":")),
            minute = target.value.substring(target.value.indexOf(":") + 1, target.value.length);
        }

        var hoursValue = this.calHourValue(hour, target);
        if(hoursValue == null) return;
        if(hoursValue >= 12) {
            colValue.timeMarker = "PM";
            if(hoursValue > 12) hoursValue = hoursValue - 12;
        } else {
            colValue.timeMarker = "AM";
        }
        if(hoursValue < 10) hoursValue = "0" + hoursValue;
        var minuteValue = this.calMinuteValue(minute, target);
        if(minuteValue == null) return;
        if(minuteValue < 10) minuteValue = "0" + minuteValue;
        target.value = hoursValue + ":" + minuteValue;
    }

    colValue.slotTime = target.value;
    var slotTimeWrapper = Dom.findParentWithClass(target, "slot-time");
    if(colValue.timeMarker == "PM") {
        Dom.removeClass(slotTimeWrapper, "marker-am");
        Dom.addClass(slotTimeWrapper, "marker-pm");
    } else {
        Dom.addClass(slotTimeWrapper, "marker-am");
        Dom.removeClass(slotTimeWrapper, "marker-pm");
    }
    colValue.startMin = this.computeDurationFromTime(colValue.slotTime, (colValue.timeMarker.toUpperCase() != "PM"));
    return true;
};

ClassEditRegSlotTab.prototype.calHourValue = function(hoursValue, target) {
    if(isNaN(hoursValue) || parseInt(hoursValue) > 24) {
        var message = "Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots and try to save again.";
        Dialog.error(message, "", function() {
            window.setTimeout(function() {
                target.select();
            }, 200);
        });
        return null;
    }
    hoursValue = parseInt(hoursValue);
    if(hoursValue == 0 || hoursValue == 24) {
        return 0;
    }
    return hoursValue;
};

ClassEditRegSlotTab.prototype.calMinuteValue = function(minuteValue, target) {
    if(isNaN(minuteValue) || parseInt(minuteValue) > 59) {
        var message = "Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots and try to save again.";
        Dialog.error(message, "", function() {
            window.setTimeout(function() {
                target.select();
            }, 200);
        });
        return null;
    }
    minuteValue = parseInt(minuteValue);
    return minuteValue;
};

ClassEditRegSlotTab.prototype.filterInstructors = function (target) {
    var thiz = this;
    var filteredInstructors = this.filters.instructors.filter(function(item) {
        return item.fullName.toUpperCase().indexOf(target.value.toUpperCase()) >= 0;
    });
    
    var filteredInstructorObject = {};
    for (var i = 0; i < filteredInstructors.length; i++) {
        filteredInstructorObject["lcdInstructor_" + filteredInstructors[i].id] = filteredInstructors[i];
    }
    
    var insItem = this.instructorsPopupContainer.getElementsByTagName("input");
    for (var i = 0; i < insItem.length; i++) {
        var id = insItem[i].getAttribute("id");
        if (filteredInstructorObject[id]) {
            Dom.removeClass(insItem[i].parentNode, "Hidden");
        } else {
            Dom.addClass(insItem[i].parentNode, "Hidden");
        }
    }
};

ClassEditRegSlotTab.prototype.renderInstructorPopupContent = function (instructors, selectedInstructors, callback) {
    this.instructorsPopupContainer.innerHTML = "";
    if (!instructors) return;
    if (instructors.length <= 0) return;
    var thiz = this;
    var selectedInstructorObject = {};
    if (selectedInstructors && selectedInstructors.length > 0) {
        selectedInstructors.forEach(function (ins) {
            selectedInstructorObject[ins.id] = ins;
        });
    }
    var slotInfo = Dom.findUpwardForData(thiz.instructorsPopup.opener, "_rowData");
    var schedName = Dom.findUpwardForData(thiz.instructorsPopup.opener, "_colName");
    var schedData = slotInfo.schedByWeekdayName[schedName];
    if (this.options.isEditRegSlotDialog) {
        instructors.forEach(function (ins) {
            var checkboxId = "lcdInstructor_" + ins.id;
            var checkbox = Dom.newDOMElement({
                _name: "input",
                "type": "checkbox",
                "id": checkboxId,
                "class": "select-intructor",
                "value": ins.id
            });
            if (selectedInstructorObject[ins.id]) checkbox.setAttribute("checked", "checked");
            var _children = [checkbox, {
                _name: "label",
                "flex": "1",
                "for": checkboxId,
                _text: ins.fullName,
                "title": ins.fullName
            }];
            var wrapper = Dom.newDOMElement({
                _name: "hbox",
                "class": "item-wrapper",
                _children: _children
            });
            thiz.instructorsPopupContainer.appendChild(wrapper);
        });
        if (callback) callback();
    } else {
        var classData = this.options.buildClassData();
        $classAdminService.getValidatedInstructorsToAssignOnSchedAsync(classData, slotInfo.slot, schedData.classWeekday, schedData.startMin, function (jobId) {
            thiz._onJobExecuted(jobId, function (results) {
                var validatedInstructor = results.validatedInstructors;
                instructors.forEach(function (ins) {
                    var checkboxId = "lcdInstructor_" + ins.id;
                    var checkbox = Dom.newDOMElement({
                        _name: "input",
                        "type": "checkbox",
                        "id": checkboxId,
                        "class": "select-intructor",
                        "value": ins.id
                    });
                    if (selectedInstructorObject[ins.id]) checkbox.setAttribute("checked", "checked");
                    
                    var _children = [checkbox, {
                        _name: "label",
                        "flex": "1",
                        "for": checkboxId,
                        _text: ins.fullName,
                        "title": ins.fullName
                    }];
                    
                    var validatedInsKey = String.format(thiz.CONFLICT_KEY_PATTERN, 
                        ins.id, thiz.classInfo.id, slotInfo.slot, schedData.classWeekday);
                    
                    var instructorPopupItemClass = "";
                    var validatedIns = validatedInstructor[validatedInsKey];
                    if (validatedInstructor && validatedIns && validatedIns.conflictCode && validatedIns.conflictCode != thiz.CONFLICT_CODE.NO_CONFLICT.key) {
                        _children.push({
                            _name: "icon",
                            "class": "InstructorConflictInfo alert-circle",
                            "conflictdesc": validatedIns.conflictedCustomMessage? validatedIns.conflictedCustomMessage : thiz.CONFLICT_CODE[validatedIns.conflictCode].desc
                        });
            
                        instructorPopupItemClass = validatedIns.conflictCode.toLowerCase();
                        if (validatedIns.conflictCode == thiz.CONFLICT_CODE.INSTRUCTOR_NOT_AVAILABLE.key
                            || validatedIns.conflictCode == thiz.CONFLICT_CODE.CONFLICT_TIME.key) {
                                if (!selectedInstructorObject[ins.id]) {
                                    checkbox.setAttribute("disabled", "disabled");
                                }
                            
                        }
                    }
                    var wrapper = Dom.newDOMElement({
                        _name: "hbox",
                        "class": "item-wrapper",
                        _children: _children
                    });
                    Dom.addClass(wrapper, instructorPopupItemClass);
                    thiz.instructorsPopupContainer.appendChild(wrapper);
                });       
                
                if (callback) callback();
            }, function (err) {            
                Dialog.error("There was an error when loading instructors.");
            }, "Loading...");
        }, function(err) {
            Dialog.error(err.errorMessage || "There was an error when loading instructors.");
        });
    }
};

ClassEditRegSlotTab.prototype._onJobExecuted = function(jobId, onSuccess, onError) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    window.defaultIndicator.busy("Loading...");
    
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                        if(window.defaultIndicator) { window.defaultIndicator.done(); }
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        if(window.defaultIndicator) { window.defaultIndicator.done(); }
                        onError({errorMessage: job.errorMessage});
                    }
                } else {
                    if(window.defaultIndicator) { window.defaultIndicator.done(); }
                    onFailed({errorMessage: "Job not found."});
                }
            }, function (error) {
                if(window.defaultIndicator) { window.defaultIndicator.done(); }
                onFailed(error);
            });
        }, 1000);
    })();
};



ClassEditRegSlotTab.prototype.selectInstructorHandler = function (e) {
    var thiz = this;
    if (Dom.hasClass(e.target, "select-intructor")) {
        if (e.target.checked) {
            if (!this.instructorsPopup._selectedTempInstructors) {
                this.instructorsPopup._selectedTempInstructors = [];
            }
            if (this.instructorObject[e.target.value]) {
                this.instructorsPopup._selectedTempInstructors.push(this.instructorObject[e.target.value]);
            }
        } else {
            if (this.instructorsPopup._selectedTempInstructors) {
                for(var i = 0; i < this.instructorsPopup._selectedTempInstructors.length; i ++) {
                    if (this.instructorsPopup._selectedTempInstructors[i].id == e.target.value) {
                        this.instructorsPopup._selectedTempInstructors.splice(i, 1);
                        break;
                    }
                }
            }
        }
    }
}

ClassEditRegSlotTab.prototype.applyInstructorButtonClickHandler = function (e) {
    var thiz = this;
    var _colName = Dom.findUpwardForData(this.instructorsPopup.opener, "_colName");
    var _slotData = Dom.findUpwardForData(this.instructorsPopup.opener, "_rowData");
    if (!_colName) return;
    if (!_slotData) return;
    var _schedData = _slotData.schedByWeekdayName[_colName];
    if (!_schedData) return;
    
    var newInstructors = this.instructorsPopup._selectedTempInstructors;
    var newInstructorIds = [];
    var oldInstructorIds = _schedData.instructorIds || [];
    var validateIds = [];
    var removedIds = [];
    var remainedIds = [];
    
    var oldIdsObject = {};
    oldInstructorIds.forEach(function (id) {
        oldIdsObject[id] = id;
    })
    
    var newIdsObject = {};
    if (newInstructors && newInstructors.length > 0) {
        for (var i = 0; i < newInstructors.length; i ++) {
            var insId = newInstructors[i].id;
            newInstructorIds.push(insId);
            newIdsObject[insId] = insId;
            remainedIds.push(insId);
            if (!oldIdsObject[insId]) {
                validateIds.push(insId);
            }
        }
    }
    
    oldInstructorIds.forEach(function (id) {
        if (!newIdsObject[id]) {
            removedIds.push(id);
            validateIds.push(id);
        }
    })
    
    if (validateIds.length > 0) {
        console.log("Remove: ", removedIds, "Remain: ", remainedIds);
        this.validateClassInstructorsOnSched(remainedIds, removedIds, _slotData.slot, _schedData.classWeekday, _schedData.startMin, function (res) {
            if (res && res.errorCode) {
                if (res.errorCode == ClassEditDialog.ERROR_CODE.NOT_FULL_DURATION) {
                    Dialog.confirmHtmlMessage("", res.errorMessage.replaceAll("\n","<br>"), "Assign Instructor", function() {
                        thiz.applySelectedInstructor(_slotData, _schedData, newInstructors, newInstructorIds);
                        thiz.instructorsPopup.close();
                        thiz.renderInstructorsOnSched(res.validatedInstructors);
                    }, "Cancel", function () {thiz.instructorsPopup.close();});
                } else {
                    Dialog.error("", res.errorMessage);
                }
                return;
            } else {
                thiz.applySelectedInstructor(_slotData, _schedData, newInstructors, newInstructorIds);
                thiz.instructorsPopup.close();
                thiz.renderInstructorsOnSched();
            }
        });
    } else {
        this.applySelectedInstructor(_slotData, _schedData, newInstructors, newInstructorIds);
        this.instructorsPopup.close();
    }
};

ClassEditRegSlotTab.prototype.applySelectedInstructor = function (_slotData, _schedData, newInstructors, newInstructorIds) {
    _schedData.instructors = newInstructors;
    _schedData.instructorIds = newInstructorIds;
    var selectedInstructorsWrapper = this.instructorsPopup.opener.getElementsByClassName("selected-instructors-wrapper");
    if(selectedInstructorsWrapper) {
        this.renderSelectedInstructors(selectedInstructorsWrapper[0], _slotData.slot, _schedData);
        if(newInstructorIds.length > 0) {
            Dom.addClass(selectedInstructorsWrapper[0].parentNode, "has-data");
        } else {
            Dom.removeClass(selectedInstructorsWrapper[0].parentNode, "has-data");
        }
    }
};

ClassEditRegSlotTab.prototype.selectAllSlotChangeHandler = function (e) {
    var slotRows = this.slotContentTableBody.getElementsByTagName("tr");
    var selectedCount = 0;
    for(var i = 0; i < slotRows.length; i ++) {
        slotRows[i]._rowData.checked = e.target.checked;
        var selectItemBox = slotRows[i].getElementsByClassName("item-selection");
        if(selectItemBox && selectItemBox[0]) selectItemBox[0].checked = e.target.checked;
        selectedCount ++;
    }
    if(selectedCount == 0) {
        e.target.checked = false;
    }
    if(e.target.checked) {
        this.selectedSlotCount = selectedCount;
        this.editRegSlotButton.removeAttribute("disabled");
    } else {
        this.selectedSlotCount = 0;
        this.editRegSlotButton.setAttribute("disabled", "disabled");
    }
};

ClassEditRegSlotTab.prototype.editRegSlotButtonClickHandler = function () {
    this.actionMenuPopup.show(this.editRegSlotButton, "left-inside", "bottom", 0, 5, true);
};

ClassEditRegSlotTab.prototype.clearRegSlotInfoActionClickHandler = function () {
    var slotNotDeleteable = [];
    for (var i = 0; i < this.slotInfos.length; i++) {
        var slot = this.slotInfos[i];
        if (slot.checked && !slot.deletable) slotNotDeleteable.push("#" + slot.slotOrder);
    }
    if (slotNotDeleteable.length > 0) {
        Dialog.error("Slot [ " + slotNotDeleteable.join(", ") + "] can not be cleared info.", "", function() {});
        this.actionMenuPopup.close();
        return;
    }

    for(var i = 0; i < this.slotInfos.length; i++) {
        if(this.slotInfos[i].checked) {
            var newRegSlot = this.getNewRegSlot();
            newRegSlot.slotOrder = this.slotInfos[i].slotOrder;
            newRegSlot.id = this.slotInfos[i].id;
            newRegSlot.slot = this.slotInfos[i].slot;
            this.slotInfos[i] = newRegSlot;
            var slotRow = this.slotContentTableBody.getElementsByTagName("tr");
            if(slotRow && slotRow[i]) {
                var inputs = slotRow[i].getElementsByTagName("input");
                for(var j = 0; j < inputs.length; j ++) {
                    if(inputs[j].getAttribute("type") == "checkbox") {
                        inputs[j].checked = false;
                    } else if(inputs[j].getAttribute("type") == "text") {
                        inputs[j].value = "";
                    }
                }

                var slotTimes = slotRow[i].getElementsByClassName("slot-time");
                for(var j = 0; j < slotTimes.length; j ++) {
                    Dom.removeClass(slotTimes[j], "marker-pm");
                    Dom.addClass(slotTimes[j], "marker-am");
                }

                var selectedInstructorsWrappers = slotRow[i].getElementsByClassName("selected-instructors-wrapper");
                for(var j = 0; j < selectedInstructorsWrappers.length; j ++) {
                    selectedInstructorsWrappers[j].innerHTML = "";
                    Dom.removeClass(selectedInstructorsWrappers[j].parentNode, "has-data");
                }

                var eyeOffs = slotRow[i].getElementsByClassName("eye-off");
                if (eyeOffs && eyeOffs.length > 0) {
                    Dom.addClass(eyeOffs[0], "eye");
                    Dom.removeClass(eyeOffs[0], "eye-off");
                }

                slotRow[i]._rowData = this.slotInfos[i];
            }
        }
    }
    this.actionMenuPopup.close();
    this.selectAllSlot.checked = false;
    //this.selectedSlotCount = 0;
};

ClassEditRegSlotTab.prototype.deleteRegSlotActionClickHandler = function () {
    var slotNotDeleteable = [];
    for (var i = 0; i < this.slotInfos.length; i++) {
        var slot = this.slotInfos[i];
        if (slot.checked && !slot.deletable) slotNotDeleteable.push("#" + slot.slotOrder);
    }
    if (slotNotDeleteable.length > 0) {
        Dialog.error("Slot [ " + slotNotDeleteable.join(", ") + "] can not be deleted.", "", function() {});
        this.actionMenuPopup.close();
        return;
    }

    var slotRows = this.slotContentTableBody.getElementsByTagName("tr");
    var i, count = 0;
    for(i = 0; i < slotRows.length; i ++) {
        if(slotRows[i]._rowData.checked) {
            this.slotContentTableBody.removeChild(slotRows[i]);
            if(this.slotInfos[i]) {
                this.slotInfos.splice(i, 1);
                count ++
            }
            i--;
        }
    }
    this.actionMenuPopup.close();
    this.selectAllSlot.checked = false;
    this.selectedSlotCount = this.selectedSlotCount - count;
    if(this.selectedSlotCount == 0) {
        this.editRegSlotButton.setAttribute("disabled", "disabled");
    }
};

ClassEditRegSlotTab.prototype.updateClassData = function (data) {
    if(!data) return;
    var slots = [];
    if(this.slotInfos && this.slotInfos.length > 0) {
        for(var i = 0; i < this.slotInfos.length; i ++) {
            var slotInfo = this.slotInfos[i];
            delete slotInfo.orderNo;
            var aSlot = {
                id: slotInfo.id,
                slot: slotInfo.slot,
                oldPregeneratingKey: slotInfo.pregeneratingKey,
                maxLimit: slotInfo.maxLimit,
                slotOrder: slotInfo.slotOrder,
                editable: slotInfo.editable,
                deletable: slotInfo.deletable,
                schedByWeekdayName: {},
                allowShowInstructors: slotInfo.allowShowInstructors,
                wailistLimit: slotInfo.wailistLimit,
                slotTimes: [],
                instructorIds: []
            };
            var hasASlotTime = false;
            for(var j = 0; j < this.weekdays.length; j++){
                var sched = this.buildSlotDayData(slotInfo, j);
                if (sched) {
                    aSlot.schedByWeekdayName[sched.weekdayName] = sched;
                    var slotTime = sched.weekdayName + " " + sched.startTime;
                    if (sched.startTime && sched.startTime.length > 0) {
                        aSlot.slotTimes.push(slotTime.toUpperCase());
                        hasASlotTime = true;
                    }
                    if (sched.instructorIds && sched.instructorIds.length > 0) {
                        for (var k = 0; k < sched.instructorIds.length; k ++) {
                            aSlot.instructorIds.push(sched.instructorIds[k]);
                        }
                    }
                }
            }
            if(slotInfo.hasRegister && !slotInfo.hasSlotTime) {
                var message = "Slot " + (slotInfo.slot + 1) + " has been taken registered. Please input the slot time value.";
                // Dialog.error(message, "", function() {});
                data.hasSlotError = true;
                data.errorMessage = message;
                return;
            } else {
                delete data.hasSlotError;
                delete data.errorMessage;
            }
            delete slotInfo.hasSlotTime;
            !hasASlotTime || (slots.push(aSlot));

        }
    }
    data.slots = slots;
};

ClassEditRegSlotTab.prototype.computeDurationFromTime = function(strTime, isAM){
    if(!strTime) return 0;
    var s = strTime.split(":");
    var h = parseInt(s[0]);
    var m = s.length > 1? parseInt(s[1]) : 0;
    var afterNoon = 12;
    if(isAM && h == 12) {
        h = 0;
    } else if(!isAM && h == 12) {
        afterNoon = 0;
    }
    return (isAM? 0 : afterNoon * 60) + h * 60 + m;
}

ClassEditRegSlotTab.prototype.buildSlotDayData = function (slotData, weekdayNo) {
    var weekdayData = slotData.schedByWeekdayName[this.weekdays[weekdayNo]];
    if(weekdayData && weekdayData.slotTime && weekdayData.slotTime.length > 0) {
        weekdayData.startTime = weekdayData.slotTime + " " + weekdayData.timeMarker;
        weekdayData.startMin = this.computeDurationFromTime(weekdayData.slotTime, (weekdayData.timeMarker.toUpperCase() != "PM"));
        slotData.hasSlotTime = true;
    } else {
        weekdayData.startTime = "";
        weekdayData.startMin = 0;
    }
    var sched = {
        id: weekdayData.id,
        weekday: weekdayData.weekday,
        weekdayName: weekdayData.weekdayName,
        classWeekday: weekdayData.classWeekday,
        startMin: weekdayData.startMin,
        instructors: weekdayData.instructors,
        instructorIds: weekdayData.instructorIds,
        startTime: weekdayData.startTime,
        editable: weekdayData.editable,
        deletable: weekdayData.deletable
    };
    return sched;
};

ClassEditRegSlotTab.prototype.noLimitSelectionClickHandler = function () {
    this.noLimitPopup.hide();
    if(!this.openedNoLimitPopupRow) return;
    var rowData = this.openedNoLimitPopupRow._rowData;
    if(!rowData) return;
    rowData.maxLimit = 99999;
    var inputSlotLimits = this.openedNoLimitPopupRow.getElementsByClassName("input-slot-limit");
    if(inputSlotLimits && inputSlotLimits.length > 0) {
        inputSlotLimits[0].value = "No Limit";
    }
};

ClassEditRegSlotTab.prototype.toggleShowInstructorsHandler = function (target) {
    var row = Dom.findUpwardForData(target, "_rowData");
    if (!row) return;
    row.allowShowInstructors = !row.allowShowInstructors;
    if (row.allowShowInstructors) {
        Dom.addClass(target, "eye");
        Dom.removeClass(target, "eye-off");
    } else {
        Dom.removeClass(target, "eye");
        Dom.addClass(target, "eye-off");
    }
};

ClassEditRegSlotTab.prototype.showInstructorsActionClickHandler = function () {
    for(var i = 0; i < this.slotInfos.length; i++) {
        if(this.slotInfos[i].checked) {
            this.slotInfos[i].allowShowInstructors = true;
            var slotRow = this.slotContentTableBody.getElementsByTagName("tr");
            if(slotRow && slotRow[i]) {
                var inputs = slotRow[i].getElementsByTagName("input");
                var icons = slotRow[i].getElementsByClassName("eye-off");
                if (icons && icons.length > 0) {
                    Dom.addClass(icons[0], "eye");
                    Dom.removeClass(icons[0], "eye-off");
                }
                slotRow[i]._rowData = this.slotInfos[i];
            }
        }
    }
    this.actionMenuPopup.close();
};

ClassEditRegSlotTab.prototype.hideInstructorsActionClickHandler = function () {
    for(var i = 0; i < this.slotInfos.length; i++) {
        if(this.slotInfos[i].checked) {
            this.slotInfos[i].allowShowInstructors = false;
            var slotRow = this.slotContentTableBody.getElementsByTagName("tr");
            if(slotRow && slotRow[i]) {
                var inputs = slotRow[i].getElementsByTagName("input");
                var icons = slotRow[i].getElementsByClassName("eye");
                if (icons && icons.length > 0) {
                    Dom.addClass(icons[0], "eye-off");
                    Dom.removeClass(icons[0], "eye");
                }
                slotRow[i]._rowData = this.slotInfos[i];
            }
        }
    }
    this.actionMenuPopup.close();
};

ClassEditRegSlotTab.prototype.backupSlotData = function (slotInfos) {
    this.slotInfoData = [];
    if (!slotInfos) return this.slotInfoData;
    if (slotInfos.length == 0) return this.slotInfoData;
    for (var i = 0; i < slotInfos.length; i ++) {
        var aSlot = {
            id: slotInfos[i].id,
            maxLimit: slotInfos[i].maxLimit,
            wailistLimit: slotInfos[i].wailistLimit,
            allowShowInstructors: slotInfos[i].allowShowInstructors,
            slotTimes: slotInfos[i].slotTimes,
            instructorIds: []
        }
        for (var key in slotInfos[i].schedByWeekdayName) {
            var instructorIds = slotInfos[i].schedByWeekdayName[key].instructorIds;
            if (instructorIds && instructorIds.length > 0) {
                aSlot.instructorIds = aSlot.instructorIds.concat(instructorIds);
            }
        }

        this.slotInfoData.push(aSlot);
    }
};

ClassEditRegSlotTab.prototype.isDataChanged = function () {
    var newSlotData = {
        slots: []
    };
    this.updateClassData(newSlotData);
    var newData = newSlotData.slots;
    if (!this.slotInfoData) this.slotInfoData = [];
    if (this.slotInfoData.length != newData.length) return true;
    var isChanged = false;
    for (var i = 0; i < this.slotInfoData.length; i ++) {
        var aSlot = this.slotInfoData[i], aNewSlot = newData[i];
        if (aSlot.id != aNewSlot.id) {
            isChanged = true;
            break;
        }
        if (aSlot.maxLimit != aNewSlot.maxLimit) {
            isChanged = true;
            break;
        }
        if (aSlot.wailistLimit != aNewSlot.wailistLimit) {
            isChanged = true;
            break;
        }
        if (aSlot.allowShowInstructors != aNewSlot.allowShowInstructors) {
            isChanged = true;
            break;
        }
        if (aSlot.instructorIds.length != aNewSlot.instructorIds.length) {
            isChanged = true;
            break;
        } else {
            for (var j = 0; j > aSlot.instructorIds.length; j ++) {
                if (aSlot.instructorIds[j] != aNewSlot.instructorIds[j]) {
                    isChanged = true;
                    break;
                }
                if (isChanged) break;
            }
        }
        if (aSlot.slotTimes.length != aNewSlot.slotTimes.length) {
            isChanged = true;
            break;
        } else {
            for (var j = 0; j < aSlot.slotTimes.length; j ++) {
                if (aSlot.slotTimes[j] != aNewSlot.slotTimes[j]) {
                    isChanged = true;
                    break;
                }
            }
            if (isChanged) break;
        }

    }
    return isChanged;

};

ClassEditRegSlotTab.prototype.showInstructorConflictPopup = function(ev) {
    var target = Dom.getTarget(ev);
    if (!target) return;
    
    var conflictIcon = Dom.findParentWithClass(target, "InstructorConflictInfo");
    if (conflictIcon) {
        if (this._infoTips) {
            this._infoTips.kill();
        }
        var popupType = "error";
        if (Dom.hasClass(conflictIcon.parentNode, "not_full_duration")) popupType = "warning";
        this._infoTips = InfoTip.show(conflictIcon, conflictIcon.getAttribute("conflictdesc"), false, null, popupType, "left-inside", -(Dom.getOffsetWidth(target)/2 + 13));
        this._infoTips.setPopupClass("ClassInstructorConflictPopup");
    }
};

ClassEditRegSlotTab.prototype.hideInstructorConflictPopup = function(ev) {
    var target = Dom.getTarget(ev);
    var conflictIcon = Dom.findParentWithClass(target, "InstructorConflictInfo");
    if(conflictIcon && conflictIcon.__tip) {
        conflictIcon.__tip.isVisible = function(){
            return true;
        };
        InfoTip.show(conflictIcon);
        if (this._infoTips) {
            this._infoTips.kill();
        }
    }
};

ClassEditRegSlotTab.prototype.validateUIWithPermission = function () {
    if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) {
        this.newRegSlotButton.setAttribute("disabled", "disabled");
        Dom.addClass(this.deleteRegSlotAction, "ActionDisabled");
        Dom.addClass(this.clearRegSlotInfoAction, "ActionDisabled");
    }
};

ClassEditRegSlotTab.prototype.validateClassInstructorsOnSched = function (remainedIds, removeIds, slot, weekday, startMin, onSuccess) {
    if (this.isEditRegSlotDialog) {
        if (onSuccess) onSuccess();
        return;
    }
    var classData = this.options.buildClassData(true);
    if (!classData.slots || classData.slots.length == 0) return;
    console.log("Class data", classData);
    console.log("validateClassInstructorsOnSched - Remove: ", removeIds, "Remain: ", remainedIds);
    if (!remainedIds) remainedIds = [];
    if (!removeIds) removeIds = [];
    var thiz = this;
    $classAdminService.validateClassInstructorsOnSched(classData, remainedIds, removeIds, slot, weekday, startMin, function (res) {
        Dom.emitEvent(ClassEditDialog.INSTRUCTOR_CONFLICTS_UPDATED, thiz.node(),{});
        if (res.validatedInstructors) {
            for (var key in res.validatedInstructors) {
                thiz.validatedInstructor[key] = res.validatedInstructors[key];
            }
        }
        if (onSuccess) onSuccess(res);
    }, function (err) {
        Dialog.error("", err.message);
    }, "Loading...");
};

ClassEditRegSlotTab.prototype.renderInstructorsOnSched = function (validatedInstructors) {
    console.log("validatedInstructors", validatedInstructors, this.slotContentTable);
    if (validatedInstructors) {
        for (var key in validatedInstructors) {
            var instructorEl = Dom.get(key);
            if (!instructorEl) continue;
            var validatedIns = validatedInstructors[key];
            Dom.removeClass(instructorEl, this.CONFLICT_CODE.INSTRUCTOR_NOT_AVAILABLE.key.toLowerCase());
            Dom.removeClass(instructorEl, this.CONFLICT_CODE.CONFLICT_TIME.key.toLowerCase());
            Dom.removeClass(instructorEl, this.CONFLICT_CODE.NOT_FULL_DURATION.key.toLowerCase());
            if (validatedIns.conflictCode) {
                Dom.addClass(instructorEl, validatedIns.conflictCode.toLowerCase());
                var infoIcon = Dom.findChildWithClass(instructorEl, "InstructorConflictInfo");
                if (infoIcon) infoIcon.setAttribute("conflictDesc", validatedIns.conflictedCustomMessage);
            }
        }
    }
};

ClassEditRegSlotTab.prototype.refreshInsConflicts = function () {
    var thiz = this;
    this.validateClassInstructorsOnSched([], [], -1, -1, -1, function (res) {
        if (res && res.validatedInstructors) thiz.renderInstructorsOnSched(res.validatedInstructors);
    });
};



if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassEditRegistrationTab.js";

function ClassEditRegistrationTab(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
    this.rendered = false;
}
__extend(BaseTemplatedWidget, ClassEditRegistrationTab);

ClassEditRegistrationTab.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        thiz.onAttachedDelayed();
    }, 100);
};

ClassEditRegistrationTab.prototype.onAttachedDelayed = function() {
    //this.renderTabContent();
};

ClassEditRegistrationTab.prototype.reloadClassInfo = function(classInfo) {
    this.options.classInfo = classInfo;
    this.registrationWidget.reloadClassInfo(classInfo);
};
ClassEditRegistrationTab.prototype.reload = function() {
    this.registrationWidget.reload();
};

ClassEditRegistrationTab.prototype.isDataChanged = function() {
    var thiz = this;
    if (thiz.registrationWidget && typeof(thiz.registrationWidget.isRegistrationChanged) == "function") {
        return thiz.registrationWidget.isRegistrationChanged();
    }
    return false;
};

ClassEditRegistrationTab.prototype.isSlotChanged = function() {
    if (this.registrationWidget && typeof(this.registrationWidget.isSlotChanged) == "function") {
        return this.registrationWidget.isSlotChanged();
    }
    return false;
};

ClassEditRegistrationTab.prototype.resetSlotChanged = function() {
    if (this.registrationWidget && typeof(this.registrationWidget.resetSlotChanged) == "function") {
        this.registrationWidget.resetSlotChanged();
    }
};

ClassEditRegistrationTab.prototype.syncClassData = function(classInfo, reloadOnly) {
    var thiz = this;
    const runWithJob = false;
    const classIds = [this.options.currentClassId];
    const slotChanged = this.isSlotChanged();
    if (this.options.enableAutoWaitlistOnTeam && !slotChanged) {
        $classAutoWaitlistService.runAutoWaitlistOnClass(classIds, runWithJob, function() {
            thiz.syncData(classInfo, reloadOnly);
        }, function(error) {
            thiz.syncData(classInfo, reloadOnly);
        });
    } else {
        this.resetSlotChanged();
        thiz.syncData(classInfo, reloadOnly);
    }
};

ClassEditRegistrationTab.prototype.syncData = function(classInfo, reloadOnly) {
    var thiz = this;
    console.log("SYNC CLASS DATA", reloadOnly, thiz.options);
    if (thiz.options && typeof(thiz.options.validateChangeCallback) == "function"
                && typeof(thiz.options.saveCallback) == "function"
                && typeof(thiz.options.reloadCallback) == "function"
                && (thiz.options && !thiz.options.hasJustReloaded)
                && (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan)) {
        if (!reloadOnly && thiz.options.validateChangeCallback()) {
            Dialog.confirm("This class is being changed and hasn't been saved yet. Please save before going to registration", "",
                    "Save and Open Registration", function() {
                        thiz.options.saveCallback({reloadOneTime: true});
                    },
                    "Discard Change and Open Registration", function() {
                        thiz.options.reloadCallback({reloadOneTime: true});
                    });
            return;
        }
    }
    window.setTimeout(thiz.renderTabContent.bind(thiz), 10);
};

ClassEditRegistrationTab.prototype.renderTabContent = function() {
    if (!this.options) return;
    console.log("RENDER tab content for Registration");
    this.options.hasJustReloaded = false;
    this.currentClassId = this.options.currentClassId;
    var slot = -1;
    if(this.options && this.options.slot >= 0) slot = this.options.slot;
    if (window.LOGIN_INFO.allowClassPaymentPlan) {
        var thiz = this;
        if (this.rendered) {
            if (thiz.registrationWidget && typeof(thiz.registrationWidget.reload) == 'function') thiz.registrationWidget.reload();
            return;
        }
        this.contentWrapper.innerHTML = "";
        widget.__ensureNamespaceLoaded("clpayplan", function (clpayplan) {
            thiz.registrationWidget = new clpayplan.ClassEditRegistrationWidget(thiz.options);
            console.log("REGISTRATION WIDGET", thiz.registrationWidget);
            thiz.registrationWidget.into(thiz.contentWrapper);
            thiz.rendered = true;
        });
    } else {
        Dom.toggleClass(this.contentWrapper.parentNode, "Legacy", true);
        this.legacyManageStudentFrame.innerHTML = '<iframe name="iframe_LegacyManageStudent" id="iframe_LegacyManageStudent" ' +
          'src="/LClassManage.jsp?team=' + TEAM_ALIAS + '&classid=' + this.currentClassId + '&slot=' + slot +'" frameborder="0" width="100%" height="100%"  ></iframe>';
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassListRowDetailWidget.js";

function ClassListRowDetailWidget(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.options = options;

    this.bind("click", this.paymentPlanClickedHandler, this.classPaymentPlans);
    this.bind("click", this.agreementClickedHandler, this.agreementContent);
    this.bind("click", this.viewCostumes, this.viewCostumesLink);
}
__extend(BaseTemplatedWidget, ClassListRowDetailWidget);

ClassListRowDetailWidget.prototype.onAttached = function() {
    this.allowClassPaymentPlan = window.LOGIN_INFO.allowClassPaymentPlan;
    this.allowWaiver = window.LOGIN_INFO.allowWaiver;

    window.setTimeout(this.onAttachedDelayed.bind(this), 10);
};

ClassListRowDetailWidget.prototype.findMySlots = function(item) {
    if (!item || !item.slots) return [];
    var mySlots = [];
    item.slots.forEach(function(slot) {
        if (slot.instructorIds && slot.instructorIds.includes(window.LOGIN_INFO.accountId)) mySlots.push(slot);
    });
    return mySlots;
}

ClassListRowDetailWidget.prototype.onAttachedDelayed = function() {
    var itemData = this.options.itemData;
    if(!itemData) return;
    console.log("ClassListRowDetailWidget itemData: ", itemData);

    var startEndDateValue = FormatUtil.formatDate(ClassUtils.transformClassTimezoneToLocal(itemData.dateStart, itemData.timezoneId), "date_standard", "local") + " - " +
                            FormatUtil.formatDate(ClassUtils.transformClassTimezoneToLocal(itemData.dateEnd, itemData.timezoneId), "date_standard", "local");
    this.classStartEndDate.innerHTML = startEndDateValue;
    var locationName = itemData.lessonLocId == 0? "(None)" : itemData.lessonLocName;
    this.classLocation.innerHTML = locationName;
    this.classLocation.title = locationName;
    this.classWaitlist.innerHTML = itemData.isWaitlist? "Yes" : "No";
    this.classLoad.innerHTML = itemData.totalSlotRegister + "/" + (itemData.totalSlotLimit == -1 ? "(No Limit)" : itemData.totalSlotLimit);
    var classVisibilityHtml = ClassUtils.CLASS_VISIBILITY[itemData.classVisibility];
    var registrationVisibilityHtml = ClassUtils.CLASS_VISIBILITY[itemData.registrationVisibility];
    this.classVisibility.innerHTML = classVisibilityHtml;
    this.classRegVisibility.innerHTML = registrationVisibilityHtml;

    this.classRegSlots.innerHTML = itemData.regSlot;
    this.classDuration.innerHTML = itemData.duration + " min" + (itemData.duration > 1? "s" : "");

    this.classPaymentPlans.innerHTML = "(No items found)";
    // itemData.paymentPlans = [{id: 1, name: "name 1"}, {id: 2, name: "name 2"}]

    if (itemData.paymentPlans && itemData.paymentPlans.length > 0) {
        this.classPaymentPlans.innerHTML = "";
        for (var i = 0; i < itemData.paymentPlans.length; i++) {
            var paymentPlan = Dom.newDOMElement({
                _name: "li",
                "class": ("PaymentPlanItem " + (itemData.regSlot > 0? "Clickable": "")),
                _children: [{
                    _name: (itemData.regSlot > 0? "a": "span"),
                    _children: [{
                        _name: "span",
                        _html: itemData.paymentPlans[i].name,
                        title: itemData.paymentPlans[i].name
                    }]
                }]
            });
            paymentPlan.__paymentPlanData = itemData.paymentPlans[i];
            this.classPaymentPlans.appendChild(paymentPlan);
        }
    }
    if (!this.allowClassPaymentPlan) Dom.hide(this.classPaymentPlans.parentNode.parentNode);

    if (itemData.agreements && itemData.agreements.length > 0) {
        this.agreementContent.innerHTML = "";
        for (var i = 0; i < itemData.agreements.length; i++) {
            var agreement = Dom.newDOMElement({
                _name: "li",
                "class": "AgreementItem Clickable",
                _children: [{
                    _name: "a",
                    _children: [{
                        _name: "span",
                        _html: itemData.agreements[i].title,
                        title: itemData.agreements[i].title
                    }]
                }]
            });
            agreement.__agreementData = itemData.agreements[i];
            this.agreementContent.appendChild(agreement);
        }
    } else {
        Dom.hide(this.agreementContent.parentNode.parentNode.parentNode);
    }
    if (!this.allowWaiver) Dom.hide(this.agreementContent.parentNode.parentNode.parentNode);
    if (!this.options.allowClassAddTool) Dom.hide(this.addNewRegistrations);

    var mySlots = this.findMySlots(itemData);

    if (!LOGIN_INFO.isAbleTakeAttendance) {
        if (LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass) {
            this.trackingAttendaceAction.disabled = mySlots.length < 1;
        } else {
            Dom.hide(this.trackingAttendaceAction);
        }
    }

    if (!LOGIN_INFO.isAbleTakeSkill) Dom.hide(this.trackingSkillsAction);
    if (!this.canCreateEditDeleteClass()){
        Dom.hide(this.cloneClassAction);
    }
    if (!ClassAuthUtils.isAbleToPrintAllAttendanceReport(LOGIN_INFO)){
        if (ClassAuthUtils.isAbleToPrintAttendanceReportOfMyInstructorClass(LOGIN_INFO)) {
            this.printAttendaceAction.disabled = mySlots.length < 1;
        } else {
            Dom.hide(this.printAttendaceAction);
        }
    }
    if (itemData.hasDressCode) {
        var parent = this.actionsPane.parentNode;
        var busyNode = Dom.newDOMElement({
            _name: "vbox",
            "class": "DressCodeBusyWrapper",
            _text: "Loading..."
        });
        parent.insertBefore(busyNode, this.actionsPane);
        var listwidget = this.findUpward(__pkg.ClassListWidget);
        if (listwidget) {
            listwidget._registerDressCodeLazyLoad(itemData.id, function(data) {
                widget.__ensureNamespaceLoaded("discountdance", function (ns) {
                    var widget = new ns["DressCodeRowDataWidget"]();
                    widget.setClassDressCodeData(data);
                    widget.setViewButtonLabel("View");
                    parent.removeChild(busyNode);
                    parent.insertBefore(widget.node(), this.actionsPane);
                }.bind(this));
            }.bind(this));
        }
    }

    this._showHideViewCostumesLink();
};

ClassListRowDetailWidget.prototype._showHideViewCostumesLink = function() {
    var classItem = this.options.itemData;
    var isCostumeEnabled = TEAM_INFO.enabledFeatures && TEAM_INFO.enabledFeatures.includes("costume-management");
    var isAgreementEnabled = this.allowWaiver && classItem && classItem.agreements && classItem.agreements.length > 0;
    
    if (!isAgreementEnabled && !isCostumeEnabled) {
        Dom.hide(this.agreementGroupField);
        return;
    }
    Dom.show(this.agreementGroupField);
    if (!isAgreementEnabled) Dom.hide(this.agreementContent.parentNode.parentNode);

    if (isCostumeEnabled) {
        Dom.setInnerText(this.costumesLabel, (window.LOGIN_INFO.costumeModuleName || "Costumes") + ":");
        var isCostumeViewActive = classItem.costumeInfos && classItem.costumeInfos.length > 0 ;
        if (isCostumeViewActive) {
            if (ClassAuthUtils.canManageClassCostumes(window.LOGIN_INFO)) Dom.addClass(this.costumes, "WithViewActive");
            this.costumeStatus.innerHTML = "Yes";
        }
    } else {
        Dom.hide(this.costumes);
    }
}

ClassListRowDetailWidget.prototype.paymentPlanClickedHandler = function (event) {
    if (!this.canCreateEditDeleteClass()) return;
    
    if (Dom.hasClass(event.target, "PaymentPlanItem Clickable")
        || Dom.hasClass(event.target.parentNode, "PaymentPlanItem Clickable")
        || Dom.hasClass(event.target.parentNode.parentNode, "PaymentPlanItem Clickable")) {

        var itemData = this.options.itemData;
        if(!itemData) return;
        var __paymentPlanData = Dom.findUpwardForData(event.target, "__paymentPlanData");
        if (!__paymentPlanData) return;
        Dom.emitEvent("OpenPaymentPlan", this.node(), {paymentPlanKey: __paymentPlanData.key, classId: itemData.id});
    }
};

ClassListRowDetailWidget.prototype.agreementClickedHandler = function (event) {
    if (Dom.hasClass(event.target, "AgreementItem Clickable")
        || Dom.hasClass(event.target.parentNode, "AgreementItem Clickable")
        || Dom.hasClass(event.target.parentNode.parentNode, "AgreementItem Clickable")) {

        var itemData = this.options.itemData;
        if(!itemData) return;

        var __agreementData = Dom.findUpwardForData(event.target, "__agreementData");
        if (!__agreementData) return;
        var options = {
            agreementKey: __agreementData.agreementKey,
            classId: itemData.id
        };

        new ViewAgreementDialog().callback(function(data) {
        }).open(options);
    }
};

ClassListRowDetailWidget.prototype.openEditClassModal = function(option) {
    if (!this.canCreateEditDeleteClass()) return;
    
    var thiz = this;

    thiz.classEditDialog = new ClassEditDialog();
    thiz.classEditDialog.callback(function(data) {
        thiz.saveClassCallback(data);
    }).open(option);
};

ClassListRowDetailWidget.prototype.saveClassCallback = function(data) {
    console.log("ClassListWidget.prototype.saveClassCallback()");
};

ClassListRowDetailWidget.prototype.viewCostumes = function() {
    this.openEditClassModal({ids: [this.options.itemData.id], activeTab: "costumesTab"});
}

ClassListRowDetailWidget.prototype.canCreateEditDeleteClass = function() {
    return ClassAuthUtils.canCreateEditDeleteClass(LOGIN_INFO);
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassListWidget.js";

function ClassListWidget(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.isDomAttached = false;

    this.bind("click", this.addClassButtonClickHandler, this.addClassButton);
    this.bind("click", this.expandAllClassDetail, this.expandButton);
    this.bind("click", this.collapseAllClassDetail, this.collapseButton);

    this.bind("OpenPaymentPlan", function (event) {
        thiz.openEditClassModal({ids: [event.classId], activePaymentPlanKey: event.paymentPlanKey, activeTab: "paymentPlanTab"});
    });

    this.currency = "$";
    this.teamAlias = window.TEAM_ALIAS;

    InfoTip.install(this.dataView.node(), {
        match: function (node) {
            return Dom.hasClass(node, "StatusCount");
        },
        offsetX: 4,
        getMessage: function (target) {
            return Dom.newDOMElement({
                _name: "div",
                "class": "StatusHintText",
                _html: target.getAttribute("statusHintText")
            })
        }
    });

    this.filters = {
        todayClass: false,
        noInstructors: false,
        classFull: false,
        instructors: []
    };
    this.selectedSlotItems = {};

    this.bind("p:PageLoaded", function(e) {
        if(!e.detail) return;
        var selectedItems = thiz.dataView.dataTable.getSelectedItems();
        if(selectedItems && selectedItems.length == 0) {
            thiz.selectedSlotItems = {};
        }
        if(e.detail.totalItems > 1) {
            thiz.totalClassCount.innerHTML = "<strong>" + e.detail.totalItems + "</strong> <span>Classes</span>";
        } else {
            thiz.totalClassCount.innerHTML = "<strong>" + e.detail.totalItems + "</strong> <span>Class</span>";
        }
        if(e.detail.totalItems > 0 && thiz.expandAllClass) {
            thiz.expandAllClassDetail();
        }

    }, this.dataView.node());


    this.bind("p:BeforeValidatingActionUserSelections", function (event) {
        if (thiz.settingDataTableItems) {
            thiz.settingDataTableItems = false;
            return;
        }
        if (!event.detail) return;
        var eventData = event.detail,
            classItem = event.detail.item;
        if (eventData.checked) {
            //check on item
            if (classItem) {
                //if (classItem.isPastClass) return;
                if (!thiz.selectedSlotItems) thiz.selectedSlotItems = {};
                thiz.selectedSlotItems[classItem.id] = {};
                for (var i = 0; i < classItem.slots.length; i++) {
                    thiz.selectedSlotItems[classItem.id][classItem.slots[i].id] = true;
                }

                var tableRows = thiz.dataView.dataTable.table.querySelectorAll("tr[data-index]");
                for (var i = 0; i < tableRows.length; i ++) {
                    var row = tableRows[i];
                    var rowData = DataTable.getRowData(row);
                    if (rowData.id == classItem.id) {
                        var nextRow = row.nextSibling;
                        if (nextRow && Dom.hasClass(nextRow, "detail-content-wrapper")) {
                            var slotCheckbox = nextRow.getElementsByTagName("input");
                            for (var j = 0; j < slotCheckbox.length; j ++) {
                                slotCheckbox[j].checked = true;
                            }
                        }
                        break;
                    }
                }

            } else {//Check All
                thiz.dataView.getSelectedItems(function (selectedClasses) {
                    thiz.selectedSlotItems = {};
                    for (var i = 0; i < selectedClasses.length; i++) {
                        //if (selectedClasses[i].isPastClass) continue;
                        thiz.selectedSlotItems[selectedClasses[i].id] = {};
                        for (var j = 0; j < selectedClasses[i].slots.length; j ++) {
                            thiz.selectedSlotItems[selectedClasses[i].id][selectedClasses[i].slots[j].id] = true;
                        }
                    }
                });

                var selectAllSlots = thiz.dataView.node().getElementsByClassName("SelectAllSlot");
                var slotSelections = thiz.dataView.node().getElementsByClassName("SlotSelection");
                for (var i = 0; i < selectAllSlots.length; i ++) {
                    if (selectAllSlots[i]._isPastClass) continue;
                    selectAllSlots[i].checked = true;
                }
                for (var i = 0; i < slotSelections.length; i ++) {
                    if (slotSelections[i]._isPastClass) continue;
                    slotSelections[i].checked = true;
                }

            }
        } else {
            //uncheck on item
            if (classItem) {
                if (thiz.selectedSlotItems[classItem.id]) delete thiz.selectedSlotItems[classItem.id];

                var tableRows = thiz.dataView.dataTable.table.querySelectorAll("tr[data-index]");
                for (var i = 0; i < tableRows.length; i ++) {
                    var row = tableRows[i];
                    var rowData = DataTable.getRowData(row);
                    if (rowData.id == classItem.id) {
                        var nextRow = row.nextSibling;
                        if (nextRow && Dom.hasClass(nextRow, "detail-content-wrapper")) {
                            var slotCheckbox = nextRow.getElementsByTagName("input");
                            for (var j = 0; j < slotCheckbox.length; j ++) {
                                slotCheckbox[j].checked = false;
                            }
                        }
                        break;
                    }
                }
            } else { //Uncheck All
                thiz.selectedSlotItems = {};
                var selectAllSlots = thiz.dataView.node().getElementsByClassName("SelectAllSlot");
                var slotSelections = thiz.dataView.node().getElementsByClassName("SlotSelection");
                for (var i = 0; i < selectAllSlots.length; i ++) {
                    selectAllSlots[i].checked = false;
                }
                for (var i = 0; i < slotSelections.length; i ++) {
                    slotSelections[i].checked = false;
                }
            }
        }

    }, this.dataView.node());

    //title custom renderer
    this.dataView.registerCustomRenderer("title", function (data, value) {
        var _children = [
            {
                _name: "icon",
                "class": "chevron-right ShowClassDetailClickable"
            },
            {
                _name: "icon",
                "class": "chevron-down ShowClassDetailClickable"
            },
            {
                _name: "span",
                flex: 1,
                "class": "class-title ShowClassDetailClickable",
                _html: value,
                title: value
            }
        ];
        var isMyInstructorAssigned = ClassUtils.isMyInstructorAssigned(data, LOGIN_INFO.accountId);
        if (ClassAuthUtils.canCreateEditDeleteClass(LOGIN_INFO)
            || (isMyInstructorAssigned && ClassAuthUtils.canManageMyInstructorClass(LOGIN_INFO))) {
            _children.push({
                _name: "icon",
                "class": "settings manage-class-action",
                title: "Click to edit class"
            });
        }
        
        return {
            _name: "div",
            _children: [
                {
                    _name: "hbox",
                    "class": "title-wrapper",
                    _children: _children
                }
            ]
        }
    });
    this.dataView.registerCustomRenderer("allowed_genders", function (data, value) {
        if (!data.allowedGenders || data.allowedGenders.length >= 4) return "";
        return data.allowedGenders.map(function(type) {
            return Gender[type].displayName;
        }).join(", ");
    });
    this.dataView.registerCustomRenderer("status", function (data, value) {
        return {
            _name: "div",
            _html: value == 1 ? "On" : "Off",
            title: value == 1 ? "On" : "Off"
        }
    });
    this.dataView.registerCustomRenderer("regSlot", function (data, value) {
        return {
            _name: "div",
            _html: value
        }
    });
    this.dataView.registerCustomRenderer("dateStart", function (data, value) {
        var children = [];
        if(data.dateStart) {
            children.push({_name: "div", _html: FormatUtil.formatDate(ClassUtils.transformClassTimezoneToLocal(data.dateStart, data.timezoneId), "date_standard", "local")});   
        }
        if(data.dateEnd) {
            children.push({_name: "div", _html: FormatUtil.formatDate(ClassUtils.transformClassTimezoneToLocal(data.dateEnd, data.timezoneId), "date_standard", "local")});
        }
        /*
        if(data.dateStart) {
            children.push({_name: "div", _html: "L:" + FormatUtil.formatDate(data.dateStart, "date_standard", "local")});
        }
        if(data.dateEnd) {
            children.push({_name: "div", _html: "L:" + FormatUtil.formatDate(data.dateEnd, "date_standard", "local")});
        }
        */
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("totalReg", function (data, value) {
        return {
            _name: "div",
            _html: value
        }
    });
    this.dataView.registerCustomRenderer("duration", function (data, value) {
        return {
            _name: "div",
            _html: value + "m"
        }
    });
    this.dataView.registerCustomRenderer("familyRegFee", function (data, value) {
        return {
            _name: "div",
            _html: value != 0 ? (ClassUtils.toCurrency(value)) : ""
        }
    });
    this.dataView.registerCustomRenderer("studentRegFee", function (data, value) {
        return {
            _name: "div",
            _html: value != 0 ? (ClassUtils.toCurrency(value)) : ""
        }
    });
    this.dataView.registerCustomRenderer("feeClassAmount", function (data, value) {
        var children = [];
        if(value != 0) {
            children.push({_name: "div", _html: ClassUtils.toCurrency(value)});
            if(data.isChargeMonthly) children.push({_name: "div", _html: "(Monthly)"});
        }
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("date4Register", function (data, value) {
        var children = [];
        if(value) children.push({_name: "div", _html: FormatUtil.formatDate(value, "datetime_standard", "local")});
        if(data.date4RegisterEnd) children.push({_name: "div", _html: FormatUtil.formatDate(data.date4RegisterEnd, "datetime_standard", "local")});
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("date4Return", function (data, value) {
        var children = [];
        if(value) children.push({_name: "div", _html: FormatUtil.formatDate(value, "datetime_standard", "local")});
        if(data.date4ReturnEnd) children.push({_name: "div", _html: FormatUtil.formatDate(data.date4ReturnEnd, "datetime_standard", "local")});
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("date4New", function (data, value) {
        var children = [];
        if(value) children.push({_name: "div", _html: FormatUtil.formatDate(value, "datetime_standard", "local")});
        if(data.date4NewEnd) children.push({_name: "div", _html: FormatUtil.formatDate(data.date4NewEnd, "datetime_standard", "local")});
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("revenue", function (data, value) {
        var children = [];
        if(value != 0) {
            children.push({_name: "div", _html: ClassUtils.toCurrency(value)});
            var chargeType = data.isChargeMonthly? "(Monthly)" : "(Total Fees)";
            children.push({_name: "div", _html: chargeType});
        }
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("open4Register", function (data, value) {
        return {
            _name: "div",
            _html: value ? "Yes" : ""
        }
    });
    this.dataView.registerCustomRenderer("allowedGender", function (data, value) {
        return {
            _name: "div",
            _html: (value == 1 ? "M" : (value == 2? "F" : ""))
        }
    });
    this.dataView.registerCustomRenderer("isChargeMonthly", function (data, value) {
        return {
            _name: "div",
            _html: value == 1 ? "Yes" : ""
        }
    });
    this.dataView.registerCustomRenderer("classVisibility", function (data, value) {
        var html = "";
        switch (data.classVisibility) {
            case 0:
                html = "Not Logged In";
                break;
            case 10:
                html = "Logged In";
                break;
            case 20:
                html = "Granted Accounts Only";
                break;
            default:
                break;
        }
        return {
            _name: "div",
            _html: html
        }
    });
    this.dataView.registerCustomRenderer("registrationVisibility", function (data, value) {
        switch (data.registrationVisibility) {
            case 0:
                html = "Not Logged In";
                break;
            case 10:
                html = "Logged In";
                break;
            case 20:
                html = "Granted Accounts Only";
                break;
            default:
                break;
        }
        return {
            _name: "div",
            _html: html
        }
    });

    this.bind("click", function(e) {
        if(Dom.hasClass(e.target, "show-students-button") || Dom.hasClass(e.target.parentNode, "show-students-button")) {
            var classId = Dom.findUpwardForData(e.target, "_classId");
            var slot = Dom.findUpwardForData(e.target, "_slot");
            if(classId <= 0) return;
            thiz.openEditClassModal({ids: [classId], activeTab: "registrationTab", slot: slot});
            return;
        } else if(Dom.hasClass(e.target, "instructor-count")) {
            var classId = Dom.findUpwardForData(e.target, "_classId");
            if(classId <= 0) return;
            thiz.openEditClassModal({ids: [classId], activeTab: "regSlotTab"});
            return;
        } else if(Dom.hasClass(e.target, "show-instructors-button") || Dom.hasClass(e.target.parentNode, "show-instructors-button")) {
            var slotData = Dom.findUpwardForData(e.target, "_slotData");
            if(!slotData) return;
            if(slotData.instructors.length == 0) {
                var classId = Dom.findUpwardForData(e.target, "_classId");
                if(classId <= 0) return;
                thiz.openEditClassModal({ids: [classId], activeTab: "regSlotTab"});
                return;
            } else {
                this.instructorStudentDetailContent.innerHTML = "";
                for(var i = 0; i < slotData.instructors.length; i ++) {
                    var instructor = document.createElement("div");
                    Dom.addClass(instructor, "popup-detail-item");
                    instructor.innerHTML = slotData.instructors[i].fullName;
                    this.instructorStudentDetailContent.appendChild(instructor);
                    this.instructorStudentDetailHeader.innerHTML = "Instructors";
                    this.instructorStudentDetail.show(e.target, "left-inside", "bottom", -6, 10, true);
                }
            }
            return;
        } else if(Dom.hasClass(e.target, "SelectAllSlot")) {
            this.selectAllSlotClickedHandler(e.target);
        } else if(Dom.hasClass(e.target, "SlotSelection")) {
            this.selectSlotClickedHandler(e.target);
        } else if(Dom.hasClass(e.target, "Waitlisted") || Dom.hasClass(e.target, "Entered") || Dom.hasClass(e.target, "Open") || Dom.hasClass(e.target, "Future")) {
            var classId = Dom.findUpwardForData(e.target, "_classId");
            var slot = Dom.findUpwardForData(e.target, "_slot");
            if(classId <= 0) return;
            if(typeof slot == "undefined" || slot < 0) return;
            thiz.openEditClassModal({ids: [classId], slot: slot, activeTab: "registrationTab", from: "ClassList"});
        } else if (Dom.hasClass(e.target, "AddNewRegistrations")
            || Dom.hasClass(e.target.parentNode, "AddNewRegistrations")
            || Dom.hasClass(e.target.parentNode.parentNode, "AddNewRegistrations")) {
            var classId = Dom.findUpwardForData(e.target, "_classId");
            if (!classId) return;
            var classItems = thiz.dataView.dataTable.getItems();
            var classItem;
            for (var i = 0; i < classItems.length; i++) {
                if (classItems[i].id == classId) {
                    classItem = classItems[i];
                    break;
                }
            }
            if (!classItem) return;
            if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
                if (!classItem.paymentPlans || !classItem.paymentPlans.length){
                    Dialog.confirm("This class doesn't have any payment plan. Please add a payment plan before adding new registrations", "",
                        "Add Payment Plan", function() {
                            thiz.openEditClassModal({ids: [classItem.id], activeTab: "paymentPlanTab", from: "ClassList"});
                        },
                        "Cancel", function() {});
                    return;
                } else {
                    thiz.openRegistrationsDialog(classItem);
                }
            } else {
                thiz.openRegistrationsDialog(classItem);
            }
            ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.startClassExpand, window.TEAM_ALIAS);
            console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.startClassExpand, " Label: ", window.TEAM_ALIAS);

        } else if (Dom.hasClass(e.target, "TrackingAttendace")
            || Dom.hasClass(e.target.parentNode, "TrackingAttendace")
            || Dom.hasClass(e.target.parentNode.parentNode, "TrackingAttendace")) {
            var classItem = thiz.getClassDataByTarget(e.target);
            if (!classItem) return;
            var validSlots = [];
            if(classItem.slots && classItem.slots.length > 0) {
                for(var j = 0; j < classItem.slots.length; j ++) {
                    var slot = classItem.slots[j];
                    if (LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass && !this.isMyInstructorSlot(slot)) continue;
                    validSlots.push(slot);
                }
            }
            if (validSlots.length == 0) {
                Dialog.error("", "There are no slots to Track Attendance.", null);
                return;
            }
            new TrackAttendanceDialog().callback(function (data) {}).open({
                classList: [{
                    id: classItem.id,
                    title: classItem.title,
                    slots: validSlots,
                    timezoneId: classItem.timezoneId,
                    googleMapLink: classItem.googleMapLink,
                    lessonLocId: classItem.lessonLocId,
                    lessonLocName: classItem.lessonLocName,
                    detail: classItem
                }],
                enableGroupAttendanceNote: LOGIN_INFO.enableGroupAttendanceNote,
                enableClassRooomAttendanceNote: LOGIN_INFO.enableClassRooomAttendanceNote,
                classRoomAttendanceNoteLabel: LOGIN_INFO.classRoomAttendanceNoteLabel
            });
        } else if (Dom.hasClass(e.target, "TrackingSkills")
            || Dom.hasClass(e.target.parentNode, "TrackingSkills")
            || Dom.hasClass(e.target.parentNode.parentNode, "TrackingSkills")) {
            var classItem = thiz.getClassDataByTarget(e.target);
            if (!classItem) return;
            
            if (classItem.slots.length == 0) {
                Dialog.error("", "There are no slots to Track Skills.", null);
                return;
            }
            new TrackSkillsDialog().callback(function(data) {}).open({
                classList: [{
                    id: classItem.id,
                    title: classItem.title,
                    progName: classItem.progName,
                    subProgName: classItem.subProgName,
                    duration: classItem.duration,
                    instructorNames: classItem.instructorNames,
                    timezoneId: classItem.timezoneId,
                    slots: classItem.slots
                }]
            });
        } else if (Dom.hasClass(e.target, "PrintAttendace")
            || Dom.hasClass(e.target.parentNode, "PrintAttendace")
            || Dom.hasClass(e.target.parentNode.parentNode, "PrintAttendace")) {
            var classItem = thiz.getClassDataByTarget(e.target);
            if (!classItem) return;
            var validSlots = [];
            if(classItem.slots && classItem.slots.length > 0) {
                for(var j = 0; j < classItem.slots.length; j ++) {
                    var slot = classItem.slots[j];
                    if (ClassAuthUtils.onlyViewClassAttendanceOfMyInstructorClass() && !this.isMyInstructorSlot(slot)) continue;
                    validSlots.push(slot);
                }
            }
            if (validSlots.length == 0) {
                Dialog.error("", "There are no slots to Print Attendance.", null);
                return;
            }
            new PrintAttendanceDialog().callback(function(data) {}).open({
                classList: [{
                    id: classItem.id,
                    title: classItem.title,
                    slots: validSlots,
                    timezoneId: classItem.timezoneId,
                    detail: classItem
                }],
                enableGroupAttendanceNote: LOGIN_INFO.enableGroupAttendanceNote,
                enableClassRooomAttendanceNote: LOGIN_INFO.enableClassRooomAttendanceNote,
                classRoomAttendanceNoteLabel: LOGIN_INFO.classRoomAttendanceNoteLabel
            });
        } else if (Dom.hasClass(e.target, "CloneClass")
            || Dom.hasClass(e.target.parentNode, "CloneClass")
            || Dom.hasClass(e.target.parentNode.parentNode, "CloneClass")) {
              var classInfo = thiz.getClassDataByTarget(e.target);
              if (!classInfo) {
                  Dialog.error("", "This class cannot be cloned", null);
                  return;
              }
              window.defaultIndicator.busy("Loading...");
              $classAdminService.getClassDetailById(classInfo.id, function(res) {
                  if(window.defaultIndicator) { window.defaultIndicator.done(); }
                  var classItem = res;
                  if (!classItem) {
                      Dialog.error("", "This class cannot be cloned", null);
                  } else {
                      thiz.cloneAndEditClass(classItem);
                  }
              }, function(err) {
                  if(window.defaultIndicator) { window.defaultIndicator.done(); }
                  Dialog.error("", "This class cannot be cloned", null);
              });
        } else if (Dom.hasClass(e.target, "ShareClass")
            || Dom.hasClass(e.target.parentNode, "ShareClass")
            || Dom.hasClass(e.target.parentNode.parentNode, "ShareClass")) {
              var classInfo = thiz.getClassDataByTarget(e.target);
              if (!classInfo) {
                  Dialog.error("", "This class cannot be cloned", null);
                  return;
              }
              new ShareClassDialog().open({type: "Class", name: classInfo.title, data: {classId: classInfo.id, subProgId: classInfo.subProgId}});
        }
    }, this.dataView);
}

__extend(BaseTemplatedWidget, ClassListWidget);

ClassListWidget.prototype.onAttached = function(isFirst) {
    if (!isFirst) return;
    var thiz = this;
    var interval = 100;
    var f = function() {
        if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
            thiz.onAttachedDelayed();
            return;
        }
        window.setTimeout(f, interval);
    };
    f();
};

ClassListWidget.prototype.onAttachedDelayed = function() {
    var thiz = this;
    if (this.isDomAttached) return;
    this.isDomAttached = true;

    this.dataView.setDefaultSelectionHandler(function(data, fieldName, cell, e) {
        if (Dom.hasClass(e.target, "manage-class-action") && data) {
            if (!data || !data.id) return;
            var isMyInstructorAssigned = ClassUtils.isMyInstructorAssigned(data, LOGIN_INFO.accountId);
            if (ClassAuthUtils.canCreateEditDeleteClass(LOGIN_INFO)
                || (isMyInstructorAssigned && ClassAuthUtils.canManageMyInstructorClass(LOGIN_INFO))) {
                thiz.openEditClassModal({ids: [data.id]});
            }
            return;
        } else if((Dom.hasClass(e.target, "ShowClassDetailClickable") || Dom.hasClass(e.target.parentNode, "ShowClassDetailClickable")) && data) {
            if(!data || data.id <= 0) return;
            thiz.classTitleClickHandler(e.target, data);
            return;
        }
    });
    
    var editActions = [];
    if (ClassAuthUtils.canUpdateClassMetaOrders(LOGIN_INFO)) {
        editActions.push({
            title: "Edit Display Order",
            run: function (items) {
                new EditDisplayOrderDialog().open();
            },
            applicable: function (count, dataView) {
                return true;
            }
        });
    }
    if (ClassAuthUtils.canCreateEditDeleteClass(LOGIN_INFO)) {
        var editClassActions = [
            {
                title: "Edit Class",
                run: function (items) {
                    thiz.dataView.getSelectedItems(function (selectedItems) {
                        var ids = [];
                        for(var i = 0; i < selectedItems.length; i ++) {
                            ids.push(selectedItems[i].id);
                        }
                        thiz.openEditClassModal({ids: ids, memberClasses: selectedItems});
                    });
                },
                applicable: function (count, dataView) {
                    return count == 1 ;
                }
            }, {
                title: "Manage Class Athletes",
                run: function (items) {
                    thiz.dataView.getSelectedItems(function (selectedItems) {
                        var ids = [];
                        for(var i = 0; i < selectedItems.length; i ++) {
                            ids.push(selectedItems[i].id);
                        }
                        if(ids.length == 0) return;
                        thiz.openEditClassModal({ids: ids, memberClasses: selectedItems, activeTab: "registrationTab"});
                    });
                },
                applicable: function (count, dataView) {
                    return count == 1;
                }
            }, {
                title: "Multi-Edit Basic Info",
                run: function (items) {
                    thiz.dataView.getSelectedItems(function (selectedItems) {
                        var ids = [];
                        for(var i = 0; i < selectedItems.length; i ++) {
                            ids.push(selectedItems[i].id);
                        }
                        new ClassMultiEditDialog().callback(function(updated) {
                            if (!updated) return;
                            thiz.dataView.refreshDataList();
                            Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
                        }).open({selectedItems: selectedItems});
                    });

                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            }, {
                title: "Multi-Overwrite Slot Structure",
                run: function (items) {
                    thiz.dataView.getSelectedItems(function (selectedItems) {
                        var ids = [], itemNotEditable = null;
                        for(var i = 0; i < selectedItems.length; i ++) {
                            if(!selectedItems[i].editable) {
                                itemNotEditable = selectedItems[i];
                                break;
                            }
                            ids.push(selectedItems[i].id);
                        }
                        if(itemNotEditable != null) {
                            Dialog.error("", "[" + itemNotEditable.title + "] can not edit because it has been registed or taken attendance.", null);
                            return;
                        }
                        if(ids.length == 0) return;
                        new ClassMultiEditRegSlotDialog().callback(function(classData) {
                            if(!classData) return;
                            $classAdminService.saveMultiSlots({classIds: ids, slots: classData.slots}, function(res) {
                                thiz.dataView.refreshDataList();
                                Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
                            }, function(err) {
                                Dialog.error(err.message || err);
                            });
                        }).open({ids: ids, memberClasses: selectedItems});
                    });

                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            }, {
                title: "Multi-Edit Questions",
                run: function (items) {
                    
                    thiz.dataView.getSelectedItems(function (selectedItems) {
                        var ids = selectedItems.map(item => item.id);
                        new ClassMultiEditQuestionDialog().callback(function(saved) {
                            if(!saved) return;
                            thiz.dataView.refreshDataList();
                            Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
                        }).open({ids: ids, classes: selectedItems});
                    });

                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            }, {
                title: "Multi-Clone",
                run: function (items) {
                    thiz.dataView.getSelectedItems(function (selectedItems) {
                        var ids = [], itemTitles = [];
                        for(var i = 0; i < selectedItems.length; i ++) {
                            ids.push(selectedItems[i].id);
                            itemTitles.push(selectedItems[i].title);
                        }
                        if(ids.length == 0) return;
                        var allClassTitles = "\"" + itemTitles.join("\", \"") + "\"";
                        Dialog.confirm("Are you sure you want to clone " + allClassTitles +"? The slot structure will be cloned accordingly for every class. " +
                        "Please edit the slot structure for every class or perform Multi-Overwrite Slot Structure afterward, " +
                        "if you need to change it. ", "", "Clone", function() {
                            $classAdminService.cloneMultiLessonClass(ids, function(res) {
                                Dialog.alert("", ids.length + (ids.length > 1 ? " classes are " : " class is ") + "being cloned. Please refresh the Classes if you don't see it.",
                                function() {
                                    var searchInput = document.getElementsByClassName("widget_AutoCompleteText sys_FrameworkWidget AnonId_textInput")[0];
                                    if (searchInput) searchInput.value = "Clone";
                                    thiz.dataView.filterView.valueMap.title = "Clone";
                                    Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
                                    window.defaultIndicator.busy("Loading...");
                                    window.setTimeout(function () {
                                        thiz.dataView.refreshDataList();
                                        if(window.defaultIndicator) { window.defaultIndicator.done(); }
                                    }, ids.length * 1000);

                                });

                            }, function(err) {
                                Dialog.error(err.message || err);
                            });
                        }, "Cancel");
                    });

                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            }, {
                title: "Delete",
                run: function (items) {
                    thiz.dataView.getSelectedItems(function (selectedItems) {
                        var ids = [], itemNotDeletable = "", cannotDeleteCount = 0, warningItems = [];
                        for(var i = 0; i < selectedItems.length; i ++) {
                            if(!selectedItems[i].deletable) {
                                itemNotDeletable += ((itemNotDeletable? ", " : "") + ("\"" + selectedItems[i].title + "\""));
                                cannotDeleteCount++;
                            }
                            ids.push(selectedItems[i].id);
                            if (!selectedItems[i].isPastClass && selectedItems[i].previouslyRegistered) {
                                warningItems.push(selectedItems[i]);
                            }
                        }
                        if(itemNotDeletable) {
                            var str = (cannotDeleteCount > 1)? "Cannot delete " + itemNotDeletable + " because they are taken attendance or registered" :
                            "Cannot delete " + itemNotDeletable + " because it is taken attendance or registered" ;
                            Dialog.error("", str, null);
                            return;
                        }
                        if(ids.length == 0) return;
                        var warningMessage = "";
                        if (warningItems.length) {
                            warningMessage = String.format("\"{0}\" {1} currently active and has registrations. Are you sure you want to delete {2}?",
                                warningItems.reduce(function(msg, item){
                                    if (!msg) return item.title;
                                    return msg + ", " + item.title;
                                }, ""),
                                warningItems.length > 1 ? "are" : "is",
                                warningItems.length == selectedItems.length ? (warningItems.length > 1 ? "them" : "it") : "selected item(s)"
                            );
                        }

                        if (!warningMessage) warningMessage = "Are you sure you want to delete selected item(s)?";
                        Dialog.confirm(warningMessage, "", "Delete", function() {
                            $classAdminService.deleteLessonClass(ids, function(res) {
                                thiz.dataView.refreshDataList();
                                Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
                            }, function(err) {});
                        }, "Cancel");
                    });

                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            }

        ];
        
        editActions = editActions.concat(editClassActions);
    }
    
    if (editActions.length) {
        //Register Actions
        this.dataView.registerActions(editActions, "Edit");
    }
    
    var attendanceActions = [];
    
    var isAbleToPrintAttendanceReport = ClassAuthUtils.isAbleToPrintAllAttendanceReport(LOGIN_INFO) || ClassAuthUtils.isAbleToPrintAttendanceReportOfMyInstructorClass(LOGIN_INFO);
    if (isAbleToPrintAttendanceReport) {
        attendanceActions.push({
            title: "Print/Export Attendance",
            run: function (items) {
                thiz.dataView.getSelectedItems(function (selectedItems) {
                    thiz.printAttendanceClickedHandler(selectedItems);
                });
            },
            applicable: function (count, dataView) {
                return thiz.isEnableAttendanceAction();
            }
        });
    }

    if (LOGIN_INFO.isAbleTakeAttendance || LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass) {
        attendanceActions.push({
            title: "Track Attendance",
            run: function (items) {
                thiz.dataView.getSelectedItems(function (selectedItems) {
                    thiz.trackAttendanceClickedHandler(selectedItems);
                });

            },
            applicable: function (count, dataView) {
                return thiz.isEnableAttendanceAction();
            }
        });
    }
    if (LOGIN_INFO.isAbleTakeSkill) {
        attendanceActions.push({
            title: "Track Skills",
            run: function (items) {
                thiz.dataView.getSelectedItems(function (selectedItems) {
                    thiz.trackSkillsClickedHandler(selectedItems);
                });
            },
            applicable: function (count, dataView) {
                return thiz.isEnableAttendanceAction();
            }
        });
    }


    if (attendanceActions.length) this.dataView.registerActions(attendanceActions, "Attendance & Skills");

    if (!ClassAuthUtils.canCreateEditDeleteClass(LOGIN_INFO)) {
        Dom.addClass(this.containerWrapper, "ReadOnly");
    }
};

ClassListWidget.prototype.openEditClassModal = function(option) {
    option.enableGroupAttendanceNote = LOGIN_INFO.enableGroupAttendanceNote;
    option.enableClassRooomAttendanceNote = LOGIN_INFO.enableClassRooomAttendanceNote;
    option.classRoomAttendanceNoteLabel = LOGIN_INFO.classRoomAttendanceNoteLabel;
    var thiz = this;
    thiz.classEditDialog = new ClassEditDialog();
    thiz.classEditDialog.callback(function(data) {
        thiz.saveClassCallback(data);
    }).open(option);
};

ClassListWidget.prototype.saveClassCallback = function(data) {
    var thiz = this;
    if (data && data.success && data.classData) {
        if (data.classData.classDressCode) {
            data.classData.classDressCode.classId = res.id;
            thiz.saveClassDressCode(data.classData.classDressCode, function() {
                thiz.dataView.refreshDataList();
                Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
            })
            return;
        }
        thiz.dataView.refreshDataList();
    } else {
        if ((thiz.classEditDialog && thiz.classEditDialog.reloadOnClose) || (data && data.reloadOnClose)) {
            console.log("RELOAD CLASS LIST", data);
            thiz.dataView.refreshDataList();
            Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
        }
    }    
}

ClassListWidget.prototype.saveClassDressCode = function(classDressCode, callback) {
    widget.__ensureNamespaceLoaded("discountdance", function(namespace) {
        if (namespace) {
            namespace.util.saveClassDressCode(classDressCode, function(rs) {
                if (callback) callback(rs);
            });
            return;
        }
        if (callback) callback();
    })
}

ClassListWidget.prototype.classTitleClickHandler = function(target, data) {
    var row = Dom.findParentByTagName(target, "tr");
    if(!data || !row) return;
    var nextRow = row.nextSibling;
    if(Dom.hasClass(row, "show-detail")) {
        Dom.removeClass(row, "show-detail");
        if(nextRow && Dom.hasClass(nextRow, "detail-content-wrapper")) {
            nextRow.style.display = "none";
        }
        this.expandAllClass = false;
        return;
    }
    Dom.addClass(row, "show-detail");
    if(nextRow && Dom.hasClass(nextRow, "detail-content-wrapper")) {
        nextRow.style.display = "table-row";
        return;
    }
    this.renderRowDetailContent(row, nextRow, data);
    this.expandAllClass = false;
};

ClassListWidget.prototype._registerDressCodeLazyLoad = function(classId, holder) {
    if (this._dressCodeTask) {
        clearInterval(this._dressCodeTask);
        this._dressCodeTask = undefined;
    }
    if (!this._lazyDressCodeHolders) this._lazyDressCodeHolders = {};
    this._lazyDressCodeHolders[classId] = holder;

    this._dressCodeTask = setInterval(function() {
        clearInterval(this._dressCodeTask);
        this._dressCodeTask = undefined;
        var ids = Object.keys(this._lazyDressCodeHolders);
        if (!ids) return;
        $classDressCodeService.getClassDressCodeDetails(ids, function(rs) {
            if (rs && rs.result) {
                for(var i = 0; i < rs.result.length; i ++) {
                    var dc = rs.result[i];
                    var h = this._lazyDressCodeHolders[dc.classId];
                    if (h) h(dc);
                }
            }
            this._lazyDressCodeHolders = undefined;
        }.bind(this), function(err) {
            
        }.bind(this));
    }.bind(this), 500);
}

ClassListWidget.prototype.expandAllClassDetail = function() {
    var thiz = this;
    Dom.addClass(this.containerWrapper, "ExpandDetail");
    this.expandAllClass = true;
    const rows = this.dataView.dataTable.body.getElementsByTagName("tr");
    this.expandedItemCount = rows.length;
    if(rows && rows.length > 0) {
        for(var i = 0; i < rows.length; i ++) {
            var row = rows[i];
            if(Dom.hasClass(row, "detail-content-wrapper")) {
                row.style.display = "table-row";
                continue;
            }
            var item = DataTable.getRowData(row);
            Dom.addClass(row, "show-detail");
            var nextRow = row.nextSibling;
            if(nextRow && Dom.hasClass(nextRow, "detail-content-wrapper")) {
                nextRow.style.display = "table-row";
                continue;
            }
            this.renderRowDetailContent(row, nextRow, item);
        }
    }
};

ClassListWidget.prototype.collapseAllClassDetail = function() {
    var thiz = this;
    this.expandAllClass = false;
    this.expandedItemCount = 0;
    Dom.removeClass(this.containerWrapper, "ExpandDetail");
    const rows = this.dataView.dataTable.body.getElementsByTagName("tr");
    if(rows && rows.length > 0) {
        for(var i = 0; i < rows.length; i ++) {
            var row = rows[i];
            if(Dom.hasClass(row, "detail-content-wrapper")) {
                row.style.display = "none";
            } else {
                Dom.removeClass(row, "show-detail");
            }
        }
    }
};

ClassListWidget.prototype.renderRowDetailContent = function(row, nextRow, itemData) {
    var thiz = this;
    if(!itemData) return;
    var currency = LOCALE.currency ? LOCALE.CURRENCY : "$";
    var newRow = document.createElement("tr"),
        contentTd = document.createElement("td"),
        divContent = document.createElement("div");
    var totalColumn = row.getElementsByTagName("td");
    contentTd.setAttribute("colspan", totalColumn.length);
    contentTd.appendChild(divContent);
    newRow.appendChild(contentTd);
    Dom.addClass(newRow, "detail-content-wrapper");
    newRow._classId = itemData.id;
    var contentDetail = document.createElement("div");
    contentDetail.setAttribute("flex", 1);
    Dom.addClass(contentDetail, "content-detail-pane");

    var allowClassAddTool = false;
    if (LOGIN_INFO.allowClassToolAddNewRegistrations
        && (ClassAuthUtils.canAddRegistrationForMember(LOGIN_INFO))
        && itemData.slots && itemData.slots.length > 0) {
        allowClassAddTool = true;
    }
    new ClassListRowDetailWidget({itemData: itemData, allowClassAddTool: allowClassAddTool}).into(contentDetail);
    divContent.appendChild(contentDetail);

    if(itemData.slots && itemData.slots.length > 0) {
        var slotContentTable = document.createElement("table");
        Dom.addClass(slotContentTable, "table-reg-slot Slots");
        slotContentTable.setAttribute("border", "1");
        slotContentTable.setAttribute("cellspacing", "0");
        slotContentTable.setAttribute("cellpadding", "0");

        var tHead = document.createElement("thead");
        slotContentTable.appendChild(tHead);
        var headerRow = document.createElement("tr");
        tHead.appendChild(headerRow);

        var slotSelectionCol = document.createElement("th");
        Dom.addClass(slotSelectionCol, "SlotSelectionWrapper");
        var selection = document.createElement("input");
        selection.setAttribute("type", "checkbox");
        slotContentTable._totalSlot = itemData.slots.length;
        if (this.selectedSlotItems[itemData.id]) {
            selection.checked = true;
        }
        if (itemData.isPastClass) {
            selection.setAttribute("disabled", "disabled");
            selection.checked = false;
            selection._isPastClass = true;
        }

        Dom.addClass(selection, "SelectAllSlot");
        slotSelectionCol.appendChild(selection);
        headerRow.appendChild(slotSelectionCol);

        var slotNumberCol = document.createElement("th");
        Dom.addClass(slotNumberCol, "slot-number");
        slotNumberCol.innerHTML = "Slot #";
        headerRow.appendChild(slotNumberCol);

        var slotLimitCol = document.createElement("th");
        Dom.addClass(slotLimitCol, "slot-limit");
        slotLimitCol.innerHTML = "Slot Limit";
        headerRow.appendChild(slotLimitCol);

        var slotOpenCol = document.createElement("th");
        Dom.addClass(slotOpenCol, "CurrentRegistrations");
        slotOpenCol.innerHTML = "Current Registrations";
        headerRow.appendChild(slotOpenCol);
        headerRow.appendChild(this.createHeaderCol("Mon"));
        headerRow.appendChild(this.createHeaderCol("Tue"));
        headerRow.appendChild(this.createHeaderCol("Wed"));
        headerRow.appendChild(this.createHeaderCol("Thu"));
        headerRow.appendChild(this.createHeaderCol("Fri"));
        headerRow.appendChild(this.createHeaderCol("Sat"));
        headerRow.appendChild(this.createHeaderCol("Sun"));

        var tbody = document.createElement("tbody");
        this.classTableBody = tbody;
        slotContentTable.appendChild(tbody);
        var selectSlotCount = 0;

        for(var i = 0; i < itemData.slots.length; i ++) {
            if(itemData.slots[i].showable) {
                tbody.appendChild(this.createRegSlotRow(itemData.slots[i], itemData.id, itemData.isWaitlist, itemData.isPastClass));
                if(this.selectedSlotItems[itemData.id] && this.selectedSlotItems[itemData.id][itemData.slots[i].id]) {
                    selectSlotCount ++;
                }
            }
        }
        slotContentTable._selectedSlot = selectSlotCount;
        if(selectSlotCount == itemData.slots.length) {
            selection.checked = true;
        }
        var tableSlotWrapper = document.createElement("div");
        Dom.addClass(tableSlotWrapper, "SlotsTable");
        console.log("tableSlotWrapper", tableSlotWrapper);
        tableSlotWrapper.appendChild(slotContentTable);
        contentTd.appendChild(tableSlotWrapper);
    }

    var tbody = Dom.findParentByTagName(row, "tbody");
    if(!tbody) return;
    if(nextRow) {
        tbody.insertBefore(newRow, nextRow);
    } else {
        tbody.appendChild(newRow);
    }
};

ClassListWidget.prototype.createHeaderCol = function (s) {
    var col = document.createElement("th");
    col.innerHTML = s;
    return col;
};

ClassListWidget.prototype.createRegSlotRow = function (slotData, classId, isWaitlist, isPastClass) {
    var row = document.createElement("tr");

    row._classId = classId;
    row._slot = slotData.slot;
    var totalSlotRegister = slotData.slotRegister;
    Dom.addClass(row, "Slot");
    if (slotData.slotRegister < slotData.maxLimit || (slotData.maxLimit == 0 && isWaitlist)){
        Dom.addClass(row, "NotFull");
    }
    row._totalSlotRegister = totalSlotRegister;

    var slotSelectionCol = document.createElement("td");
    Dom.addClass(slotSelectionCol, "SlotSelectionWrapper");
    var selection = document.createElement("input");
    selection.setAttribute("type", "checkbox");
    selection.value = slotData.id;

    if (isPastClass) {
        selection.setAttribute("disabled", "disabled");
        selection.checked = false;
        selection._isPastClass = isPastClass;
    } else {
        var isCheckedSlot = false;
        var selectedClasses = this.dataView.dataTable.getSelectedItems();
        for (var i = 0; i < selectedClasses.length; i++) {
            if (selectedClasses[i].id == classId) {
                isCheckedSlot = true;
                break;
            }
        }
        selection.checked = isCheckedSlot;
        if (isCheckedSlot) {
            if (!this.selectedSlotItems[classId]) this.selectedSlotItems[classId] = {};
            this.selectedSlotItems[classId][slotData.id] = true;
        } else {
            if (this.selectedSlotItems[classId]) delete this.selectedSlotItems[classId][slotData.id];
        }
    }

    Dom.addClass(selection, "SlotSelection");
    slotSelectionCol.appendChild(selection);
    row.appendChild(slotSelectionCol);

    var slotNumberCol = document.createElement("td");
    Dom.addClass(slotNumberCol, "slot-number");
    slotNumberCol.innerHTML = slotData.slotOrder;
    row.appendChild(slotNumberCol);

    var slotLimitCol = document.createElement("td");
    Dom.addClass(slotLimitCol, "slot-limit");
    if(slotData.maxLimit == 99999) {
        slotLimitCol.innerHTML = "No Limit";
    } else {
        slotLimitCol.innerHTML = slotData.maxLimit;
    }
    row.appendChild(slotLimitCol);

    var currentRegistrationsCol = document.createElement("td");
    Dom.addClass(currentRegistrationsCol, "CurrentRegistrations");
    var slotOpen = slotData.openRegistration + "";
    if (slotOpen < 0) slotOpen = "0";
    if (slotOpen >= 99999) slotOpen = "No Limit";
    var registrationEl = Dom.newDOMElement({
        _name: "hbox",
        _children: [
            {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Currently registered members",
                _children: [{_name: "div", _html: "Active"}, {_name: "div", "flex": 1, "class": "Entered", _html: slotData.enteredRegistration + ""}]
            }, {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Available registrations. Does NOT consider any future registrations",
                _children: [{_name: "div", _html: "Open"},
                    {_name: "div", "flex": 1, "class": "Open", _html: slotOpen}]
            }, {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Registrations with a start date in the future",
                _children: [{_name: "div", _html: "Future"}, {_name: "div", "flex": 1, "class": "Future", _html: slotData.futureRegistration + ""}]
            },
            {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Waitlisted members",
                _children: [{_name: "div", _html: "Waiting"}, {_name: "div", "flex": 1, "class": "Waitlisted", _html: slotData.waitingRegistration + ""}]
            }
        ]
    });

    currentRegistrationsCol.appendChild(registrationEl);
    row.appendChild(currentRegistrationsCol);





    row.appendChild(this.createWeedayCol(slotData.schedByWeekdayName, "Mon"));
    row.appendChild(this.createWeedayCol(slotData.schedByWeekdayName, "Tue"));
    row.appendChild(this.createWeedayCol(slotData.schedByWeekdayName, "Wed"));
    row.appendChild(this.createWeedayCol(slotData.schedByWeekdayName, "Thu"));
    row.appendChild(this.createWeedayCol(slotData.schedByWeekdayName, "Fri"));
    row.appendChild(this.createWeedayCol(slotData.schedByWeekdayName, "Sat"));
    row.appendChild(this.createWeedayCol(slotData.schedByWeekdayName, "Sun"));
    return row;
};

ClassListWidget.prototype.createWeedayCol = function (schedByWeekdayName, dayKey) {
    var col = document.createElement("td");
    Dom.addClass(col, "SlotTime " + dayKey);
    col._slotData = schedByWeekdayName[dayKey];
    if(schedByWeekdayName[dayKey]) {
        var startTime = document.createElement("div");
        startTime.innerHTML = schedByWeekdayName[dayKey].startTime;
        col.appendChild(startTime);

        var actions = document.createElement("div");
        if(schedByWeekdayName[dayKey].instructors && schedByWeekdayName[dayKey].instructors.length == 0) {
            var instructorCount = document.createElement("a");
            Dom.addClass(instructorCount, "instructor-count");
            instructorCount.innerHTML = schedByWeekdayName[dayKey].instructors.length;
            instructorCount.title = "Manage Instructors";
            actions.appendChild(instructorCount);
        } else {
            Dom.addClass(col, "HasInstructor");
        }

        var showInstructorButton = document.createElement("a");
        Dom.addClass(showInstructorButton, "show-instructors-button");
        if(schedByWeekdayName[dayKey].instructors.length == 0) Dom.addClass(showInstructorButton, "no-instructor");
        showInstructorButton.innerHTML = '<icon class="voice"></icon>';
        showInstructorButton.title = "Show Instructors";
        actions.appendChild(showInstructorButton);
        col.appendChild(actions);
    }
    return col;
};

ClassListWidget.prototype.addClassButtonClickHandler = function () {
    var thiz = this;
    thiz.classEditDialog = new ClassEditDialog().callback(function(data) {
        thiz.saveClassCallback(data);
    });
    thiz.classEditDialog.open({});
};

ClassListWidget.prototype.selectAllSlotClickedHandler = function(target) {
    var tableRegSlot = Dom.findParentByTagName(target, "table");
    this.toggleSlotHandler(tableRegSlot, target.checked);
};

ClassListWidget.prototype.toggleSlotHandler = function(slotTable, isChecked) {
    if(!slotTable) return;
    var slotSelections = slotTable.getElementsByClassName("SlotSelection");
    if(slotSelections.length > 0 ) {
        if(isChecked) {
            slotTable._selectedSlot = slotSelections.length;
        } else {
            slotTable._selectedSlot = 0;
        }
        for(var i = 0; i < slotSelections.length; i ++) {
            slotSelections[i].checked = isChecked;
            var row = Dom.findParentByTagName(slotSelections[i], "tr");
            if(isChecked) {
                if(!this.selectedSlotItems[row._classId]) this.selectedSlotItems[row._classId] = {};
                this.selectedSlotItems[row._classId][slotSelections[i].value] = true;
            } else {
                delete this.selectedSlotItems[row._classId];
            }
        }
        if (isChecked) {
            var classItem;
            for (var i = 0; i < this.dataView.dataTable.getItems().length; i ++) {
                if (this.dataView.dataTable.getItems()[i].id == row._classId) {
                    classItem = this.dataView.dataTable.getItems()[i];
                    break;
                }
            }
            var selectedItems = this.dataView.dataTable.getSelectedItems();
            if (!selectedItems) selectedItems = [];
            var existItem = false;
            if (!classItem) return;
            for (var i = 0; i < selectedItems.length; i ++) {
                if (selectedItems[i].id == classItem.id) {
                    existItem = true;
                    break;
                }
            }
            if (!existItem) {
                this.slotItemClickAction = true;
                selectedItems.push(classItem);
                this.settingDataTableItems = true;
                this.dataView.dataTable.selectItems(selectedItems, true);
            }
        }
    }
    this.dataView._invalidateActions();
};

ClassListWidget.prototype.selectSlotClickedHandler = function(target) {
    var tableRegSlot = Dom.findParentByTagName(target, "table");
    if(!tableRegSlot) return;
    var selectAll = tableRegSlot.getElementsByClassName("SelectAllSlot")[0];
    var row = Dom.findParentByTagName(target, "tr");
    if(target.checked) {
        var tbody = tableRegSlot.getElementsByTagName("tbody")[0];
        var count = 0;
        var slotSelections = tbody.getElementsByClassName("SlotSelection");
        if (slotSelections && slotSelections.length > 0) {
            for (var i = 0; i < slotSelections.length; i++) {
                if (slotSelections[i].checked) {
                    count ++;
                } else {
                    break;
                }
            }
        }
        if(count > 0 && count == slotSelections.length) {
            selectAll.checked = true;
        } else {
            selectAll.checked = false;
        }
        if (!this.selectedSlotItems[row._classId]) this.selectedSlotItems[row._classId] = {};
        var classItem;
        for (var i = 0; i < this.dataView.dataTable.getItems().length; i ++) {
            if (this.dataView.dataTable.getItems()[i].id == row._classId) {
                classItem = this.dataView.dataTable.getItems()[i];
                break;
            }
        }
        this.selectedSlotItems[row._classId][target.value] = true;
        var selectedItems = this.dataView.dataTable.getSelectedItems();
        if (!selectedItems) selectedItems = [];
        var existItem = false;
        if (!classItem) return;
        for (var i = 0; i < selectedItems.length; i ++) {
            if (selectedItems[i].id == classItem.id) {
                existItem = true;
                break;
            }
        }
        if (!existItem) {
            this.slotItemClickAction = true;
            selectedItems.push(classItem);
            this.settingDataTableItems = true;
            this.dataView.dataTable.selectItems(selectedItems, true);
        }
    } else {
        if(selectAll) selectAll.checked = false;
        if(this.selectedSlotItems[row._classId]) {
            this.selectedSlotItems[row._classId][target.value] = false;
        }
    }
    this.dataView._invalidateActions();
};

ClassListWidget.prototype.printAttendanceClickedHandler = function(items) {
    if(!items) return;
    if(items.length == 0) return;
    var thiz = this;
    var classList = [];
    for(var i = 0; i < items.length; i ++) {
        //if(items[i].isPastClass) continue;
        var classItem = {
            id: items[i].id,
            title: items[i].title,
            slots: [],
            detail: items[i],
            timezoneId: items[i].timezoneId
        };
        if(thiz.selectedSlotItems[items[i].id] && items[i].slots && items[i].slots.length > 0) {
            for(var j = 0; j < items[i].slots.length; j ++) {
                var slot = items[i].slots[j];
                if (ClassAuthUtils.onlyViewClassAttendanceOfMyInstructorClass() && !this.isMyInstructorSlot(slot)) continue;
                if(thiz.selectedSlotItems[items[i].id][slot.id]) {
                    classItem.slots.push(slot);
                }
            }
        }
        if(classItem.slots.length > 0) {
            classList.push(classItem);
        }
    }
    if (classList.length == 0) {
        Dialog.error("", "There are no valid slots to Print Attendance. Please ensure you can access the selected slot(s).", null);
        return;
    }

    var options = {
        classList: classList,
        enableGroupAttendanceNote: LOGIN_INFO.enableGroupAttendanceNote,
        enableClassRooomAttendanceNote: LOGIN_INFO.enableClassRooomAttendanceNote,
        classRoomAttendanceNoteLabel: LOGIN_INFO.classRoomAttendanceNoteLabel
    };
    new PrintAttendanceDialog().callback(function(data) {

    }).open(options);
};

ClassListWidget.prototype.isEnableAttendanceAction = function () {
    return this.dataView.getSelectedItemCount() > 0;
};

ClassListWidget.prototype.trackSkillsClickedHandler = function(items) {
    if(!items) return;
    if(items.length == 0) return;
    var thiz = this;
    var classList = [];
    for(var i = 0; i < items.length; i ++) {
        //if(items[i].isPastClass) continue;
        var classItem = {
            id: items[i].id,
            title: items[i].title,
            progName: items[i].progName,
            subProgName: items[i].subProgName,
            duration: items[i].duration,
            instructorNames: items[i].instructorNames,
            timezoneId: items[i].timezoneId,
            slots: []
        };
        classItem.slots = [];
        if(thiz.selectedSlotItems[items[i].id] && items[i].slots && items[i].slots.length > 0) {
            for(var j = 0; j < items[i].slots.length; j ++) {
                var slot = items[i].slots[j];
                if(thiz.selectedSlotItems[items[i].id][slot.id]) {
                    classItem.slots.push(slot);
                }
            }
        }
        if(classItem.slots.length > 0) {
            classList.push(classItem);
        }
    }
    if (classList.length == 0) {
        Dialog.error("", "There are no valid slots to Track Skills. Please ensure you can access the selected slot(s).", null);
        return;
    }
    var options = {
        classList: classList
    };
    new TrackSkillsDialog().callback(function(data) {

    }).open(options);
};

ClassListWidget.prototype.isMyInstructorSlot = function(slot) {
    if (!slot || !slot.instructorIds) return false;
    return slot.instructorIds && slot.instructorIds.includes(window.LOGIN_INFO.accountId);
}

ClassListWidget.prototype.trackAttendanceClickedHandler = function(items) {
    if(!items) return;
    if(items.length == 0) return;
    var thiz = this;
    var classList = [];
    for(var i = 0; i < items.length; i ++) {
        //if(items[i].isPastClass) continue;
        var classItem = {
            id: items[i].id,
            title: items[i].title,
            progName: items[i].progName,
            subProgName: items[i].subProgName,
            duration: items[i].duration,
            instructorNames: items[i].instructorNames,
            slots: [],
            dateStart: items[i].dateStart,
            dateEnd: items[i].dateEnd,
            timezoneId: items[i].timezoneId,
            googleMapLink: items[i].googleMapLink,
            lessonLocId: items[i].lessonLocId,
            lessonLocName: items[i].lessonLocName,
            detail: items[i]
        };
        classItem.slots = [];
        if(thiz.selectedSlotItems[items[i].id] && items[i].slots && items[i].slots.length > 0) {
            for(var j = 0; j < items[i].slots.length; j ++) {
                var slot = items[i].slots[j];
                if (LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass && !this.isMyInstructorSlot(slot)) continue;
                if(thiz.selectedSlotItems[items[i].id][slot.id]) {
                    classItem.slots.push(slot);
                }
            }
        }
        if(classItem.slots.length > 0) {
            classList.push(classItem);
        }
    }
    if (classList.length == 0) {
        Dialog.error("", "There are no valid slots to Track Attendance. Please ensure you can access the selected slot(s).", null);
        return;
    }
    var options = {
        classList: classList,
        enableGroupAttendanceNote: LOGIN_INFO.enableGroupAttendanceNote,
        enableClassRooomAttendanceNote: LOGIN_INFO.enableClassRooomAttendanceNote,
        classRoomAttendanceNoteLabel: LOGIN_INFO.classRoomAttendanceNoteLabel
    };
    new TrackAttendanceDialog().callback(function (data) {}).open(options);
};

ClassListWidget.prototype.openRegistrationsDialog = function (classData) {
    if (!classData) return;
    var thiz = this;
    thiz.isRegistrationsChanged = false;
    var registrationsOptions = {
        classId: classData.id,
        title: classData.title,
        ageText: classData.ageText,
        allowedGenders: classData.allowedGenders,
        ageLow: classData.ageLow,
        ageHi: classData.ageHi,
        dateAgeUp: classData.dateAgeUp,
        insuranceOptions: classData.insuranceOptions,
        emergencyOptions: classData.emergencyOptions,
        addedMemberIds: [],
        registrationsChanged: function (isRegistrationsChanged) {
            thiz.isRegistrationsChanged = isRegistrationsChanged;
        }
    };
    var registrationsDialog = new RegistrationsDialog().callback(function (registrationsData) {
        if (thiz.isRegistrationsChanged) thiz.dataView.refreshDataList();
    }).open(registrationsOptions);
};

ClassListWidget.prototype.getClassDataByTarget = function(target) {
    var classId = Dom.findUpwardForData(target, "_classId");
    if (!classId) return;
    var classItems = this.dataView.dataTable.getItems();
    var classItem;
    for (var i = 0; i < classItems.length; i++) {
        if (classItems[i].id == classId) {
            classItem = classItems[i];
            break;
        }
    }
    return classItem;
};

ClassListWidget.prototype.cloneAndEditClass = function (classData) {
    var thiz = this;
    if (!classData) return;
    var oldTitle = classData.title;
    var newTitle = classData.title;
    if (newTitle.lastIndexOf("Clone") != newTitle.length - 5) newTitle += " Clone";
    new ConfirmCloneClassDialog().callback(function(data) {
        if (!data) return;
        if(classData && classData.hasError) {
            delete classData.hasError;
            return;
        }
        if (classData && classData.hasSlotError && classData.errorMessage) {
            Dialog.error(classData.errorMessage, "", function() {});
            delete classData.hasSlotError;
            delete classData.errorMessage;
            return;
        }
        classData.title = data.clonedClassTitle;
        if (classData.oldThumnailFilePath && classData.oldThumnailFilePath == classData.thumbnailFilePath) {
            classData.thumbnailFilePath = "";
        }

        for(var i = 0; i < classData.slots.length; i++) {
            var s = classData.slots[i];
            s.id = 0;
            s.oldPregeneratingKey = "";
            for(var k in s.schedByWeekdayName) {
                var sched = s.schedByWeekdayName[k];
                sched.id = 0;
                sched.oldPregeneratingKey = "";
                for(var j = 0; j < sched.instructors.length; j++){
                    sched.instructors[j].instructorId = 0;
                }
            }
        }
        if (classData && classData.paymentPlans && classData.paymentPlans.length) {
            classData.paymentPlans.forEach(function(cpp) {
                cpp.id = 0;
                cpp.assignedStudents = [];
                if (cpp.items && cpp.items.length) {
                    cpp.items.forEach(function(item) {
                        item.id = 0;
                    });
                }
            });
        }
        var originClassId = classData.id;
        classData.id = 0;
        classData.overrideInstructorDurationConflicts = true;
        classData.clonedFrom = originClassId;
        thiz.saveClassInfo(classData, originClassId, oldTitle, data.showAfterClone);
    }).open({clonedClassTitle: newTitle, showCloneButton: true});
};

ClassListWidget.prototype.saveClassInfo = function (classData, originClassId, oldTitle, showAfterClone) {
    var thiz = this;
    $classAdminService.saveClassInfoAsync(classData, function(jobId) {
        thiz._onJobExecuted(jobId, function (results) {
            var classInfo = results.CLASS_INFO;
            if (classInfo) {
                thiz.performCloneClassPostProcessing(classInfo, originClassId, function() {
                    SnackBar.show("[" + oldTitle + "] cloned to new class [" + classInfo.title + "]");
                    thiz.dataView.refreshDataList();
                    Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
                    if (showAfterClone) thiz.openEditClassModal({ids: [classInfo.id], from: "ClassList"});
                })
            } else {                
                Dialog.error(results.ERROR_MESSAGE || "There was an error when cloning this class.");
            }
        }, function (err) {
            Dialog.error("There was an error when cloning this class.");
        }, "Loading...");
    }, function(err) {
        Dialog.error("There was an error when cloning this class.");
    });
};

ClassListWidget.prototype.performCloneClassPostProcessing = function(newClassData, originClassId, callback) {
    if (LOGIN_INFO && LOGIN_INFO.allowDressCode) {
        widget.__ensureNamespaceLoaded("discountdance", function(namespace) {
            namespace.util.cloneClassDressCode(originClassId, newClassData.id, function() {
                if (callback) callback();
            }, "Loading...");
        })
        return;
    }
    if (callback) callback();
}

ClassListWidget.prototype._onJobExecuted = function(jobId, onSuccess, onError, executingMessage) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var busyIndicator = new Spinner(executingMessage);
    busyIndicator.busy();
    
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                        busyIndicator.done();
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        busyIndicator.done();
                        onError({errorMessage: job.errorMessage});
                    }
                } else {
                    busyIndicator.done();
                    onFailed({errorMessage: "Job not found."});
                }
            }, function (error) {
                busyIndicator.done();
                onFailed(error);
            });
        }, 1000);
    })();
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassMultiEditDialog.js";

function ClassMultiEditDialog() {
    //this.grabHeight = true;
    Dialog.call(this);
    var thiz = this;

    // this.statusCombo.renderer = function(item, selected) {
    //     if(!item) return "--Not Change--";
    //     return "" + item.name;
    // };

    this.subProgramCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.title;
    };
    this.curriculumCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.sessionCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.lessonLocCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.lessonZoneCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.insuranceCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.emergencyCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.isAllowDisplayHomepage.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.allowWaitListCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.allowMakeupCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.callToActionCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.feePerFamilyChartOfAccount.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.feePerStudentChartOfAccount.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.feePerParticipantChartOfAccount.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.prorateClassFeeCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.classFeeMonthlyCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.resetMakeupMonthlyCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.timeZoneCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.fullName;
    };

    this.chargeCCProcessingFee.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.chargeCCProcessingFeeCoa.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.feePerTransaction.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.percentagePerTransaction.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.gendersSelectBox.getConfigs = function() {
        return {
            mode: SelectBox.MODE_DROPDOWN,
            multipleSelect: true,
            useExplicitSelectLinks: false,
            optionSelectAll: false,
            noneSelectionText: "--Not Change--"
        };
    };
    this.gendersSelectBox.parseData = function(data) {
        return {
            value: data.type,
            text: data.displayName
        };
    };
    this.gendersSelectBox.setup();
 
    this.showAvailabelRegSlotsCombo.renderer = function(item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };


    this.bind("p:ItemSelected", this.allowMakeupComboChangeHandler, this.allowMakeupCombo.node());
    this.bind("p:ItemSelected", this.callToActionComboChangeHandler, this.callToActionCombo.node());
    this.bind("p:ItemSelected", this.classFeeMonthlyComboChangeHandler, this.classFeeMonthlyCombo);

    this.bind("change", this.unlimitedChangeHandler, this.unlimited);
    this.bind("change", this.allowRegisterCallChangeHandler, this.allowRegisterCall);
    this.bind("change", this.limitGenderChangeHandler, this.removeGendersButton);
    this.bind("p:SelectionChanged", this.limitGenderChangeHandler, this.gendersSelectBox.node());
    
    this.bind("p:ItemSelected", function() {
        var item = thiz.chargeCCProcessingFee.getSelectedItem();
        if (item == null || (item && item.id == 1)) {
            thiz.showProcessingInfo();
        } else {
            thiz.hideProcessingInfo();
        }
    }, this.chargeCCProcessingFee);

    this.bind("p:ItemSelected", function() {
        var item = thiz.feePerTransaction.getSelectedItem();
        if (item == null || (item && item.id == 1)) {
            thiz.feePerTransactionFee.removeAttribute("disabled");
        } else {
            thiz.feePerTransactionFee.setAttribute("disabled", "disabled");
        }
    }, this.feePerTransaction);
    this.bind("p:ItemSelected", function() {
        var item = thiz.percentagePerTransaction.getSelectedItem();
        if (item == null || (item && item.id == 1)) {
            thiz.percentagePerTransactionFee.removeAttribute("disabled");
        } else {
            thiz.percentagePerTransactionFee.setAttribute("disabled", "disabled");
        }
    }, this.percentagePerTransaction);
    
    var currencyIcon = "currency-" + Util.getCurrencyCode().toLowerCase();
    
    Dom.removeClass(this.feePerTransactionCurrencyIcon, "currency-usd");
    Dom.removeClass(this.feePerFamilyCurrencyIcon, "currency-usd");
    Dom.removeClass(this.feePerFamilyChartOfAccountCurrencyIcon, "currency-usd");
    Dom.removeClass(this.feePerParticipantCurrencyIcon, "currency-usd");
    
    Dom.addClass(this.feePerTransactionCurrencyIcon, currencyIcon);
    Dom.addClass(this.feePerFamilyCurrencyIcon, currencyIcon);
    Dom.addClass(this.feePerFamilyChartOfAccountCurrencyIcon, currencyIcon);
    Dom.addClass(this.feePerParticipantCurrencyIcon, currencyIcon);
}

__extend(Dialog, ClassMultiEditDialog);

ClassMultiEditDialog.prototype.limitGenderChangeHandler = function() {
    this.gendersSelectBox.setEnabled(!this.removeGendersButton.checked);
    var selectedGenders = this.gendersSelectBox.getSelectedData() || [];
    Dom.toggleClass(this.removeGendersButton.parentNode, "Active", selectedGenders.length == 0);
}

ClassMultiEditDialog.prototype.setup = function(options) {
    var thiz = this;
    this.classList = options.selectedItems;
    this.ccFeeLabelHeadline.innerHTML = String.format("Processing {0}", TEAM_INFO.electronicProcessingFeeLabel);
    this.ccFeeLabelCombo.innerHTML = String.format("Charge Processing {0}:", TEAM_INFO.electronicProcessingFeeLabel);
    this.setDatePickerMinDate();
    this.title = "Multi-Edit Basic Info";
    this.classIds = [];
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        Dom.addClass(this.containerWrapper, "PaymentPlanEnabled");
    } else {
        Dom.removeClass(this.containerWrapper, "PaymentPlanEnabled");
    }
    Dom.toggleClass(this.containerWrapper, "AllowCheck", window.LOGIN_INFO && window.LOGIN_INFO.allowCheck ? true : false);
    if(!options) return;
    var classTitles = [];
    for(var i = 0; i < options.selectedItems.length; i ++) {
        classTitles.push(options.selectedItems[i].title + " (ID: " + options.selectedItems[i].id + ")");
        this.classIds.push(options.selectedItems[i].id);
    }
    
    console.log("ClassMultiEditDialog: ", options.selectedItems);

    this.editAcountInfoTitle.innerHTML = classTitles.join(", ");
    //this.renderCombo(this.statusCombo, [{id: 1, name: "ON"}, {id: 0, name: "OFF - Disabled"}]);
    this.renderCombo(this.insuranceCombo, [{id: 0, name: "Optional"}, {id: 1, name: "Required"}, {id: 2, name: "Hidden"}]);
    this.renderCombo(this.emergencyCombo, [{id: 0, name: "Optional"}, {id: 1, name: "Required"}, {id: 2, name: "Hidden"}]);
    this.renderCombo(this.isAllowDisplayHomepage, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.allowWaitListCombo, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.allowMakeupCombo, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.callToActionCombo, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.prorateClassFeeCombo, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.classFeeMonthlyCombo, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.resetMakeupMonthlyCombo, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.chargeCCProcessingFee, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.feePerTransaction, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.percentagePerTransaction, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.renderCombo(this.showAvailabelRegSlotsCombo, [{id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.limitGenderChangeHandler();
    $classAdminService.getClassConfiguration(function(res) {
        thiz.filters = res;
        thiz.renderClassMultiEditDialog(thiz.filters);

        var timeZoneIds = res.timeZones,
            localTimeZoneId = moment.tz.guess();

        if(!timeZoneIds) timeZoneIds = [];
        if(timeZoneIds.indexOf(localTimeZoneId) == -1) {
            timeZoneIds.push(localTimeZoneId);
        }

        var zones = [null];
        for(var i = 0; i < timeZoneIds.length; i ++) {
            var momentZone = moment.tz(timeZoneIds[i]);
            zones.push({
                id: timeZoneIds[i],
                fullName: timeZoneIds[i] + " (GMT" + momentZone.format("Z") + ")"
            });
        }

        for(var i = 0; i < options.selectedItems.length; i ++) {
            var timeZoneId = options.selectedItems[i].timeZone;
            if(timeZoneId && timeZoneIds.indexOf(timeZoneId) < 0) {
                timeZoneIds.push(timeZoneId);
                var momentZone = moment.tz(timeZoneId);
                zones.push({
                    id: timeZoneId,
                    fullName: timeZoneId + " (GMT" + momentZone.format("Z") + ")"
                });
            }
        }
	thiz.gendersSelectBox.setItems(ClassUtils.getGenders(thiz.filters.limitGenders));
        thiz.timeZoneCombo.setItems(zones);

    }, function(err) {});
    
};

ClassMultiEditDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.saveButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

ClassMultiEditDialog.prototype.renderClassMultiEditDialog = function (filters) {
    this.renderCombo(this.subProgramCombo, filters.subPrograms);
    this.renderCombo(this.curriculumCombo, filters.curriculums);
    this.renderCombo(this.sessionCombo, filters.sessions);
    this.renderCombo(this.lessonLocCombo, filters.lessonLocs);
    this.renderCombo(this.lessonZoneCombo, filters.lessonZones);

    var lessonCoas = filters.lessonCoas;
    if(!lessonCoas) lessonCoas = [];
    lessonCoas.unshift(null);
    this.feePerFamilyChartOfAccount.setItems(lessonCoas);
    this.feePerStudentChartOfAccount.setItems(lessonCoas);
    this.feePerParticipantChartOfAccount.setItems(lessonCoas);
    this.chargeCCProcessingFeeCoa.setItems(lessonCoas);
    this.primaryBillingDateText.innerHTML = moment().date(filters.primaryBillingDateDay || 1).locale(window.LOCALE.language || "en-US").format("Do");

    if (!filters.waitlistabilityNoteVisible) Dom.hide(this.waitlistNote);
    var thiz = this;
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        ClientPropertyUtil.invalidateElements(thiz.dialogBody, cm.ModuleData.__propertySpec);
        if (TEAM_INFO.isAffiliateTeam && cm.ModuleData.__propertySpec["emergencyFields"]) {
            thiz.emergencyCombo.selectItemByKey("id", filters.emergencyOptions || 0);
        }
    });
};

ClassMultiEditDialog.prototype.renderCombo = function (combo, items) {
    var list = items;
    if(!list) list = [];
    list.unshift(null);
    combo.setItems(list);
};

ClassMultiEditDialog.prototype.saveButtonClickHandler = function () {
    if (!this.validateFormData()) return;
    var classData = this.getClassData();
    if (!classData) return;

    $classAdminService.saveMultiLessonClassInfo(
        this.classIds,
        classData,
        (res) => this.close(true),
        (err) => Dialog.error(err.message || err)
    );
};

ClassMultiEditDialog.prototype.cancelButtonClickHandler = function () {
    this.close();
};
ClassMultiEditDialog.prototype.getClassData = function () {
    var data = {},
    hasInputValue = false;
    data.title = this.classTitle.value.trim();
    if(data.title && data.title.length > 0) hasInputValue = true;

    data.status = -1;
    // if(this.statusCombo.getSelectedItem()) {
    //     data.status = this.statusCombo.getSelectedItem().id;
    //     hasInputValue = true;
    // }

    data.subProgId = -1;
    if(this.subProgramCombo.getSelectedItem()) {
        data.subProgId = this.subProgramCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.currId = -1;
    if(this.curriculumCombo.getSelectedItem()) {
        data.currId = this.curriculumCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.sessionId = -1;
    if(this.sessionCombo.getSelectedItem()) {
        data.sessionId = this.sessionCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.lessonLocId = -1;
    if(this.lessonLocCombo.getSelectedItem()) {
        data.lessonLocId = this.lessonLocCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.pzoneId = -1;
    if(this.lessonZoneCombo.getSelectedItem()) {
        data.pzoneId = this.lessonZoneCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.isInsuranceRequired = -1;
    if(this.insuranceCombo.getSelectedItem()) {
        data.isInsuranceRequired = this.insuranceCombo.getSelectedItem().id;
        hasInputValue = true;
    }
    
    data.isEmergencyRequired = -1;
    if(this.emergencyCombo.getSelectedItem()) {
        data.isEmergencyRequired = this.emergencyCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.isWaitlist = -1;
    if(this.isAllowDisplayHomepage.getSelectedItem()) {
        data.isAllowDisplayHomepage = this.isAllowDisplayHomepage.getSelectedItem().id;
        hasInputValue = true;
    }

    data.isWaitlist = -1;
    if(this.allowWaitListCombo.getSelectedItem()) {
        data.isWaitlist = this.allowWaitListCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.ageUnit = -1;
    data.ageLow = -1;
    var ageLowInMonth = this.getStudentAgeLimitValueInMonth("low", false);
    if (ageLowInMonth != null) {
        data.ageLow = ageLowInMonth;
        data.ageUnit = 1;
        hasInputValue = true;
    }

    data.ageHi = -1;
    var ageHiInMonth = this.getStudentAgeLimitValueInMonth("high", false);
    if (ageHiInMonth != null) {
        data.ageHi = ageHiInMonth;
        data.ageUnit = 1;
        hasInputValue = true;
    }

    data.dateAgeUp = this.dateAgeUp.getDate();
    if(data.dateAgeUp) hasInputValue = true;

    data.makeups = -1;
    if(this.allowMakeupCombo.getSelectedItem()) {
        data.makeups = this.makeups.value;
        hasInputValue = true;
    }

    if (this.removeGendersButton.checked) {
        data.isAllowAllGendersSelected = true;
        hasInputValue = true;
    } else {
        var selectedGenders = this.gendersSelectBox.getSelectedData();
        if (selectedGenders && selectedGenders.length > 0) {
            var genders = [];
            selectedGenders.forEach(function(gd) {
                genders.push(gd.type);
            });
            data.allowedGenders = genders;
            data.isAllowAllGendersSelected = false;
            hasInputValue = true;
        }
    }

    data.isShowedAvailableRegSlots = -1;
    if(this.showAvailabelRegSlotsCombo.getSelectedItem()) {
        data.isShowedAvailableRegSlots = this.showAvailabelRegSlotsCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.allowRegisterCall = -1;
    data.registerCallText = null;
    data.registerCallBgcolor = null;
    if(this.callToActionCombo.getSelectedItem()) {
        data.allowRegisterCall = this.callToActionCombo.getSelectedItem().id;
        hasInputValue = true;
        data.registerCallText = "";
        data.registerCallBgcolor = "";
        if(data.allowRegisterCall > 0) {
            data.registerCallText = this.registerCallText.value;
            data.registerCallBgcolor = this.registerCallBgcolor.getRGBColorString().replace("#", "");
        }
    }

    data.description = this.description.value.trim();
    if(data.description && data.description.length > 0) hasInputValue = true;

    data.duration = -1;
    if(this.classLength.value && this.classLength.value.length > 0) {
        data.duration = this.classLength.value;
        hasInputValue = true;
    }
    var selectedTimezoneId = this.timeZoneCombo.getSelectedItem() ? this.timeZoneCombo.getSelectedItem().id : TimezoneProviders.server.getTimezoneId();
    if (this.timeZoneCombo.getSelectedItem()) {
        data.timezoneId = selectedTimezoneId;
        hasInputValue = true;
    }
    var classStartDate = this.classStartDate.getDate();
    if(classStartDate && this.setDateValueToData(data, "dateStart", classStartDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var classEndDate = this.classEndDate.getDate();
    if(classEndDate && this.setDateValueToData(data, "dateEnd", classEndDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var displayStartingDate = this.displayStarting.getDate();
    if(displayStartingDate && this.setDateValueToData(data, "date4See", displayStartingDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var registrationStartDate = this.registrationStartDate.getDate();
    if(registrationStartDate && this.setDateValueToData(data, "date4Register", registrationStartDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var registrationEndDate = this.registrationEndDate.getDate();
    if(registrationEndDate && this.setDateValueToData(data, "date4RegisterEnd", registrationEndDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var forReturningMembersStartDate = this.forReturningMembersStartDate.getDate();
    if(forReturningMembersStartDate && this.setDateValueToData(data, "date4Return", forReturningMembersStartDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var forReturningMembersEndDate = this.forReturningMembersEndDate.getDate();
    if(forReturningMembersEndDate && this.setDateValueToData(data, "date4ReturnEnd", forReturningMembersEndDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var forNewMembersStartDate = this.forNewMembersStartDate.getDate();
    if(forNewMembersStartDate && this.setDateValueToData(data, "date4New", forNewMembersStartDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }
    var forNewMembersEndDate = this.forNewMembersEndDate.getDate();
    if(forNewMembersEndDate && this.setDateValueToData(data, "date4NewEnd", forNewMembersEndDate, selectedTimezoneId) != null) {
        hasInputValue = true;
    }

    data.familyRegFee = -1;
    if(this.feePerFamily.value && this.feePerFamily.value.length > 0) {
        data.familyRegFee = this.feePerFamily.value;
        hasInputValue = true;
    }

    data.familyRegCoaId = -1;
    if(this.feePerFamilyChartOfAccount.getSelectedItem()) {
        data.familyRegCoaId = this.feePerFamilyChartOfAccount.getSelectedItem().id;
        hasInputValue = true;
    }

    data.studentRegFee = -1;
    if(this.feePerStudent.value && this.feePerStudent.value.length > 0) {
        data.studentRegFee = this.feePerStudent.value;
        hasInputValue = true;
    }

    data.studentRegCoaId = -1;
    if(this.feePerStudentChartOfAccount.getSelectedItem()) {
        data.studentRegCoaId = this.feePerStudentChartOfAccount.getSelectedItem().id;
        hasInputValue = true;
    }

    data.feeClassAmount = -1;
    if(this.feePerParticipant.value && this.feePerParticipant.value.length > 0) {
        data.feeClassAmount = this.feePerParticipant.value;
        hasInputValue = true;
    }

    data.feeClassCoaId = -1;
    if(this.feePerParticipantChartOfAccount.getSelectedItem()) {
        data.feeClassCoaId = this.feePerParticipantChartOfAccount.getSelectedItem().id;
        hasInputValue = true;
    }

    data.isProrate = -1;
    if(this.prorateClassFeeCombo.getSelectedItem()) {
        data.isProrate = this.prorateClassFeeCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.isChargeMonthly = -1;
    if(this.classFeeMonthlyCombo.getSelectedItem()) {
        data.isChargeMonthly = this.classFeeMonthlyCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.resetMakeupMonthly = -1;
    if(this.resetMakeupMonthlyCombo.getSelectedItem()) {
        data.resetMakeupMonthly = this.resetMakeupMonthlyCombo.getSelectedItem().id;
        hasInputValue = true;
    }

    data.enableCCProcessingFee = -1;
    if(this.chargeCCProcessingFee.getSelectedItem()) {
        data.enableCCProcessingFee = this.chargeCCProcessingFee.getSelectedItem().id;
        hasInputValue = true;
    }

    data.ccProcessingFeeCoaId = -1;
    if(this.chargeCCProcessingFeeCoa.getSelectedItem()) {
        data.ccProcessingFeeCoaId = this.chargeCCProcessingFeeCoa.getSelectedItem().id;
        hasInputValue = true;
    }

    data.enableCCProcessingFlatFeePerTrans = -1;
    if(this.feePerTransaction.getSelectedItem()) {
        data.enableCCProcessingFlatFeePerTrans = this.feePerTransaction.getSelectedItem().id;
        hasInputValue = true;
    }

    data.ccProcessingFlatFeePerTrans = -1;
    if(this.feePerTransactionFee.value && this.feePerTransactionFee.value.length > 0) {
        data.ccProcessingFlatFeePerTrans = this.feePerTransactionFee.value;
        hasInputValue = true;
    }
    if (data.enableCCProcessingFlatFeePerTrans == 0) data.ccProcessingFlatFeePerTrans = 0;

    data.enableCCProcessingPercentagePerTrans = -1;
    if(this.percentagePerTransaction.getSelectedItem()) {
        data.enableCCProcessingPercentagePerTrans = this.percentagePerTransaction.getSelectedItem().id;
        hasInputValue = true;
    }

    data.ccProcessingPercentagePerTrans = -1;
    if(this.percentagePerTransactionFee.value && this.percentagePerTransactionFee.value.length > 0) {
        data.ccProcessingPercentagePerTrans = this.percentagePerTransactionFee.value;
        hasInputValue = true;
    }
    if (data.enableCCProcessingPercentagePerTrans == 0) data.ccProcessingPercentagePerTrans = 0;

    if(!hasInputValue) {
        this.showErrorMessage("Please input the data to edit.", null);
        return null;
    }
    return data;
};

ClassMultiEditDialog.prototype.getStudentAgeLimitValueInMonth = function (limitValueType, zeroIfBlank) {
    var isLowInput = limitValueType == "low";
    var yearInput = isLowInput ? this.studentAgeLimitLowYear : this.studentAgeLimitHighYear;
    var monthInput = isLowInput ? this.studentAgeLimitLowMonth : this.studentAgeLimitHighMonth;
    
    if (typeof(zeroIfBlank) != "undefined" && !zeroIfBlank) {
        if (yearInput.value.length <= 0 && monthInput.value.length <= 0) return null;
    }
    
    return (parseInt(yearInput.value) || 0) * 12 + (parseInt(monthInput.value) || 0);
};

ClassMultiEditDialog.prototype.validateFormData = function () {
    var thiz = this;
    
    var isAgeLimitInputIntegerValue = function (inputNode, maxValue) {
        var value = inputNode.value;
        if (value.length > 0 && !isNaN(value)) {
            var floatValue = parseFloat(value);
            if (!Number.isInteger(floatValue)) return false;
            if (maxValue && parseInt(value) > maxValue) return false; 
        }
        return true;
    }
    
    var areYearMonthAgeLimitInputValid = function (yearInputNode, monthInputNode) {
        return isNaN(yearInputNode.valueAsNumber) && isNaN(monthInputNode.valueAsNumber)
            || Number.isInteger(yearInputNode.valueAsNumber) && Number.isInteger(monthInputNode.valueAsNumber);
    }
    
    if (!isAgeLimitInputIntegerValue(this.studentAgeLimitLowYear)) {
        this.showErrorMessage(String.format("{0} must be an integer.", "Athlete Age Limit Low Year"), this.studentAgeLimitLowYear);
        return false;
    }
    if (!isAgeLimitInputIntegerValue(this.studentAgeLimitLowMonth, 11)) {
        this.showErrorMessage(String.format("{0} must be an integer and less than or equal to 11.", "Athlete Age Limit Low Month"), this.studentAgeLimitLowMonth);
        return false;
    }
    if (!areYearMonthAgeLimitInputValid(this.studentAgeLimitLowYear, this.studentAgeLimitLowMonth)) {
        this.showErrorMessage(String.format("{0} must either remain unchanged or both be provided.", "Athlete Age Limit Low Year and Month"), this.studentAgeLimitLowYear);
        return false;
    }
    
    if (!isAgeLimitInputIntegerValue(this.studentAgeLimitHighYear)) {
        this.showErrorMessage(String.format("{0} must be an integer.", "Athlete Age Limit High Year"), this.studentAgeLimitHighYear);
        return false;
    }
    if (!isAgeLimitInputIntegerValue(this.studentAgeLimitHighMonth, 11)) {
        this.showErrorMessage(String.format("{0} must be an integer and less than or equal to 11.", "Athlete Age Limit High Month"), this.studentAgeLimitHighMonth);
        return false;
    }
    if (!areYearMonthAgeLimitInputValid(this.studentAgeLimitHighYear, this.studentAgeLimitHighMonth)) {
        this.showErrorMessage(String.format("{0} must either remain unchanged or both be provided.", "Athlete Age Limit High Year and Month"), this.studentAgeLimitHighYear);
        return false;
    }
    
    var ageLowInMonth = this.getStudentAgeLimitValueInMonth("low", false);
    var ageHiInMonth = this.getStudentAgeLimitValueInMonth("high", false);
    if (ageLowInMonth != null && ageHiInMonth != null && ageLowInMonth >= ageHiInMonth) {
        this.showErrorMessage(String.format("[{0}] must be less than [Athlete Age Limit High].", "Athlete Age Limit Low"), this.studentAgeLimitLowYear);
        return false;
    }

    if (!this.validateClassDateTimeData()) return false;

    if(this.feePerFamily && this.feePerFamily.value.length > 0) {
        if(isNaN(this.feePerFamily.value)) {
            this.showErrorMessage("Please type the correct [Per Family] format.", this.feePerFamily);
            return false;
        }
        var feePerFamily = parseInt(this.feePerFamily.value, 10);
        if(feePerFamily > 0 && !this.feePerFamilyChartOfAccount.getSelectedItem()) {
            this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.",
                "Chart of Account of Per Family"), this.feePerFamilyChartOfAccount.node());
            return false;
        }
    }
    if (!(window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan)) {
        if(this.feePerStudent && this.feePerStudent.value.length > 0) {
            if(isNaN(this.feePerStudent.value)) {
                this.showErrorMessage("Please type the correct [Per Athlete] format.", this.feePerStudent);
                return false;
            }
            var feePerStudent = parseInt(this.feePerStudent.value, 10);
            if(feePerStudent > 0 && !this.feePerStudentChartOfAccount.getSelectedItem()) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.",
                    "Chart of Account of Per Athlete"), this.feePerStudentChartOfAccount.node());
                return false;
            }
        }
        if(this.feePerParticipant && this.feePerParticipant.value.length > 0) {
            if(isNaN(this.feePerParticipant.value)) {
                this.showErrorMessage("Please type the correct [Per Participant] format.", this.feePerParticipant);
                return false;
            }
            var feePerParticipant = parseInt(this.feePerParticipant.value, 10);
            if(feePerParticipant > 0 && !this.feePerParticipantChartOfAccount.getSelectedItem()) {
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.",
                    "Chart of Account of Per Participant"), this.feePerParticipantChartOfAccount.node());
                return false;
            }
        }
        if (this.classFeeMonthlyCombo.getSelectedItem() && this.classFeeMonthlyCombo.getSelectedItem().id == 1) {
            if(!this.classStartDate.getDate()) {
                this.showErrorMessage("Monthly class MUST start on the 1st of the month", this.classStartDate);
                return false;
            }
            if(this.classStartDate.getDate().getDate() != 1) {
                this.showErrorMessage("Monthly class MUST start on the 1st of the month", this.classStartDate);
                return false;
            }
        }
        if(this.chargeCCProcessingFee.getSelectedItem() && this.chargeCCProcessingFee.getSelectedItem().id == 1) {
            if(!this.chargeCCProcessingFeeCoa.getSelectedItem()) {
                var ccFeeLabel = String.format("Chart of Account of CC Processing {0}", TEAM_INFO.electronicProcessingFeeLabel);
                this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.",
                ccFeeLabel), this.chargeCCProcessingFeeCoa.node());
                return false;
            }
        }
        if(this.feePerTransactionFee && this.feePerTransactionFee.value.length > 0) {
            if(isNaN(this.feePerTransactionFee.value)) {
                this.showErrorMessage("Please type the correct [Flat Fee Per Transaction] format.", this.feePerTransactionFee);
                return false;
            }
            if(this.feePerTransactionFee.value < 0) {
                this.showErrorMessage("[Flat Fee Per Transaction] value must be positive value.", this.feePerTransactionFee);
                return false;
            }
        }

        if(this.percentagePerTransactionFee && this.percentagePerTransactionFee.value.length > 0) {
            if(isNaN(this.percentagePerTransactionFee.value)) {
                this.showErrorMessage("Please type the correct [Percentage Per Transaction] format.", this.percentagePerTransactionFee);
                return false;
            }
            if(this.percentagePerTransactionFee.value < 0) {
                this.showErrorMessage("[Percentage Per Transaction] value must be positive value.", this.percentagePerTransactionFee);
                return false;
            }
            if(this.percentagePerTransactionFee.value > 1000) {
                this.showErrorMessage("[Percentage Per Transaction] value must be earlier than 1000.", this.percentagePerTransactionFee);
                return false;
            }
        }
    }

    return true;
};

ClassMultiEditDialog.prototype.showErrorMessage = function (message, inputToFocus) {
    var thiz = this;
    Dialog.error(message, "", function() {
        if(inputToFocus) {
            window.setTimeout(function() {
                inputToFocus.focus();
            }, 200);
        }
    });
};

ClassMultiEditDialog.prototype.allowMakeupComboChangeHandler = function () {
    if(this.allowMakeupCombo.getSelectedItem() && this.allowMakeupCombo.getSelectedItem().id > 0) {
        this.makeups.value = 0;
        this.makeups.removeAttribute("disabled");
        this.resetMakeupMonthlyCombo.setEnable(true);
    } else {
        this.makeups.value = 0;
        this.makeups.setAttribute("disabled", "disabled");
        this.resetMakeupMonthlyCombo.setEnable(false);
        this.resetMakeupMonthlyCombo.selectItem(null);
    }
};

ClassMultiEditDialog.prototype.callToActionComboChangeHandler = function () {
    if(this.callToActionCombo.getSelectedItem() && this.callToActionCombo.getSelectedItem().id > 0) {
        Dom.removeClass(this.registerCallText.parentNode, "disabled-control");
        this.registerCallText.removeAttribute("disabled");
        this.registerCallBgcolor.setEnable(true);
    } else {
        Dom.addClass(this.registerCallText.parentNode, "disabled-control");
        this.registerCallText.setAttribute("disabled", "disabled");
        this.registerCallText.value = "";
        this.registerCallBgcolor.setEnable(false);
        this.registerCallBgcolor.setColor("#FFFFFF");
    }
};

ClassMultiEditDialog.prototype.classFeeMonthlyComboChangeHandler = function () {
    if(this.classFeeMonthlyCombo.getSelectedItem() && this.classFeeMonthlyCombo.getSelectedItem().id == 1) {
        Dialog.alert("", "Monthly class MUST start on the 1st of the month", null);
        //this.resetMakeupMonthlyCombo.setEnable(true);
    } else {
        //this.resetMakeupMonthlyCombo.setEnable(false);
        //this.resetMakeupMonthlyCombo.selectItem(null);
    }
};

ClassMultiEditDialog.prototype.transformTimezone = function(date, timezone) {
    return ClassUtils.transformToTimeZone(date, timezone);
    if(!date) return null;
    if(!timezone) timezone = moment.tz.guess();
    var r = moment.tz(moment(date).format('YYYY-MM-DD HH:mm'), timezone).toDate();
    return r;
};

ClassMultiEditDialog.prototype.setDateValueToData = function(data, dataField, date, timezone) {
    data[dataField] = null;
    if(date != null) data[dataField] = this.transformTimezone(date, timezone);
    return dataField;
};

ClassMultiEditDialog.prototype.showProcessingInfo = function() {
    Dom.removeClass(this.chargeCCProcessingFeeCoaLabel, "Hidden");
    Dom.removeClass(this.chargeCCProcessingFeeCoa.node(), "Hidden");
    Dom.removeClass(this.feePerTransaction.node().parentNode, "Hidden");
    Dom.removeClass(this.percentagePerTransaction.node().parentNode, "Hidden");
};

ClassMultiEditDialog.prototype.hideProcessingInfo = function() {
    Dom.addClass(this.chargeCCProcessingFeeCoaLabel, "Hidden");
    Dom.addClass(this.chargeCCProcessingFeeCoa.node(), "Hidden");
    Dom.addClass(this.feePerTransaction.node().parentNode, "Hidden");
    Dom.addClass(this.percentagePerTransaction.node().parentNode, "Hidden");

};

ClassMultiEditDialog.prototype.setDatePickerMinDate = function () {
    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.dateAgeUp.setMinDate(minDate);
    this.classStartDate.setMinDate(minDate);
    this.classEndDate.setMinDate(minDate);
    this.displayStarting.setMinDate(minDate);
    this.registrationStartDate.setMinDate(minDate);
    this.registrationEndDate.setMinDate(minDate);
    this.forReturningMembersStartDate.setMinDate(minDate);
    this.forReturningMembersEndDate.setMinDate(minDate);
    this.forNewMembersStartDate.setMinDate(minDate);
    this.forNewMembersEndDate.setMinDate(minDate);
};

ClassMultiEditDialog.prototype.getEndOfDate = function(date) {
    var eod = new Date(date);
    eod.setHours(23, 59, 59, 00);
    return eod;
}

ClassMultiEditDialog.prototype.validateClassDateTimeData = function() {
    if ( !this.classStartDate.getDate() && !this.classEndDate.getDate() && !this.displayStarting.getDate()
        && !this.registrationStartDate.getDate() && !this.registrationEndDate.getDate() 
        && !this.forReturningMembersStartDate.getDate() && !this.forReturningMembersEndDate.getDate() 
        && !this.forNewMembersStartDate.getDate() && !this.forNewMembersEndDate.getDate() ) {
        return true;
    }
    var newDateTimeValues = {};
    newDateTimeValues.dateStart = this.classStartDate.getDate();
    newDateTimeValues.date4Register = this.registrationStartDate.getDate();
    newDateTimeValues.date4RegisterEnd = this.registrationEndDate.getDate();
    newDateTimeValues.date4Return = this.forReturningMembersStartDate.getDate();
    newDateTimeValues.date4ReturnEnd = this.forReturningMembersEndDate.getDate();
    newDateTimeValues.date4New = this.forNewMembersStartDate.getDate();
    newDateTimeValues.date4NewEnd = this.forNewMembersEndDate.getDate();
    newDateTimeValues.date4See = this.displayStarting.getDate();
    if (this.classEndDate.getDate()) newDateTimeValues.dateEnd = this.getEndOfDate(this.classEndDate.getDate().getTime());
    if (!this._validateDateTimeForClass(newDateTimeValues, newDateTimeValues)) return false;

    return true;
}

ClassMultiEditDialog.prototype.transformToTimeZone = function(date, timezoneId) {
    if (!timezoneId) return date;
    return ClassUtils.transformToTimeZone(date, timezoneId);
}

ClassMultiEditDialog.prototype.formatDate = function(date, timezoneId, withTime) {
    return FormatUtil.formatDateWithTZID(date, withTime ? "datetime_standard" : "date_standard", timezoneId);
} 

ClassMultiEditDialog.prototype._validateDateTimeForClass = function(classItem, newData) {
    var timezoneId = classItem.timezoneId;
    var message = "";
    if (classItem.dateStart) {
        var classStart = classItem.dateStart;
        if (classItem.dateEnd && classStart.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Class Start Date", "Class End Date");
            this.showErrorMessage(message, newData.dateStart ? this.classStartDate.input : this.classEndDate.input);
            return false;
        }
    }
    if (classItem.date4See) {
        var date4See = classItem.date4See;
        if (classItem.dateEnd && date4See.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Display Starting From Date", "Class End Date");
            this.showErrorMessage(message, newData.date4See ? this.displayStarting.input : this.classEndDate.input);
            return false;
        }
        if (classItem.date4Register && date4See.getTime() > classItem.date4Register.getTime()) {
            message = String.format("[{0}] must be earlier than or equal to [{1}].", "Display Starting From Date", "Open for Registration Start Date");
            this.showErrorMessage(message, newData.date4See ? this.displayStarting.input : this.registrationStartDate.input);
            return false;
        }
    }
    if (classItem.date4Register) {
        var registerStart = classItem.date4Register;
        if (classItem.dateEnd && registerStart.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for Registration Start Date", "Class End Date")
            this.showErrorMessage(message, newData.date4Register ? this.registrationStartDate.input : this.classEndDate.input);
            return false; 
        }
        if (classItem.date4RegisterEnd && registerStart.getTime() > classItem.date4RegisterEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for Registration Start Date", "Open for Registration End Date");
            this.showErrorMessage(message, newData.date4Register ? this.registrationStartDate.input : this.registrationEndDate.input);
            return false; 
        }
        if (classItem.date4Return && registerStart.getTime() > classItem.date4Return.getTime()) {
            message = String.format("[{0}] must be later than or equal to [{1}].", "Open for Return Members Start Date", "Open for Registration Start Date");
            this.showErrorMessage(message, newData.date4Return ? this.forReturningMembersStartDate.input : this.registrationStartDate.input);
            return false; 
        }
        if (classItem.date4New && registerStart.getTime() > classItem.date4New.getTime()) {
            message = String.format("[{0}] must be later than or equal to [{1}].", "Open for New Members Start Date", "Open for Registration Start Date");
            this.showErrorMessage(message,  newData.date4New ? this.forNewMembersStartDate.input : this.registrationStartDate.input);
            return false; 
        }
    }
    if (classItem.date4RegisterEnd) {
        var registerEnd = classItem.date4RegisterEnd;
        if (classItem.dateEnd && registerEnd.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for Registration End Date", "Class End Date");
            this.showErrorMessage(message, newData.date4RegisterEnd ? this.registrationEndDate.input : this.classEndDate.input);
            return false;
        }
        if (classItem.date4ReturnEnd && registerEnd.getTime() < classItem.date4ReturnEnd.getTime()) {
            message = String.format("[{0}] must be earlier than or equal to [{1}].", "Open for Return Members End Date", "Open for Registration End Date");
            this.showErrorMessage(message, newData.date4ReturnEnd ? this.forReturningMembersEndDate.input : this.registrationEndDate.input);
            return false;
        }
        if (classItem.date4NewEnd && registerEnd.getTime() < classItem.date4NewEnd.getTime()) {
            message = String.format("[{0}] must be earlier than or equal to [{1}].", "Open for New Members End Date", "Open for Registration End Date");
            this.showErrorMessage(message, newData.date4RegisterEnd ? this.registrationEndDate.input : this.forNewMembersEndDate.input);
            return false;
        }
    }
    if (classItem.date4Return) {
        var returnStart = classItem.date4Return;
        if (classItem.date4ReturnEnd && returnStart.getTime() > classItem.date4ReturnEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for Return Members Start Date", "Open for Return Members End Date");
            this.showErrorMessage(message, newData.date4Return ? this.forReturningMembersStartDate.input : this.forReturningMembersEndDate.input);
            return false; 
        }
        if (classItem.dateEnd && returnStart.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for Return Members Start Date", "Class End Date");
            this.showErrorMessage(message, newData.date4Return ? this.forReturningMembersStartDate.input : this.classEndDate.input);
            return false; 
        }
    }
    if (classItem.date4ReturnEnd) {
        var returnEnd = classItem.date4ReturnEnd;
        if (classItem.dateEnd && returnEnd.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for Return Members End Date", "Class End Date");
            this.showErrorMessage(message, newData.date4ReturnEnd ? this.forReturningMembersEndDate.input : this.classEndDate.input);
            return false; 
        }
    }
    if (classItem.date4New) {
        var newStart = classItem.date4New;
        if (classItem.date4NewEnd && newStart.getTime() > classItem.date4NewEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for New Members Start Date", "Open for New Members End Date");
            this.showErrorMessage(message, newData.date4New ? this.forNewMembersStartDate.input : this.forNewMembersEndDate.input);
            return false; 
        }
        if (classItem.dateEnd && newStart.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for New Members Start Date", "Class End Date");
            this.showErrorMessage(message, newData.date4New ? this.forNewMembersStartDate.input : this.classEndDate.input);
            return false; 
        }
    }
    if (classItem.date4NewEnd) {
        var newEnd = classItem.date4NewEnd;
        if (classItem.dateEnd && newEnd.getTime() > classItem.dateEnd.getTime()) {
            message = String.format("[{0}] must be earlier than [{1}].", "Open for New Members End Date", "Class End Date");
            this.showErrorMessage(message, newData.date4NewEnd ? this.NewMembersEndDate.input : this.classEndDate.input);
            return false; 
        }
    }

    return true;
}

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassMultiEditQuestionDialog.js";

function ClassMultiEditQuestionDialog() {
    Dialog.call(this);
    this.grabHeight = true;
    
    this.bind("click", this.invalidateQuestionOptionInfoElements.bind(this), this.useSubProgQuestionRadio);
    this.bind("click", this.invalidateQuestionOptionInfoElements.bind(this), this.useClassCustomQuestionRadio);
}

__extend(Dialog, ClassMultiEditQuestionDialog);

ClassMultiEditQuestionDialog.prototype.asyncSetup = function(options, callback) {
    var thiz = this;
    this.classIdIndex = 0;
    this.options = options;
    this.title = "Multi-Edit Class Questions";
    if(!options) return;
    this.classIds = options.ids;
    var classTitles = [];
    for(var i = 0; i < options.classes.length; i ++) {
        classTitles.push(options.classes[i].title + " (ID: " + options.classes[i].id + ")");
    }
    this.editClassInfoTitle.innerHTML = classTitles.join(", ");
    this.initQuestionSettingViews(() => {
        this.invalidateQuestionOptionInfoElements();
        callback();
    });
};

ClassMultiEditQuestionDialog.prototype.invalidateQuestionOptionInfoElements = function() {
    this.classQuestionSettingView.setEnabled(this.useClassCustomQuestionRadio.checked);
    if (this.useSubProgQuestionRadio._cvValidationResult) this.useSubProgQuestionRadio._cvValidationResult.valid = true;
};

ClassMultiEditQuestionDialog.prototype.initQuestionSettingViews = function(callback) {
    var thiz = this;
    this.classQuestionSettingWrapper.innerHTML = "";
    widget.__ensureNamespaceLoaded("customquestion", (cqPkg) => {
        
        var initClassQuestionSettingView = new Promise(function(resolve, reject) {
            thiz.classQuestionSettingView = new cqPkg.QuestionApplicationSettingView({
                "application-type": cqPkg.ModuleData.QUESTION_APPLICATION_TYPE.CLASS.type
            }).into(thiz.classQuestionSettingWrapper);
            thiz.classQuestionSettingView.initWith(0, () => resolve());
        });
        
        Promise.all([initClassQuestionSettingView]).then(function () {
            callback && callback();
        });
    });
};

ClassMultiEditQuestionDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [{
            type: "accept", title: "Save",
            run: function () {
                thiz.saveMultiClassQuestions();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
};

ClassMultiEditQuestionDialog.prototype.getValidationRules = function () {
    var thiz = this;
    var rs = new RuleSet().live(true)
        .custom(new GenericRule(this.useSubProgQuestionRadio,
            function() {
                return thiz.useSubProgQuestionRadio.checked || thiz.useClassCustomQuestionRadio.checked;
            },
            function () {
                return "Please select a question use option";
            }));
    return rs;
};
ClassMultiEditQuestionDialog.prototype.saveMultiClassQuestions = function() {
    if(!ValidationManager.run(this.getValidationRules())) return false;
    
    var thiz = this;
    Dialog.confirm("This will update question setting for selected classes. Are you sure you want to proceed?", "", "Yes, update", function() {
        thiz.handleSavingMultiClassQuestions();
    }, "Cancel");
};

ClassMultiEditQuestionDialog.prototype.handleSavingMultiClassQuestions = function() {
    var overrideSubProgQuestions = this.useClassCustomQuestionRadio.checked;
    var multiClassQuestionInfo = {
        classIds: this.classIds,
        overrideSubProgQuestions: overrideSubProgQuestions,
        questionIds: overrideSubProgQuestions ? this.classQuestionSettingView.getSelectedQuestionIds() : null
    };
    
    var thiz = this;
    var busyIndicator = new Spinner("Saving...");
    busyIndicator.busy();
    
    $classAdminService.saveMultiClassQuestions(multiClassQuestionInfo, function (jobId) {
        thiz._onJobExecuted(jobId, function (data) {
            thiz.close("saved");
            busyIndicator.done();
        }, function (error) {
            busyIndicator.done();
            Dialog.error(error.message || "Error when saving class questions");
        })
    }, (error) => {
        busyIndicator.done();
        Dialog.error(error.message);
    });
};

ClassMultiEditQuestionDialog.prototype._onJobExecuted = function(jobId, onSuccess, onError) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var firstTime = true;

    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                firstTime = false;
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        onError({message: job.errorMessage});
                    }
                } else {
                    onError({message: "Job not found."});
                }
            }, function (error) {
                onError(error);
            });
        }, firstTime ? 150 : 500);
    })();
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassMultiEditRegSlotDialog.js";

function ClassMultiEditRegSlotDialog() {
    this.grabHeight = true;
    Dialog.call(this);

    this.bind("click", this.saveButtonClickHandler, this.saveButton);
    this.bind("click", this.cancelButtonClickHandler, this.cancelButton);

    this.weekdayName = {
        Mon: "Monday",
        Tue: "Tuesday",
        Wed: "Wednesday",
        Thu: "Thursday",
        Fri: "Friday",
        Sat: "Saturday",
        Sun: "Sunday"
    };

}

__extend(Dialog, ClassMultiEditRegSlotDialog);

ClassMultiEditRegSlotDialog.prototype.setup = function(options) {
    var thiz = this;
    this.classIdIndex = 0;
    this.options = options;
    this.title = "Multi-Overwrite Reg Slots";
    if(!options) return;
    var classTitles = [];
    for(var i = 0; i < options.memberClasses.length; i ++) {
        classTitles.push(options.memberClasses[i].title + " (ID: " + options.memberClasses[i].id + ")");
    }
    this.editClassInfoTitle.innerHTML = classTitles.join(", ");
    $classAdminService.getLessonInstructor(function(res) {
        var options = {
            filters: {
                instructors: res
            },
            isEditRegSlotDialog: true
        };
        thiz.classEditRegSlot = new ClassEditRegSlotTab(options).into(thiz.contentPane);
    }, function (err) {});

};

ClassMultiEditRegSlotDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [{
            type: "accept", title: "Save",
            order: 3,
            run: function () {
                thiz.saveButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            order: 1,
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
};

ClassMultiEditRegSlotDialog.prototype.saveButtonClickHandler = function () {
    var thiz = this;
    var classData = {};
    this.classEditRegSlot.updateClassData(classData);
    var slots = [];
    var hasError = false, errorMessage = "";
    for(var i = 0; i < classData.slots.length; i ++) {
        if(hasError) break;
        var slot = classData.slots[i],
            hasCorrectValue = false,
            schedByWeekdayName = {};
            
            if (slot.slot < 0) {
                hasError = true;
                errorMessage = String.format("Invalid slot number. Please check your slots info and try to save again.");
                break;
            }
            
        for(var key in slot.schedByWeekdayName) {
            var hasInstructors = false;
            if(slot.schedByWeekdayName[key].instructors.length > 0) {
                hasInstructors = true;
                schedByWeekdayName[key] = {
                    instructors: slot.schedByWeekdayName[key].instructors
                };
            }
            if(slot.schedByWeekdayName[key].startTime.length > 0) {
                var startTime = slot.schedByWeekdayName[key].startTime.trim();
                if(startTime.length != 8) {
                    hasError = true;
                    errorMessage = String.format("Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots (#{0}) and try to save again.", slot.slotOrder);
                    break;
                } else {
                    if(startTime.indexOf(":") != 2) {
                        hasError = true;
                        errorMessage = String.format("Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots (#{0}) and try to save again.", slot.slotOrder);
                        break;
                    }
                    var hour = parseInt(startTime.substring(0, 2), 10);
                        minute = parseInt(startTime.substring(3, 5), 10);
                    if(isNaN(hour) || isNaN(minute) || hour < 0 || hour > 12 || minute < 0 || minute > 59) {
                        hasError = true;
                        errorMessage = String.format("Invalid slot time Format for slot times needs to be hh:mm. Please check your time slots (#{0}) and try to save again.", slot.slotOrder);
                        break;
                    }
                }
                hasCorrectValue = true;
                schedByWeekdayName[key] = slot.schedByWeekdayName[key];
            } else if (hasInstructors) {
                hasError = true;
                errorMessage = String.format("[Slot Time] is required for [Slot #{0}] on [{1}]", slot.slotOrder, this.weekdayName[key]);
                break;
            }
        }
        if(hasError) break;
        if(slot.maxLimit.length == 0) slot.maxLimit = 0;
        if(hasCorrectValue && (isNaN(slot.maxLimit) || slot.maxLimit < 0)) {
            hasError = true;
            errorMessage = String.format("[Slot Limit] is required for [Slot #{0}]", slot.slotOrder);
            break;
        }
        if(hasCorrectValue) {
            slot.schedByWeekdayName = schedByWeekdayName;
            slots.push(slot);
        }
    }

    if(hasError && errorMessage.length > 0) {
        Dialog.error(errorMessage, "", null);
        return;
    }
    classData.slots = slots;
    Dialog.confirm("This will overwrite all selected classes slot structure. Are you sure you want to proceed?", "", "Ok", function() {
        thiz.close(classData);        
    }, "Cancel");
};

ClassMultiEditRegSlotDialog.prototype.cancelButtonClickHandler = function () {
    this.close();
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassRecurringChargeDialog.js";

function ClassRecurringChargeDialog() {
    ModificationWatchDialog.call(this);

    this._frequencyViewWidgetMap = {};

    this.coaSelection.parseData = function(data, index) {
        return {
            value: data.id,
            text: data.name,
            checked: index == 0
        };
    }
    this.chargeFrequencySelection.parseData = function(data, index) {
        return {
            value: data.key,
            text: data.value,
            checked: index == 0
        };
    }
    this.bind("p:SelectionChanged", function(event) {
        var frequency = this.chargeFrequencySelection.getSelectedData();
        if (!frequency || frequency.length < 1) return;

        frequency = frequency[0];
        this.showFrequency(frequency);
        this.invalidateSizing();
    }, this.chargeFrequencySelection);

    var thiz = this;
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.chargeNameInput, "Required field")
        .custom(new GenericRule(this.chargeAmountInput, function(input) {
            var chargeAmount = null;
            try {
                chargeAmount = parseFloat(thiz.chargeAmountInput.value);
            } catch (e) {
                SnackBar.show(e);
                return false;
            }

            return isNaN(chargeAmount) ? false : true;
        }, "Required field"), null);
}
__extend(ModificationWatchDialog, ClassRecurringChargeDialog);

ClassRecurringChargeDialog.prototype.asyncSetup = function(options, callback) {
    var data = (typeof options == "object") ? options : {};
    if (data.id) {
        this.title = "Update Recurring Class Charge";
    } else {
        this.title = "New Recurring Class Charge";
    }
    this.model = data;
    this.config = data.config;

    var initFn = function() {
        this._init();
        if (typeof callback == "function") {
            callback.call(this);
        }
    };
    if (!this.config) {
        $billingService.getScheduledChargeConfig(function(config) {
            this.config = config;
            initFn.call(this);
        }.bind(this), function(error) {
            SnackBar.show("Failed to load configuration");
        }, new Spinner("Loading..."));
    } else {
        initFn.call(this);
    }
}

ClassRecurringChargeDialog.prototype._init = function() {
    this.coaSelection.setItems(this.config.chargeCategories.filter(function(item) { return item != null; }));

    var acceptedItems = [];
    var that = this;
    this.config.cycleTimeUnits.forEach(function(unit) {
        if (!that.model.acceptedFrequencyTypes || that.model.acceptedFrequencyTypes.indexOf(unit.key) != -1) {
            acceptedItems.push(unit);
        }
    });
    if (acceptedItems.length < 1) {
        SnackBar.show("There\'s no supported frequency");
        this.close();
        return;
    }
    this.chargeFrequencySelection.setItems(acceptedItems);

    if (this.model.id) {
        $billingService.getScheduledChargeById(this.model.id, function(model) {
            this.render(model);
        }.bind(this), function(error) {
            SnackBar.show("Failed to get scheduled charge." + " Error: ", error);
        });
    } else {
        this.render();
    }
}

ClassRecurringChargeDialog.prototype.render = function(model) {
    var mergeModel = model || {};
    mergeModel.classId = this.model.classId;
    this.model = mergeModel;

    var selectedCoAValue, selectedChargeFrequencyValue;
    if (this.model.id) {
        this.chargeNameInput.value = this.model.name;
        selectedCoAValue = this.model.coaId;
        this.chargeAmountInput.value = this.model.amount;
        selectedChargeFrequencyValue = this.model.chargeFrequency;
    } else {
        if (this.config.chargeCategories && this.config.chargeCategories.length > 0) {
            selectedCoAValue = this.config.chargeCategories[0].id;
        }
        if (this.config.cycleTimeUnits && this.config.cycleTimeUnits.length > 0) {
            selectedChargeFrequencyValue = this.config.cycleTimeUnits[0].key;
        }
    }

    var renderedFrequencyItems = this.chargeFrequencySelection.data;
    var frequency = renderedFrequencyItems[0];
    for (var i in renderedFrequencyItems) {
        if (renderedFrequencyItems[i].key == selectedChargeFrequencyValue) {
            frequency = renderedFrequencyItems[i];
            break;
        }
    }
    if (frequency) {
        this.chargeFrequencySelection.setValueSelected(frequency.key, true);
        this.showFrequency(frequency);
    }
    this.coaSelection.setValueSelected(selectedCoAValue, true);

    this.invalidateSizing();
    this.setSnapshotInputValues(this.getCurrentInputValues());
};

ClassRecurringChargeDialog.prototype.showFrequency = function (frequency) {
    if (!frequency || (typeof frequency != "object")) return;

    // reset all view widgets
    for (var k in this._frequencyViewWidgetMap) {
        if (!this._frequencyViewWidgetMap.hasOwnProperty(k)) continue;
        Dom.addClass(this._frequencyViewWidgetMap[k].node(), "Hidden");
    }

    // get or create the requested view
    var widget = this._frequencyViewWidgetMap[frequency.key];
    if (!widget) {
        if (frequency.key == 10) widget = new RecurringChargeMonthlyFrequencyView();
        else if (frequency.key == 30) widget = new RecurringChargeAnnuallyFrequencyView();
        else if (frequency.key == 40) widget = new RecurringChargeOneTimeFrequencyView();
        else {
            SnackBar.show("There\'s not yet supported the frequency" + " [" + (frequency.value || ("#" + frequency.key)) + "]");
            return;
        }

        widget.setData(frequency, this.model.chargeTimes);
        this._frequencyViewWidgetMap[frequency.key] = widget;
        widget.into(this.frequencyViewContainer);
    }
    Dom.removeClass(widget.node(), "Hidden");
}

ClassRecurringChargeDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES.concat("p:ValueUpdated");
}

ClassRecurringChargeDialog.prototype.getCurrentInputValues = function() {
    var cycleTime = parseInt(this.chargeFrequencySelection.getValue());
    var frequencyWidget = this._frequencyViewWidgetMap[cycleTime];
    var chargeTimes = frequencyWidget ? frequencyWidget.getSelectedChargeTimes() : null;
    var result = {
        id: this.model.id,
        name: this.chargeNameInput.value,
        coaId: this.coaSelection.getValue(),
        amount: parseFloat(this.chargeAmountInput.value),
        chargeFrequency: cycleTime,
        chargeTimes: chargeTimes
    };
    return result;
}

ClassRecurringChargeDialog.prototype.save = function(callback) {
    var thiz = this;
    if (!ValidationManager.run(this.validationRules)) return false;

    var cycleTime = parseInt(this.chargeFrequencySelection.getValue());
    var frequencyWidget = this._frequencyViewWidgetMap[cycleTime];
    if (frequencyWidget && !ValidationManager.run(frequencyWidget.getValidationRules())) return false;

    var data = this.getCurrentInputValues();
    $billingService.saveClassScheduledCharge(this.model.classId, data, function(data) {
        if (data) callback(data);
        else SnackBar.show("Failed to save data");
    }, function(error) {
        SnackBar.show(String.format("Failed to save data with error: {0]}", error));
    });
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassSettingCostumeVendorsWidget.js";

function ClassSettingCostumeVendorsWidget(node) {
    BaseTemplatedWidget.call(this);

    var thiz = this;
    this.vendorList.populator = function (data, binding, node) {
        node._vendorDataKey = data.key;
        Dom.addClass(node, "VendorItem_" + data.key);
        if (thiz.selectedVendor && data.key == thiz.selectedVendor.key) Dom.addClass(node, "Active");
        Dom.addClass(binding.vendorName, "VendorItem_" + data.key);
        if (data.name && data.name.length > 0) {
            binding.vendorName.innerHTML = data.name;
        } else {
            binding.vendorName.innerHTML = "[New Vendor]";
            Dom.addClass(binding.vendorName, "NoVendorName");
        }
    };

    this.bind("click", this.newVendorButtonClickHandler, this.newVendorButton);
    this.bind("click", this.newVendorButtonClickHandler, this.newVendorButton2);
    this.bind("click", this.autoSizerButtonClickHandler, this.autoSizerButton);
    this.bind("click", this.saveButtonClickHandler, this.saveButton);
    this.bind("click", this.cancelButtonClickHandler, this.cancelButton);
    this.bind("click", this.deleteButtonClickHandler, this.deleteButton);
    this.bind("click", this.vendorListClickedHandler, this.vendorList);
}

__extend(BaseTemplatedWidget, ClassSettingCostumeVendorsWidget);

ClassSettingCostumeVendorsWidget.prototype._initPageDrescription = function() {
    var vendors = this._costumeModule.util.getSystemVendors();
    if (vendors && vendors.length > 0) {
        var names = vendors.map(function(v) {
            return v.name;
        }).join(", ");
        this.maintainVendorsWrapper.innerHTML = names;
        Dom.addClass(this.node(), "WithMaintainVendor");
    }
}

ClassSettingCostumeVendorsWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    if (!this._costumeModule) {
        widget.__ensureNamespaceLoaded("costume", function(module) {
            this._costumeModule = module;
            this._initPageDrescription();
            this.vendorObject = {};
            this.renderVendorList();
        }.bind(this));
    }
};

ClassSettingCostumeVendorsWidget.prototype.setSelectedVendor = function() {
    this.selectedVendor = undefined;
    if (!this.vendorDataItems || this.vendorDataItems.length < 1) return;

    if (this.lastUpdatedVendor) {
        this.selectedVendor = this.vendorDataItems.find(function(vendor) {
            return this.lastUpdatedVendor.id == vendor.id;
        }.bind(this));
    } 
    if (!this.selectedVendor) this.selectedVendor = this.vendorDataItems[0];
}

ClassSettingCostumeVendorsWidget.prototype.renderVendorList = function () {
    var thiz = this;
    this.vendorWidget = null;

    $costumeManagementService.getAllVendors(function (res) {
        thiz.vendorDataItems = res.result;

        if (thiz.vendorDataItems && thiz.vendorDataItems.length > 0) {
            for (var i = 0; i < thiz.vendorDataItems.length; i++) {
                thiz.vendorDataItems[i].key = Util.newUUID();
                thiz.vendorObject[thiz.vendorDataItems[i].key] = thiz.vendorDataItems[i];
            }
            thiz.setSelectedVendor();

            Dom.removeClass(thiz.vendorContentWrapper, "Hidden");
            Dom.addClass(thiz.noVendorContent, "Hidden");
            thiz.newVendorButton2.removeAttribute("disabled");
            thiz.vendorList.setItems(thiz.vendorDataItems, function() {
                thiz._toggleDeleteButton();
            });

            thiz.renderVendorContent();
        } else {
            Dom.removeClass(thiz.noVendorContent, "Hidden");
            Dom.addClass(thiz.vendorContentWrapper, "Hidden");
        }
    }, function (error) {});
    
    this._installDisclaimerInfoTip();
};

ClassSettingCostumeVendorsWidget.prototype._installDisclaimerInfoTip = function () {
    InfoTip.install(this.disclaimer, {
        match: function (node) {
            return Dom.hasClass(node, "disclaimer");
        },
        getMessage: function (target) {
            return "SportsEngine Motion is not responsible for your costume orders. It\u2019s your responsibility to ensure that the correct costume size is ordered. We do our very best to keep the data accurate, however, vendors can change size charts without any notice.";
        },
        type: "info"
    });
}

ClassSettingCostumeVendorsWidget.prototype.newVendorButtonClickHandler = function () {
    var thiz = this;

    this.newVendorButton2.setAttribute("disabled", "disabled");
    Dom.addClass(this.noVendorContent, "Hidden");
    Dom.removeClass(this.vendorContentWrapper, "Hidden");

    if (!this.vendorDataItems) this.vendorDataItems = [];

    var newData = {
        id: 0,
        key: Util.newUUID()
    };
    this.vendorDataItems.splice(0, 0, newData);
    this.selectedVendor = this.vendorDataItems[0];
    this.vendorList.setItems(this.vendorDataItems, function() {
        thiz._toggleDeleteButton();
    });

    this.renderVendorContent();
};

ClassSettingCostumeVendorsWidget.prototype.renderVendorContent = function () {
    this.vendorContent.innerHTML = "";
    var options = {
        "vendor": this.selectedVendor,
        "isVendorNameEditable": !this.selectedVendor.system || this._costumeModule.ModuleData.TEAM_INFO.isOverideSystemVendorAllowed,
        "isVendorChartEditable": !this.selectedVendor.system || this._costumeModule.ModuleData.TEAM_INFO.isOverideSystemVendorAllowed,
        "isAutoSizeEditable": !this.selectedVendor.system || this._costumeModule.ModuleData.TEAM_INFO.isOverideSystemVendorAllowed
    }
    this.vendorWidget = new this._costumeModule.VendorWidget(options);
    this.vendorWidget.into(this.vendorContent);
};

ClassSettingCostumeVendorsWidget.prototype.vendorListClickedHandler = function (event) {
    var selectedNode = Dom.findUpwardForNodeWithData(event.target, "_vendorDataKey");
    if (!selectedNode) return;
    var thiz = this;
    if (!Dom.hasClass(selectedNode, "Active")) {
        var nextVendor = this.vendorObject[selectedNode._vendorDataKey];
        if (this.vendorWidget && (this.vendorWidget.isDataChanged() || this.selectedVendor.id < 1)) {
            Dialog.confirm("The vendor was changed but unsaved. Please discard or save these changes to continue", null, "Save & Continue", function () {
                thiz._save(function(newVendor) {
                    thiz.lastUpdatedVendor = nextVendor;
                    thiz.renderVendorList();
                })
            },
            "Cancel", function () {
                return;
            }, "Discard & Continue", function () {
                thiz.discardChanges(nextVendor);
            });
        } else {
            this.selectVendorNode(selectedNode);
        }
    }
};

ClassSettingCostumeVendorsWidget.prototype.selectVendorNode = function (selectedNode) {
    if (!selectedNode) return;
    Dom.doOnSelector(this.vendorList.node(), ".Active", function (el) {
        Dom.removeClass(el, "Active");
    });
    Dom.addClass(selectedNode, "Active");

    this.selectedVendor = this.vendorObject[selectedNode._vendorDataKey];
    this._toggleDeleteButton();
    this.renderVendorContent();
}

ClassSettingCostumeVendorsWidget.prototype._toggleDeleteButton = function() {
    if (typeof this.selectedVendor.deletable === "undefined" || !this.selectedVendor.deletable) {
        Dom.hide(this.deleteButton);
    } else {
        Dom.show(this.deleteButton);
    }
}

ClassSettingCostumeVendorsWidget.prototype.saveButtonClickHandler = function() {
    var thiz = this;
    this._save(function(newVendor) {
        thiz.lastUpdatedVendor = newVendor;
        thiz.renderVendorList();
    })
};

ClassSettingCostumeVendorsWidget.prototype._save = function(callback) {
    if (!this.vendorWidget) return;
    if (!this.vendorWidget.validateVendor()) return;

    var thiz = this;
    var vendorValue = this.vendorWidget.getVendorValue();

    if (this.selectedVendor.id > 0) {
        $costumeManagementService.updateVendor(vendorValue, function(res) {
            if (callback) callback(res);

            SnackBar.show("Vendor saved successfully.");
        }, function(err) {
            Dialog.error("Fail to save Vendor with error", err.message);
        });
    } else {
        $costumeManagementService.createVendor(vendorValue, function(res) {
            if (callback) callback(res);

            SnackBar.show("Vendor created successfully.");
        }, function(err) {
            Dialog.error("Fail to save Vendor with error", err.message);
        });
    }
}

ClassSettingCostumeVendorsWidget.prototype.cancelButtonClickHandler = function () {
    var thiz = this;
    Dialog.confirmDangerousAction("All changes are not saved. Do you want to discard these changes?", null, "Discard Changes", function () {
        thiz.discardChanges();
    },
    "Cancel", function () {
        return;
    }, null, null);
};

ClassSettingCostumeVendorsWidget.prototype.discardChanges = function(nextVendor) {
    this.lastUpdatedVendor = nextVendor || this.selectedVendor;
    this.renderVendorList();
}

ClassSettingCostumeVendorsWidget.prototype.deleteButtonClickHandler = function () {
    if (!this.selectedVendor) return;

    var thiz = this;
    Dialog.confirmDangerousAction("Are you sure you want to delete this vendor?", null, "Delete", function () {
        if (thiz.selectedVendor.id > 0) {
            $costumeManagementService.deleteVendor(thiz.selectedVendor.id, function () {
                thiz.lastUpdatedVendor = null;
                thiz.renderVendorList();

                SnackBar.show("Vendor deleted successfully");
            }, function (err) {});
        } else {
            thiz.renderVendorList();
        }
    },
    "Cancel", function () {
        return;
    }, null, null);
};

ClassSettingCostumeVendorsWidget.prototype.autoSizerButtonClickHandler = function() {
    var thiz = this;
    widget.__ensureNamespaceLoaded("costume", function (ns) {
        new ns.CostumeOrderingReportDialog().callback(function(data) {}).open({});
    });
}

ClassSettingCostumeVendorsWidget.prototype.invalidateButtonStatus = function (event) {
    if (event.isDataChanged) {
        this.newVendorButton2.setAttribute("disabled", "disabled");
        this.cancelButton.removeAttribute("disabled");
        this.saveButton.removeAttribute("disabled");
    } else {
        this.newVendorButton2.removeAttribute("disabled");
        this.cancelButton.setAttribute("disabled", "disabled");
        this.saveButton.setAttribute("disabled", "disabled");
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/DataForm.js";

function DataForm() {
    BaseTemplatedWidget.call(this);
    this.modified = false;
    this._snapshotInputValues = null;

    var checkModifiedEvent = function(event) {
        if (!this.unsavedChangeListenerRegistered) return;
        if (typeof(event.fromUser) != "undefined") {
            if (!event.fromUser) return;
        }
        Dom.emitEvent(DataForm.DATA_CHANGE_EVENT_NAME, this.node());
        if (this._snapshotInputValues === null) {
            this.showUnsavedNotify();
            return;
        }
        this._validateInputValues();
    };
    var names = this.getChangeEventNames();
    for (var i = 0; i < names.length; i ++) {
        this.bind(names[i], checkModifiedEvent, this.node());
    }
    this.unsavedChangeListenerRegistered = true;
}
__extend(BaseTemplatedWidget, DataForm);

DataForm.FORMDATA_CHANGE_EVENT_NAME = "p:Modified";
DataForm.ALL_CHANGE_EVENT_NAMES = ["input", "change", "p:ItemSelected", "p:ValueChanged", "p:SelectionChanged"];

DataForm.prototype.getChangeEventNames = function() {
    return DataForm.ALL_CHANGE_EVENT_NAMES;
}

DataForm.prototype.showUnsavedNotify = function() {
    // TODO: Abstract method. Need to override
}

DataForm.prototype.clearUnsavedNotify = function() {
    // TODO: Abstract method. Need to override
}

DataForm.prototype.getSnapshotInputValues = function() {
    return this._snapshotInputValues;
}

DataForm.prototype.setSnapshotInputValues = function(values) {
    if(values && typeof (values) == "object") {
        this._snapshotInputValues = JSON.parse(JSON.stringify(values));
    } else {
        this._snapshotInputValues = values;
    }
}

DataForm.prototype.hasInputValuesChanged = function() {
    return this.modified;
}

DataForm.prototype._validateInputValues = function(values) {
    var curValues = values || this.getCurrentInputValues() || {};
    var snapshotValues = this._snapshotInputValues || {};
    if (JSON.stringify(snapshotValues) !== JSON.stringify(curValues)) {
        this.modified = true;
        this.showUnsavedNotify();
    } else {
        this.modified = false;
        this.clearUnsavedNotify();
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassSettingGeneralWidget.js";

function ClassSettingGeneralWidget() {
    DataForm.call(this);
    var thiz = this;
    this.coaSettingList = [];
    this.bind("change", function(event) {
        if (!event.target.checked) {
            this.itemMakeups.value = 0;
            this.itemMakeups.disabled = true;
        } else {
            this.itemMakeups.disabled = false;
        }
    }, this.ckbUnlimitedMakeups);
    this.bind("click", function(event) {
        console.log("click on ", event.currentTarget);
        Dom.toggleClass(thiz.paymentRequiredInfoLink, "Focused", true);
        var popupContent = Dom.newDOMElement({
            _name: "span",
            _text: "When YES, completing a class registration will always require accounts to have an electronic payment method on file, even if no charges are assessed at registration.",
            style: "width: 42em; display: block; padding: 0em 1em"
        });
        var popup = new Popup();
        popup.setPopupClass("RequireElectronicPayment");
        popup.setContentFragment(popupContent);
        popup.onHide = function() {
            Dom.toggleClass(thiz.paymentRequiredInfoLink, "Focused", false);
            popup.kill();
        };
        popup.show(thiz.paymentRequiredInfoLink, "left-inside", "top", 0, 5, true);
    }, this.paymentRequiredInfoLink);
    this.bind("change", this.validateSubformData.bind(this), this.ckbFamilyAnnualRegistration);
    this.bind("change", this.validateSubformData.bind(this), this.ckbStudentAnnualRegistration);
    this.bind("change", this.toggleRemitance.bind(this), this.ckbCheckAccepted);
    this.bind("change", this.toggleRemitance.bind(this), this.ckbCashAccepted);
    //this.bind("change", this.toggleMultiRegDiscount.bind(this), this.ckbRegDiscount);
    //this.bind("change", this.toggleMultiClassDiscount.bind(this), this.ckbClassDiscount);
    this.bind("change", this.validateSubformData.bind(this), this.ckbCoupon);
    //this.bind("click", this.editDiscount.bind(this, {id: 0, type: DiscountEditDialog.DISC_TYPE_STUDENT}), this.buttonAddStudentsDiscountDefination);
    //this.bind("click", this.editDiscount.bind(this, {id: 0, type: DiscountEditDialog.DISC_TYPE_CLASS}), this.buttonAddClassesDiscountDefination);
    //this.bind("click", this.editCoupon.bind(this, 0), this.buttonAddCoupon);
    this.bind("click", this.performCancel.bind(this), this.buttonHCancel);
    this.bind("click", this.save.bind(this), this.buttonHSave);
    this.bind("click", this.performCancel.bind(this), this.buttonFCancel);
    this.bind("click", this.save.bind(this), this.buttonFSave);
    this.bind("p:ItemSelected", function(event) {
        thiz.multiStudentDiscOrderCombo.setDisabled(thiz.multiStudentDiscAppCombo.getSelectedItem().key != 0);
    }, this.multiStudentDiscAppCombo);
    this.bind("p:ItemSelected", function(event) {
        thiz.multiClassDiscOrderCombo.setDisabled(thiz.multiClassDiscAppCombo.getSelectedItem().key != 0);
    }, this.multiClassDiscAppCombo);
    this.bind("change", this.toggleAutoWaitlist.bind(this), this.ckbAutoWaitlist);
    this.bind("mouseover", this.showClassPaymentTransferToolTip.bind(this), this.classPaymentTransfer);
    this.bind("mouseout", this.hideClassPaymentTransferToolTip.bind(this), this.classPaymentTransfer);

    this._onCostumeModuleChange = function() {
        widget.__refershClientModuleData("finance");
        widget.__refershClientModuleData("costume", function (ns) {
            if (window.LOGIN_INFO) {
                window.LOGIN_INFO.costumeModuleName = ns.util.getPreferredCostumeModuleName(true);
                var tabPane = thiz.findUpward(TabPane);
                if (tabPane && tabPane.findTabByName("costumeVendors")){
                    tabPane.setTabTitleByName("costumeVendors", String.format("{0} Vendors", window.LOGIN_INFO.costumeModuleName));
                }
            }
        });
    }
}
__extend(DataForm, ClassSettingGeneralWidget);

ClassSettingGeneralWidget.prototype.onDetached = function() {
    CommonEvent.removeEvent("costume-management", "costume_module_name_changed", this._onCostumeModuleChange);
};

ClassSettingGeneralWidget.valueTitleComparer = function(selected, item) {
    return selected.value == item.value;
};
ClassSettingGeneralWidget.valueTitleRenderer = function(item) {
    return item.title;
};
ClassSettingGeneralWidget.idNameComparer = function(selected, item) {
    return selected.id == item.id;
};
ClassSettingGeneralWidget.idNameRenderer = function(item) {
    return item.name;
};

ClassSettingGeneralWidget.prototype.onAttached = function() {
    CommonEvent.listener("costume-management", "costume_module_name_changed", this._onCostumeModuleChange);
    var thiz = this;
    if (this.delayedRenderTimeout) {
        window.clearTimeout(this.delayedRenderTimeout);
    }
    this.delayedRenderTimeout = window.setTimeout(function() {
        thiz.onAttachedDelayed();
    }, 100);
};

ClassSettingGeneralWidget.prototype.onAttachedDelayed = function() {
    this.selectWaitlist.renderer = ClassSettingGeneralWidget.valueTitleRenderer;
    this.selectWaitlist.comparer = ClassSettingGeneralWidget.valueTitleComparer;
    this.selectWaitlist.setItems([
        {value: 0, title: "NO - Accept Enrollment"},
        {value: 1, title: "YES - " + window.top.TeamLocalizer.getString("Waitlist Non-Electronic Payers")}
    ]);
    this.selectSendInstuctorEmail.renderer = ClassSettingGeneralWidget.valueTitleRenderer;
    this.selectSendInstuctorEmail.comparer = ClassSettingGeneralWidget.valueTitleComparer;
    this.selectSendInstuctorEmail.setItems([
        {value: 1, title: "YES"},
        {value: 0, title: "NO"}
    ]);
    this.showClothing4Reg.renderer = ClassSettingGeneralWidget.valueTitleRenderer;
    this.showClothing4Reg.comparer = ClassSettingGeneralWidget.valueTitleComparer;
    this.showClothing4Reg.setItems([
        {value: true, title: "YES"},
        {value: false, title: "NO"}
    ]);
    
    this.groupAttendanceNoteCombo.renderer = ClassSettingGeneralWidget.valueTitleRenderer;
    this.groupAttendanceNoteCombo.comparer = ClassSettingGeneralWidget.valueTitleComparer;
    this.groupAttendanceNoteCombo.setItems([
        {value: false, title: "NO"},
        {value: true, title: "YES"}
    ]);
    
    this.classRoomAttendanceNoteCombo.renderer = ClassSettingGeneralWidget.valueTitleRenderer;
    this.classRoomAttendanceNoteCombo.comparer = ClassSettingGeneralWidget.valueTitleComparer;
    this.classRoomAttendanceNoteCombo.setItems([
        {value: false, title: "NO"},
        {value: true, title: "YES"}
    ]);

    this.selectFamilyChartOfAccount.renderer = ClassSettingGeneralWidget.idNameRenderer;
    this.selectFamilyChartOfAccount.comparer = ClassSettingGeneralWidget.idNameComparer;
    this.selectStudentChartOfAccount.renderer = ClassSettingGeneralWidget.idNameRenderer;
    this.selectStudentChartOfAccount.comparer = ClassSettingGeneralWidget.idNameComparer;
    this.selectMultiStudentsAccountChart.renderer = ClassSettingGeneralWidget.idNameRenderer;
    this.selectMultiStudentsAccountChart.comparer = ClassSettingGeneralWidget.idNameComparer;
    this.selectMultiClassesAccountChart.renderer = ClassSettingGeneralWidget.idNameRenderer;
    this.selectMultiClassesAccountChart.comparer = ClassSettingGeneralWidget.idNameComparer;

    this.multiStudentDiscAppCombo.comparer = function(a, b) {return a.key == b.key;};
    this.multiStudentDiscAppCombo.renderer = function(data) {return data.value;};
    this.multiStudentDiscOrderCombo.comparer = function(a, b) {return a.key == b.key;};
    this.multiStudentDiscOrderCombo.renderer = function(data) {return data.value;};
    this.multiClassDiscAppCombo.comparer = function(a, b) {return a.key == b.key;};
    this.multiClassDiscAppCombo.renderer = function(data) {return data.value;};
    this.multiClassDiscOrderCombo.comparer = function(a, b) {return a.key == b.key;};
    this.multiClassDiscOrderCombo.renderer = function(data) {return data.value;};
    
    this.costumeModuleNameCombo.comparer = function(a, b) {return a.key == b.key;};
    this.costumeModuleNameCombo.renderer = function(data) {return data.value;};
    
    this.classTransferCombo.comparer = function(a, b) {return a.id == b.id;};
    this.classTransferCombo.renderer = function(data) {return data ? data.name : "Default";};
    
    this.classTransferNotPaidCombo.comparer = function(a, b) {return a.id == b.id;};
    this.classTransferNotPaidCombo.renderer = function(data) {return data ? data.name : "Default";};

    var thiz = this;
    new Promise(function(resolve, reject) {
        if (window.LOGIN_INFO && ClassAuthUtils.canViewClassSettings(window.LOGIN_INFO)) {
            resolve(window.LOGIN_INFO);
        } else {
            $classAdminService.getAccountInfo(function(loginInfo) {
                resolve(loginInfo);
            }, function(error) { reject(error); });
        }
    }).then(function(loginInfo) {
        thiz.allowClassPaymentPlan = loginInfo.allowClassPaymentPlan;
        thiz.allowAutoWaitlist = loginInfo.allowAutoWaitlist;
        thiz.isViewOnly = !ClassAuthUtils.canUpdateGeneralSettings(loginInfo);
        thiz.tableStudentsDiscountDefination.discountName = "Athletes";
        thiz.tableClassesDiscountDefination.discountName = "Classes";
        thiz.allowCheck = loginInfo.allowCheck;
        if (thiz.allowClassPaymentPlan) {
            Dom.addClass(thiz.mainBody, "AllowClassPaymentPlan");
        }
        if (thiz.allowAutoWaitlist) {
            Dom.addClass(thiz.mainBody, "AllowAutoWaitlist");
        }

        if (thiz.allowCheck) {
            Dom.addClass(thiz.mainBody, "AllowCheck");
        }
        thiz.allowCash = true;
        Dom.addClass(thiz.mainBody, "AllowCash");
        thiz.allowCostume = loginInfo.allowCostume;
        Dom.toggleClass(thiz.mainBody, "AllowCostume", loginInfo.allowCostume);
        
        thiz.setupDiscountDataTable(thiz.tableStudentsDiscountDefination);
        thiz.setupDiscountDataTable(thiz.tableClassesDiscountDefination);
        thiz.setupCouponTable();
        thiz.initFormValidation();
        thiz.requestSettingData();
        thiz.renderDiscountContent();
        thiz.hideAnnualFeeSetting();
    });
};

ClassSettingGeneralWidget.prototype.disableAllFormItems = function() {
    Dom.doOnChildRecursively(this.node(), {
        eval: function(node) {
            if (typeof(node) == "object" && (node.tagName == "BUTTON" || node.tagName == "INPUT")) {
                return true;
            }
            return false;
        }
    }, function(node) {
        node.disabled = true;
    });
};

ClassSettingGeneralWidget.prototype.initFormValidation = function() {
    var thiz = this;
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemStudentAnnualFeeAmount, "Please input Fee amount", Condition.checked(this.ckbStudentAnnualRegistration))
        .required(this.itemReceiptEmail, "Please enter a valid email address")
        .pattern(this.itemReceiptEmail, ValidationManager.patterns.EMAIL_REGEX, "Please enter a valid email address")
        .custom(new GenericRule(this.itemReceiptEmail, function(context) {
            if (thiz.itemReceiptEmail.value.length > 512) return false;
            return true;
        },"Email address used to send receipt emails too long"))
        .custom(new GenericRule(this.itemReceiptName, function(context) {
            if (thiz.itemReceiptName.value.length > 255) return false;
            return true;
        },"Name used to send receipt emails too long"))
        .required(this.timeRetainingRegistration, "Please enter a valid value", Condition.checked(this.ckbAutoWaitlist))
        .custom(new PatternMatchedRule(this.timeRetainingRegistration, /^[0-9]+$/, "Input positive integer value"),
            function(rule) {
                return parseInt(rule.input.value);
            }, Condition.checked(this.ckbAutoWaitlist))
        .min(this.timeRetainingRegistration, 1, false, "Input positive integer value", Condition.checked(this.ckbAutoWaitlist))
        .required(this.itemReceiptEmailWaitlist, "Please enter a valid email address", Condition.checked(this.ckbAutoWaitlist))
        .pattern(this.itemReceiptEmailWaitlist, ValidationManager.patterns.EMAIL_REGEX, "Please enter a valid email address",
            Condition.checked(this.ckbAutoWaitlist))
        .custom(new GenericRule(this.itemReceiptEmailWaitlist, function(context) {
            if (thiz.itemReceiptEmailWaitlist.value.length > 512) return false;
            return true;
        },"Email address used to send auto-waitlist receipt emails too long", Condition.checked(this.ckbAutoWaitlist)))
        .custom(new GenericRule(this.itemReceiptNameWaitlist, function(context) {
            if (thiz.itemReceiptNameWaitlist.value.length > 255) return false;
            return true;
        },"Name used to send auto-waitlist receipt emails too long"))
        .required(this.itemMakeups, "Input positive value", Condition.checked(this.ckbUnlimitedMakeups))
        .custom(new PatternMatchedRule(this.itemMakeups, /^[0-9]+$/, "Input positive integer value"),
            function(rule) {
                return parseInt(rule.input.value);
            }, Condition.checked(this.ckbFamilyAnnualRegistration))
        .min(this.itemMakeups, 1, false, "Input positive integer value", Condition.checked(this.ckbUnlimitedMakeups));
        

    if (thiz.allowCheck) {
        this.validationRules
        .required(this.itemRemittanceName, "Please input 'Remittance Name'", Condition.checked(this.ckbCheckAccepted))
        .required(this.itemCheckAddress, "Please input Address", Condition.checked(this.ckbCheckAccepted))
        .required(this.itemCheckCity, "Please input City", Condition.checked(this.ckbCheckAccepted))
        .required(this.itemCheckState, "Please input State", Condition.checked(this.ckbCheckAccepted))
        .required(this.itemCheckZipCode, "Please input ZipCode", Condition.checked(this.ckbCheckAccepted))
        .required(this.itemCheckPhone, "Please input Phone", Condition.checked(this.ckbCheckAccepted));
    }
//    always validate remittance info for cash accepted, because cash will be allowed on all team
    this.validationRules
        .required(this.itemRemittanceName, "Please input 'Remittance Name'", Condition.checked(this.ckbCashAccepted))
        .required(this.itemCheckAddress, "Please input Address", Condition.checked(this.ckbCashAccepted))
        .required(this.itemCheckCity, "Please input City", Condition.checked(this.ckbCashAccepted))
        .required(this.itemCheckState, "Please input State", Condition.checked(this.ckbCashAccepted))
        .required(this.itemCheckZipCode, "Please input ZipCode", Condition.checked(this.ckbCashAccepted))
        .required(this.itemCheckPhone, "Please input Phone", Condition.checked(this.ckbCashAccepted));

    this.validationRules
        .rule(new GenericRule(thiz.fakeClassesDiscountButton, function(rule) {
            if (thiz.ckbClassDiscount.checked) {
                return thiz.tableClassesDiscountDefination.getItems() && thiz.tableClassesDiscountDefination.getItems().length;
            }
            return true;
        }, "Please create discount data"))
        .rule(new GenericRule(thiz.fakeStudentsDiscountButton, function(rule) {
            if (thiz.ckbRegDiscount.checked) {
                return thiz.tableStudentsDiscountDefination.getItems() && thiz.tableStudentsDiscountDefination.getItems().length;
            }
            return true;
        }, "Please create discount data"));
};

ClassSettingGeneralWidget.prototype.requestSettingData = function() {
    var thiz = this;
    function checkExistsCoA(coaSettingList, coaId) {
        for (var i = 0; i < coaSettingList.length; i++) {
            if (coaSettingList[i].id == coaId) {
                return true;
            }
        }
        return false;
    }
    $classAdminService.getAdminSetting(function(data) {
        thiz.id = data.id;
        thiz.coaSettingList = data.coaSettingList.filter(function(item) {
            return item.hidden == false;
        });
        var coaOptions = thiz.coaSettingList;

        thiz.selectFamilyChartOfAccount.setItems(coaOptions);
        thiz.selectStudentChartOfAccount.setItems(coaOptions);
        thiz.selectMultiStudentsAccountChart.setItems(coaOptions);
        thiz.selectMultiClassesAccountChart.setItems(coaOptions);

        thiz.itemReceiptEmail.value = data.receiveEmail;
        thiz.itemReceiptName.value = data.receiveName;
        
        thiz.groupAttendanceNoteCombo.selectItemIfContains({value: data.enableGroupAttendanceNote});
        thiz.classRoomAttendanceNoteCombo.selectItemIfContains({value: data.enableClassRooomAttendanceNote});
        thiz.classRoomNoteLabelInput.value = data.classRoomAttendanceNoteLabel || "Classroom";
        thiz.ckbInstructorConflictChecking.checked = data.instructorConflictCheckingEnabled;

        thiz.selectWaitlist.selectItemIfContains({value: data.autoCheckWaitlistPayment});
        if (thiz.allowAutoWaitlist) {
            thiz.ckbAutoWaitlist.checked = data.enableAutoWaitlist;
            thiz.itemReceiptEmailWaitlist.value = data.receiveEmailWaitlist;
            thiz.itemReceiptNameWaitlist.value = data.receiveNameWaitlist;
            thiz.timeRetainingRegistration.value = data.timeRetainingRegistration;
            thiz.toggleAutoWaitlist();
        }

        thiz.selectSendInstuctorEmail.selectItemIfContains({value: data.instEmailStd});
        thiz.showClothing4Reg.selectItemIfContains({value: data.showClothing4Reg});
        if (!data.showClothing4Reg) Dom.hide(thiz.showClothing4RegWrapper);
        
        //thiz.showInsuranceEmergency.selectItemIfContains({value: data.showInsuranceEmergency});
        thiz.ckbHideDaysOffered.checked = data.hideDaysOffered;
        thiz.ckbHideTimeOffered.checked = data.hideTimeOffered;
        thiz.ckbHideInstructorOffered.checked = data.hideInstructor;
        thiz.ckbDisplaySubprogExpanded.checked = data.expandedSubProg;
        
        thiz.ckbHideAge.checked = data.hideAge;
        thiz.ckbHideGender.checked = data.hideGender;
        thiz.ckbHideLocations.checked = data.hideLocation;
        thiz.ckbHideDayOfWeek.checked = data.hideDayOfWeek;
        thiz.ckbHideSession.checked = data.hideSession;
        
        if (data.defaultMakeups > 0) {
            thiz.itemMakeups.value = data.defaultMakeups;
            thiz.ckbUnlimitedMakeups.checked = true;
        } else {
            thiz.itemMakeups.disabled = true;
            thiz.ckbUnlimitedMakeups.checked = false;
        }
        if (thiz.allowClassPaymentPlan) {
            thiz.ckbApplyMultiAthleteDiscount.checked = data.studentAnnualFeeMultiDiscEnable;
        }
        if (data.familyAnnualCoAId > 0 && checkExistsCoA(thiz.coaSettingList, data.familyAnnualCoAId)) {
            thiz.ckbFamilyAnnualRegistration.checked = true;
            Dom.emitEvent("change", thiz.ckbFamilyAnnualRegistration);
            thiz.itemFamilyAnnualFeeAmount.setValue(data.familyAnnualFeeAmount);
            thiz.selectFamilyChartOfAccount.selectItemIfContains({id: data.familyAnnualCoAId});
        } else {
            thiz.ckbFamilyAnnualRegistration.checked = false;
            Dom.emitEvent("change", thiz.ckbFamilyAnnualRegistration);
        }
        if (data.studentAnnualCoAId > 0 && checkExistsCoA(thiz.coaSettingList, data.studentAnnualCoAId)) {
            thiz.ckbStudentAnnualRegistration.checked = true;
            Dom.emitEvent("change", thiz.ckbStudentAnnualRegistration);
            thiz.itemStudentAnnualFeeAmount.setValue(data.studentAnnualFeeAmount);
            thiz.selectStudentChartOfAccount.selectItemIfContains({id: data.studentAnnualCoAId});
        } else {
            thiz.ckbStudentAnnualRegistration.checked = false;
            Dom.emitEvent("change", thiz.ckbStudentAnnualRegistration);
        }

        thiz.ckbCashAccepted.checked = data.cashAccepted;
        Dom.emitEvent("change", thiz.ckbCashAccepted);
        
        thiz.ckbCheckAccepted.checked = data.checkAccepted;
        Dom.emitEvent("change", thiz.ckbCheckAccepted);
        thiz.itemRemittanceName.value = data.checkName;
        thiz.itemCheckAddress.value = data.checkAddress;
        thiz.itemCheckCity.value = data.checkCity;
        thiz.itemCheckState.value = data.checkState;
        thiz.itemCheckZipCode.value = data.checkZip;
        thiz.itemCheckPhone.value = data.checkPhone;
        thiz.ckbCreditCardAccepted.checked = data.creditCardAccepted;
        if (thiz.allowClassPaymentPlan) {
            thiz.ckbElectronicPaymentRequired.checked = data.requireElectronicPayment;
        }
        thiz.ckbRequireAccountBalancePayoff.checked = data.requireAccountBalancePayoff;

        thiz.ckbRegDiscount.checked = data.enableRegDiscount;
        thiz.ckbClassDiscount.checked = data.enableClassDiscount;

        thiz.multiStudentDiscAppCombo.setItems(data.discAppTypes);
        thiz.multiStudentDiscOrderCombo.setItems(data.discOrderTypes);
        thiz.multiStudentDiscAppCombo.selectItemByKey("key", data.multiStudentDiscApp);
        thiz.multiStudentDiscOrderCombo.selectItemByKey("key", data.multiStudentDiscOrder);

        thiz.selectMultiStudentsAccountChart.selectItemIfContains({id: data.mulStudentsDiscountCoAId});
        if(data.discList){
            if (thiz.tableStudentsDiscountDefination.domLoaded) {
                thiz.tableStudentsDiscountDefination.setItems(data.discList.filter(function (item) {
                    return item.type == DiscountEditDialog.DISC_TYPE_STUDENT;
                }));
            } else {
                setTimeout(function() {
                    thiz.tableStudentsDiscountDefination.setItems(data.discList.filter(function(item) {
                        return item.type == DiscountEditDialog.DISC_TYPE_STUDENT;
                    }));
                }, 50);
            }
        }
        thiz.multiClassDiscAppCombo.setItems(data.discAppTypes);
        thiz.multiClassDiscOrderCombo.setItems(data.discOrderTypes);
        thiz.multiClassDiscAppCombo.selectItemByKey("key", data.multiClassDiscApp);
        thiz.multiClassDiscOrderCombo.selectItemByKey("key", data.multiClassDiscOrder);

        thiz.selectMultiClassesAccountChart.selectItemIfContains({id: data.mulClassesDiscountCoAId});
        if (data.discList){
            if (thiz.tableClassesDiscountDefination.domLoaded) {
                thiz.tableClassesDiscountDefination.setItems(data.discList.filter(function(item) {
                    return item.type == DiscountEditDialog.DISC_TYPE_CLASS;
                }));
            } else {
                setTimeout(function() {
                    thiz.tableClassesDiscountDefination.setItems(data.discList.filter(function(item){
                        return item.type == DiscountEditDialog.DISC_TYPE_CLASS;
                    }));
                }, 50);
            }
        }

        thiz.toggleMultiRegDiscount();
        thiz.toggleMultiClassDiscount();

        if (data.couponList && data.couponList.length > 0) {
            thiz.ckbCoupon.checked = true;
            Dom.emitEvent("change", thiz.ckbCoupon);
            var couponData = data.couponList.map(function(coupon) {
                var filterList = data.coaSettingList.filter(function (coa) {
                    return coa.id == coupon.coaId;
                });
                coupon.coaName = filterList.length > 0 ? filterList[0].name : "";
                return coupon;
            });
            if (thiz.tableCouponDefination.domLoaded) {
                thiz.tableCouponDefination.setItems(couponData);
            } else {
                setTimeout(function() {
                    thiz.tableCouponDefination.setItems(couponData);
                }, 50);
            }
        } else {
            thiz.ckbCoupon.checked = false;
            Dom.emitEvent("change", thiz.ckbCoupon);
            // this.tableCouponDefination.setItems([]);
        }
        
        thiz.costumeModuleNameCombo.setItems(data.costumeModuleNames);
        thiz.costumeModuleNameCombo.selectItemByKey("key", data.costumeModuleNameCode);
        
        thiz.chargeCategories = [null].concat(data.chargeCategories);
        thiz.classTransferCombo.setItems(thiz.chargeCategories);
        thiz.classTransferCombo.selectItemByKey("id", data.classPaymentTransferChargeCategoryId);
        
        thiz.chargeCategoriesNotPaid = [null].concat(data.chargeCategories);
        thiz.classTransferNotPaidCombo.setItems(thiz.chargeCategoriesNotPaid);
        thiz.classTransferNotPaidCombo.selectItemByKey("id", data.classTransferNotPaidChargeCategoryId);
        
        if (thiz.isViewOnly) thiz.disableAllFormItems();
        thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
        thiz.clearUnsavedNotify();
    }, function(error) {
        console.log("Fail to get Setting Data with error:", error);
    });
};

ClassSettingGeneralWidget.prototype.reloadDiscountTable = function(table, type) {
    $classAdminService.listDiscountData(type, function(data) {
        table.setItems(data);
    }, function(error) {
        console.error("Fail to get Discount data with error:", error);
    });
};
/*
ClassSettingGeneralWidget.prototype.reloadCouponTable = function() {
    var thiz = this;
    $classAdminService.listCouponData(function(data) {
        var couponData  = [];
        if(data){
            couponData = data.map(function (coupon) {
                var filterList = thiz.coaSettingList.filter(function(coa) {
                    return coa.id == coupon.coaId;
                });
                coupon.coaName = filterList.length > 0 ? filterList[0].name : "";
                return coupon;
            });
        }
        thiz.tableCouponDefination.setItems(couponData);
    }, function(error) {
        console.error("Fail to get Coupon data with error:", error);
    });
};

ClassSettingGeneralWidget.prototype.editDiscount = function(discount) {
    var thiz = this;
    if (discount.type == DiscountEditDialog.DISC_TYPE_STUDENT && !this.ckbRegDiscount.checked) return;
    if (discount.type == DiscountEditDialog.DISC_TYPE_CLASS && !this.ckbClassDiscount.checked) return;

    var coaId = discount.type == DiscountEditDialog.DISC_TYPE_CLASS
        ? this.selectMultiClassesAccountChart.getSelectedItem().id : this.selectMultiStudentsAccountChart.getSelectedItem().id;
    if (!coaId) {
        Dialog.alert("Alert", "Select Chart Of Account first");
        return;
    }
    var editDialog = new DiscountEditDialog().callback(function(data) {
        if (data && data.type == DiscountEditDialog.DISC_TYPE_CLASS) {
            thiz.reloadDiscountTable(thiz.tableClassesDiscountDefination, data.type);
        }
        if (data && data.type == DiscountEditDialog.DISC_TYPE_STUDENT) {
            thiz.reloadDiscountTable(thiz.tableStudentsDiscountDefination, data.type);
        }
    });
    editDialog.open({coaId: coaId, data: discount, allowClassPaymentPlan: thiz.allowClassPaymentPlan});
};

ClassSettingGeneralWidget.prototype.deleteDiscount = function(data) {
    var thiz = this;
    if (data.type == DiscountEditDialog.DISC_TYPE_STUDENT && !this.ckbRegDiscount.checked) return;
    if (data.type == DiscountEditDialog.DISC_TYPE_CLASS && !this.ckbClassDiscount.checked) return;
    Dialog.confirm("Are you sure you want to delete this item?", null, "Delete", function () {
        $classAdminService.deleteDiscount(data.id, function() {
            SnackBar.show("Data was deleted successfully.");
            if (data && data.type == DiscountEditDialog.DISC_TYPE_CLASS) {
                thiz.reloadDiscountTable(thiz.tableClassesDiscountDefination, data.type);
            }
            if (data && data.type == DiscountEditDialog.DISC_TYPE_STUDENT) {
                thiz.reloadDiscountTable(thiz.tableStudentsDiscountDefination, data.type);
            }
        });
    }, "Cancel", function () {
    });
};

ClassSettingGeneralWidget.prototype.editCoupon = function(id) {
    var thiz = this;
    var editDialog = new CouponEditDialog().callback(function(response) {
        if (response) {
            thiz.reloadCouponTable();
        }
    });
    editDialog.open({id: id, coaSettingList: this.coaSettingList});
};

ClassSettingGeneralWidget.prototype.deleteCoupon = function(id) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete this item?", null, "Delete", function () {
        $classAdminService.deleteCoupon(id, function() {
            SnackBar.show("Data was deleted successfully.");
            thiz.reloadCouponTable();
        });
    }, "Cancel", function () {
    });
};
*/

ClassSettingGeneralWidget.prototype.toggleRemitance = function() {
    if(this.ckbCheckAccepted.checked || this.ckbCashAccepted.checked) 
        Dom.addClass(this['acceptPayment'], "Activate");
    else Dom.removeClass(this['acceptPayment'], "Activate");
}

ClassSettingGeneralWidget.prototype.validateSubformData = function(event) {
    var targetName = Dom.getAttributeAsString(event.target, "toggle-target");
    if (event.target.checked) Dom.addClass(this[targetName], "Activate");
    else Dom.removeClass(this[targetName], "Activate");
};

ClassSettingGeneralWidget.prototype.toggleMultiRegDiscount = function() {
    var isEnabled = this.ckbRegDiscount.checked;
    this.multiStudentDiscAppCombo.setEnable(isEnabled);
    this.multiStudentDiscOrderCombo.setEnable(isEnabled && this.multiStudentDiscAppCombo.getSelectedItem().key == 0);
    this.selectMultiStudentsAccountChart.setEnable(isEnabled);
    Dom.setEnabled(isEnabled, this.buttonAddStudentsDiscountDefination);
    Dom.toggleClass(this.studentsDiscount, "Disabled", !isEnabled);
    if (isEnabled) {
        this.ckbApplyMultiAthleteDiscount.removeAttribute("disabled");
    } else {
//        this.ckbApplyMultiAthleteDiscount.checked = false;
//        this.ckbApplyMultiAthleteDiscount.setAttribute("disabled", "disabled");
    }
};

ClassSettingGeneralWidget.prototype.toggleMultiClassDiscount = function() {
    var isEnabled = this.ckbClassDiscount.checked;
    this.multiClassDiscAppCombo.setEnable(isEnabled);
    this.multiClassDiscOrderCombo.setEnable(isEnabled && this.multiClassDiscAppCombo.getSelectedItem().key == 0);
    this.selectMultiClassesAccountChart.setEnable(isEnabled);
    Dom.setEnabled(isEnabled, this.buttonAddClassesDiscountDefination);
    Dom.toggleClass(this.classesDiscount, "Disabled", !isEnabled);
};

ClassSettingGeneralWidget.prototype.setupDiscountDataTable = function(table) {
    var thiz = this;
    if (this.allowClassPaymentPlan) {
        var colFrom = new DataTable.PlainTextColumn(table.discountName, function (data) {
            return data.fromValue;
        }).width("8em");
        colFrom.getContentTitle = function (data, row, col) {
            return "";
        }
        table.column(colFrom);
    } else {
        var colFrom = new DataTable.PlainTextColumn("From", function (data) {
            return data.fromValue;
        }).width("6em");
        colFrom.getContentTitle = function (data, row, col) {
            return "";
        }
        table.column(colFrom);
        var colTo = new DataTable.PlainTextColumn("To", function (data) {
            return data.toValue;
        }).width("6em");
        colTo.getContentTitle = function (data, row, col) {
            return "";
        }
        table.column(colTo);
    }
    var colDiscount = new DataTable.PlainTextColumn("Discount", function (data) {
        return (data.percent > 0 ? data.percent + "%" : "$" + data.amount);
    }).width("1*");
    colDiscount.getContentTitle = function (data, row, col) {
        return "";
    }
    table.column(colDiscount);
    var actions = [ {
            id: "edit", type: "pencil", title: "Edit Discount",
            isApplicable: function(item) {
                return true;
            },
            handler: function (item) {
                thiz.editDiscount(item);
            }
        },{
            id: "delete", type: "delete", title: "Delete Discount",
            isApplicable: function(item) {
                return true;
            },
            handler: function (item) {
                thiz.deleteDiscount(item);
            }
        }];
    var actionCol = new DataTable.ActionColumn(actions);
    actionCol.title = "";
    if (!this.isViewOnly) table.column(actionCol.width("6.5em"));
    // table.selector(true, false);
    table.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    setTimeout(function() {
        table.setup();
        table.domLoaded = true;
    }, 50);
};

ClassSettingGeneralWidget.prototype.setupCouponTable = function() {
    var thiz = this;
    var colTitle = new DataTable.GenericColumn("Coupon Title", function (data) {
        return "<a class='CouponTitle'>" + data.title + "</a>";
    }).width("1*", "9em");
    colTitle.getContentTitle = function (data, row, col) {
        return "";
    }
    this.tableCouponDefination.column(colTitle);
    var colLimitAmt = new DataTable.PlainTextColumn("Not to Exceed", function (data) {
        return data.limitAmount <= 0  || !data.limitAmount ? "" : Util.toCurrency(data.limitAmount);
    }).width("9.5em");
    colLimitAmt.dataType = "currency";
    this.tableCouponDefination.column(colLimitAmt);
    var colSingleUse = new DataTable.GenericColumn("1X Use", function (data) {
        var html = "<span class=\"SingleUseColumn\" title=\"{2}\" >{0} <br/> {1} </span>";
        return String.format(html, data.singleUse ? "YES" : "",
                            data.singleUse && data.dateRedeemed ? FormatUtil.formatDate(data.dateRedeemed, "date_standard", "local") : "",
                            data.singleUse && data.redeemedAccountId > 0 ? data.redeemedAccountName : "");
    }).width("10em");
    colSingleUse.useHtmlTitle = function() {
        return true;
    }
    colSingleUse.getContentTitle = function() {
        return "";
    }
    colSingleUse.getTitleInfo = function() {
        return "1X Use";
    }
    colSingleUse.dataType = "info";
    this.tableCouponDefination.column(colSingleUse);

    var colCode = new DataTable.PlainTextColumn("Code", function (data) {
        return data.code;
    }).width("8em");
    colCode.getContentTitle = function (data, row, col) {
        return "";
    }
    this.tableCouponDefination.column(colCode);
    if (!this.allowClassPaymentPlan) {
        var colCoA = new DataTable.PlainTextColumn("CoA", function (data) {
            return data.coaName;
        }).width("12em");
        colCoA.getContentTitle = function (data, row, col) {
            return "";
        }
        this.tableCouponDefination.column(colCoA);
    }
    var colStartDate = new DataTable.PlainTextColumn("Start Date", function (data) {
        return FormatUtil.formatDate(data.startDate, "date_standard", "local");
    }).width("9em");
    this.tableCouponDefination.column(colStartDate);
    var colExpireDate = new DataTable.GenericColumn("Expiration Date", function (data) {
        return "<span class='" + (moment(data.expirationDate).isAfter(new Date(), "day") ? "" : "Expired") + "'>"
                + FormatUtil.formatDate(data.expirationDate, "date_standard", "local") + "</span>";
    }).width("10em");
    colExpireDate.getContentTitle = function (data, row, col) {
        return data.expirationDate;
    }
    this.tableCouponDefination.column(colExpireDate);
    var colDiscount = new DataTable.PlainTextColumn("Discount", function (data) {
         return (data.percent > 0 ? data.percent + "%" : Util.toCurrency(data.amount));
    }).width("7.5em");
    colDiscount.dataType = "currency";
    colDiscount.getContentTitle = function (data, row, col) {
        return "";
    }
    this.tableCouponDefination.column(colDiscount);
    var actions = [ {
            id: "edit", type: "pencil", title: "Edit Coupon",
            isApplicable: function(item) {
                return true;
            },
            handler: function (item) {
                
            }
        },{
            id: "delete", type: "delete", title: "Delete Coupon",
            isApplicable: function(item) {
                return true;
            },
            handler: function (item) {
                
            }
        }];
    var actionCol = new DataTable.ActionColumn(actions);
    actionCol.title = "";
    if (!this.isViewOnly) this.tableCouponDefination.column(actionCol.width("6.5em"));
    // this.tableCouponDefination.selector(true, false);
    this.tableCouponDefination.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    setTimeout(function() {
        thiz.tableCouponDefination.setup();
        thiz.tableCouponDefination.domLoaded = true;
    }, 50);
};

ClassSettingGeneralWidget.prototype.createDomActionColumn = function() {
    return Dom.newDOMElement({
        _name: "hbox",
        _children: [
            {
                _name: "a",
                class: "ButtonEdit",
                _children: [
                    {
                        _name: "icon",
                        class: "pencil",
                    }, {
                        _name: "span",
                        _text: "Edit"
                    }
                ]
            }, {
                _name: "a",
                class: "ButtonDelete",
                _children: [
                    {
                        _name: "icon",
                        class: "minus-circle",
                    }, {
                        _name: "span",
                        _text: "Remove"
                    }
                ]
            }
        ]
    });
};

ClassSettingGeneralWidget.prototype.getCurrentSettingData = function() {
    var data = {
        id: this.id,
        receiveEmail: this.itemReceiptEmail.value,
        receiveName: this.itemReceiptName.value,
        defaultMakeups: this.itemMakeups.value,

        creditCardAccepted: this.ckbCreditCardAccepted.checked,
        checkAccepted: this.ckbCheckAccepted.checked,
        cashAccepted: this.ckbCashAccepted.checked,
        checkName: this.itemRemittanceName.value,
        checkAddress: this.itemCheckAddress.value,
        checkCity: this.itemCheckCity.value,
        checkState: this.itemCheckState.value,
        checkZip: this.itemCheckZipCode.value,
        checkPhone: this.itemCheckPhone.value,

        autoCheckWaitlistPayment: this.selectWaitlist.getSelectedItem().value,
        instEmailStd: this.selectSendInstuctorEmail.getSelectedItem().value,
        showClothing4Reg: this.showClothing4Reg.getSelectedItem().value,
        //showInsuranceEmergency: this.showInsuranceEmergency.getSelectedItem().value,
        hideDaysOffered: this.ckbHideDaysOffered.checked,
        hideTimeOffered: this.ckbHideTimeOffered.checked,
        hideInstructor: this.ckbHideInstructorOffered.checked,
        expandedSubProg: this.ckbDisplaySubprogExpanded.checked,
        
        hideAge: this.ckbHideAge.checked,
        hideGender: this.ckbHideGender.checked,
        hideLocation: this.ckbHideLocations.checked,
        hideDayOfWeek: this.ckbHideDayOfWeek.checked,
        hideSession: this.ckbHideSession.checked,
        enableGroupAttendanceNote: this.groupAttendanceNoteCombo.getSelectedItem().value,
        enableClassRooomAttendanceNote: this.classRoomAttendanceNoteCombo.getSelectedItem().value,
        classRoomAttendanceNoteLabel: this.classRoomNoteLabelInput.value
    };
    if (this.ckbFamilyAnnualRegistration.checked && this.selectFamilyChartOfAccount.getSelectedItem().id > 0) {
        data.familyAnnualCoAId = this.selectFamilyChartOfAccount.getSelectedItem().id;
        data.familyAnnualFeeAmount = this.itemFamilyAnnualFeeAmount.getValue();
    }
    if (this.ckbStudentAnnualRegistration.checked && this.selectStudentChartOfAccount.getSelectedItem().id > 0) {
        data.studentAnnualFeeAmount = this.itemStudentAnnualFeeAmount.getValue();
        data.studentAnnualCoAId = this.selectStudentChartOfAccount.getSelectedItem().id;
    }

    data.enableRegDiscount = this.ckbRegDiscount.checked;
    data.mulStudentsDiscountCoAId = this.selectMultiStudentsAccountChart.getSelectedItem().id;
    data.multiStudentDiscApp = this.multiStudentDiscAppCombo.getSelectedItem().key;
    data.multiStudentDiscOrder = this.multiStudentDiscOrderCombo.getSelectedItem().key;
    data.enableClassDiscount = this.ckbClassDiscount.checked;
    data.mulClassesDiscountCoAId = this.selectMultiClassesAccountChart.getSelectedItem().id;
    data.multiClassDiscApp = this.multiClassDiscAppCombo.getSelectedItem().key;
    data.multiClassDiscOrder = this.multiClassDiscOrderCombo.getSelectedItem().key;
    data.requireAccountBalancePayoff = this.ckbRequireAccountBalancePayoff.checked;
    data.costumeModuleNameCode = this.costumeModuleNameCombo.getSelectedItem().key;
    data.classPaymentTransferChargeCategoryId = this.classTransferCombo.getSelectedItem() ? this.classTransferCombo.getSelectedItem().id : 0;
    data.classTransferNotPaidChargeCategoryId = this.classTransferNotPaidCombo.getSelectedItem() ? this.classTransferNotPaidCombo.getSelectedItem().id : 0;

    if (this.allowClassPaymentPlan) {
        data.studentAnnualFeeMultiDiscEnable = this.ckbApplyMultiAthleteDiscount.checked;
        data.requireElectronicPayment = this.ckbElectronicPaymentRequired.checked;
    } else {
        data.studentAnnualFeeMultiDiscEnable = false;
    }
    if (this.allowAutoWaitlist) {
        data.enableAutoWaitlist = this.ckbAutoWaitlist.checked;
    } else {
        data.enableAutoWaitlist = false;
    }
    data.instructorConflictCheckingEnabled = this.ckbInstructorConflictChecking.checked;
    data.receiveEmailWaitlist = this.itemReceiptEmailWaitlist.value;
    data.receiveNameWaitlist = this.itemReceiptNameWaitlist.value;
    data.timeRetainingRegistration = this.timeRetainingRegistration.value;
    return data;
};

ClassSettingGeneralWidget.prototype.getCurrentInputValues = function() {
    var data = this.getCurrentSettingData();
    data.annualReg = this.ckbStudentAnnualRegistration.checked;
    data.annualFamilyReg = this.ckbFamilyAnnualRegistration.checked;
    data.checkAccepted = this.ckbCheckAccepted.checked;
    data.cashAccepted = this.ckbCashAccepted.checked;
    data.hasCoupon = this.ckbCoupon.checked;
    data.electronicPaymentRequired = this.ckbElectronicPaymentRequired.checked;
    return data;
};

ClassSettingGeneralWidget.prototype.save = function() {
    var thiz = this;
    if (!ValidationManager.run(this.validationRules)) return false;
    if (!this.modified) return;
    var data = this.getCurrentSettingData();
    var updateAdminSetting = function() {
        if (thiz.ckbRegDiscount.checked == false) {
            thiz.tableStudentsDiscountDefination.setItems([]);
        }
        if (thiz.ckbClassDiscount.checked == false) {
            thiz.tableClassesDiscountDefination.setItems([]);
        }
        $classAdminService.updateAdminSetting(data, function() {
            SnackBar.show("Admin Setting was saved");
            thiz.requestSettingData();
        }, function(error) {
            console.error("Fail to update Admin Setting with error: ", error);
        });
    }

    if (this.ckbCoupon.checked == false && this.tableCouponDefination.getItems() && this.tableCouponDefination.getItems().length > 0) {
        this.tableCouponDefination.setItems([]);
        $classMetaService.deleteAllCouponInTeam(function(data) {
            console.log("All Coupon were deleted successfully.");
            updateAdminSetting();
        }, function(error) {
            console.error("Fail to delete Coupon data.");
        });
    } else {
        updateAdminSetting();
    }
};

ClassSettingGeneralWidget.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    // do something
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel();
                return false;
            }
        }
    ]
};

ClassSettingGeneralWidget.prototype.showUnsavedNotify = function() {
    this.headerStatus.textContent = "Unsaved Changes";
    Dom.addClass(this.headerStatus, "Danger");
    this.footerStatus.textContent = "Unsaved Changes";
    Dom.addClass(this.footerStatus, "Danger");
    this.buttonHCancel.disabled = false;
    this.buttonHSave.disabled = false;
    this.buttonFCancel.disabled = false;
    this.buttonFSave.disabled = false;
};

ClassSettingGeneralWidget.prototype.clearUnsavedNotify = function() {
    this.headerStatus.textContent = "Unmodified";
    Dom.removeClass(this.headerStatus, "Danger");
    this.footerStatus.textContent = "Unmodified";
    Dom.removeClass(this.footerStatus, "Danger");
    this.buttonHCancel.disabled = true;
    this.buttonHSave.disabled = true;
    this.buttonFCancel.disabled = true;
    this.buttonFSave.disabled = true;
};

ClassSettingGeneralWidget.prototype.performCancel = function() {
    var thiz = this;
    if (!this.modified) return;
    Dialog.confirm("Discard changes?", "Are you sure you want to discard the unsaved changes?", "Discard changes", function () {
        thiz.requestSettingData();
    }, "Cancel");
};

ClassSettingGeneralWidget.prototype.renderDiscountContent = function () {
    if (this.allowClassPaymentPlan) {
        Dom.addClass(this.studenClass, "AllowClassPaymentPlan");
        Dom.addClass(this.discountHeader , "Hidden");
        Dom.addClass(this.discountHintBox , "Hidden");
        Dom.addClass(this.discountContent , "Hidden");
    } else {
        Dom.hide(this.applyMultiAthleteDiscountWrapper);
        Dom.removeClass(this.discountHeader , "Hidden");
        Dom.removeClass(this.discountHintBox , "Hidden");
        Dom.removeClass(this.discountContent , "Hidden");
    }
};

ClassSettingGeneralWidget.prototype.toggleAutoWaitlist = function () {
    var enableAutoWaitlist = this.ckbAutoWaitlist.checked;
    if (enableAutoWaitlist) {
        this.itemReceiptEmailWaitlist.removeAttribute("disabled");
        this.itemReceiptNameWaitlist.removeAttribute("disabled");
        this.timeRetainingRegistration.removeAttribute("disabled");
    } else {
        this.itemReceiptEmailWaitlist.setAttribute("disabled", "disabled");
        this.itemReceiptNameWaitlist.setAttribute("disabled", "disabled");
        this.timeRetainingRegistration.setAttribute("disabled", "disabled");
    }
};

ClassSettingGeneralWidget.prototype.hideAnnualFeeSetting = function () {
    Dom.addClass(this.annualFeeHeader, "Hidden");
    Dom.addClass(this.annualFeeContent, "Hidden");
};

ClassSettingGeneralWidget.prototype.showClassPaymentTransferToolTip = function (event) {
    if (!event || !event.target) return;
    var message;
    if (event.target == this.chargeCategoryPayment) {
        message = "Specifies the charge category for credits created when payments are transferred to a new class. If set to \"Default\" the charge category of the first charge item is used.";
    } else if (event.target == this.chargeCategoryUnpaid) {
        message = "Specifies the charge category for credits created when a transfer occurs with unpaid charges. If set to \"Default\" the charge category of the first charge item is used.";
    }
    if (!message) return;

    var popupContent = Dom.newDOMElement({
        _name: "span",
        _text: message,
        style: "width: 42em; display: block; padding: 0em 1em; font-style: italic"
    });
    this.classPaymentTransferToolTip = new Popup();
    this.classPaymentTransferToolTip.setContentFragment(popupContent);
    if (this.classPaymentTransferToolTip != null) this.classPaymentTransferToolTip.kill();
    this.classPaymentTransferToolTip.show(event.target, "left-inside", "top", 10, 5, true);
};

ClassSettingGeneralWidget.prototype.hideClassPaymentTransferToolTip = function (event) {
    if (!event || !event.target) return;

    if (event.target == this.chargeCategoryPayment || event.target == this.chargeCategoryUnpaid) {
        if (this.classPaymentTransferToolTip != null) this.classPaymentTransferToolTip.kill();
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassSettingSizesWidget.js";

function ClassSettingSizesWidget() {
    BaseTemplatedWidget.call(this);
    this.title = "Member Sizing Settings";

    this.bind("click", this._saveChanges.bind(this), this.saveButton);
    this.bind("click", this._revertChanges.bind(this), this.resetButton);
    this.bind("click", this._clickHandler);
}
__extend(BaseTemplatedWidget, ClassSettingSizesWidget);

ClassSettingSizesWidget.prototype.onAttached = function(first) {
    if (!first) return;
    this._setupSizeDataTable();
    this._initializePaginator();
    this._installInfoTip();
    $costumeManagementService.getCostumeSizingSettingInfo(function(rs) {
        this.setup(rs);
    }.bind(this), function(error) {
        Dialog.error(error.message);
    }, "Loading...");
}

ClassSettingSizesWidget.prototype.getCurrentInputs = function() {
    return {
        id: TEAM_INFO.id,
        parentsSizingToolEnabled: this.enableParentsSizingTool.checked,
        sizingSettings: this._getMemberSizingSettings()
    }
}

ClassSettingSizesWidget.prototype.isDataChanged = function() {
    var currentInputs = this.getCurrentInputs();
    var isChanged = JSON.stringify(currentInputs) !== this._snapshot;
    return isChanged;
};

ClassSettingSizesWidget.prototype.setup = function(setting) {
    this._origin = setting;
    this.enableParentsSizingTool.checked = setting.parentsSizingToolEnabled;
    this.paginator.refresh();
    this.takeSnapshot(this.getCurrentInputs());
}

ClassSettingSizesWidget.prototype.takeSnapshot = function(target) {
    this._snapshot = JSON.stringify(target);
};

ClassSettingSizesWidget.prototype._installInfoTip = function() {
    var thiz = this;

    InfoTip.install(this.sizeDataTable.node(), {
        match: function (node) {
            return Dom.isChildOf(thiz.sizeDataTable.node(), node) && Dom.hasClass(node, "required-tooltip");
        },
        getMessage: function (target) {
            return "Required to enable sizing tool.";
        },
        type: "info"
    });
}

ClassSettingSizesWidget.prototype._revertChanges = function() {
    if (!this.isDataChanged()) return;
    this.setup(this._origin);
}

ClassSettingSizesWidget.prototype._saveChanges = function() {
    if (!this.isDataChanged()) return;
    var inputs = this.getCurrentInputs();
    if (!this._enabledInMobileSizingToolIsSet(inputs.sizingSettings)) {
        SnackBar.show("You must have at least one measurement enabled in the Mobile Sizing Tool.");
    } else {
        $costumeManagementService.saveCostumeSizingSettingInfo(inputs, function(rs) {
            this.setup(rs);
            SnackBar.show("Member sizing settings are saved successfully.");
        }.bind(this), function(error) {
            SnackBar.show(error.message);
        }, "Loading...");
    }
}

ClassSettingSizesWidget.prototype._enabledInMobileSizingToolIsSet = function(sizingSettings) {
    return sizingSettings.some(function(setting) {
        return setting.enabledInMobileSizingTool == true;
    });
}

ClassSettingSizesWidget.prototype._getMemberSizingSettings = function() {
    var sizeTableRows = this.node().querySelectorAll(
    ".SizeDataTableContainer tr.FirstRow, .SizeDataTableContainer tr.TableRow, .SizeDataTableContainer tr.LastRow");

    var enabledCheckbox, requiredCheckbox, setting;
    var settings = [];
    var displayOrder = 0;

    sizeTableRows.forEach(function(row) {
        setting = {}

        enabledCheckbox = row.querySelector(".EnabledInMobileCheckbox");
        requiredCheckbox = row.querySelector(".RequiredToCompleteCheckbox");
        setting = {
           id: parseInt(enabledCheckbox.getAttribute("value")),
           enabledInMobileSizingTool: enabledCheckbox.checked,
           requiredToCompleteSizing: requiredCheckbox.checked,
           displayOrder: displayOrder
        }

        settings.push(setting);
        displayOrder = displayOrder + 1;
    });

    return settings;
}

ClassSettingSizesWidget.prototype._setupSizeDataTable = function() {
    var thiz = this;
    var nameCol = new DataTable.DomNodeColumn("Size/Measurement Name", function (item) {
        var displayName = {
            _name: "span",
            _html: item.displayName
        }
        var infoIcon = {
            _name: "icon",
            "class": "information required-tooltip",
            "title": "Required to enable sizing tool."
        }

        var childNodes = [displayName];
        if (item.displayName == "Girth") childNodes.push(infoIcon);

        return {
          _name: "div",
          _children: childNodes
        }
    });
    this.sizeDataTable.column(nameCol);

    // Enabled in Mobile Sizing Tool?
    var enabledInMobileSizingToolCol = new DataTable.DomNodeColumn("Enabled in Mobile Sizing Tool?", function (item) {
        var domElement = {
            _name: "input",
            "type": "checkbox",
            "class": "EnabledInMobileCheckbox",
            "value": item.id
        }
        if (item.enabledInMobileSizingTool) domElement.checked = "checked";

        return Dom.newDOMElement(domElement);
    }).width("215px");
    this.sizeDataTable.column(enabledInMobileSizingToolCol);

    // Required to Complete Sizing?
    var requiredToCompleteSizingCol = new DataTable.DomNodeColumn("Required to Complete Sizing?", function (item) {
        var domElement = {
            _name: "input",
            "type": "checkbox",
            "class": "RequiredToCompleteCheckbox",
            "value": item.id
        }
        if (item.requiredToCompleteSizing) domElement.checked = "checked";

        return Dom.newDOMElement(domElement);
    }).width("215px");
    this.sizeDataTable.column(requiredToCompleteSizingCol);

    // Display Order
    var dragAction = {
        icon: "DragButton",
        run: function (item, fc, e) {
        }
    };
    var actionsColumnHandler = this.sizeDataTable.createActionColumnHandler(dragAction);
    var actionsCol = new DataTable.GenericDomColumn("Display Order", actionsColumnHandler).width("120px");
    this.sizeDataTable.column(actionsCol);

    this.sizeDataTable.selector(false, false, true);
    this.sizeDataTable.setup();

    this._setupDragAndDrop();
}

ClassSettingSizesWidget.prototype._setupDragAndDrop = function() {
    var thiz = this;

    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER();
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target) return null;
        return target;
    }.bind(this);

    this.dnd = new DragAndDropManager()
        .source(this.sizeDataTable.body)
        .anchor(function (dragNode) {
            return Dom.hasClass(dragNode, "DragButton");
        })
        .itemInfo(function (dragNode) {
            var node = Dom.findParentWithClass(dragNode, "DTEvenSection");
            if (!node) return null;
            return {
                element: node,
                data: DataTable.getRowData(node)
            };
        })
        .destination(this.sizeDataTable.body)
        .canDrop(function (data) {
            return !this._disabled;
        }.bind(this))
        .dropAt(dropTargetFinderFunction)
        .setup();
    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "DraggableItemImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        var node =  Dom.newDOMElement({
            _name: "tr",
            "class": "DropHint",
            _children: [
                {
                    _name: "td",
                    colspan: 8
                }
            ]
        });
        return node;
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        this._invalidateRowsOfTable();
    }.bind(this);
}

ClassSettingSizesWidget.prototype._invalidateRowsOfTable = function() {
    var trs = this.sizeDataTable.body.childNodes;
    var datas = Array.prototype.map.call(trs, function(tr) {
        var data = DataTable.getRowData(tr);
        if (data) {
            var enabledCheckbox = tr.querySelector(".EnabledInMobileCheckbox");
            var requiredCheckbox = tr.querySelector(".RequiredToCompleteCheckbox");
            data.enabledInMobileSizingTool = enabledCheckbox && enabledCheckbox.checked;
            data.requiredToCompleteSizing = requiredCheckbox && requiredCheckbox.checked;
        }
        return data;
    });
    this.sizeDataTable.setItems(datas);
};

ClassSettingSizesWidget.prototype._initializePaginator = function () {
    var thiz = this;
    this.paginator = new InfiniteScrollPaginator();
    this.paginator._shouldLoadMore = function () {
        return thiz.paginator.renderer.isNearEnd() && thiz.paginator._isMoreItemsAvailable();
    }
    this.paginator._isMoreItemsAvailable = function() {
        return thiz.paginator.lastLoadedIndex >= 0 && ((thiz.paginator.lastLoadedIndex + 1) * thiz.paginator.pageSize < thiz.paginator.total);
    }
    this.paginator.setup({
        showPaginator : true,
        withoutStatus : true,
        onPageLoaded : function(p, count) {
        },
        comparer : function(a, b) {
            return a.transaction_id == b.transaction_id;
        },
        useButtons : false,
        avoidPageSizeRecalculation : true
    });
    this.paginator.control(this.sizeDataTable);
    this.paginator.setSource(this._getPaginatorSource());
}

ClassSettingSizesWidget.prototype._getPaginatorSource = function () {
    var thiz = this;
    return {
        order: thiz._getDefaultPaginatorOrder(),
        terms: "",
        getOrder: function () {
            return this.order;
        }.bind(this),
        setOrder: function (order) {
            this.order = order;
        }.bind(this),
        loadPage: function(pageIndex, pageSize, handler, failed) {
            var data = Util.getProperty(this._origin, "sizingSettings", {result: [], count: 0});
            handler(data.result, data.count);
        }.bind(this)
    }
}

ClassSettingSizesWidget.prototype._getDefaultPaginatorOrder = function () {
    return {
        name: "displayOrder",
        asc: true,
        ignoreCase: true
    };
}
ClassSettingSizesWidget.prototype._clickHandler = function (e) {
    var target = Dom.getTarget(e);

    if (Dom.hasClass(target, "RequiredToCompleteCheckbox")) {
        this._handleRequiredToCompleteCheckbox(target);
    } else if (Dom.hasClass(target, "EnabledInMobileCheckbox")) {
        this._handleEnabledInMobileCheckbox(target);
    }
}

ClassSettingSizesWidget.prototype._handleEnabledInMobileCheckbox = function (target) {
    var tr = Dom.findParentByTagName(target, "tr");
    var enabledInMobileCheckbox = tr.querySelector(".RequiredToCompleteCheckbox");

    if (enabledInMobileCheckbox.checked && !target.checked) {
        SnackBar.show("You cannot disable this measurement in the Mobile Sizing Tool as it’s required to complete sizing.");
        target.checked = true;
    }
}

ClassSettingSizesWidget.prototype._handleRequiredToCompleteCheckbox = function (target) {
    var tr = Dom.findParentByTagName(target, "tr");
    var enabledInMobileCheckbox = tr.querySelector(".EnabledInMobileCheckbox");

    if (target.checked) {
        enabledInMobileCheckbox.checked = true;
    }
}

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ClassSettingWidget.js";

function ClassSettingWidget(opts) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.DEFAULT_TAB_RENDERERS = {
        "GeneralTabPane": function (thiz) {
            thiz.generalTabPaneContent.innerHTML = "";
            return new ClassSettingGeneralWidget().into(thiz.generalTabPaneContent);
        },
        "DiscountsTabPane": function (thiz) {
            thiz.discountsTabPaneContent.innerHTML = "";
            return new DiscountSettingWidget().into(thiz.discountsTabPaneContent);
        },
        "RatesTabPane": function (thiz) {
            thiz.ratesTabPaneContent.innerHTML = "";
            return new RatePlanSettingWidget().into(thiz.ratesTabPaneContent);
        },
        "AnnualFeesTabPane": function (thiz) {
            thiz.annualFeesTabPaneContent.innerHTML = "";
            return new AnnualFeesSettingWidget().into(thiz.annualFeesTabPaneContent);
        },
        "ProgramTabPane": function (thiz) {
            thiz.programTabPaneContent.innerHTML = "";
            return new ProgramComponent().into(thiz.programTabPaneContent);
        },
        "SubProgramTabPane": function (thiz) {
            thiz.subProgramTabPaneContent.innerHTML = "";
            return new SubProgramComponent().into(thiz.subProgramTabPaneContent);
        },
        "SessionTabPane": function (thiz) {
            thiz.sessionTabPaneContent.innerHTML = "";
            return new SessionComponent().into(thiz.sessionTabPaneContent);
        },
        "StartDropPoliciesTabPane": function (thiz) {
            thiz.startDropPoliciesTabPaneContent.innerHTML = "";
            return new StartDropPoliciesSettingWidget().into(thiz.startDropPoliciesTabPaneContent);
        },
        "ZoneTabPane": function (thiz) {
            thiz.zoneTabPaneContent.innerHTML = "";
            return new ZoneComponent().into(thiz.zoneTabPaneContent);
        },
        "NoClassesSchedulesTabPane": function (thiz) {
            thiz.noClassesSchedulesTabPaneContent.innerHTML = "";
            // widget.__ensureNamespaceLoaded("noclassschedules", function (noclassschedules) {
                return new NoClassSchedule().into(thiz.noClassesSchedulesTabPaneContent);
            // });    
        },
        "SkillsTabPane": function (thiz) {
            thiz.skillsTabPaneContent.innerHTML = "";
            return new SkillsComponent().into(thiz.skillsTabPaneContent);
        },
        "LocationTabPane": function (thiz) {
            thiz.locationTabPaneContent.innerHTML = "";
            return new LocationComponent().into(thiz.locationTabPaneContent);
        },
        "WaiverTabPane": function (thiz) {
            thiz.waiverTabPaneContent.innerHTML = "";
            return new MembershipWaiversComponent().into(thiz.waiverTabPaneContent);
        },
        "PagesTabPane": function (thiz) {
            thiz.pagesTabPaneContent.innerHTML = "";
            return "PagesSettingWidget";
        },
        "AgreementTabPane": function (thiz) {
            return "AgreementList";
        },
        "CostumeVendorsTabPane": function (thiz) {
            thiz.costumeVendorsTabPaneContent.innerHTML = "";
            return new ClassSettingCostumeVendorsWidget().into(thiz.costumeVendorsTabPaneContent);
        },
        "SizesTabPane": function (thiz) {
            thiz.sizesTabPaneContent.innerHTML = "";
            return new ClassSettingSizesWidget().into(thiz.sizesTabPaneContent);
        },
        "CouponTabPane": function (thiz) {
            thiz.couponTabPaneContent.innerHTML = "";
            return new CouponComponent().into(thiz.couponTabPaneContent);
        }
    };

    this.bind("e:TabChange", function (event) {
        if (!thiz._initialized) return;
        thiz.renderActiveTabPane();
        event.stopPropagation();
    }, this.membershipTabPane.node());

    this.navigationModule = this.membershipTabPane.getNavigationModule();
}
__extend(BaseTemplatedWidget, ClassSettingWidget);

ClassSettingWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    if (typeof(AdminConsole) == "undefined" || !this.findUpward(AdminConsole)) {
        CommonNavigation.setRoot(this.navigationModule);
    }
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
        thiz.renderClassSetting();
    } else {
        $classAdminService.getAccountInfo(function (res) {
            window.LOGIN_INFO.allowClassPaymentPlan = res.allowClassPaymentPlan;
            window.LOGIN_INFO.allowStartDropDates = res.allowStartDropDates;
            window.LOGIN_INFO.allowWaiver = res.allowWaiver;
            window.LOGIN_INFO.allowRatePlan = res.allowRatePlan;
            thiz.renderClassSetting();
        }, function (err) {});
    }
    };

ClassSettingWidget.prototype.renderClassSetting = function () {
    var agreementTabHeader = this.membershipTabPane.findHeaderByName("agreements"),
        pagesSettingTabHeader = this.membershipTabPane.findHeaderByName("pages"),
        waiverTabHeader = this.membershipTabPane.findHeaderByName("waiver"),
        startDropDateHeader = this.membershipTabPane.findHeaderByName("startDropPolicies"),
        ratePlanTabHeader = this.membershipTabPane.findHeaderByName("rates"),
        discountTabHeader = this.membershipTabPane.findHeaderByName("discounts");
    if (!window.LOGIN_INFO.allowWaiver) {
        if (agreementTabHeader) this.membershipTabPane._removeTabByHeader(agreementTabHeader);
        if (pagesSettingTabHeader) this.membershipTabPane._removeTabByHeader(pagesSettingTabHeader);
    } else {
        if (waiverTabHeader) this.membershipTabPane._removeTabByHeader(waiverTabHeader);
    }
    if (!window.LOGIN_INFO.allowStartDropDates) {
        if(startDropDateHeader) this.membershipTabPane._removeTabByHeader(startDropDateHeader);
    }
    if (!window.LOGIN_INFO.allowRatePlan) {
        if(ratePlanTabHeader) this.membershipTabPane._removeTabByHeader(ratePlanTabHeader);
    }
    if (!window.LOGIN_INFO.allowClassPaymentPlan) {
        if(discountTabHeader) this.membershipTabPane._removeTabByHeader(discountTabHeader);
    }
    if (!TEAM_INFO.enabledFeatures.includes("costume-management")) {  // Sizes
        this.membershipTabPane.headers.forEach(function(header) {
            if (header.getAttribute("tab-key") == "costumeVendors") Dom.hide(header);
            if (header.getAttribute("tab-key") == "sizes") Dom.hide(header);
        });
    } else {
        this.membershipTabPane.setTabTitleByName("costumeVendors", String.format("{0} Vendors", window.LOGIN_INFO.costumeModuleName || "Costumes"));
    }
    
    this._invalidateTabsByPermissions();
    this._initialized = true;
};

ClassSettingWidget.prototype._invalidateTabsByPermissions = function () {
    var tabs = this.membershipTabPane.getTabs();
    var canViewGeneralSettings = ClassAuthUtils.canViewGeneralSettings(window.LOGIN_INFO);
    var canViewOtherSettings = ClassAuthUtils.canManageWithoutGeneralSetting(window.LOGIN_INFO);
    var thiz = this;
    tabs.forEach((tab, i) => {
        var header = tab.header;
        var tabKey = Dom.getAttributeAsString(header, "tab-key");
        var validTab = ((tabKey == "general" || tabKey == "annualFees") && canViewGeneralSettings) || ((tabKey != "general" && tabKey != "annualFees") && canViewOtherSettings);
        if (!validTab) thiz.membershipTabPane._removeTabByHeader(header);
    });
};

ClassSettingWidget.prototype.renderActiveTabPane = function () {
    var activeTab = this.membershipTabPane.getActiveTabPane();
    if(!activeTab) return;
    for(var tab in this.DEFAULT_TAB_RENDERERS){
        if(Dom.hasClass(activeTab, tab)){
            this.tabToChange = tab;
            this.moveToTab(tab, activeTab);
            return;
        }
    }
};

ClassSettingWidget.prototype.moveToTab = function(tab, activeTab) {
    var thiz = this;
    if (!tab || !this.DEFAULT_TAB_RENDERERS[tab]) tab = "GeneralTabPane";
    var f = this.DEFAULT_TAB_RENDERERS[tab];
    var widgetComponent = f(this);
    if (widgetComponent == "PagesSettingWidget") {
        thiz.pagesTabPaneContent.innerHTML = "";
        widget.__ensureNamespaceLoaded("waiver", function (waiver) {
            var pagesSettingWidget = new waiver.PagesSettingWidget().into(thiz.pagesTabPaneContent);
            if (pagesSettingWidget.getNavigationModule) {
                activeTab[TabPane.KEY_NAVIGATION_MODULE] = pagesSettingWidget.getNavigationModule();
            }
        });
    } else if (widgetComponent == "AgreementList") {
        thiz.agreementNoticeLabel.innerHTML = "Agreements has moved to " + FormatUtil.term("Org Tools") + " in the menu - ";
        thiz.agreementLink.setAttribute("href", "/team/" + ADMIN_CONTEXT.teamAlias + "/controller/cms/admin/index#/agreements");
        activeTab[TabPane.KEY_NAVIGATION_MODULE]  = CommonNavigation.newUnnavigatableModule();
    } else {
        if (widgetComponent.getNavigationModule) {
            activeTab[TabPane.KEY_NAVIGATION_MODULE] = widgetComponent.getNavigationModule();
        }
    }
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        ClientPropertyUtil.invalidateElements(thiz.node(), cm.ModuleData.__propertySpec);
    });
};

ClassSettingWidget.prototype.getNavigationModule = function () {
    return this.navigationModule;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ConfirmCloneClassDialog.js";

function ConfirmCloneClassDialog() {
    Dialog.call(this);
    var thiz = this;
    
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.clonedClassTitle, "Class name is a required field");
}

__extend(Dialog, ConfirmCloneClassDialog);

ConfirmCloneClassDialog.prototype.setup = function (options) {
    this.options = options;
    this.title = "Confirm";
    this.clonedClassTitle.value = options.clonedClassTitle;
};

ConfirmCloneClassDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [        
        {
            type: "accept", title: "Clone & Show New Class",
            run: function () {
                thiz.cloneButtonClickHandler(true);
            }
        },
        {
            type: "accept", title: "Clone",
            isApplicable: function () {
                return thiz.options.showCloneButton;
            },            
            run: function () {
                thiz.cloneButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

ConfirmCloneClassDialog.prototype.cloneButtonClickHandler = function (showAfterClone) {
    if (!ValidationManager.run(this.validationRules)) return;
    this.close({clonedClassTitle: this.clonedClassTitle.value, showAfterClone: showAfterClone});
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/CouponEditDialog_old.js";

function CouponEditDialog_old() {
    ModificationWatchDialog.call(this);
    this.bind("change", this.validateDiscountInput.bind(this), this.radioPercentage);
    this.bind("change", this.validateDiscountInput.bind(this), this.radioDollarAmount);
    this.isReadonly = false;
}
__extend(ModificationWatchDialog, CouponEditDialog_old);

CouponEditDialog_old.prototype.hasInputValuesChanged = function(values) {
    return this.isReadonly ? false : this.__base(values).hasInputValuesChanged.apply(this);
};

CouponEditDialog_old.prototype.setup = function(data) {
    var thiz = this;
    this.setDatePickerMinDate();
    this.selectAccountChart.renderer = function(item) {
        return item.name;
    }
    this.selectAccountChart.comparer = function(selected, item) {
        return selected.id == item.id;
    }
    this.selectAccountChart.setItems(data.coaSettingList);
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        Dom.addClass(this.selectAccountChart.node().parentNode, "Hidden");
    }
    if (data.id != 0) {
        this.id = data.id;
        this.title = "Update Coupon";
        this.loadCouponData(data.id);
    } else {
        this.title = "Add Coupon";
        // this.radioDollarAmount.checked = true;
        // this.itemPercentage.disabled = true;
        this.setSnapshotInputValues(this.getCurrentInputValues());
        this.clearUnsavedNotify();
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemTitle, "Please input 'Coupon Title'")
        .required(this.itemCode, "Please input 'Coupon Code'")
        .custom(new RequiredRule(this.itemStartDate, "Please input date with format 'MM/DD/YYYY'"), function(rule) {
            return rule.input.getDate();
        })
        .custom(new RequiredRule(this.itemExpirationDate, "Please input date with format 'MM/DD/YYYY'"), function(rule) {
            return rule.input.getDate();
        })
        .required(this.itemPercentage, "Input value must be positive value", Condition.checked(this.radioPercentage))
        .min(this.itemPercentage, 0, true, "Input value must be positive value", Condition.checked(this.radioPercentage))
        .required(this.itemDollarAmount, "Input value must be positive value", Condition.checked(this.radioDollarAmount))
        .min(this.itemDollarAmount, 0, true, "Input value must be positive value", Condition.checked(this.radioDollarAmount));
}

CouponEditDialog_old.prototype.validateDiscountInput = function(event) {
    if (this.radioPercentage.checked) {
        Dom.addClass(this.groupPercentage, "Activate");
        Dom.removeClass(this.groupAmount, "Activate");
        // this.itemPercentage.disabled = false;
        // this.itemDollarAmount.disabled = true;
    } else {
        Dom.removeClass(this.groupPercentage, "Activate");
        Dom.addClass(this.groupAmount, "Activate");
        // this.itemPercentage.disabled = true;
        // this.itemDollarAmount.disabled = false;
    }
}

CouponEditDialog_old.prototype.loadCouponData = function(id) {
    var thiz = this;
    $classMetaService.getCouponById(id, function(data) {
        if (data) {
            thiz.itemTitle.value = data.title;
            thiz.itemCode.value = data.code;
            thiz.itemLimitAmount.setValue(data.limitAmount);
            thiz.selectAccountChart.selectItemIfContains({id: data.coaId});
            thiz.itemStartDate.setDate(data.startDate);
            thiz.itemExpirationDate.setDate(data.expirationDate);
            if (data.percent) {
                thiz.radioPercentage.checked = true;
                thiz.itemPercentage.value = data.percent;
                // thiz.itemDollarAmount.disabled = true;
            } else {
                thiz.radioDollarAmount.checked = true;
                thiz.itemDollarAmount.setValue(data.amount);
                // thiz.itemPercentage.disabled = true;
            }
            var singleUse = data.singleUse;
            thiz.cbxSingleUse.checked = singleUse;
            thiz.redeemed_date.innerHTML = singleUse && data.dateRedeemed ? " on " + FormatUtil.formatDate(data.dateRedeemed, "date_standard", "local") : "";
            thiz.isReadonly = singleUse && data.redeemedAccountId > 0;
            Dom.toggleClass(thiz.alertMessage,"Hidden", !thiz.isReadonly);
            Dom.emitEvent("change", thiz.cbxSingleUse);
            Dom.emitEvent("change", thiz.radioDollarAmount);
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
        }
    }, function(error) {
        console.error("Fail to get Coupon:", error);
    });
}

CouponEditDialog_old.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES.concat("p:ValueUpdated");
}

CouponEditDialog_old.prototype.getCurrentInputValues = function() {
    return {
        id: this.id ? this.id : 0,
        title: this.itemTitle.value,
        code: this.itemCode.value,
        coaId: this.selectAccountChart.getSelectedItem().id,
        startDate: this.itemStartDate.getDate(),
        expirationDate: this.itemExpirationDate.getDate(),
        amount: this.radioDollarAmount.checked ? parseFloat(this.itemDollarAmount.getValue()) : 0,
        percent: this.radioPercentage.checked ? parseFloat(this.itemPercentage.value) : 0,
        singleUse: this.cbxSingleUse.checked,
        limitAmount: parseFloat(this.itemLimitAmount.getValue())
    }
}

CouponEditDialog_old.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var coupon = this.getCurrentInputValues();
    if (coupon.id > 0) {
        $classMetaService.updateCoupon(coupon, function(data) {
            SnackBar.show("Coupon was saved successfully");
            if (callback) callback(coupon);
        }, function(error) {
            if (error.httpCode != 500) {
                Dialog.alert("Error", error.message);
            } else {
                console.error("Fail to save Coupon Setting with error", error);
            }
        });
    } else {
        $classMetaService.createCoupon(coupon, function(id) {
            SnackBar.show("Coupon was saved successfully");
            coupon.id = id;
            if (callback) callback(coupon);
        }, function(error) {
            if (error.httpCode != 500) {
                Dialog.alert("Error", error.message);
            } else {
                console.error("Fail to create Coupon Setting with error", error);
            }
        });
    }
};

CouponEditDialog_old.prototype.setDatePickerMinDate = function () {
    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.itemStartDate.setMinDate(minDate);
    this.itemExpirationDate.setMinDate(minDate);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/DiscountEditDialog.js";

function DiscountEditDialog() {
    ModificationWatchDialog.call(this);
    this.dao = null;
    this.bind("change", this.validateDiscountInput.bind(this), this.radioPercentage);
    this.bind("change", this.validateDiscountInput.bind(this), this.radioDollarAmount);
}
__extend(ModificationWatchDialog, DiscountEditDialog);

DiscountEditDialog.DISC_TYPE_STUDENT = 10;
DiscountEditDialog.DISC_TYPE_CLASS = 20;

DiscountEditDialog.prototype.setup = function(options) {
    var thiz = this;
    var data = options.data;
    this.coaId = options.coaId;
    this.id = data.id;
    this.type = data.type;
    this.allowClassPaymentPlan = options.allowClassPaymentPlan;
    if (data.type == DiscountEditDialog.DISC_TYPE_CLASS) {
        this.countLabel.innerHTML = "Classes count:";
        this.labelRangeFrom.textContent = "Classes (Minimum 2)";
        this.labelRangeTo.textContent = "Classes";
        this.cutoffDescription.innerHTML = "Athletes with at least this many class registrations will receive this discount on all installments of per-member fees marked as discountable.";
    } else {
        this.countLabel.innerHTML = "Athletes count:";
        this.labelRangeFrom.textContent = "Athletes (Minimum 2)";
        this.labelRangeTo.textContent = "Athletes";
        this.cutoffDescription.innerHTML = "Families with at least this many registered athletes will receive this discount on all installments of per-member fees marked as discountable.";
    }
    if (data.id != 0) {
        this.title = (data.type == DiscountEditDialog.DISC_TYPE_CLASS ? "Edit " + "Multi-Class Discount" : "Edit " + "Multi-Athlete Discount");
        this.loadDiscountData(data);
    } else {
        this.title = (data.type == DiscountEditDialog.DISC_TYPE_CLASS ? "Add " + "Multi-Class Discount" : "Add " + "Multi-Athlete Discount");
        this.setSnapshotInputValues(this.getCurrentInputValues());
        this.clearUnsavedNotify();
    }

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemPercentage, "Input value must be positive value", Condition.checked(this.radioPercentage))
        .min(this.itemPercentage, 0, true, "Input value must be positive value", Condition.checked(this.radioPercentage))
        .max(this.itemPercentage, 100, false, "Input value cannot be greater than 100", Condition.checked(this.radioPercentage))
        .required(this.itemDollarAmount, "Input value must be positive value", Condition.checked(this.radioDollarAmount))
        .min(this.itemDollarAmount, 0, true, "Input value must be positive value", Condition.checked(this.radioDollarAmount))
        .max(this.itemDollarAmount, 30000, true, "Input value cannot be greater than 30000", Condition.checked(this.radioDollarAmount));
        
    if (this.allowClassPaymentPlan) {
        Dom.addClass(this.rangeWrapper, "Hidden");
        Dom.removeClass(this.cutoffWrapper, "Hidden");
        
        this.validationRules.required(thiz.cutoff, "[Cutoff] must be a Number and is required")
                            .min(this.cutoff, 2, false, "[Cutoff] must be at least 2")
                            .max(this.cutoff, 30000, false, "[Cutoff] cannot be greater than 30000");
    } else {
        Dom.addClass(this.cutoffWrapper, "Hidden");
        Dom.removeClass(this.rangeWrapper, "Hidden");
        
        this.validationRules.required(this.itemRangeFrom, "[From] must be a Number and is required")
                            .min(this.itemRangeFrom, 2, false, "[From] must be at least 2")
                            .max(this.itemRangeFrom, 30000, false, "[From] cannot be greater than 30000")
                            .max(this.itemRangeTo, 30000, false, "[To] cannot be greater than 30000")
                            .rule(new GenericRule(this.itemRangeTo, function(input) {
                                var from = parseInt(thiz.itemRangeFrom.value);
                                var to = parseInt(thiz.itemRangeTo.value);
                                return to >= from;
                            }, "[To] must be at least [From]"));
    }
}

DiscountEditDialog.prototype.validateDiscountInput = function(event) {
    if (this.radioPercentage.checked) {
        Dom.addClass(this.groupPercentage, "Activate");
        Dom.removeClass(this.groupAmount, "Activate");
    } else {
        Dom.removeClass(this.groupPercentage, "Activate");
        Dom.addClass(this.groupAmount, "Activate");
    }
}

DiscountEditDialog.prototype.loadDiscountData = function(data) {
    if (data) {
        this.itemRangeFrom.value = data.fromValue;
        this.itemRangeTo.value = data.toValue;
        this.cutoff.value = data.fromValue;
        if (data.amount == 0) {
            this.radioPercentage.checked = true;
            this.itemPercentage.value = data.percent;
        } else {
            this.radioDollarAmount.checked = true;
            this.itemDollarAmount.value = data.amount;
        }
        Dom.emitEvent("change", this.radioDollarAmount);
        this.setSnapshotInputValues(this.getCurrentInputValues());
        this.clearUnsavedNotify();
    }
}

DiscountEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

DiscountEditDialog.prototype.getCurrentInputValues = function() {
    var data = {
        id: this.id ? this.id : 0,
        type: this.type,
        amount: this.radioDollarAmount.checked ? parseFloat(this.itemDollarAmount.value) : 0,
        percent: this.radioPercentage.checked ? parseFloat(this.itemPercentage.value) : 0
    };
    if (this.allowClassPaymentPlan) {
        data.fromValue = parseInt(this.cutoff.value);
        data.toValue = data.fromValue;
    } else {
        data.fromValue = parseInt(this.itemRangeFrom.value);
        data.toValue = parseInt(this.itemRangeTo.value);
    }
    return data;
}

DiscountEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var discount = this.getCurrentInputValues();
    if (discount.id > 0) {
        $classAdminService.updateDiscount(discount, function(data) {
            SnackBar.show("Data was saved successfully");
            if (callback) callback(discount);
        }, function(error) {
            Dialog.alert("Fail to save Discount Setting with error", error.message);
        });
    } else {
        $classAdminService.createDiscount(this.coaId, discount, function(id) {
            SnackBar.show("Data was saved successfully");
            discount.id = id;
            if (callback) callback(discount);
        }, function(error) {
            Dialog.alert("Fail to save Discount Setting with error", error.message);
        });
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/DiscountItemEditDialog.js";

function DiscountItemEditDialog() {
    ModificationWatchDialog.call(this);
    var thiz = this;
    this.bind("change", function () {
        if (thiz.radioDollarAmount.checked) {
            thiz.itemDollarAmount.setEnable(true);
            thiz.itemPercentage.setEnable(false);
            thiz.applyTotalTuition.removeAttribute("disabled");
            thiz.applyRegisteredClass.removeAttribute("disabled");
            if (!thiz.applyTotalTuition.checked && !thiz.applyRegisteredClass.checked) {
                thiz.applyTotalTuition.checked = true;
            }
        }
    }, this.radioDollarAmount);
    this.bind("change", function () {
        if (thiz.radioPercentage.checked) {
            thiz.itemPercentage.setEnable(true);
            thiz.itemDollarAmount.setEnable(false);
            thiz.applyTotalTuition.setAttribute("disabled", "disabled");
            thiz.applyRegisteredClass.setAttribute("disabled", "disabled");
        }
    }, this.radioPercentage);
}
__extend(ModificationWatchDialog, DiscountItemEditDialog);

DiscountItemEditDialog.DISC_TYPE_CLASS = "MultiClassDiscount";
DiscountItemEditDialog.DISC_TYPE_STUDENT = "MultiStudentDiscount";
DiscountItemEditDialog.DISC_APPLIED_EACH_CLASS = "EachRegisteredClass";
DiscountItemEditDialog.DISC_APPLIED_TOTAL_TUITION = "TotalTuition";

DiscountItemEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

DiscountItemEditDialog.prototype.setup = function (options) {
    var thiz = this;
    this.options = options;
    this.discountItemData = options.data;
    var discountType = "Athletes";
    if (this.discountItemData.discountType == DiscountItemEditDialog.DISC_TYPE_CLASS) {
        discountType = "Classes"
        this.countDescription.innerHTML = "Athletes with at least this many class registrations will receive this discount on all installments of per-member fees marked as discountable.";
        Dom.addClass(this.athleteDiscountDollarContent, "Hidden");
    } else {
        this.countDescription.innerHTML = "Families with at least this many registered athletes will receive this discount.";
        Dom.removeClass(this.athleteDiscountDollarContent, "Hidden");
    }
    this.discountType = discountType;
    this.countLabel.innerHTML = discountType + ' count: <span class="required">*</span>';


    if (this.discountItemData.id > 0 || (this.discountItemData.key && this.discountItemData.key.length > 0)) {
        this.title = (this.discountItemData.discountType == DiscountItemEditDialog.DISC_TYPE_CLASS ? "Edit " + "Multi-Class Discount" : "Edit " + "Multi-Athlete Discount");
        this.countInput.value = this.discountItemData.cutoff;
        if (this.discountItemData.amount > 0 || (this.discountItemData.amount == 0 && this.discountItemData.hpercents == 0)) {
            this.radioDollarAmount.checked = true;
            this.radioPercentage.checked = false;
            this.itemDollarAmount.setValue(this.discountItemData.amount);
            this.itemDollarAmount.setEnable(true);
            this.itemPercentage.setEnable(false);
            if (this.discountItemData.discountAppliedObject == DiscountItemEditDialog.DISC_APPLIED_TOTAL_TUITION) {
                thiz.applyTotalTuition.checked = true;
            } else if (this.discountItemData.discountAppliedObject == DiscountItemEditDialog.DISC_APPLIED_EACH_CLASS) {
                thiz.applyRegisteredClass.checked = true;
            }

        } else if (this.discountItemData.hpercents > 0) {
            this.radioPercentage.checked = true;
            this.radioDollarAmount.checked = false;
            this.itemPercentage.setValue(this.discountItemData.hpercents);
            this.itemDollarAmount.setEnable(false);
            this.itemPercentage.setEnable(true);
            thiz.applyTotalTuition.setAttribute("disabled", "disabled");
            thiz.applyRegisteredClass.setAttribute("disabled", "disabled");
        }
    } else {
        this.title = (this.discountItemData.discountType == DiscountItemEditDialog.DISC_TYPE_CLASS ? "Add " + "Multi-Class Discount" : "Add " + "Multi-Athlete Discount");
        this.radioDollarAmount.checked = true;
        this.radioPercentage.checked = false;
        this.itemDollarAmount.setEnable(true);
        this.itemPercentage.setEnable(false);
        this.applyRegisteredClass.checked = true;
    }

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemPercentage, "Input value must be positive value", Condition.checked(this.radioPercentage))
        .custom(new GenericRule(thiz.itemPercentage, function (input) {
            if (thiz.radioPercentage.checked && thiz.itemPercentage.getValue() < 0) return false;
            return true;
        }, "Input value must be positive value"), null)
        .custom(new GenericRule(thiz.itemPercentage, function (input) {
            if (thiz.radioPercentage.checked && thiz.itemPercentage.getValue() > 100) return false;
            return true;
        }, "Input value cannot be greater than 100"), null)
//        .required(this.itemDollarAmount, "Input value must be equal or greater than zero 1", Condition.checked(this.radioDollarAmount))
        .custom(new GenericRule(thiz.itemDollarAmount, function (input) {
            var value = thiz.itemDollarAmount.getValue()? thiz.itemDollarAmount.getValue() : 0;
            if (thiz.radioDollarAmount.checked && (value < 0)) return false;
            return true;
        }, "Input value must be equal or greater than zero"), null)
        .custom(new GenericRule(thiz.itemDollarAmount, function (input) {
            if (thiz.radioDollarAmount.checked && thiz.itemDollarAmount.getValue() > 30000) return false;
            return true;
        }, "Input value cannot be greater than 30000"), null)
        .required(thiz.countInput, discountType + " count must be a Number and is required")
        .min(this.countInput, 2, false, discountType + " count must be at least 2")
        .max(this.countInput, 30000, false, discountType + " count cannot be greater than 30000")
        .custom(new GenericRule(thiz.countInput, function(input) {
            var valid = true;
            for (var i = 0; i < thiz.options.existIds.length; i++) {
                if (thiz.options.existIds[i] == thiz.countInput.value) {
                    valid = false;
                    break;
                }
            }
            return valid;
        }, thiz.discountType + " count value already exist."), null)
        .custom(new GenericRule(thiz.countInput, function (input) {
            if (!Number.isInteger(parseFloat(thiz.countInput.value))) return false;
            if (thiz.countInput.value.length > 0) {
                var valid = true;
                for (var i = 0; i < thiz.countInput.value.length; i++) {
                    if (isNaN(thiz.countInput.value[i])) {
                        valid = false;
                        break;
                    }
                }
                return valid;
            }
            return true;
        }, thiz.discountType + " count value must be integer."), null);
};

DiscountItemEditDialog.prototype.getCurrentInputValues = function() {
    //TODO add discountAppliedObject
    var data = {
        key: this.discountItemData.key ? this.discountItemData.key : Util.newUUID(),
        id: this.discountItemData.id ? this.discountItemData.id : 0,
        discountPlanId: this.discountItemData.discountPlanId,
        discountType: this.discountItemData.discountType,
        amount: this.radioDollarAmount.checked ? this.itemDollarAmount.getValue() : 0,
        hpercents: this.radioPercentage.checked ? this.itemPercentage.getValue() : 0,
        cutoff: parseInt(this.countInput.value)
    };
    var discountAppliedObject = 0;
    if (this.discountItemData.discountType == DiscountItemEditDialog.DISC_TYPE_STUDENT) {
        if (this.applyTotalTuition.checked) {
            data.discountAppliedObject = DiscountItemEditDialog.DISC_APPLIED_TOTAL_TUITION;
        } else if (this.applyRegisteredClass.checked) {
            data.discountAppliedObject = DiscountItemEditDialog.DISC_APPLIED_EACH_CLASS;
        }
    }

    return data;
};

DiscountItemEditDialog.prototype.save = function (callback) {
    if (this.saveButtonClickedTimeout) window.clearTimeout(this.saveButtonClickedTimeout);
    var thiz = this;
    this.saveButtonClickedTimeout = window.setTimeout(function () {
        if(!ValidationManager.run(thiz.validationRules)) return false;
        var discount = thiz.getCurrentInputValues();
        thiz.close(discount);
    }, 200);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/DiscountPlanWidget.js";

function DiscountPlanWidget(options) {
    this.options = options;
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.bind("e:TabChange", function (event) {
        Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_ITEM_CHANGED, thiz.node(), null);
        event.stopPropagation();
    }, this.detailTabPane.node());
    this.bind("input", this.discountPlanNameInputHandler, this.discountPlanName);
    this.bind("p:ItemSelected", function (event) {
        if (thiz.classDiscountApplicationCombo.getSelectedItem() && thiz.classDiscountApplicationCombo.getSelectedItem().key == "TotalCount") {
            thiz.classOrderCombo.setEnable(false);
            Dom.show(thiz.applicationDescription);
        } else {
            thiz.classOrderCombo.setEnable(true);
            Dom.hide(thiz.applicationDescription);
        }
        Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_ITEM_CHANGED, thiz.node(), null);
    }, this.classDiscountApplicationCombo);
    this.bind("p:ItemSelected", function () {
        if (thiz.athleteDiscountApplicationCombo.getSelectedItem() && thiz.athleteDiscountApplicationCombo.getSelectedItem().key == "TotalCount") {
            thiz.athleteOrderCombo.setEnable(false);
        } else {
            thiz.athleteOrderCombo.setEnable(true);
        }
    }, this.athleteDiscountApplicationCombo);

    this.bind("p:ItemSelected", function (event) {
        if (event.fromUser) thiz.setDataChanged(true);
    }, this.detailTabPane.node());
    this.bind("change", function (event) {
        thiz.setDataChanged(true);
        var activeTab = thiz.detailTabPane.getActiveTabPane();
        var tabName = thiz.detailTabPane._getTabName(activeTab);
        if (event.target.checked) {
            Dom.removeClass(event.target.parentNode.parentNode.parentNode, "Disabled");
            if (tabName == "multiClassDiscounts") {
                thiz.detailTabPane.setTabTitleByName("multiClassDiscounts", "Multi-Class Discounts");
            } else if (tabName == "multiAthleteDiscounts") {
                thiz.detailTabPane.setTabTitleByName("multiAthleteDiscounts", "Multi-Athlete Discounts");
            }
        } else {
            Dom.addClass(event.target.parentNode.parentNode.parentNode, "Disabled");
            if (tabName == "multiClassDiscounts") {
                thiz.detailTabPane.setTabTitleByName("multiClassDiscounts", "Multi-Class Discounts (Disabled)");
            } else if (tabName == "multiAthleteDiscounts") {
                thiz.detailTabPane.setTabTitleByName("multiAthleteDiscounts", "Multi-Athlete Discounts (Disabled)");
            }
        }
        var allowOptions = {
            key: thiz.discountPlan.key,
            allowMultiClassDiscount: thiz.enableMultiClassDiscounts.checked,
            allowMultiStudentDiscount: thiz.enableMultiAthleteDiscounts.checked,
            allowCoupon: thiz.allowCoupons.checked
        }
        Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_ALLOW_DISCOUNT_CHANGED, event.target, allowOptions);
    }, this.detailTabPane.node());

    this.bind("click", this.newMultiClassDiscountButtonClickedHandler, this.newMultiClassDiscountButton);
    this.bind("click", this.newMultiAthleteDiscountButtonClickedHandler, this.newMultiAthleteDiscountButton);

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.discountPlanName, "Discount Plan Name is required.")
    var comboRenderer = function (data) {
        if (!data) return "";
        return "" + data.value;
    };
    var comboComparer = function(selected, item) {
        return selected.key == item.key;
    };

    this.classDiscountApplicationCombo.renderer = comboRenderer;
    this.classOrderCombo.renderer = comboRenderer;
    this.athleteDiscountApplicationCombo.renderer = comboRenderer;
    this.athleteOrderCombo.renderer = comboRenderer;

    this.classDiscountApplicationCombo.comparer = comboComparer;
    this.classOrderCombo.comparer = comboComparer;
    this.athleteDiscountApplicationCombo.comparer = comboComparer;
    this.athleteOrderCombo.comparer = comboComparer;

    this.discountApplicationItems = options.discountConfiguration && options.discountConfiguration.discountApplicationTypes.length > 0
                                        ? options.discountConfiguration.discountApplicationTypes : [];
    this.discountOrderItems = options.discountConfiguration && options.discountConfiguration.discountOrderTypes.length > 0
                                        ? options.discountConfiguration.discountOrderTypes : [];
    this.setupMultiClassDiscountTable();
    this.setupMultiAthleteDiscountTable();
    this._setupInfoTips();
}

DiscountPlanWidget.DISCOUNT_PLAN_NAME_INPUT = "p:DiscountPlanNameInput";
DiscountPlanWidget.DISCOUNT_PLAN_ITEM_CHANGED = "p:DiscountPlanItemChanged";
DiscountPlanWidget.DISCOUNT_PLAN_DATA_CHANGED = "p:DiscountPlanDataChanged";
DiscountPlanWidget.DISCOUNT_PLAN_ALLOW_DISCOUNT_CHANGED = "p:DiscountPlanAllowDiscountChanged";
DiscountPlanWidget.DISC_TYPE_CLASS = "MultiClassDiscount";
DiscountPlanWidget.DISC_TYPE_STUDENT = "MultiStudentDiscount";

__extend(BaseTemplatedWidget, DiscountPlanWidget);

DiscountPlanWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    if (!this.options) return;
    if (!this.options.discountPlan) return;
    this.discountPlan = this.options.discountPlan;

    this.classDiscountApplicationCombo.setItems(this.discountApplicationItems);
    this.classOrderCombo.setItems(this.discountOrderItems);
    this.athleteDiscountApplicationCombo.setItems(this.discountApplicationItems);
    this.athleteOrderCombo.setItems(this.discountOrderItems);

    this.multiClassDiscountTable.setup();
    this.multiAthleteDiscountTable.setup();

    if (this.discountPlan.name && this.discountPlan.name.length > 0) this.discountPlanName.value = this.discountPlan.name;
    this.enableMultiClassDiscounts.checked = this.discountPlan.allowMultiClassDiscount;
    if (this.discountPlan.allowMultiClassDiscount) {
        Dom.removeClass(this.multiClassDiscounts, "Disabled");
        this.detailTabPane.setTabTitleByName("multiClassDiscounts", "Multi-Class Discounts");
    } else {
        Dom.addClass(this.multiClassDiscounts, "Disabled");
        this.detailTabPane.setTabTitleByName("multiClassDiscounts", "Multi-Class Discounts (Disabled)");
    }
    this.classDiscountApplicationCombo.selectItemByKey("key", this.discountPlan.multiClassDiscountApplicationType);
    this.classOrderCombo.selectItemByKey("key", this.discountPlan.multiClassDiscountOrderType);

    this.enableMultiAthleteDiscounts.checked = this.discountPlan.allowMultiStudentDiscount;
    if (this.discountPlan.allowMultiStudentDiscount) {
        Dom.removeClass(this.multiAthleteDiscounts, "Disabled");
        this.detailTabPane.setTabTitleByName("multiAthleteDiscounts", "Multi-Athlete Discounts");
    } else {
        Dom.addClass(this.multiAthleteDiscounts, "Disabled");
        this.detailTabPane.setTabTitleByName("multiAthleteDiscounts", "Multi-Athlete Discounts (Disabled)");
    }
    this.athleteDiscountApplicationCombo.selectItemByKey("key", this.discountPlan.multiStudentDiscountApplicationType);
    this.athleteOrderCombo.selectItemByKey("key", this.discountPlan.multiStudentDiscountOrderType);

    this.allowCoupons.checked = this.discountPlan.allowCoupon;
    if (this.discountPlan.id > 0) {
        var thiz = this;
        
        var promiseAll = [];
        promiseAll.push(new Promise(function(resolve, reject) {
            $classAdminService.getDiscountPlanById(thiz.discountPlan.id, function (res) {
                thiz.discountPlanInfo = res;
                resolve();
            }, function (err) {
                reject(err);
            }, "Loading...");
        }));
        
        if (this.options.showClassAttached) {
            promiseAll.push(new Promise(function(resolve, reject) {
                $classAdminService.getClassAttachedDiscountPlan(thiz.discountPlan.id, function (res) {
                    thiz.classListInfo = res;
                    resolve();
                }, function (err) {
                    reject(err);
                }, "Loading...");
            }));
        }
        
        Promise.all(promiseAll).then(function () {
            thiz.classListContent.innerHTML = "";
            var hasClassAttached = thiz.classListInfo && thiz.classListInfo.length > 0;
            if (hasClassAttached) {
                thiz.classListInfo.forEach(function (classInfo) {
                    thiz.classListContent.appendChild(Dom.newDOMElement({
                        _name: "div",
                        _text: classInfo.name,
                        "title": classInfo.name
                    }));
                });
                Dom.removeClass(thiz.classListWrapper, "NoClassFound");
            } else {
                Dom.addClass(thiz.classListWrapper, "NoClassFound");
            }
            if (thiz.options.validateDeleteAction) thiz.options.validateDeleteAction(hasClassAttached);
            
            var classDiscountItems = thiz.discountPlanInfo.multiClassDiscountItems.result;
            for (var i = 0; i < classDiscountItems.length; i++) {
                classDiscountItems[i].key = Util.newUUID();
            }
            thiz.multiClassDiscountTable.setItems(classDiscountItems);

            var athleteDiscountItems = thiz.discountPlanInfo.multiStudentDiscountItems.result;
            for (var i = 0; i < athleteDiscountItems.length; i++) {
                athleteDiscountItems[i].key = Util.newUUID();
            }
            thiz.multiAthleteDiscountTable.setItems(athleteDiscountItems);
            thiz.discountPlan.isLoadedItems = true;
            Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_ITEM_CHANGED, thiz.node(), null);
        });
    } else {
        this.multiClassDiscountTable.setItems([]);
        this.multiAthleteDiscountTable.setItems([]);
        if (this.options.validateDeleteAction) this.options.validateDeleteAction(false);
    }
};

DiscountPlanWidget.prototype._setupInfoTips = function () {
    var showClassDiscountTips = function() {
        if (this._multiClassDiscountsTooltips) {
            this._multiClassDiscountsTooltips.kill();
        }
        this._multiClassDiscountsTooltips = InfoTip.show(this.multiClassDiscountsTooltips, "Will not apply to Rate Plans.", false, null, "tooltip", "left-inside", -(Dom.getOffsetWidth(this.multiClassDiscountsTooltips)/2 + 7));
    }
    var hideClassDiscountTips = function() {
        if(this.multiClassDiscountsTooltips && this.multiClassDiscountsTooltips.__tip) {
            this.multiClassDiscountsTooltips.__tip.isVisible = function(){
                return true;
            };
            InfoTip.show(this.multiClassDiscountsTooltips);
            if (this._multiClassDiscountsTooltips) {
                this._multiClassDiscountsTooltips.kill();
            }
        }
    }
    this.bind("mouseover", showClassDiscountTips, this.multiClassDiscountsTooltips);
    this.bind("mouseout", hideClassDiscountTips, this.multiClassDiscountsTooltips);

    var showAthleteDiscountsTooltips = function () {
        if (this._athleteDiscountsTooltips) {
            this._athleteDiscountsTooltips.kill();
        }
        this._athleteDiscountsTooltips = InfoTip.show(this.enableMultiAthleteDiscountsTooltips, "Rate Plan Pricing must have Discount Plan assigned to the Rate Plan.", false, null, "tooltip", "left-inside", -(Dom.getOffsetWidth(this.enableMultiAthleteDiscountsTooltips)/2 + 7));
    }
    var hideMultiAthleteDiscountsTooltips = function () {
        if(this.enableMultiAthleteDiscountsTooltips && this.enableMultiAthleteDiscountsTooltips.__tip) {
            this.enableMultiAthleteDiscountsTooltips.__tip.isVisible = function(){
                return true;
            };
            InfoTip.show(this.enableMultiAthleteDiscountsTooltips);
            if (this._athleteDiscountsTooltips) {
                this._athleteDiscountsTooltips.kill();
            }
        }
    }
    this.bind("mouseover", showAthleteDiscountsTooltips, this.enableMultiAthleteDiscountsTooltips);
    this.bind("mouseout", hideMultiAthleteDiscountsTooltips, this.enableMultiAthleteDiscountsTooltips);
};

DiscountPlanWidget.prototype.setupMultiClassDiscountTable = function () {
    var thiz = this;
    this.multiClassDiscountTable.column(new DataTable.GenericColumn("Classes", function(data) {
        if (!data) return "";
        return "" + data.cutoff;
    }).width("10em"));

    this.multiClassDiscountTable.column(new DataTable.GenericColumn("Discount", function(data) {
        if (!data) return "";
        if (data.hpercents > 0 && data.hpercents <= 100) {
            return data.hpercents + "%";
        } else {
            return "" + Util.toCurrency(data.amount);
        }
        return "";
    }).width("1*"));

    var actions = [ {
        id: "edit", type: "pencil", title: "Edit Discount",
        isApplicable: function(item) {
            return true;
        },
        handler: function (item) {
            thiz.editDiscount(item, thiz.multiClassDiscountTable);
        }
    },{
        id: "delete", type: "delete", title: "Delete Discount",
        isApplicable: function(item) {
            return true;
        },
        handler: function (item) {
            thiz.deleteDiscount(item, thiz.multiClassDiscountTable);
        }
    }];
    this.multiClassDiscountTable.column(new DataTable.ActionColumn(actions).width("8em"));
};

DiscountPlanWidget.prototype.setupMultiAthleteDiscountTable = function () {
    var thiz = this;
    this.multiAthleteDiscountTable.column(new DataTable.PlainTextColumn("Athletes", function (data) {
        if (!data) return "";
        return "" + data.cutoff;
    }).width("10em"));

    this.multiAthleteDiscountTable.column(new DataTable.PlainTextColumn("Discount", function (data) {
        if (!data) return "";
        if (data.hpercents > 0 && data.hpercents <= 100) {
            return data.hpercents + "%";
        } else {
            return "" + Util.toCurrency(data.amount);
        }
        return "";
    }).width("1*"));

    this.multiAthleteDiscountTable.column(new DataTable.PlainTextColumn("Apply to total tuition", function (data) {
        if (data.discountAppliedObject == "TotalTuition" && data.amount > 0) {
            return "Yes";
        } else {
            return "";
        }
    }).width("13em"));

    var actions = [ {
        id: "edit", type: "pencil", title: "Edit Discount",
        isApplicable: function(item) {
            return true;
        },
        handler: function (item) {
            thiz.editDiscount(item, thiz.multiAthleteDiscountTable);
        }
    },{
        id: "delete", type: "delete", title: "Delete Discount",
        isApplicable: function(item) {
            return true;
        },
        handler: function (item) {
            thiz.deleteDiscount(item, thiz.multiAthleteDiscountTable);
        }
    }];
    this.multiAthleteDiscountTable.column(new DataTable.ActionColumn(actions).width("8em"));
};

DiscountPlanWidget.prototype.discountPlanNameInputHandler = function (event) {
    this.setDataChanged(true);
    if(this.inputingDiscountPlanNameTimeout) {
        window.clearTimeout(this.inputingDiscountPlanNameTimeout);
    }
    var thiz = this;
    this.inputingDiscountPlanNameTimeout = window.setTimeout(function () {
        Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_NAME_INPUT, event.target,
            {discountPlanKey: thiz.discountPlan.key, discountPlanName: event.target.value});
    }, 200);
};

DiscountPlanWidget.prototype.validateDiscountData = function () {
    if (!ValidationManager.run(this.validationRules)) return false;
    return true;
};

DiscountPlanWidget.prototype.getDiscountPlanValue = function () {
    if (!this.discountPlan) return;
    var data = {id: this.discountPlan.id};
    var classDiscountApplication = this.classDiscountApplicationCombo.getSelectedItem().key,
        athleteDiscountApplication = this.athleteDiscountApplicationCombo.getSelectedItem().key;
    data.name = this.discountPlanName.value;
    data.allowMultiClassDiscount = this.enableMultiClassDiscounts.checked;
    data.allowMultiStudentDiscount = this.enableMultiAthleteDiscounts.checked;
    data.multiClassDiscountApplicationType = classDiscountApplication;
    data.multiClassDiscountOrderType = classDiscountApplication == "TotalCount" ? null : this.classOrderCombo.getSelectedItem().key;
    data.multiStudentDiscountApplicationType = athleteDiscountApplication;
    data.multiStudentDiscountOrderType = athleteDiscountApplication == "TotalCount" ? null : this.athleteOrderCombo.getSelectedItem().key;
    data.allowCoupon = this.allowCoupons.checked;
    data.multiClassDiscountItems = this.multiClassDiscountTable.getItems();
    data.multiStudentDiscountItems = this.multiAthleteDiscountTable.getItems();
    return data;
};


DiscountPlanWidget.prototype.newMultiClassDiscountButtonClickedHandler = function () {
    var existIds = [];
    var discountItems = this.multiClassDiscountTable.getItems();
    for (var i = 0; i < discountItems.length; i++) {
        existIds.push(discountItems[i].cutoff);
    }
    var options = {
        data: {discountType: DiscountPlanWidget.DISC_TYPE_CLASS},
        existIds: existIds
    };
    var thiz = this;
    new DiscountItemEditDialog().callback(function (data) {
        if (data) {
            thiz.setDataChanged(true);
            var items = thiz.multiClassDiscountTable.getItems();
            items.push(data);
            items.sort(function (a, b) {
                return a.cutoff - b.cutoff;
            });
            thiz.multiClassDiscountTable.setItems(items);
            Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_ITEM_CHANGED, thiz.node(), null);
        }
    }).open(options);
};

DiscountPlanWidget.prototype.newMultiAthleteDiscountButtonClickedHandler = function () {
    var existIds = [];
    var discountItems = this.multiAthleteDiscountTable.getItems();
    for (var i = 0; i < discountItems.length; i++) {
        existIds.push(discountItems[i].cutoff);
    }
    var options = {
        data: {discountType: DiscountPlanWidget.DISC_TYPE_STUDENT},
        existIds: existIds
    };
    var thiz = this;
    new DiscountItemEditDialog().callback(function (data) {
        if (data) {
            thiz.setDataChanged(true);
            var items = thiz.multiAthleteDiscountTable.getItems();
            items.push(data);
            items.sort(function (a, b) {
                return a.cutoff - b.cutoff;
            });
            thiz.multiAthleteDiscountTable.setItems(items);
            Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_ITEM_CHANGED, thiz.node(), null);
        }
    }).open(options);
};

DiscountPlanWidget.prototype.editDiscount = function (discount, fromTable) {
    if (!discount) return;
    if (!discount.key) discount.key = Util.newUUID();
    var existIds = [],
        options = {data: discount},
        thiz = this,
        discountItems = fromTable.getItems();

    for (var i = 0; i < discountItems.length; i++) {
        if (discountItems[i].key != discount.key) {
            existIds.push(discountItems[i].cutoff);
        }
    }
    options.existIds = existIds;
    new DiscountItemEditDialog().callback(function (data) {
        if (!data) return;
        var items = fromTable.getItems();
        for (var i = 0; i < items.length; i++) {
            if (items[i].key == data.key) {
                items[i] = data;
                items.sort(function (a, b) {
                    return a.cutoff - b.cutoff;
                });
                fromTable.setItems(items);
                thiz.setDataChanged(true);
                break;
            }
        }
    }).open(options);
};

DiscountPlanWidget.prototype.deleteDiscount = function (discount, fromTable) {
    if (!discount) return;
    var thiz = this;
    Dialog.confirmDangerousAction("Are you sure you want to delete this item?", null, "Delete", function () {
        var items = fromTable.getItems();
        for (var i = 0; i < items.length; i++) {
            if (items[i].key == discount.key) {
                items.splice(i, 1);
                fromTable.setItems(items);
                thiz.setDataChanged(true);
                Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_ITEM_CHANGED, thiz.node(), null);
                break;
            }
        }
    }, "Cancel", function () {
    });
};

DiscountPlanWidget.prototype.setDataChanged = function (isChanged) {
    this.isDiscountDataChanged = isChanged;
    Dom.emitEvent(DiscountPlanWidget.DISCOUNT_PLAN_DATA_CHANGED, this.node(), {isDataChanged: isChanged});
};
DiscountPlanWidget.prototype.isDataChanged = function () {
    return this.isDiscountDataChanged;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/DiscountSettingWidget.js";

function DiscountSettingWidget(node) {
    BaseTemplatedWidget.call(this);

    var thiz = this;
    this.discountPlanList.populator = function (data, binding, node) {
        node._discountPlanDataKey = data.key;
        Dom.addClass(node, "DiscountPlanItem_" + data.key);
        if (thiz.selectedDiscountPlan && data.key == thiz.selectedDiscountPlan.key) Dom.addClass(node, "Active");
        Dom.addClass(binding.discountPlanName, "DiscountPlanName_" + data.key);
        if (data.name && data.name.length > 0) {
            binding.discountPlanName.innerHTML = data.name;
        } else {
            binding.discountPlanName.innerHTML = "[No Discount Plan Name]";
            Dom.addClass(binding.discountPlanName, "NoDiscountPlanName");
        }

        Dom.addClass(binding.multiClassDiscount, "DiscountPlanAllowMultiClass_" + data.key);
        if (data.allowMultiClassDiscount) {
            binding.multiClassDiscount.innerHTML = "Yes";
            Dom.addClass(binding.multiClassDiscount, "Allow");
        } else {
            binding.multiClassDiscount.innerHTML = "No";
            Dom.removeClass(binding.multiClassDiscount, "Allow");
        }

        Dom.addClass(binding.multiAthleteDiscount, "DiscountPlanAllowMultiAthlete_" + data.key);
        if (data.allowMultiStudentDiscount) {
            binding.multiAthleteDiscount.innerHTML = "Yes";
            Dom.addClass(binding.multiAthleteDiscount, "Allow");
        } else {
            binding.multiAthleteDiscount.innerHTML = "No";
            Dom.removeClass(binding.multiAthleteDiscount, "Allow");
        }

        Dom.addClass(binding.allowCoupon, "DiscountPlanAllowCoupon_" + data.key);
        if (data.allowCoupon) {
            binding.allowCoupon.innerHTML = "Yes";
            Dom.addClass(binding.allowCoupon, "Allow");
        } else {
            binding.allowCoupon.innerHTML = "No";
            Dom.removeClass(binding.allowCoupon, "Allow");
        }
    };

    this.bind("click", this.newDiscountPlanButtonClickedHandler, this.newDiscountPlanButton);
    this.bind("click", this.newDiscountPlanButtonClickedHandler, this.newDiscountPlanButton2);
    this.bind("click", this.saveButtonClickedHandler, this.saveButton);
    this.bind("click", this.cancelButtonClickedHandler, this.cancelButton);
    this.bind("click", this.deleteButtonClickedHandler, this.deleteButton);
    this.bind("click", this.discountPlanListClickedHandler, this.discountPlanList);

    this.bind("p:DiscountPlanNameInput", this.discountPlanNameInputHandler, this.discountPlanContent);
    this.bind("p:DiscountPlanDataChanged", this.invalidateButtonStatus, this.discountPlanContent);
    this.bind("p:DiscountPlanAllowDiscountChanged", this.discountAllowDiscountChangedHandler, this.discountPlanContent);
}

__extend(BaseTemplatedWidget, DiscountSettingWidget);

DiscountSettingWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    var thiz = this;
    this.discountPlanObject = {};
    if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
        thiz.discountConfiguration = {
            discountApplicationTypes: window.LOGIN_INFO.discountApplicationTypes,
            discountOrderTypes: window.LOGIN_INFO.discountOrderTypes
        }
        thiz.renderDiscountPlan();
    } else {
        $classAdminService.getAccountInfo(function (res) {
            window.LOGIN_INFO.discountApplicationTypes = res.discountApplicationTypes;
            window.LOGIN_INFO.discountOrderTypes = res.discountOrderTypes;
            thiz.discountConfiguration = {
                discountApplicationTypes: res.discountApplicationTypes,
                discountOrderTypes: res.discountOrderTypes
            }
            thiz.renderDiscountPlan();
        }, function (err) {});
    }
};

DiscountSettingWidget.prototype.renderDiscountPlan = function () {
    var thiz = this;
    this.discountPlanWidget = null;
    $classAdminService.getDiscountPlans(function (res) {
        thiz.discountPlans = res.result;
        if (thiz.discountPlans && thiz.discountPlans.length > 0) {
            for (var i = 0; i < thiz.discountPlans.length; i++) {
                thiz.discountPlans[i].key = Util.newUUID();
                thiz.discountPlanObject[thiz.discountPlans[i].key] = thiz.discountPlans[i];
            }
            thiz.selectedDiscountPlan = thiz.discountPlans[0];
            Dom.removeClass(thiz.discountPlanContentWrapper, "Hidden");
            Dom.addClass(thiz.noDiscountPlanContent, "Hidden");
            thiz.discountPlanList.setItems(thiz.discountPlans);
            thiz.renderDiscountPlanContent();
        } else {
            Dom.removeClass(thiz.noDiscountPlanContent, "Hidden");
            Dom.addClass(thiz.discountPlanContentWrapper, "Hidden");
        }
    }, function (error) {});
};

DiscountSettingWidget.prototype.newDiscountPlanButtonClickedHandler = function () {
    var thiz = this;
    if (this.discountPlanWidget && this.discountPlanWidget.isDataChanged()) {
        Dialog.confirm("The discount has changed but unsaved. Would you like to save the changes of discount?", null, "Save & Continue", function () {
            thiz.saveButtonClickedHandler(thiz.newDiscountPlanButtonClickedHandler);
        },
        "Cancel", function () {
            return;
        }, null, null);
    } else {
        Dom.addClass(this.noDiscountPlanContent, "Hidden");
        Dom.removeClass(this.discountPlanContentWrapper, "Hidden");
        if (!this.discountPlans) this.discountPlans = [];
        var newData = {
            key: Util.newUUID(),
            allowMultiClassDiscount: true,
            allowMultiStudentDiscount: true,
            allowCoupon: true,
            classDiscountItems: [],
            athleteDiscountItems: []
        };
        this.discountPlans.splice(0, 0, newData);
        this.selectedDiscountPlan = this.discountPlans[0];
        this.discountPlanList.setItems(this.discountPlans);
        this.renderDiscountPlanContent();
        if (this.discountPlanWidget) this.discountPlanWidget.setDataChanged(true);
    }
};

DiscountSettingWidget.prototype.renderDiscountPlanContent = function () {
    this.discountPlanContent.innerHTML = "";
    var thiz = this;
    var discountPlanOptions = {
        discountPlan: this.selectedDiscountPlan,
        discountConfiguration: this.discountConfiguration,
        showClassAttached: true,
        validateDeleteAction: function (hasActiveClass) {
            thiz.validateDeleteAction(hasActiveClass);
        }
    };

    this.discountPlanWidget = new DiscountPlanWidget(discountPlanOptions).into(this.discountPlanContent);
};

DiscountSettingWidget.prototype.discountPlanNameInputHandler = function (event) {
    var discountPlanNameElm = this.discountPlanList.node().getElementsByClassName("DiscountPlanName_" + event.discountPlanKey)[0];
    if (discountPlanNameElm) {
        if (event.discountPlanName && event.discountPlanName.length > 0) {
            discountPlanNameElm.innerHTML = event.discountPlanName;
        } else {
            discountPlanNameElm.innerHTML = "[No Discount Plan Name]";
        }
    }
};

DiscountSettingWidget.prototype.discountAllowDiscountChangedHandler = function (event) {
    var allowMultiClassElm = this.discountPlanList.node().getElementsByClassName("DiscountPlanAllowMultiClass_" + event.key)[0];
    var allowMultiAthleteElm = this.discountPlanList.node().getElementsByClassName("DiscountPlanAllowMultiAthlete_" + event.key)[0];
    var allowCouponElm = this.discountPlanList.node().getElementsByClassName("DiscountPlanAllowCoupon_" + event.key)[0];

    if (allowMultiClassElm) {
        if (event.allowMultiClassDiscount) {
            allowMultiClassElm.innerHTML = "Yes";
            Dom.addClass(allowMultiClassElm, "Allow");
        } else {
            allowMultiClassElm.innerHTML = "No";
            Dom.removeClass(allowMultiClassElm, "Allow");
        }
    }

    if (allowMultiAthleteElm) {
        if (event.allowMultiStudentDiscount) {
            allowMultiAthleteElm.innerHTML = "Yes";
            Dom.addClass(allowMultiAthleteElm, "Allow");
        } else {
            allowMultiAthleteElm.innerHTML = "No";
            Dom.removeClass(allowMultiAthleteElm, "Allow");
        }
    }

    if (allowCouponElm) {
        if (event.allowCoupon) {
            allowCouponElm.innerHTML = "Yes";
            Dom.addClass(allowCouponElm, "Allow");
        } else {
            allowCouponElm.innerHTML = "No";
            Dom.removeClass(allowCouponElm, "Allow");
        }
    }
};

DiscountSettingWidget.prototype.discountPlanListClickedHandler = function (event) {
    var discountPlanNode = Dom.findUpwardForNodeWithData(event.target, "_discountPlanDataKey");
    if (!discountPlanNode) return;
    var thiz = this;
    if (!Dom.hasClass(discountPlanNode, "Active")) {
        if (this.discountPlanWidget && this.discountPlanWidget.isDataChanged()) {
            Dialog.confirm("The discount plan was changed but unsaved. Please discard or save these changes to continue", null, "Save & Continue", function () {
                thiz.saveButtonClickedHandler(function () {
                    thiz.selectDiscountPlan(discountPlanNode);
                });
            },
            "Cancel", function () {
                return;
            }, "Discard & Continue", function () {
                thiz.discardChanges(discountPlanNode);
            });
        } else {
            this.selectDiscountPlan(discountPlanNode);
        }
    }
};

DiscountSettingWidget.prototype.selectDiscountPlan = function (discountPlanNode) {
    if (!discountPlanNode) return;
    Dom.doOnSelector(this.discountPlanList.node(), ".Active", function (el) {
        Dom.removeClass(el, "Active");
    });
    Dom.addClass(discountPlanNode, "Active");
    console.log("Active", discountPlanNode);
    this.selectedDiscountPlan = this.discountPlanObject[discountPlanNode._discountPlanDataKey];
    this.renderDiscountPlanContent();
};

DiscountSettingWidget.prototype.saveButtonClickedHandler = function (callback) {
    if(this.saveButtonClickedTimeOut) {
        window.clearTimeout(this.saveButtonClickedTimeOut);
    }
    var thiz = this;
    thiz.saveButtonClickedTimeOut = window.setTimeout(function () {
        if (!thiz.discountPlanWidget.validateDiscountData()) return;
        var data = thiz.discountPlanWidget.getDiscountPlanValue();
        if (!data) return;
        thiz.saveButton.setAttribute("disabled", "disabled");
        var key = thiz.selectedDiscountPlan.key;
        $classAdminService.saveDiscountPlan(data, function (res) {
            thiz.selectedDiscountPlan = res;
            thiz.selectedDiscountPlan.key = key;
            thiz.discountPlanObject[thiz.selectedDiscountPlan.key] = res;
            if (thiz.discountPlanWidget) thiz.discountPlanWidget.discountPlan = thiz.selectedDiscountPlan;

            for (var i = 0; i < thiz.discountPlans.length; i++) {
                if (thiz.discountPlans[i].key == key) {
                    thiz.discountPlans[i] = res;
                    break;
                }
            }
            Dom.doOnSelector(thiz.discountPlanList.node(), ".NoDiscountPlanName", function (el) {
                Dom.removeClass(el, "NoDiscountPlanName");
            });
            SnackBar.show("Data was saved successfully");
            thiz.discountPlanWidget.setDataChanged(false);
            thiz.saveButton.removeAttribute("disabled");
            if (typeof(callback) == "function") callback();
        }, function (err) {
            thiz.saveButton.removeAttribute("disabled");
            Dialog.alert("Fail to save Discount  with error", err.message);
        });
    }, 200);
};

DiscountSettingWidget.prototype.cancelButtonClickedHandler = function () {
    var thiz = this;
    Dialog.confirmDangerousAction("All changes are not saved. Do you want to discard these changes?", null, "Discard Changes", function () {
        thiz.discardChanges();
    },
    "Cancel", function () {
        return;
    }, null, null);
};

DiscountSettingWidget.prototype.discardChanges = function(nextDiscountPlanNode) {
    var thiz = this;
    thiz.discountPlanWidget.setDataChanged(false);
    if (thiz.selectedDiscountPlan.id > 0) {
        thiz.renderDiscountPlanContent();
        var discountPlanNameElm = thiz.discountPlanList.node().getElementsByClassName("DiscountPlanName_" + thiz.selectedDiscountPlan.key)[0];
        if (discountPlanNameElm) {
            if (thiz.selectedDiscountPlan.name && thiz.selectedDiscountPlan.name.length > 0) {
                discountPlanNameElm.innerHTML = thiz.selectedDiscountPlan.name;
            } else {
                discountPlanNameElm.innerHTML = "[No Discount Plan Name]";
            }
        }
        thiz.discountAllowDiscountChangedHandler(thiz.selectedDiscountPlan);
        if (nextDiscountPlanNode) {
            setTimeout(function() {
                thiz.selectDiscountPlan(nextDiscountPlanNode);
            }, 20);
        }
    } else {
        var discountPlanNameElm = thiz.discountPlanList.node().getElementsByClassName("DiscountPlanItem_" + thiz.selectedDiscountPlan.key)[0];
        if (discountPlanNameElm) discountPlanNameElm.parentNode.removeChild(discountPlanNameElm);
        var plans = [];
        for (var i = 0; i < thiz.discountPlans.length; i++) {
            if (thiz.discountPlans[i].key != thiz.selectedDiscountPlan.key) {
                plans.push(thiz.discountPlans[i]);
            }
        }
        thiz.discountPlans = plans;
        if (!thiz.discountPlans.length) {
            thiz.renderDiscountPlan();
        }
        setTimeout(function() {
            thiz.discountPlanWidget.setDataChanged(false);
            if (nextDiscountPlanNode) {
                thiz.selectDiscountPlan(nextDiscountPlanNode);
            } else {
                thiz.selectDiscountPlan(thiz.discountPlanList.node().childNodes[0]);
            }
        }, 10);
        return;
    }
}

DiscountSettingWidget.prototype.deleteButtonClickedHandler = function () {
    if (!this.selectedDiscountPlan) return;
    var thiz = this;
    Dialog.confirmDangerousAction("This plan will be removed from all sub programs, classes and rate plans which it is associated. Are you sure you want to delete this plan?", null, "Delete", function () {
        if (thiz.selectedDiscountPlan.id > 0) {
            $classAdminService.deleteDiscountPlan(thiz.selectedDiscountPlan.id, function () {
                thiz.discountPlanWidget.setDataChanged(false);
                thiz.renderDiscountPlan();
                SnackBar.show("Data was deleted successfully");
            }, function (err) {
                Dialog.error("", err.message);
            });
        } else {
            thiz.discountPlanWidget.setDataChanged(false);
            thiz.renderDiscountPlan();
        }
    },
    "Cancel", function () {
        return;
    }, null, null);
};

DiscountSettingWidget.prototype.invalidateButtonStatus = function (event) {
    if (event.isDataChanged) {
        this.newDiscountPlanButton2.setAttribute("disabled", "disabled");
        this.cancelButton.removeAttribute("disabled");
        this.saveButton.removeAttribute("disabled");
    } else {
        this.newDiscountPlanButton2.removeAttribute("disabled");
        this.cancelButton.setAttribute("disabled", "disabled");
        this.saveButton.setAttribute("disabled", "disabled");
    }
};

DiscountSettingWidget.prototype.validateDeleteAction = function (hasClass) {
    if (hasClass) {
        this.deleteButton.setAttribute("disabled", "disabled");
        this.deleteButton.setAttribute("title", "Discount in use by active class. Cannot delete.");
    } else {
        this.deleteButton.removeAttribute("disabled");
        this.deleteButton.removeAttribute("title");
    }
};



if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/EditDisplayOrderDialog.js";

function EditDisplayOrderDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    var thiz = this;

    this.bind("click", function (event) {
        var node = Dom.getTarget(event);
        var itemNode = Dom.findParentWithClass(node, "ListItem");
        if (!itemNode) return;
        if (Dom.hasClass(itemNode, "ProgramItem")) {
            thiz.removeChildActiveClass(thiz.programRepeater.node());
            var row = Dom.findUpwardForNodeWithData(itemNode, "_programData");
            thiz.setupSubProgram(row._programData.id);
        } else if (Dom.hasClass(itemNode, "SubProgramItem")) {
            thiz.removeChildActiveClass(thiz.subProgramRepeater.node());
            var row = Dom.findUpwardForNodeWithData(itemNode, "_subProgramData");
            thiz.setupClasses(row._subProgramData.id);
        } else if (Dom.hasClass(itemNode, "ClassItem")) {
            thiz.removeChildActiveClass(thiz.classRepeater.node());
        }
        Dom.addClass(itemNode, "Active");
    }, this.selectorContainer);


    this.programRepeater.populator = function (data, binding, node) {
        node._programData = data;
        binding.programName.innerHTML = data.title;
        binding.programName.title = data.title;
    };
    this.subProgramRepeater.populator = function (data, binding, node) {
        node._subProgramData = data;
        binding.subProgramName.innerHTML = data.title;
        binding.subProgramName.title = data.title;
    };
    this.classRepeater.populator = function (data, binding, node) {
        node._classData = data;
        binding.className.innerHTML = data.title;
        binding.className.title = data.title;
    };
}

__extend(Dialog, EditDisplayOrderDialog);

EditDisplayOrderDialog.prototype.asyncSetup = function (options, dialogCallback) {
    this.title = "Edit Display Orders";
    var thiz = this;
    $classMetaService.getPrograms("", 0, 999999999, null, function (res) {
        thiz.programRepeater.setItems(res.result);
        thiz.programList = res.result;
        thiz.programObject = {};
        for (var i = 0; i < thiz.programList.length; i++) {
            delete thiz.programList[i].subPrograms;
            thiz.programObject[thiz.programList[i].id] = thiz.programList[i];
        }
    }, function (err) {});
    dialogCallback();
};

EditDisplayOrderDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Save",
            isApplicable: function () {
                return true;
            },
            run: function () {
                thiz.saveButtonClickedHandler();
            }
        },
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                return true;
            }
        }
    ];
    return actions;
};
EditDisplayOrderDialog.prototype.onShown = function () {
    if (ClassAuthUtils.canManageProgram()) {
        this.setupReordering(this.programRepeater.node(), "_programData");
        Dom.addClass(this.programContainer, "Draggable");
    }
    if (ClassAuthUtils.canManageSubProgram()) {
        this.setupReordering(this.subProgramRepeater.node(), "_subProgramData");
        Dom.addClass(this.subProgramContainer, "Draggable");
    }
    this.setupReordering(this.classRepeater.node(), "_classData");
    Dom.addClass(this.classContainer, "Draggable");
    this.validateContentSizing();
};

EditDisplayOrderDialog.prototype.setupReordering = function (container, dataName) {
    var thiz = this;
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
    .source(container)
    .anchor(function (node) {
        return Dom.hasClass(node, "DragButton");
    })
    .itemInfo(function (anchor) {
        var item = Dom.findParentWithClass(anchor, "ListItem");
        if (!item) return null;
        return {
            element: item,
            data: dataName
        };
    })
    .destination(container)
    .canDrop(function (data) {
        return data == dataName;
    }
    .bind(this))
    .dropAt(dropTargetFinderFunction)
    .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "ColumnDrag"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        Dom.addClass(draggable, "JustDropped");
        window.setTimeout(function () {
            Dom.removeClass(draggable, "JustDropped");
        }, 100);


        if (Dom.hasClass(draggable, "ProgramItem")) {
            thiz.dropProgramHandler(draggable);
        } else if (Dom.hasClass(draggable, "SubProgramItem")) {
            thiz.dropSubProgramHandler(draggable);
        } else if (Dom.hasClass(draggable, "ClassItem")) {
            thiz.dropClassHandler(draggable);
        }

    }.bind(this);
};

EditDisplayOrderDialog.prototype.validateContentSizing = function () {
    var h = this.dialogBody.offsetHeight;
    this.programContainer.style.height = (h - 7 * Util.em()) + "px";
    this.subProgramContainer.style.height = (h - 7 * Util.em()) + "px";
    this.classContainer.style.height = (h - 7 * Util.em()) + "px";
};

EditDisplayOrderDialog.prototype.removeChildActiveClass = function (parentNode) {
    if (!parentNode) return;
    var activeNodes = parentNode.getElementsByClassName("Active");
    for (var i = 0; i < activeNodes.length; i++) {
        Dom.removeClass(activeNodes[i], "Active");
    }
};

EditDisplayOrderDialog.prototype.setupSubProgram = function (proId) {
    var thiz = this;
    if (this.programObject && this.programObject[proId] && this.programObject[proId].subPrograms) {
        thiz.subProgramRepeater.setItems(this.programObject[proId].subPrograms);
    } else {
        $classMetaService.getSubProgramsByProgram(proId, function (res) {
            thiz.subProgramRepeater.setItems(res.result);
        }, function (err) {});
    }
    this.classRepeater.setItems(null);
};

EditDisplayOrderDialog.prototype.setupClasses = function (subProId) {
    var thiz = this;
    if (this.subProgClassObject && this.subProgClassObject[subProId] && this.subProgClassObject[subProId].classList) {
        this.classRepeater.setItems(this.subProgClassObject[subProId].classList);
    } else {
        $classMetaService.getLessonClassBySubProg(subProId, function (res) {
            thiz.classRepeater.setItems(res.result);
            if (!thiz.subProgClassObject) thiz.subProgClassObject = {};
            for (var i = 0; i < res.result.length; i++) {
                var classItem = res.result[i];
                if (!thiz.subProgClassObject[classItem.subprog_id]) thiz.subProgClassObject[classItem.subprog_id] = {};
                if (!thiz.subProgClassObject[classItem.subprog_id].classList) thiz.subProgClassObject[classItem.subprog_id].classList = [];
                thiz.subProgClassObject[classItem.subprog_id].classList.push(classItem);
            }
        }, function (err) {});
    }

};

EditDisplayOrderDialog.prototype.dropProgramHandler = function (programNode) {
    if (!programNode) return;
    this.programList = [];
    var thiz = this;
    Dom.doOnSelector(this.programRepeater.node(), ".ProgramItem", function (programItem) {
        if (programItem._programData && thiz.programObject[programItem._programData.id]) {
            thiz.programList.push(programItem._programData);
        }
    });
};

EditDisplayOrderDialog.prototype.dropSubProgramHandler = function (subProgramNode) {
    if (!subProgramNode) return;
    var thiz = this, subProgramList = [];
    Dom.doOnSelector(this.subProgramRepeater.node(), ".SubProgramItem", function (subProgramItem) {
        if (subProgramItem._subProgramData) {
            subProgramList.push(subProgramItem._subProgramData);
        }
    });
    if (thiz.programObject[subProgramNode._subProgramData.programId]) {
        thiz.programObject[subProgramNode._subProgramData.programId].subPrograms = subProgramList;
    }

};

EditDisplayOrderDialog.prototype.dropClassHandler = function (classNode) {
    if (!classNode) return;
    var thiz = this, classList = [], subProgramList = [];
    Dom.doOnSelector(this.classRepeater.node(), ".ClassItem", function (classItem) {
        var classData = classItem._classData;
        if (classData) classList.push(classData);
    });

    Dom.doOnSelector(this.subProgramRepeater.node(), ".SubProgramItem", function (subProgramItem) {
        if (subProgramItem._subProgramData.id == classNode._classData.subprog_id) {
            subProgramItem._subProgramData.classList = classList;
        }
        if (subProgramItem._subProgramData) {
            subProgramList.push(subProgramItem._subProgramData);
        }
    });
    if (thiz.programObject[classNode._classData.prog_id]) {
        thiz.programObject[classNode._classData.prog_id].subPrograms = subProgramList;
    }
    if (thiz.subProgClassObject[classNode._classData.subprog_id]) {
        thiz.subProgClassObject[classNode._classData.subprog_id].classList = classList;
    }
};

EditDisplayOrderDialog.prototype.saveButtonClickedHandler = function () {
    var params = [];
    for (var i = 0; i < this.programList.length; i++) {
        var program = this.programList[i];
        var prog = {
            id: program.id,
            subProgs: []
        };
        if (program.subPrograms && program.subPrograms.length) {
            for (var j = 0; j < program.subPrograms.length; j++) {
                var subProg = {
                    id: program.subPrograms[j].id,
                    lessonClasses: []
                };
                if (program.subPrograms[j].classList && program.subPrograms[j].classList.length) {
                    for (var k = 0; k < program.subPrograms[j].classList.length; k++) {
                        var classItem = program.subPrograms[j].classList[k];
                        subProg.lessonClasses.push(classItem.id);
                    }
                }
                prog.subProgs.push(subProg);
            }
        }
        params.push(prog);
    }

    var thiz = this;
    $classMetaService.updateClassMetaOrders(params, function (res) {
        SnackBar.show("Data was saved successfully.");
        thiz.close();
    }, function (err) {});

    console.log(params);

};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/HourRateDialog.js";

function HourRateDialog() {
    ModificationWatchDialog.call(this);
}
__extend(ModificationWatchDialog, HourRateDialog);

HourRateDialog.prototype.setup = function (initialData) {
    this.title = initialData ? "Edit Rate" : "Add A New Rate";
    this.initialData = initialData;
    this.generatedId = this.initialData ? this.initialData.generatedId + "" : Util.newUUID();

    this._setupValidationRules();
    this._renderInitalData(initialData);
    this.setSnapshotInputValues(this.getCurrentInputValues());
};

HourRateDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

HourRateDialog.prototype._renderInitalData = function (initialData) {
    if (!initialData) return;
    this.hours.value = initialData.limitTime.hour || 0;
    this.minutes.value = initialData.limitTime.minute || 0;
    this.rateValue.setValue(initialData.amount);
    Dom.toggleClass(this.timeBox, "Disabled", initialData.unlimited);
};

HourRateDialog.prototype._setupValidationRules = function () {
    var thiz = this;
    this.validationRules = new RuleSet()
        .live(true)
        .custom(new GenericRule(thiz.hours, function () {
            var value = thiz.hours.value.trim();
            if (!value || value < 0) return false;
            return true;
        }, "Hour value is required and must be equal or greater than 0"), null)
        .custom(new GenericRule(thiz.minutes, function () {
            var value = thiz.minutes.value.trim();
            if (!value || value < 0) return false;
            return true;
        }, "Minute value is required and must be equal or greater than 0"), null)
        .custom(new GenericRule(thiz.minutes, function () {
            var hour = thiz.hours.value.trim();
            var minute = thiz.minutes.value.trim();
            if (hour == 0 && minute <= 0) return false;
            return true;
        }, "Invalid Rate range"), null)
        .required(this.rateValue, "Rate value is required")
        .custom(new GenericRule(thiz.rateValue, function () {
            return thiz.rateValue.getValue() > 0;
        }, "Rate value must be positive"), null);
};

HourRateDialog.prototype.getCurrentInputValues = function () {
    return {
        amount: this.rateValue.getValue() || 0,
        limitTime: {
            hour: this.hours.valueAsNumber || 0,
            minute: this.minutes.valueAsNumber || 0,
        },
        generatedId: this.generatedId,
        unlimited: this.initialData && this.initialData.unlimited || false
    }
};

HourRateDialog.prototype.save = function () {
    if(!ValidationManager.run(this.validationRules)) return false;
    this.close(this.getCurrentInputValues());
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/InstructorReport.js";

function InstructorReport() {
    var thiz = this;
    this.attached = false;
    BaseTemplatedWidget.call(this);
    this.bind("p:PageLoaded", function (e) {
        var summary = thiz.dataView.lastResultExtra.summary;
        thiz.totalDuration.innerHTML = summary.totalDurationDisplay;
        thiz.totalClasses.innerHTML = summary.totalClasses;
    }, this.dataView);
    this.bind("click", this.substituteInstructorHandler, this.substituteInstructorBtn);
}
__extend(BaseTemplatedWidget, InstructorReport);

InstructorReport.prototype.onAttached = function(firstTime) {
    if (!firstTime) return;
    var thiz = this;
    if (this.attached) return;
    this.attached = true;
    $classAdminService.getAccountInfo(function (res) {
        window.LOGIN_INFO.teamName = res.teamName;
        thiz.init();
    }, function (err) {});

};

InstructorReport.prototype.init = function() {
    var thiz = this;
    this.dataView.setDefaultSelectionHandler(function(data, fieldName, cell, e) {
        if (!data.classId) return;
        var className = Dom.findParentWithClass(e.target, "ClassName");
        if (className) {
            if (thiz.editClassClickedTimeout) window.clearTimeout(thiz.editClassClickedTimeout);
            thiz.editClassClickedTimeout = window.setTimeout(function () {
                thiz.openEditClassModal({ids: [data.classId]}, data.instructorIds);
            }, 200);
        }

        var instructorDelete = Dom.findParentWithClass(e.target, "InstructorDelete");
        if (instructorDelete) {

            Dialog.confirmDangerousAction("Are you sure you want to delete instructor on this schedule?", null, "Delete", function () {
                $classInstructorService.deleteInstructorOnSlotInstance(data.id, data.instructorId, function (results) {
                    thiz.dataView.refreshDataList();
                }, function (err) {
                    Dialog.error(err.message || "There was an error when delete Instructor.");
                });
            },
            "Cancel", function () {
                return;
            }, null, null);
        }

        var instructorSwap = Dom.findParentWithClass(e.target, "InstructorSwap");
        if (instructorSwap) {
            var canChangeSubstitution = ClassAuthUtils.canSubstituteInstructor(window.ACCOUNT_INFO, data.instructorId) && data.activeClass;
            if (!canChangeSubstitution) return;
            $classAdminService.getValidatedInstructorsOnSlotInstance(data.classSchedId, data.id, function (jobId) {
                thiz._onJobExecuted(jobId, function(result) {
                    thiz.showAvailableInstructors(e.target, result, data);
                }, function(error) {
                    Dialog.error(error.errorMessage || "There was an error when get available Instructor.");
                }, "Loading...");
            }, function (err) {
                Dialog.error(err.message || "There was an error when get available Instructor.");
            });
        }
    });
    this.dataView.registerCustomRenderer("className", function (data, value) {
        var classNameEl = Dom.newDOMElement({
            _name: "span",
            class: "ClassName",
            _text: value
        });
        if (data.slotInstanceRescheduled) Dom.addClass(classNameEl, "Rescheduled");
        return classNameEl;
    });

    this.dataView.registerCustomRenderer("classDate", function (data, value) {
        return data.classDateDisplay;
    });

    this.dataView.registerCustomRenderer("classStart", function (data, value) {
        return data.classStartDisplay;
    });

    this.dataView.registerCustomRenderer("classEnd", function (data, value) {
        return data.classEndDisplay;
    });

    this.dataView.registerCustomRenderer("duration", function (data, value) {
        return data.durationDisplay;
    });

    this.dataView.registerCustomRenderer("activeClass", function (data, value) {
        if (value) {
            return "Active";
        } else {
            return "Past";
        }
    });

    var attendanceActions = [];
    if (ClassAuthUtils.canViewClassAttendance(LOGIN_INFO) || window.LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass) {
        attendanceActions.push({
            title: "Print/Export Attendance",
            run: function (items) {
                thiz.dataView.getSelectedItems(function (selectedItems) {
                    thiz.getSelectedClassDetetail(selectedItems, function (classList) {
                        thiz.printAttendanceClickedHandler(classList);
                    })
                });
            },
            applicable: function (count, dataView) {
                return count > 0;
            }
        });
    }

    if (LOGIN_INFO.isAbleTakeAttendance || LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass) {
        attendanceActions.push({
            title: "Track Attendance",
            run: function (items) {
                thiz.dataView.getSelectedItems(function (selectedItems) {
                    thiz.getSelectedClassDetetail(selectedItems, function (classList) {
                        thiz.trackAttendanceClickedHandler(classList);
                    })
                });
            },
            applicable: function (count, dataView) {
                return count > 0;
            }
        });
    }
    if (LOGIN_INFO.isAbleTakeSkill) {
        attendanceActions.push({
            title: "Track Skills",
            run: function (items) {
                thiz.dataView.getSelectedItems(function (selectedItems) {
                    thiz.getSelectedClassDetetail(selectedItems, function (classList) {
                        thiz.trackSkillsClickedHandler(classList);
                    })
                });
            },
            applicable: function (count, dataView) {
                return count > 0;
            }
        });
    }
    if (attendanceActions.length) this.dataView.registerActions(attendanceActions, "Attendance & Skills");


    this.dataView.registerCustomRenderer("fullName", function (data, value) {
        return thiz.getInstructorNameNode(data);
    });
    this.showInstructorInfoTip();

    this.dataView.registerActions([{
        title: "Export to Excel", icon: "file-excel",
        important: true,
        run: function () {
            thiz.dataView.getSelectedItems(function (results) {
                var ids = [], instructorIds = [];
                results.forEach(function (result) {
                    ids.push(result.id);
                    instructorIds.push(result.instructorId);
                });
                $classAdminService.generateDownloadableInstructorReportAsExcel(ids, instructorIds, function (fileUrl) {
                    Util.initiateDownload(fileUrl);
                }, "Exporting...");
            });
        }.bind(this),
        applicable: function (count, dataView) {
            return count > 0;
        }
    }], "");
    this.dataView.registerActions([{
        title: "Print", icon: "printer",
        important: true,
        runOnIds: this.printReport.bind(this),
        applicable: function (count, dataView) {
            return count > 0;
        }
    }], "");
    this.dataView.comparer = function (a, b) {
        return a.fakeKey == b.fakeKey;
    };
    this.dataView.getItemUniqueId = function (item) {
        return item.fakeKey;
    };
    this.dataView.boot();
};

InstructorReport.prototype._onJobExecuted = function(jobId, onSuccess, onError, executingMessage) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var busyIndicator = new Spinner(executingMessage);
    busyIndicator.busy();

    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                        busyIndicator.done();
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        busyIndicator.done();
                        onError({errorMessage: job.errorMessage});
                    }
                } else {
                    busyIndicator.done();
                    onFailed({errorMessage: "Job not found."});
                }
            }, function (error) {
                busyIndicator.done();
                onFailed(error);
            });
        }, 1000);
    })();
};

InstructorReport.prototype.getInstructorNameNode = function(data) {
    var node = Dom.newDOMElement({
        _name: "hbox",
        class: "InstructorWrap",
        _text: data.fullName
    });
    if ((data.instConflict && data.instConflictCode != "NO_CONFLICT") || (data.substitutionSlotInstanceId)) {
        if ((data.instConflict && data.instConflictCode != "NO_CONFLICT") ){
            var className = data.instConflictCode == "NOT_FULL_DURATION" ? "NotFullDuration" : "NotAvailable";
            var warning = Dom.newDOMElement({
                _name: "icon",
                class: "alert-box InstructorWarning " + className
            });
            node.appendChild(warning);
        }

        node.appendChild(Dom.newDOMElement({
            _name: "div",
            class: "Space"
        }));


        if (ClassAuthUtils.canCreateEditDeleteClass(window.ACCOUNT_INFO)) {
            var instDelete = Dom.newDOMElement({
                _name: "div",
                title: "Delete",
                class: "InstructorDelete",
                _children: [
                    {_name: "icon", class: "delete-forever Delete"}
            ]});
            node.appendChild(instDelete);
        }

        var canChangeSubstitution = ClassAuthUtils.canSubstituteInstructor(window.ACCOUNT_INFO, data.instructorId) && data.activeClass;
        if (data.substitutionSlotInstanceId || canChangeSubstitution) {
            var swapInst = Dom.newDOMElement({
                _name: "div",
                title: "Substitute",
                class: "InstructorSwap",
                _children: [
                    {_name: "icon", class: "swap-horizontal Swap"}
            ]});
            if (canChangeSubstitution) Dom.addClass(swapInst, "CanSwapInstructor");
            node.appendChild(swapInst);
        }
    }
    return node;
};

InstructorReport.prototype.showInstructorInfoTip = function() {
    var tip = null;
    this.dataView.node().addEventListener("mouseover", function (event) {
        if (!Dom.hasClass(event.target, "InstructorWarning")) return;
        var node = Dom.findParentWithClass(event.target, "DTEvenSection");
        if (!node) return;
        var data = DataTable.getRowData(node);
        if (!data) return;
        var type = data.instConflictCode == 'NOT_FULL_DURATION' ? "warning" : "error";
        if (tip != null) {
            tip.kill();
        }
        tip = InfoTip.show(event.target, data.instConflictMessage, false, null, type, null, -20, -5);
    });
    this.dataView.node().addEventListener("mouseout", function (event) {
        if (tip != null) {
            tip.kill();
        }
    });
};

InstructorReport.prototype.substituteInstructorHandler = function() {
    var thiz = this;
    var data = this.instructorsPopupContainer.data;
    var selectedInstructor = this.instructorsPopupContainer.querySelector("input[name=\"instructor\"]:checked");
    if (selectedInstructor) {
        var substituteInstId = Number(selectedInstructor.value);
        $classInstructorService.substituteInstructorOnSlotInstance(data.id, substituteInstId, data.instructorId, function (results) {
            thiz.dataView.refreshDataList();
        }, function (err) {
            Dialog.error(err.message || "There was an error when swap Instructor.");
        });
    }
    this.instructorsPopup.close();
}

InstructorReport.prototype.showAvailableInstructors = function (target, result, data) {
    this.instructorsPopupContainer.innerHTML = "";
    var thiz = this;
    if (result) {
        result.forEach(function(instructor) {
            var wrapper = document.createElement("hbox");
            Dom.addClass(wrapper, "item-wrapper");
            var checkbox = document.createElement("input");
            checkbox.setAttribute("type", "radio");
            checkbox.setAttribute("name", "instructor");
            var checkboxId = widget.random() + "_" + instructor.id;
            checkbox.setAttribute("id", checkboxId);
            checkbox.value = instructor.id;
            wrapper.appendChild(checkbox);

            var spanInstructorName = document.createElement("label");
            spanInstructorName.setAttribute("flex", 1);
            spanInstructorName.setAttribute("for", checkboxId);
            spanInstructorName.innerHTML = instructor.fullName;
            spanInstructorName.title = instructor.fullName;
            wrapper.appendChild(spanInstructorName);

            if (instructor.conflictCode && instructor.conflictCode != "NO_CONFLICT") {
                var className = thiz.setupInstructorAlert(wrapper, instructor, "alert-circle");
                Dom.addClass(spanInstructorName, className);
                if (instructor.conflictCode != "NOT_FULL_DURATION") {
                    Dom.addClass(checkbox, "Disable");
                    spanInstructorName.removeAttribute("for");
                }
            }
            thiz.instructorsPopupContainer.appendChild(wrapper);
        });
    }
    this.instructorsPopupContainer.data = data;
    this.instructorsPopupContainer.parentNode.style.padding = "0 0.5em";
    this.instructorsPopupContainer.parentNode.style.background = "#EEE";
    this.instructorsPopup.show(target, "left-inside", "top", 0, 5, true);
}

InstructorReport.prototype.setupInstructorAlert = function(wrapper, instructor, classIcon) {
    var className = instructor.conflictCode == "NOT_FULL_DURATION" ? "NotFullDuration" : "NotAvailable";
    var warning = Dom.newDOMElement({
        _name: "icon",
        class: classIcon + " EventWarning " + className
    });
    wrapper.appendChild(warning);
    var type = instructor.conflictCode == 'NOT_FULL_DURATION' ? "warning" : "error";
    var tip = null;
    warning.addEventListener("mouseover", function (event) {
        if (tip != null) {
            tip.kill();
        }
        tip = InfoTip.show(warning, instructor.conflictedCustomMessage, false, null, type, null, -20, -5);
    });
    warning.addEventListener("mouseout", function (event) {
        if (tip != null) {
            tip.kill();
        }
    });
    return className;
};

InstructorReport.prototype.getDateRange = function (namedDate) {
    if (namedDate.from != null || namedDate.to != null) return namedDate;
    if (namedDate.name != null ) {
        var fromDate = moment.tz(new Date(), TimezoneProviders.local.getTimezoneId()).hour(0).minute(0).second(0).millisecond(0);
        var toDate = moment.tz(new Date(), TimezoneProviders.local.getTimezoneId()).hour(23).minute(59).second(59).millisecond(999);
        switch (namedDate.name) {
            case "today":
                namedDate.from = fromDate.toDate();
                namedDate.to = toDate.toDate();
                break;
            case "last7Days":
                fromDate.add(-6, "d");
                namedDate.from = fromDate.toDate();
                namedDate.to = toDate.toDate();
                break;
            case "thisMonth":
                fromDate.date(1);
                toDate.date(1);
                toDate.add(1, "M");
                toDate.add(-1, "d");
                namedDate.from = fromDate.toDate();
                namedDate.to = toDate.toDate();
                break;
            case "lastMonth":
                fromDate.date(1);
                fromDate.add(-1, "M");
                toDate.date(1);
                toDate.add(-1, "d");
                namedDate.from = fromDate.toDate();
                namedDate.to = toDate.toDate();
                break;
            case "last1Month":
                fromDate.add(-30, "d");
                namedDate.from = fromDate.toDate();
                namedDate.to = toDate.toDate();
                break;
            case "last3Month":
                fromDate.add(-90, "d");
                namedDate.from = fromDate.toDate();
                namedDate.to = toDate.toDate();
                break;
            case "thisYear":
                fromDate.date(1);
                fromDate.date(1);
                toDate.month(1);
                toDate.month(1);
                toDate.add(1, "y");
                toDate.add(-1, "d");
                namedDate.from = fromDate.toDate();
                namedDate.to = toDate.toDate();
                break;
            default: break;
        }
    }

    return namedDate;
};

InstructorReport.prototype.printReport = function (id) {
    var thiz = this;
    this.dataView.getSelectedItems(function (results) {
        results.sort(function (a, b) {
            return a.classDate.getTime() - b.classDate.getTime();
        });
        var mapData = {}, resultList = [];
        for (var i = 0; i < results.length; i ++) {
            var result = results[i];
            var classDate = result.classDate;
            classDate.setHours(0);
            classDate.setMinutes(0);
            classDate.setSeconds(0);
            classDate.setMilliseconds(0);
            if (!mapData[classDate.getTime()]) {
                mapData[classDate.getTime()] = [];
                resultList.push({
                    date: FormatUtil.formatDate(classDate, "date_named_full_weekday", "local"),
                    items: mapData[classDate.getTime()]
                });
            }
            var dataRow = {
                className: result.className,
                classStart: result.classStartDisplay,
                classEnd: result.classEndDisplay,
                duration: result.durationDisplay,
                fullName: result.fullName,
                mapAddress: (result.mapAddress && result.mapAddress.length > 0) ? result.mapAddress : "",
                mapState: (result.mapState && result.mapState.length > 0) ? result.mapState : "",
                mapZip: (result.mapZip && result.mapZip.length > 0) ? result.mapZip : "",
                locationName: (result.locationName && result.locationName.length > 0) ? result.locationName : "",
                slotInstanceRescheduled: result.slotInstanceRescheduled
            };

            mapData[classDate.getTime()].push(dataRow);
        }

        var classDateFilterValue = thiz.dataView.filterView.getValueMap().classDate;
        var dateRange = thiz.getDateRange(classDateFilterValue);
        var dateRangeDisplay = "";
        if (dateRange.from != null) {
            dateRangeDisplay = FormatUtil.formatDate(dateRange.from, "date_named_full_weekday", "local");
        }
        if (dateRange.to != null) {
            if (dateRangeDisplay.length > 0) dateRangeDisplay += " - ";
            dateRangeDisplay += FormatUtil.formatDate(dateRange.to, "date_named_full_weekday", "local");
        }

        var exportedData  = {
            data: {
                teamName: window.LOGIN_INFO.teamName,
                dateRangeDisplay: dateRangeDisplay,
                resultList: resultList
            },
            generatedTime: FormatUtil.formatDate(new Date(), "datetime_standard", "local")
        };

        widget.__ensureNamespaceLoaded("print", function (print) {
            new print.PDFExportDialog().open({
                template: InstructorReport.generateReportTemplate(thiz.dataView.savedView.columns),
                data: exportedData,
                jobName: "Instructor Report"
            });
        });
    });
};

InstructorReport.prototype.openEditClassModal = function(option, instructorIds) {
    if (!ClassAuthUtils.canOpenClassDetail(window.ACCOUNT_INFO, instructorIds)) return;

    var thiz = this;
    thiz.classEditDialog = new ClassEditDialog();
    thiz.classEditDialog.callback(function(data) {
        thiz.saveClassCallback(data);
    }).open(option);
};

InstructorReport.prototype.saveClassCallback = function(data) {
    var thiz = this;
    if (data && data.success && data.classData) {
        if (data.classData.classDressCode) {
            data.classData.classDressCode.classId = res.id;
            thiz.saveClassDressCode(data.classData.classDressCode, function() {
                thiz.dataView.refreshDataList();
                Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
            })
            return;
        }
        thiz.dataView.refreshDataList();
    } else {
        if ((thiz.classEditDialog && thiz.classEditDialog.reloadOnClose) || (data && data.reloadOnClose)) {
            console.log("RELOAD CLASS LIST", data);
            thiz.dataView.refreshDataList();
            Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
        }
    }

};

InstructorReport.prototype.saveClassDressCode = function(classDressCode, callback) {
    widget.__ensureNamespaceLoaded("discountdance", function(namespace) {
        if (namespace) {
            namespace.util.saveClassDressCode(classDressCode, function(rs) {
                if (callback) callback(rs);
            });
            return;
        }
        if (callback) callback();
    });
};

InstructorReport.generateReportTemplate = function(columns) {
    return {
        pageSize: 'A4',
        pageOrientation: 'landscape',
        pageMargins: [ 20, 40, 20, 20 ],
        "footer": {
            text: "Generated at ${generatedTime}",
            alignment: "left",
            style: "footer"
        },
        "content": [
            {
                text: "${data.teamName} Class Schedule",
                alignment: "center",
                style: "header"
            },
            {
                text: "${data.dateRangeDisplay}",
                alignment: "center",
                style: "header"
            },
            {
                $repeatOn: "data.resultList",
                stack: [
                    {
                        text: "${date}",
                        style: "header"
                    },
                    {
                        style: "noBorderTable",
                        "table": {
                            "headerRows": 1,
                            dontBreakRows: true,
                            "widths": ['*', 60, 60, 60, '*', 120, 50, 50, 100],
                            "body": [
                                ["Class", "Start", "End", "Duration", "Instructor", "Address", "State", "Zip", "Location Name"],
                                {
                                    $repeatOn: "items",
                                    $itemTemplate: [
                                        {text: ["${className}", {$when: "slotInstanceRescheduled", text: " (Rescheduled)", italics: true}]},
                                        {text: "${classStart}"},
                                        {text: "${classEnd}"},
                                        {text: "${duration}"},
                                        {text: "${fullName}"},
                                        {text: "${mapAddress}"},
                                        {text: "${mapState}"},
                                        {text: "${mapZip}"},
                                        {text: "${locationName}"}
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        ],
        "styles": {
            "header": {
                "fontSize": 16,
                "bold": true,
                "margin": [ 0, 10, 0, 10 ]
            },
            "noBorderTable": {
                "margin": [0, 0, 0, 20]
            },
            "footer": {
                "fontSize": 8,
                "italics": true,
                "margin": [20, 0, 20, 0]
            }
        },
        "defaultStyle": {},
        images: {}
    }
};

InstructorReport.prototype.getSelectedClassDetetail = function (items, callback) {
    if (!items) return;
    var classIds = [];
    var thiz = this;
    this.classSlotObject = {};
    items.forEach(function (item) {
        if (!thiz.classSlotObject[item.classId]) {
            thiz.classSlotObject[item.classId] = {};
            classIds.push(item.classId);
        }
        thiz.classSlotObject[item.classId][item.slot] = true;
    });
    $classAdminService.getClassDetailByIds(classIds, function (res) {
        if (callback) callback(res.result);
    }, function (err) {

    }, "Loading...");
};

InstructorReport.prototype.getSelectedSlots = function (classItem, myInstructorSlotOnly) {
    var selectedSlots = [];
    if (!classItem) return selectedSlots;
    if (!this.classSlotObject) return selectedSlots;
    var thiz = this;
    if (classItem.slots && classItem.slots.length > 0) {
        classItem.slots.forEach(function (slot) {
            var canViewAttendance = !myInstructorSlotOnly || (window.LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass && slot.instructorIds.includes(LOGIN_INFO.accountId));
            if (canViewAttendance && thiz.classSlotObject[classItem.id] && thiz.classSlotObject[classItem.id][slot.slot] == true) {
                selectedSlots.push(slot);
            }
        });
    }
    return selectedSlots;
};

InstructorReport.prototype.printAttendanceClickedHandler = function(items) {
    if (!items) return;
    if (items.length == 0) return;
    var thiz = this;
    var classList = [];
    for (var i = 0; i < items.length; i ++) {
        var classItem = {
            id: items[i].id,
            title: items[i].title,
            slots: this.getSelectedSlots(items[i], !ClassAuthUtils.canViewClassAttendance(LOGIN_INFO)),
            detail: items[i],
            timezoneId: items[i].timezoneId
        };
        if (classItem.slots.length > 0) {
            classList.push(classItem);
        }
    }
    if (classList.length == 0) {
        Dialog.error("", "There are no slots to Print Attendance.", null);
        return;
    }
    new PrintAttendanceDialog().callback(function(data) {}).open({
        classList: classList,
        enableGroupAttendanceNote: LOGIN_INFO.enableGroupAttendanceNote,
        enableClassRooomAttendanceNote: LOGIN_INFO.enableClassRooomAttendanceNote,
        classRoomAttendanceNoteLabel: LOGIN_INFO.classRoomAttendanceNoteLabel
    });
};

InstructorReport.prototype.trackAttendanceClickedHandler = function(items) {
    if(!items) return;
    if(items.length == 0) return;
    var thiz = this;
    var classList = [];
    for (var i = 0; i < items.length; i ++) {
        var classItem = {
            id: items[i].id,
            title: items[i].title,
            slots: this.getSelectedSlots(items[i], !LOGIN_INFO.isAbleTakeAttendance),
            timezoneId: items[i].timezoneId,
            googleMapLink: items[i].googleMapLink,
            lessonLocId: items[i].lessonLocId,
            lessonLocName: items[i].lessonLocName,
            detail: items[i]
        };

        if(classItem.slots.length > 0) {
            classList.push(classItem);
        }
    }
    if (classList.length == 0) {
        Dialog.error("", "There are no slots to Track Attendance.", null);
        return;
    }
    new TrackAttendanceDialog().callback(function (data) {}).open({
        classList: classList,
        enableGroupAttendanceNote: LOGIN_INFO.enableGroupAttendanceNote,
        enableClassRooomAttendanceNote: LOGIN_INFO.enableClassRooomAttendanceNote,
        classRoomAttendanceNoteLabel: LOGIN_INFO.classRoomAttendanceNoteLabel
    });
};

InstructorReport.prototype.trackSkillsClickedHandler = function(items) {
    if(!items) return;
    if(items.length == 0) return;
    var thiz = this;
    var classList = [];
    for (var i = 0; i < items.length; i ++) {
        var classItem = {
            id: items[i].id,
            title: items[i].title,
            progName: items[i].progName,
            subProgName: items[i].subProgName,
            duration: items[i].duration,
            instructorNames: items[i].instructorNames,
            timezoneId: items[i].timezoneId,
            slots: this.getSelectedSlots(items[i])
        };

        if(classItem.slots.length > 0) {
            classList.push(classItem);
        }
    }
    if (classList.length == 0) {
        Dialog.error("", "There are no slots to Track Skills.", null);
        return;
    }
    new TrackSkillsDialog().callback(function(data) {

    }).open({classList: classList});
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/InstructorsManagementWidget.js";

function InstructorsManagementWidget() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.searchTextValue = "";
    var teamAlias = window.TEAM_ALIAS;
    
    if (teamAlias) {
        this.accountListView.populator = function (data, binding, node) {
            node._data = data;
            binding.accountAvatar.src = "/rest/accounts/avatar/cdn/" + teamAlias + "/" + data.id + "?w=200";
            binding.accountName.innerHTML = data.fullName;
            binding.accountName.title = data.fullName;
        };
        
        this.instructorsListView.populator = function (data, binding, node) {
            node._data = data;
            binding.instructorAvatar.src = "/rest/accounts/avatar/cdn/" + teamAlias + "/" + data.id + "?w=200";
            binding.instructorName.innerHTML = data.fullName;
            binding.instructorName.title = data.fullName;
        };
    } else {
        $classAdminService.getAccountInfo(function(res) {
            teamAlias = res.teamAlias;
            thiz.accountListView.populator = function (data, binding, node) {
                node._data = data;
                binding.accountAvatar.src = "/rest/accounts/avatar/cdn/" + teamAlias + "/" + data.id + "?w=200";
                binding.accountName.innerHTML = data.fullName;
                binding.accountName.title = data.fullName;
            };
            
            thiz.instructorsListView.populator = function (data, binding, node) {
                node._data = data;
                binding.instructorAvatar.src = "/rest/accounts/avatar/cdn/" + teamAlias + "/" + data.id + "?w=200";
                binding.instructorName.innerHTML = data.fullName;
                binding.instructorName.title = data.fullName;
            };
        }, function(err) {});
    }
    
    this.bind("click", this.cancelButtonClickHandler, this.cancelButton);
    this.bind("click", this.updateButtonClickHandler, this.updateButton);
    Dom.registerEvent(this.searchText, "input", this.searchTextInputHandler.bind(this), true);
    this.bind("click", this.searchButtonClickHandler, this.searchButton);
    this.bind("click", this.listContentWrapperClickHandler, this.listContentWrapper);
    
    
}
__extend(BaseTemplatedWidget, InstructorsManagementWidget);

InstructorsManagementWidget.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        thiz.onAttachedDelayed();
    }, 10);
};
InstructorsManagementWidget.prototype.onAttachedDelayed = function() {
    var thiz = this;
    $classAdminService.getInstructorsInfo(function(res) {
        thiz.activeAccounts = res.activeAccounts;
        thiz.instructors = res.instructors;
        // thiz.defaultActiveAccounts = Object.assign([], res.activeAccounts);
        // thiz.defaultInstructors = Object.assign([], res.instructors);
        thiz.defaultActiveAccounts = [];
        thiz.defaultInstructors = [];
        for(var i = 0; i < res.activeAccounts.length; i ++) {
            var acc = res.activeAccounts[i];
            var newAcc = {};
            for(var key in acc) {
                newAcc[key] = acc[key];
            }
            thiz.defaultActiveAccounts.push(newAcc);
        }
        
        for(var i = 0; i < res.instructors.length; i ++) {
            var ins = res.instructors[i];
            var newIns = {};
            for(var key in ins) {
                newIns[key] = ins[key];
            }
            thiz.defaultInstructors.push(newIns);
        }
        
        
        thiz.renderAvailableAccounts();
        thiz.renderInstructors();
        thiz.updateButton.setAttribute("disabled", "disabled");
        thiz.cancelButton.setAttribute("disabled", "disabled");
    }, function(err) {});
    var h = window.height? window.height : window.innerHeight;
    var delta = Dom.getOffsetTop(this.containerWrapper);
    this.containerWrapper.style.height = (h > delta*2? (h - delta) + "px" : ("5em"));
};

InstructorsManagementWidget.prototype.cancelButtonClickHandler = function () {
    this.activeAccounts = Object.assign([], this.defaultActiveAccounts);
    this.instructors = Object.assign([], this.defaultInstructors);
    this.renderAvailableAccounts();
    this.renderInstructors();
    this.updateButton.setAttribute("disabled", "disabled");
    this.cancelButton.setAttribute("disabled", "disabled");
};

InstructorsManagementWidget.prototype.updateButtonClickHandler = function () {
    var thiz = this;
    var ids = [];
    for(var i = 0; i < this.instructors.length; i ++) {
        ids.push(this.instructors[i].id);
    }
    $classAdminService.updateSelectedCoaches(ids, function(res) {
        Dialog.alert("Info", "Saved Selected Instructors success!", function() {
            $classAdminService.getInstructorsInfo(function(res) {
                thiz.activeAccounts = res.activeAccounts;
                thiz.instructors = res.instructors;
                thiz.defaultActiveAccounts = Object.assign([], res.activeAccounts);
                thiz.defaultInstructors = Object.assign([], res.instructors);
                
                thiz.renderAvailableAccounts();
                thiz.renderInstructors();
                thiz.updateButton.setAttribute("disabled", "disabled");
                thiz.cancelButton.setAttribute("disabled", "disabled");
            }, function(err) {});
        });
        
    }, function(err) {});
};

InstructorsManagementWidget.prototype.listContentWrapperClickHandler = function (e) {
    if(Dom.hasClass(e.target, "add-action") || Dom.hasClass(e.target.parentNode, "add-action")) {
        var itemNode = Dom.findUpwardForNodeWithData(e.target, "_data");
        this.addNewInstructor(itemNode);
    } else if(Dom.hasClass(e.target, "remove-action") || Dom.hasClass(e.target.parentNode, "remove-action")) {
        var itemNode = Dom.findUpwardForNodeWithData(e.target, "_data");
        this.removeInstructor(itemNode);
    }
};

InstructorsManagementWidget.prototype.addNewInstructor = function (itemNode) {
    if(!itemNode) return;
    if(!this.instructors) this.instructors = [];
    var itemData = Object.assign({}, itemNode._data);
    itemData.isNew = true;
    this.instructors.splice(0, 0, itemData);
    
    var newRow = document.createElement("hbox");
    newRow._data = itemData;
    newRow.setAttribute("role", "item");
    Dom.addClass(newRow, "Row NewItem");
    newRow._data = itemData;
    
    var avatarWrapper = document.createElement("div");
    avatarWrapper.setAttribute("class", "avatar");
    var avatar = document.createElement("img");
    avatar.src = "/rest/accounts/avatar/cdn/" + TEAM_ALIAS + "/" + itemData.id + "?w=200";
    avatarWrapper.appendChild(avatar);
    newRow.appendChild(avatarWrapper);
    
    var instructorName = document.createElement("div");
    Dom.addClass(instructorName, "instructor-name");
    instructorName.setAttribute("flex", 1);
    instructorName.innerHTML = itemData.fullName;
    newRow.appendChild(instructorName);
    
    var actionWrapper = document.createElement("a");
    Dom.addClass(actionWrapper, "remove-action");
    actionWrapper.innerHTML = '<icon class="minus-circle"></icon> Remove';
    newRow.appendChild(actionWrapper);
    
    var instructorRows = this.instructorsListView.node().getElementsByTagName("hbox");
    if(instructorRows && instructorRows[0]) {
        this.instructorsListView.node().insertBefore(newRow, instructorRows[0]);
    } else {
        this.instructorsListView.node().appendChild(newRow);
    }
    this.selectedCoachesCount.innerHTML = this.instructors.length;
    for(var i = 0; i < this.activeAccounts.length; i ++) {
        if(this.activeAccounts[i].id == itemData.id) {
            this.activeAccounts.splice(i, 1);
            break;
        }
    }
    this.renderAvailableAccounts();
    this.updateButton.removeAttribute("disabled");
    this.cancelButton.removeAttribute("disabled");
};

InstructorsManagementWidget.prototype.removeInstructor = function (itemNode) {
    if(!itemNode) return;
    if(!this.activeAccounts) this.activeAccounts = [];
    var itemData = Object.assign({}, itemNode._data);
    this.activeAccounts.push(itemData);
    this.renderAvailableAccounts();
    
    for(var i = 0; i < this.instructors.length; i ++) {
        if(this.instructors[i].id == itemData.id) {
            this.instructors.splice(i, 1);
            var instructorRows = this.instructorsListView.node().getElementsByTagName("hbox");
            if(instructorRows && instructorRows[i]) {
                this.instructorsListView.node().removeChild(instructorRows[i]);
            }
            break;
        }
    }
    this.selectedCoachesCount.innerHTML = this.instructors.length;
    this.updateButton.removeAttribute("disabled");
    this.cancelButton.removeAttribute("disabled");
};

InstructorsManagementWidget.prototype.renderAvailableAccounts = function() {
    var thiz = this;
    var filteredAccounts = this.activeAccounts.filter(function(item) {
        return item.fullName.toUpperCase().indexOf(thiz.searchText.value.toUpperCase()) >= 0;
    });
    filteredAccounts.sort(function(a, b) {
        var nameA = a.fullName.toUpperCase();
        var nameB = b.fullName.toUpperCase();
        if (nameA < nameB) {
            return -1;
        }
        if (nameA > nameB) {
            return 1;
        }
        return 0;
    });
    
    this.accountListView.setItems(filteredAccounts);
};

InstructorsManagementWidget.prototype.renderInstructors = function() {
    this.instructorsListView.setItems(this.instructors);
    this.selectedCoachesCount.innerHTML = this.instructors.length;
};

InstructorsManagementWidget.prototype.searchTextInputHandler = function () {
    var thiz = this;
    this.searchTextValue = this.searchText.value;
    if(this.inputingSearchTextTimeout) {
        clearTimeout(this.inputingSearchTextTimeout);
    }
    this.inputingSearchTextTimeout = window.setTimeout(function() {
        thiz.renderAvailableAccounts();
    }, 200);
};
InstructorsManagementWidget.prototype.searchButtonClickHandler = function () {
    var thiz = this;
    if(this.searchTextValue != this.searchText.value) {
        this.renderAvailableAccounts();    
    }
};






if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/LegacyIframeWidget.js";

function LegacyIframeWidget(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.options = options;

    this.closable = {
            close: function () {
                thiz.collapseActionClickHandler();
            }
        };
    this.bind("click", this.expandActionClickHandler, this.expandAction);
    this.bind("click", this.collapseActionClickHandler, this.collapseAction);
}

__extend(BaseTemplatedWidget, LegacyIframeWidget);

LegacyIframeWidget.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        thiz.onAttachedDelayed();
    }, 100);
};
LegacyIframeWidget.prototype.onAttachedDelayed = function() {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.hasOwnProperty("allowClassPaymentPlan")) {
        this.renderIframe(window.LOGIN_INFO.allowClassPaymentPlan);
    } else {
        $classAdminService.getAccountInfo(function (res) {
            thiz.renderIframe(res.allowClassPaymentPlan);
        }, function (err) {});
    }
    
};
LegacyIframeWidget.prototype.renderIframe = function (allowClassPaymentPlan) {
    var thiz = this;
    var title = "Reports";
    var reportType = (this.options && this.options.reportType)? this.options.reportType : 
                            (this.getReportType? this.getReportType() : Util.getProperty(this.node(), "reportType", "revenue")),
        showExpandAction = false;//Util.getProperty(this.options, "showExpandAction", false);
//    var dialog = this.findUpward(ReportDialog);
    console.log("---", reportType, this.options);
    
    var iframeSrc = "/LegacyPopup.jsp?type=" + reportType;
    if (reportType == "coa") {
        title = "Chart of Accounts";
    } else if (reportType == "trans") {
        title = "Income Transaction Reports";
    } else if (reportType == "revenue") {
        title = "Classes Reports";
    } else if (reportType == "reports") {
        title = "Admin Reports";
        var searchParams = window.location.search;
        if(searchParams && searchParams.indexOf("classReportType") > 0) {
            if (searchParams.indexOf("?") > 0) searchParams = "?" + searchParams;
            iframeSrc = "/LegacyPopup.jsp" + searchParams + "&type=" + reportType + "&allowClassPaymentPlan=" + (allowClassPaymentPlan ? "1" : "0");
        } else {
            iframeSrc = "/LegacyPopup.jsp?type=" + reportType + "&allowClassPaymentPlan=" + (allowClassPaymentPlan ? "1" : "0");
        }
    } else if (reportType == "heatmap") {
        title = "Heat Map Reports";
    } else if (reportType == "student") {
        title = "Athletes";
    } else if (reportType == "instructors") {
        title = "Instructor Report";
        iframeSrc = "/LegacyInstructor.jsp?type=" + reportType;
    } else {
        this.titleHeader.style.display = "none";
    }
    if(showExpandAction) {
        this.tableAction.style.display = "flex";
    } else {
        this.tableAction.style.display = "none";
    }

    window.setTimeout(function() {
        var r = (reportType == "student")? thiz.__node.parentNode : Dom.findParentWithClass(thiz.__node, "ReportsContainer");
        var w = (r? (r.clientWidth) : -1) - (reportType == "student"? 50: 0);
        iframeSrc = iframeSrc + "&width=" + (Math.round(w * 0.98) - 20);
        var iframeContent = '<iframe name="iframe_LegacyWidget" id="iframe_LegacyWidget" ' +
        'src="' + iframeSrc + '" frameborder="0" width="' + (w > 0? w + "px" : "100%") + '" height="100%" style="min-height: 400px;"></iframe>';
        thiz.legacyFrame.innerHTML = iframeContent;
        thiz.titleHeader.innerHTML = title;

    }, 500);


};


LegacyIframeWidget.prototype.expandActionClickHandler = function() {
    Dom.addClass(document.getElementById("colMain_contentMain"), "fullscreen");
    BaseWidget.registerClosable(this.closable);
};

LegacyIframeWidget.prototype.collapseActionClickHandler = function() {
    Dom.removeClass(document.getElementById("colMain_contentMain"), "fullscreen");
    BaseWidget.unregisterClosable(this.closable);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/LocationMapDialog.js";

function LocationMapDialog() {
    Dialog.call(this);
    var thiz = this;
    
    this.currentClass = null;
    this.options = {};
}

__extend(Dialog, LocationMapDialog);

LocationMapDialog.prototype.setup = function(options) {
    var thiz = this;
    this.options = options;
    this.renderDialog();
    
};

LocationMapDialog.prototype.getDialogActions = function() {
    var thiz = this;
    this.title = "Open Map";
    var actions = [
        {
            type: "cancel", title: "Close",
            order: 1,
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
    
    return actions;
};

LocationMapDialog.prototype.renderDialog = function () {
    var thiz = this;
    var frameContent = "<iframe src='" + this.options.link + "' frameBorder='0' scrolling='no' seamless='seamless' width='100%' height='100%' style='min-height: 600px;'></iframe>";
    this.googleMapFrame.innerHTML = frameContent;
};












if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ManageStudentDialog.js";

function ManageStudentDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    var thiz = this;
    
    this.bind("click", this.cancelButtonClickHandler, this.cancelButton);
    this.bind("click", this.indexActionNextClickHandler, this.indexActionNext);
    this.bind("click", this.indexActionPrevClickHandler, this.indexActionPrev);
    
    this.currentClass = null;
    this.options = {};
}

__extend(Dialog, ManageStudentDialog);

ManageStudentDialog.prototype.setup = function(options) {
    var thiz = this;
    this.options = options;
    this.classIdIndex = 0;
    
    this.currentClassId = options.currentClassId;
    if (options.classes){
        for(var i = 0; i < options.classes.length; i++){
            if(this.currentClassId == options.classes[i].id){
                this.classIdIndex = 0;
                break;
            }
        }
    }
    this.renderManageStudentDialog();
    
};

ManageStudentDialog.prototype.getDialogActions = function() {
    var thiz = this;
    this.title = "Manage Athletes";
    var actions = [
        {
            type: "cancel", title: "Close",
            order: 1,
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
    
    return actions;
};

ManageStudentDialog.prototype.renderManageStudentDialog = function () {
    var thiz = this;
    this.currentClass = this.options.classes[this.classIdIndex];
    var ids = this.options.classes;
    if(ids) {
        if(ids.length > 1) {
            this.editClassIndex.innerHTML = "Class " + (this.classIdIndex + 1) + " of " + ids.length;
        } else {
            this.indexAction.parentNode.removeChild(this.indexAction);
        }
        if(this.classIdIndex == 0) {
            Dom.addClass(this.indexActionPrev, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionPrev, "action-disabled");
        }
        if(this.classIdIndex == ids.length - 1) {
            Dom.addClass(this.indexActionNext, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionNext, "action-disabled");
        }
    } else {
        this.indexAction.parentNode.removeChild(this.indexAction);
    }
    this.currentClass = ids[this.classIdIndex];
    if(this.currentClass){
        this.currentClassId = this.currentClass.id;
        this.legacyManageStudentFrame.innerHTML = '<iframe name="iframe_LegacyManageStudent" id="iframe_LegacyManageStudent" ' + 
              'src="/LClassManage.jsp?team=' + TEAM_ALIAS + '&classid=' + this.currentClassId + 'frameborder="0" width="100%" height="700"></iframe>';
    }
    
    
};

ManageStudentDialog.prototype.cancelButtonClickHandler = function () {
    this.close();
};

ManageStudentDialog.prototype.showErrorMessage = function (message, activeTab, inputToFocus) {
    var thiz = this;
    Dialog.error(message, "", function() {
        thiz.tabPane.setActiveTabPane(activeTab);
        if(inputToFocus) {
            window.setTimeout(function() {
                inputToFocus.focus();
            }, 200);
        }
    });
};

ManageStudentDialog.prototype.indexActionNextClickHandler = function () {
    if(this.classIdIndex == this.options.classes.length - 1) return;
    this.classIdIndex ++;
    this.renderManageStudentDialog();
    
};

ManageStudentDialog.prototype.indexActionPrevClickHandler = function () {
    if(this.classIdIndex == 0) return;
    this.classIdIndex --;
    this.renderManageStudentDialog();
};













if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/PrintAttendanceDialog.js";

function PrintAttendanceDialog() {
    Dialog.call(this);
    var thiz = this;
    this.slotsDetail = [];

    var populateSlotList = function(data, binding, node) {
        node._slotData = data;
        binding.slotNumber.innerHTML = '<icon class="chevron-right"></icon><icon class="chevron-down"></icon>' + "Slot #" + data.slotOrder;
        thiz.bind("click", thiz.removeSlotClickedHandler, binding.removeSlotAction);
        thiz.bind("click", thiz.slotNumberClickedHandler, binding.slotNumber);
    }

    this.classList.populator = function (data, binding, node) {
        node._classData = data;
        binding.classTitle.innerHTML = data.title;
        if(!data.slots) return;
        binding.slotList.populator = populateSlotList;
        binding.slotList.setItems(data.slots);
        thiz.bind("click", thiz.removeClassClickedHandler, binding.removeClassAction);
    };
    
    this.bind("p:PopupHidden", function() {
        if(!thiz.slotTimePopupOpener) return;
        Dom.removeClass(thiz.slotTimePopupOpener, "Expaned");
        thiz.slotTimePopupOpener = null;
    }, this.slotTimePopup.node());
    
    this.quickRanges.renderer = function (item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    
    this.bind("p:ItemSelected", this.quickRangesChangeHandler, this.quickRanges.node());
    this.bind("p:ItemSelected", this.printTypeChangeHandler, this.printTypeCombo.node());
    this.bind("p:ValueUpdated", this.printDateTimeChangeHandler, this.printFrom.node());
    this.bind("p:ValueUpdated", this.printDateTimeChangeHandler, this.printTo.node());
    
    this.COL_KEY_AGE = "age";
    this.COL_KEY_GENDER = "gender";
    this.COL_KEY_ACCOUNT = "account";
    this.COL_KEY_BALANCE30DAYS = "balance30sdays";
    this.COL_KEY_GROUPING = "grouping";
    this.COL_KEY_CLASSROOM = "classroom";
    
    this.attendanceColumnItems = [
        {id: this.COL_KEY_AGE, name: "Age"},
        {id: this.COL_KEY_GENDER, name: "Gender"},
        {id: this.COL_KEY_ACCOUNT, name: "Account"}
    ];
    
    if (ClassAuthUtils.canViewAccountBalanceOfAttendance()) {
        this.attendanceColumnItems.push({id: this.COL_KEY_BALANCE30DAYS, name: "Account balance"});
    }
    
    this.skillColumnItems = [
        {id: this.COL_KEY_AGE, name: "Age"},
        {id: this.COL_KEY_GENDER, name: "Gender"},
        {id: this.COL_KEY_ACCOUNT, name: "Account"}
    ];
    
    this.SLOTINSTANCE_STATUS_CANCEL = 2;
    
}

__extend(Dialog, PrintAttendanceDialog);

PrintAttendanceDialog.ATTENDANCE_SHEET = 1;
PrintAttendanceDialog.SIGNIN_SHEET = 2;
PrintAttendanceDialog.SKILLS_SHEET = 3;

PrintAttendanceDialog.prototype.setup = function(options) {
    var thiz = this;
    this.title = "Print/Export Attendance";
    this.options = options;
    if (this.options.enableGroupAttendanceNote) {
        this.attendanceColumnItems.push({id: this.COL_KEY_GROUPING, name: "Grouping"});
    }
    if (this.options.enableClassRooomAttendanceNote) {
        this.attendanceColumnItems.push({
            id: this.COL_KEY_CLASSROOM, 
            name: this.options.classRoomAttendanceNoteLabel
        });
    }
    
    this.setDatePickerMinDate();

    this.classList.setItems(options.classList);
    this.printTypeCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    
    var printTypeItems = [{
        id: PrintAttendanceDialog.ATTENDANCE_SHEET,
        name: "Attendance sheet"
    }, {
        id: PrintAttendanceDialog.SIGNIN_SHEET,
        name: "Signin sheet"
    }];
    
    if (ClassAuthUtils.canViewClassAttendance()) {
        printTypeItems.push({
            id: PrintAttendanceDialog.SKILLS_SHEET,
            name: "Skills sheet"
        });
    }
    this.printTypeCombo.setItems(printTypeItems);

    this.classListObject = {};
    if(options.classList && options.classList.length > 0) {
        for(var i = 0; i < options.classList.length; i ++) {
            this.classListObject[options.classList[i].id] = options.classList[i];
        }
    }    
    
    this.quickRanges.setItems([
        {id: "today", name: "Today"},
        {id: "next7days", name: "Next 7 days"},
        {id: "next30days", name: "Next 30 days"},
        {id: "thismonth", name: "This month"},
        {id: "lastmonth", name: "Last month"},
        {id: "fullclass", name: "Full Class"},
        {id: "custom", name: "Custom"}
    ]);
    if (options.timeRange && options.timeRange.name) {
        this.quickRanges.selectItemByKey("id", options.timeRange.name);
    } else {
        this.quickRanges.selectItemByKey("id", "next7days");
    }
    this.rerenderCustomizeColumnCombo(this.attendanceColumnItems);
};

PrintAttendanceDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Export to PDF", icon:"file-pdf",
            run: function () {
                thiz.downloadButtonClickedHandler(function(params, hasAgeCol, hasGenderCol, hasAccountCol, hasBalanceCol, hasGroupingCol, hasClassroomCol) {
                    thiz.exportToPDF(params, hasAgeCol, hasGenderCol, hasAccountCol, hasBalanceCol, hasGroupingCol, hasClassroomCol);
                });
            },
            isEnabled: function () {
                return thiz.getSelectedSlot().length > 0;
            }
        },
        {
            type: "accept", title: "Export to Excel", icon:"file-excel",
            run: function () {
                thiz.downloadButtonClickedHandler(function(params, hasAgeCol, hasGenderCol, hasAccountCol, hasBalanceCol, hasGroupingCol, hasClassroomCol) {
                    thiz.exportToExcel(params, hasAgeCol, hasGenderCol, hasAccountCol, hasBalanceCol, hasGroupingCol, hasClassroomCol);
                });
            },
            isEnabled: function () {
                return thiz.getSelectedSlot().length > 0;
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];

    return actions;
};

PrintAttendanceDialog.prototype.removeSlotClickedHandler = function(e) {
    var item = Dom.findParentWithClass(e.target, "SlotItem");
    var slotList = Dom.findParentWithClass(e.target, "AnonId_slotList");
    if(slotList && item) {
        slotList.removeChild(item);
        var deletedSlot = Dom.findUpwardForData(item, "_slotData");
        var deletedClass = Dom.findUpwardForData(slotList, "_classData");
        if(deletedSlot && deletedClass && this.classListObject[deletedClass.id]) {
            var slots = this.classListObject[deletedClass.id].slots;
            var deletedSlotIndex = -1;
            for(var i = 0; i < slots.length; i ++) {
                if(slots[i].id == deletedSlot.id) {
                    deletedSlotIndex = i;
                    break;
                }
            }
            if(deletedSlotIndex >= 0) {
                slots.splice(deletedSlotIndex, 1);
            }
        }
    }
    this.invalidateElements();
};

PrintAttendanceDialog.prototype.removeClassClickedHandler = function(e) {
    var item = Dom.findParentWithClass(e.target, "ClassItem");
    var classList = Dom.findParentWithClass(e.target, "AnonId_classList");
    if(classList && item) {
        classList.removeChild(item);
        var deletedClass = Dom.findUpwardForData(item, "_classData");
        if(deletedClass && this.options && this.options.classList && this.options.classList.length > 0) {
            var deletedIndex = -1;
            for(var i = 0; i < this.options.classList.length; i++) {
                if(this.options.classList[i].id == deletedClass.id) {
                    deletedIndex = i;
                    break;
                }
            }
            if(deletedIndex >= 0) {
                this.options.classList.splice(deletedIndex, 1);
            }
        }
    }
    this.invalidateElements();
};

PrintAttendanceDialog.prototype.slotNumberClickedHandler = function (e) {
    var slotData = Dom.findUpwardForData(e.target, "_slotData");
    var slotNumber = Dom.findParentWithClass(e.target, "SlotNumber");
    if (!slotData) return;
    this.slotTimePopupWrapper.innerHTML = "";
    for (var i = 0; i < slotData.slotTimes.length; i ++) {
        var slotTime = document.createElement("div");
        Dom.addClass(slotTime, "SlotTimeItem");
        var spanWeekday = document.createElement("span"),
            spanTime = document.createElement("span");
        spanWeekday.innerHTML = slotData.slotTimes[i].substring(0, 3);
        spanTime.innerHTML = slotData.slotTimes[i].substring(3, slotData.slotTimes[i].length);
        
        slotTime.appendChild(spanWeekday);
        slotTime.appendChild(spanTime);
        
        this.slotTimePopupWrapper.appendChild(slotTime);
    }
    this.slotTimePopup.show(slotNumber.parentNode.parentNode, "left-inside", "bottom", 0, 5, true);
    this.slotTimePopupOpener = slotNumber;
    Dom.addClass(slotNumber, "Expaned");
};

PrintAttendanceDialog.prototype.downloadButtonClickedHandler = function(exportFunction) {
    if(!this.options) return;
    if(!this.options.classList) return;
    var thiz = this;
    var quickRangesSelectedItem = this.quickRanges.getSelectedItem();
    
    if (quickRangesSelectedItem && quickRangesSelectedItem.id != "fullclass") {
        if(!this.printFrom.getDate()) {
            this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "From"), this.printFrom.input);
            return;
        }
        if(!this.printTo.getDate()) {
            this.showErrorMessage(String.format("[{0}] is a required field; please enter the correct value.", "To"), this.printTo.input);
            return;
        }
    }    
    
    var classes = this.getSelectedSlot();
    if (classes.length == 0) {
        this.showErrorMessage("Please choose at least on slot.", null);
        return;
    }
    if (this.options.classList.length == 1 &&  this.options.classList[0].deletedSlot) {
        classes[0].deletedSlot = this.options.classList[0].deletedSlot;
        classes[0].slots = null;
    }
    var params = {
        classes: classes,
        from: this.printFrom.getDate(),
        to: this.printTo.getDate(),
        type: this.printTypeCombo.getSelectedItem() ? this.printTypeCombo.getSelectedItem().id : 0,
        isFullClass: false,
        columns: []
    };
    
    if (quickRangesSelectedItem && quickRangesSelectedItem.id == "fullclass") params.isFullClass = true;    
    var customizeColumn = thiz.customizeColumnSelectBox.getSelectedData();
    if (customizeColumn && customizeColumn.length > 0) {
        for (var i = 0; i < customizeColumn.length; i++) {
            params.columns.push(customizeColumn[i].id);
        }
    }
    var hasAgeCol = (params.columns && (params.columns.length == 0 || (params.columns.length > 0 && params.columns.indexOf(this.COL_KEY_AGE) < 0)))? false: true; 
    var hasGenderCol = (params.columns && (params.columns.length == 0 || (params.columns.length > 0 && params.columns.indexOf(this.COL_KEY_GENDER) < 0)))? false: true;
    var hasAccountCol = (params.columns && (params.columns.length == 0 || (params.columns.length > 0 && params.columns.indexOf(this.COL_KEY_ACCOUNT) < 0)))? false: true;
    var hasBalanceCol = (params.columns && (params.columns.length == 0 || (params.columns.length > 0 && params.columns.indexOf(this.COL_KEY_BALANCE30DAYS) < 0)))? false: true;
    var hasGroupingCol = (params.columns && (params.columns.length == 0 || (params.columns.length > 0 && params.columns.indexOf(this.COL_KEY_GROUPING) < 0)))? false: true;
    var hasClassroomCol = (params.columns && (params.columns.length == 0 || (params.columns.length > 0 && params.columns.indexOf(this.COL_KEY_CLASSROOM) < 0)))? false: true;
    exportFunction(params, hasAgeCol, hasGenderCol, hasAccountCol, hasBalanceCol, hasGroupingCol, hasClassroomCol);
};

PrintAttendanceDialog.prototype.exportToPDF = function (params, hasAgeCol, hasGenderCol, 
        hasAccountCol, hasBalanceCol, hasGroupingCol, hasClassroomCol) {
    var thiz = this;
    var jobName = "";
    var template = ""
    if (params.type == PrintAttendanceDialog.ATTENDANCE_SHEET || params.type == PrintAttendanceDialog.SIGNIN_SHEET) {
        jobName = (params.type == PrintAttendanceDialog.ATTENDANCE_SHEET)? "Attendance tracking sheet" : "Signin sheet";
        template = PrintAttendanceDialog.ATT_TRACK_TEMPLATE;
    } else {
        jobName = "Skills sheet";
        template = PrintAttendanceDialog.ATT_TRACK_TEMPLATE;
    } 
    var generatedTime = FormatUtil.formatDate(new Date(), "datetime_standard", "local");
    window.defaultIndicator.busy("Generating data");
    if (params.type == PrintAttendanceDialog.SKILLS_SHEET) {
        $attndService.buildTrackingSkill(params, function(res) {
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
            for (var i = 0; i < res.ranges.length; i++) {
                res.ranges[i].slotInfo = thiz.slotsDetail[res.ranges[i].classId][res.ranges[i].slot];
            }
            var exportedData = {
                    ranges: res.ranges,
                    generatedTime: generatedTime,
                    showAgeCol: (hasAgeCol? [1] : []),
                    showGenderCol: (hasGenderCol? [1] : []), 
                    showAccountCol: (hasAccountCol? [1] : []),
                    show30daysBalance: (hasBalanceCol? [1] : [])
                };
            widget.__ensureNamespaceLoaded("print", function (print) {
                new print.PDFExportDialog().open({
                    template: PrintAttendanceDialog.SKILL_TRACK_TEMPLATE,
                    data: exportedData,
                    jobName: jobName
                });
            });

        }, function(err) {
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
        });
    } else {
        $attndService.buildTrackingAttendance(params, function(res) {
            var rescheduleSlotInstances = res.rescheduleSlotInstances;
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
            for (var i = 0; i < res.ranges.length; i++) {
                res.ranges[i].slotInfo = thiz.slotsDetail[res.ranges[i].classId][res.ranges[i].slot];
                
                var slotInstances = res.ranges[i].slotInstances;
                for (var j = 0; j < slotInstances.length; j ++) {
                    var displaySlotTime = slotInstances[j].slotDate + "\n" + slotInstances[j].slotHour;
                    if (slotInstances[j].slotInstanceStatus != thiz.SLOTINSTANCE_STATUS_CANCEL 
                        && rescheduleSlotInstances && rescheduleSlotInstances[slotInstances[j].slotInstanceId]) {
                        slotInstances[j].rescheduleSlotInstance = true;
                    }
                    slotInstances[j].displaySlotTime = displaySlotTime;
                }
            }
            var exportedData = {
                    ranges: res.ranges,
                    show30daysBalance: (params.type == PrintAttendanceDialog.ATTENDANCE_SHEET && hasBalanceCol? [1] : []),
                    generatedTime: generatedTime,
                    showAgeCol: (hasAgeCol? [1] : []),
                    showGenderCol: (hasGenderCol? [1] : []), 
                    showAccountCol: (hasAccountCol? [1] : []),
                    showGrouping: (hasGroupingCol? [1] : []),
                    showClassroom: (hasClassroomCol? [1] : []),
                    classRoomAttendanceNoteLabel: thiz.options.classRoomAttendanceNoteLabel
                };
            widget.__ensureNamespaceLoaded("print", function (print) {
                new print.PDFExportDialog().open({
                    template: PrintAttendanceDialog.ATT_TRACK_TEMPLATE,
                    data: exportedData,
                    jobName: jobName
                });
            });

        }, function(err) {
            if(window.defaultIndicator) { window.defaultIndicator.done(); }
        });
    }
};

PrintAttendanceDialog.prototype.exportToExcel = function (params, hasAgeCol, hasGenderCol, hasAccountCol, hasBalanceCol) {
    var infoMap = {};
    for (var iC = 0; iC < params.classes.length; iC++) {
        var classes = params.classes[iC];
        var slotMap = {};
        for (var iS = 0; iS < classes.slots.length; iS++) {
            var slot = classes.slots[iS];
            slotMap[slot] = this.slotsDetail[classes.classId][slot];
        }
        infoMap[classes.classId] = slotMap;
    }
    params.infoMap = infoMap;
    $attndService.exportToExcel(params, function(fileUrl) {
        new WaitingExportDialog().open(fileUrl);
    }, function(err) {
        Dialog.error(err);
    });
};

PrintAttendanceDialog.prototype.getSelectedSlot = function () {
    var classes = [];
    var thiz = this;
    var slotsDetail = this.slotsDetail;
    for(var i = 0; i < this.options.classList.length; i ++) {
        var lessonClass = this.options.classList[i];
        if(lessonClass.slots && lessonClass.slots.length > 0) {
            var classInfo = {
                classId: lessonClass.id,
                slots: []
            };
            var detail = lessonClass.detail;
            for(var j = 0; j < lessonClass.slots.length; j ++) {
                var slot = lessonClass.slots[j];
                classInfo.slots.push(slot.slot);
                var slotInfo = {
                        title: detail.title,
                        progName: detail.progName,
                        subProgName: detail.subProgName,
                        duration: detail.duration,
                        slotOrder: slot.slotOrder,
                        instructorNames: (slot.instructorNames && slot.instructorNames.length? slot.instructorNames.join(', ') : "(Not assigned)"),
                        slotTimes: slot.slotTimes,
                        mapFullAddress: detail.mapFullAddress
                }
                if (!slotsDetail[lessonClass.id]) {
                    slotsDetail[lessonClass.id] = [];
                } 
                slotsDetail[lessonClass.id][slot.slot] = slotInfo;
            }
            classes.push(classInfo);
        }
    }
    return classes;
};

PrintAttendanceDialog.prototype.showErrorMessage = function (message, inputToFocus) {
    var thiz = this;
    Dialog.error(message, "", function() {
        if(inputToFocus) {
            window.setTimeout(function() {
                inputToFocus.focus();
            }, 200);
        }
    });
};

PrintAttendanceDialog.prototype.setDatePickerMinDate = function () { 
    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.printFrom.setMinDate(minDate);
    this.printTo.setMinDate(minDate);
};

PrintAttendanceDialog.prototype.rerenderCustomizeColumnCombo = function (filterItems) {
    if (!filterItems) return;
    this.customizeColumnContainer.innerHTML = "";
    var thiz = this;
    this.customizeColumnSelectBox = new SelectBox();
    this.customizeColumnSelectBox.getConfigs = function() {
        return {
            name: "selectBox",
            mode: SelectBox.MODE_DROPDOWN,
            direction: SelectBox.DIRECTION_COLUMN,
            multipleSelect: true,
            optionSelectAll: true,
            optionSelectAllText: "All Columns"
        }
    };
    
    this.customizeColumnSelectBox.getData = function(items) {
        return filterItems;
    };
    this.customizeColumnSelectBox.parseData = function(object) {
        return {
            value: object.id,
            text: object.name,
            checked: true
        };
    }
    this.customizeColumnSelectBox.getSelectedOptionText = function() {
        var labelText = "Column (0)";
        var selectedItems = thiz.customizeColumnSelectBox.getSelectedData();
        if(selectedItems && selectedItems.length > 0) {
            labelText = selectedItems[0].name;
            if(selectedItems.length > 1) {
                labelText += " (+" + (selectedItems.length - 1) + ")";
            }
        }
        return [labelText];
    };
    this.customizeColumnSelectBox.into(this.customizeColumnContainer);
    this.customizeColumnSelectBox._options =  {
        onSelectionChanged: function(fromUserAction) {
            if (!fromUserAction) return;
        },
    };
    this.customizeColumnSelectBox.setup();
};



PrintAttendanceDialog.prototype.quickRangesChangeHandler = function () {
    if (this.changingQuickRanges) {
        this.changingQuickRanges = false;
        return;
    }
    this.printFrom.setEnabled(true);
    this.printTo.setEnabled(true);
    var selectedItem = this.quickRanges.getSelectedItem();
    if (!selectedItem) return;
    switch (selectedItem.id) {
        case "today":
            var form = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).hour(0).minute(0).second(0).millisecond(0);
            this.printFrom.setDate(form.toDate());
            this.printTo.setDate(form.toDate());
            break;
        case "next7days":
            var form = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).hour(0).minute(0).second(0).millisecond(0);
            this.printFrom.setDate(form.toDate());
            form.add(6, 'd');
            this.printTo.setDate(form.toDate());
            break;
        case "next30days":
            var form = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).hour(0).minute(0).second(0).millisecond(0);
            this.printFrom.setDate(form.toDate());
            form.add(30, 'd');
            this.printTo.setDate(form.toDate());
            break;
        case "thismonth":
            var form = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).date(1).hour(0).minute(0).second(0).millisecond(0);
            this.printFrom.setDate(form.toDate());
            form.add(1, 'M');
            form.add(-1, 'd');
            this.printTo.setDate(form.toDate());
            break;
        case "lastmonth":        
            var form = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).date(1).hour(0).minute(0).second(0).millisecond(0);
            form.add(-1, 'd');
            this.printTo.setDate(form.toDate());
            form.date(1);
            this.printFrom.setDate(form.toDate());            
            break;
        case "fullclass":
            this.printFrom.setEnabled(false);
            this.printTo.setEnabled(false);
            break;
        case "custom":
            if (this.options.timeRange && this.options.timeRange.from) {
                this.printFrom.setDate(this.options.timeRange.from);
            }
            if (this.options.timeRange && this.options.timeRange.to) {
                this.printTo.setDate(this.options.timeRange.to);
            }
            break;            
        default:
            break;
    }
};


PrintAttendanceDialog.prototype.printTypeChangeHandler = function () {
    var selectedType = this.printTypeCombo.getSelectedItem();
    if (!selectedType) return;
    if (selectedType.id == PrintAttendanceDialog.ATTENDANCE_SHEET) {
        this.rerenderCustomizeColumnCombo(this.attendanceColumnItems);
    } else {
        this.rerenderCustomizeColumnCombo(this.skillColumnItems);
    }
};

PrintAttendanceDialog.prototype.printDateTimeChangeHandler = function () {
    this.changingQuickRanges = true;
    this.quickRanges.selectItemByKey("id", "custom");
};



PrintAttendanceDialog.ATT_TRACK_TEMPLATE = {
    pageSize: 'A4',
    pageOrientation: 'landscape',
    pageMargins: [ 20, 20, 20, 20 ],
    "footer": {
        text: "Generated at ${generatedTime}",
        alignment: "left",
        style: "footer"
    },
    "content": [
        {
            $repeatOn: "ranges",
            stack: [
                {
                    text: "${slotInfo.title} | Reg Slot #${slotInfo.slotOrder}",
                    style: "header"
                },
                {
                    style: "noBorderTable",

                    "table": {
                        "headerRows": 0,
                        "widths": ['*'],
                        "body": [[{
                            style: "noBorderTable",
                            "table": {
                                "headerRows": 0,
                                "widths": [70, 200, 80, 220, 60, '*'],
                                "body": [
                                    [
                                        {
                                            text: "Program:",
                                            style: "classMetaHeader"
                                        }, {
                                            text: "${slotInfo.progName}",
                                            style: "classMetaInfo"
                                        }, {
                                            text: "Subprogram:",
                                            style: "classMetaHeader"
                                        }, {
                                            text: "${slotInfo.subProgName}",
                                            style: "classMetaInfo"
                                        }, {
                                            text: "Duration:",
                                            style: "classMetaHeader"
                                        }, {
                                            text: "${slotInfo.duration}m",
                                            style: "classMetaInfo"
                                        }
                                    ],
                                    [
                                        {
                                            text: "Instructors:",
                                            style: "classMetaHeader",
                                        }, {
                                            text: "${slotInfo.instructorNames}",
                                            style: "classMetaInfo"
                                        },
                                        {
                                            text: "Address:",
                                            style: "classMetaHeader",    
                                        },{
                                            text: "${slotInfo.mapFullAddress}",
                                            style: "classMetaInfo",
                                            colSpan: 3
                                        },{},{}
                                    ],
                                    [
                                        {
                                            text: "Reg Slot:",
                                            style: "classMetaHeader",
                                        },{
                                            colSpan: 5,
                                            style: "noBorderTable",
                                            "table": {
                                                "headerRows": 0,
                                                "widths": [{
                                                    $repeatOn: "slotInfo.slotTimes",
                                                    $itemTemplate: 80
                                                }],
                                                "body": [[{
                                                    $repeatOn: "slotInfo.slotTimes",
                                                    $itemTemplate: {
                                                        text: "${$this}",
                                                        style: "slotTime"
                                                    }
                                                }]],
                                            },
                                            layout: {
                                                hLineWidth: "0",
                                                vLineWidth: "3",
                                                hLineColor: "'white'",
                                                vLineColor: "'white'",
                                            }
                                            
                                        },
                                        {},{},{},{}
                                    ]
                                ]
                            },
                            layout: {
                                hLineWidth: "0",
                                vLineWidth: "0",
                            }
                        }]]
                    },
                    layout: {
                        hLineWidth: "1",
                        vLineWidth: "1",
                        hLineColor: "'gray'",
                        vLineColor: "'gray'",
                        vLineStyle: "null",
                    }
                },
                {
                    style: "tableAttendance",
                    pageBreak: "${ $parent.ranges.length - 1 == $index ? '' : 'after' }",
                    "table": {
                        "headerRows": 1,
                        dontBreakRows: true,
                        "widths": ['*',
                                {
                                    $repeatOn: '$parent.showAgeCol',
                                    $itemTemplate: 30
                                },{
                                    $repeatOn: '$parent.showGenderCol',
                                    $itemTemplate: 42
                                }, {
                                    $repeatOn: '$parent.showAccountCol',
                                    $itemTemplate: "*"
                                }, {
                                    $repeatOn: '$parent.show30daysBalance',
                                    $itemTemplate: "*"
                                }, {
                                    $repeatOn: '$parent.showGrouping',
                                    $itemTemplate: 60
                                }, {
                                    $repeatOn: '$parent.showClassroom',
                                    $itemTemplate: 70
                                },{
                                    $repeatOn: 'slotInstances', 
                                    $itemTemplate: 72
                                },{
                                     $repeatOn: 'extraColumns', 
                                     $itemTemplate: "${$this}" * 55
                                }],
                        "body": [
                            [
                                {
                                    text: "Student",
                                    style: "tableHeader"
                                },{
                                    $when: "$parent.showAgeCol.length == 1",
                                    text: "Age",
                                    style: "tableHeader"
                                },{
                                    $when: "$parent.showGenderCol.length == 1",
                                    text: "Gender",
                                    style: "tableHeader"
                                },{
                                    $when: "$parent.showAccountCol.length == 1",
                                    text: "Account",
                                    style: "tableHeader"
                                },{
                                    $when: "$parent.show30daysBalance.length == 1",
                                    text: "Account balance",
                                    alignment: "right",
                                    style: "tableHeader"
                                },{
                                    $when: "$parent.showGrouping.length == 1",
                                    text: "Grouping",
                                    alignment: "center",
                                    style: "tableHeader"
                                },{
                                    $when: "$parent.showClassroom.length == 1",
                                    text: "${$parent.classRoomAttendanceNoteLabel}",
                                    alignment: "center",
                                    style: "tableHeader"
                                },{
                                    $repeatOn: "slotInstances",
                                    text: ["${displaySlotTime}", 
                                        {$when: "slotInstanceStatus == 2", text: " (Cancelled)", italics: true},
                                        {$when: "rescheduleSlotInstance", text: " (Rescheduled)", italics: true}
                                    ],
                                    alignment: "center",
                                    style: "tableHeader"
                                },{
                                    $repeatOn: 'extraColumns', 
                                    text: "",
                                }
                            ],
                            {
                                $repeatOn: "members",
                                $itemTemplate: [
                                    {
                                        text: "${firstName} ${lastName}",
                                        style: "cell-name"
                                    }, {
                                        $when: "$parent.$parent.showAgeCol.length == 1",
                                        text: "${age}",
                                        style: "cell"
                                    }, {
                                        $when: "$parent.$parent.showGenderCol.length == 1",
                                        text: "${gender}",
                                        style: "cell"
                                    }, {
                                        $when: "$parent.$parent.showAccountCol.length == 1",
                                        text: "${accountName}",
                                        style: "cell"
                                    }, {
                                        $when: "$parent.$parent.show30daysBalance.length == 1",
                                        text: "${balance30daysText}",
                                        alignment: "right",
                                        style: "cell"
                                    }, {
                                        $when: "$parent.$parent.showGrouping.length == 1",
                                        text: "${groupingText}",
                                        alignment: "center",
                                        style: "cell"
                                    }, {
                                        $when: "$parent.$parent.showClassroom.length == 1",
                                        text: "${classroomText}",
                                        alignment: "center",
                                        style: "cell"
                                    }, {
                                        $repeatOn: "$parent.slotInstances",
                                        stack: [
                                            {
                                                style: "noBorderTable",
                                                "table": {
                                                    "headerRows": 0,
                                                    dontBreakRows: true,
                                                    "widths": [12, '*'],
                                                    "body": [
                                                        [
                                                            {
                                                                $when: "showDob",
                                                                text: "${($parent.shortClosetDob == slotDate)? $parent.namedShortDob : ''}",
                                                                style: 'closetDateCell'
                                                            }, {
                                                                $when: "slotInstanceStatus != 2 && showTrackedAttnd && (presentMemberIds.indexOf($parent.id) >= 0 || absentMemberIds.indexOf($parent.id) >= 0)",
                                                                image: "${(presentMemberIds.indexOf($parent.id) >= 0)?'present': ((absentMemberIds.indexOf($parent.id) >= 0)?'absent':'')}",
                                                                width: 24,
                                                                height: 24,
                                                                style: 'noMarginCell'
                                                            }, {        
                                                                $when: "slotInstanceStatus != 2 && showTrackedAttnd && (tardyMemberIds.indexOf($parent.id) >= 0)",                                                        
                                                                text: "T",
                                                                style: "status-name"
                                                            }, {        
                                                                $when: "slotInstanceStatus != 2 && showTrackedAttnd && (leftEarlyMemberIds.indexOf($parent.id) >= 0)",                                                        
                                                                text: "L",
                                                                style: "status-name"
                                                            }, {        
                                                                $when: "slotInstanceStatus != 2 && showTrackedAttnd && (tardyLeftEarlyMemberIds.indexOf($parent.id) >= 0)",                                                        
                                                                text: "TL",
                                                                style: "status-name"
                                                            }, {        
                                                                $when: "slotInstanceStatus != 2 && showTrackedAttnd && (excusedAbsenceMemberIds.indexOf($parent.id) >= 0)",                                                        
                                                                text: "E",
                                                                style: "status-name"
                                                            }, {        
                                                                $when: "slotInstanceStatus == 2",                                                        
                                                                text: "",
                                                                style: "status-name"
                                                            }
                                                        ]
                                                     ]
                                                },
                                                layout: {
                                                    hLineWidth: "0",
                                                    vLineWidth: "0",
                                                }
                                            }
                                        ],
                                        style: "noMarginCell"
                                    },
                                    {
                                        $repeatOn: '$parent.extraColumns', 
                                        text: "",
                                    }
                                ]
                            }
                        ]
                    },
                    layout: {
                        hLineWidth: "1",
                        vLineWidth: "1",
                        hLineColor: "'gray'",
                        vLineColor: "'gray'",
                        vLineStyle: "null",
                    }
                }
                
            ]
        }
    ],
    "styles": {
        "header": {
            "fontSize": 16,
            "bold": true,
            "margin": [
                0,
                0,
                0,
                10
            ]
        },
        "noBorderTable": {
            "margin": [0, 0, 0, 0]
        },
       
        "classMetaHeader": {
            "fontSize": 12,
            "bold": true,
            "margin": [2, 2, 2, 2]
        },
        "classMetaInfo": {
            "fontSize": 12,
            "margin": [2, 2, 2, 2]
        },
        "slotTime": {
            "bold": true,
            "fontSize": 10,
            "margin": [2, 2, 2, 2],
            "fillColor": "#949494",
            "color": "white",
            "alignment": 'center'
        },
        "tableAttendance": {
            "fontSize": 10,
            "margin": [
                0,
                5,
                0,
                15
            ]
        },
        "tableHeader": {
            "bold": true,
            "fontSize": 10,
            "margin": [4, 4, 4, 4 ]
        },
        "cell": {
            "bold": false,
            "margin": [4, 4, 4, 4 ]
        },
        "noMarginCell": {
            "bold": false,
            "margin": [0, 0, 0, 0]
        },
        "closetDateCell": {
            "bold": false,
            "fontSize": 7,
            "margin": [0, 0, 0, 0],
            "alignment": "right"
        },
        "dobCell": {
            "bold": false,
            "fontSize": 7,
            "margin": [0, 0, 0, 0]
        },
        "cell-name": {
            bold: true,
            "margin": [4, 4, 4, 4 ]
        },
        "footer": {
            "fontSize": 8,
            "italics": true,
            "margin": [20, 0, 20, 0]
        },
        "status-name": {
            bold: true,
            "fontSize": 12,
            "margin": [4, 4, 4, 4]
        }
    },
    "defaultStyle": {},
    images: {
        cake: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABOCAYAAACQYxCuAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAA0WAAANFgBB5SHbwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAQzSURBVHic7dvJa11lGMfxT66W1hqUFo0jVWwxiiNaRTdCF8ahKVW04lC1iiI4geJCcQD/gOJSKw5VF6LgThTUhUhVXIi6UVFREBVTa9M2kcTmJnHxnkuSmzudc889b7y5X3ggJO/J83t+Z3qnQ1w249rIGqKxAt/jR6yMrCUKj2I2iUciaymc4zFqzoCDODGqooLZZa74SrwQVVGBXIiyxQZM4+KIugrjY4uLr8Qe9EVTVgDb1C++EjdGU9dhVuEXzQ34FasjaewoT2tefCWeiqSxY5yAMa0bMJYc03FKRSTBQ+hP0b4fD3RISxRaufer4+coSjvASuEdn9aAaQWMEYq4Bfoz5inh6Jy1RKEP49JfAWMK6BQVcQXM4qMMx32YHNsVXCH9FbApitIOUmsEWC+ej6Sxo6zAbs2LfzVp27Vcjy8wY67omeR31xUtJubQcwAbkp9/wt6IWnosW2LcAqeqP9IbwW8FaonCTvXfADuLFlPUcHjJ0jMgtoDY9AyILSA2R6Zoe6x8DFvV5G9rcsgxI6w3tsXleE5Ywp6UfjgbOybxXVLDZWkKPwvvLYEC8o53Mdis+KtxYAmI7VQcwtZ6xV+l9qptt0VZ2JqzgA26+8xXxyjOmG/AO0tAVNHxNmE0eB6+0eXr8jWYxfklYc1+uRVPqPmGEq6MrSQiQyWsi60iIuv6MCVdl7ibKPcJD4Nly7IfDeZpwCxeF3panaKMN+R81ebRqZjBw8n/2yY8V/LuuJRxW5LjPgtXltqJXIp/sMrUm3I2oYztVTnulW3nySIDDrVZ/P1qk5cJtYqvcE+bJhyErzIePI0ddYRVuF17I8wybmmSox0TvoRnMwqrd1aquSOjwFaKr3B3xhzPwHHSDYWnUgirsCOlwDTFV7hTuqvtb6ytHLy1RYGHhad8PRq9Vu9qMUcZt2bMsV1rJpRxTfXBw4IrjRxrNHA6G9/ikgZthrGvQY6RJjkGW8ix2cKvUapjrzD7VZM1eFzYt/9HEnvwhMbT1efizyTBflzUoO0xwvdCH+AHYdb5faEf0Wg77WCiZzYpcGODtmvxJD6dV8cneCzJnysXCK7Od3lUvl9/nInfq3IcwKU55sjERvUv6b+Ez2Pa5RxzZ7469mt8O3SUm/FPHWGVmBBeg1kZ1vwNNSG8ATKzS9iw1Cqn4bUmoubHjLA9bn2KHKfjFen6+7ulm9wZwIuSg8fxkrA786gajVdjC16WfZlsCm8JZ+vkGjlOEnqObwqv2yw5JhONWxrUsSlpM47ZWhMih4W9+vtwBE4R9vTkvXX9X3MPzwGNF02z/v8R4eE5LXT41qvahNmbEYotIDY9A2ILiE3PgNgCYtMzILaA2PQMiC0gNj0DYguITc8AYQi5XJksCRuklitfw5D8Vlr/TzFj3hT8ED4X5tdiC+t0TOCzSvH/AdHPcKu27XIJAAAAAElFTkSuQmCC",
        //absent: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAAMBJREFUSMftlUEKwjAQRR9iDyCk4Cmy8RIWzyyIazfdeIC296gLpxDiJDUJURA/zCKTzP+ZmTCBPxJxAiZgzrQR6GICYwH5YkNMYDmUi5f4Te2arwlY4Arslb0WuACHkhTPsu4B4/iN+GY5EyzRmsAOuInvLpm0DrkvnCzg37aPkGcL+JmEyNX4d1/RFmicdSO+ZHy8RFpDtcZnC1R/plYItIYa2bMlAqn4/iyavJukGjxHfhAdZX/CABxrV+XH8ABiSJJGUXzEuAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMi0xMFQyMToxMjozNiswMDowMEGTrzcAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTItMTBUMjE6MTI6MzYrMDA6MDAwzheLAAAAKHRFWHRzdmc6YmFzZS11cmkAZmlsZTovLy90bXAvbWFnaWNrLVo4a083eDNL7NQ3bQAAAABJRU5ErkJggg==",
        absent: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAAIFJREFUSMftlDEKgDAMRR/eoeARHOr9p+Id7OBxdElBhJbGNiDqnzok/yc/aeDHZzEBCzBWxDogALNGIAA7EIWgRB4lNmgEHLBK4pbppCbmtkgzeYmoG/lZJPkcL2/XwJvtRFX50KuCx1pkOmTTNTX/aOanwktCzRDTsfNam368BAcgcD9FIbPxPAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMi0xMFQyMjowODoxMyswMDowMDropCoAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTItMTBUMjI6MDg6MTMrMDA6MDBLtRyWAAAAKHRFWHRzdmc6YmFzZS11cmkAZmlsZTovLy90bXAvbWFnaWNrLW9CbkxWaWR4qtj91gAAAABJRU5ErkJggg==",
        //present: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAALpJREFUSMftlUEKwjAQRR/SjYfxHhbXBRfew6Xp0ot4sLa3qFAXJlCqmWQy1oX4YSCB+fP//EUCfyhxAAZgKqweqCWB3jA8VCcJhKZSvPA3a2f+CYGdacUEGmAEXIxv2aABbkClMZW7QXA+ARcNf9nwLt/jbLhL8EWBFrgDpwznRQJnfw4iqeFFETl/H4VYTALzTSTnUX5FGldg689tRr/OgZX/9bdoWDjRFjyf/ChqbH9CB+zXTuXH8ACF6IL0W4Vw2QAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMi0xMFQyMToxMTowMyswMDowMHYTPHAAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTItMTBUMjE6MTE6MDMrMDA6MDAHToTMAAAAKHRFWHRzdmc6YmFzZS11cmkAZmlsZTovLy90bXAvbWFnaWNrLXkzWmFxc2diBrKrcwAAAABJRU5ErkJggg==",
        present: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAAIJJREFUSMftkLsNgCAURY+fbVzCIfwUuoeVUTs3cQ4LZ7LARBtIaJQo0BhO+V4473IhEHhJ5lNeAAKY9WHsUL4AKbD7Sn4CQ5A7kfdA9bCvNfn4Vp7Lh+LmiJVc0UnBATTavLSp5elI61quGLW6rGsx/eRz8sSw34AIWIHJdfrAT7gA/vctXmUgC/kAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMTItMTBUMjI6MDU6MDYrMDA6MDBRhACjAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTEyLTEwVDIyOjA1OjA2KzAwOjAwINm4HwAAACh0RVh0c3ZnOmJhc2UtdXJpAGZpbGU6Ly8vdG1wL21hZ2ljay1iRXg3elppS2lAssUAAAAASUVORK5CYII=",
        emptybox: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAAFpJREFUSMdjYBgFJAJvBgaGJwwMDP/JxI8ZGBg88VnwmALDYfgRPgtgisgFGPqZaB3moxaMWjBqwagFg9GCJ1Ca3KKagQFS5OMEngyU1QmPGBgYPGgdKsMMAAD120YcpP3UxAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMi0xMFQyMToxMToxMCswMDowMItRJnMAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTItMTBUMjE6MTE6MTArMDA6MDD6DJ7PAAAAKHRFWHRzdmc6YmFzZS11cmkAZmlsZTovLy90bXAvbWFnaWNrLVZ6dXNSMXVGnsNVXgAAAABJRU5ErkJggg==",
        empty: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAC3XpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHja7ZdRkuMoDIbfOcUeAUkIieNgMFVzgz3+/mDa6aR7pmpn52EfYhLAsvgBfTLdCeffP0b4CxcViSGpeS45R1yppMIVHY/XdbUU06qvm49n9GwP9wOGSdDKdZvP7V9h18cAS9t+PNuDta3jW4hu4XXJnHn2t59vIeHLTvs+lD2upk/b2V9uW3aLv94nQzC6Qk848CkkEbXPWQQrEJeKmldNcIqS0NdlZ0nfxy7c3Zfg3b2X2MW67fIcihDzdsgvMdp20he73NPwM7XHzE8PTO4pvsRujO5jnNfuasqIVA57Ux9bWT04HgilrGEZxfBV9G2VguLYYgOxDpoHSgtUiBHtQYk6VRp0rrZRwxITn2xomRvLsrkYF24LSpqFBpsU6QEsWBqoCcx8r4XWvGXN15C0PXaCJxPEJtEvJXxn/J1yC40xU5co+h0rrItnTmMZk9ys4QUgNHZMdcV3lfApb+InsAKCusLs2GCNxyVxKD1ySxZngZ/GFOL1apD1LYAQYW7FYpDXiWImUcoUjdmIEEcHn4qVI8n5AAFS5U5hgI1IBhznOTfGGC1fVr7MOFoAQiWLAU2RClgpKfLHkiOHqoqmoKpZTV2L1iw5Zc05W55nVDWxZGrZzNyKVRdPrp7d3L14LVwER5iWXCwUL6XUikkrpCtGV3jUevAhRzr0yIcdfpSjNqRPS01bbta8lVY7d+l4/XvuFrr30utJJ1LpTKee+bTTz3LWgVwbMtLQkYcNH2XUm9qm+kyNXsj9mhptapNYWn72oAaz2YcEzeNEJzMQ40QgbpMAEpons+iUEk9yk1ksjJdCGdRIJ5xOkxgIppNYB93sHuR+yS1o+lfc+GfkwkT3J8iFiW6T+8rtG2q9rr8osgDNt3DGNMrAwQanyo4PzuPfb8N/FXgLvYXeQm+ht9Bb6C30vxGSgX8e8FMz/AP4SJD9qVa/+gAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB+IMChU6GBE9OvgAAAAmSURBVEjH7c0xAQAACMOwgX/PxQT7GgMZgBRtygwMDAwMDAwMfhwXLQQsCEtCkwAAAABJRU5ErkJggg=="
            
    }
};


PrintAttendanceDialog.SKILL_TRACK_TEMPLATE = {
    pageSize: 'A4',
    pageOrientation: 'landscape',
    pageMargins: [ 20, 20, 20, 20 ],
    "footer": {
        text: "Generated at ${generatedTime}",
        alignment: "left",
        style: "footer"
    },
    "content": [
        {
            $repeatOn: "ranges",
            stack: [
                {
                    text: "${slotInfo.title} | Reg Slot #${slotInfo.slotOrder}",
                    style: "header"
                },
                {
                    style: "noBorderTable",
                    "table": {
                        "headerRows": 0,
                        "widths": ['*'],
                        "body": [[{
                            style: "noBorderTable",
                            "table": {
                                "headerRows": 0,
                                "widths": [70, 200, 80, 220, 60, '*'],
                                "body": [
                                    [
                                        {
                                            text: "Program:",
                                            style: "classMetaHeader"
                                        },
                                        {
                                            text: "${slotInfo.progName}",
                                            style: "classMetaInfo"
                                        },
                                        {
                                            text: "Subprogram:",
                                            style: "classMetaHeader"
                                        },
                                        {
                                            text: "${slotInfo.subProgName}",
                                            style: "classMetaInfo"
                                        },
                                        {
                                            text: "Duration:",
                                            style: "classMetaHeader"
                                        },
                                        {
                                            text: "${slotInfo.duration}m",
                                            style: "classMetaInfo"
                                        }
                                    ],
                                    [
                                        {
                                            text: "Instructors:",
                                            style: "classMetaHeader",
                                        },
                                        {
                                            text: "${slotInfo.instructorNames}",
                                            style: "classMetaInfo"
                                        },
                                        {
                                            text: "Address:",
                                            style: "classMetaHeader",    
                                        },{
                                            text: "${slotInfo.mapFullAddress}",
                                            style: "classMetaInfo",
                                            colSpan: 3
                                        },{},{}
                                    ],
                                    [
                                        {
                                            text: "Reg Slot:",
                                            style: "classMetaHeader",
                                        },
                                        {
                                            colSpan: 5,
                                            style: "noBorderTable",
                                            "table": {
                                                "headerRows": 0,
                                                "widths": [{
                                                    $repeatOn: "slotInfo.slotTimes",
                                                    $itemTemplate: 80
                                                }],
                                                "body": [[{
                                                    $repeatOn: "slotInfo.slotTimes",
                                                    $itemTemplate: {
                                                        text: "${$this}",
                                                        style: "slotTime"
                                                    }
                                                }]],
                                            },
                                            layout: {
                                                hLineWidth: "0",
                                                vLineWidth: "3",
                                                hLineColor: "'white'",
                                                vLineColor: "'white'",
                                            }
                                            
                                        },
                                        {},{},{},{}
                                    ]
                                ]
                            },
                            layout: {
                                hLineWidth: "0",
                                vLineWidth: "0",
                            }
                        }]]
                    },
                    layout: {
                        hLineWidth: "1",
                        vLineWidth: "1",
                        hLineColor: "'gray'",
                        vLineColor: "'gray'",
                        vLineStyle: "null",
                    }
                },
                {
                    style: "tableAttendance",
                    pageBreak: "${ $parent.ranges.length - 1 == $index ? '' : 'after' }",
                    "table": {
                        "headerRows": 1,
                        dontBreakRows: true,
                        "widths": ['*',
                                {
                                    $repeatOn: '$parent.showAgeCol',
                                    $itemTemplate: 30
                                },{
                                    $repeatOn: '$parent.showGenderCol',
                                    $itemTemplate: 42
                                },{
                                    $repeatOn: '$parent.showAccountCol',
                                    $itemTemplate: "*"
                                },
                                {
                                    $repeatOn: "skillItems",
                                    $itemTemplate: 75
                                },
                                {
                                    $repeatOn: 'extraColumns', 
                                    $itemTemplate: "${$this}" * 75
                                }
                            ],
                        "body": [
                            [
                                {
                                    text: "Student",
                                    style: "tableHeader"
                                },
                                {
                                    $when: "$parent.showAgeCol.length == 1",
                                    text: "Age",
                                    style: "tableHeader"
                                },
                                {
                                    $when: "$parent.showGenderCol.length == 1",
                                    text: "Gender",
                                    style: "tableHeader"
                                },
                                {
                                    $when: "$parent.showAccountCol.length == 1",
                                    text: "Account",
                                    style: "tableHeader"
                                },
                                {
                                    $repeatOn: "skillItems",
                                    text: "${skillName}",
                                    alignment: "center",
                                    style: "tableHeader"
                                },
                                {
                                    $repeatOn: 'extraColumns', 
                                    text: ""
                                }
                            ],
                            {
                                $repeatOn: "members",
                                $itemTemplate: [
                                    {
                                        text: "${firstName} ${lastName}",
                                        style: "cell-name"
                                    },
                                    {
                                        $when: "$parent.$parent.showAgeCol.length == 1",
                                        text: "${age}",
                                        style: "cell"
                                    }, {
                                        $when: "$parent.$parent.showGenderCol.length == 1",
                                        text: "${gender}",
                                        style: "cell"
                                    }, {
                                        $when: "$parent.$parent.showAccountCol.length == 1",
                                        text: "${accountName}",
                                        style: "cell"
                                    }, {
                                        $repeatOn: "$parent.skillItems",
                                        stack: [
                                            {
                                                image: "${(passedMemberIds.indexOf($parent.id) > -1)?'passed': 'empty'}",
                                                width: 24,
                                                height: 24,
                                                style: 'skillName',
                                            }
                                        ],
                                        style: "noMarginCell"
                                    }, 
                                    {
                                        $repeatOn: '$parent.extraColumns', 
                                        text: ""
                                    }
                                ]
                            }
                        ]
                    },
                    layout: {
                        hLineWidth: "1",
                        vLineWidth: "1",
                        hLineColor: "'gray'",
                        vLineColor: "'gray'",
                        vLineStyle: "null",
                    }
                }
                
            ],
        }
    ],
    "styles": {
        "header": {
            "fontSize": 16,
            "bold": true,
            "margin": [
                0,
                0,
                0,
                10
            ]
        },
        "noBorderTable": {
            "margin": [0, 0, 0, 0]
        },
       
        "classMetaHeader": {
            "fontSize": 12,
            "bold": true,
            "margin": [2, 2, 2, 2]
        },
        "classMetaInfo": {
            "fontSize": 12,
            "margin": [2, 2, 2, 2]
        },
        "slotTime": {
            "bold": true,
            "fontSize": 10,
            "margin": [2, 2, 2, 2],
            "fillColor": "#949494",
            "color": "white",
            "alignment": 'center'
        },
        "tableAttendance": {
            "fontSize": 10,
            "margin": [
                0,
                5,
                0,
                15
            ]
        },
        "tableHeader": {
            "bold": true,
            "fontSize": 10,
            "margin": [4, 4, 4, 4 ]
        },
        "cell": {
            "bold": false,
            "margin": [4, 4, 4, 4 ]
        },
        "noMarginCell": {
            "bold": false,
            "margin": [0, 0, 0, 0]
        },
        "skillName": {
            "bold": false,
            "margin": [0, 0, 0, 0],
            "alignment": 'center'
        },
        "dobCell": {
            "bold": false,
            "fontSize": 7,
            "margin": [0, 0, 0, 0]
        },
        "cell-name": {
            bold: true,
            "margin": [4, 4, 4, 4 ]
        },
        "footer": {
            "fontSize": 8,
            "italics": true,
            "margin": [20, 0, 20, 0]
        }
    },
    "defaultStyle": {},
    images: {
        passed: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAAIJJREFUSMftkLsNgCAURY+fbVzCIfwUuoeVUTs3cQ4LZ7LARBtIaJQo0BhO+V4473IhEHhJ5lNeAAKY9WHsUL4AKbD7Sn4CQ5A7kfdA9bCvNfn4Vp7Lh+LmiJVc0UnBATTavLSp5elI61quGLW6rGsx/eRz8sSw34AIWIHJdfrAT7gA/vctXmUgC/kAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMTItMTBUMjI6MDU6MDYrMDA6MDBRhACjAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTEyLTEwVDIyOjA1OjA2KzAwOjAwINm4HwAAACh0RVh0c3ZnOmJhc2UtdXJpAGZpbGU6Ly8vdG1wL21hZ2ljay1iRXg3elppS2lAssUAAAAASUVORK5CYII=",
        emptybox: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAASAAAAEgARslrPgAAAFpJREFUSMdjYBgFJAJvBgaGJwwMDP/JxI8ZGBg88VnwmALDYfgRPgtgisgFGPqZaB3moxaMWjBqwagFg9GCJ1Ca3KKagQFS5OMEngyU1QmPGBgYPGgdKsMMAAD120YcpP3UxAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxOC0xMi0xMFQyMToxMToxMCswMDowMItRJnMAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTgtMTItMTBUMjE6MTE6MTArMDA6MDD6DJ7PAAAAKHRFWHRzdmc6YmFzZS11cmkAZmlsZTovLy90bXAvbWFnaWNrLVZ6dXNSMXVGnsNVXgAAAABJRU5ErkJggg==",
        empty: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAC3XpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHja7ZdRkuMoDIbfOcUeAUkIieNgMFVzgz3+/mDa6aR7pmpn52EfYhLAsvgBfTLdCeffP0b4CxcViSGpeS45R1yppMIVHY/XdbUU06qvm49n9GwP9wOGSdDKdZvP7V9h18cAS9t+PNuDta3jW4hu4XXJnHn2t59vIeHLTvs+lD2upk/b2V9uW3aLv94nQzC6Qk848CkkEbXPWQQrEJeKmldNcIqS0NdlZ0nfxy7c3Zfg3b2X2MW67fIcihDzdsgvMdp20he73NPwM7XHzE8PTO4pvsRujO5jnNfuasqIVA57Ux9bWT04HgilrGEZxfBV9G2VguLYYgOxDpoHSgtUiBHtQYk6VRp0rrZRwxITn2xomRvLsrkYF24LSpqFBpsU6QEsWBqoCcx8r4XWvGXN15C0PXaCJxPEJtEvJXxn/J1yC40xU5co+h0rrItnTmMZk9ys4QUgNHZMdcV3lfApb+InsAKCusLs2GCNxyVxKD1ySxZngZ/GFOL1apD1LYAQYW7FYpDXiWImUcoUjdmIEEcHn4qVI8n5AAFS5U5hgI1IBhznOTfGGC1fVr7MOFoAQiWLAU2RClgpKfLHkiOHqoqmoKpZTV2L1iw5Zc05W55nVDWxZGrZzNyKVRdPrp7d3L14LVwER5iWXCwUL6XUikkrpCtGV3jUevAhRzr0yIcdfpSjNqRPS01bbta8lVY7d+l4/XvuFrr30utJJ1LpTKee+bTTz3LWgVwbMtLQkYcNH2XUm9qm+kyNXsj9mhptapNYWn72oAaz2YcEzeNEJzMQ40QgbpMAEpons+iUEk9yk1ksjJdCGdRIJ5xOkxgIppNYB93sHuR+yS1o+lfc+GfkwkT3J8iFiW6T+8rtG2q9rr8osgDNt3DGNMrAwQanyo4PzuPfb8N/FXgLvYXeQm+ht9Bb6C30vxGSgX8e8FMz/AP4SJD9qVa/+gAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB+IMChU6GBE9OvgAAAAmSURBVEjH7c0xAQAACMOwgX/PxQT7GgMZgBRtygwMDAwMDAwMfhwXLQQsCEtCkwAAAABJRU5ErkJggg=="
            
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/RatePlanSettingWidget.js";

function RatePlanSettingWidget(node) {
    BaseTemplatedWidget.call(this);

    this.ratePlanListRepeaterView.populator = function (data, binding, node) {
        Dom.addClass(node, "RatePlan_" + data.id);
        node._data = data;

        Dom.addClass(binding.ratePlanName, "RatePlanName_" + data.id);
        Dom.setInnerText(binding.ratePlanName, data.name);
    }.bind(this);

    this.bind("click", this.addNewRatePlan, this.newRatePlanButton);
    this.bind("click", this.addNewRatePlan, this.newRatePlanButton2);
    this.bind("click", this.deleteRatePlanHandler, this.deleteButton);
    this.bind("click", this.saveRatePlanHandler, this.saveButton);
    this.bind("click", this.cancelButtonClickedHandler, this.cancelButton);
    this.bind("click", this.ratePlanListClickedHandler, this.ratePlanListRepeaterView.node());
    this.bind(RatePlanWidget.RATE_PLAN_NAME_INPUT_CHANGED, this.ratePlanNameInputChangedHandler, this.ratePlanContentEditor);
    this.bind(RatePlanWidget.RATE_PLAN_DATA_CHANGED, this.invalidateButtonStatus, this.ratePlanContentEditor);
    this.bind("click", this.cloneButtonClickedHandler, this.cloneButton);
}

__extend(BaseTemplatedWidget, RatePlanSettingWidget);

RatePlanSettingWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.ratePlanNameInput, "Rate plan name is required");
    this.fetchAndRenderRatePlan();
};

RatePlanSettingWidget.prototype.fetchAndRenderRatePlan = function (forceActiveRatePlan) {
    var thiz = this;
    this.ratePlanItems = [];
    $classBillByHourService.getRatePlans(function (ratePlans) {
        if (!ratePlans || !ratePlans.length) {
            Dom.removeClass(this.noRatePlanContent, "Hidden");
            Dom.addClass(this.ratePlanContentWrapper, "Hidden");
            this.ratePlanListRepeaterView.setItems([]);
        } else {
            thiz.ratePlanItems = ratePlans;
            this.ratePlanListRepeaterView.setItems(ratePlans);
            this.selectRatePlan(forceActiveRatePlan ? forceActiveRatePlan : ratePlans[0]);
        }
    }.bind(this), function (error) {
        Dialog.error(error.message);
    });
};

RatePlanSettingWidget.prototype.addNewRatePlan = function (ratePlanData) {
    var previousItems = this.ratePlanItems || [];
    if (!previousItems.length) {
        Dom.addClass(this.noRatePlanContent, "Hidden");
        Dom.removeClass(this.ratePlanContentWrapper, "Hidden");
    }

    var initialRatePlan = {
        name: "[No Rate Plan Name]",
        id: Util.newUUID(),
        fakeItem: true,
        items: []
    };
    if (ratePlanData && ratePlanData.fakeItem) initialRatePlan = ratePlanData;
    previousItems.splice(0, 0, initialRatePlan);
    this.ratePlanListRepeaterView.setItems(previousItems);
    this.selectRatePlan(initialRatePlan);
};

RatePlanSettingWidget.prototype.ratePlanListClickedHandler = function (event) {
    var thiz = this;
    var target = Dom.getTarget(event);
    var ratePlanItem = Dom.findParentWithClass(target, "RatePlanItem");
    if (!ratePlanItem || !ratePlanItem._data || (this.activedRatePlan && this.activedRatePlan.id === ratePlanItem._data.id)) return;
    if (this.ratePlanWidget && this.ratePlanWidget.isRatePlanDataChanged()) {
        Dialog.confirm("The rate plan was changed but unsaved. Please discard or save these changes to continue", null, "Save & Continue", function () {
            thiz.saveRatePlanHandler(function () {
                thiz.selectRatePlan(ratePlanItem._data);
            });
        },
        "Cancel", function () {
            return;
        }, "Discard & Continue", function () {
            thiz.discardChanges(ratePlanItem._data);
        });
    } else {
        this.selectRatePlan(ratePlanItem._data);
    }
};

RatePlanSettingWidget.prototype.selectRatePlan = function (ratePlan) {
    if (!ratePlan) return;
    this.activedRatePlan = ratePlan;
    var ratePlanNodes = this.ratePlanListRepeaterView.node().getElementsByClassName("RatePlan_" + ratePlan.id);
    if (ratePlanNodes && ratePlanNodes.length) {
        var node = ratePlanNodes[0];
        if (ratePlan.fakeItem) Dom.addClass(node, "FakeItem");
        Dom.doOnSelector(this.ratePlanListRepeaterView.node(), ".Active", function (el) {
            Dom.removeClass(el, "Active");
        });
        Dom.addClass(node, "Active");

        this.ratePlanContentEditor.innerHTML = "";
        if (!ratePlan.fakeItem) {
            $classBillByHourService.getRatePlan(ratePlan.id, function (res) {
                this.ratePlanWidget = new RatePlanWidget(res).into(this.ratePlanContentEditor);
                this.ratePlanWidget.setDataChanged(false);
            }.bind(this), function (error) {
                Dialog.error(error.message);
            });
        } else {
            this.ratePlanWidget = new RatePlanWidget(ratePlan).into(this.ratePlanContentEditor);
            this.ratePlanWidget.setDataChanged(true);
        }
    }
};

RatePlanSettingWidget.prototype.deleteRatePlanHandler = function () {
    Dialog.confirmDangerousAction("This rate plan will be deleted. Are you sure you want to delete this plan?", null, "Delete", function () {
        if (this.activedRatePlan.fakeItem) {
            this.activedRatePlan = null;
            this.fetchAndRenderRatePlan();
        } else {
            $classBillByHourService.deleteRatePlan(this.activedRatePlan.id, function () {
                SnackBar.show("Rate Plan was deleted successfully");
                this.fetchAndRenderRatePlan();
            }.bind(this), function (error) {
                Dialog.error(error.message);
            });
        }
    }.bind(this),
    "Cancel", function () {
        return;
    }, null, null);
};

RatePlanSettingWidget.prototype.saveRatePlanHandler = function (callback) {
    if (this.saveButtonClickedTimeout) window.clearTimeout(this.saveButtonClickedTimeout);
    var thiz = this;
    this.saveButtonClickedTimeout = window.setTimeout(function () {
        if (!thiz.ratePlanWidget) return;
        if (!thiz.ratePlanWidget.isRatePlanInputValid()) return;
        var ratePlan = thiz.ratePlanWidget.getRatePlanValues();
        ratePlan.id = thiz.activedRatePlan.fakeItem ? -1 : thiz.activedRatePlan.id;
        thiz.saveButton.setAttribute("disabled", "disabled");
        $classBillByHourService.saveRatePlan(ratePlan, function (res) {
            thiz.saveButton.removeAttribute("disabled");
            SnackBar.show("Rate Plan was saved successfully");
            Dom.doOnSelector(thiz.ratePlanListRepeaterView.node(), ".FakeItem", function (el) {
                el._data = res;            
                Dom.addClass(el, "RatePlan_" + res.id);
                Dom.removeClass(el, "FakeItem");
            });
            if (thiz.ratePlanItems && thiz.ratePlanItems[0]) thiz.ratePlanItems[0] = res;
            thiz.activedRatePlan = res;
            thiz.ratePlanWidget.setDataChanged(false);
            if (typeof(callback) == "function") callback();
        }.bind(this), function (error) {
            thiz.saveButton.removeAttribute("disabled");
            Dialog.error(error.message);
        });
    }, 200);
    
};

RatePlanSettingWidget.prototype.cancelButtonClickedHandler = function () {
    Dialog.confirmDangerousAction("All changes are not saved. Do you want to discard these changes?", null, "Discard Changes", function () {
        this.discardChanges();
    }.bind(this),
    "Cancel", function () {
        return;
    }, null, null);
};

RatePlanSettingWidget.prototype.discardChanges = function (nextRatePlanItem) {
    this.ratePlanWidget.setDataChanged(false);
    if (nextRatePlanItem) {
        this.fetchAndRenderRatePlan(nextRatePlanItem);
    } else {
        this.fetchAndRenderRatePlan(this.activedRatePlan.fakeItem ? null : this.activedRatePlan);
    }
};

RatePlanSettingWidget.prototype.ratePlanNameInputChangedHandler = function (event) {
    var value = event.value;
    var ratePlanNameElements = this.ratePlanListRepeaterView.node().getElementsByClassName("RatePlanName_" + this.activedRatePlan.id);
    if (ratePlanNameElements && ratePlanNameElements.length) {
        Dom.setInnerText(ratePlanNameElements[0], value && value.trim() ? value : "[No Rate Plan Name]");
        this.ratePlanWidget.setDataChanged(true);
    }
};

RatePlanSettingWidget.prototype.invalidateButtonStatus = function (event) {
    if (event.isDataChanged) {
        this.newRatePlanButton2.setAttribute("disabled", "disabled");
        this.cancelButton.removeAttribute("disabled");
        this.saveButton.removeAttribute("disabled");
        this.cloneButton.setAttribute("disabled", "disabled");
    } else {
        this.newRatePlanButton2.removeAttribute("disabled");
        this.cancelButton.setAttribute("disabled", "disabled");
        this.saveButton.setAttribute("disabled", "disabled");
        this.cloneButton.removeAttribute("disabled", "disabled");
    }
};

RatePlanSettingWidget.prototype.cloneButtonClickedHandler = function (event) {
    var data = this.ratePlanWidget.getRatePlanValues();
    data.id = Util.newUUID();
    data.fakeItem = true;
    data.name = "[CLONE] " + data.name;
    
    if (data.items && data.items.length > 0) {
        data.items.forEach(function (item) {
            item.id = 0;
            item.ratePlanId = 0;
        });
    }
    this.addNewRatePlan(data);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/RatePlanWidget.js";

function RatePlanWidget(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
    this.selectedDiscountPlanId = this.options && this.options.discountPlanId ? this.options.discountPlanId : 0;
    this.selectedFirstChargeOption = null;

    this.bind("change", function (event) {
        if (event.target) {
            this.setDataChanged(true);
            this._radioValueChangedHandler(event.target);
        }
    }.bind(this), this.container);
    this.bind("click", this.newRateItemClickHandler, this.newRatePlanItemButton);

    this.bind("click", function() {
        var discountPlan = this.discountPlanCombo.getSelectedItem();
        this._editDiscountPlanButtonClickHandler(discountPlan);
    }.bind(this), this.editDiscountPlanButton);
    this.bind("click", function() {
        this._editDiscountPlanButtonClickHandler({
            key: Util.newUUID(),
            allowMultiClassDiscount: true,
            allowMultiStudentDiscount: true,
            allowCoupon: true,
            classDiscountItems: [],
            athleteDiscountItems: []
        });
    }.bind(this), this.newDiscountPlanButton);
    this.bind("p:ItemSelected", function (event) {
        var target = Dom.getTarget(event);
        if (!target) return;

        if (Dom.hasClass(target, "MonthDayComboBox")) {
            this._renderPaymentDueByExample();
        }
        if (!event.fromUser) return;
        if (Dom.hasClass(target, "DiscountPlanCombo")) {
            var selectedItem = this.discountPlanCombo.getSelectedItem();
            if (selectedItem && selectedItem.id) {
                this.selectedDiscountPlanId = selectedItem.id;
            }
        }
        this.setDataChanged(true);
    }.bind(this), this.container);

    this.bind("input", function (e) {
        var target = Dom.getTarget(e);
        if (!target) return;
        Dom.emitEvent(RatePlanWidget.RATE_PLAN_NAME_INPUT_CHANGED, target, {value: target.value});
    }.bind(this), this.ratePlanNameInput);

    this.bind("e:TabChange", function (event) {
        event.stopPropagation();
    }, this.rateDetailTabPane.node());

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.ratePlanNameInput, "Rate plan name is required")
        .rule(new GenericRule(this.rFirstChargeRegistration, function (rule) {
            if (!this.rFirstChargeRegistration.checked && !this.rFirstChargeClassStart.checked && !this.rFirstChargeNextChargeDate.checked) {
                return false;
            }
            return true;
        }.bind(this), "Please choose First Charge."));
    this._setupHourlyRateTable();

    this.dayOfMonth = [{id: 1, name: "1st"}, {id: 2, name: "2nd"}, {id: 3, name: "3rd"}];
    for (var i = 4; i <= 20; i ++) {
        this.dayOfMonth.push({id: i, name: i + "th"});
    }
    this.dayOfMonth.push({id: 21, name: "21st"});
    this.dayOfMonth.push({id: 22, name: "22nd"});
    this.dayOfMonth.push({id: 23, name: "23rd"});
    for (var i = 24; i <= 28; i ++) {
        this.dayOfMonth.push({id: i, name: i + "th"});
    }
    this.dayOfMonth.push({id: 99, name: "Last day of month"});

    var baseNameRenderer = function (data, selected) {
        if (!data) return "";
        return data.name
    };
    this.chargeCategory.renderer = baseNameRenderer;
    this.monthDayComboBox.renderer = baseNameRenderer;
    this.monthDayComboBox.setItems(this.dayOfMonth);
    if (this.options && this.options.dayOfMonth) this.monthDayComboBox.selectItemById(this.options.dayOfMonth);

    this._setupChargeCategoriesComboBox();
    this._setupDiscountPlanComboBox();
    this.loadDiscountPlanList();
    
    InfoTip.install(this.prorateChargeContent, {
        match: function (node) {
            return Dom.hasClass(node, "help-circle");
        },
        getMessage: function (target) {
            return Dom.newDOMElement({
                _name: "div",
                "class": "ProrateChargeHintText",
                _html: "The per-class cost of this Plan Item is based on four weeks in each Charge Cycle. " 
                + "If this class session begins or ends partway through a Charge Cycle, " 
                + "the count of weeks includes weeks that would occur if the session spanned the entire Charge Cycle. " 
                + "Classes that meet once per week, will calculate as 4 classes for the Charge Cycle."
            })
        }
    });
}
__extend(BaseTemplatedWidget, RatePlanWidget);

RatePlanWidget.RATE_PLAN_NAME_INPUT_CHANGED = "p:RatePlanNameInputChanged";
RatePlanWidget.RATE_PLAN_DATA_CHANGED = "p:RatePlanDataChanged";

RatePlanWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst || !this.options) return;
    this.hourlyRateTable.setup();
    if (this.options && this.options.items) {
        this.options.items.forEach(function (element) {
            element.generatedId = Util.newUUID();
        });
    }
    this._renderRatePlanInfo();
};

RatePlanWidget.prototype._renderRatePlanInfo = function () {
    this.ratePlanNameInput.value = this.options.name || "";
    this.hourlyRateTable.setItems(this.options.items || []);
    this.validateEmptyData();
    if (this.options.discountable) {
        this.isDiscountable.checked = true;
        this._radioValueChangedHandler(this.isDiscountable);
    }
    Dom.toggleClass(this.discountPlanWrapper, "Disabled", !this.options.discountable);

    if (this.options.firstChargeOption === ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
        this.rFirstChargeRegistration.checked = true;
        this._radioValueChangedHandler(this.rFirstChargeRegistration);
    } else if (this.options.firstChargeOption === ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
        this.rFirstChargeClassStart.checked = true;
        this._radioValueChangedHandler(this.rFirstChargeClassStart);
    } else if (this.options.firstChargeOption === ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY) {
        this.ignoreFristClassDay.checked = true;
        this._radioValueChangedHandler(this.ignoreFristClassDay);
    } else if (this.options.firstChargeOption === ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_AFTER_FIRST_CLASS_DAY) {
        this.chargeAfterFristClassDay.checked = true;
        this._radioValueChangedHandler(this.chargeAfterFristClassDay);
    }

    if (this.options.recurrentDueTimeType === ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT) {
        this.rDueBySystemDefault.checked = true;
        this._radioValueChangedHandler(this.rDueBySystemDefault);
    }

    if (this.options.prorateCharge) {
        this.prorateCharge.checked = true;
        this.prorateNoClassDay.checked = this.options.prorateOnNoClassDays;
        this._radioValueChangedHandler(this.prorateCharge);
    }
};

RatePlanWidget.prototype.isRatePlanInputValid = function () {
    if (!ValidationManager.run(this.validationRules)) return false;
    if (!this.hourlyRateTable.getItems() || !this.hourlyRateTable.getItems().length) {
        var thiz = this;
        Dialog.error("", "Rate Plan Chart is currently blank.", function () {
            setTimeout(function(){
                var tab = thiz.rateDetailTabPane.findTabByName("rateTable");
                thiz.rateDetailTabPane.setActiveTabPane(tab);
            }, 200);
        });
        return false;
    }
    return true;
};

RatePlanWidget.prototype.newRateItemClickHandler = function () {
    new HourRateDialog().callback(function (data) {
        if (data) {
            var rate = this._validateAndGetRateData(data);
            if (rate) {
                var preItems = this.hourlyRateTable.getItems() || [];
                preItems.push(rate);
                this.hourlyRateTable.setItems(this._reloadUpperLimitValue(preItems));
                this.validateEmptyData();
                this.setDataChanged(true);
            }
        }
    }.bind(this)).open();
};

RatePlanWidget.prototype.getRatePlanValues = function () {
    return {
        name: this.ratePlanNameInput.value.trim(),
        chargeCategoryId: this.chargeCategory.getSelectedItem() ? this.chargeCategory.getSelectedItem().id : 0,
        items: this.hourlyRateTable.getItems(),
        discountable: this.isDiscountable.checked || false,
        discountPlanId: !this.isDiscountable.checked ? null : this.discountPlanCombo.getSelectedItem() ? this.discountPlanCombo.getSelectedItem().id : 0,
        firstChargeOption: this.selectedFirstChargeOption,
        dayOfMonth: this.monthDayComboBox.getSelectedItem().id,
        recurrentDueTimeType: this.rDueBySystemDefault.checked ? this.rDueBySystemDefault.value : ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT,
        prorateCharge: this.prorateCharge.checked,
        prorateOnNoClassDays: this.prorateCharge.checked && this.prorateNoClassDay.checked ? true : false,
        recurringMode: this.rChargeCycleMonthly.checked ? this.rChargeCycleMonthly.value : "UNDEFINED"
    }
};

RatePlanWidget.prototype._renderPaymentDueByExample = function () {
    var currentDate = moment(new Date());
    var teamTimezoneID = window.TEAM_INFO.timezoneId;
    var startDate = moment.tz([currentDate.year(), currentDate.month(), currentDate.date()], teamTimezoneID);

    var exampleText = "EXAMPLE: An installment charged on <strong>";
    if (this.monthDayComboBox.getSelectedItem()) {
        if (this.monthDayComboBox.getSelectedItem().id == 99) {
            startDate.date(1);
            startDate.add("M", 1);
            startDate.add("d", -1);
        } else {
            startDate.date(this.monthDayComboBox.getSelectedItem().id);
        }
        exampleText += " " + FormatUtil.formatDateWithTZID(startDate, "date_standard", teamTimezoneID);
    }

    var thiz = this;
    $classAdminService.getDueDate(startDate.toDate(), function (res) {
        exampleText += "</strong> will be collected on <strong>"
            + FormatUtil.formatDateWithTZID(res, "date_standard", teamTimezoneID) + "</strong>";
        thiz.rDueByDefaultExample.innerHTML = exampleText;
    }, function (err) {});
};

RatePlanWidget.prototype._reloadUpperLimitValue = function (items) {
    var previousUnlimitedItem = items.find(function (item) {
        return item.unlimited;
    });

    var sortedRawItems = items.filter(function (item) {
        return !item.unlimited;
    }).sort(function (a, b) {
        return ((a.limitTime.hour * 60) + a.limitTime.minute) - ((b.limitTime.hour * 60) + b.limitTime.minute);
    });
    var highestRange = sortedRawItems[sortedRawItems.length - 1];
    var upperMinutes = (highestRange.limitTime.hour * 60) + highestRange.limitTime.minute + 1;
    sortedRawItems.push({
        unlimited: true,
        limitTime: {
            hour: parseInt(upperMinutes / 60),
            minute: upperMinutes % 60
        },
        amount: !previousUnlimitedItem || previousUnlimitedItem.amount < highestRange.amount ? highestRange.amount : previousUnlimitedItem.amount,
        generatedId: Util.newUUID()
    });
    return sortedRawItems;
};

RatePlanWidget.prototype._validateAndGetRateData = function (rate) {
    var items = this.hourlyRateTable.getItems() || [];
    var totalMinutes = (rate.limitTime.hour * 60) + rate.limitTime.minute;
    var isSameTime = items.find(function (v) {
        return ((v.limitTime.hour * 60) + v.limitTime.minute) == totalMinutes;
    });
    if (isSameTime) {
        Dialog.error("", "This rate range already exists.");
        return false;
    }
    rate.limitTime.hour = parseInt(totalMinutes / 60);
    rate.limitTime.minute = totalMinutes % 60;
    return rate;
};

RatePlanWidget.prototype.loadDiscountPlanList = function () {
    $classAdminService.getDiscountPlanToAttachRatePlan(function(data) {
        this.discountPlanCombo.setItems(data.result);
        if (this.selectedDiscountPlanId) {
            this.discountPlanCombo.selectItemById(this.selectedDiscountPlanId);
        }
    }.bind(this), function(error) {
        Dialog.error(error.message);
    });
};

RatePlanWidget.prototype._radioValueChangedHandler = function (target) {
    if (!target) return;
    if (!Dom.hasClass(target, "ProrateNoClassDay")) {
        var wrapper = target.parentNode.parentNode;
        if (!wrapper) return;
        var items = wrapper.getElementsByClassName("RadioItemInfo");
        for (var i = 0; i < items.length; i++) {
            Dom.removeClass(items[i], "RadioSelected");
        }
        Dom.addClass(target.parentNode, "RadioSelected");
    }
    if (Dom.hasClass(target, "ProrateCharge")) {
        Dom.toggleClass(this.prorateChargeContent, "Disabled", !this.prorateCharge.checked);
    } else if (Dom.hasClass(target, "FirstChargeItem")) {
        this._firstChargeChangedHandler(target);
    } else if (Dom.hasClass(target, "DiscountableItem")) {
        Dom.toggleClass(this.discountPlanWrapper, "Disabled", !this.isDiscountable.checked);
    }
};

RatePlanWidget.prototype._firstChargeChangedHandler = function (target) {
    if (!target) return;
    this.selectedFirstChargeOption = target.value;
    if (target.value == ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY
        || target.value == ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_AFTER_FIRST_CLASS_DAY) {
        this.rFirstChargeNextChargeDate.checked = true;
        Dom.addClass(this.rFirstChargeNextChargeDate.parentNode, "RadioSelected");
    } else if (target.value != "NEXT_CHARGE_DATE") {
        this.ignoreFristClassDay.checked = false;
        this.chargeAfterFristClassDay.checked = false;
    } else if (target.value == "NEXT_CHARGE_DATE") {
        this.ignoreFristClassDay.checked = true;
        Dom.addClass(this.ignoreFristClassDay.parentNode, "RadioSelected");
        this.selectedFirstChargeOption = ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY;
    }
};

RatePlanWidget.prototype._editDiscountPlanButtonClickHandler = function (discountPlan) {
    if (!discountPlan) return;
    discountPlan.key = Util.newUUID();
    this._openDiscountPlanDialog(discountPlan);
};

RatePlanWidget.prototype._openDiscountPlanDialog = function (discountPlanData) {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        var discountPlanOptions = {
            discountPlan: discountPlanData,
            discountConfiguration: {
                discountApplicationTypes: window.LOGIN_INFO.discountApplicationTypes,
                discountOrderTypes: window.LOGIN_INFO.discountOrderTypes
            }
        };
        new DiscountPlanDialog().callback(function (discountData) {
            if (discountData) {
                thiz.selectedDiscountPlanId = discountData.id;
                thiz.loadDiscountPlanList();
            }
        }).open(discountPlanOptions);
    }
};

RatePlanWidget.prototype._setupDiscountPlanComboBox = function () {
    this.discountPlanCombo.useHtml = true;
    this.discountPlanCombo.setPopupClass("DiscountPlansPopup");
    this.discountPlanCombo.renderer = function(item) {
        var html = "<vbox class=\"InfoGroup\">"
                + "<hbox class=\"DiscountPlanName\">" + item.name + "</hbox>"
                + "<hbox>"
                + "<span>Multi-Class Discount:"
                + "<span class=\"DisplayValue " + (item.allowMultiClassDiscount ? "" : "OFF") + "\">" + (item.allowMultiClassDiscount ? "Yes" : "No")
                + "</span></span>"
                + "<span> - Multi-Athlete Discount:"
                + "<span class=\"DisplayValue " + (item.allowMultiStudentDiscount ? "" : "OFF") + "\">" + (item.allowMultiStudentDiscount ? "Yes" : "No")
                + "</span></span>"
                + "<span> - Coupons: "
                + "<span class=\"DisplayValue " + (item.allowCoupon ? "" : "OFF") + "\">" + (item.allowCoupon ? "Yes" : "No")
                + "</span></span>"
                + "</hbox>"
                + "</vbox>";
        return html;
    };
    this.discountPlanCombo.comparer = Util.sameId;
};

RatePlanWidget.prototype._setupChargeCategoriesComboBox = function () {
    $paymentUtilService.getSimpleTeamChargeCategories(function (res) {
        this.chargeCategory.setItems(res);
        if (this.options && this.options.chargeCategoryId) {
            this.chargeCategory.selectItemById(this.options.chargeCategoryId);
        }
    }.bind(this));
};

RatePlanWidget.prototype._setupHourlyRateTable = function () {
    var thiz = this;
    this.hourlyRateTable.column(new DataTable.PlainTextColumn("Up to Hours Per Week", function (data) {
        var hourText = data.limitTime.hour ? (data.limitTime.hour + " " + (data.limitTime.hour > 1 ? "hours" : "hour")) : "";
        var minuteText = data.limitTime.minute ? data.limitTime.minute + " " + (data.limitTime.minute > 1 ? "minutes" : "minute") : "";
        if (data.unlimited) {
            return (hourText + " " + minuteText + " & Up").trim();
        }
        return "Up to " + hourText + " " + minuteText;
    }).width("1*", "15em"));

    this.hourlyRateTable.column(new DataTable.PlainTextColumn("Monthly Rate", function (data) {
        return Util.toCurrency(data.amount);
    }).width("12em"));

    var actions = [{
        id: "edit", type: "pencil", title: "Edit Hour Rate",
        isApplicable: function(item) {
            return true;
        },
        handler: function (item) {
            thiz._editRatePlanItem(item);
        }
    },{
        id: "delete", type: "delete", title: "Delete Hour Rate",
        isApplicable: function(item) {
            return !item.unlimited;
        },
        handler: function (item) {
            thiz._deleteRatePlanItem(item);
        }
    }];
    this.hourlyRateTable.column(new DataTable.ActionColumn(actions).width("8em"));
};

RatePlanWidget.prototype._editRatePlanItem = function (item) {
    new HourRateDialog().callback(function (editedItem) {
        if (!editedItem) return;

        var editedItemIndex = this.hourlyRateTable.getItems().findIndex(function (element) {
            return element.generatedId === editedItem.generatedId;
        });
        if (editedItemIndex !== -1) {
            var newItems = this.hourlyRateTable.getItems();
            if (!newItems.length) return;
            newItems[editedItemIndex] = editedItem;
            if (editedItem.unlimited) {
                this.hourlyRateTable.setItems(newItems);
            } else {
                this.hourlyRateTable.setItems(this._reloadUpperLimitValue(newItems));
            }
            this.setDataChanged(true);
        }
    }.bind(this)).open(item);
};

RatePlanWidget.prototype._deleteRatePlanItem = function (item) {
    if (!item) return;
    Dialog.confirmDangerousAction("Are you sure you want to delete this item?", null, "Delete", function () {
        var newItems = this.hourlyRateTable.getItems().filter(function (element) {
            return element.generatedId != item.generatedId;
        });
        if (newItems && newItems.length === 1) {
            this.hourlyRateTable.setItems([]);
        } else {
            this.hourlyRateTable.setItems(this._reloadUpperLimitValue(newItems));
        }
        this.validateEmptyData();
        this.setDataChanged(true);
    }.bind(this), "Cancel", null);
};

RatePlanWidget.prototype.setDataChanged = function (isChanged) {
    this.ratePlanDataChanged = isChanged;
    Dom.emitEvent(RatePlanWidget.RATE_PLAN_DATA_CHANGED, this.node(), {isDataChanged: isChanged});
};

RatePlanWidget.prototype.isRatePlanDataChanged = function () {
    return this.ratePlanDataChanged;
};

RatePlanWidget.prototype.validateEmptyData = function () {
    if (this.hourlyRateTable.getItems().length > 0) {
        Dom.hide(this.emptyDataMessage);
    } else {
        Dom.show(this.emptyDataMessage);
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ReceiptDetailDialog.js";

function ReceiptDetailDialog() {
    var thiz = this;
    Dialog.call(this);
    this.title = "Receipt Detail";
}
__extend(Dialog, ReceiptDetailDialog);

ReceiptDetailDialog.prototype.setup = function(options) {
    var thiz = this;
    var queryStr = Object.keys(options).map(function(k) { return k + "=" + options[k];}).join("&");
    console.log("ReceiptDetailDialog open: /LessonRegAccShow.jsp?", queryStr);
    var iframe = Dom.newDOMElement({
        _name: "iframe",
        src: "/LessonRegAccShow.jsp?use-empty-layout=true&" + queryStr,
        frameBorder: 0,
        scrolling: "no",
        width: "100%",
        height: "100%"
    });
    this.bind("load", function() {
        var h = iframe.contentDocument.body.scrollHeight;
        thiz.legacyFrame.style.height = h + "px";
    }, iframe);
    this.legacyFrame.appendChild(iframe);
};

ReceiptDetailDialog.prototype.getDialogActions = function() {
    return [
        {
            type: "cancel", title: "Close",
            order: 1,
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/RecurringChargeAnnuallyFrequencyView.js";

function RecurringChargeAnnuallyFrequencyView() {
    BaseTemplatedWidget.call(this);

    this.chargeTimesSelection.parseData = function(data) {
        return {
            value: data.value,
            text: data.displayText
        };
    };

    var thiz = this;
    this.validationRules = new RuleSet()
                            .live(true)
                            .rule(new GenericRule(this.chargeTimesSelection, function(input) {
                                        var values = thiz.chargeTimesSelection.getValues();
                                        return values.length > 0;
                                    }, "Please select at least one month")
                            );
};
__extend(BaseTemplatedWidget, RecurringChargeAnnuallyFrequencyView);


// ----- Override Methods Region ----- //
RecurringChargeAnnuallyFrequencyView.prototype.setData = function(data, selectedValues) {
    this.data = data;
    if (!data || (typeof data != "object")) return;
    if (!data.chargeTimes || (typeof data.chargeTimes != "object")) return;

    var list = Object.keys(data.chargeTimes).map(function(k) {
        var value = data.chargeTimes[k];
        var displayText;
        if (!value) {
            displayText = "Unset";
        } else {
            var mm = new moment(value);
            if (data.timeZoneID) mm = mm.tz(data.timeZoneID);
            displayText = mm.format("MM") + " - " + mm.format("MMMM");
        }

        return {key: k, value: value, displayText: displayText};
    });
    this.chargeTimesSelection.setItems(list);

    if (selectedValues && Array.isArray(selectedValues)) {
        this.chargeTimesSelection.setValuesSelected(selectedValues, true);
    }
}

RecurringChargeAnnuallyFrequencyView.prototype.getValidationRules = function() {
    return this.validationRules;
};

RecurringChargeAnnuallyFrequencyView.prototype.getSelectedChargeTimes = function() {
    return this.chargeTimesSelection.getValues();
};
// --X-- Override Methods Region --X-- //


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/RecurringChargeMonthlyFrequencyView.js";

function RecurringChargeMonthlyFrequencyView() {
    BaseTemplatedWidget.call(this);

    this.validationRules = new RuleSet();
};
__extend(BaseTemplatedWidget, RecurringChargeMonthlyFrequencyView);

// ----- Override Methods Region ----- //
RecurringChargeMonthlyFrequencyView.prototype.setData = function(data, selectedValues) {
    this.data = data;
};

RecurringChargeMonthlyFrequencyView.prototype.getValidationRules = function() {
    return this.validationRules;
};

RecurringChargeMonthlyFrequencyView.prototype.getSelectedChargeTimes = function() {
    return null;
};
// --X-- Override Methods Region --X-- //


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/RecurringChargeOneTimeFrequencyView.js";

function RecurringChargeOneTimeFrequencyView() {
    BaseTemplatedWidget.call(this);

    this.validationRules = new RuleSet();
};
__extend(BaseTemplatedWidget, RecurringChargeOneTimeFrequencyView);

// ----- Override Methods Region ----- //
RecurringChargeOneTimeFrequencyView.prototype.setData = function(data, selectedValues) {
    this.data = data;
};

RecurringChargeOneTimeFrequencyView.prototype.getValidationRules = function() {
    return this.validationRules;
};

RecurringChargeOneTimeFrequencyView.prototype.getSelectedChargeTimes = function() {
    return null;
};
// --X-- Override Methods Region --X-- //


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/RegistrationReport.js";

function RegistrationReport() {
    var thiz = this;
    this.attached = false;
    BaseTemplatedWidget.call(this);
    this.bind("p:PageLoaded", function () {
        var summary = this.dataView.lastResultExtra.summary;
        // thiz.summaryLabel.innerHTML = String.format("<span>{0}</span> member(s)", this.dataView.getDiscoveredTotalItems());
        thiz.totalRegCount.innerHTML = summary.totalEntered + summary.totalWaiting + summary.totalCanceled + summary.totalFuture;
    }, this.dataView);
    this.dataView.setDefaultSelectionHandler(this.dataViewClickedHandler.bind(this));

    InfoTip.install(this.dataView.node(), {
        match: function (node) {
            return Dom.hasClass(node, "alert-circle");
        },
        getMessage: function (target) {
            return Dom.newDOMElement({
                _name: "div",
                "class": "SignedHintText",
                _html: target.getAttribute("message")
            })
        }
    });
    this.instructorListRepeater.populator = function (data, binding, node) {
        binding.instructorName.innerHTML = data.instructorName;
    }
    this.bind("click", this.hideInstructorListButtonClickedHandler, this.hideInstructorListButton);
    this.bind("click", this.closeInstructorListButtonClickedHandler, this.closeInstructorPopupHeader);
}
__extend(BaseTemplatedWidget, RegistrationReport);

RegistrationReport.prototype.onAttached = function(firstTime) {
    if (!firstTime) return;
    var thiz = this;
    if (this.attached) return;
    this.attached = true;
    if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
        thiz.init();
    } else {
        $classAdminService.getAccountInfo(function (res) {
            window.LOGIN_INFO.allowWaiver = res.allowWaiver;
            thiz.init();
        }, function (err) {});
    }
};

RegistrationReport.prototype.init = function() {
    var thiz = this;

    var actions = [];

    var canEmailSMSPush = ClassAuthUtils.canEmailSMSPushAccountMember(window.LOGIN_INFO);
    var canSendAgreementReviewReminder = ClassAuthUtils.canSendAgreementReviewReminder(window.LOGIN_INFO);
    if (canEmailSMSPush || canSendAgreementReviewReminder) {
        actions.push({
            title: "Communicate:",
            group: "RegistrationReportCommunicate",
            applicable: function () {
                return false;
            }
        });
        actions.push({
            title: "Email" + (ADMIN_CONTEXT.isSMSEnabled ? "/SMS" : "") + "/Push Custom Message",
            icon: "hexagon-multiple",
            group: "RegistrationReportCommunicate",
            runOnIds: this.sendEmail.bind(this),
            applicable: function (count, dataView) {
                return count > 0;
            },
            visible: function(count, dataView) {
                return canEmailSMSPush;
            }
        });
        if (window.LOGIN_INFO && window.LOGIN_INFO.allowWaiver) {
            actions.push({
                title: "Send Agreement Review Reminder",
                group: "RegistrationReportCommunicate",
                icon: "email",
                run: function () {
                    var ids = [];
                    thiz.dataView.getSelectedItems(function (items) {
                        for (var i = 0; i < items.length; i ++) {
                            ids.push(items[i].account_id);
                        }
                        thiz.sendAgreementReview(ids);
                    });
                },
                visible: function(count, dataView) {
                    return canSendAgreementReviewReminder;
                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
            actions.push({
                title: "Edit & Send Agreement Review Reminder",
                group: "RegistrationReportCommunicate",
                icon: "email",
                run: function () {
                    var ids = [];
                    thiz.dataView.getSelectedItems(function (items) {
                        for (var i = 0; i < items.length; i ++) {
                            ids.push(items[i].account_id);
                        }
                        thiz.sendAgreementReview(ids, true);
                    });
                },
                visible: function(count, dataView) {
                    return canSendAgreementReviewReminder;
                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
        }
    }

    actions.push({
        title: "Review:",
        group: "RegistrationReportReview",
        applicable: function () {
            return false;
        }
    });
    actions.push({
        title: "Mark as Reviewed",
        group: "RegistrationReportReview",
        icon: "eye",
        runOnIds: function (ids) {
            thiz.updateReviewedStatus(ids, "REVIEWED");
        },
        applicable: function (count, dataView) {
            return count > 0;
        }
    });
    actions.push({
        title: "Mark as Not Reviewed",
        group: "RegistrationReportReview",
        icon: "eye-off",
        runOnIds: function (ids) {
            thiz.updateReviewedStatus(ids, "NOT_REVIEWED");
        },
        applicable: function (count, dataView) {
            return count > 0;
        }
    });

    actions.push({
        title: "Export to Excel", icon: "file-excel",
        runOnIds: function (ids) {
            $classAdminService.generateDownloadableNewRegistrationsReportAsExcel(ids, function (jobId) {
                new WaitingExportDialog().open(jobId);
            }, "Loading...");
        },
        applicable: function (count, dataView) {
            return count > 0;
        }
    });

    actions.push({
        title: "Print", icon: "printer",
        runOnIds: this.printReport.bind(this),
        applicable: function (count, dataView) {
            return count > 0;
        }
    });

    this.dataView.registerActions(actions, "Action...");


    this.dataView.registerCustomRenderer("name", function(data, value) {
        return {
            _name: "strong",
            class: "InfoLink MemberName",
            _text: value
        }
    });
    this.dataView.registerCustomRenderer("account_name", function(data, value) {
        var _c = [{ _name: "strong", class: "InfoLink AccountName", _text: value }];
        if (ClassAuthUtils.canViewClassRegistrationFinancialInfo(window.LOGIN_INFO) && ((!data.waiting && !data.canceled) || data.paid)) {
            _c.push({
                _name: "span",
                _children: [{
                    _name: "icon",
                    class: "InfoLink ReceiptDetail receipt",
                    title: "View Receipt"
                }]
            });
        }
        return {
            _name: "hbox",
            _children: _c
        };
    });
    this.dataView.registerCustomRenderer("dt_dob", function(data, value) {
        return {
            _name: "span",
            _text: FormatUtil.formatDate(value, "date_month_only", "server")
        }
    });
    this.dataView.registerCustomRenderer("class_title", function(data, value) {
        return {
            _name: "strong",
            class: "InfoLink ClassTitle",
            _text: value
        }
    });
    this.dataView.registerCustomRenderer("sex", function(data, value) {
        return {
            _name: "span",
            _text: data.memberGender
        }
    });
    this.dataView.registerCustomRenderer("canceled", function (data, value) {
        var status = (!data.canceled && data.waiting) ? "Waiting" : ((data.canceled || thiz.isDropDatePassed(data))? "Inactive" : "Active");
        status = (status == "Active" && thiz.isFutureReg(data)) ? "Future" : status;
        var _children = [];
        if (data.waiting && (data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key)) {
            _children.push({
                _name: "icon",
                "class": "alert-circle InfoLink PaymentPending",
                "message": ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.msg
            });
        } else if (data.canceled && (data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.REJECTED.key)) {
            _children.push({
                _name: "icon",
                "class": "alert-circle InfoLink PaymentRejected",
                "message": ClassUtils.PAYMENT_AUTHORIZED_STATUS.REJECTED.msg
            });
        } else if (data.memberAgreementStatus == "REQUIRED_NOT_SIGNED") {
            _children.push({
                _name: "icon",
                "class": "alert-circle InfoLink RequiredNotSigned",
                "message": "A required agreement needs to be signed"
            });
        } else {
            if (data.memberAgreementStatus == "OPTIONAL_NOT_SIGNED") {
                _children.push({
                    _name: "icon",
                    "class": "alert-circle InfoLink OptionalNotSigned",
                    "message": "An optional agreement has not been signed"
                });
            }
        }
        _children.push({
            _name: "span",
            class: status,
            _text: status
        });
        return {
            _name: "hbox",
            _children: _children
        };
    });
    this.dataView.registerCustomRenderer("waiting", function(data, value) {
        return {
            _name: "span",
            _text: value ? "Yes" : "No"
        };
    });
    this.dataView.registerCustomRenderer("slot", function(data, value) {
        return {
            _name: "span",
            _text: "#" + (value + 1)
        };
    });
    this.dataView.registerCustomRenderer("reviewed", function(data, value) {
        var displayText = "Not Reviewed";
        if (value == 1) displayText = "Reviewed";
        return {
            _name: "span",
            _text: displayText
        }
    });
    this.dataView.registerCustomRenderer("calculatedAge", function(data, value) {
        var ageText = "";
        if (value > 0) {
            ageText = data.calculatedAgeText;
        }
        return {
            _name: "span",
            _text: ageText
        };
    });
    this.dataView.registerCustomRenderer("fee_reg_account_amt", function(data, value) {
        if (!data.paid) return "";
        var totalFee = data.addl_fee_amt + data.fee_class_amt + data.fee_reg_account_amt + data.fee_reg_mem_amt
                + data.fee_reg_year_account_amt + data.fee_reg_year_student_amt + data.fee_tax_amt;
        var discount = data.disc_mcl_amt + data.disc_mstd_amt + data.lesson_coupon_amt;
        return {
            _name: "span",
            _text: (!data.waiting && !data.canceled && totalFee - discount > 0) ? Util.toCurrency(totalFee - discount) : ""
        };
    });
    this.dataView.registerCustomRenderer("disc_mstd_amt", function(data, value) {
        var totalDiscount = data.disc_mcl_amt + data.disc_mstd_amt + data.lesson_coupon_amt;
        return {
            _name: "span",
            _text: (!data.waiting && !data.canceled && totalDiscount > 0) ? "-" + Util.toCurrency(totalDiscount) : ""
        };
    });
    this.dataView.registerCustomRenderer("addl_fee_amt", function(data, value) {
        var additionalCharged = data.addl_fee_amt - data.refund_addl_fee_amt;
        return {
            _name: "span",
            _text: (!data.waiting && !data.canceled && additionalCharged != 0) ? Util.toCurrency(additionalCharged) : ""
        };
    });
    this.dataView.registerCustomRenderer("dt_created", function(data, value) {
        return {
            _name: "span",
            _text: FormatUtil.formatDate(value, "date_standard", "local")
        }
    });

    this.dataView.registerCustomRenderer("start_drop_date_policy_drop_date", function(data, value) {
        var startDateStr = FormatUtil.formatDate(data.start_drop_date_policy_start_date, "date_standard", "local");
        var dropDateStr = FormatUtil.formatDate(data.start_drop_date_policy_drop_date, "date_standard", "local");
        return {
            _name: "vbox",
            class: "StartDropDateContainer",
            _children: (startDateStr.length == 0 && dropDateStr.length == 0) ? [] : [
                {
                    _name: "hbox",
                    class: "StartDropDatePolicy",
                    _children: [
                        {_name: "label", _text: "S:"},
                        {_name: "span", _text: startDateStr}
                    ]
                },
                {
                    _name: "hbox",
                    class: "StartDropDatePolicy",
                    _children: [
                        {_name: "label", _text: "D:"},
                        {_name: "span", _text: dropDateStr}
                    ]
                }
            ]
        }
    });
    this.dataView.registerCustomRenderer("agree1", function(data, value) {
        var agreements = [];
        if (data.agree1) agreements.push(data.agree1);
        if (data.agree2) agreements.push(data.agree2);
        if (data.agree3) agreements.push(data.agree3);
        if (data.agree4) agreements.push(data.agree4);
        if (data.agree5) agreements.push(data.agree5);
        return {
            _name: "span",
            _text: agreements.join(", ")
        };
    });

    this.dataView.registerCustomRenderer("agreements", function(data, value) {
        return {
            _name: "span",
            _text: value
        };
    });
    this.dataView.registerCustomRenderer("class_length_mins", function(data, value) {
        return {
            _name: "span",
            _text: data.classLengthName
        };
    });
    this.dataView.registerCustomRenderer("instructors", function(data, value) {
        return thiz.createInstructorTableHTML(data.instructors);
    })
    this.dataView.boot();
};

RegistrationReport.prototype.dataViewClickedHandler = function(data, fieldName, cell, event) {
    var thiz = this;
    var colInstructorList = Dom.findParentWithClass(event.target, "Col_instructors");
    if (colInstructorList) {
        thiz.showInstructorListClickHandler(event);
    }
    if (thiz.instructorListPopupShowing) return;

    var link = Dom.findParentWithClass(event.target, "InfoLink");
    if (!link) return;

    this._lastFocusedPaymentPlanLink = link;
    Dom.addClass(link, "Focused");

    if (Dom.hasClass(link, "MemberName")) {
        widget.__ensureNamespaceLoaded("ama", function (ama) {
            if (!thiz.canViewAccountMemberDetailDialog(ama)) return;

            new ama.MembersDetailDialog().callback(function(updated) {
                if (updated) thiz.dataView.refreshDataList();
            }).open({ids: [data.member_id]});
        }.bind(this));
    }
    if (Dom.hasClass(link, "AccountName")) {
        widget.__ensureNamespaceLoaded("ama", function (ama) {
            if (!thiz.canViewAccountMemberDetailDialog(ama)) return;

            var detailDialog = new ama.AccountsDetailDialog().callback(function(data) {
                thiz._registrationChanged = true;
                thiz.dataView.refreshDataList();
            });
            detailDialog.open({"ids": [data.account_id], fromWidget: "clpayplan.ClassEditRegistrationWidget"});
        }.bind(this));
    }
    if (Dom.hasClass(link, "ReceiptDetail")) {
        var options = {
            team: ADMIN_CONTEXT.teamAlias,
            accId: data.account_id,
            regIdx: data.reg_idx,
            lci_id: data.id,
            inv_idx: data.inv_idx
        };
        new ReceiptDetailDialog().open(options);
    }
    if (Dom.hasClass(link, "ClassTitle")) {
        if (!ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)) return;

        if (thiz.editClassClickedTimeout) window.clearTimeout(thiz.editClassClickedTimeout);
        thiz.editClassClickedTimeout = window.setTimeout(function () {
            thiz.openEditClassModal([data.class_id], "registrationTab", "ClassList");
        }, 200);
    }

    if (Dom.hasClass(link, "RequiredNotSigned") || Dom.hasClass(link, "OptionalNotSigned")) {
        widget.__ensureNamespaceLoaded("ama", function (ama) {
            if (!thiz.canViewAccountMemberDetailDialog(ama)) return;

            var detailDialog = new ama.AccountsDetailDialog().callback(function(data) {
                thiz._registrationChanged = true;
                thiz.dataView.refreshDataList();
            });
            detailDialog.open({"ids": [data.account_id], targetTab: "agreements"});
        }.bind(this));
    }
};
RegistrationReport.prototype.canViewAccountMemberDetailDialog = function (pkgAMA) {
    return pkgAMA.authutil.canViewLimitBasicAccountMemberInfo(window.LOGIN_INFO);
};
RegistrationReport.prototype.openEditClassModal = function (classIds, activeTab, from) {
    var thiz = this;
    thiz.classEditDialog = new ClassEditDialog();
    thiz.classEditDialog.callback(function(res) {
        console.log("# RegistrationReport - ClassEditDialog.responseData", res);
        thiz.saveClassCallback(res);
    }).open({ids: classIds, activeTab: activeTab, from: from});
};

RegistrationReport.prototype.saveClassCallback = function(data) {
    var thiz = this;

    if (data && data.success && data.classData) {
        if (data.classData.classDressCode) {
            data.classData.classDressCode.classId = res.id;
            thiz.saveClassDressCode(data.classData.classDressCode, function() {
                thiz.dataView.refreshDataList();
                Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
            })
            return;
        }
        thiz.dataView.refreshDataList();
    } else {
        if ((thiz.classEditDialog && thiz.classEditDialog.reloadOnClose) || (data && data.reloadOnClose)) {
            console.log("RELOAD CLASS LIST", data);
            thiz.dataView.refreshDataList();
            Dom.removeClass(thiz.containerWrapper, "ExpandDetail");
        }
    }

};

RegistrationReport.prototype.saveClassDressCode = function(classDressCode, callback) {
    widget.__ensureNamespaceLoaded("discountdance", function(namespace) {
        if (namespace) {
            namespace.util.saveClassDressCode(classDressCode, function(rs) {
                if (callback) callback(rs);
            });
            return;
        }
        if (callback) callback();
    });
};

RegistrationReport.prototype.sendEmail = function(regIds) {
    this.dataView.getSelectedItems(function(selectedData) {
        if (selectedData.length == 0) {
            return;
        }
        var ids = selectedData.map(function(reg) {return reg.account_id;});
        widget.__ensureNamespaceLoaded("util", function (util) {
            new util.CommunicationDialog().open({dataType: "account", ids: ids});
        }, "Loading...");
    });
};


RegistrationReport.prototype.printReport = function(regIds) {
    var thiz = this;
    this.dataView.getSelectedItems(function(result) {
        var data = result.map(function(d) {
            var startDateStr = FormatUtil.formatDate(d.start_drop_date_policy_start_date, "date_standard", "local");
            var dropDateStr = FormatUtil.formatDate(d.start_drop_date_policy_drop_date, "date_standard", "local");
            var totalFee = d.addl_fee_amt + d.fee_class_amt + d.fee_reg_account_amt + d.fee_reg_mem_amt
                    + d.fee_reg_year_account_amt + d.fee_reg_year_student_amt + d.fee_tax_amt;
            var discount = d.disc_mcl_amt + d.disc_mstd_amt + d.lesson_coupon_amt;
            var additionalCharged = d.addl_fee_amt - d.refund_addl_fee_amt;
            var ageText = "";
            if (d.calculatedAge > 0) {
                ageText = d.calculatedAgeText;
            }
            var instructorNames = [];
            d.instructors.forEach(function (instructor) {
                instructorNames.push(instructor.instructorName);
            });
            var displayReviewedText = "Not Review";
            if (d.reviewed == 1) displayReviewedText = "Reviewed";
            var reg = {
                name: d.name,
                account_name: d.account_name,
                ageText: ageText,
                sex: d.memberGender,
                dt_dob: FormatUtil.formatDate(d.dt_dob, "date_month_only", "server"),
                class_title: d.class_title,
                slot: "#" + (d.slot + 1),
                dt_created: FormatUtil.formatDate(d.dt_created, "date_standard", "local"),
                waiting: (d.waiting ? "Yes" : "No"),
                startDropDate: (startDateStr.length == 0 && dropDateStr.length == 0) ? "" : ("S: " + startDateStr + "\nD: " + dropDateStr),
                totalPaid: d.paid && (!d.waiting && !d.canceled && totalFee - discount > 0) ? Util.toCurrency(totalFee - discount) : "",
                totalDiscount: (!d.waiting && !d.canceled && discount > 0) ? "-" + Util.toCurrency(discount) : "",
                additionalCharged: (!d.waiting && !d.canceled && additionalCharged != 0) ? Util.toCurrency(additionalCharged) : "",
                payment_plan_name: d.reg_payment_plan_name,
                agreements: d.agreements? d.agreements : "",
                class_length_mins: d.classLengthName,
                ratePlanName: d.ratePlanName ? d.ratePlanName : "",
                instructorNames: instructorNames.join("\n"),
                reviewed: displayReviewedText
            };
            return reg;
        });
        var exportedData  = {
            data: data,
            generatedTime: FormatUtil.formatDate(new Date(), "datetime_standard", "local")
        };
        widget.__ensureNamespaceLoaded("print", function (print) {
            new print.PDFExportDialog().open({
                template: RegistrationReport.generateReportTemplate(thiz.dataView.savedView.columns),
                data: exportedData,
                jobName: "New Registrations Report"
            });
        });
    });
};

RegistrationReport.prototype.isFutureReg = function(data){
    var thiz = this;
    if (data.start_drop_date_policy_start_date && data.start_drop_date_policy_start_date > new Date()) return true;
    return false;
}

RegistrationReport.prototype.isDropDatePassed = function(data){
    var thiz = this;
    if (data.start_drop_date_policy_drop_date) {
        var d = new Date(data.start_drop_date_policy_drop_date);
        d.setDate(d.getDate() + 1);
        if (d < new Date()) return true;
    }
    return false;
}

RegistrationReport.generateReportTemplate = function(columns) {
    var columnMap = {
        account_name: {
            title: "Account",
            size: "*",
            fieldName: "name"
        },
        name: {
            title: "Member",
            size: "*",
            fieldName: "account_name"
        },
        calculatedAge: {
            title: "Age",
            size: 60,
            styles: {alignment: "right"},
            fieldName: "ageText"
        },
        dt_dob: {
            title: "Member DOB",
            size: 80,
            fieldName: "dt_dob"
        },
        sex: {
            title: "Gender",
            size: 60,
            fieldName: "sex"
        },
        class_title: {
            title: "Registered Class",
            size: 120,
            fieldName: "class_title"
        },
        slot: {
            title: "Slot",
            size: 30,
            styles: {alignment: "right"},
            fieldName: "slot"
        },
        dt_created: {
            title: "Date of Registration",
            size: 80,
            fieldName: "dt_created"
        },
        waiting: {
            title: "Waitlist",
            size: 40,
            fieldName: "waiting"
        },
        start_drop_date_policy_start_date: {
            title: "Start/Drop Date",
            size: 80,
            fieldName: "startDropDate"
        },
        fee_reg_account_amt: {
            title: "Total Paid",
            size: 60,
            styles: {alignment: "right"},
            fieldName: "totalPaid"
        },
        disc_mstd_amt: {
            title: "Discount",
            size: 60,
            styles: {alignment: "right"},
            fieldName: "totalDiscount"
        },
        addl_fee_amt: {
            title: "Additional Charged",
            size: 60,
            styles: {alignment: "right"},
            fieldName: "additionalCharged"
        },
        payment_plan_name: {
            title: "Registered Payment Plan",
            size: 80,
            fieldName: "reg_payment_plan_name"
        },
        agree1: {
            title: "Waiver",
            size: 120,
            fieldName: "agreements"
        },
        agreements: {
            title: "Agreements",
            size: 120,
            fieldName: "agreements"
        },
        class_length_mins: {
            title: "Class Length",
            size: 110,
            fieldName: "class_length_mins"
        },
        ratePlanName: {
            title: "Rate Plan",
            size: 120,
            fieldName: "ratePlanName"
        },
        instructors: {
            title: "Instructor",
            size: 120,
            fieldName: "instructorNames"
        },
        reviewed: {
            title: "Rviewed",
            size: 60,
            fieldName: "reviewed"
        }
    };
    var customColumns = columns.reduce(function(a, c) {
        var column = columnMap[c];
        if (!column) return a;
        a.column_sizes.push(column.size);
        a.column_titles.push(column.title);
        var field = {text: "${" + column.fieldName + "}"};
        if (column.styles) {
            Object.keys(column.styles).forEach(function(style) {
                field[style] = column.styles[style];
            });
        }
        a.column_fields.push(field);
        return a;
    }, {
        column_sizes: [],
        column_titles: [],
        column_fields: []
    });
    console.log("-- Custom Print Columns: ", customColumns);
    return {
        pageSize: 'A4',
        pageOrientation: 'landscape',
        pageMargins: [ 20, 40, 20, 20 ],
        "header": {
            text: "New Registrations Report",
            align: "left",
            style: "header"
        },
        "footer": {
            text: "Generated at ${generatedTime}",
            alignment: "left",
            style: "footer"
        },
        "content": [
            {
                style: "noBorderTable",
                "table": {
                    style: "tableAttendance",
                    "headerRows": 1,
                    dontBreakRows: true,
                    "widths": customColumns.column_sizes,
                    "body": [
                        customColumns.column_titles, {
                            $repeatOn: "data",
                            $itemTemplate: customColumns.column_fields
                        }
                    ]
                }
            }
        ],
        "styles": {
            "header": {
                "fontSize": 16,
                "bold": true,
                "margin": [ 20, 20, 20, 20 ]
            },
            "classMetaHeader": {
                "fontSize": 12,
                "bold": true,
                "margin": [2, 2, 2, 2]
            },
            "classMetaInfo": {
                "fontSize": 12,
                "margin": [2, 2, 2, 2]
            },
            "noBorderTable": {
                "margin": [0, 0, 0, 0]
            },
            "footer": {
                "fontSize": 8,
                "italics": true,
                "margin": [20, 0, 20, 0]
            }
        },
        "defaultStyle": {},
        images: {}
    }
};

RegistrationReport.prototype.sendAgreementReview = function (ids, editable) {
    var emailContentInfo = {
        subject: "Please Review Agreements on Your Account",
        message: ClassUtils.getAreementEmailContentTemaplate(ADMIN_CONTEXT.teamAlias, LOGIN_INFO.myAccountAgreementLink)
    };
    $waiverNotificationService.getReceipientInfosForAgreement("email", "account", ids, function (res) {
        if (res.recipients.length > 0) {
            if (editable) {
                widget.__ensureNamespaceLoaded("ama", function(ama) {
                    new ama.EmailMessageDialog(function(attachments, message, callback) {
                        $waiverNotificationService.sendAgreementReview("email", "account", ids, attachments, message, function(result) {
                            SnackBar.show("Email message sent.");
                            if (callback) callback();
                        }, function(e) {
                            ama.util.handleSendEmailError(e);
                        }, "Sending...");

                    }).open({title: "Send Agreement Review Reminder", info: res, contextTitle: "account", emailContentInfo: emailContentInfo});

                }.bind(this));
            } else {
                $waiverNotificationService.sendAgreementReview("email", "account", ids, [], emailContentInfo, function (result) {
                    SnackBar.show("Email message sent.");
                }, function(e) {
                    Dialog.error("Send email failed.");
                }, "Sending...");
            }
        } else {
            Dialog.error("There are no accounts that you selected with valid emails");
        }
    }, function(e){
    }, "Loading...");
};

RegistrationReport.prototype.showInstructorListClickHandler = function (event) {
    var colInstructor = Dom.findParentWithClass(event.target, "Col_instructors");
    if (!colInstructor) return;

    var instructorContentWrapper = colInstructor.getElementsByClassName("InstructorContentWrapper")[0];
    if (Dom.hasClass(event.target, "CloseInstructorListButton") || Dom.hasClass(event.target.parentNode, "CloseInstructorListButton")) {
        Dom.removeClass(instructorContentWrapper, "ShowInstructorList");
        event.stopPropagation();
        return;
    }
    if (Dom.hasClass(event.target, "SeeMore") || Dom.hasClass(event.target.parentNode, "SeeMore")) {
        if (this.instructorListPopupShowing) {
            this.instructorsPopup.hide();
            this.instructorListPopupShowing = false;
            event.stopPropagation();
            return;
        }
        this.instructorListPopupShowing = !this.instructorListPopupShowing;

        var target = Dom.hasClass(event.target, "SeeMore") ? event.target : event.target.parentNode;
        Dom.addClass(this.instructorListContent.parentNode.parentNode, "InstructorListPopupWrapper");
        var rowData = DataTable.getRowData(colInstructor);
        if (rowData && rowData.instructors && rowData.instructors.length > 0) {
            this.instructorListRepeater.setItems(rowData.instructors);
            this.instructorsPopup.show(target, "right-inside", "top", 2 * Util.em(), 5, true);
            this.instructorListPopupShowing = true;
            this.instructorListOpener = instructorContentWrapper;
        }
        event.stopPropagation();
        return;
    }

    Dom.addClass(instructorContentWrapper, "ShowInstructorList");
}

RegistrationReport.prototype.createInstructorTableHTML = function (instructors) {
    if (!instructors) return "";
    if (instructors.length == 0) return "";
    var instructorContentWrapper = document.createElement("div"),
        firstInstructorWrapper = document.createElement("div"),
        firstInstructorName = document.createElement("div");

    Dom.addClass(instructorContentWrapper, "InstructorContentWrapper");
    Dom.addClass(firstInstructorWrapper, "FirstInstructorWrapper");
    Dom.addClass(firstInstructorName, "FirstInstructorName");
    firstInstructorName.innerHTML = instructors[0].instructorName;
    firstInstructorName.title = instructors[0].instructorName;
    instructorContentWrapper.appendChild(firstInstructorWrapper);
    firstInstructorWrapper.appendChild(firstInstructorName);
    if (instructors.length > 1) {
        var bonus = document.createElement("div");
        Dom.addClass(bonus, "InstructorBonus");
        bonus.innerText = "(+" + (instructors.length - 1) + ")";
        firstInstructorWrapper.appendChild(bonus);
    }

    var instructorListWrapper = document.createElement("div"),
        instructorList = document.createElement("div"),
        instructorHeader = document.createElement("div"),
        instructorContent = document.createElement("div");
    Dom.addClass(instructorListWrapper, "InstructorListWrapper");
    Dom.addClass(instructorList, "InstructorList");
    Dom.addClass(instructorHeader, "InstructorHeader");
    Dom.addClass(instructorContent, "InstructorContent");

    //Class Name Col
    var headerTitle = document.createElement("div"),
        closeInstructorListButton = document.createElement("button"),
        closeInstructorListIcon = document.createElement("icon");
    headerTitle.innerHTML = "Instructor Name";
    Dom.addClass(closeInstructorListButton, "CloseInstructorListButton");
    closeInstructorListButton.setAttribute("type", "button");
    closeInstructorListButton.title = "Close instuctor list";
    Dom.addClass(closeInstructorListIcon, "minus");
    instructorHeader.appendChild(headerTitle);
    instructorHeader.appendChild(closeInstructorListButton);
    closeInstructorListButton.appendChild(closeInstructorListIcon);

    instructorList.appendChild(instructorHeader);
    instructorList.appendChild(instructorContent);
    instructorListWrapper.appendChild(instructorList);
    instructorContentWrapper.appendChild(instructorListWrapper);

    for (var i = 0; i < instructors.length; i ++) {
        var instructorItem = document.createElement("div");
        Dom.addClass(instructorItem, "InstructorItem");
        instructorItem.innerHTML = instructors[i].instructorName;
        instructorContent.appendChild(instructorItem);
    }

    var seeMoreWrapper = document.createElement("div"),
        seeMore = document.createElement("div"),
        spanText = document.createElement("span"),
        seeMoreIcon = document.createElement("icon");

    Dom.addClass(seeMoreWrapper, "SeeMoreWrapper");
    Dom.addClass(seeMore, "SeeMore");
    spanText.innerHTML = "See More";
    Dom.addClass(seeMoreIcon, "menu-right");
    seeMore.appendChild(spanText);
    seeMore.appendChild(seeMoreIcon);
    seeMoreWrapper.appendChild(seeMore);
    instructorListWrapper.appendChild(seeMoreWrapper);

    return instructorContentWrapper;
}

RegistrationReport.prototype.hideInstructorListButtonClickedHandler = function () {
    this.instructorsPopup.hide();
};

RegistrationReport.prototype.closeInstructorListButtonClickedHandler = function (event) {
    if (!this.instructorListOpener) return;
    Dom.removeClass(this.instructorListOpener, "ShowClassList");
    this.instructorListOpener = null;
    this.instructorsPopup.hide();
    event.stopPropagation();
};

RegistrationReport.prototype.updateReviewedStatus = function (ids, status) {
    var thiz = this;
    $classAdminService.updateReviewedStatus(ids, status, function (res) {
        thiz.dataView.refreshDataList();
    }, function (err) {

    }, "Saving...");
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ReportDialog.js";

function ReportDialog() {
    this.grabWidth = true;
    this.grabHeight = true;
    Dialog.call(this);
}

__extend(Dialog, ReportDialog);

ReportDialog.prototype.setup = function(options) {
    this.title = "Report";
    if(!ClassAuthUtils.canViewAtLeastReports(LOGIN_INFO)) {
        while(this.reportTypeTabPane.getTabs().length > 1){
            var tab = this.reportTypeTabPane.getTabs()[0];
            if(tab) this.reportTypeTabPane._removeTabByHeader(tab.header);
        }
    }
    if(!ClassAuthUtils.canViewHeatMapReport(LOGIN_INFO)) {
        var heatmap = this.reportTypeTabPane.getTabs()[this.reportTypeTabPane.getTabs().length - 1];
        if(heatmap) this.reportTypeTabPane._removeTabByHeader(heatmap.header);
    }
    if(!options) return;
    
};

ReportDialog.prototype.getDialogActions = function() {
    var actions = [
        {
            type: "cancel", title: "Close",
            order: 1,
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
    return actions;
};

ReportDialog.prototype.getInnerOffset = function () {
    return {
        w: 15 * Util.em(),
        h: 5 * Util.em()
    };
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ReportsWidget.js";

function ReportsWidget() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.navigationModule = this.reportTypeTabPane.getNavigationModule();

    this.DEFAULT_TAB_RENDERERS = {
        "RegistrationTabPane": function (thiz) {
            thiz.registrationTabContent.innerHTML = "";
            return new RegistrationReport().into(thiz.registrationTabContent);
        },
        "InstructorTabPane": function (thiz) {
            thiz.instructorTabContent.innerHTML = "";
            return new InstructorReport().into(thiz.instructorTabContent);
        }
    };

    this.bind("e:TabChange", function (e) {
        if (!thiz._initialized) return;
        thiz.renderActiveTabPane();
        e.stopPropagation();
    }, this.reportTypeTabPane.node());
}
__extend(BaseTemplatedWidget, ReportsWidget);

ReportsWidget.prototype.onAttached = function() {
    var thiz = this;
    var interval = 100;
    var f = function() {
        if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
            thiz.onAttachedDelayed();
            return;
        }
        console.log("CHECK LOGIN INFO");
        window.setTimeout(f, interval);
    };
    f();
};

ReportsWidget.prototype.onAttachedDelayed = function() {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
        this.validateReportTabs(window.LOGIN_INFO);
    } else {
        $classAdminService.getAccountInfo(function (res) {
            thiz.validateReportTabs(res);
        }, function (err) {});
    }
};

ReportsWidget.prototype.validateReportTabs = function(loginInfo) {
    var tabKeys = [];
    var canViewAllReports = ClassAuthUtils.canViewAllReports(loginInfo);
    if (canViewAllReports) {
        if (!loginInfo.allowClassPaymentPlan) {
            tabKeys.push("coa");
            tabKeys.push("trans");
        } else {
            // tabKeys.push("registrations");
        }
    }

    var canViewRegistrationReport = canViewAllReports || ClassAuthUtils.onlyViewRegistrationReportOfMyLocationClass(loginInfo);
    if (canViewRegistrationReport && loginInfo.allowClassPaymentPlan) tabKeys.push("registrations");

    if (ClassAuthUtils.canViewHeatMapReport(loginInfo)) {
        tabKeys.push("heatmap");
    }

    if (canViewAllReports && loginInfo.allowCostume) {
        tabKeys.push("autosizer");
        tabKeys.push("costumesdashboard");
        this._validateCostumeTabHeader(loginInfo);
    }
    if (loginInfo.isClassInstructor) {
        // tabKeys.push("report");
    }
    if (ClassAuthUtils.canViewInstructorReport(loginInfo) || ClassAuthUtils.onlyViewInstructorReportOfMyInstructorClass(loginInfo)) {
        tabKeys.push("instructors");
    }

    var i = 0;
    var activeTab = this.reportTypeTabPane.getActiveTabPane();
    while (i < this.reportTypeTabPane.getTabs().length) {
        var t = this.reportTypeTabPane.getTabs()[i];
        var k = t.header.getAttribute("tab-key");
        if (tabKeys.indexOf(k) == -1) {
            this.reportTypeTabPane.removeTabByContentNode(t.contentNode);
            continue;
        }
        i++;
    }
    if (!this.reportTypeTabPane.getActiveTabPane()) {
        this.reportTypeTabPane.setActiveTabPane(this.reportTypeTabPane.getTabs()[0]);
    }
    if (typeof(AdminConsole) == "undefined" || !this.findUpward(AdminConsole)) {
        CommonNavigation.setRoot(this.navigationModule);
    }
    
    this._initialized = true;
}

ReportsWidget.prototype.getNavigationModule = function () {
    return this.navigationModule;
};

ReportsWidget.prototype.renderActiveTabPane = function () {
    var activeTab = this.reportTypeTabPane.getActiveTabPane();
    if(!activeTab) return;
    for(var tab in this.DEFAULT_TAB_RENDERERS){
        if(Dom.hasClass(activeTab, tab)){
            this.tabToChange = tab;
            this.moveToTab(tab, activeTab);
            return;
        }
    }
    if (Dom.hasClass(activeTab, "AutoSizerTabPane") || Dom.hasClass(activeTab, "CostumesDashboardTabPane")) {
        var thiz = this;
        widget.__ensureNamespaceLoaded("costume", function (ns) {
            if (Dom.hasClass(activeTab, "AutoSizerTabPane")) {
                thiz.autosizerTabContent.innerHTML = "";
                var costumeOrderingReport = new ns.CostumeOrderingReportWidget().into(thiz.autosizerTabContent);
            } else {
                thiz.costumesDashboardTabContent.innerHTML = "";
                new ns.CostumeDashboardReportWidget({}).into(thiz.costumesDashboardTabContent);
            }
        });
    }
};

ReportsWidget.prototype.moveToTab = function(tab, activeTab) {
    var thiz = this;
    if (!tab || !this.DEFAULT_TAB_RENDERERS[tab]) tab = "RegistrationTabPane";
    var f = this.DEFAULT_TAB_RENDERERS[tab];
    var widgetComponent = f(this);
    if (widgetComponent.getNavigationModule) {
        activeTab[TabPane.KEY_NAVIGATION_MODULE] = widgetComponent.getNavigationModule();
    }
};

ReportsWidget.prototype._validateCostumeTabHeader = function(loginInfo) {
    this.reportTypeTabPane.setTabTitleByName("costumesdashboard",  String.format("{0} Dashboard", loginInfo.costumeModuleName || "Costumes"));
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/SelectAccountDialog.js";

function SelectAccountDialog () {
    Dialog.call(this);
    this.grabHeight = true;
    this.grabWidth = true;
    this.title = "Select Accounts";
    this.dataView.registerCustomRenderer("email_valid", function (data, value) {
        var valid = data.hasValidEmail ? "<icon class='check'></icon>" : "<icon class='close'></icon>";
        return { _name: "hbox",
        _children: [
            {_name: "span", _html: valid}
        ]};
    });
    this.dataView.registerCustomRenderer("classMembership", function (data, value) {
        return this.createClassTableHtml(data.classes);
    }.bind(this));
    this.bind("p:PageLoaded", function () {
        this.summaryLabel.innerHTML = String.format("<span style=\"color: #469ADB;font-size: 1.5em;\">{0} </span> ACCOUNT(S)", this.dataView.getDiscoveredTotalItems());
    }, this.dataView);
    this.dataView.setDefaultSelectionHandler(function(data, fieldName, cell, event) {
        var colClassMembership = Dom.findParentWithClass(event.target, "Col_classMembership");
        if (colClassMembership) {
            this.showClassListButtonClickedHandler(event);
            return;
        }
    }.bind(this));
    this.bind("p:PopupHidden", function() {
        window.setTimeout(function() {
            this.classListPopupShowing = false;
        }.bind(this), 200);
    }, this.classListPopup.node());

    this.bind("click", this.hideClassListButtonClickedHandler, this.hideClassListButton);
    this.bind("click", this.closeClassListButtonClickedHandler, this.closeClassListButton);

    this.classListRepeater.populator = function (data, binding, node) {
        binding.className.innerHTML = data.className + " | " + data.slotName;
        binding.progName.innerHTML = data.programName;
        binding.subProgName.innerHTML = data.subProgramName;
        binding.sessionName.innerHTML = data.sessionName ? data.sessionName : "";
        binding.locationName.innerHTML = data.classLocationName;
        binding.classFee.innerHTML = ClassUtils.toCurrency(data.classFee);
    };
}
__extend(Dialog, SelectAccountDialog);

SelectAccountDialog.prototype.hideClassListButtonClickedHandler = function () {
    this.classListPopup.hide();
};

SelectAccountDialog.prototype.closeClassListButtonClickedHandler = function (event) {
    if (!this.classListOpener) return;
    Dom.removeClass(this.classListOpener, "ShowClassList");
    this.classListOpener = null;
    this.classListPopup.hide();
    event.stopPropagation();
};

SelectAccountDialog.prototype.showClassListButtonClickedHandler = function (event) {
    var colClassMembership = Dom.findParentWithClass(event.target, "Col_classMembership");
    if (!colClassMembership) return;

    var classContentWrapper = colClassMembership.getElementsByClassName("ClassContentWrapper")[0];
    if (Dom.hasClass(event.target, "CloseClassListButton") || Dom.hasClass(event.target.parentNode, "CloseClassListButton")) {
        Dom.removeClass(classContentWrapper, "ShowClassList");
        event.stopPropagation();
        return;
    }
    if (Dom.hasClass(event.target, "SeeMore") || Dom.hasClass(event.target.parentNode, "SeeMore")) {
        if (this.classListPopupShowing) {
            this.classListPopup.hide();
            this.classListPopupShowing = false;
            event.stopPropagation();
            return;
        }
        this.classListPopupShowing = !this.classListPopupShowing;
        var target = Dom.hasClass(event.target, "SeeMore") ? event.target : event.target.parentNode;
        Dom.addClass(this.classListContent.parentNode.parentNode, "ClassListPopupWrapper");
        var rowData = DataTable.getRowData(colClassMembership);
        if (rowData && rowData.classes && rowData.classes.length > 0) {
            this.classListRepeater.setItems(rowData.classes);
            this.classListPopup.show(target, "right-inside", "top", 2 * Util.em(), 5, true);
            this.classListPopupShowing = true;
            this.classListOpener = classContentWrapper;
            if (rowData.allowPaymentPlan) {
                Dom.addClass(this.classListContent.parentNode.parentNode, "AllowPaymentPlan");
            } else {
                Dom.removeClass(this.classListContent.parentNode.parentNode, "AllowPaymentPlan");
            }
        }
        event.stopPropagation();
        return;
    }
    Dom.addClass(classContentWrapper, "ShowClassList");
};

SelectAccountDialog.prototype.createClassTableHtml = function (classes) {
    if (!classes) return "";
    if (classes.length == 0) return "";
    
    var classContentWrapper = document.createElement("div"),
        firstClassWrapper = document.createElement("div"),
        firstClassName = document.createElement("div");
        
    Dom.addClass(classContentWrapper, "ClassContentWrapper");
    Dom.addClass(firstClassWrapper, "FirstClassWrapper");
    Dom.addClass(firstClassName, "FirstClassName");
    firstClassName.innerHTML = classes[0].className + " | " + classes[0].slotName;
    firstClassName.title = classes[0].className + " | " + classes[0].slotName;
    classContentWrapper.appendChild(firstClassWrapper);
    firstClassWrapper.appendChild(firstClassName);
    if (classes.length > 1) {
        var classBonus = document.createElement("div");
        Dom.addClass(classBonus, "ClassBonus");
        classBonus.innerText = "(+" + (classes.length - 1) + ")";
        firstClassWrapper.appendChild(classBonus);
    }
    
    var classListWrapper = document.createElement("div"),
        classList = document.createElement("div"),
        classHeader = document.createElement("div"),
        classContent = document.createElement("div");
    Dom.addClass(classListWrapper, "ClassListWrapper");
    Dom.addClass(classList, "ClassList");
    Dom.addClass(classHeader, "ClassHeader");
    Dom.addClass(classContent, "ClassContent");
    
    //Class Name Col 
    var headerTitle = document.createElement("div"),
        closeClassListButton = document.createElement("button"),
        closeClassListIcon = document.createElement("icon");
    headerTitle.innerHTML = "Class Name";
    Dom.addClass(closeClassListButton, "CloseClassListButton");
    closeClassListButton.setAttribute("type", "button");
    closeClassListButton.title = "Close class list";
    Dom.addClass(closeClassListIcon, "minus");
    classHeader.appendChild(headerTitle);
    classHeader.appendChild(closeClassListButton);
    closeClassListButton.appendChild(closeClassListIcon);
    
    classList.appendChild(classHeader);
    classList.appendChild(classContent);
    classListWrapper.appendChild(classList);
    classContentWrapper.appendChild(classListWrapper);
    
    //Class List Content
    for (var i = 0; i < classes.length; i ++) {
        var classItem = document.createElement("div");
        Dom.addClass(classItem, "ClassItem");
        classItem.innerHTML = classes[i].className + " | " + classes[i].slotName;        
        classContent.appendChild(classItem);
    }
    
    var seeMoreWrapper = document.createElement("div"),
        seeMore = document.createElement("div"),
        spanText = document.createElement("span"),
        seeMoreIcon = document.createElement("icon");
    
    Dom.addClass(seeMoreWrapper, "SeeMoreWrapper");    
    Dom.addClass(seeMore, "SeeMore");
    spanText.innerHTML = "See More";
    Dom.addClass(seeMoreIcon, "menu-right");
    seeMore.appendChild(spanText);
    seeMore.appendChild(seeMoreIcon);
    seeMoreWrapper.appendChild(seeMore);
    classListWrapper.appendChild(seeMoreWrapper);
    
    return classContentWrapper;
};

SelectAccountDialog.prototype.setup = function(options) {
    this.selectedItems = options.selectedItems || [];
    this.titleShare.innerHTML = "Select Accounts to Share Your " + options.typeShare;
    // this.dataView.addEventListener("p:SelectionChanged", function (event) {
    //     if (event.detail && event.detail.item) {
    //         if (event.detail.checked) {
    //             this.selectedItems.push(event.detail.item);
    //         } else {
    //             this.selectedItems = this.selectedItems.filter(item => item.id != event.detail.item.id);
    //         }
    //     }
    // }.bind(this), false);
    // this.dataView.addEventListener("p:PageLoaded", function (event) {
    //     this.dataView.dataTable.selectItems(this.selectedItems, true);
    // }.bind(this), false);
    this.dataView.boot();
};

SelectAccountDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Cancel",
            run: function () {
                thiz.close();
            }
        },
        {
            type: "accept", title: "Select",
            run: function () {
                thiz.dataView.getSelectedItems(function (result) {
                    // var ids = new Set(selected.map(item => item.id));
                    // var result = [...selected, ...thiz.selectedItems.filter(item => !ids.has(item.id))];
                    if (!result.length) {
                        Dialog.error("No account is selected. Please select at least one account.");
                        return;
                    }
                    thiz.close(result);
                });
            }
        }
    ]
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/SelectClassForFeedDialog.js";

function SelectClassForFeedDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    var thiz = this;

    this.bind("p:PageLoaded", function(e) {
        if(!e.detail) return;
        if(e.detail.totalItems > 1) {
            thiz.totalClassCountInit.innerHTML = "Classes";
        } else {
            thiz.totalClassCountInit.innerHTML = "Class";
        }
        thiz.totalClassCount.innerHTML = e.detail.totalItems;

        if (!thiz.pageLoaded) {
            if (thiz.options && thiz.options.selectedClasses && thiz.options.selectedClasses.length > 0) {
                thiz.dataView.dataTable.selectItems(thiz.options.selectedClasses, true);
            } else {
                thiz.dataView.dataTable.selectAll();
            }
            thiz.pageLoaded = true;
        } else {
            thiz.dataView.dataTable.selectItems([], true);
        }

    }, this.dataView.node());

    this.bind("p:SelectionChanged", function () {
        thiz.invalidateElements();
    }, this.dataView.node());

}

__extend(Dialog, SelectClassForFeedDialog);

SelectClassForFeedDialog.prototype.asyncSetup = function (options, dialogCallback) {
    this.options = options;
    this.title = "Select Class";
    this.dataView.registerCustomRenderer("title", function (data, value) {
        return {
            _name: "div",
            _children: [
                {
                    _name: "span",
                    flex: 1,
                    "class": "class-title",
                    _html: value,
                    title: value
                }
            ]
        }
    });
    this.dataView.registerCustomRenderer("prog_name", function (data, value) {
        return {
            _name: "div",
            _children: [
                {
                    _name: "span",
                    flex: 1,
                    _html: value,
                    title: value
                }
            ]
        }
    });
    this.dataView.registerCustomRenderer("subprog_name", function (data, value) {
        return {
            _name: "div",
            _children: [
                {
                    _name: "span",
                    flex: 1,
                    _html: value,
                    title: value
                }
            ]
        }
    });

    this.dataView.registerCustomRenderer("date_start", function (data, value) {
        var _html = "";
        if (data.date_start) _html += FormatUtil.formatDate(data.date_start, "date_standard", "local");
        if (data.date_end) {
            _html += " - ";
            _html += FormatUtil.formatDate(data.date_end, "date_standard", "local");
        }
        return {
            _name: "div",
            _html: _html
        }
    });

    dialogCallback();
};

SelectClassForFeedDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: thiz.getSelectActionTitle(),
            isApplicable: function () {
                if (thiz.dataView.isSelectAllMarked()) return true;
                var selectedItems = thiz.dataView.getSelectedItems();
                return selectedItems && selectedItems.length > 0;
            },
            run: function () {
                thiz.dataView.getSelectedItems(function (selectedItems) {
                    console.log("selectedItems", selectedItems);
                    thiz.close(selectedItems);
                });
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                return true;
            }
        }
    ];
    return actions;
};

SelectClassForFeedDialog.prototype.getSelectActionTitle = function() {
    var selectedItems = this.dataView.getSelectedItems();
    if (selectedItems && selectedItems.length > 0) {
        return "Select [" + selectedItems.length + "]";
    }
    return "Select";
};

SelectClassForFeedDialog.prototype.shouldShowUnapplicableButtons = function () {
    return true;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ShareClassDialog.js";

function ShareClassDialog () {
    Dialog.call(this);
    this.bind("click", this.copyClipboardLinkHandler, this.copyClipboardLink);
    this.bind("click", this.sendEmailHandler, this.sendEmail);
    this.bind("click", this.getInformationFacebook, this.shareFacebook);
    this.bind("click", this.getInformationGoogle, this.shareGoogle);
}
__extend(Dialog, ShareClassDialog);

ShareClassDialog.prototype.asyncSetup = function(options, postSetupAction) {
    if (!options) return;
    this.typeShare = options.type;
    this.data = options.data;
    this.name = options.name;
    this.title = "Share " + this.typeShare;
    this.subjectLinkInput.value = options.name;
    this.notesInput.addEventListener("input", function() {
        var counter = this.notesInput.value.length;
        this.countCharacter.innerHTML = "<b><span style=\"color: " + (counter > 0 ? "black" : "gray") + "\">" 
            + counter + "</span>/250</b> Characters Max.";
    }.bind(this));
    var source = function (term, callback) {
        new SelectAccountDialog().callback(function(accounts) {
            if (accounts) {
                this.updateCountAccount(accounts.length);
            }
            this.accountSelection.setItems(accounts || this.accountSelection.getItems());
        }.bind(this)).open({typeShare: this.typeShare, selectedItems: this.accountSelection.getItems() || []});
    }.bind(this);
    var renderer = function (account) {
        return account.last_name + ", " + account.first_name;
    };
    this.accountSelection.setup(source, renderer);
    this.accountSelection.addEventListener("p:ValueChanged", function (event) {
        this.updateCountAccount(this.accountSelection.getItems().length);
    }.bind(this), false);
    this.setupMoreRecipients();
    Dom.toggleClass(this.shareTargetContainer, "SharableViaEmail", this._canShareViaEmail());
    
    var showDialog = function (active) {
        if (!active) Dom.hide(this.shareGoogle);
        postSetupAction();
    }.bind(this);
    $businessPublisherService.isBPITeamActive(function (active) {
        showDialog(active);
    }, function (error) {
        console.log("ShareClassDialog isBPITeamActive: " + error);
        showDialog(false);
    });
};

ShareClassDialog.prototype._canShareViaEmail = function () {
    return ClassAuthUtils.canEmailSMSPushAccountMember(window.LOGIN_INFO)
        && PermissionUtils.isAccountWithAllPermissions(window.LOGIN_INFO, PERMISSION_KEY.AMA_AccountMember_ViewBasicList);
}

ShareClassDialog.prototype.updateCountAccount = function (count) {
    this.countAccount.innerHTML = "<b><span style=\"color: " + (count > 0 ? "black" : "gray") + "\">" + count + "</span></b> Account" + (count > 1 ? "s" : "");
};

ShareClassDialog.prototype.getExtraReceipients = function (validate) {
    var extraReceipients = this.moreRecipients.getItems() || [];
    var extraEmail = this.moreRecipients.autoCompleteInput.node().value.trim();
    if (extraEmail.length > 0 && (!validate || extraEmail.match(ValidationManager.patterns.EMAIL_REGEX))) {
        extraReceipients.push(extraEmail);
    }
    return extraReceipients;
};

ShareClassDialog.prototype.setupMoreRecipients = function () {
    this.domains = ["com", "net", "org"];
    if (window.LOCALE) {
        this.domains.push(
            window.LOCALE.language == "en-US" ? "us" :
            window.LOCALE.language == "en-AU" ? "au" : "uk");
    }
    var thiz = this;
    var source = function (term, callback) {
        if (!term || term.length == 0) {
            callback([]);
            return;
        }
        var items = [];
        var p = term.indexOf("@");
        var d = term.lastIndexOf(".");

        if (term.match(ValidationManager.patterns.EMAIL_REGEX)) {
            items.push(term);
        }
        if (p > 0 && d > p && d == term.length - 1) {
            for (var i = 0; i < thiz.domains.length; i++) {
                items.push(term + thiz.domains[i]);
            };
        }
        callback(items);
    };
    var renderer = function (email) {
        return email;
    };
    this.moreRecipients.isSelectItemEvent = function(event) {
        return event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN || event.keyCode == DOM_VK_SPACE
            || event.keyCode == DOM_VK_COMMA;
    };

    this.moreRecipients.externalDataParser = function (input, callback) {
        input = ("" + (input || "")).trim();
        if (!input) {
            callback([], "");
            return;
        }
        var emails = [];
        var m = null;
        var re = /(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/g;
        do {
            m = re.exec(input);
            if (m) {
                emails.push(m[0]);
            }
        } while (m && emails.length < 100);

        if (emails.length > 0) {
            callback(emails, "");
        } else {
            callback([], input);
        }
    };
    this.moreRecipients.setup(source, renderer);
};

ShareClassDialog.prototype.getLinkShare = function (isPlainText) {
    var shoppingCartEnable = AdminConsole.instance.isTeamFeatureModuleEnable("shoppingcart");
    var linkShare = window.location.origin;
    var param = "";
    Object.getOwnPropertyNames(this.data).forEach(function(property) {
        param += (property + "=" + this.data[property]);
        param += "&"
    }.bind(this));
    param = param.slice(0, -1);
    var body = document.getElementsByTagName("body")[0];
    if (shoppingCartEnable) {
        linkShare += window.LOGIN_INFO.classRegShoppingLink + "?" + param;
    } else {
        // if (body && Dom.hasClass(body, "ClassicLayout")) {
        //     linkShare += "ClassReg.jsp?team=" + TEAM_INFO.alias + "&" + param;
        // } else {
        linkShare += window.LOGIN_INFO.classRegistrationLink + "?" + param;
        // }
    }
    if (isPlainText) return linkShare;
    return "<a href=\"" + linkShare + "\" target=\"_blank\">Click here</a> to view the " + this.typeShare.toLowerCase() + " <b>" + this.name + "</b>!";    
};

ShareClassDialog.prototype.copyClipboardLinkHandler = function () {
    var linkShare = this.getLinkShare(true);
    var node = Dom.newDOMElement({
        _name: "input",
        value: linkShare,
        position: -99999
    });
    document.body.appendChild(node);
    node.select();
    var success = document.execCommand("copy");
    document.body.removeChild(node);
    var snackBar = SnackBar.show(success ? "Link Copied to Clipboard!" : "Copy Link was unsuccessfully", null, null, success ? null : "close-box", linkShare);
    Dom.addClass(snackBar.node(), "CustomSnackBar");
    snackBar.node().style.left = Math.round((document.body.offsetWidth - snackBar.node().offsetWidth) / 2) + "px";
};

ShareClassDialog.prototype.getRuleSet = function () {
    var ruleSet = new RuleSet().live(true).rule(new GenericRule(this.accountSelection, function () {
        return this.accountSelection.getItems().length > 0;
    }.bind(this), "Please select accounts."));
    ruleSet.required(this.subjectLinkInput, "Please enter email subject.");
    ruleSet.required(this.notesInput, "Please enter notes.");
    var emailValidationContext = {};
    ruleSet.custom(new GenericRule(this.moreRecipients.autoCompleteInput.node(),
                function() {
                    var extraReceipients = this.getExtraReceipients();
                    emailValidationContext.addresses = [];
                    extraReceipients.forEach(function (email) {
                        if (email && !email.match(ValidationManager.patterns.EMAIL_REGEX)) {
                            emailValidationContext.addresses.push(email);
                        }
                    });

                    return emailValidationContext.addresses.length == 0;
                }.bind(this),
                function () {
                    return "Invalid email address: " + emailValidationContext.addresses.join(", ");
                }));
    return ruleSet;
}

ShareClassDialog.prototype.sendEmailHandler = function () {
    if (!ValidationManager.run(this.getRuleSet())) return;
    var accounts = this.accountSelection.getItems();
    var ids = [];
    accounts.forEach(function(account) {
        ids.push(account.id);
    });
    var message = {
        extraReceipients: this.getExtraReceipients(true),
        subject: this.subjectLinkInput.value.trim(),
        message: this.notesInput.value.trim() + "<br/>" + this.getLinkShare()
    };
    var thiz = this;
    $emailService.sendMessage("email", "account", ids, null, message, function(result) {
        var snackBar = SnackBar.show("Email Sent to Selected Accounts!");
        Dom.addClass(snackBar.node(), "CustomSnackBar");
        snackBar.node().style.left = Math.round((document.body.offsetWidth - snackBar.node().offsetWidth) / 2) + "px";
        thiz.close();
    }, function(e) {
        widget.__ensureNamespaceLoaded("ama", function(ama) {
            ama.util.handleSendEmailError(e);
        });
    }, "Sending...");
};

/*ShareClassDialog.prototype.send3RdEmailHandler = function () {
    var accounts = this.accountSelection.getItems();
    var emails = [];
    accounts.forEach(function(account) {
        emails.push(account.email);
    });
    var sendto = emails.join(", ");
    var subject = this.subjectLinkInput.value.trim();
    var message = this.notesInput.value.trim();
    var args = [];
    if (subject) {
        args.push('subject=' + encodeURIComponent(subject));
    }
    if (message) {
        args.push('body=' + encodeURIComponent(message))
    }
    var url = 'mailto:' + encodeURIComponent(sendto);
    if (args.length > 0) {
        url += '?' + args.join('&');
    }
    window.open(url, '_self');
};*/

ShareClassDialog.prototype.getInformationGoogle = function () {
    var title = "Share " + this.typeShare + " to Google My Business";
    this.getInformationSocial("GOOGLE", title, function(result) {
        return result && result.googlePublishingTargets && result.googlePublishingTargets.length > 0;
    }, function () {
        this.googleNoConnect(title);
    }.bind(this), function(result) {
        var obj = {
            result: result.googlePublishingTargets
        }
        return obj;
    });
};

ShareClassDialog.prototype.getInformationFacebook = function () {
    var title = "Share " + this.typeShare + " to Facebook";
    this.getInformationSocial("FACEBOOK", title, function(result) {
        return result && ((result.faceBookPublishingTargets && result.faceBookPublishingTargets.length > 0) || 
                (result.socialAccountId && result.extraData));
    }, function () {
        this.facebookNoConnect(title);
    }.bind(this), function(result) {
        var obj = {};
        if (result.faceBookPublishingTargets) {
            result.faceBookPublishingTargets.forEach(function(item) {
                item.name = "@" + item.name;
            });
            obj.result = result.faceBookPublishingTargets;
        }
        if (result.socialAccountId && result.extraData && result.extraData.pageId) {
            obj.extra = {
                accountId: result.socialAccountId,
                accountName: result.socialAccountName,
                accessToken: result.token,
                pageId: result.extraData.pageId,
                pageName: "@" + result.extraData.pageName
            };
        }
        return obj;
    });
};

ShareClassDialog.prototype.getInformationSocial = function (typeSocial, title, condition, onFail, convertResult) {
    $classAdminService.getSocial(typeSocial, function(result) {
        if (condition(result)) {
            var reloadFb = function() {
                this.getInformationFacebook();
            }.bind(this);
            new ShareSocialDialog().open({typeShare: this.typeShare, typeSocial: typeSocial, title: title, name: this.name, 
                data: convertResult(result), link: this.getLinkShare(true), reloadFb: reloadFb});
        } else {
            onFail();
        }
    }.bind(this), function(error) {
        console.error("Fail to get information social: ", error);
    });
};

ShareClassDialog.prototype.facebookNoConnect = function(title) {
    var message = "You need to connect to your Facebook account to be able to share your " + this.typeShare.toLowerCase() + ".";
    var extraMessage = "We'll never post anything without your permission.";
    var builder = {
        title: title,
        size: "normal",
        buildContent: function (container) {
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Warning",
                _children: [
                    {
                        _name: "vbox", flex: 1,
                        _children: [
                            { _name: "div", style: "font-size: 1.05em;font-weight: 400;", _html: message},
                            { _name: "div", style: "font-size: 0.9em;color: gray;margin-top: 0.5em;", _html: extraMessage}
                        ]
                    }
                ]
            }));
        }
    };
    var thiz = this;
    var dlg = new BuilderBasedDialog(builder);
    Dom.addClass(dlg.dialogFooter, "FacebookConnectFooter");
    dlg.getDialogActions = function() {
        return [{
            title: "Connect",
            order: 1,
            type: "accept",
            icon: "facebook-box",
            run: function () {
                this.close();
                thiz.showDialogFacebook();
            }
        },
        {
            title: "Not Now",
            order: 2,
            type: "cancel",
            isCloseHandler: true,
            run: function () {
                this.close();
            }
        }];
    };
    dlg.open();
};

ShareClassDialog.prototype.showDialogFacebook = function() {
    var thiz = this;
    widget.__ensureNamespaceLoaded('util', function(util) {
        util.FacebookProvider.login(function(res) {
            thiz.getInformationFacebook();
        });
    });
};

ShareClassDialog.prototype.googleNoConnect = function(title) {
    var message = "You need to connect your SportsEngine Motion account with Google account that associated with your Google My Business locations to be able to share your " + this.typeShare.toLowerCase() + "." +
                "<br/><br/> If you need to connect and setup your account and locations, visit:" +
                "<br/><strong>\"Business Publisher > Manage Account & Locations > Google Accounts\"</strong>";
    var builder = {
        title: title,
        size: "normal",
        buildContent: function (container) {
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Warning",
                _children: [
                    { _name: "icon", "class": "alert" , "style": "color: darkorange;"},
                    {
                        _name: "vbox", flex: 1, "class": "Messages",
                        _children: [
                            { _name: "div", "style": "font-size: 0.95em;", _html: message}
                        ]
                    }
                ]
            }));
        },
        actions: [{
            title: "OK",
            primary: true,
            run: function () {
                this._dialog.quit();
                return true;
            }
        }]
    };
    new BuilderBasedDialog(builder).open();
};

ShareClassDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [{
        type: "cancel", title: "Close",
        run: function () {
            thiz.close();
        }
    }];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ShareSocialDialog.js";

function ShareSocialDialog() {
    Dialog.call(this);
}
__extend(Dialog, ShareSocialDialog);

ShareSocialDialog.prototype.setup = function(options) {
    if (!options) return;
    this.title = options.title;
    this.data = options.data;
    this.name = options.name;
    this.typeSocial = options.typeSocial;
    this.typeShare = options.typeShare;
    this.link = options.link;
    this.reloadFb = options.reloadFb;
    Dom.addClass(this.socialLogo, options.typeSocial);
    Dom.addClass(this.notesGoogle, options.typeSocial);
    this.socialLabel.innerHTML = options.typeSocial.toLowerCase();
    this.socialShare.innerHTML = "Select " + (options.typeSocial == "FACEBOOK" ? "pages" : "locations") + " you want to share this " + options.typeShare.toLowerCase() + " to:";
    if (this.data.extra) {
        var linkPage = "https://www.facebook.com/" + this.data.extra.pageId;
        var node = Dom.newDOMElement({
            _name: "hbox", "class": "Item",
            _children: [
                {_name: "input", id: this.data.extra.pageId, type: "checkbox"},
                {_name: "a", "href": linkPage, "target": "_blank",_children: [{_name: "label", _text: this.data.extra.pageName}]},
                {_name: "div", flex: 1},
                {_name: "a", class:"FacebookSettings", _children: [{_name: "icon", class: "settings", _children: [{_name: "span", _text: "Settings"}]}]
                }
            ]
        });
        this.listItems.appendChild(node);
        Dom.findChildWithClass(node, "FacebookSettings").addEventListener("click", function() {
            this.facebookSettingsHandler();
        }.bind(this));
    }
    if (this.data.result) {
        this.data.result.forEach(function(item) {
            var node = Dom.newDOMElement({
                _name: "hbox", "class": "Item", "_data" : item,
                _children: [
                    {_name: "input", id: item.id, type: "checkbox"},
                    {_name: "label", _text: item.name, for: item.id}
                ]
            });
            this.listItems.appendChild(node);
        }.bind(this));
    }
    if (this.listItems.childElementCount == 1) {
        Dom.addClass(this.listItems, "OneItem");
        Dom.hide(this.socialShare);
        this.listItems.childNodes[0].childNodes[0].checked = true;
    }
    Dom.doOnSelector(this.listItems, "input", function (node) {
        node.addEventListener("change", function () {
            this.invalidateElements();
        }.bind(this));
    }.bind(this));
    this.notesInput.addEventListener("input", function() {
        var counter = this.notesInput.value.length;
        this.countCharacter.innerHTML = "<b><span style=\"color: " + (counter > 0 ? "black" : "gray") + "\">" 
            + counter + "</span>/250</b> Characters Max.";
    }.bind(this));
};

ShareSocialDialog.prototype.getLinkShare = function () {
    return "\nClick " + this.link + " to view the " + this.typeShare.toLowerCase() + " \"" + this.name + "\".";
};

ShareSocialDialog.prototype.share = function () {
    var ruleSet = new RuleSet().live(true).required(this.notesInput, "Please enter notes.");
    if (!ValidationManager.run(ruleSet)) return;
    var param = {
        tokenType: this.typeSocial,
        publishingTargetIds: [],
        sharePersonalPage: false,
        note: this.notesInput.value.trim() + this.getLinkShare(),
        link: ""
    };
    var items = this.listItems.querySelectorAll(":checked");
    items.forEach(function(item) {
        if (this.data.extra && this.data.extra.pageId && this.data.extra.pageId == item.id) {
            param.sharePersonalPage = true;
        } else {
            param.publishingTargetIds.push(item.id);
        }
    }.bind(this));
    
    $classAdminService.shareSocial(param, function(result) {
        if (this.typeSocial == "GOOGLE") {
            this.showDlgSuccessShareGG();
        } else {
            SnackBar.show("Share success.");
        }
        this.close();
    }.bind(this), function(error) {
        console.error("Fail to share social: ", error);
    }, "Sharing...");
};

ShareSocialDialog.prototype.showDlgSuccessShareGG = function () {
    var message = "Your " + this.typeShare.toLowerCase() + " has been shared and posted to Google.<br>Post can take several hours to appear on Google.";
    var builder = {
        title: this.title,
        size: "normal",
        buildContent: function (container) {
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Warning",
                _children: [
                    { _name: "icon", "class": "check-circle" , "style": "color: #84C55F; opacity: 1"},
                    {
                        _name: "vbox", flex: 1, "class": "Messages",
                        _children: [
                            { _name: "div", _html: message}
                        ]
                    }
                ]
            }));
        },
        actions: [{
            title: "OK",
            primary: true,
            run: function () {
                this._dialog.quit();
                return true;
            }
        }]
    };
    new BuilderBasedDialog(builder).open();
};

ShareSocialDialog.prototype.facebookSettingsHandler = function () {
    var thiz = this;
    widget.__ensureNamespaceLoaded('util', function(util) {
        util.FacebookProvider.settings(function(res) {
            thiz.close();
            thiz.reloadFb();
        }, function() {
            thiz.close();
        });
    });
};

ShareSocialDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Share",
            isEnabled: function () {
                return this.listItems.querySelectorAll(":checked").length > 0;
            }.bind(this), 
            run: function () { this.share(); return false; }
        }
    ]
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/StartDropPoliciesSettingWidget.js";

function StartDropPoliciesSettingWidget(node) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.startDropPoliciesList.populator = function (data, binding, node) {
        node._policyDataKey = data.key;
        Dom.addClass(node, "PolicyItem_" + data.key);
        if (thiz.selectedPolicy && data.key == thiz.selectedPolicy.key) Dom.addClass(node, "Active");
        Dom.addClass(binding.policyName, "PolicyName_" + data.key);
        if (data.name && data.name.length > 0) {
            binding.policyName.innerHTML = data.name;
        } else {
            binding.policyName.innerHTML = "[No Policy Name]";
            Dom.addClass(binding.policyName, "NoPolicyName");
        }        
    };
    
    this.bind("click", this.newStartDropPoliciesClickedHandler, this.newStartDropPoliciesButton);
    this.bind("click", this.newStartDropPoliciesClickedHandler, this.newStartDropPoliciesButton2);
    this.bind("click", this.saveButtonClickedHandler, this.saveButton);
    this.bind("click", this.cancelButtonClickedHandler, this.cancelButton);
    this.bind("click", this.deleteButtonClickedHandler, this.deleteButton);
    this.bind("click", this.startDropPoliciesListClickedHandler, this.startDropPoliciesList.node());
    // 
    this.bind("p:StartDropPolicyNameInputed", this.policyNameInputHandler, this.discountPlanContent);
    this.bind("p:StartDropPolicyDataChanged", this.invalidateButtonStatus, this.discountPlanContent);
}

__extend(BaseTemplatedWidget, StartDropPoliciesSettingWidget);

StartDropPoliciesSettingWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    this.startDropPoliciesObject = {};
    this.renderStartDropPolicies();
};

StartDropPoliciesSettingWidget.prototype.renderStartDropPolicies = function () {
    var thiz = this;
    this.startDropPoliciesWidget = null;
    $classStartDropDateService.getAllStartDropDatePolicy(function (res) {
        thiz.startDropPolicies = res.result;
        if (thiz.startDropPolicies && thiz.startDropPolicies.length > 0) {
            for (var i = 0; i < thiz.startDropPolicies.length; i++) {
                thiz.startDropPolicies[i].key = Util.newUUID();
                thiz.startDropPoliciesObject[thiz.startDropPolicies[i].key] = thiz.startDropPolicies[i];
            }
            thiz.selectedPolicy = thiz.startDropPolicies[0];
            Dom.removeClass(thiz.startDropPoliciesContentWrapper, "Hidden");
            Dom.addClass(thiz.noStartDropPoliciesContent, "Hidden");
            thiz.startDropPoliciesList.setItems(thiz.startDropPolicies);
            thiz.renderStartDropPoliciesContent();
        } else {
            Dom.removeClass(thiz.noStartDropPoliciesContent, "Hidden");
            Dom.addClass(thiz.startDropPoliciesContentWrapper, "Hidden");
        }
    }, function (error) {});
};

StartDropPoliciesSettingWidget.prototype.renderStartDropPoliciesContent = function () {
    this.startDropPoliciesContent.innerHTML = "";
    var thiz = this;
    this.validateDeleteAction(false);
    var startDropPoliciesOptions = {
        selectedPolicy: this.selectedPolicy,
        showClassAttached: true,
        validateDeleteAction: function (hasActiveClass) {
            thiz.validateDeleteAction(hasActiveClass)
        }
    };
    
    this.startDropPoliciesWidget = new StartDropPoliciesWidget(startDropPoliciesOptions).into(this.startDropPoliciesContent);
};

StartDropPoliciesSettingWidget.prototype.newStartDropPoliciesClickedHandler = function () {
    var thiz = this;
    if (this.startDropPoliciesWidget && this.startDropPoliciesWidget.isDataChanged()) {
        Dialog.confirm("The Policy has changed but unsaved. Would you like to save the changes of Policy?", null, "Save & Continue", function () {
            thiz.saveButtonClickedHandler(thiz.newStartDropPoliciesClickedHandler);
        },
        "Cancel", function () {
            return;
        }, null, null);
    } else {
        Dom.addClass(this.noStartDropPoliciesContent, "Hidden");
        Dom.removeClass(this.startDropPoliciesContentWrapper, "Hidden");
        if (!this.startDropPolicies) this.startDropPolicies = [];
        var newData = {
            key: Util.newUUID()
        };
        this.startDropPolicies.splice(0, 0, newData);
        this.selectedPolicy = this.startDropPolicies[0];
        this.startDropPoliciesList.setItems(this.startDropPolicies);
        this.renderStartDropPoliciesContent();
        if (this.startDropPoliciesWidget) this.startDropPoliciesWidget.setDataChanged(true);
    }
};

StartDropPoliciesSettingWidget.prototype.startDropPoliciesListClickedHandler = function (event) {
    var policyNode = Dom.findUpwardForNodeWithData(event.target, "_policyDataKey");
    if (!policyNode) return;
    var thiz = this;
    if (!Dom.hasClass(policyNode, "Active")) {
        if (this.startDropPoliciesWidget && this.startDropPoliciesWidget.isDataChanged()) {
            Dialog.confirm("The Policy was changed but unsaved. Please discard or save these changes to continue", null, "Save & Continue", function () {
                thiz.saveButtonClickedHandler(function () {
                    thiz.selectPolicy(policyNode);
                });
            },
            "Cancel", function () {
                return;
            }, "Discard & Continue", function () {
                thiz.discardChanges(policyNode);
            });
        } else {
            this.selectPolicy(policyNode);
        }
    }
};

StartDropPoliciesSettingWidget.prototype.selectPolicy = function (policyNode) {
    if (!policyNode) return;
    Dom.doOnSelector(this.startDropPoliciesList.node(), ".Active", function (el) {
        Dom.removeClass(el, "Active");
    });
    Dom.addClass(policyNode, "Active");
    this.selectedPolicy = this.startDropPoliciesObject[policyNode._policyDataKey];
    this.renderStartDropPoliciesContent();
};


StartDropPoliciesSettingWidget.prototype.saveButtonClickedHandler = function (callback) {
    if(this.saveButtonClickedTimeOut) {
        window.clearTimeout(this.saveButtonClickedTimeOut);
    }
    var thiz = this;
    thiz.saveButtonClickedTimeOut = window.setTimeout(function () {
        if (!thiz.startDropPoliciesWidget.validatePolicyData()) return;
        var data = thiz.startDropPoliciesWidget.getPolicyValue();
        if (!data) return;
        thiz.saveButton.setAttribute("disabled", "disabled");
        var key = thiz.selectedPolicy.key;
        console.log("SAVE: ", data);
        $classStartDropDateService.saveStartDropDatePolicy(data, function (res) {
            thiz.selectedPolicy = res;
            thiz.selectedPolicy.key = key;
            thiz.startDropPoliciesObject[thiz.selectedPolicy.key] = res;
            if (thiz.startDropPoliciesWidget) thiz.startDropPoliciesWidget.selectedPolicy = thiz.selectedPolicy;
            for (var i = 0; i < thiz.startDropPolicies.length; i++) {
                if (thiz.startDropPolicies[i].key == key) {
                    thiz.startDropPolicies[i] = res;
                    break;
                }
            }
            Dom.doOnSelector(thiz.startDropPoliciesList.node(), ".NoPolicyName", function (el) {
                Dom.removeClass(el, "NoPolicyName");
            });
            SnackBar.show("Data was saved successfully");
            thiz.startDropPoliciesWidget.setDataChanged(false);
            thiz.saveButton.removeAttribute("disabled");
            if (typeof(callback) == "function") callback();
        }, function (err) {
            thiz.saveButton.removeAttribute("disabled");
            Dialog.alert("Fail to save Discount  with error", err.message);
        });
    }, 200);
};

StartDropPoliciesSettingWidget.prototype.cancelButtonClickedHandler = function () {
    var thiz = this;
    Dialog.confirmDangerousAction("All changes are not saved. Do you want to discard these changes?", null, "Discard Changes", function () {
        thiz.discardChanges();
    },
    "Cancel", function () {
        return;
    }, null, null);
};

StartDropPoliciesSettingWidget.prototype.discardChanges = function(nextPolicyNode) {
    var thiz = this;
    thiz.startDropPoliciesWidget.setDataChanged(false);
    if (thiz.selectedPolicy.id > 0) {
        thiz.renderStartDropPoliciesContent();
        var policyNameElm = thiz.startDropPoliciesList.node().getElementsByClassName("PolicyName_" + thiz.selectedPolicy.key)[0];
        if (policyNameElm) {
            if (thiz.selectedPolicy.name && thiz.selectedPolicy.name.length > 0) {
                policyNameElm.innerHTML = thiz.selectedPolicy.name;
            } else {
                policyNameElm.innerHTML = "[No Policy Name]";
            }
        }
        if (nextPolicyNode) {
            setTimeout(function() {
                thiz.selectPolicy(nextPolicyNode);
            }, 20);
        }
    } else {
        var policyNameElm = thiz.startDropPoliciesList.node().getElementsByClassName("PolicyItem_" + thiz.selectedPolicy.key)[0];
        if (policyNameElm) policyNameElm.parentNode.removeChild(policyNameElm);
        var plans = [];
        for (var i = 0; i < thiz.startDropPolicies.length; i++) {
            if (thiz.startDropPolicies[i].key != thiz.selectedPolicy.key) {
                plans.push(thiz.startDropPolicies[i]);
            }
        }
        thiz.startDropPolicies = plans;
        if (!thiz.startDropPolicies.length) {
            thiz.renderStartDropPolicies();
        }
        setTimeout(function() {
            thiz.startDropPoliciesWidget.setDataChanged(false);
            if (nextPolicyNode) {
                thiz.selectPolicy(nextPolicyNode);
            } else {
                thiz.selectPolicy(thiz.startDropPoliciesList.node().childNodes[0]);
            }
        }, 10);
        return;
    }
};

StartDropPoliciesSettingWidget.prototype.deleteButtonClickedHandler = function () {
    if (!this.selectedPolicy) return;
    var thiz = this;
    Dialog.confirmDangerousAction("This Policy will be removed from all sub programs and classes which it is associated. Are you sure you want to delete this Policy?", null, "Delete", function () {
        if (thiz.selectedPolicy.id > 0) {
            $classStartDropDateService.deleteStartDropDatePolicyById(thiz.selectedPolicy.id, function () {
                thiz.startDropPoliciesWidget.setDataChanged(false);
                thiz.renderStartDropPolicies();
                SnackBar.show("Data was deleted successfully");
            }, function (err) {
                Dialog.error("", err.message);
            });
        } else {
            thiz.startDropPoliciesWidget.setDataChanged(false);
            thiz.renderStartDropPolicies();
        }
    },
    "Cancel", function () {
        return;
    }, null, null);
};

StartDropPoliciesSettingWidget.prototype.policyNameInputHandler = function (event) {
    var policyNameElm = this.startDropPoliciesList.node().getElementsByClassName("PolicyName_" + event.policyKey)[0];
    if (policyNameElm) {
        if (event.policyName && event.policyName.length > 0) {
            policyNameElm.innerHTML = event.policyName;
        } else {
            policyNameElm.innerHTML = "[No Policy Name]";
        }
    }
};

StartDropPoliciesSettingWidget.prototype.invalidateButtonStatus = function (event) {
    if (event.isDataChanged) {
        this.newStartDropPoliciesButton2.setAttribute("disabled", "disabled");
        this.cancelButton.removeAttribute("disabled");
        this.saveButton.removeAttribute("disabled");
    } else {
        this.newStartDropPoliciesButton2.removeAttribute("disabled");
        this.cancelButton.setAttribute("disabled", "disabled");
        this.saveButton.setAttribute("disabled", "disabled");
    }
};

StartDropPoliciesSettingWidget.prototype.validateDeleteAction = function (hasClass) {
    if (hasClass) {
        this.deleteButton.setAttribute("disabled", "disabled");
        this.deleteButton.setAttribute("title", "Policy in use by active class. Cannot delete.");
    } else {
        this.deleteButton.removeAttribute("disabled");
        this.deleteButton.removeAttribute("title");
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/StartDropPoliciesWidget.js";

function StartDropPoliciesWidget(options) {
    this.options = options;
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.bind("input", this.policyNameInputHandler, this.policyName);
    this.bind("input", function (event) {
        thiz.setDataChanged(true);
        Dom.emitEvent(StartDropPoliciesWidget.POLICY_DATA_CHANGED, event.target, {isDataChanged: true});
    }, this.numberToLookahead);
    this.bind("input", function (event) {
        thiz.setDataChanged(true);
        Dom.emitEvent(StartDropPoliciesWidget.POLICY_DATA_CHANGED, event.target, {isDataChanged: true});
    }, this.maximumRegistrationLimit);
    this.bind("change", function (event) {
        if (Dom.hasClass(event.target, "AllowEditStartDate")) {
            Dom.toggleClass(thiz.startDuringRegistration.parentNode, "Disabled", !event.target.checked);
            Dom.toggleClass(thiz.startRegistrationCompleted.parentNode, "Disabled", !event.target.checked);
            Dom.toggleClass(thiz.maximumRegistrationLimit.parentNode.parentNode, "Disabled", !event.target.checked);
        } else if (Dom.hasClass(event.target, "AllowEditDropDate")) {
            Dom.toggleClass(thiz.dropDuringRegistration.parentNode, "Disabled", !event.target.checked);
            Dom.toggleClass(thiz.dropRegistrationCompleted.parentNode, "Disabled", !event.target.checked);
        } else if (Dom.hasClass(event.target, "FutureRegistrationItem")) {
            if (thiz.onlyFutureRegistration.checked) {
                Dom.removeClass(thiz.numberToLookahead.parentNode, "Disabled");
            } else {
                Dom.addClass(thiz.numberToLookahead.parentNode, "Disabled");
            }
        }
        thiz.setDataChanged(true);
        Dom.emitEvent(StartDropPoliciesWidget.POLICY_DATA_CHANGED, event.target, {isDataChanged: true});
    }, this.policiesContentPane);

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.policyName, "Policy Name is required.")
        .custom(new GenericRule(thiz.startDuringRegistration, function (input) {
            if (thiz.allowEditStartDate.checked && !thiz.startDuringRegistration.checked && !thiz.startRegistrationCompleted.checked) return false;
            return true;
        }, "Please, check at least one of \"During Registration\" or \"After Registration is Completed\""))
        .custom(new GenericRule(thiz.dropDuringRegistration, function (input) {
            if (thiz.allowEditDropDate.checked && !thiz.dropDuringRegistration.checked && !thiz.dropRegistrationCompleted.checked) return false;
            return true;
        }, "Please, check at least one of \"During Registration\" or \"After Registration is Completed\""))
        //.required(this.maximumRegistrationLimit, "Input value must be positive value", null)
        .min(this.maximumRegistrationLimit, -1, true, "Input value must be positive value", null)
        .custom(new GenericRule(thiz.maximumRegistrationLimit, function (input) {
            if (thiz.allowEditStartDate.checked) {
                if (thiz.maximumRegistrationLimit.validity && !thiz.maximumRegistrationLimit.validity.valid) return false;
                if (!Number.isInteger(parseFloat(thiz.maximumRegistrationLimit.value))) return false;
            }
            return true;
        }, "Input value must be positive integer value"))
        .required(this.numberToLookahead, "Input value must be positive value", Condition.checked(this.onlyFutureRegistration))
        .min(this.numberToLookahead, -1, true, "Input value must be positive value", Condition.checked(this.onlyFutureRegistration))
        .custom(new GenericRule(thiz.numberToLookahead, function (input) {
            if (thiz.onlyFutureRegistration.checked && thiz.numberToLookahead.validity && !thiz.numberToLookahead.validity.valid) return false;
            if (thiz.onlyFutureRegistration.checked && !Number.isInteger(parseFloat(thiz.numberToLookahead.value))) return false;
            return true;
        }, "Input value must be positive integer value"));

    InfoTip.install(this.policiesContentPane, {
        match: function (node) {
            return Dom.hasClass(node, "RegistrationDateHint");
        },
        getMessage: function (target) {
            return target.getAttribute("message");
        }
    });
}

StartDropPoliciesWidget.POLICY_NAME_INPUTED = "p:StartDropPolicyNameInputed";
StartDropPoliciesWidget.POLICY_DATA_CHANGED = "p:StartDropPolicyDataChanged";

__extend(BaseTemplatedWidget, StartDropPoliciesWidget);

StartDropPoliciesWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    if (!this.options) return;
    if (!this.options.selectedPolicy) return;
    this.selectedPolicy = this.options.selectedPolicy;
    if (this.selectedPolicy.name && this.selectedPolicy.name.length > 0) this.policyName.value = this.selectedPolicy.name;
    this.allowEditStartDate.checked = this.selectedPolicy.allowParentEditStartDate;
    if (this.selectedPolicy.allowParentEditStartDate) {
        Dom.removeClass(this.startDuringRegistration.parentNode, "Disabled");
        Dom.removeClass(this.startRegistrationCompleted.parentNode, "Disabled");
        Dom.removeClass(this.maximumRegistrationLimit.parentNode.parentNode, "Disabled");
    } else {
        Dom.addClass(this.startDuringRegistration.parentNode, "Disabled");
        Dom.addClass(this.startRegistrationCompleted.parentNode, "Disabled");
        Dom.addClass(this.maximumRegistrationLimit.parentNode.parentNode, "Disabled");
    }
    this.startDuringRegistration.checked = this.selectedPolicy.allowEditStartDateDuringReg;
    this.startRegistrationCompleted.checked = this.selectedPolicy.allowEditStartDateWhenRegCompleted;
    this.allowEditDropDate.checked = this.selectedPolicy.allowParentEditDropDate;
    if (this.selectedPolicy.allowParentEditDropDate) {
        Dom.removeClass(this.dropDuringRegistration.parentNode, "Disabled");
        Dom.removeClass(this.dropRegistrationCompleted.parentNode, "Disabled");
    } else {
        Dom.addClass(this.dropDuringRegistration.parentNode, "Disabled");
        Dom.addClass(this.dropRegistrationCompleted.parentNode, "Disabled");
    }
    this.dropDuringRegistration.checked = this.selectedPolicy.allowEditDropDateDuringReg;
    this.dropRegistrationCompleted.checked = this.selectedPolicy.allowEditDropDateWhenRegCompleted;
    if (this.selectedPolicy.futureRegistrationAvailabilityType == "ALL_FUTURE_REGISTRATIONS") {
        this.allFutureRegistration.checked = true;
        this.onlyFutureRegistration.checked = false;
        Dom.addClass(this.numberToLookahead.parentNode, "Disabled");
    } else if (this.selectedPolicy.futureRegistrationAvailabilityType == "LOOKAHEAD_DAYS_FUTURE_REGISTRATION") {
        this.allFutureRegistration.checked = false;
        this.onlyFutureRegistration.checked = true;
        Dom.removeClass(this.numberToLookahead.parentNode, "Disabled");
    }
    this.numberToLookahead.value = this.selectedPolicy.lookaheadDaysForFutureRegistration;
    this.maximumRegistrationLimit.value = this.selectedPolicy.maxFutureRegistrationLimitDays;
    
    var thiz = this;
    if (this.selectedPolicy.id > 0 && this.options.showClassAttached) {
        $classStartDropDateService.getClassAttachedPolicy(this.selectedPolicy.id, function (res) {
            thiz.classListContent.innerHTML = "";
            if (res && res.length > 0) {
                res.forEach(function (classInfo) {
                    thiz.classListContent.appendChild(Dom.newDOMElement({
                        _name: "div",
                        _text: classInfo.name,
                        "title": classInfo.name
                    }));
                });
                Dom.removeClass(thiz.classListWrapper, "NoClassFound");
            } else {
                Dom.addClass(thiz.classListWrapper, "NoClassFound");
            }
            if (thiz.options.validateDeleteAction) thiz.options.validateDeleteAction(res.length > 0);
        }, function (err) {
            
        }, "Loading...");
    } else {
        if (this.options.validateDeleteAction) this.options.validateDeleteAction(false);
    }
};

StartDropPoliciesWidget.prototype.policyNameInputHandler = function (event) {
    if(this.inputingPolicyNameTimeout) {
        window.clearTimeout(this.inputingPolicyNameTimeout);
    }
    var thiz = this;
    this.inputingPolicyNameTimeout = window.setTimeout(function () {
        thiz.setDataChanged(true);
        Dom.emitEvent(StartDropPoliciesWidget.POLICY_NAME_INPUTED, event.target,
            {policyKey: thiz.selectedPolicy.key, policyName: event.target.value});
    }, 200);
};

StartDropPoliciesWidget.prototype.validatePolicyData = function () {
    if (!ValidationManager.run(this.validationRules)) return false;
    return true;
};

StartDropPoliciesWidget.prototype.getPolicyValue = function () {
    if (!this.selectedPolicy) return;
    var data = {
        id: this.selectedPolicy.id,
        name: this.policyName.value,
        allowParentEditStartDate: this.allowEditStartDate.checked,
        allowParentEditDropDate: this.allowEditDropDate.checked
    };

    if (data.allowParentEditStartDate) {
        data.allowEditStartDateDuringReg = this.startDuringRegistration.checked;
        data.allowEditStartDateWhenRegCompleted = this.startRegistrationCompleted.checked;
        data.maxFutureRegistrationLimitDays = parseInt(this.maximumRegistrationLimit.value);
    } else {
        data.allowEditStartDateDuringReg = false;
        data.allowEditStartDateWhenRegCompleted = false;
        data.maxFutureRegistrationLimitDays = 0;
    }
    if (data.allowParentEditDropDate) {
        data.allowEditDropDateDuringReg = this.dropDuringRegistration.checked;
        data.allowEditDropDateWhenRegCompleted = this.dropRegistrationCompleted.checked;
    } else {
        data.allowEditDropDateDuringReg = false;
        data.allowEditDropDateWhenRegCompleted = false;
    }
    if (this.allFutureRegistration.checked) {
        data.futureRegistrationAvailabilityType = "ALL_FUTURE_REGISTRATIONS";
        data.lookaheadDaysForFutureRegistration = 0;
    } else {
        data.futureRegistrationAvailabilityType = "LOOKAHEAD_DAYS_FUTURE_REGISTRATION";
        data.lookaheadDaysForFutureRegistration = parseInt(this.numberToLookahead.value);
    }
    return data;
};

StartDropPoliciesWidget.prototype.setDataChanged = function (isChanged) {
    this.isPolicyDataChanged = isChanged;
    Dom.emitEvent(StartDropPoliciesWidget.POLICY_DATA_CHANGED, this.node(), {isDataChanged: isChanged});
};

StartDropPoliciesWidget.prototype.isDataChanged = function () {
    return this.isPolicyDataChanged;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/TrackAttendanceContent.js";

function TrackAttendanceContent(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.options = options;
    this.attendanceStatus = {};
    this.SLOTINSTANCE_STATUS_CANCEL = 2;
    Util.getEnumValues(AttendanceState).forEach(function(item){
        thiz.attendanceStatus[item.value] = item;
    });

    var memberNameColumn = new DataTable.GenericColumn("Student", function (data) {
        return "<span class=\"InfoLink MemberName\">" + data.fullname + "</span>";
    }).sortable("fullname").width("1*", "15em");
    memberNameColumn.getContentTitle = function (data, row, col) {
        return "" + data.fullname;
    }

    this.defaultAttendanceColumns = [
        memberNameColumn,
        new DataTable.GenericColumn("Age", function (data) {
            return data.age;
        }).sortable("age").width("6em"),
        new DataTable.GenericColumn("Gender", function (data) {
            return data.gender || "M";
        }).sortable("sex").width("8em"),
        new DataTable.GenericColumn("Account", function (data) {
            return data.accountName;
        }).sortable("accountName").width("1*", "15em")
    ];

    if (this._canViewAccountBalance()) {
        var accountBalanceColumn  = new DataTable.GenericColumn("Account Balance", function (data) {
            if (data.balance30days > 0) {
                return "<a class=\"Positive\">" + ClassUtils.toCurrency(data.balance30days) + "</a>";
            } else if (data.balance30days < 0) {
                return "<a class=\"Negative\"> - " + ClassUtils.toCurrency(data.balance30days * -1) + "</a>";
            } else {
                return ClassUtils.toCurrency(data.balance30days);
            }
        }).sortable("balance30days").width("11em");
        accountBalanceColumn.getContentTitle = function (data, row, col) {
            if (data.balance30days < 0) {
                return "- " + ClassUtils.toCurrency(data.balance30days * -1);
            }
            return ClassUtils.toCurrency(data.balance30days);
        }
        this.defaultAttendanceColumns.push(accountBalanceColumn);
    }
    if (this.options.enableGroupAttendanceNote) {
        if (ClassAuthUtils.canEditAttendanceNotes()) {
            this.defaultAttendanceColumns.push(new DataTable.GenericDomColumn("Grouping", function (data) {
                return Dom.newDOMElement({
                    _name: "input",
                    "type": "text",
                    "class": "GroupingInput",
                    "maxlength": 1024,
                    "value": data.grouping ? data.grouping : ""
                });
            }).sortable("grouping").width("14em"));
        } else {
            this.defaultAttendanceColumns.push(new DataTable.GenericColumn("Grouping", function (data) {
                return data.grouping ? data.grouping : "";
            }).sortable("grouping").width("14em"));
        }

    }
    if (this.options.enableClassRooomAttendanceNote) {
        this.defaultAttendanceColumns.push(new DataTable.GenericDomColumn(thiz.options.classRoomAttendanceNoteLabel, function (data) {
            var _text = data.classroom ? data.classroom : "";
            if (ClassAuthUtils.canEditAttendanceNotes()) {
                return Dom.newDOMElement({
                    _name: "input",
                    "type": "text",
                    "class": "ClassroomInput",
                    "maxlength": 1024,
                    "value": _text
                });
            } else {
                return Dom.newDOMElement({
                    _name: "div",
                    "class": "Col_classroom",
                    _text: _text
                });
            }
        }).sortable("classroom").width("14em"));
    }
    this.defaultAttendanceColumns.push(
        new DataTable.GenericDomColumn("Start/Drop Date", function (data) {
            var _children = [];
            if (data.policyStartDate) {
                _children.push(Dom.newDOMElement({
                    _name: "div",
                    _children: [
                        Dom.newDOMElement({
                            _name: "label",
                            _html: "S:"
                        }),
                        Dom.newDOMElement({
                            _name: "span",
                            _html: FormatUtil.formatDateWithTZID(data.policyStartDate, "date_standard", data.classTzId)
                        })
                    ]
                }));
            }
            if (data.policyEndDate) {
                _children.push(Dom.newDOMElement({
                    _name: "div",
                    _children: [
                        Dom.newDOMElement({
                            _name: "label",
                            _html: "D:"
                        }),
                        Dom.newDOMElement({
                            _name: "span",
                            _html: FormatUtil.formatDateWithTZID(data.policyEndDate, "date_standard", data.classTzId)
                        })
                    ]
                }));
            }
            return Dom.newDOMElement({
                _name: "div",
                "class": "StartDropDateColumn",
                _children: _children
            });
        }).width("12em")
    );
    this.defaultAttendanceColumns.push(this._getDataTableSizesColumn());
    this.defaultAttendanceColumns.push(
        new DataTable.GenericDomColumn("Attended", function (data) {
            var _html = "";
            if (data.availableAttendance > 0) {
                _html = data.presentAttendance + "/" + data.availableAttendance;
            }
            return Dom.newDOMElement({
                _name: "span",
                "id": "attendedContent_" + data.id,
                _html: _html
            });
        }).width("1*", "8em")
    );
    this.bind("click", this.attendanceTableClickedHandler ,this.attendanceTableWrapper);
    this.bind("click", this.printAttendanceButtonClickedHandler ,this.printAttendanceButton);
    this.bind("click", this.attendanceStatusClickedHandler ,this.attendanceStatusContent);
    this.bind("p:ItemSelected", this.timeRangePickerChangedHandler ,this.timeRangePicker.node());
    this.bind("click", this._dataTableClickHandler, this.dataTable.node());
    this.bind("click", this.locationMapButtonClickedHandler, this.locationMapButton);
    this.bind("input", this._dataTableInputHandler, this.dataTable.node());
}

__extend(BaseTemplatedWidget, TrackAttendanceContent);


TrackAttendanceContent.prototype._openMemberSizingDialog = function(member) {
    var thiz = this;
    widget.__ensureNamespaceLoaded("ama", function (ama) {
        if (!thiz._canViewMemberDetailDialog(ama)) return;

        new ama.MembersDetailDialog().callback(function(updated) {
            if (updated) thiz.renderAttendanceTable();
        }).open({ids: [member.id], targetTab: ClassAuthUtils.canViewAMAMemberSizes(window.LOGIN_INFO) ? "sizes" : ""});
    }.bind(this));
}

TrackAttendanceContent.prototype._canViewMemberDetailDialog = function(pkgAMA) {
    return pkgAMA.authutil.canViewStandardAccountMemberInfo(window.LOGIN_INFO);
};

TrackAttendanceContent.prototype._canViewMemberBasicDetailDialog = function(pkgAMA) {
    return pkgAMA.authutil.canViewLimitBasicAccountMemberInfo(window.LOGIN_INFO);
};

TrackAttendanceContent.prototype._canViewAccountBalance = function() {
    return ClassAuthUtils.canViewAccountBalanceOfAttendance(window.LOGIN_INFO);
};

TrackAttendanceContent.prototype._canTakeAttendanceAllClass = function() {
    return window.LOGIN_INFO && window.LOGIN_INFO.isAbleTakeAttendance || ClassAuthUtils.canTakeAttendanceSkill(window.LOGIN_INFO);
};

TrackAttendanceContent.prototype._dataTableClickHandler = function(event) {
    var ruler = Dom.findParentWithClass(event.target, "SizesColumn");
    if (ruler) {
        this._openMemberSizingDialog(DataTable.getRowData(event.target));
    }
}

TrackAttendanceContent.prototype._getDataTableSizesColumn = function() {
    var sizesColumn =  new DataTable.GenericDomColumn("Sizes", function(data) {
        // NOT_NEEDED or COMPLETED
        if (data.sizingStatus == 2 || data.sizingStatus == 3) {
            return null;
        } else {
            return Dom.newDOMElement({
                _name: "a",
                "class": "SizesColumn",
                href: "#",
                _children: [{_name: "icon", class: "ruler"}]
            });
        }

    }).width("1*", "6em");
    sizesColumn.defaultHidden = window.LOGIN_INFO.allowCostume ? false : true;
    return sizesColumn;
}

TrackAttendanceContent.prototype.syncClassData = function(classInfo, reloadOnly) {
    var thiz = this;
    if (thiz.options && typeof(thiz.options.validateChangeCallback) == "function"
                && typeof(thiz.options.saveCallback) == "function"
                && typeof(thiz.options.reloadCallback) == "function"
                && (thiz.options && !thiz.options.hasJustReloaded)
                && (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan)) {
        if (!reloadOnly && thiz.options.validateChangeCallback()) {
            Dialog.confirm("This class is being changed and hasn't been saved yet. Please save before going to attendance", "",
                    "Save and Open Attendance", function() {
                        thiz.options.saveCallback({reloadOneTime: true});
                    },
                    "Discard Change and Open Attendance", function() {
                        thiz.options.reloadCallback({reloadOneTime: true});
                    });
            return;
        }
    }
    window.setTimeout(thiz.renderTabContent.bind(thiz), 10);
};

TrackAttendanceContent.prototype.onAttached = function(isFirst) {
    var thiz = this;
    if (!isFirst) return;

    if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
        thiz.renderAttendanceContent();
    } else {
        $classAdminService.getAccountInfo(function (res) {
            window.LOGIN_INFO.isAbleTakeAttendance = res.isAbleTakeAttendance;
            thiz.renderAttendanceContent();
        }, function (err) {});
    }
};

TrackAttendanceContent.prototype.renderAttendanceContent = function(){
    this.timeRangePicker.setItems(ClassUtils.ATTENDANCE_RANGE_OPTIONS);
    if (this.options.defaultDate && this.options.defaultDate == "currentMonth") {
        this.timeRangePicker.selectItemByKey("key", "thismonth");
    } else {
        this.timeRangePicker.selectItemByKey("key", "next7days");
    }

    if (!(this.options && typeof(this.options.reloadCallback) == "function")) { // it is not a call from ClassEditDialog
        this.renderTabContent();
    }

    Dom.toggleClass(this.attendanceTakingNote, "Inapplicabled", this._canTakeAttendanceAllClass());
};

TrackAttendanceContent.prototype.renderTabContent = function(){
    var thiz = this;
    if (!this.options) return;
    if (!this.options.classList) return;
    if (this.options.classList.length == 0) return;
    this.classObject = {};
    this.slotObject = {};
    var classComboItems = [];
    this.selectedClass = this.options.classList[0];
    this.selectedSlot = this.options.classList[0].slots[0];
    for (var i = 0; i < this.options.classList.length; i ++) {
        var classItem = this.options.classList[i];
        this.classObject[classItem.id] = classItem;
        if (classItem.slots && classItem.slots.length > 0) {
            for (var j = 0; j < classItem.slots.length; j ++) {
                var slot = classItem.slots[j];
                this.slotObject[slot.id] = slot;
                var className = "Reg Slot #" + slot.slotOrder;
                if (classItem.title && classItem.title.length > 0) className = classItem.title + " | " + className;
                var comboItem = {
                    id: classItem.id + "_" + slot.id,
                    name: className,
                    deleted: false,
                    googleMapLink: classItem.googleMapLink,
                    lessonLocId: classItem.lessonLocId,
                    lessonLocName: classItem.lessonLocName
                };
                classComboItems.push(comboItem);
            }
        }

        if (classItem.deletedSlotsHasAttendance && classItem.deletedSlotsHasAttendance.length > 0) {
            for (var j = 0; j < classItem.deletedSlotsHasAttendance.length; j ++) {
                var slot = classItem.deletedSlotsHasAttendance[j];
                slot["deleted"] = true;
                this.slotObject[slot.id] = slot;
                var className = "Reg Slot #" + slot.slotOrder;
                if (classItem.title && classItem.title.length > 0) className = classItem.title + " | " + className;
                var comboItem = {
                    id: classItem.id + "_" + slot.id,
                    name: className,
                    deleted: true
                };
                classComboItems.push(comboItem);
            }
        }
    }

    var getSlotText = function (selectedSlot) {
        var slotText = "";
        if (selectedSlot.slotOpen <= 0 && selectedSlot.slotRegister >= selectedSlot.maxLimit && selectedSlot.maxLimit > 0 && selectedSlot.maxLimit != 99999) {
            slotText = "Slot Full";
        } else if (selectedSlot.slotOpen == 0 && selectedSlot.maxLimit <= 0 && selectedSlot.wailistLimit > 0) {
            slotText = "Waitlist";
        } else if (selectedSlot.maxLimit == 99999) {
            slotText = "No Limit";
        } else {
            slotText = "Slot Open: " + (selectedSlot.slotOpen < 0? 0 : selectedSlot.slotOpen) ;
        }

        return slotText;
    }

    this.classCombo.useHtml = true;
    this.classCombo.getDisplayValue = function (item) {
        var classId = item.id.substring(0, item.id.lastIndexOf("_"));
        var slotId = item.id.substring(item.id.lastIndexOf("_") + 1, item.id.length);
        var selectedClass = thiz.classObject[classId];
        if (!selectedClass) return "";
        var selectedSlot = thiz.slotObject[slotId];
        if (!selectedSlot) return "";
        var slotText = "";
        if (!item.deleted){
            slotText = getSlotText(selectedSlot);
        }
        var displayValue = "Reg Slot #" + selectedSlot.slotOrder + (item.deleted? " <icon class=\"block-helper\"></icon>&nbsp;&nbsp;" : (" | " + slotText)) + " | " + selectedSlot.slotTimes.join("&nbsp;&nbsp;&nbsp;");
//        var displayValue = "Reg Slot #" + selectedSlot.slotOrder + " | Slot Open: " + selectedSlot.slotOpen + " | " + selectedSlot.slotTimes.join("&nbsp;&nbsp;&nbsp;");
        if (selectedClass.title && selectedClass.title.length > 0) displayValue = selectedClass.title + " | " + displayValue;
        return displayValue;
    };
    this.classCombo.renderer = function (item, selected) {
        if(!item) return "";
        var classId = item.id.substring(0, item.id.lastIndexOf("_"));
        var slotId = item.id.substring(item.id.lastIndexOf("_") + 1, item.id.length);
        var selectedClass = thiz.classObject[classId];
        if (!selectedClass) return "";
        var selectedSlot = thiz.slotObject[slotId];
        if (!selectedSlot) return "";
        var slotTimeHtml = "";
        for (var i = 0; i < selectedSlot.slotTimes.length; i++) {
            slotTimeHtml += "<div>" + selectedSlot.slotTimes[i] + "</div>";
        }
        var slotText = "";
        if (!item.deleted){
            slotText = getSlotText(selectedSlot);
        }


        var displayValue = "<span class=\"RegSlotTitle\">Reg Slot #" + selectedSlot.slotOrder + (item.deleted? " <icon class=\"block-helper\"></icon></span>" : ("</span> | " + slotText));
        var displayClass = "ComboClassSlotInfo NoClassTitle";
        if (selectedClass.title && selectedClass.title.length > 0) {
            displayValue = selectedClass.title + " | " + displayValue;
            displayClass = "ComboClassSlotInfo";
        }
        return  "<hbox class=\"ClassComboWrapper " + (item.deleted? "DeletedSlot" : "") + "\">" +
                    "<div class=\"" + displayClass + "\">" + displayValue + "</div>" +
                    "<div class=\"ComboClassSlotTimeInfo\">" + slotTimeHtml + "</div>" +
                "</hbox>";
    };
    this.classCombo.setItems(classComboItems);
    this.renderLocationMapButton();

    this.bind("p:ItemSelected", this.classComboChangedHandler, this.classCombo.node());

    var changeOrder = {
        changeOrder: function(currentOrder) {
            thiz.dataTable.setOrder(currentOrder);
            if(currentOrder && (currentOrder.propertyName == "fullname"
                || currentOrder.propertyName == "accountName"
                || currentOrder.propertyName == "grouping"
                || currentOrder.propertyName == "classroom")) {
                thiz.dataTable.getItems().sort(function(a, b) {
                    var nameA = a[currentOrder.propertyName],
                    nameB = b[currentOrder.propertyName];
                    if (!nameA) nameA = "";
                    if (!nameB) nameB = "";
                    nameA = nameA.toLowerCase();
                    nameB = nameB.toLowerCase();

                    if (currentOrder.asc) {
                        if (nameA < nameB) {
                            return -1;
                        }
                        if (nameA > nameB) {
                            return 1;
                        }
                        return 0;
                    } else {
                        if (nameA < nameB) {
                            return 1;
                        }
                        if (nameA > nameB) {
                            return -1;
                        }
                        return 0;
                    }
                });
            } else if (currentOrder && (currentOrder.propertyName == "age" || currentOrder.propertyName == "sex"
                || currentOrder.propertyName == "balance30days")) {
                thiz.dataTable.getItems().sort(function (a, b) {
                    if (currentOrder.asc) {
                        return a[currentOrder.propertyName] - b[currentOrder.propertyName];
                    } else {
                        return b[currentOrder.propertyName] - a[currentOrder.propertyName];
                    }
                });
            }
            thiz.dataTable.setItems(thiz.dataTable.getItems());
        }
    }
    this.dataTable.addOrderRequestListener(changeOrder);
    this.dataTable.useFloatingHeader = true;
    this.renderAttendanceTable();
}

TrackAttendanceContent.prototype.renderAttendanceTable = function () {
    if (!this.selectedClass) return;
    if (!this.selectedSlot) return;
    this.attendanceChanged = false;
    window.defaultIndicator.busy("Loading...");
    this.birthdayCol = [];
    this.savingAttendanceInfo = {};
    var thiz = this,
        timeRange = this.timeRangePicker.getRange();
    var dateRangeData = this.getDateRangeData(timeRange);
    var deletedSlot = null;
    if (this.selectedSlot.deleted) {
        deletedSlot = {};
        deletedSlot[this.selectedSlot.slot] = this.selectedSlot.id;
    }

    var params = {
        classes: [{classId: this.selectedClass.id,
                slots: (deletedSlot? null : [this.selectedSlot.slot]),
                deletedSlot: deletedSlot}],
        from: dateRangeData.from,
        isFullClass: dateRangeData.isFullClass,
        to: dateRangeData.to,
        type: 0
    };
    $attndService.buildTrackingAttendance(params, function (res) {
        thiz.rescheduleSlotInstances = res.rescheduleSlotInstances;
        thiz.dataTable.columns = [];
        thiz.dataTable.actualColumns = [];
        thiz.slotInstanceAttendances = res.slotInstanceAttendances;
        for (var i = 0; i < thiz.defaultAttendanceColumns.length; i ++) {
            thiz.dataTable.column(thiz.defaultAttendanceColumns[i]);
        }
        var result = {
            members: []
        };

        if(res && res.ranges && res.ranges.length > 0) {
            result = res.ranges[0];
            if (result.members.length > 0) {
                var order = {
                    propertyName: thiz.options.enableGroupAttendanceNote ? "grouping" : "fullname",
                    asc: true
                };
                result.members.sort(function(a, b) {
                    var nameA = a[order.propertyName],
                    nameB = b[order.propertyName];
                    if (!nameA) nameA = "";
                    if (!nameB) nameB = "";
                    nameA = nameA.toLowerCase();
                    nameB = nameB.toLowerCase();
                    if (nameA < nameB) {
                        return -1;
                    }
                    if (nameA > nameB) {
                        return 1;
                    }
                    return 0;
                });

                if (result.slotInstances && result.slotInstances.length > 0) {
                    for (var i = 0; i < result.slotInstances.length; i ++) {
                        var slotInstance = result.slotInstances[i];
                        thiz.createAttendanceColumn(slotInstance);
                    }
                }
            }
        }


        thiz.memberMap = {};
        thiz.attendanceNoteMap = {};
        thiz.editingAttendanceNoteMap = {};
        for (var i = 0; i < result.members.length; i ++) {
            var m = result.members[i];
            m.availableAttendance = 0;
            m.presentAttendance = 0;
            thiz.memberMap[m.id] = m;
            thiz.attendanceNoteMap[m.classInId] = {
                grouping: m.grouping,
                classroom: m.classroom
            }
            thiz.editingAttendanceNoteMap[m.classInId] = {
                grouping: m.grouping,
                classroom: m.classroom
            }
            for (var j = 0; j < result.slotInstances.length; j ++) {
                var slotInstance = result.slotInstances[j];
                var hasTakenAttendance = false;
                if (thiz.slotInstanceAttendances && thiz.slotInstanceAttendances[slotInstance.slotInstanceId]
                    && thiz.slotInstanceAttendances[slotInstance.slotInstanceId][m.id]) {
                    hasTakenAttendance = true;
                    var status = thiz.attendanceStatus[thiz.slotInstanceAttendances[slotInstance.slotInstanceId][m.id].state];
                    if (AttendanceState.Present.value == status.value
                        || AttendanceState.Tardy.value == status.value
                        || AttendanceState.LeftEarly.value == status.value
                        || AttendanceState.TardyLeftEarly.value == status.value) {
                        if (m && m.presentAttendance >= 0) m.presentAttendance ++;
                    }
                }

                if (m.policyStartDate || m.policyEndDate) {
                    if (((!m.policyStartDate || slotInstance.orignalTakenDate.getTime() >= m.policyStartDate.getTime())
                            && m.policyEndDate && slotInstance.orignalTakenDate.getTime() <= m.policyEndDateEOD.getTime()) ||
                        (m.policyStartDate && slotInstance.orignalTakenDate.getTime() >= m.policyStartDate.getTime())
                                && (!m.policyEndDate || slotInstance.orignalTakenDate.getTime() <= m.policyEndDateEOD.getTime())) {
                        if (m && m.availableAttendance >= 0) m.availableAttendance ++;
                    } else {
                        if (hasTakenAttendance) {
                            if (m && m.availableAttendance >= 0) m.availableAttendance ++;
                        }
                    }
                } else {
                    if (m && m.availableAttendance >= 0) m.availableAttendance ++;
                }
            }
        }

        thiz.dataTable.setDefaultSelectionHandler({
            run: function (item, event) {
                var link = Dom.findParentWithClass(event.target, "InfoLink");
                if (!link) return;

                if (link && Dom.hasClass(link, "MemberName")) {
                    var timeRange = thiz.timeRangePicker.getRange(),
                        timeRangeData = thiz.getDateRangeData(timeRange);
                    widget.__ensureNamespaceLoaded("ama", function (ama) {
                        if (!thiz._canViewMemberBasicDetailDialog(ama)) return;

                        new ama.MembersDetailDialog().callback(function(updated) {
                            //if (updated) thiz.dataView.refreshDataList();
                        }).open({ids: [item.id], targetTab: ama.authutil.canViewMemberAttendance(window.LOGIN_INFO) ? "attendance" : "", attendanceTimeRangeData: timeRangeData});
                    }.bind(this));
                }
            }
        });

        thiz.dataTable.setup();
        thiz.dataTable.setItems(result.members);
        thiz.dataTable.setOrder(order);

        if(thiz.birthdayCol && thiz.birthdayCol.length > 0) {
            for (var i = 0; i < thiz.birthdayCol.length; i++) {
                Dom.doOnSelector(thiz.attendanceTableWrapper, ("." + thiz.birthdayCol[i]), function(col) {
                    Dom.addClass(col, "HasBirthday");
                });
            }
        }
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    }, function () {
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    });
};

TrackAttendanceContent.prototype.createAttendanceColumn = function (slotInstance) {
    var thiz = this;
    if (!slotInstance) return;
    var colHeaderHtml = slotInstance.slotDate + "<br/>" + slotInstance.slotHour;
    if (slotInstance.slotInstanceStatus == this.SLOTINSTANCE_STATUS_CANCEL) {
        colHeaderHtml += "<br/><span class=\"Cancelled\">Cancelled</span>";
    } else if (this.rescheduleSlotInstances && this.rescheduleSlotInstances[slotInstance.slotInstanceId]) {
        colHeaderHtml += "<br/><span class=\"Rescheduled\">Rescheduled</span>";
    }
    var col = new DataTable.GenericDomColumn(colHeaderHtml, function (data) {
        var content = document.createElement("hbox");
        Dom.addClass(content, "Date_" + slotInstance.slotDate.replace("/", "_"));

        var dobWrapper = document.createElement("div");
        Dom.addClass(dobWrapper, "DobWrapper");
        var dob = FormatUtil.formatDate(data.dob, "date_month_only", "server");
        if(dob === slotInstance.slotDate) {
            thiz.birthdayCol.push("Date_" + slotInstance.slotDate.replace("/", "_"));
            var cakeIcon = document.createElement("icon");
            Dom.addClass(cakeIcon, "cake");
            dobWrapper.appendChild(cakeIcon);
        }
        content.appendChild(dobWrapper);
        var attStatus = document.createElement("div");
        Dom.addClass(attStatus, "AttendanceStatus");
        var hasTakenAttendance = false;
        if (thiz.slotInstanceAttendances && thiz.slotInstanceAttendances[slotInstance.slotInstanceId]
            && thiz.slotInstanceAttendances[slotInstance.slotInstanceId][data.id]) {
            hasTakenAttendance = true;
            var status = thiz.attendanceStatus[thiz.slotInstanceAttendances[slotInstance.slotInstanceId][data.id].state];
            if (status) {
                Dom.addClass(attStatus, status.code);
                attStatus.innerHTML = status.abbr;
                attStatus.title = status.title;
            }
        } else {
            Dom.addClass(attStatus, "NotTakeAttendance");
        }

        if (data.policyStartDate || data.policyEndDate) {
            if (((!data.policyStartDate || slotInstance.orignalTakenDate.getTime() >= data.policyStartDate.getTime())
                    && data.policyEndDate && slotInstance.orignalTakenDate.getTime() <= data.policyEndDateEOD.getTime()) ||
                (data.policyStartDate && slotInstance.orignalTakenDate.getTime() >= data.policyStartDate.getTime())
                        && (!data.policyEndDate || slotInstance.orignalTakenDate.getTime() <= data.policyEndDateEOD.getTime())) {
                content.appendChild(attStatus);
            } else {
                if (hasTakenAttendance) content.appendChild(attStatus);
            }
        } else {
            content.appendChild(attStatus);
        }
        var editable = slotInstance.editable && slotInstance.slotInstanceStatus != thiz.SLOTINSTANCE_STATUS_CANCEL;
        Dom.toggleClass(attStatus, "Disabled", !editable);
        Dom.toggleClass(attStatus, "Cancelled", slotInstance.slotInstanceStatus == thiz.SLOTINSTANCE_STATUS_CANCEL);
        if (slotInstance.slotInstanceStatus == thiz.SLOTINSTANCE_STATUS_CANCEL) {
            attStatus.setAttribute("title", "Cancelled");
        }
        return content;
    }, "SlotInstance").width("9em");

    col._slotInstance = slotInstance;
    col.useHtmlTitle = function () {
        return true;
    };
    col.getTitleInfo = function () { return ""; };
    this.dataTable.column(col);
};

TrackAttendanceContent.prototype.classComboChangedHandler = function () {
    var thiz = this;
    if (this.isDataChanged()) {
        Dialog.confirm("This attendance is being changed and hasn't been saved yet. Please save to continue", "",
        "Save Attendance", function() {
            thiz.updateAttendanceHandler(function () {
                thiz.goToSlotAttendance();
            });
        },
        "Discard Change", function() {
            thiz.goToSlotAttendance();
        });
    } else {
        this.goToSlotAttendance();
    }
};

TrackAttendanceContent.prototype.goToSlotAttendance = function () {
    var selectedClassSlot = this.classCombo.getSelectedItem();
    this.renderLocationMapButton();
    if(!selectedClassSlot) return;
    var id = selectedClassSlot.id;
    var classId = id.substring(0, id.lastIndexOf("_"));
    var slotId = id.substring(id.lastIndexOf("_") + 1, id.length);
    this.selectedClass = this.classObject[classId];
    this.selectedSlot = this.slotObject[slotId];
    this.renderAttendanceTable();

};

TrackAttendanceContent.prototype.attendanceTableClickedHandler = function (e) {
    var cellContentWrapper = Dom.findParentWithClass(e.target, "CellContentWrapper");
    if (!cellContentWrapper) return;
    var col = cellContentWrapper.parentNode;
    if (Dom.hasClass(col, "Col_student") || Dom.hasClass(col, "Col_age") || Dom.hasClass(col, "Col_sex")
        || Dom.hasClass(col, "Col_account") || Dom.hasClass(col, "Col_30_days_balance")) {
        return;
    }

    if ((!window.LOGIN_INFO || (!window.LOGIN_INFO.isAbleTakeAttendance && !window.LOGIN_INFO.isAbleTakeAttendanceOnMyInstructorClass))) return;

    var attendanceStatus = cellContentWrapper.getElementsByClassName("AttendanceStatus")[0];
    if (!attendanceStatus) return;
    var memberData = DataTable.getRowData(e.target);
    var colId = col.getAttribute("column-id");
    var column = null;
    this.dataTable.columns.forEach(function (c) {
        if (c.id == colId) column = c;
    });
    if (!column) return;
    var slotInstance = column._slotInstance;
    if (!slotInstance || !slotInstance.editable || slotInstance.slotInstanceStatus == this.SLOTINSTANCE_STATUS_CANCEL) return;
    
    if (!this.savingAttendanceInfo[memberData.id]) {
        this.savingAttendanceInfo[memberData.id] = {};
    }
    if (!this.savingAttendanceInfo[memberData.id][slotInstance.slotInstanceId]) {
        this.savingAttendanceInfo[memberData.id][slotInstance.slotInstanceId] = {};
    }
    this.workingAttendance = {
        slotInstance: slotInstance,
        memberId: memberData.id,
        statusElement: attendanceStatus
    };

    var statusItems = this.attendanceStatusContent.getElementsByClassName("StatusItem");
    for (var i = 0; i < statusItems.length; i++) {
        Dom.removeClass(statusItems[i], "Hidden");
    }
    var state = -1;
    if (this.slotInstanceAttendances[slotInstance.slotInstanceId] && this.slotInstanceAttendances[slotInstance.slotInstanceId][memberData.id]) {
        state = this.slotInstanceAttendances[slotInstance.slotInstanceId][memberData.id].state;
    }
    var currentStatus = this.attendanceStatusContent.getElementsByClassName(this.attendanceStatus[state].code)[0];
    if (currentStatus) Dom.addClass(currentStatus, "Hidden");
    this.attendanceStatusPopup.show(e.target, "center", "bottom", 0, 5, true);
};

TrackAttendanceContent.prototype.updateAttendanceHandler = function (callback, reload) {
    if (!this.savingAttendanceInfo) return;
    var thiz = this;
    var attendanceInfos = [];
    console.log("START updateAttendanceHandler", new Date());
    for (var memberId in this.savingAttendanceInfo) {
        for (var slotInstanceId in this.savingAttendanceInfo[memberId]) {
            var attendanceInfo = {
                slotInstanceId: parseInt(slotInstanceId),
                attndId: -1,
                memberId: parseInt(memberId),
                state: this.savingAttendanceInfo[memberId][slotInstanceId].state,
                classId: this.selectedClass.id,
                slot: this.selectedSlot.slot,
                takenDate: this.savingAttendanceInfo[memberId][slotInstanceId].takenDate,
                weekday: this.savingAttendanceInfo[memberId][slotInstanceId].weekday,
                startMin: this.savingAttendanceInfo[memberId][slotInstanceId].startMin,
                note: "",//this.savingAttendanceInfo[memberId][slotInstanceId].note,
                lessonClassSchedId: this.savingAttendanceInfo[memberId][slotInstanceId].lessonClassSchedId
            };
            if(this.slotInstanceAttendances && this.slotInstanceAttendances[slotInstanceId]
                && this.slotInstanceAttendances[slotInstanceId][memberId]) {

                var slotInstanceAttendance = this.slotInstanceAttendances[slotInstanceId][memberId];
                attendanceInfo.attndId = slotInstanceAttendance.attndId;
                attendanceInfo.currentState = slotInstanceAttendance.currentState;
                attendanceInfo.note = slotInstanceAttendance.note;
            }
            console.log("MEMBER", memberId, "TAKEN DATE", this.savingAttendanceInfo[memberId][slotInstanceId].takenDate, attendanceInfo);
            attendanceInfos.push(attendanceInfo);
        }

    }

    var attendanceNoteInfo = [];
    for (var key in this.editingAttendanceNoteMap) {
        var attendanceNote = this.attendanceNoteMap[key];
        var editingAttendanceNote = this.editingAttendanceNoteMap[key];

        if (JSON.stringify(attendanceNote) !== JSON.stringify(editingAttendanceNote)) {
            attendanceNoteInfo.push({
                classInId: key,
                grouping: editingAttendanceNote.grouping,
                classroom: editingAttendanceNote.classroom
            })
        }
    }
    var promiseAll = [];
    var isUpdateAttendanceNote = false;
    if (attendanceNoteInfo.length > 0 && ClassAuthUtils.canEditAttendanceNotes()) {
        promiseAll.push(new Promise(function(resolve, reject) {
            $classAdminService.updateMultiAttendaceNote(attendanceNoteInfo, function(res) {
                isUpdateAttendanceNote = true;
                resolve();
            }, function (err) {
                Dialog.error("There is an error when saving attendance",  "Attendances cannot be saved and will be reloaded.", function() {
                    thiz.renderAttendanceTable();
                });
                reject(err);
            });
        }));
    }
    if (attendanceInfos.length > 0 && ClassAuthUtils.canTakeAttendance()) {
        promiseAll.push(new Promise(function(resolve, reject) {
            $attndService.updateAttendance(attendanceInfos, function(res) {
                resolve();
            }, function (err) {
                Dialog.error("There is an error when saving attendance",  "Attendances cannot be saved and will be reloaded.", function() {
                    thiz.renderAttendanceTable();
                });
                reject(err);
            });
        }));
    }
    if (promiseAll.length == 0) return;
    Promise.all(promiseAll).then(function () {
        if (reload) {
            thiz.renderAttendanceTable();
        } else {
            thiz.attendanceChanged = false;
            thiz.attendanceNoteMap = Util.clone(thiz.editingAttendanceNoteMap);
        }
        SnackBar.show("Data was saved successfully");
        if (callback) callback(isUpdateAttendanceNote);
    });
};

TrackAttendanceContent.prototype.isDataChanged = function () {
    var attendanceNoteChanged = false;
    if (this.attendanceNoteMap && this.editingAttendanceNoteMap) {
        if (JSON.stringify(this.attendanceNoteMap) !== JSON.stringify(this.editingAttendanceNoteMap)) {
            attendanceNoteChanged = true;
        }
    }
    return this.attendanceChanged || attendanceNoteChanged;
};

TrackAttendanceContent.prototype.printAttendanceButtonClickedHandler = function () {
    var thiz = this;
    if (this.isDataChanged()) {
        Dialog.confirm("This attendance is being changed and hasn't been saved yet. Please save before going to print attendance", "",
        "Save and Print Attendance", function() {
            thiz.updateAttendanceHandler(function () {
                thiz.openPrintAttendanceDialog();
            });
        },
        "Print Attendance", function() {
            thiz.openPrintAttendanceDialog();
        });
    } else {
        thiz.openPrintAttendanceDialog();
    }
};

TrackAttendanceContent.prototype.openPrintAttendanceDialog = function () {
    var selectedClassSlot = this.classCombo.getSelectedItem();
    if(!selectedClassSlot) return;
    var thiz = this;
    var timeRange = this.timeRangePicker.getRange();
    if (timeRange.name != null) {
        var dateRangeData = this.getDateRangeData(timeRange);
        timeRange.from = dateRangeData.from;
        timeRange.to = dateRangeData.to;
    } else {
        timeRange.name = "custom";
    }
    var deletedSlot = null;
    if (this.selectedSlot.deleted) {
        deletedSlot = {};
        deletedSlot[this.selectedSlot.slot] = this.selectedSlot.id;
    }

    var id = selectedClassSlot.id,
        classId = id.substring(0, id.lastIndexOf("_")),
        slotId = id.substring(id.lastIndexOf("_") + 1, id.length),
        selectedClass = this.classObject[classId],
        selectedSlot = this.slotObject[slotId];
    var title = selectedClass.title? selectedClass.title : (selectedClass.detail? selectedClass.detail.title : "");
    new PrintAttendanceDialog().callback(function(data) {}).open({
        classList: [{
            id: selectedClass.id,
            title: title,
            slots: [selectedSlot],
            deletedSlot: deletedSlot,
            detail: selectedClass.detail? selectedClass.detail : selectedClass
        }],
        timeRange: timeRange,
        enableGroupAttendanceNote: thiz.options.enableGroupAttendanceNote,
        enableClassRooomAttendanceNote: thiz.options.enableClassRooomAttendanceNote,
        classRoomAttendanceNoteLabel: thiz.options.classRoomAttendanceNoteLabel
    });
};

TrackAttendanceContent.prototype.attendanceStatusClickedHandler = function (e) {



    var statusItem;
    if (Dom.hasClass(e.target, "StatusItem")) statusItem = e.target;
    if (Dom.hasClass(e.target.parentNode, "StatusItem")) statusItem = e.target.parentNode;
    if (!statusItem) return;
    if (!this.workingAttendance) return;
    if (!this.workingAttendance.statusElement) return;

    var slotInstance = this.workingAttendance.slotInstance;
    var attendanceInfo = this.savingAttendanceInfo[this.workingAttendance.memberId][slotInstance.slotInstanceId];
    if (!attendanceInfo) return;
    attendanceInfo.weekday = slotInstance.weekday;
    attendanceInfo.startMin = slotInstance.startMin;
    attendanceInfo.takenDate = slotInstance.takenDate;
    attendanceInfo.lessonClassSchedId = slotInstance.lessonClassSchedId;
    this.workingAttendance.statusElement.setAttribute("class", "");
    Dom.addClass(this.workingAttendance.statusElement, "AttendanceStatus");

    var currentMember = this.memberMap[this.workingAttendance.memberId];
    var currentState = -1;

    if (this.slotInstanceAttendances[slotInstance.slotInstanceId]
        && this.slotInstanceAttendances[slotInstance.slotInstanceId][this.workingAttendance.memberId]) {
        currentState = this.slotInstanceAttendances[slotInstance.slotInstanceId][this.workingAttendance.memberId].state;
    }
    if (AttendanceState.Present.value == currentState
        || AttendanceState.Tardy.value == currentState
        || AttendanceState.LeftEarly.value == currentState
        || AttendanceState.TardyLeftEarly.value == currentState) {
        if (currentMember.presentAttendance > 0) currentMember.presentAttendance --;
    }

    for (var i in this.attendanceStatus) {
        if (Dom.hasClass(statusItem, this.attendanceStatus[i].code)) {
            Dom.addClass(this.workingAttendance.statusElement, this.attendanceStatus[i].code);
            this.workingAttendance.statusElement.innerHTML = this.attendanceStatus[i].abbr;
            this.workingAttendance.statusElement.title = this.attendanceStatus[i].title;
            attendanceInfo.state = this.attendanceStatus[i].value;
            break;
        }
    }

    if (!this.slotInstanceAttendances[slotInstance.slotInstanceId]) this.slotInstanceAttendances[slotInstance.slotInstanceId] = {};
    if (!this.slotInstanceAttendances[slotInstance.slotInstanceId][this.workingAttendance.memberId])
        this.slotInstanceAttendances[slotInstance.slotInstanceId][this.workingAttendance.memberId] = {};
    this.slotInstanceAttendances[slotInstance.slotInstanceId][this.workingAttendance.memberId].state = attendanceInfo.state;

    if (AttendanceState.Present.value == attendanceInfo.state
        || AttendanceState.Tardy.value == attendanceInfo.state
        || AttendanceState.LeftEarly.value == attendanceInfo.state
        || AttendanceState.TardyLeftEarly.value == attendanceInfo.state) {
        currentMember.presentAttendance ++;
    }

    var attendedContent = document.getElementById("attendedContent_" + this.workingAttendance.memberId);
    if (attendedContent) {
        attendedContent.innerHTML = currentMember.presentAttendance + "/" + currentMember.availableAttendance;
    }

    this.attendanceChanged = true;
    this.workingAttendance = null;
    this.attendanceStatusPopup.close();
};
TrackAttendanceContent.prototype.getDateRangeData = function (timeRange) {
    if (!timeRange) return {};
    var dateRangeData = {
        from: new Date(),
        to: new Date(),
        isFullClass: false
    };
    var classTimezoneId = this.selectedClass.detail.timezoneId;
    if (!timeRange.name) {
        dateRangeData.from = ClassUtils.transformTimeZoneToTimeZone(timeRange.from, TimezoneProviders.team.getTimezoneId(), classTimezoneId);
        dateRangeData.to = ClassUtils.transformTimeZoneToTimeZone(timeRange.to, TimezoneProviders.team.getTimezoneId(), classTimezoneId);
        return dateRangeData;
    }
    var fromDate = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).hour(0).minute(0).second(0).millisecond(0);
    var toDate = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).hour(23).minute(59).second(59).millisecond(0);
    switch (timeRange.name) {
        case "today":
            break;
        case "next7days":
            toDate.add(6, 'd');
            break;
        case "next30days":
            toDate.add(30, 'd');
            break;
        case "thismonth":
            fromDate.date(1);

            toDate.date(1);
            toDate.add(1, 'M');
            toDate.add(-1, 'd');
            break;
        case "lastmonth":
            fromDate.date(1);
            fromDate.add(-1, 'M');

            toDate.date(1);
            toDate.add(-1, 'd');
            break;
        case "fullclass":
            dateRangeData.isFullClass = true;
            break;
        default:
            break;
    }
    dateRangeData.from = ClassUtils.transformTimeZoneToTimeZone(fromDate.toDate(), TimezoneProviders.team.getTimezoneId(), classTimezoneId);
    dateRangeData.to = ClassUtils.transformTimeZoneToTimeZone(toDate.toDate(), TimezoneProviders.team.getTimezoneId(), classTimezoneId);
    return dateRangeData;
};

TrackAttendanceContent.prototype.timeRangePickerChangedHandler = function () {
    this.renderAttendanceTable();
};

TrackAttendanceContent.prototype.renderLocationMapButton = function (event) {
    var selectedClass = this.classCombo.getSelectedItem();
    if (selectedClass && selectedClass.lessonLocId) {
        this.locationName.innerHTML = selectedClass.lessonLocName;
        Dom.show(this.locationMapButton);
    } else {
        Dom.hide(this.locationMapButton);
    }
};

TrackAttendanceContent.prototype.locationMapButtonClickedHandler = function () {
    var selectedClass = this.classCombo.getSelectedItem();
    if (!selectedClass) return;
    if (!selectedClass.googleMapLink || selectedClass.googleMapLink.length == 0) return;
    new LocationMapDialog().callback(function(event) {}).open({link: selectedClass.googleMapLink});
};

TrackAttendanceContent.prototype._dataTableInputHandler = function (event) {
    var groupingInput = Dom.findParentWithClass(event.target, "GroupingInput");
    if (groupingInput) {
        var rawData = DataTable.getRowData(groupingInput);
        if (!this.editingAttendanceNoteMap[rawData.classInId]) {
            this.editingAttendanceNoteMap[rawData.classInId] = {};
        }
        this.editingAttendanceNoteMap[rawData.classInId].grouping = groupingInput.value;
        return;
    }
    var classroomInput = Dom.findParentWithClass(event.target, "ClassroomInput");
    if (classroomInput) {
        var rawData = DataTable.getRowData(classroomInput);
        if (!this.editingAttendanceNoteMap[rawData.classInId]) {
            this.editingAttendanceNoteMap[rawData.classInId] = {};
        }
        this.editingAttendanceNoteMap[rawData.classInId].classroom = classroomInput.value;
        return;
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/TrackAttendanceDialog.js";

function TrackAttendanceDialog() {
    Dialog.call(this);
    this.grabHeight = true;
}

__extend(Dialog, TrackAttendanceDialog);

TrackAttendanceDialog.prototype.getInnerOffset = function () {
    return {
        h: 5 * Util.em()
    };
};

TrackAttendanceDialog.prototype.setup = function (options) {
    var thiz = this;
    this.title = "Track Attendance";
    this.options = options;
    this.options.isAttendanceDialog = true;
    this.trackAttendanceContent = new TrackAttendanceContent(options).into(this.containerWrapper);
    
};

TrackAttendanceDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Update",
            run: function () {
                thiz.updateButtonClickedHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                if (thiz.trackAttendanceContent.isDataChanged()) {
                    Dialog.confirm("Some attendances are changed and haven't been saved yet. Do you want to quit?", "",
                    "Close without saving", function() {
                        thiz.close();
                    },
                    "Cancel", function() {
                    });
                } else {
                    thiz.close();
                }
            }
        }
    ];

    return actions;
};

TrackAttendanceDialog.prototype.updateButtonClickedHandler = function () {
    this.trackAttendanceContent.updateAttendanceHandler(null, true);
};



if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/TrackSkillsDialog.js";

function TrackSkillsDialog() {
    Dialog.call(this);
    var thiz = this;
    this.grabHeight = true;
    
    this.bind("change", function () {
        if(thiz.showSlotDetail.checked) {
            Dom.removeClass(thiz.classInfoPane, "Hidden");
        } else {
            Dom.addClass(thiz.classInfoPane, "Hidden");
        }
        thiz.dataTable.invalidateFloatingHeader();
    }, this.showSlotDetail);
    
    this.bind("change", function () {
        if(thiz.useLogDate.checked) {
            if (thiz.logDate.getDate() == null) {
                var currentDate = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId()).hour(0).minute(0).second(0).millisecond(0);
                thiz.logDate.setDate(currentDate.toDate());
            }
        }
    }, this.useLogDate);
    
    this.defaultSkillColumns = [
        new DataTable.GenericColumn("Student", function (data) {
            return data.fullname;
        }).sortable("fullname").width("1*", "15em"),
        new DataTable.GenericColumn("Age", function (data) {
            return data.age;
        }).sortable("age").width("6em"),
        new DataTable.GenericColumn("Gender", function (data) {
            return data.gender;
        }).sortable("sex").width("8em"),
        new DataTable.GenericColumn("Account", function (data) {
            return data.accountName;
        }).sortable("accountName").width("1*", "15em")
    ];
    
    this.bind("click", this.skillTableClickedHandler ,this.skillTableWrapper);
    
}

__extend(Dialog, TrackSkillsDialog);

TrackSkillsDialog.prototype.getInnerOffset = function () {
    return {
        h: 5 * Util.em()
    };
};

TrackSkillsDialog.prototype.setup = function (options) {
    var thiz = this;
    this.title = "Track Skills";
    this.options = options;
    this.setDatePickerMinDate();
    if (!options) return;
    if (!options.classList) return;
    if (options.classList.length == 0) return;
    this.classObject = {};
    this.slotObject = {};
    var classComboItems = [];
    this.selectedClass = options.classList[0];
    this.selectedSlot = options.classList[0].slots[0];
    
    for (var i = 0; i < options.classList.length; i ++) {
        var classItem = options.classList[i];
        this.classObject[classItem.id] = classItem;
        if (classItem.slots && classItem.slots.length > 0) {
            for (var j = 0; j < classItem.slots.length; j ++) {
                var slot = classItem.slots[j];
                this.slotObject[slot.id] = slot;
                var comboItem = {
                    id: classItem.id + "_" + slot.id,
                    name: classItem.title + " | Reg Slot #" + slot.slotOrder,
                };
                classComboItems.push(comboItem);
            }
        }        
    }
    
    this.classCombo.renderer = function(item, selected) {
        if(!item) return "";
        return "" + item.name;
    };    
    this.classCombo.setItems(classComboItems);
    this.renderTrackSkillDialog(this.selectedClass, this.selectedSlot);
    this.bind("p:ItemSelected", this.classComboChangedHandler, this.classCombo.node());
};

TrackSkillsDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Update",
            run: function () {
                thiz.updateButtonClickedHandler(function () {
                    thiz.renderSkillTable();
                });
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { 
                if (thiz.isDataChanged()) {
                    Dialog.confirm("All changes are not saved. Do you want to quit?", null, "Close without saving", function () {
                         thiz.close();
                    },
                    "Cancel", function () {
                    }, null, null);
                } else {
                    return true;
                }
                
            }
        }
    ];

    return actions;
};

TrackSkillsDialog.prototype.renderTrackSkillDialog = function (classItem, slotItem) {
    if(!classItem) return;
    var thiz = this;
    this.programName.innerHTML = classItem.progName;
    this.subProgramName.innerHTML = classItem.subProgName;
    this.duration.innerHTML = classItem.duration + "m";
    if (slotItem.instructorNames && slotItem.instructorNames.length > 0) {
        this.instructorNames.innerHTML = slotItem.instructorNames.join(", ");
        this.instructorNames.title = slotItem.instructorNames.join(", ");
        Dom.show(this.instructorNames.parentNode);
    } else {
        Dom.hide(this.instructorNames.parentNode);
    }
    this.regSlotWrapper.innerHTML = "";
    if (slotItem) {
        this.regSlotWrapper.parentNode.style.display = "flex";
        LOCALE.WEEKDAYS_SHORT.forEach(function (wd) {
            var sched = slotItem.schedByWeekdayName[wd];
            if (!sched) return;
            var divSlotContent = document.createElement("div");
            divSlotContent.innerHTML = sched.weekdayName + " " + sched.startTime;
            thiz.regSlotWrapper.appendChild(divSlotContent);
        });
    } else {
        this.regSlotWrapper.parentNode.style.display = "none";
    }
};

TrackSkillsDialog.prototype.onShown = function () {
    var thiz = this;
    var changeOrder = {
        changeOrder: function (currentOrder) {
            thiz.dataTable.setOrder(currentOrder);
            if (currentOrder && (currentOrder.propertyName == "fullname" || currentOrder.propertyName == "accountName")) {
                thiz.dataTable.getItems().sort(function (a, b) {
                    var nameA = a[currentOrder.propertyName].toLowerCase(),
                    nameB = b[currentOrder.propertyName].toLowerCase();
                    if (currentOrder.asc) {
                        if (nameA < nameB) {
                            return -1;
                        }
                        if (nameA > nameB) {
                            return 1;
                        }
                        return 0;
                    } else {
                        if (nameA < nameB) {
                            return 1;
                        }
                        if (nameA > nameB) {
                            return -1;
                        }
                        return 0;
                    }
                });
            } else if (currentOrder && (currentOrder.propertyName == "age" || currentOrder.propertyName == "sex")) {
                thiz.dataTable.getItems().sort(function (a, b) {
                    if(currentOrder.asc) {
                        return a[currentOrder.propertyName] - b[currentOrder.propertyName];
                    } else {
                        return b[currentOrder.propertyName] - a[currentOrder.propertyName];
                    }
                });
            }
            thiz.dataTable.setItems(thiz.dataTable.getItems());
        }
    }
    this.dataTable.addOrderRequestListener(changeOrder);
    this.dataTable.useFloatingHeader = true;
    this.renderSkillTable();
};

TrackSkillsDialog.prototype.renderSkillTable = function () {
    if (!this.selectedClass) return;
    if (!this.selectedSlot) return;
    this.skillsChanged = false;
    var thiz = this;
    var params = {
        classes: [{classId: this.selectedClass.id, slots: [this.selectedSlot.slot]}],
        from: null,
        isFullClass: true,
        to: null,
        type: 0
    };
    window.defaultIndicator.busy("Loading...");
    $attndService.buildTrackingSkill(params, function (res) {
        thiz.dataTable.columns = [];
        thiz.dataTable.actualColumns = [];
        thiz.savingTrackSkillInfo = {};
        thiz.pastSkill = {};
        for (var i = 0; i < thiz.defaultSkillColumns.length; i ++) {
            thiz.dataTable.column(thiz.defaultSkillColumns[i]);
        }
        var result = {
            members: []
        };
        if (res && res.ranges && res.ranges.length > 0) {
            result = res.ranges[0];
            thiz.skilledMembers = res.skilledMembers;
            if (result.members.length > 0) {
                var order = {
                    propertyName: "fullname",
                    asc: true
                };
                if (result.members && result.members.length > 0) {
                    result.members.sort(function (a, b) {
                        var nameA = a[order.propertyName].toLowerCase(),
                        nameB = b[order.propertyName].toLowerCase();
                        if (nameA < nameB) {
                            return -1;
                        }
                        if (nameA > nameB) {
                            return 1;
                        }
                        return 0;
                    });
                }
                  
                if (result.skillItems && result.skillItems.length > 0) {
                    for (var i = 0; i < result.skillItems.length; i ++) {
                        thiz.createSkillColumn(result.skillItems[i]);
                    }    
                }
            }
        }
        
        thiz.dataTable.setup();
        thiz.dataTable.setItems(result.members);
        thiz.dataTable.setOrder(order);
        
        if (thiz.pastSkill) {
            for (var key in thiz.pastSkill) {
                Dom.doOnSelector(thiz.skillTableWrapper, (".Skill-" + key), function(col) {
                    Dom.addClass(col, "HasPastSkill");
                });
            }
        }
        
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    }, function (err) {
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    });
};

TrackSkillsDialog.prototype.createSkillColumn = function (skillItem) {
    if (!skillItem) return;
    var thiz = this;
    var col = new DataTable.GenericDomColumn(skillItem.skillName , function (data) {
        var content = document.createElement("hbox"),
            testDateWrapper = document.createElement("div"),
            testDate = document.createElement("div"),
            note = document.createElement("div"),
            attainedWrapper = document.createElement("div"),
            attained = document.createElement("div");
            
        Dom.addClass(content, "SkillItem");
        Dom.addClass(content, "Skill-" + skillItem.skillItemId);
        testDateWrapper.setAttribute("flex", 1);
        attainedWrapper.setAttribute("flex", 1);
        Dom.addClass(attained, "Attained");
        
        Dom.addClass(testDate, "TestDate");
        Dom.addClass(note, "Note");
        
        // var noteIcon = document.createElement("icon");
        // Dom.addClass(noteIcon, "message-text-outline");
        // note.appendChild(noteIcon);
        
        var attainedIcon = document.createElement("icon");
        
        Dom.addClass(attainedIcon, "AttainedStatus");
        attained.appendChild(attainedIcon);
        
        
        if (thiz.skilledMembers && thiz.skilledMembers[thiz.selectedClass.id + "_" + skillItem.skillItemId] 
            && thiz.skilledMembers[thiz.selectedClass.id + "_" + skillItem.skillItemId][data.id]
            && thiz.skilledMembers[thiz.selectedClass.id + "_" + skillItem.skillItemId][data.id].state == 1) {
            Dom.addClass(attainedIcon, "checkbox-marked-circle-outline");    
            var loggedDate = thiz.skilledMembers[thiz.selectedClass.id + "_" + skillItem.skillItemId][data.id].loggedDate;
            if (loggedDate) {
                var testDateIconWrapper = document.createElement("div");
                Dom.addClass(testDateIconWrapper, "DateIconWrapper");
                var testDateIcon = document.createElement("icon");
                Dom.addClass(testDateIcon, "calendar");
                testDateIconWrapper.title = FormatUtil.formatDateWithTZID(loggedDate, "date_standard", thiz.selectedClass.timezoneId);
                testDateIconWrapper.appendChild(testDateIcon);
                testDate.appendChild(testDateIconWrapper);
                thiz.pastSkill[skillItem.skillItemId] = true;
            }
        } else {
            Dom.addClass(attainedIcon, "checkbox-blank-circle-outline");
        }
            
        testDateWrapper.appendChild(testDate);
        testDateWrapper.appendChild(note);
        attainedWrapper.appendChild(attained);
        content.appendChild(testDateWrapper);
        content.appendChild(attainedWrapper);
        return content;
    }, "SkillItem").width("1*", "10em");    
    
    col._skillItem = skillItem;
    this.dataTable.column(col);
};

TrackSkillsDialog.prototype.classComboChangedHandler = function () {
    var thiz = this;
    if (this.isDataChanged()) {
        Dialog.confirm("This skills is being changed and hasn't been saved yet. Please save to continue", "",
        "Save Skills", function() {
            thiz.updateButtonClickedHandler(function () {
                thiz.goToSlotSkills();
            });
        },
        "Discard Change", function() {
            thiz.goToSlotSkills();
        });
    } else {
        this.goToSlotSkills();
    }
};

TrackSkillsDialog.prototype.goToSlotSkills = function () {
    var selectedClassSlot = this.classCombo.getSelectedItem();
    if (!selectedClassSlot) return;
    var id = selectedClassSlot.id;
    var classId = id.substring(0, id.lastIndexOf("_"));
    var slotId = id.substring(id.lastIndexOf("_") + 1, id.length);
    this.selectedClass = this.classObject[classId];
    this.selectedSlot = this.slotObject[slotId];
    this.renderTrackSkillDialog(this.selectedClass, this.selectedSlot);
    this.renderSkillTable();
};

TrackSkillsDialog.prototype.skillTableClickedHandler = function (e) {
    if (Dom.hasClass(e.target, "AttainedStatus")) {
        var memberData = DataTable.getRowData(e.target);
        var cell = Dom.findParentWithAttribute(e.target, "column-id");
        if (!cell) return;
        var colId = cell.getAttribute("column-id");
        var column = null;
        this.dataTable.columns.forEach(function (c) {
            if (c.id == colId) column = c;
        });
        if (!column) return;
        var skillItem = column._skillItem;
        if (!skillItem) return;
        
        if (!this.savingTrackSkillInfo[memberData.id]) {
            this.savingTrackSkillInfo[memberData.id] = {};
        }
        if (!this.savingTrackSkillInfo[memberData.id][skillItem.skillItemId]) {
            this.savingTrackSkillInfo[memberData.id][skillItem.skillItemId] = {};
        }
        
        var skillInfo = this.savingTrackSkillInfo[memberData.id][skillItem.skillItemId];
        skillInfo.skillId = skillItem.skillId;
        skillInfo.regIdx = memberData.regIdx;
        skillInfo.classInIdx = memberData.classInIdx;
        if (Dom.hasClass(e.target, "checkbox-marked-circle-outline")) {
            skillInfo.state = 0;
            Dom.removeClass(e.target, "checkbox-marked-circle-outline");
            Dom.addClass(e.target, "checkbox-blank-circle-outline");
        } else {
            skillInfo.state = 1;
            Dom.addClass(e.target, "checkbox-marked-circle-outline");
            Dom.removeClass(e.target, "checkbox-blank-circle-outline");
        }
        this.skillsChanged = true;
    }
};

TrackSkillsDialog.prototype.updateButtonClickedHandler = function (callback) {
    if (!this.savingTrackSkillInfo) return;
    var thiz = this;
    var skilledMembers = [];
    var newDate = moment.tz(new Date(), TimezoneProviders.team.getTimezoneId());
    var logDate = newDate;
    if (thiz.useLogDate.checked) {
        logDate = thiz.logDate.getDate() ? thiz.logDate.getDate() : newDate;
    }
    for (var memberId in this.savingTrackSkillInfo) {
        for (var skillItemId in this.savingTrackSkillInfo[memberId]) {
            var skillItem = this.savingTrackSkillInfo[memberId][skillItemId];
            if (!skillItem) continue;
            var skilledMember = {
                memberId: parseInt(memberId),
                skillItemId: parseInt(skillItemId),
                skillId: skillItem.skillId,
                loggedDate: logDate,
                classId: thiz.selectedClass.id,
                state: skillItem.state,
                regIdx: skillItem.regIdx,
                classInIdx: skillItem.classInIdx
            };
            skilledMembers.push(skilledMember);
        }
    }
    if (skilledMembers.length == 0) {
        Dialog.error("There are no item changed.", "", function() {});
        return;
    }
    
    window.defaultIndicator.busy("Updating...");
    $attndService.updateSkill(skilledMembers, function (res) {
        if (callback) callback();
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    }, function (err) {
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    });
    
};

TrackSkillsDialog.prototype.setDatePickerMinDate = function () { 
    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.logDate.setMinDate(minDate);
};

TrackSkillsDialog.prototype.isDataChanged = function () {
    return this.skillsChanged;
};






if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ViewAgreementDialog.js";

function ViewAgreementDialog() {
    Dialog.call(this);
    this.bind("click", this.countClickedHandler, this.signedCount);
    this.bind("click", this.notSigncountClickedHandler, this.notSignedCount);
}
__extend(Dialog, ViewAgreementDialog);

ViewAgreementDialog.prototype.asyncSetup = function (options, dialogCallback) {
    var thiz = this;
    this.options = options;
    if (!options.agreementKey) return;
    $classAdminService.getAgreementDetailByKey(options.agreementKey, options.classId, function (agreementData) {
        thiz.agreementData = agreementData;
        thiz.renderViewAgreementDialog();
        dialogCallback();
    }, function (err) {dialogCallback();});
};

ViewAgreementDialog.prototype.renderViewAgreementDialog = function () {
    if (!this.agreementData) return;
    this.title = this.agreementData.classTitle + " Agreements";
    this.agreementTitle.innerHTML = this.agreementData.title;
    this.enabled.innerHTML = this.agreementData.enabled ? "Yes" : "No";
    this.agreementType.innerHTML = this.agreementData.agreementType.toLowerCase();
    this.savedOn.innerHTML = FormatUtil.formatDate(this.agreementData.lastModifiedAt, "date_named", "local");
    this.agreementDescription.innerHTML = this.agreementData.description;
    this.signedCount.innerHTML = this.agreementData.classSignedCount;
    this.notSignedCount.innerHTML = this.agreementData.classNotSignedCount;

};

ViewAgreementDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

ViewAgreementDialog.prototype.countClickedHandler = function (event) {
    this.memberPopupContent.innerHTML = "";
    if (!this.agreementData) return;
    var _children = [];
    for (var i = 0; i < this.agreementData.members.length; i++) {
        _children.push({
            _name: "div",
            "class": "MemberItem",
            _html: "<icon class=\"circle\"></icon>" + this.agreementData.members[i].name
        });
    }
    if (_children.length > 0) {
        var memberEl = Dom.newDOMElement({
            _name: "div",
            _children: _children
        });
        this.memberPopupContent.appendChild(memberEl);
        this.memberPopup.show(event.target, "right-inside", "top", 0, 5, true);
    }
};


ViewAgreementDialog.prototype.notSigncountClickedHandler = function (event) {
    this.memberPopupContent.innerHTML = "";
    if (!this.agreementData) return;
    var _children = [];
    for (var i = 0; i < this.agreementData.notSignedMembers.length; i++) {
        _children.push({
            _name: "div",
            "class": "MemberItem",
            _html: "<icon class=\"circle\"></icon>" + this.agreementData.notSignedMembers[i].name
        });
    }
    if (_children.length > 0) {
        var memberEl = Dom.newDOMElement({
            _name: "div",
            _children: _children
        });
        this.memberPopupContent.appendChild(memberEl);
        this.memberPopup.show(event.target, "right-inside", "top", 0, 5, true);
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/ViewRatePlanDialog.js";

function ViewRatePlanDialog() {
    Dialog.call(this);
    var thiz = this;
}

__extend(Dialog, ViewRatePlanDialog);

ViewRatePlanDialog.prototype.asyncSetup = function(options, dialogCallback) {
    this.title = "Rate Chart";
    var ratePlanId = options.ratePlanId;
    var thiz = this;
    $classBillByHourService.getRatePlan(ratePlanId, function (res) {
        var ratePlanOptions = {
            ratePlanName: res.name,
            ratePlanItems: res.items
        };
        thiz.ratePlanContent.innerHTML = "";
        new RateChartItemsTable(ratePlanOptions).into(thiz.ratePlanContent);
        dialogCallback();
    }, function (err) {
        dialogCallback();
    });
};

ViewRatePlanDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/WaitingExportDialog.js";

function WaitingExportDialog() {
	Dialog.call(this);
    this.title = "Export to Excel";
}
__extend(Dialog, WaitingExportDialog);

WaitingExportDialog.prototype.setup = function(jobId) {
    this.onJobStatus(jobId, "Error when exporting.", function (fileUrl) {
        Util.initiateDownload(fileUrl);
    });
}

WaitingExportDialog.prototype.onJobStatus = function (jobId, defaultErrMsg, callback) {
    var thiz = this;
    var onFailed = function (error) {
        thiz.close();
        Dialog.error(error && error.message || defaultErrMsg);
    };
    if (!jobId || jobId.length == 0) {
        onFailed();
        return;
    }
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        thiz.close();
                        callback(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        onFailed({message: (job && job.errorMessage) || "Job execution error."});
                    }
                } else {
                    onFailed(null, {message: "Job not found."});
                }
            }, function (error) {
                onFailed(error);
            });
        }, 1500);
    })();
};

WaitingExportDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/admin/WaiverDetailDialog.js";

function WaiverDetailDialog() {
    Dialog.call(this);
    var thiz = this;
    
    
}

__extend(Dialog, WaiverDetailDialog);

WaiverDetailDialog.prototype.setup = function(options) {
    this.title = "Waiver";
    if(!options.waiverData) return;
    this.waiverTitle.innerHTML = options.waiverData.agreeTitle;
    this.waiverAgreementType.innerHTML = options.waiverData.agreeOptional == 1 ? "Required" : "Optional";
    this.waiverMessage.innerHTML = options.waiverData.agreeMessage;
};

WaiverDetailDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};



if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/AddAccountDialog.js";

function AddAccountDialog() {
    ModificationWatchDialog.call(this);
    this.bind("click", this.guardianCollapseExpandActionClikedHandler, this.guardianCollapseExpandAction);
    this.bind("click", this.insuranceEmergencyActionClikedHandler, this.insuranceEmergencyAction);
    this.loadState = TEAM_INFO.country == "US" || TEAM_INFO.country == "CA" || TEAM_INFO.country == "AU";
}

__extend(ModificationWatchDialog, AddAccountDialog);

AddAccountDialog.prototype.asyncSetup = function (options, postCallback) {
    var thiz = this;
    this.title = "Add New Account";
    this.options = options;
    this.emailLoginInstructions.checked = true;
    
    widget.__ensureNamespaceLoaded("util", function(utilModule) {
        widget.__ensureNamespaceLoaded("ama", function(amaModule) {
            thiz.smsEnabled = amaModule.ModuleData.SMS_ENABLED;
            thiz.isAccountSMSCarrierRequired = amaModule.ModuleData.ACCOUNT_SMS_CARRIER_REQUIRED;
            if (thiz.smsEnabled) {
                Dom.addClass(thiz.smsWrapper, "Active");
                Dom.toggleClass(thiz.smsWrapper, "Required", thiz.isAccountSMSCarrierRequired);
            };
            thiz.initValidationRules();

            postCallback();
        }, function(err) {
            thiz.close();
        }, "Loading...");
    }, function(err) {
        thiz.close();
    }, "Loading...");
};

AddAccountDialog.prototype.initStateProvinces = function() {
    console.log('initStateProvinces for ', TEAM_INFO.country);
    if(this.loadState) {
        var thiz = this;
        this.state.remove();
        $amaService.listStates(function(items) {
            thiz.stateCombo.comparer = function(a, b) {
               return a.key == b.key;
            };
            thiz.stateCombo.renderer = function(data) {
               return data.value || "";
            };
            thiz.stateCombo.setItems(items);
        }, "Loading..");
    } else {
        this.stateCombo.node().remove();
    }
};

AddAccountDialog.prototype.getStateValue = function() {
    if(this.loadState) {
        return this.stateCombo.getSelectedItem().key;
    } else {
        return this.state.value.trim();
    }
};

AddAccountDialog.prototype.onShown = function() {
}
AddAccountDialog.prototype.onBeforeShow = function (options) {
    this.ssoEnabled = typeof(ADMIN_CONTEXT) != "undefined" ? ADMIN_CONTEXT.sessoEnabled : (typeof(TEAM_INFO) != "undefined" && TEAM_INFO.ssoEnabled);
    Dom.toggleClass(this.containerWrapper, "SSOEnabled", this.ssoEnabled);
    this.initStateProvinces();
    if (this.options) {
        if (this.options.insuranceOptions == 2 && this.options.emergencyOptions == 2) {
            Dom.addClass(this.insuranceEmergencyPane, "Hidden");
        } else {
            Dom.removeClass(this.insuranceEmergencyPane, "Hidden");
        }
        if (this.options.insuranceOptions == 1 || this.options.emergencyOptions == 1) {
            Dom.addClass(this.insuranceEmergencyPane, "Expanded");
        } else {
            Dom.addClass(this.insuranceEmergencyPane, "Collapsed");
        }
                
        if (this.options.insuranceOptions == 0) {
            Dom.addClass(this.insurancePane, "Optional");
        } else if (this.options.insuranceOptions == 1) {
            Dom.addClass(this.insurancePane, "Required");

            this.validationRules.required(this.insuranceCarrier, "Please enter the Insurance Carrier.")
                                .required(this.insurancePhone, "Please enter the Insurance Phone.");
        } else if (this.options.insuranceOptions == 2) {
            Dom.addClass(this.insurancePane, "Hidden");
        }
        
        if (this.options.emergencyOptions == 0) {
            Dom.addClass(this.emergencyPane, "Optional");
        } else if (this.options.emergencyOptions == 1) {
            Dom.addClass(this.emergencyPane, "Required");
            this.validationRules.required(this.emergencyContact, "Please enter the Emergency Contact.")
                                .required(this.emergencyPhone, "Please enter the Emergency Phone.");
        } else if (this.options.emergencyOptions == 2) {
            Dom.addClass(this.emergencyPane, "Hidden");
        }       
        
        this.invalidateSizing();
    }
};

AddAccountDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.saveButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                if (this.modified) {
                    Dialog.confirm("Discard changes?", "Are you sure you want to discard the unsaved changes?", "Discard changes", function () {
                        thiz.close();
                    }, "Cancel");
                } else {
                    return true;
                }
            }
        }
    ];

    return actions;
};

AddAccountDialog.prototype.initValidationRules = function() {
    var thiz = this;
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.emailForSignIn, "Please enter the Login Email.")
        .pattern(this.emailForSignIn, ValidationManager.patterns.EMAIL_REGEX, "Please enter a valid email address")
        .required(this.retypeEmail, "Please enter the Re-type Email.")
        .pattern(this.retypeEmail, ValidationManager.patterns.EMAIL_REGEX, "Please enter a valid email address")
        //.required(this.birthday, "Please enter the Birthday.")
        .required(this.firstName, "Please enter the First Name.")
        .required(this.lastName, "Please enter the Last Name.")
        .required(this.billingAddress, "Please enter the Billing Address.")
        .required(this.city, "Please enter the City.")
        .required(this.zipCode, "Please enter the " + "Zip Code" + ".")
        .required(this.homePhone, "Please enter the Home Phone.");

    if(this.loadState) {
        this.validationRules.custom(new RequiredRule(
            this.stateCombo, "Please enter the '" + "state" + "."), function(rule) {
                return thiz.stateCombo.getSelectedItem().key != '';
        });
    } else {
        this.validationRules.required(this.state, "Please enter the '" + "state" + ".");
    }
    this.validationRules.custom(new GenericRule(thiz.retypeEmail, function() {
        return thiz.retypeEmail.value == thiz.emailForSignIn.value;
    }, "Email addresses don't match."));


    widget.__ensureNamespaceLoaded("util", function (ns) {
        thiz.phoneUtil = ns.phoneUtil;
        var rules = [];
        rules = rules.concat(ns.phoneUtil.getRequiredSMSValidationRules("Home Phone", thiz.homePhone));
        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Work/Mobile Phone", thiz.workMobilePhone));

        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Home Phone", thiz.guardian1HomePhone));
        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Work Phone", thiz.guardian1WorkPhone));
        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Mobile Phone", thiz.guardian1MobilePhone));

        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Home Phone", thiz.guardian2HomePhone));
        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Work Phone", thiz.guardian2WorkPhone));
        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Mobile Phone", thiz.guardian2MobilePhone));

        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Insurance Phone", thiz.insurancePhone));
        rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Emergency Phone", thiz.emergencyPhone));

        if (thiz.smsEnabled) {
            rules = rules.concat(ns.phoneUtil.buildSmsValidationRules("Mobile\/SMS", thiz.smsInput, thiz.isAccountSMSCarrierRequired));
        }

        rules.forEach(function(rule) {
            thiz.validationRules.custom(rule);
        });
    });

};

AddAccountDialog.prototype.guardianCollapseExpandActionClikedHandler = function () {
    var thiz = this;
    if (this.clickingCollapseExpandAction) {
        clearTimeout(this.clickingCollapseExpandAction);
    }
    this.clickingCollapseExpandAction = window.setTimeout(function () {
        if (Dom.hasClass(thiz.guardianPane, "Expanded")) {
            Dom.removeClass(thiz.guardianPane, "Expanded");
            Dom.addClass(thiz.guardianPane, "Collapsed");
        } else {
            Dom.removeClass(thiz.guardianPane, "Collapsed");
            Dom.addClass(thiz.guardianPane, "Expanded");
        }
        thiz.invalidateSizing();
    }, 100);
};

AddAccountDialog.prototype.insuranceEmergencyActionClikedHandler = function () {
    var thiz = this;
    if (this.clickingInsuranceEmergencyAction) {
        clearTimeout(this.clickingInsuranceEmergencyAction);
    }
    this.clickingInsuranceEmergencyAction = window.setTimeout(function () {
        if (Dom.hasClass(thiz.insuranceEmergencyPane, "Expanded")) {
            Dom.removeClass(thiz.insuranceEmergencyPane, "Expanded");
            Dom.addClass(thiz.insuranceEmergencyPane, "Collapsed");
        } else {
            Dom.removeClass(thiz.insuranceEmergencyPane, "Collapsed");
            Dom.addClass(thiz.insuranceEmergencyPane, "Expanded");
        }
        thiz.invalidateSizing();
    }, 100);
};


AddAccountDialog.prototype.saveButtonClickHandler = function () {
    if (!ValidationManager.run(this.validationRules)) return;
    var data = this.getAccountData();
    var thiz = this;
    $classToolService.saveAccount(this.emailLoginInstructions.checked, data, function (res) {
        thiz.close(res);
    }, function (error) {
        Dialog.error(error.message);
    }, new Spinner("Loading..."));
};

AddAccountDialog.prototype.getAccountData = function () {
    var accountData = {
        id: -1,
        email: this.emailForSignIn.value,
        firstName: this.firstName.value,
        lastName: this.lastName.value,
        address: this.billingAddress.value,
        city: this.city.value,
        state: this.getStateValue(),
        zip: this.zipCode.value,
        homePhone: this.phoneUtil.getPhoneNumberFromInput(this.homePhone.value.trim()),
        workPhone: this.phoneUtil.getPhoneNumberFromInput(this.workMobilePhone.value.trim()),
        guard1FirstName: this.guardian1FirstName.value,
        guard1LastName: this.guardian1LastName.value,
        guard1HomePhone: this.phoneUtil.getPhoneNumberFromInput(this.guardian1HomePhone.value.trim()),
        guard1WorkPhone: this.phoneUtil.getPhoneNumberFromInput(this.guardian1WorkPhone.value.trim()),
        guard1MedicalPhone: this.phoneUtil.getPhoneNumberFromInput(this.guardian1MobilePhone.value.trim()),

        guard2FirstName: this.guardian2FirstName.value,
        guard2LastName: this.guardian2LastName.value,
        guard2HomePhone: this.phoneUtil.getPhoneNumberFromInput(this.guardian2HomePhone.value.trim()),
        guard2WorkPhone: this.phoneUtil.getPhoneNumberFromInput(this.guardian2WorkPhone.value.trim()),
        guard2MedicalPhone: this.phoneUtil.getPhoneNumberFromInput(this.guardian2MobilePhone.value.trim()),

        medicalCarrier: this.insuranceCarrier.value,
        medicalCarrierPhone: this.phoneUtil.getPhoneNumberFromInput(this.insurancePhone.value.trim()),
        emergencyContact: this.emergencyContact.value,
        emergencyPhone: this.phoneUtil.getPhoneNumberFromInput(this.emergencyPhone.value.trim()),

        sms1: this.smsEnabled ? this.phoneUtil.getPhoneNumberFromInput(this.smsInput.value.trim()) : ""
    };
    
    return accountData;
};

AddAccountDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/AddMemberDialog.js";

function AddMemberDialog() {
    ModificationWatchDialog.call(this);

    this.genderCombo.renderer = function (data) {
        if (!data) return "";
        return "" + data.name;
    };
    this.shirtSizeCombo.renderer = function (data) {
        if (!data) return "--Select--";
        return "" + data.name;
    };
    this.jacketSizeCombo.renderer = function (data) {
        if (!data) return "--Select--";
        return "" + data.name;
    };
    this.pantsSizeCombo.renderer = function (data) {
        if (!data) return "--Select--";
        return "" + data.name;
    };
    this.competitiveCategoryCombo.renderer = function (data) {
        if (!data) return "";
        return data.name;
    };

    this.dateAgeUp = new Date();

    var thiz = this;
    this.bind("click", this.newAccountButtonClickedHandler, this.newAccountButton);
    this.bind("click", this.searchAccountButtonClickedHandler, this.searchAccountButton);
    this.bind("click", this.moreDetailsCollapseExpandActionClickedHandler, this.moreDetailsCollapseExpandAction);
    this.bind("p:ValueUpdated", function() {
        thiz.age.value = thiz.getAge(thiz.birthday.getDate(), thiz.dateAgeUp);
    }, this.birthday.node());

    this.bind("input", function(event) {
        thiz.tryFormatDateInput();
    }, this.birthday.node().querySelector("input"));

    this.bind("blur", function () {
        thiz.tryFormatDateInput();
    }, this.birthday.node().querySelector("input"));
    
    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.birthday.setMinDate(minDate);

    this.initValidationRules();
}

__extend(ModificationWatchDialog, AddMemberDialog);

AddMemberDialog.prototype.setup = function (options) {
    var thiz = this;
    this.title = "Add New Member";
    this.options = options;
    this.ageLabel.innerHTML = FormatUtil.formatDate(this.dateAgeUp, "date_standard", "local");
    if (this.options && this.options.accountObject) {
        this.accountObject = this.options.accountObject;
        this.memberOfAccount.value = this.accountObject.firstName + " " + this.accountObject.lastName;
    }

    if (this.options && this.options.memberConfiguration) {
        var genders = this.options.memberConfiguration.genders;
        this.genderCombo.setItems(genders);
        var shirtSizes = this.options.memberConfiguration.shirtSizes;
        shirtSizes.splice(0, 0, null);
        this.shirtSizeCombo.setItems(shirtSizes);
        this.jacketSizeCombo.setItems(shirtSizes);
        this.pantsSizeCombo.setItems(shirtSizes);
        if (this.options.memberConfiguration.isCompetitiveCategoryEnabled) {
            var competitiveCategories = this.options.memberConfiguration.competitiveCategories || [];
            this.competitiveCategoryCombo.setItems(competitiveCategories);
            Dom.addClass(this.competitveCategoryEntry, "CompetitveCategoryEnabled");
        }
    }

};

AddMemberDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.saveButtonClickHandler();
            }
        },
        {
            type: "accept", title: "Save & Create Another",
            run: function () {
                thiz.saveAndNewButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                if (this.modified) {
                    Dialog.confirm("Discard changes?", "Are you sure you want to discard the unsaved changes?", "Discard changes", function () {
                        thiz.close();
                    }, "Cancel");
                } else {
                    return true;
                }
            }
        }
    ];
    return actions;
};

AddMemberDialog.prototype.newAccountButtonClickedHandler = function () {
    var options = {
        insuranceOptions: this.options.insuranceOptions
    };
    var thiz = this;
    new AddAccountDialog().callback(function (data) {
        if (data && data.id > 0) {
            var account = {
                id: data.id,
                email: data.email,
                firstName: data.firstName,
                lastName: data.lastName
            };
            thiz.memberOfAccount.value = account.firstName + " " + account.lastName;
            thiz.accountObject = account;
            ValidationManager.run(new RuleSet().live(true).required(thiz.memberOfAccount, "Please enter the Account."));
        }

    }).open(options);
};

AddMemberDialog.prototype.searchAccountButtonClickedHandler = function () {
    var thiz = this;
    var options = {};
    new SearchAccountDialog().callback(function (data) {
        if (data) {
            thiz.memberOfAccount.value = data.firstName + " " + data.lastName;
            thiz.accountObject = data;
            ValidationManager.run(new RuleSet().live(true).required(thiz.memberOfAccount, "Please enter the Account."));
        }
    }).open(options);
};

AddMemberDialog.prototype.saveButtonClickHandler = function () {
    var thiz = this;
    if (!ValidationManager.run(this.validationRules)) return;
    var params = this.getMemberData();
    $classToolService.saveMember(params, function (res) {
        if (!thiz.addedMembers) thiz.addedMembers = [];
        thiz.addedMembers.push(res);
        SnackBar.show(res.first_name + " " + res.last_name + " was saved.");
        thiz.close(res);
    }, function (error) {
        Dialog.error(error.message);
    }, new Spinner("Loading..."));
};

AddMemberDialog.prototype.saveAndNewButtonClickHandler = function () {
    var thiz = this;
    if (!ValidationManager.run(this.validationRules)) return;
    var params = this.getMemberData();
    $classToolService.saveMember(params, function (res) {
        thiz.isAddedMember = true;
        if (!thiz.addedMembers) thiz.addedMembers = [];
        thiz.addedMembers.push(res);
        SnackBar.show(res.first_name + " " + res.last_name + " was saved.");
        thiz.resetMemberForm();
    }, function (error) {
        Dialog.error(error.message);
    }, new Spinner("Loading..."));
};

AddMemberDialog.prototype.tryFormatDateInput = function() {
    return __pkg.util.tryFormatDateInput(this.birthday);
};

AddMemberDialog.prototype.initValidationRules = function() {
    var thiz = this;

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.memberOfAccount, "Please enter the Account.")
        .required(this.firstName, "Please enter the Legal First Name.")
        .required(this.lastName, "Please enter the Legal Last Name.")
        .required(this.genderCombo, "Please enter the Gender.")
        .required(this.birthday, "Please enter the Birthday.")
        .custom(new GenericRule(this.birthday, function() {
            var today = new Date();
            return this.birthday.getDate() <= today;
        }.bind(this), "Birthday" + " cannot exceed today."))
        .custom(new GenericRule(this.birthday, function() {
            var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
            return this.birthday.getDate() > minDate;
        }.bind(this), "Birthday" + " is not valid."));

        widget.__ensureNamespaceLoaded("util", function (ns) {
            thiz.phoneUtil = ns.phoneUtil;
            var rules = [];
            rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Athelete's Cell Phone", thiz.atheleteCellPhone));
            rules = rules.concat(ns.phoneUtil.getSMSValidationRules("Physician Office Phone", thiz.physicianOfficePhone));
            rules.forEach(function(rule) {
                thiz.validationRules.custom(rule);
            });
        });

};

AddMemberDialog.prototype.getAge = function (birthday, fromDate, unit) {
    if (!birthday) return 0;
    fromDate = fromDate || new Date();
    if (1 == unit) {
        var months = 0;
        if (fromDate.getFullYear() >= birthday.getFullYear()) {
            months = (fromDate.getMonth() + (12 - birthday.getMonth())) + (fromDate.getFullYear() - 1 - birthday.getFullYear()) * 12;
            months -= (fromDate.getDate() < birthday.getDate() ? 1 : 0);
        }
        return Math.max(0, months);
    }
    var thisYear = 0;
    if (fromDate.getMonth() < birthday.getMonth()) {
        thisYear = 1;
    } else if ((fromDate.getMonth() == birthday.getMonth()) && fromDate.getDate() < birthday.getDate()) {
        thisYear = 1;
    }
    var years = fromDate.getFullYear() - birthday.getFullYear() - thisYear;
    return Math.max(0, years);
};


AddMemberDialog.prototype.moreDetailsCollapseExpandActionClickedHandler = function () {
    var thiz = this;
    if (this.clickingCollapseExpandAction) {
        clearTimeout(this.clickingCollapseExpandAction);
    }
    this.clickingCollapseExpandAction = window.setTimeout(function () {
        if (Dom.hasClass(thiz.moreInfoPane, "Expanded")) {
            Dom.removeClass(thiz.moreInfoPane, "Expanded");
            Dom.addClass(thiz.moreInfoPane, "Collapsed");
        } else {
            Dom.removeClass(thiz.moreInfoPane, "Collapsed");
            Dom.addClass(thiz.moreInfoPane, "Expanded");
        }
        thiz.invalidateSizing();
    }, 100);
};

AddMemberDialog.prototype.getMemberData = function () {
    return {
        id: -1,
        account_id: this.accountObject.id,
        first_name: this.firstName.value,
        mi: this.middleName.value,
        last_name: this.lastName.value,
        prefer: this.preferredFristName.value,
        sex: this.genderCombo.getSelectedItem().id,
        phone: this.phoneUtil.getPhoneNumberFromInput(this.atheleteCellPhone.value.trim()),
        dt_dob: FormatUtil.formatDate(this.birthday.getDate(), "date_machine", "local"),
        shirt_size: this.shirtSizeCombo.getSelectedItem() ? this.shirtSizeCombo.getSelectedItem().name : "",
        warmup_jacket_size: this.jacketSizeCombo.getSelectedItem() ? this.jacketSizeCombo.getSelectedItem().name : "",
        warmup_pant_size: this.pantsSizeCombo.getSelectedItem() ? this.pantsSizeCombo.getSelectedItem().name : "",
        med_dr_name: this.physicianName.value,
        med_dr_phone: this.phoneUtil.getPhoneNumberFromInput(this.physicianOfficePhone.value.trim()),
        med_notes: this.medicalInformation.value,
        medication: this.medication.value,
        cust_fld: this.usaGymNumber.value,
        competitiveCategory: this._getCompetitiveCategoryComboSelectedItem()
    };
};

AddMemberDialog.prototype.resetMemberForm = function () {
    this.firstName.value = "";
    this.middleName.value = "";
    this.lastName.value = "";
    this.preferredFristName.value = "";
    this.genderCombo.selectItemByKey("id", 0);
    this.atheleteCellPhone.value = "";
    this.birthday.setDate(null);
    this.age.value = "";
    this.shirtSizeCombo.selectItem(null);
    this.jacketSizeCombo.selectItem(null);
    this.pantsSizeCombo.selectItem(null);
    this.physicianName.value = "";
    this.physicianOfficePhone.value = "";
    this.medicalInformation.value = "";
    this.medication.value = "";
    this.usaGymNumber.value = "";
    this.competitiveCategoryCombo.selectItemByKey("id", 2);
};

AddMemberDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

AddMemberDialog.prototype._getCompetitiveCategoryComboSelectedItem = function () {
    var isCompetitiveCategoryEnabled = this.options.memberConfiguration.isCompetitiveCategoryEnabled;
    if (!isCompetitiveCategoryEnabled || !this.competitiveCategoryCombo.getSelectedItem()) return null;
    return this.competitiveCategoryCombo.getSelectedItem().id;
}

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/ClassTransferFeeDialog.js";

function ClassTransferFeeDialog() {
    Dialog.call(this);
    this.title = "Class Transfer Fee";
    
    this.bind("click", this.feeInfoContainerClickedHandler, this.feeInfoContainer);
    this.bind("p:ItemSelected", this.feeInfoContainerChangedHandler, this.feeInfoContainer);
    this.bind("click", this.feeInfoHeaderClickedHandler, this.feeInfoHeader);
}
__extend(Dialog, ClassTransferFeeDialog);

ClassTransferFeeDialog.prototype.asyncSetup = function (options, dialogCallback) {
    this.options = options;
    var btn =  Dom.newDOMElement({
            _name: "button",
            "type": "button",
            "role": "primary",
            "class": "UpdateTransferFeeButton",
            _children: [{
                _name: "span",
                _text: "Apply"
            }]
        });
    Dom.setEnabled(false, btn);
    var headerEl = Dom.newDOMElement({
        _name: "hbox",
        _children: [{
            _name: "span",
            _text: "Class Transfer Fee Options"
        }, {
            _name: "span",
            "class": "CurrentClassName",
            _text: options.currentClassTitle,
            "title": options.currentClassTitle
        }, {
            _name: "icon",
            "class": "arrow-right"
        }, {
            _name: "span",
            class: "TransferClassName",
            _text: options.newClassTitle,
            "title": options.newClassTitle,
            "flex": 1
        }, btn]
    });
    this.feeInfoHeader.appendChild(headerEl);
    
    this.feeInfoContainer.innerHTML = "";
    this.feeInfoContainer.appendChild(options.feeContentTableHtml);
    dialogCallback();
    this.removeBoundary(this.feeInfoContainer);
};

ClassTransferFeeDialog.prototype.removeBoundary = function (el) {
    var thiz = this;
    var wrapperEl = Dom.findParentWithClass(el, "AnonId_dialogFrame");
    console.log("AnonId_dialogFrame", wrapperEl, el );
    if (wrapperEl){
        var headerEl = Dom.findDescendantWithClass(wrapperEl, "AnonId_dialogHeaderPane");
        console.log("AnonId_dialogHeaderPane", headerEl);
        if (headerEl) Dom.hide(headerEl);
        var footerEl = Dom.findDescendantWithClass(wrapperEl, "AnonId_dialogFooter");
        console.log("AnonId_dialogFooter", footerEl);
        if (footerEl) {
            footerEl.innerHTML = "";
            footerEl.style["padding-top"] = "0px";
        }
    }
    var c = "Sys_DialogOverlay_" + this.constructor.name;
    var overlay = Dom.findDescendantWithClass(Dialog.getOwnerDocument().body, c);
    console.log("overlay", overlay, c, thiz.onHideFeePopup);
    if (overlay) {
        var overlayHandler = function (e) {
            Dom.unregisterEvent(overlay, "click", overlayHandler, false);
            setTimeout(function(){
                console.log("setTimeout feePopupCloseCallback");
                thiz.feePopupCloseCallback();    
            }, 200);
            thiz.close();
        }
        overlay.addEventListener("click", overlayHandler, false);
    }
};


ClassTransferFeeDialog.prototype.feeInfoContainerClickedHandler = function (event) {
    this.options.feeInfoPopupClickedHandler(event);
};

ClassTransferFeeDialog.prototype.feeInfoContainerChangedHandler = function (event) {
    this.options.feeInfoPopupComboChangedHandler(event);
};

ClassTransferFeeDialog.prototype.feeInfoHeaderClickedHandler = function (event) {
    this.options.feeInfoPopupHeaderClickedHandler(event, this.feeInfoContainer);
};

ClassTransferFeeDialog.prototype.feePopupCloseCallback = function (event) {
    if (this.options.feePopupCloseCallback){
        this.options.feePopupCloseCallback(event, this.feeInfoContainer);    
    }
};


ClassTransferFeeDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { 
                thiz.options.onHideFeePopup();
                return true;
            }
        }
    ];
    return actions;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/LocationImportResultDialog.js";

function LocationImportResultDialog() {
    Dialog.call(this);
    this.title = "Locations";
    this.setupStatusSelector();

    this.bind("p:SelectionChanged", (event) => {
        this.paginator.refresh();
    }, this.statusSelector);

    this.bind("click", function () {
        this.exportToExcelHandler();
    }, this.exportButton);
}

__extend(Dialog, LocationImportResultDialog);

LocationImportResultDialog.prototype.onShown = function () {
    this.statusSelector.setItems(["Created", "Updated", "Skipped"]);
    this.setupDataTable();
    this.setupPaginator();
    this.paginator.setSource(this.dataListSource);
};

LocationImportResultDialog.prototype.setup = function (data) {
    this.jobId = data.jobId;
};

LocationImportResultDialog.prototype.setupStatusSelector = function () {
    this.statusSelector.getConfigs = () => {
        return {
            mode: SelectBox.MODE_DROPDOWN,
            multipleSelect: true,
            useExplicitSelectLinks: true,
            noneSelectionText: "All Import Statuses"
        };
    };
    this.statusSelector.parseData = (data) => {
        return {
            value: data,
            text: data
        };
    };
    this.statusSelector.setup();
};

LocationImportResultDialog.prototype.setupPaginator = function () {
    var thiz = this;
    this.dataListSource = {
        order: {
            propertyName: "name",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var page = pageIndex + 1;
            var statuses = thiz.statusSelector.getValues();
            $classMetaService.getImportedLocationStatus(thiz.jobId, statuses, page, pageSize, {name: this.order.propertyName, asc: this.order.asc}, function (list) {
                handler(list.result, list.count);
            }, failed, "Loading...");
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
    this.paginator = new InfiniteScrollPaginator();
    this.paginator._shouldLoadMore = function () {
        return thiz.paginator.renderer.isNearEnd() && thiz.paginator._isMoreItemsAvailable();
    };
    this.paginator._isMoreItemsAvailable = function () {
        return thiz.paginator.lastLoadedIndex >= 0 && ((thiz.paginator.lastLoadedIndex + 1) * thiz.paginator.pageSize < thiz.paginator.total);
    };
    this.paginator.needCalculatePageSize = function() {
        return true;
    };
    this.paginator.control(this.dataTable);
    this.paginator.pageSize = 20;
    this.paginator.setup({
        showPaginator : true,
        withoutStatus : true,
        onPageLoaded : function (p, count) {
            Dom.toggleClass(thiz.emptyDataPlaceholder, "Inapplicable", count > 0);
            Dom.setInnerText(thiz.totalItem, String.format("Total {0} location(s)", p.total));
        },
        comparer : function(a, b) {
            return a.id == b.id;
        },
        useButtons : false,
        avoidPageSizeRecalculation : true
    });
};

LocationImportResultDialog.prototype.setupDataTable = function () {
    var thiz = this;
    this.dataTable.column(new DataTable.PlainTextColumn("Location Name", function (data) {
       return data.name || "";
    }).sortable("name").width("1*", "14em"));

    this.dataTable.column(new DataTable.PlainTextColumn("Address", function (data) {
        return data.address || "";
    }).width("10em"));

    this.dataTable.column(new DataTable.PlainTextColumn("City", function (data) {
        return data.city || "";
    }).width("10em"));

    this.dataTable.column(new DataTable.PlainTextColumn("State", function (data) {
        return data.state || "";
    }).width("6em"));

    this.dataTable.column(new DataTable.PlainTextColumn("Zip", function (data) {
        return data.zip || "";
    }).width("6em"));

    this.dataTable.column(new DataTable.PlainTextColumn("Phone", function (data) {
        return data.phone || "";
    }).width("10em"));

    this.dataTable.column(new DataTable.PlainTextColumn("Org", function (data) {
        return data.teamAlias || "";
    }).width("10em"));

    this.dataTable.column(new DataTable.PlainTextColumn("Description", function (data) {
        return data.desc || "";
    }).width("10em"));

    if (TEAM_INFO.isAffiliationDeclared) {
        this.dataTable.column(new DataTable.PlainTextColumn("Territory", function (data) {
            return data.territoryName || "";
        }).width("13em"));
    }

    this.dataTable.column(new DataTable.GenericDomColumn("Status", function (data) {
        var node = {
            _name: "span",
            "class": data.status,
            _text: data.status
        };
        return Dom.newDOMElement(node);
    }).width("7em"));

    this.dataTable.column(new DataTable.GenericDomColumn("Reason", function (data) {
        return data.reason || "";
    }).width("1*", "14em"));

    this.dataTable.useFloatingHeader = true;
    this.dataTable.setup();
};

LocationImportResultDialog.prototype.exportToExcelHandler = function () {
    if (!this.jobId) return;
    var statuses = this.statusSelector.getValues();
    var order = this.dataListSource.getOrder();
    $classMetaService.exportLocationStatusToExcel(this.jobId, statuses, {name: order.propertyName, asc: order.asc}, function (fileUrl) {
        if (!fileUrl) return;
        Util.initiateDownload(fileUrl);
    }, function (error) {
        Dialog.error(error.message);
    }, "Export to File...");
};

LocationImportResultDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/LocationImportView.js";

function LocationImportView() {
    BaseTemplatedWidget.call(this);
    this.title = "Maps Management";

    this.validationRules = new RuleSet().live(true);
    
    var thiz = this;
    
    this.validationRules.custom(new RequiredRule(this.importLocationFileUploadView, "Please select a file to upload!"), 
        function() {
            return thiz.importLocationFileUploadView.fileInfoList.length > 0;
        }
    );
    this.bind("click", this.importLocation, this.importLocationButton);

    this.bind("click", function () {
        if (!this.jobId) return;
        new __pkg.LocationImportResultDialog().open({ jobId: this.jobId });
    }, this.viewLocationImportedResult);
}
__extend(BaseTemplatedWidget, LocationImportView);

LocationImportView.prototype.importLocation = function() {
    console.log('>>>' + this.importLocationFileUploadView.getCommaSeparatedStoragePaths());
    var haveFile = ValidationManager.run(this.validationRules);
    console.log('haveFile: ', haveFile);
    if(!haveFile) {
        return;
    }
    var file = this.importLocationFileUploadView.getSelectedLocalFiles()[0];
    console.log('upload file: ', file)
    var thiz = this;
    this.importLocationButton.disabled = true;
    $classMetaService.importLessonLocsFile(file, 
        function(response) {
            console.log('importLessonLocsFile response', response);
            if(response.status == "Success") {
                thiz.jobId = response.jobId;
                thiz.waiting4ImportLocation();
            } else {
                Dialog.error(response.message);
            }
            
            thiz.importLocationFileUploadView.setCommaSeparatedStoragePaths("");
            thiz.importLocationFileUploadView.rebuildFileInfoList();
            thiz.importLocationFileUploadView.invalidateStatus();
            //thiz.importLocationFileUploadView.fireFileModified();
            thiz.importLocationButton.disabled = false;
        }, "Uploading Locations import file..."
    );
}

LocationImportView.prototype.waiting4ImportLocation = function() {
    var thiz = this;
    if(this.indicator === undefined) {
        this.indicator = window.defaultIndicator;
        this.indicator.busy("Importing Locations...");
    }
    $classMetaService.checkImportLessonLocsFileStatus(this.jobId, function(result) {
        console.log('checkImportLessonLocsFileStatus: ', result);
        if(result.status == "Running") {
            setTimeout(function() {
              thiz.waiting4ImportLocation();
            }, 1000);
        } else {
            if(thiz.indicator !== undefined) {
                thiz.indicator.done();
                delete thiz.indicator;
            }
            thiz.onImportLocationComplete(result);
        }
    });
}

LocationImportView.prototype.onImportLocationComplete = function(result) {
    console.log('onImportLocationComplete, result: ', result);
    if(result.status == "Done") {
        var importResult = JSON.parse(result.data);
        SnackBar.show(importResult.message);

        if (this.jobId) {
            $classMetaService.getImportedLocationSummary(this.jobId, function (summary) {
                if (!summary) return;
                Dom.setInnerText(this.viewLocationImportedResult, String.format("Total {0} location(s) created, {1} updated, {2} skipped", summary.created, summary.updated, summary.skipped));
            }.bind(this));
        }
    } else {
        Dialog.error(response.errorMessage);
    }
}

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/MemberListWidget.js";

function MemberListWidget(options) {
    this.options = options;
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.excludeMemberIds = this.options.excludeMemberIds ? this.options.excludeMemberIds : [];
    this.memberSource = {
        order: {
            propertyName: "memberFullName",
            asc: true
        },
        keyword: "",
        classId: thiz.options.classId,
        limitGender: false,
        limitAge: false,
        excludeMemberIds: thiz.excludeMemberIds,
        loadPage: function (pageIndex, pageSize, handler, failed) {
            $classToolService.getMembers(this.classId, this.limitGender, this.limitAge, this.keyword, this.excludeMemberIds,
                pageIndex * pageSize, pageSize, {name: this.order.propertyName, asc: this.order.asc}, function (list) {
                handler(list.result, list.count);
                if (list.count == 0) {
                    Dom.addClass(thiz.memberList ,"Empty");
                } else {
                    Dom.removeClass(thiz.memberList ,"Empty");
                }
                thiz.searchText.focus();
            }, failed, thiz._dialog);
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
    
    this.initializeDataTable();
    
    this.bind("click", this.selectedMemberContentClickedHandler, this.selectedMemberContent);
    this.bind("click", this.removeAllMemberClickedHandler, this.removeAllMember);
    this.bind("change", this.ageLimitChangedHandler, this.ageLimit);
    this.bind("change", this.genderLimitChangedHandler, this.genderLimit);
    this.bind("input", this.searchTextInputHandler, this.searchText);
    
    this.bind("mouseover", this.showInvalidPopup, this.memberDataTable.node());
    this.bind("mouseout", this.hideInvalidPopup, this.memberDataTable.node());
}
__extend(BaseTemplatedWidget, MemberListWidget);

MemberListWidget.prototype.onAttached = function () {
    var thiz = this;
    window.setTimeout(function () {
        thiz.onAttachedDelayed();
    }, 200)

};

MemberListWidget.prototype.onAttachedDelayed = function () {
    this.renderMemberListWidget();
    
    this.memberDataTable.setup();
    var thiz = this;
    this.paginator = new InfiniteScrollPaginator();
    this.paginator._shouldLoadMore = function () {
        return thiz.paginator.renderer.isNearEnd() && thiz.paginator._isMoreItemsAvailable();
    };
    this.paginator._isMoreItemsAvailable = function () {
        return thiz.paginator.lastLoadedIndex >= 0 && ((thiz.paginator.lastLoadedIndex + 1) * thiz.paginator.pageSize < thiz.paginator.total);
    };
    this.paginator.setup({
        showPaginator : true,
        withoutStatus : true,
        onPageLoaded : function(p, count) {
        },
        comparer : function(a, b) {
            return a.transaction_id == b.transaction_id;
        },
        useButtons : false,
        avoidPageSizeRecalculation : true
    });
    this.paginator.needCalculatePageSize = function() {
        return true;
    };
    this.paginator.control(this.memberDataTable);
    this.paginator.setSource(this.memberSource);
};

MemberListWidget.prototype.renderMemberListWidget = function () {
    if (!this.options) return;
    this.className.innerHTML = this.options.title;
    
    var showClassLimit = false;    
    if (this.options.ageLow > 0 || this.options.ageHi > 0) {
        showClassLimit = true;
        var text = "Age: " + this.options.ageText;
        if (this.options.dateAgeUp) {
            text += " at " + FormatUtil.formatDate(this.options.dateAgeUp, "date_standard", "server")
        }
        this.ageText.innerHTML = text;
    } else {
        Dom.hide(this.ageLimitWrapper);
    }
    
    var allowedGenderList = Object.values(Gender).filter(function(gen) { return gen.type != "Mixed"});
    if (!this.options.allowedGenders || this.options.allowedGenders.length >= allowedGenderList.length) {
        Dom.hide(this.genderLimitWrapper);
    } else {
        this.genderLimitLabel.innerHTML = this.options.allowedGenders.map(function(type) {
            return Gender[type].displayName;
        }).join(", ");
        showClassLimit = true;
    }

    if (!showClassLimit) Dom.hide(this.classLimitWrapper);
};

MemberListWidget.prototype.showInvalidPopup = function(ev) {
    var target = Dom.getTarget(ev);
    if (!target) return;

    if (Dom.findParentWithClass(target, "InvalidBirthDay")) {
        this.showTips(target, "Invalid birthday.", false);
    } else if (Dom.findParentWithClass(target, "SuspendedMember")) {
        this.showTips(target, "Member is suspended and will be active when the registration is completed.", true);
    } else if (Dom.findParentWithClass(target, "CancelledHiddenMember")) {
        this.showTips(target, "Member is no longer active. Please contact your organization if you feel this is inaccurate.", true);
    }
};

MemberListWidget.prototype.hideInvalidPopup = function(ev) {
    var target = Dom.getTarget(ev);

    if(target && target.__tip) {
        target.__tip.isVisible = function(){
            return true;
        };
        InfoTip.show(target);
        if (this._infoTips) {
            this._infoTips.kill();
        }
    }
};

MemberListWidget.prototype.showTips = function(target, message, showAlert) {
    if (this._infoTips) {
        this._infoTips.kill();
    }
    var el = Dom.newDOMElement({
        _name: "div",
        _html: (showAlert ? "<icon class=\"alert\" style=\"font-size: 1.2em;margin-right: 0.5em;\"></icon>" : "") +  "<span>" + message + "</span>"
    });
    this._infoTips = InfoTip.show(target, el, false, null, "error", "left-inside", -(Dom.getOffsetWidth(target)/2 + 11));
    this._infoTips.setPopupClass("MemberInvalidPopup");
}

MemberListWidget.prototype.initializeDataTable = function () {
    var thiz = this;
    var minDob = new Date(-1262304000000);
    var memColumn = new DataTable.GenericColumn("Member", function (data) {});
    memColumn.getContentTitle = function(data) {
        return data.memberFullName;
    }
    memColumn.getCellContentHtml = function (data) {
        var nameHtml = '<hbox style="align-items: center;"><div style="opacity:' + (data.memberStatusId == 40 ? "0.5" : "1") + ';">' + data.memberFullName + '</div>'
                        + (!data.dtDob || data.dtDob < minDob ? '<div><icon class="alert InvalidBirthDay" style="font-size: 1.2em;color: #FF0000;opacity: 0.5;margin-left: 0.5em;"></div>' : '')
                        + (data.memberStatusId == 30 ? '<div><icon class="alert SuspendedMember" style="font-size: 1.2em;color: #ffcc33;margin-left: 0.5em;"></div>' : '')
                        + (data.memberStatusId == 40 ? '<div><icon class="alert CancelledHiddenMember" style="font-size: 1.2em;color: #ff0000;margin-left: 0.5em;"></div>' : '')
                        + '</hbox>';
        return nameHtml;
    };
    memColumn.width("1*", "10em");
    memColumn.sortable("memberFullName");
    this.memberDataTable.column(memColumn);
    
    var ageColumn = new DataTable.GenericColumn("Age", function (data) {});
    ageColumn.getContentTitle = function(data) {
        return "" + data.age;
    }
    ageColumn.getCellContentHtml = function (data) {
        return '<div style="opacity:' + (data.memberStatusId == 40 ? "0.5" : "1") + ';">' + data.age + '</div>';
    };
    ageColumn.width("5em");
    ageColumn.sortable("age");
    this.memberDataTable.column(ageColumn);
    
    var sexColumn = new DataTable.GenericColumn("Sex", function (data) {});
    sexColumn.getContentTitle = function(data) {
        return data.gender;
    }
    sexColumn.getCellContentHtml = function (data) {
        return '<div style="opacity:' + (data.memberStatusId == 40 ? "0.5" : "1") + ';">' + data.gender + '</div>';
    };
    sexColumn.width("5em");
    sexColumn.sortable("gender");
    this.memberDataTable.column(sexColumn);
    
    var accColumn = new DataTable.GenericColumn("Account", function (data) {});
    accColumn.getContentTitle = function(data) {
        return data.accountFullName;
    }
    accColumn.getCellContentHtml = function (data) {
        return '<div style="opacity:' + (data.memberStatusId == 40 ? "0.5" : "1") + ';">' + data.accountFullName + '</div>';
    };
    accColumn.width("1*", "10em");
    accColumn.sortable("accountFullName");
    this.memberDataTable.column(accColumn);
    var validateMemberData = function (member) {
        return member && member.dtDob && member.dtDob >= minDob ? true : false;
    };
    
    var actions = [{
        id: "add", type: "add", title: "Add",
        isApplicable: function(item) {
            return validateMemberData(item);
        },
        handler: function (item, actionNode) {
            thiz.addMember(item, actionNode);
        }
    }];
    var actionCol = new DataTable.ActionColumn(actions);
    actionCol.title = "Actions";
    actionCol.getCellContentHtml = function (data, row, col) {
        if (thiz.addedMemberIds && thiz.addedMemberIds.indexOf(data.id) >= 0) {
            return '<div id="memberAction_' + data.id + '" class="MemberAction RegistedMember"><button type="button" role="primary" action-id="add">ADD</button><div>Added</div></div>';    
        }
        var validMember = validateMemberData(data);
        return '<div id="memberAction_' + data.id + '" class="MemberAction"><button type="button" ' + (validMember ? "role='primary'" : "disabled") + ' action-id="add">ADD</button><div>Added</div></div>';
    };
    
    this.memberDataTable.column(actionCol.width("7em"));
    
    this.memberDataTable.selector(false, false);
    this.memberDataTable.setDefaultSelectionHandler({
        run: function (item) {}
    });
    this.memberDataTable.useFloatingHeader = true;
};

MemberListWidget.prototype.ageLimitChangedHandler = function (e) {
    this.memberSource.limitAge = e.target.checked;
    this.paginator.refresh();
};

MemberListWidget.prototype.genderLimitChangedHandler = function (e) {
    this.memberSource.limitGender = e.target.checked;
    this.paginator.refresh();
};

MemberListWidget.prototype.searchTextInputHandler = function () {
    var thiz = this;
    if (this.inputingSearchTextTimeout) {
        window.clearTimeout(this.inputingSearchTextTimeout);
    }
    var keyword = thiz.searchText.value;
    this.inputingSearchTextTimeout = window.setTimeout(function () {
        if (thiz.memberSource.keyword != keyword) {
            thiz.memberSource.keyword = keyword;
            thiz.paginator.refresh();
        }
    }, 500);
};

MemberListWidget.prototype.addMember = function (memberInfo, actionNode) {
    if (!memberInfo) return;
    var itemWrapper = document.createElement("div");
    itemWrapper._memberId = memberInfo.id;
    Dom.addClass(itemWrapper, "MemberItemWrapper");
    
    var item = document.createElement("div");
    Dom.addClass(item, "MemberItem");
    
    var memberName = document.createElement("div");
    memberName.setAttribute("flex", 1);
    memberName.innerHTML = memberInfo.memberFullName;
    memberName.title = memberInfo.memberFullName;
    Dom.addClass(memberName, "MemberName");
    item.appendChild(memberName);
    
    var deleteIcon = document.createElement("icon");
    Dom.addClass(deleteIcon, "close");
    Dom.addClass(deleteIcon, "RemoveMemberAction");
    deleteIcon.title = "Remove";
    item.appendChild(deleteIcon);
    itemWrapper.appendChild(item);
    this.selectedMemberContent.appendChild(itemWrapper);
    if (actionNode) {
        var divMemberAction = Dom.findParentWithClass(actionNode, "MemberAction");
        if (divMemberAction) Dom.addClass(divMemberAction, "RegistedMember");
    }
    if (!this.addedMemberIds) this.addedMemberIds = [];
    this.addedMemberIds.push(memberInfo.id);
    Dom.removeClass(this.removeAllMember, "Disabled");
};

MemberListWidget.prototype.selectedMemberContentClickedHandler = function (event) {
    var thiz = this;
    if (Dom.hasClass(event.target, "RemoveMemberAction") 
        || Dom.hasClass(event.target.parentNode, "RemoveMemberAction")) {
            
        Dialog.confirm("Are you sure you want to remove this member?", null, "Remove", function () {
            var itemWrapper = Dom.findParentWithClass(event.target, "MemberItemWrapper");
            if (itemWrapper && itemWrapper.parentNode) {
                var memberId = itemWrapper._memberId;
                if (thiz.addedMemberIds && thiz.addedMemberIds.indexOf(memberId) >= 0) {
                    thiz.addedMemberIds.splice(thiz.addedMemberIds.indexOf(memberId), 1);
                }
                var memberAction = document.getElementById("memberAction_" + memberId);
                if (memberAction) Dom.removeClass(memberAction, "RegistedMember");
                itemWrapper.parentNode.removeChild(itemWrapper);
            }
        }, "Cancel", function () {});
    }
};

MemberListWidget.prototype.removeAllMemberClickedHandler = function () {
    if (!this.addedMemberIds) return;
    if (this.addedMemberIds && this.addedMemberIds.length == 0) return;
    var thiz = this;
    var memberItemDoms = thiz.memberList.getElementsByClassName("RegistedMember");
    Dialog.confirm("Are you sure you want to remove all members?", null, "Remove", function () {
        thiz.selectedMemberContent.innerHTML = "";
        while (memberItemDoms.length > 0) {
            Dom.removeClass(memberItemDoms[0], "RegistedMember");
        }
        thiz.addedMemberIds = [];
        Dom.addClass(thiz.removeAllMember, "Disabled");
    }, "Cancel", function () {});
};

MemberListWidget.prototype.reloadMemberListWidget = function () {
    this.paginator.refresh();
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/PaymentMethodHandlers.js";

// ----- Payment Method Handlers ----- //
function __extendFunction() {
    var __base = arguments[0];
    var sub = arguments[1];

    sub.prototype = Object.create(__base.prototype);
    sub.prototype.constructor = sub;

    for (var i = 2; i < arguments.length; i ++) {
        var f = arguments[i];
        sub.prototype[f.name] = f;
    }
    return sub;
};

function DefaultPaymentMethodHandler() {
    this.paymentMethod = null;
};

// ----- Payment Processor
DefaultPaymentMethodHandler.prototype.canProcessPayment = function() {
    return false;
};

DefaultPaymentMethodHandler.prototype.isTerminalReaderSupported = function() {
    return false;
};

// DefaultPaymentMethodHandler.prototype.addPaymentMethod = function (cardToken, metadata, onCool, onFailed, indicator) {
//     var info = this.getPaymentInfo && this.getPaymentInfo();
//     if (!info) return;
//     $bookingsService.addCardToAccount(info.accountId, cardToken.id, metadata, onCool, onFailed, indicator);
// };

function CreditCardHandler() {
    this.paymentMethod = "CreditCard";
};

__extendFunction(DefaultPaymentMethodHandler, CreditCardHandler);

function ECheckHandler() {
    this.paymentMethod = "ECheck";
};
__extendFunction(DefaultPaymentMethodHandler, ECheckHandler);

//__pkg.__export("CreditCardHandler", CreditCardHandler);


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/PaymentSetupDialog.js";

function PaymentSetupDialog() {
    Dialog.call(this);
    this.title = "Payment Setup";

    this.bind("p:ItemSelected", this.invalidateElements, this.paymentContainer);
    this.bind("p:AccountBankListChanged", this._updateDialogSizing, this.dialogContentNode);
    this.bind("p:AccountCreditCardListChanged", this._updateDialogSizing, this.dialogContentNode);
}
__extend(Dialog, PaymentSetupDialog);

PaymentSetupDialog.prototype.asyncSetup = function (data, callback) {
    if (data.account) this.account = data.account;
    this.paymentRequest = data.paymentRequest;
    this.paymentExecutor = data.paymentExecutor;
    this.paymentMethod = data.paymentMethod || "CreditCard";
    this.selectedCardId = data.selectedCardId || 0;
    var name = "";
    if (this.account) {
        name = String.format("{0}, {1}", this.account.last_name, this.account.first_name);
        this.accountInfoContainer.appendChild(Dom.newDOMElement({
            _name: "hbox", flex: "1", "class": "AccountDetails",
            _children: [
                {_name: "span", _text: this.account.status, "class": "Status " + this.account.status.replace(/[//\s]/g, "")},
                {_name: "span", _text: this.account.city},
                {_name: "span", _text: TeamLocalizer.getString(this.account.paymentMethod), "class": "PaymentMethod" + (this.account.paymentMethod == "Check" ? " Check" : ""), "data-card-count": this.account.cardCount},
                this.account.ccTypeImg ? {
                    _name: "div", "class": "CardImageContainer",
                    _children: [
                        {
                            _name: "img", src:"/" + this.account.ccTypeImg,
                        }
                    ]
                } : undefined
            ]
        }));
    }
    Dom.setInnerText(this.accountNameLabel, name);
    widget.createWidgetAsync("finance", "PaymentMethodWidget", {}, (wg) => {
        this.paymentMethodWidget = wg;
        wg.into(this.paymentContainer);
        this._initPaymentMethods(data, callback);
    });
};

PaymentSetupDialog.prototype._updateDialogSizing = function () {
    window.setTimeout(() => { this.invalidateSizing(); }, 100);
};

PaymentSetupDialog.prototype._onPaymentMethodsLoaded = function () {
    this.invalidateElements();
};

PaymentSetupDialog.prototype._onPaymentMethodsListChanged = function (method, listChanges) {
    if (!this.firstSetupDone) {
        this.firstSetupDone = true;
        window.setTimeout(() => {
            var selectedCardNode = this.paymentContainer.querySelector(":scope .widget_CreditCardPaymentInput .widget_RepeaterView > .Item.Selected");
            selectedCardNode && selectedCardNode.scrollIntoView({behavior: "auto", block: "nearest", inline: "nearest"});
        }, 100);
    }
    this.invalidateElements();
};

PaymentSetupDialog.prototype._initPaymentMethods = function (data, callback) {
    this.appendedCreditCardNote = false;
    this.paymentMethodWidget.addLoadedListener(this._onPaymentMethodsLoaded.bind(this));
    this.paymentMethodWidget.addListChangedListener(this._onPaymentMethodsListChanged.bind(this));
    
    var acceptableMethods = [this.paymentMethod];
    acceptableMethods.forEach((pm, i) => {
        if (pm == this.paymentMethodWidget.getPaymentMethodByName("CreditCard").name) {
            var ccHandler = new CreditCardHandler();
            ccHandler.getPaymentInfo = () => { return { accountId: this.account && this.account.id || 0, };};
            this.paymentMethodWidget.setCustomHandler(pm, ccHandler);
        };
    });
    var billingInfo = {
        firstName: this.account.first_name,
        lastName: this.account.last_name,
        zip: this.account.zip
    };
    this.paymentMethodWidget.load({
        acceptableMethods: acceptableMethods,
        accountId: this.account && this.account.id || 0,
        selectedCardId: this.selectedCardId,
        billingInfo: billingInfo || {}
    });
    callback && callback();
};

PaymentSetupDialog.prototype._getPaymentInfo = function () {
    if (!this.paymentMethodWidget || !this.paymentMethodWidget.getSelection()) return null;
    var selectedMethod = this.paymentMethodWidget.getSelection();    
    var paymentInfo = {};
    paymentInfo.paymentMethod = selectedMethod.paymentMethod.name;
    if (selectedMethod.paymentMethod.name == this.paymentMethodWidget.getPaymentMethodByName("CreditCard").name) {
        if (!selectedMethod.card || selectedMethod.card.expired) return null;
        
        var card = selectedMethod.card;
        paymentInfo.vaultTokenId = card.id;
    } else {
        if (!selectedMethod.bankAccount) return null;
        paymentInfo.vaultTokenId = selectedMethod.bankAccount.id;
    }
    return paymentInfo;
};

PaymentSetupDialog.prototype.getDialogActions = function () {
    return  [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: () => { return true; }
        },
        {
            type: "accept", title: "Select",
            isCloseHandler: true,
            isApplicable: () => {
                var paymentInfo = this._getPaymentInfo();
                return paymentInfo && paymentInfo.vaultTokenId;
            },
            run: this.apply.bind(this)
        }
    ]
};

PaymentSetupDialog.prototype.apply = function () {
    var paymentInfo = this._getPaymentInfo();
    this.close(paymentInfo);
};

PaymentSetupDialog.prototype.shouldShowUnapplicableButtons = function () {
    return true;
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/RegistrationsDialog.js";

function RegistrationsDialog() {
    this.grabWidth = true;
    this.grabHeight = true;
    this.shouldShowUnapplicableButtons = function() {return true;};
    Dialog.call(this);
}

__extend(Dialog, RegistrationsDialog);

RegistrationsDialog.prototype.getInnerOffset = function () {

    if (window.innerWidth <= BaseWidget.RESPONSIVE_BREAKPOINTS.xl) {
        return {
            w: 5 * Util.em(),
            h: 5 * Util.em()
        };
    } else {
        return {
            w: 25 * Util.em(),
            h: 10 * Util.em()
        };
    }
};

RegistrationsDialog.prototype.asyncSetup = function (options, dialogCallback) {
    var thiz = this;
    this.options = options;
    this.title = "Add New Registrations";

    this.renderRegistrationWidget();
    if (options.action && options.action == "addClassForMember") {
        new SelectClassDialog().callback(function (selectClassData) {
            if (!selectClassData) {
                thiz.close();
                return;
            }
            console.log("RegistrationsDialog", selectClassData);
            if (selectClassData.addedClassIds && selectClassData.addedClassIds.length > 0) {
                for (var i = 0; i < selectClassData.addedClassIds.length; i++) {
                    thiz.registrationsWidget.options.addedClassIds.push(selectClassData.addedClassIds[i]);
                }
            }
            dialogCallback();
        }).open(options);
    } else if (options.action && options.action == "reEnrollMemberClass") {
        dialogCallback();
    } else if (!options.addedMemberIds || options.addedMemberIds.length == 0) {
        new SelectMemberDialog().callback(function (memberDialogData) {
            if (!memberDialogData) {
                thiz.close();
                return;
            }
            if (memberDialogData.addedMemberIds && memberDialogData.addedMemberIds.length > 0) {
                for (var i = 0; i < memberDialogData.addedMemberIds.length; i++) {
                    thiz.registrationsWidget.options.addedMemberIds.push(memberDialogData.addedMemberIds[i]);
                }
            }
            dialogCallback();
        }).open(options);
    } else {
        dialogCallback();
    }
};

RegistrationsDialog.prototype.renderRegistrationWidget = function() {
    console.log("renderRegistrationWidget", this.options);
    var registrationsOptions = {
        classId: this.options.classId,
        memberId: this.options.memberId,
        memberFullName: this.options.memberFullName,
        movedLessonClassIns: this.options.movedLessonClassIns,
        defaultRegSlot: this.options.defaultRegSlot,
        defaultPaymentPlan: this.options.defaultPaymentPlan,
        addedMemberIds: this.options.addedMemberIds,
        addedClassIds: this.options.addedClassIds,
        invalidateElements: this.invalidateElements.bind(this),
        action: this.options.action,
        mapMemberSlot: this.options.mapMemberSlot,
        isReenrollingReg: this.options.isReenrollingReg
    };
    this.containerWrapper.innerHTML = "";
    this.registrationsWidget = new RegistrationsWidget(registrationsOptions).into(this.containerWrapper);
    this.registrationsWidget._dialog = this;
};

RegistrationsDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Save Registrations",
            isApplicable: function() {
                var regData = thiz.registrationsWidget.options;
                console.log(thiz.registrationsWidget, thiz.registrationsWidget.options, "### INVALIDATE REGISTRATION DATA:\n # memberIds:", regData.addedMemberIds, "\n # movedLessonClassIns:", regData.movedLessonClassIns);
                if (thiz.options.action == "addClassForMember" || thiz.options.action == "reEnrollMemberClass") {
                    return (regData.addedClassIds && regData.addedClassIds.length);
                } else {
                    return (regData.addedMemberIds && regData.addedMemberIds.length);
                }
                
            },
            run: function () {
                thiz.saveButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                return thiz.cancelButtonClickHandler();
            }
        }
    ];

    if (thiz.options.movedLessonClassIns) {
        actions.push({
            type: "extra", title: "Choose another class",
            isCloseHandler: false,
            isApplicable: function() {
                var regData = thiz.registrationsWidget.options;
                console.log("### INVALIDATE REGISTRATION DATA:\n # memberIds:", regData.addedMemberIds, "\n # movedLessonClassIns:", regData.movedLessonClassIns);
                return (regData.addedMemberIds && regData.addedMemberIds.length
                    && regData.movedLessonClassIns && regData.movedLessonClassIns.length);
            },
            run: function() {
                var regData = thiz.registrationsWidget.options;
                if (!regData.addedMemberIds || !regData.addedMemberIds.length
                    || !regData.movedLessonClassIns || !regData.movedLessonClassIns.length) {
                    Dialog.error("Member list is empty.");
                    return;
                }
                thiz.options.movedLessonClassIns = regData.movedLessonClassIns;
                thiz.options.addedMemberIds = regData.addedMemberIds;
                new ClassSelectorDialog().callback(function(classInfo) {
                    console.log("# selected class:", classInfo);
                    if (!classInfo) return;
                    thiz.options.classId = classInfo.id;
                    thiz.options.title = classInfo.title;
                    
                    var defaultPaymentPlan = -1;
                    if (classInfo && classInfo.paymentPlans && classInfo.paymentPlans.length == 1) {
                        defaultPaymentPlan = classInfo.paymentPlans[0].id;
                    }
                    thiz.options.defaultPaymentPlan = defaultPaymentPlan;
                    var defaultRegSlot = -1;
                    if (classInfo.assignedSlot >= 0) {
                        defaultRegSlot = classInfo.assignedSlot;
                    } else if (classInfo.slots && classInfo.slots.length == 1) {
                        defaultRegSlot = classInfo.slots[0].slot;
                    }
                    thiz.options.defaultRegSlot = defaultRegSlot;
                    thiz.renderRegistrationWidget();
                }).open(thiz.options.movedLessonClassIns);
            }
        });
    }

    return actions;
};

RegistrationsDialog.prototype.saveButtonClickHandler = function () {
    if (!this.options) return;
    if (this.registrationsWidget.checkingRegistrations) {
        this.registrationsWidget.checkingRegistrations = false;
        return;
    }
    var data = this.registrationsWidget.getRegistrationsData();
    if (Object.getOwnPropertyNames(data).length <= 0) return;
    var thiz = this;
    this.sendGAEvents(data);
    var classIdMemberIdMap = {};
    for (var key in data) {
        if (!classIdMemberIdMap[data[key].classId]) classIdMemberIdMap[data[key].classId] = [];
        classIdMemberIdMap[data[key].classId].push(data[key].memberId);
    }
    
    $classToolService.saveRegistrations(classIdMemberIdMap, data, function (res) { // res: failed registrations map by member_id
        var nameField = "memberFullName";
        if (thiz.options.action == "addClassForMember") nameField = "className";
        
        var isNotSavedNames = [], isNotSavedIds = [], isSavedIds = [], partialPaymentIds = [];
        var errorMsg = "", partialPaymentMsg = "";
        for (var key in data) {
            var registrant = res[key];
            if (registrant) {
                if (registrant.paymentResult && registrant.paymentResult.partial) {
                    partialPaymentMsg += "<li><strong>" + registrant.accountFullName + ":</strong></li>";
                    var failedTotalByCodeMap = registrant.paymentResult.failedTotalByCodeMap;
                    if (typeof (failedTotalByCodeMap) !== "object") failedTotalByCodeMap = {};

                    var descriptionByCodeMap = registrant.paymentResult.descriptionByCodeMap;
                    if (typeof (descriptionByCodeMap) !== "object") descriptionByCodeMap = {};

                    partialPaymentMsg += "<ul>";
                    for (var k in failedTotalByCodeMap) {
                        partialPaymentMsg += "<li>Payment for <span style=\"color:red;font-weight: bold;\">" + Util.toCurrency(failedTotalByCodeMap[k]) + "</span> failed due to: <strong>" + k + "</strong></li>";
                    }
                    partialPaymentMsg += "</ul>";

                    partialPaymentIds.push(data[key].id);
                } else {
                    errorMsg += "<li><strong>" + res[key][nameField] + ": </strong><span>" + res[key].errorMessage + "</span></li>";
                    isNotSavedNames.push(data[key][nameField]);
                    isNotSavedIds.push(data[key].id);
                }
            } else {
                isSavedIds.push(key);
            }
        }

        if ((isSavedIds.length > 0 || partialPaymentIds.length > 0) && typeof(thiz.options.registrationsChanged) == "function") {
            thiz.options.registrationsChanged(true);
        }

        if (isNotSavedNames.length > 0 || partialPaymentIds.length > 0) {
            var str = "";
            if (partialPaymentIds.length > 0) {
                str += "<p>Registrations of the following accounts were successful but problems occured when processing a portion of the payment: ";
                str += "<ul>" + partialPaymentMsg + "</ul>";
                str += "</p>";
            }

            if (partialPaymentIds.length > 0 && isNotSavedNames.length > 0) {
                str += "<hr style=\"color: #4a46462b;margin: 2em 0em;\">";
            }

            if (isNotSavedNames.length > 0) {
                str += "<p>The following registrations cannot be saved: ";
                str += "<ul>" + errorMsg + "</ul>";
                str += "Please resolve these issues and submit again.";
                str += "</p>";
            }

            Dialog.alertHtmlMessage("Warning", str, function () {
                if (isNotSavedNames.length > 0) {
                    thiz.registrationsWidget.reloadRegistrationWithItem(isNotSavedIds);
                } else {
                    thiz.close();
                }
            });
        } else {
            Dialog.alert("Success", "Registrations saved successfully.", function () {
                thiz.close();
            });
        }
    }, function (err) {}, this);
};


RegistrationsDialog.prototype.sendGAEvents = function (submitData) {
    var memberCount = 0; waivedFeeCount = 0, waitlistCount = 0, offlineCount = 0, ccCount = 0, overrideCount = 0;
    for (var key in submitData) {
        memberCount ++;
        var paymentInfo = submitData[key].paymentInfo;
        if (!paymentInfo) continue;
        switch (paymentInfo.paymentTypeKey) {
            case "wailistPayLater":
                waitlistCount ++;
                break;
            case "check":
            case "cash":
                offlineCount ++;
                break;
            case "accountCC":
                ccCount ++;
                break;
            default:
                break;
        }

        if (submitData[key].fee && submitData[key].fee.isWaived) waivedFeeCount ++;
        if (submitData[key].overrideConflict) overrideCount ++;
    }

    ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.saveMembers, window.TEAM_ALIAS, memberCount);
    console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.saveMembers, " Label: ", window.TEAM_ALIAS, " Value: ", memberCount);

    if (waivedFeeCount > 0) {
        ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.saveMembersFeeWaived, window.TEAM_ALIAS, waivedFeeCount);
        console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.saveMembersFeeWaived, " Label: ", window.TEAM_ALIAS, " Value: ", waivedFeeCount);
    }

    if (waitlistCount > 0) {
        ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.saveMembersWaitlist, window.TEAM_ALIAS, waitlistCount);
        console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.saveMembersWaitlist, " Label: ", window.TEAM_ALIAS, " Value: ", waitlistCount);
    }

    if (offlineCount > 0) {
        ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.saveMembersOffline, window.TEAM_ALIAS, offlineCount);
        console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.saveMembersOffline, " Label: ", window.TEAM_ALIAS, " Value: ", offlineCount);
    }

    if (ccCount > 0) {
        ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.saveMembersCc, window.TEAM_ALIAS, ccCount);
        console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.saveMembersCc, " Label: ", window.TEAM_ALIAS, " Value: ", ccCount);
    }

    if (overrideCount > 0) {
        ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.saveMembersOverride, window.TEAM_ALIAS, overrideCount);
        console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.saveMembersOverride, " Label: ", window.TEAM_ALIAS, " Value: ", overrideCount);
    }
};


RegistrationsDialog.prototype.cancelButtonClickHandler = function () {
    var data = this.registrationsWidget.getRegistrationsData();
    var thiz = this;
    if (data != null && Object.getOwnPropertyNames(data).length > 0) {
        Dialog.confirm("Are you sure? No members will be registered to classes.", "", "Close", function() {
            thiz.close();
        }, "Cancel", function() {
            return false;
        });
    } else {
        return true;
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/RegistrationsWidget.js";

function RegistrationsWidget(options) {
    this.options = options;
    var thiz = this;
    this.currency = (LOCALE && LOCALE.CURRENCY) ? LOCALE.CURRENCY : "$";
    BaseTemplatedWidget.call(this);

    this.paymentTypeRenderer = function (data, selected) {
        if (!data) return "&nbsp;";
        return "" + data.name;
    };

    this.couponCodeRenderer = function (data, selected) {
        if (!data) return "&nbsp;";
        return "<span>" + data.name + "</span>" + (data.shared ? "<icon class=\"file-tree SharedIndicator\" title=\"Shared coupon\"></icon>" : "");
    };

    this.couponDecorator = function (node, data) {
        Dom.toggleClass(node, "SharedCoupon", data && data.shared);
    };

    this.paymentPlanComboRenderer = function (data, selected) {
        if (!data) return "&nbsp;";
        return "" + data.name;
    };
    this.couponCodeDisplayValue = function (data) {
        if (!data) return "&nbsp;";
        return (data.shared ? "<icon class=\"file-tree SharedIndicator\" title=\"Shared coupon\"></icon>" : "") + "<span>" + data.code + "</span>";
    };
    this.paymentTypeComparer = function (obj1, obj2) {
        if (obj1 != null && obj2 != null) return obj1.key == obj2.key;
        return false;
    };
    this.slotRenderer = function (data, selected) {
        if (!data) return "&nbsp;";
        var text = "<strong>Reg Slot #" + (data.slot + 1) + "</strong> | ";
        if (data.maxLimit >= 99999) {
            text += data.slotRegister
        } else {
            if (data.slotOpen <= 0) {
                text += "Full";
            } else {
                text += data.slotRegister + "/" + data.maxLimit;
            }
        }
        text += " Reg  |";
        var maxLength = 2;
        if (data.slotTimes.length < 2) maxLength = data.slotTimes.length;
        for (var i = 0; i < maxLength; i++) {
            text += "<span>&nbsp;&nbsp;" + data.slotTimes[i] + "</span>";
        }
        if (data.slotTimes.length > maxLength) text += " +" + (data.slotTimes.length - maxLength);

        var _children = [{
            _name: "div",
            _html: text
        }];
        if (thiz.conflictSlotObject[data.id]) {
            _children.push({
                _name: "icon",
                "class": "CTConflictSlotIcon alert-box"
            });
        }

        return Dom.newDOMElement({
            _name: "hbox",
            "class": "RegistrationSlotComboItem",
            _children: _children
        });
    };
    this.slotDisplayValue = function (data) {
        if (!data) return "&nbsp;";
        return "RS #" + (data.slot + 1);
    };

    this.chargeCategoryRenderer = function (data, selected) {
        if (!data) return "&nbsp;";
        return "<span>" + data.name + "</span>";
    };

    this.chargeCategoryDecorator = function (node, data) {
    };

    this.chargeCategoryDisplayValue = function (data) {
        if (!data) return "&nbsp;";
        return "<span>" + data.name + "</span>";
    };

    this.paymentTypeCombo.renderer = this.paymentTypeRenderer;
    this.paymentTypeCombo.comparer = this.paymentTypeComparer;
    this.couponCodeCombo.renderer = this.couponCodeRenderer;
    this.couponCodeCombo.decorator = this.couponDecorator;
    this.couponCodeCombo.setPopupClass("ClassCouponCodeComboPopup");
    this.paymentPlanCombo.renderer = this.paymentPlanComboRenderer;

    this.registrationsObject = {};    
    var orderBy = {
        propertyName: "memberFullName",
        asc: true
    };
    if (thiz.options.action == "addClassForMember" || thiz.options.action == "reEnrollMemberClass") {
        orderBy = {
            propertyName: "className",
            asc: true
        };
    }
    
    this.studentSource = {
        classId: thiz.options.classId,
        memberId: thiz.options.memberId,
        classIds: thiz.options.addedClassIds,
        memberIds: thiz.options.addedMemberIds,
        order: orderBy,
        loadPage: function (pageIndex, pageSize, handler, failed) {
            window.defaultIndicator.busy("Loading...");
            thiz._updateMovedLessonClassIn();            
            
            // TODO Remove classIdMemberIdMap
            var classIdMemberIdMap = {};
            if (thiz.options.action == "addClassForMember" || thiz.options.action == "reEnrollMemberClass") {
                for (var i = 0; i < this.classIds.length; i ++) {
                    classIdMemberIdMap[this.classIds[i]] = [this.memberId];
                }
            } else {
                classIdMemberIdMap[this.classId] = this.memberIds
            }
            var unappliedPaymentWrapper = Dom.findParentWithClass(thiz.useUnappliedPayment, "UnappliedPaymentWrapper");
            if (unappliedPaymentWrapper && !Dom.hasClass(unappliedPaymentWrapper, "Hidden")){
                for (var key in thiz.registrationsObject) {
                    thiz.registrationsObject[key].allowUnappliedPayment = thiz.useUnappliedPayment.checked;
                }
            }
            
            var buildOptions = {
                taxApplication: thiz.defaultTaxApplication,
                order: {name: this.order.propertyName, asc: this.order.asc},
                reenrollReg: thiz.options.isReenrollingReg
            }
            $classToolService.buildRegistrations(classIdMemberIdMap, thiz.registrationsObject, buildOptions,
                function (list) {       
                    thiz.registrationsObject = {};
                    var reCheckRegistration = false;
                    for (var i = 0; i < list.length; i ++) {
                        thiz.registrationsObject[list[i].id] = list[i];
                        thiz.registrationsObject[list[i].id].classTransferring = thiz.registrationsObject[list[i].id].classTransferInfo? thiz.registrationsObject[list[i].id].classTransferInfo.classTransferring : false;
                        if (thiz.registrationsObject[list[i].id].classTransferring){
                            reCheckRegistration = true;
                        }
                        if (thiz.options.mapMemberSlot) {
                            var key = list[i].classId + "_" + list[i].memberId;
                            var selectedSlot = thiz.options.mapMemberSlot[key];
                            if (thiz.options && thiz.options.mapMemberSlot && thiz.options.mapMemberSlot[key] >= 0) {
                                if (list[i].assignedSlot < 0) {
                                    list[i].assignedSlot = thiz.options.mapMemberSlot[key];
                                    reCheckRegistration = true;
                                }
                            }  
                        }
                                              
                    }
                    handler(list, list.length);
                    thiz.renderFeeNote();
                    window.defaultIndicator.done();
                    if (reCheckRegistration)  {
                        thiz.checkRegistrations();
                    } else {
                        thiz.invalidateElements();
                    }
                },
                function (err) {
                    window.defaultIndicator.done();
                });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };

    this.bind("click", this.studentListClickedHandler, this.studentList);
    this.bind("change", this.studentListChangedHandler, this.studentList);
    this.bind("click", this.addMoreStudentButtonClickedHandler, this.addMoreStudentButton);
    this.bind("click", this.addMoreClassesButtonClickedHandler, this.addMoreClassesButton);
    this.bind("p:ItemSelected", this.studentListComboChangedHandler, this.studentList);
    this.bind("click", this.updateRegSlotButtonClickedHandler, this.updateRegSlotButton);
    this.bind("click", this.overrideConflictButtonClickedHandler, this.overrideConflictButton);
    this.bind("click", this.removeOverrideConflictButtonClickedHandler, this.removeOverrideConflictButton);
    this.bind("click", this.updatePaymentTypeButtonClickedHandler, this.updatePaymentTypeButton);
    this.bind("change", this.popupAllowOverrideCheckboxChangedHandler, this.popupAllowOverrideCheckbox);
    this.bind("click", this.assignRegSlotDetailInfoClickedHandler, this.assignRegSlotDetailInfo);
    this.bind("click", this.updateCouponButtonClickedHandler, this.updateCouponButton);
    this.bind("click", this.chargeProgAddlFeeButtonClickedHandler, this.chargeProgAddlFeeButton);
    this.bind("click", this.waiveProgAddlFeeButtonClickedHandler, this.waiveProgAddlFeeButton);
    this.bind("click", this.sendEmailReceiptClickedHandler, this.sendEmailReceipt);
    this.bind("click", this.dontSendEmailReceiptClickedHandler, this.dontSendEmailReceipt);
    this.bind("click", this.updatePaymentPlanButtonClickedHandler, this.updatePaymentPlanButton);
    // this.bind("click", this.viewPaymentPlanDetailClickedHandler, this.paymentPlanDetailInfo);
    this.bind("click", this.updatePolicyStartDateButtonClickedHandler, this.updatePolicyStartDateButton);
    this.bind("click", this.updatePolicyDropDateButtonClickedHandler, this.updatePolicyDropDateButton);
    this.bind("p:ValueUpdated", this.studentListValueUpdatedHandler, this.studentList);
    this.bind("change", this.useUnappliedPaymentChangedHandler, this.useUnappliedPayment);
    this.bind("click", this.feeInfoPopupClickedHandler, this.feeInfoPopupContent);
    this.bind("p:ItemSelected", this.feeInfoPopupComboChangedHandler, this.feeInfoPopupContent);

    Dom.registerEvent(this.studentList, "input", this.studentListInputHandler.bind(this), true);
    this.bind("click", this.feeInfoPopupHeaderClickedHandler, this.feeInfoPopupHeader);

    InfoTip.install(document, {
        match: function (node) {
            return Dom.hasClass(node, "CTConflictSlotIcon");
        },
        getMessage: function (target) {
            return Dom.newDOMElement({
                _name: "div",
                _html: "The instructor is not available or in conflict with others. Please resolve it."
            });
        },
        type: "error",
        hAlign: "left-inside",
        offsetX: -17
    });

    this.bind("click", function () {
        thiz.slotInstancePopup.hide();
    }, this.slotInstancePopupArrow);
    this.bind("click", function () {
        thiz.classInstancePopup.hide();
    }, this.classInstancePopupArrow);
    this.bind("click", function () {
        thiz.conflictsInfoPopup.hide();
    }, this.conflictsInfoPopupArrow);
    this.bind("click", function () {
        thiz.cleanFeeInputRegisterredEvents();
        console.log("feeInfoPopup.hide");
        thiz.feeInfoPopup.hide();
    }, this.feeInfoPopupArrow);

    this.bind("p:PopupHidden", function () {
        thiz.conflictsInfoPopupOpener = null;
    }, this.conflictsInfoPopup);

    this.bind("p:PopupHidden", function () {
        window.setTimeout(function () {
            thiz.onHideFeePopup();
        }, 200);
    }, this.feeInfoPopup);

    //var thiz = this;
    this.slotInstancePopup.popupOpacity = 0.9999;
    this.slotInstanceBackgroundBox.translateDelta = 0.5;
    this.slotInstancePopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        }
        thiz.slotInstanceBackgroundBox.onSizeChanged();
    }
    
    this.classInstancePopup.popupOpacity = 0.9999;
    this.classInstanceBackgroundBox.translateDelta = 0.5;
    this.classInstancePopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.classInstancePopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.classInstancePopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.classInstancePopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.classInstancePopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.classInstancePopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.classInstancePopupContent.parentNode, "PopupLeftInside");
        }
        thiz.classInstanceBackgroundBox.onSizeChanged();
    }

    this.conflictsInfoPopup.popupOpacity = 0.9999;
    this.conflictsInfoBackgroundBox.translateDelta = 0.5;
    this.conflictsInfoPopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.conflictsInfoPopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.conflictsInfoPopupContent.parentNode, "PopupAlignBottom");
        if (vAlign == "top") {
            Dom.addClass(thiz.conflictsInfoPopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.conflictsInfoPopupContent.parentNode, "PopupAlignBottom");
        }
        thiz.conflictsInfoBackgroundBox.onSizeChanged();
    }

    this.feeInfoPopup.popupOpacity = 0.9999;
    this.feeInfoBackgroundBox.translateDelta = 0.5;
    this.feeInfoPopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.feeInfoPopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.feeInfoPopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.feeInfoPopupContent.parentNode, "PopupLeftInside");

        if (vAlign == "top") {
            Dom.addClass(thiz.feeInfoPopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.feeInfoPopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.feeInfoPopupContent.parentNode, "PopupLeftInside");
        }

        thiz.feeInfoBackgroundBox.onSizeChanged();
    }

    this.studentDataTable.addListener({
        onSelectionChanged: function() {
            if(thiz.studentDataTable.getSelectedItems().length > 0) {
                Dom.removeClass(thiz.actionsWrapper, "Disabled");
                thiz.assignRegSlotCombo.node().removeAttribute("disabled");
                if (thiz.assignRegSlotCombo.getSelectedItem() != null) {
                    thiz.updateRegSlotButton.removeAttribute("disabled");
                    Dom.removeClass(thiz.assignRegSlotDetailInfo, "Disabled");
                }
                thiz.overrideConflictButton.removeAttribute("disabled");
                thiz.removeOverrideConflictButton.removeAttribute("disabled");
                if (thiz.paymentTypeCombo.getSelectedItem() != null) thiz.updatePaymentTypeButton.removeAttribute("disabled");
                thiz.paymentTypeCombo.node().removeAttribute("disabled");
                thiz.couponCodeCombo.node().removeAttribute("disabled");
                thiz.updateCouponButton.removeAttribute("disabled");
                thiz.chargeProgAddlFeeButton.removeAttribute("disabled");
                thiz.waiveProgAddlFeeButton.removeAttribute("disabled");
                thiz.sendEmailReceipt.removeAttribute("disabled");
                thiz.dontSendEmailReceipt.removeAttribute("disabled");
                thiz.paymentPlanCombo.node().removeAttribute("disabled");
                if (thiz.paymentPlanCombo.getSelectedItem() != null) {
                    thiz.updatePaymentPlanButton.removeAttribute("disabled");
                }
                var metaData = thiz.metaDataObject[thiz.options.classId] || {classDetailInfo: {}};
                thiz.policyStartDateWidget.setEnabled(metaData.classDetailInfo.editableSddStartDateDuringReg);
                thiz.policyDropDateWidget.setEnabled(metaData.classDetailInfo.editableSddDropDateDuringReg);
            } else {
                Dom.addClass(thiz.actionsWrapper, "Disabled");
                thiz.assignRegSlotCombo.node().setAttribute("disabled", "disabled");
                thiz.updateRegSlotButton.setAttribute("disabled", "disabled");
                thiz.overrideConflictButton.setAttribute("disabled", "disabled");
                thiz.removeOverrideConflictButton.setAttribute("disabled", "disabled");
                thiz.updatePaymentTypeButton.setAttribute("disabled", "disabled");
                thiz.paymentTypeCombo.node().setAttribute("disabled", "disabled");
                Dom.addClass(thiz.assignRegSlotDetailInfo, "Disabled");
                thiz.couponCodeCombo.node().setAttribute("disabled", "disabled");
                thiz.updateCouponButton.setAttribute("disabled", "disabled");
                thiz.chargeProgAddlFeeButton.setAttribute("disabled", "disabled");
                thiz.waiveProgAddlFeeButton.setAttribute("disabled", "disabled");
                thiz.sendEmailReceipt.setAttribute("disabled", "disabled");
                thiz.dontSendEmailReceipt.setAttribute("disabled", "disabled");
                thiz.paymentPlanCombo.node().setAttribute("disabled", "disabled");
                if (thiz.paymentPlanCombo.getSelectedItem() != null) {
                    thiz.updatePaymentPlanButton.setAttribute("disabled", "disabled");
                }
                thiz.policyStartDateWidget.setEnabled(false);
                thiz.policyDropDateWidget.setEnabled(false);
            }
        }
    });

    this.bind("p:ItemSelected", function () {
        if (thiz.assignRegSlotCombo.getSelectedItem() && thiz.studentDataTable.getSelectedItems().length > 0) {
            thiz.updateRegSlotButton.removeAttribute("disabled");
            Dom.removeClass(thiz.assignRegSlotDetailInfo, "Disabled");
        } else {
            thiz.updateRegSlotButton.setAttribute("disabled", "disabled");
            Dom.addClass(thiz.assignRegSlotDetailInfo, "Disabled");
        }
    }, this.assignRegSlotCombo.node());

    this.bind("p:ItemSelected", function () {
        if (thiz.paymentTypeCombo.getSelectedItem() && thiz.studentDataTable.getSelectedItems().length > 0) {
            thiz.updatePaymentTypeButton.removeAttribute("disabled");
        } else {
            thiz.updatePaymentTypeButton.setAttribute("disabled", "disabled");
        }
    }, this.paymentTypeCombo.node());

    this.bind("p:ItemSelected", function () {
        if (thiz.studentDataTable.getSelectedItems().length > 0) {
            thiz.updateCouponButton.removeAttribute("disabled");
        } else {
            thiz.updateCouponButton.setAttribute("disabled", "disabled");
        }
    }, this.couponCodeCombo);

    this.bind("p:ItemSelected", function () {
        if (thiz.paymentPlanCombo.getSelectedItem() && thiz.studentDataTable.getSelectedItems().length > 0) {
            thiz.updatePaymentPlanButton.removeAttribute("disabled");
        } else {
            thiz.updatePaymentPlanButton.setAttribute("disabled", "disabled");
        }
    }, this.paymentPlanCombo);

    this.bind("p:ValueUpdated", function () {
        thiz.updatePolicyStartDateButton.removeAttribute("disabled");
    }, this.policyStartDateWidget);

    this.bind("p:ValueUpdated", function () {
        thiz.updatePolicyDropDateButton.removeAttribute("disabled");
    }, this.policyDropDateWidget);

    this.totalFeeName = "Total Fee";// (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan)? "Reg Fee" : "Total Fee";
    thiz.isClassTransferChanging = false;
    thiz.additionalFeeInput = null;
}
__extend(BaseTemplatedWidget, RegistrationsWidget);

RegistrationsWidget.prototype.onAttached = function (firstTime) {
    if (!firstTime) return
    if (!this.options) return;
    var thiz = this;
    this.studentSource.memberIds = this.options.addedMemberIds;
    this.studentSource.classIds = this.options.addedClassIds;
    
    if (window.LOGIN_INFO) {
        thiz.reloadRegistrationWidget(function () {
            thiz.renderRegistrationsWidget();
        });
    } else {
        $classAdminService.getAccountInfo(function (res) {
            window.LOGIN_INFO = res;
            thiz.reloadRegistrationWidget(function () {
                thiz.renderRegistrationsWidget();
            });
        }, function (err) {
            thiz.reloadRegistrationWidget(function () {
                thiz.renderRegistrationsWidget();
            });
        }, "Loading...");
    }
    
    
    
};

RegistrationsWidget.prototype.reloadRegistrationWidget = function (callback) {
    var classIds = [];
    if (this.options.classId) {
        classIds = [this.options.classId];
    } else {
        classIds = this.options.addedClassIds;
    }
    if (!classIds || classIds.length == 0) return;   
    
    this.metaDataObject = {};
    this.conflictSlotObject = {};
    var thiz = this;
    console.log("this.options.movedLessonClassIns", this.options.movedLessonClassIns);
    var isClassTransfer = (this.options.movedLessonClassIns && this.options.movedLessonClassIns.length)? true : false;
    $classToolService.getMetaData(classIds, isClassTransfer, function (res) {
        thiz.metaDataObject = res;
        
        thiz.allowStartDropDate = false;
        thiz.allowClassPaymentPlan = false;
        thiz.hasCoupon = false;
        thiz.hasSubProgAddlFee = false;
        thiz.paymentTypes = [];
        thiz.defaultTax = null;
        thiz.defaultTaxApplication = null;
        function generateTaxApplicationFromTax(tax) {
            return {
                id: -1,
                taxId: tax.id,
                taxRatePercentage: tax.ratePercentage,
                taxName: tax.name + " (" + Util.formatNumber(tax.ratePercentage) + "%)",
                description: tax.name,
                chargeCategoryId: tax.chargeCategoryId
            };
        };
        for (var key in res) {
            var classDetailInfo = res[key].classDetailInfo;
            if (classDetailInfo.editableSddStartDateDuringReg || classDetailInfo.editableSddDropDateDuringReg) thiz.allowStartDropDate = true;
            if (res[key].allowClassPaymentPlan) thiz.allowClassPaymentPlan = true;
            if (res[key].hasCoupon) thiz.hasCoupon = true;
            if (res[key].hasSubProgAddlFee) thiz.hasSubProgAddlFee = true;
            if (thiz.paymentTypes.length == 0) {
                for (var paymentTypeKey in res[key].paymentTypes) {
                    thiz.paymentTypes.push({key: paymentTypeKey, name: res[key].paymentTypes[paymentTypeKey]});
                }
            }
            //TODO fix
            thiz.subProgAddlFeeTitle = res[key].subProgAddlFeeTitle;
            if (!thiz.defaultTax) thiz.defaultTax = res[key].defaultTax;
            if (!thiz.defaultTaxApplication) {
                thiz.defaultTaxApplication = thiz.defaultTax ? generateTaxApplicationFromTax(thiz.defaultTax) : null;
            }
            if (res[key] && res[key].instructorConflictSlots) {
                res[key].instructorConflictSlots.forEach(function (id) {
                    thiz.conflictSlotObject[id] = true;
                });
            }
        }
        thiz.totalFeeName = (thiz.allowClassPaymentPlan) ? "Reg Fee" : "Total Fee";
        thiz.initializeDataTable();
        if (callback) callback(); 
        
    }, function (err) {
        if (callback) callback(); 
    }, "Loading...");
};

RegistrationsWidget.prototype.renderRegistrationsWidget = function () {
    var action = this.options.action;
    var thiz = this;
    if (action == "addClassForMember" || action == "reEnrollMemberClass") {
        this.className.innerHTML = "Add New Registration for <strong>" + this.options.memberFullName + "</strong>";
        Dom.addClass(this.addMoreStudentButton, "Hidden");
        Dom.removeClass(this.addMoreClassesButton, "Hidden");
        Dom.addClass(this.regSlotActionWrapper, "Hidden");
        Dom.addClass(this.conflictsActionWrapper, "Hidden");
        Dom.addClass(this.startDropDateWrapper, "Hidden");
        Dom.addClass(this.paymentPlanWrapper, "Hidden");
        Dom.addClass(this.subProgAddlFeeWrapper, "Hidden");
        Dom.addClass(this.couponWrapper, "Hidden");
        
    } else {
        var metaData = this.metaDataObject[this.options.classId];
        var classInfo = metaData.classDetailInfo;
        if (!classInfo) return;
        
        if (this.options.movedLessonClassIns && this.options.movedLessonClassIns.length) {
            var targetStr = this.options.movedLessonClassIns.length > 1
                ? (this.options.movedLessonClassIns.length + " selected Registrations") : this.options.movedLessonClassIns[0].name + "'s Registration";
            this.className.innerHTML = "Move <strong>" + targetStr + "</strong>"
                + (this.options.movedLessonClassIns.length == 1 ? " from class <strong>" + this.options.movedLessonClassIns[0].class_title + "</strong>" : "")
                + " to class <strong>" + classInfo.title + "</strong>";
            Dom.toggleClass(this.containerWrapper, "MoveClass", true);
        } else {
            Dom.toggleClass(this.containerWrapper, "MoveClass", false);
            this.className.innerHTML = "Add New Registration to Class: <strong>" + classInfo.title + "</strong>";
        }
        
        Dom.addClass(this.addMoreClassesButton, "Hidden");
        Dom.removeClass(this.addMoreStudentButton, "Hidden");
        Dom.removeClass(this.regSlotActionWrapper, "Hidden");
        Dom.removeClass(this.conflictsActionWrapper, "Hidden");
        Dom.removeClass(this.startDropDateWrapper, "Hidden");
        Dom.removeClass(this.paymentPlanWrapper, "Hidden");
        Dom.removeClass(this.subProgAddlFeeWrapper, "Hidden");
        Dom.removeClass(this.couponWrapper, "Hidden");
        
        this.assignRegSlotCombo.useHtml = true;
        this.assignRegSlotCombo.renderer = this.slotRenderer;
        this.assignRegSlotCombo.getDisplayValue = this.slotDisplayValue;
        this.assignRegSlotCombo.setItems([null].concat(classInfo.slots));
        
        this.assignRegSlotCombo.setPopupClass("SlotItemPopup");
        var instructorConflictSlots = metaData.instructorConflictSlots;
        if (instructorConflictSlots && instructorConflictSlots.length > 0) {
            instructorConflictSlots.forEach(function (id) {
                thiz.assignRegSlotCombo.setItemEnabled({id: id}, false);
            });
        }
        if (this.allowStartDropDate) {
            var classTimezoneProvider = {
                getTimezoneId: function () {
                    return classInfo.timezoneId;
                },
                getName: function () {
                    return "Class time zone";
                }
            };
            this.policyStartDateWidget.setCustomTimezoneProvider(classTimezoneProvider);
            this.policyDropDateWidget.setCustomTimezoneProvider(classTimezoneProvider);
            this.policyStartDateWidget.setMinDate(ClassUtils.transformToTimeZone(classInfo.minSddStartDate, classInfo.timezoneId));
            this.policyStartDateWidget.setMaxDate(ClassUtils.transformToTimeZone(classInfo.maxSddStartDate, classInfo.timezoneId));
            this.policyDropDateWidget.setMinDate(ClassUtils.transformToTimeZone(classInfo.minSddDropDate, classInfo.timezoneId));
            this.policyDropDateWidget.setMaxDate(ClassUtils.transformToTimeZone(classInfo.maxSddDropDate, classInfo.timezoneId));
            if (!classInfo.editableSddStartDateDuringReg) this.policyStartDateWidget.setEnabled(false);
            if (!classInfo.editableSddDropDateDuringReg) this.policyDropDateWidget.setEnabled(false);
        } else {
            Dom.hide(this.startDropDateWrapper);
        }
        
        if (this.allowClassPaymentPlan) {
            this.paymentPlanCombo.useHtml = true;
            this.paymentPlanCombo.setItems([null].concat(classInfo.paymentPlans));
        } else {
            Dom.hide(this.paymentPlanWrapper);    
        }
        
        if (this.hasCoupon) {
            var couponItems = [null];
            this.couponCodeCombo.useHtml = true;
            this.couponCodeCombo.getDisplayValue = this.couponCodeDisplayValue;
            var couponCodes = [null].concat(Object.values(metaData.couponCodes));
            this.couponCodeCombo.setItems(couponCodes);
        } else {
            Dom.hide(this.couponWrapper);
        }
        
        //TOTO fix action sub prog fee title
        if (metaData.hasSubProgAddlFee && metaData.subProgAddlFeeTitle.length > 0) {
            this.subProgAddlFeeLabel.innerHTML = metaData.subProgAddlFeeTitle
                + " (" + (ClassUtils.toCurrency(metaData.subProgAddlFee)) + ")";
        } else {
            Dom.hide(this.subProgAddlFeeWrapper);
        } 
    }
    
    if (!this.paymentTypes) this.paymentTypes = [];
    this.paymentTypeCombo.useHtml = true;
    var paymentTypes = [null];
    for (var i = 0; i < this.paymentTypes.length; i++) {
        paymentTypes.push(this.paymentTypes[i]);
    }
    paymentTypes.push({key: "waive", name: "Waive"});
    this.paymentTypeCombo.setItems(paymentTypes);    

    this.studentDataTable.disabledCheckBoxWhenCheckAll(false);
    this.studentDataTable.setup();
    
    this.paginator.setup({
        getTotalItemText: function(total) {
            return String.format("Total %d users", total);
        },
        showPaginator: true,
        withoutStatus: true,
        onPageLoaded: function (p, count) {

        },
        comparer: function (a, b) {
            return a.id == b.id;
        },
        useButtons: false,
        avoidPageSizeRecalculation: true
    });
    this.paginator.pageSize = 999999;
    this.paginator.needCalculatePageSize = function () { return false; };
    this.paginator.control(this.studentDataTable);
    this.paginator.setSource(this.studentSource);
};

RegistrationsWidget.prototype.initializeDataTable = function () {
    var thiz = this;
    var isReEnrollMemberClass = (this.options.action == "reEnrollMemberClass");
    if (this.options.action == "addClassForMember" || this.options.action == "reEnrollMemberClass") {
        this.studentDataTable.column(new DataTable.DomNodeColumn("Class Name", function (data) {
            return new Dom.newDOMElement({
                _name: "hbox",
                "class": "ClassNameWrapper",
                _children: [{
                    _name: "div",
                    "class": "ClassName",
                    "title": "" + data.className,
                    _html: "" + data.className
                }, {
                    _name: "div",
                    "class": "IconClassInfo",
                    _children: [{
                        _name: "icon",
                        "class": "information"
                    }]                    
                }]
            });
        }).sortable("className").width("1*", "15em"));
    } else {
        this.studentDataTable.column(new DataTable.DomNodeColumn("Member", function (data) {
            var gender = ClassUtils.getGenderByCode(data.sex, Gender.Female);
            return new Dom.newDOMElement({
                name: "div",
                _children: [{
                    _name: "div",
                    "class": "MemberName",
                    "title": "" + data.memberFullName,
                    _html: "<span>" + data.memberFullName + "</span>" + (data.memberStatusId == 30 ? "<icon class=\"alert SuspendedMember\" style=\"color: #e4c51f;margin-left: 0.3em;\"></icon>" : "")
                },
                {
                    _name: "div",
                    "class": "MemberAge",
                    _html: data.age + " yo, " + gender.displayName
                },
                {
                    _name: "div",
                    "class": "MemberAccount",
                    _html: "<label>Acc: </label><span>" + data.accountFullName + "</span>"
                }]
            });
        }).sortable("memberFullName").width("1*", "15em"));
    }


    var regSlotColumn = new DataTable.DomNodeColumn("Reg Slot", function (data) {
        var metaData = thiz.metaDataObject[data.classId] || {classDetailInfo: {}};
        var regSlotWarpper = document.createElement("div");
        Dom.addClass(regSlotWarpper, "RegSlotWarpper");
        
        regSlotWarpper.setAttribute("id", "regSlotWrapper_" + data.id);
        thiz.renderRegSlotColumn(regSlotWarpper, data);
        return regSlotWarpper;
    }).width("10em");
    regSlotColumn.getContentTitle = function (data, row, col) {
        return "";
    };
    this.studentDataTable.column(regSlotColumn);

    var conflictsColumn = new DataTable.DomNodeColumn("Warnings", function (data) {
        var conflictsWrapper = document.createElement("div");
        Dom.addClass(conflictsWrapper, "ConflictsWrapper");
        conflictsWrapper.setAttribute("id", "conflictsWrapper_" + data.id);
        thiz.renderConflictsColumn(conflictsWrapper, data);
        return conflictsWrapper;
    }).width("16em");
    conflictsColumn.getContentTitle = function (data, row, col) {
        return "";
    };
    this.studentDataTable.column(conflictsColumn);

    if (this.allowStartDropDate) {
        var startDropDateCol = new DataTable.DomNodeColumn("Start/Drop Date", function (data) {
            return thiz.renderStartDropDateColumn(data);
        }).width("16em");
        this.studentDataTable.column(startDropDateCol);
    }

    if (this.allowClassPaymentPlan) {
        var paymentPlanCol = new DataTable.DomNodeColumn("Payment Plan", function (data) {
            return thiz.renderPaymentPlanColumn(data);
        }).width("14em");
        this.studentDataTable.column(paymentPlanCol);
    }
        
    if (this.hasCoupon) {
        this.studentDataTable.column(new DataTable.DomNodeColumn("Coupon", function (data) {
            return thiz.renderCouponColumn(data);
        }).width("10em"));
    }
    
    if (this.hasSubProgAddlFee) {
        if (this.options.action == "addClassForMember" || this.options.action == "reEnrollMemberClass") {
            this.studentDataTable.column(new DataTable.DomNodeColumn("Sub Program Fee/Discount", function (data) {
                return thiz.renderSubProgFeeColumn(data);
            }).width("8em"));
        } else {
            this.studentDataTable.column(new DataTable.DomNodeColumn(thiz.subProgAddlFeeTitle, function (data) {
                return thiz.renderSubProgFeeColumn(data);
            }).width("8em"));    
        }
        
    }

    if (!this.allowClassPaymentPlan) {
        var classFeeCol = new DataTable.DomNodeColumn("Class Fee", function (data) {
            return thiz.renderClassFeeColumn(data);
        }).width("10em");
        this.studentDataTable.column(classFeeCol);
    }
    if (!this.allowClassPaymentPlan) {
        var w = isReEnrollMemberClass? "7em" : "10em";
        var regFeeCol = new DataTable.DomNodeColumn("Reg Fee", function (data) {
            return thiz.renderRegFeeColumn(data);
        }).width(w);
        this.studentDataTable.column(regFeeCol);
    }

    var totalFeeColumn = new DataTable.DomNodeColumn("Total Fee", function (data) {
        var totalFeeWrapper = document.createElement("div");
        Dom.addClass(totalFeeWrapper, "TotalFeeWrapper");
        if (data.movedLessonClassInId > 0 && data.classTransferring) {
            Dom.addClass(totalFeeWrapper, "ClassTransferFee");
        }
        var totalFee = document.createElement("div");
        Dom.addClass(totalFee, "TotalFee");
        totalFee.setAttribute("id", "totalFee_" + data.id);
        totalFeeWrapper.setAttribute("id", "totalFeeWrapper_" + data.id);
        if (data.fee.isWaived) {
            totalFee.innerHTML = "Waived";
            Dom.addClass(totalFeeWrapper, "Waived");
            totalFeeWrapper.appendChild(totalFee);
            var totalFeeAction = document.createElement("icon");
            Dom.addClass(totalFeeAction, "TotalFeeAction");
            Dom.addClass(totalFeeAction, "AddTotalFee");
            Dom.addClass(totalFeeAction, "plus-circle");
            totalFeeWrapper.appendChild(totalFeeAction);
            var classFeeWrapper = document.getElementById("classFee_" + data.id);
            if(classFeeWrapper) Dom.addClass(classFeeWrapper, "Waived");

            var regFeeWrapper = document.getElementById("regFee_" + data.id);
            if(regFeeWrapper) Dom.addClass(regFeeWrapper, "Waived");

            var subProgFeeWrapper = document.getElementById("subProgAddlFee_" + data.id);
            if(subProgFeeWrapper) Dom.addClass(subProgFeeWrapper, "Waived");

        } else if (data.fee.totalFee >= 0) {
            var feeContent = document.createElement("div");
            Dom.addClass(feeContent, "FeeContent");
            var feeVal = -1;
            if (data.fee.totalFee == 0 && data.fee.totalFeeWithoutUnappliedPayment == 0) {
                if (data.paymentPlanId > 0) {
                    feeVal = 0;
                }
            } else {
                feeVal = data.fee.totalFee;
            }
            if (data.movedLessonClassInId > 0) {
                feeContent.innerHTML = ClassUtils.toCurrency(data.classTransferInfo.billedTodayAmount);
                totalFee.appendChild(feeContent);
                if (data.fee.allFeeInfo && !ClassUtils.isEmpty(data.fee.allFeeInfo)) {
                    var icon = document.createElement("icon");
                    Dom.addClass(icon, "information");
                    Dom.addClass(icon, "FeeDetailInfo");
                    totalFee.appendChild(icon);
                }
                totalFeeWrapper.appendChild(totalFee);
            } else {
                feeContent.innerHTML =  (feeVal >= 0)? (ClassUtils.toCurrency(feeVal)) : "";
                
                totalFee.appendChild(feeContent);
                if (data.fee.allFeeInfo && !ClassUtils.isEmpty(data.fee.allFeeInfo)) {
                    var icon = document.createElement("icon");
                    Dom.addClass(icon, "information");
                    Dom.addClass(icon, "FeeDetailInfo");
                    totalFee.appendChild(icon);
                }
                totalFeeWrapper.appendChild(totalFee);
                if (data.fee.totalFee > 0 || data.fee.totalFeeWithoutUnappliedPayment > 0) {
                    var totalFeeAction = document.createElement("icon");
                    Dom.addClass(totalFeeAction, "TotalFeeAction");
                    Dom.addClass(totalFeeAction, "RemoveTotalFee");
                    Dom.addClass(totalFeeAction, "close-circle-outline");
                    totalFeeWrapper.appendChild(totalFeeAction);
                }
            }
            
            
        }
        return totalFeeWrapper;
    }).width("11em");
    totalFeeColumn.title = this.totalFeeName;
    conflictsColumn.getContentTitle = function (data, row, col) {
        return "";
    };
    this.studentDataTable.column(totalFeeColumn);

    var paymentTypeColumn = new DataTable.DomNodeColumn("Payment Type", function (data) {
        var paymentTypeWrapper = document.createElement("div");
        Dom.addClass(paymentTypeWrapper, "PaymentTypeWrapper");
        paymentTypeWrapper.setAttribute("id", "paymentTypeWrapper_" + data.id);

        var paymentTypeContainer = document.createElement("div");
        Dom.addClass(paymentTypeContainer, "PaymentTypeContainer");
        paymentTypeContainer.appendChild(paymentTypeWrapper);

        console.log("paymentTypeColumn", data, (data.movedLessonClassInId && data.classTransferring && data.classTransferInfo && data.classTransferInfo.totalAmount == 0));
        if ((data.fee.totalFee == 0 && data.fee.totalFeeWithoutUnappliedPayment == 0)
            || ( data.movedLessonClassInId && data.classTransferring && data.classTransferInfo 
            && data.classTransferInfo.totalAmount == 0 && data.classTransferInfo.additionalFee == 0  
            && (!data.classTransferInfo.transferSourceKeys ||  data.classTransferInfo.transferSourceKeys.length == 0))) {
            Dom.addClass(paymentTypeWrapper, "NoFee");
        }

        if (data.fee.isWaived) {
            Dom.addClass(paymentTypeWrapper, "Waived");
        }

        var noPaymentWrapper = document.createElement("div");
        Dom.addClass(noPaymentWrapper, "NoPaymentContent");
        noPaymentWrapper.setAttribute("id", "noPaymentContent_" + data.id);
        noPaymentWrapper.innerHTML = "[No Payment Needed]";
        paymentTypeWrapper.appendChild(noPaymentWrapper);

        var paymentTypeContent = document.createElement("div");
        Dom.addClass(paymentTypeContent, "PaymentTypeContent");
        paymentTypeWrapper.appendChild(paymentTypeContent);
        thiz.renderPaymentTypeContent(paymentTypeContent, data);
        var metaData = thiz.metaDataObject[data.classId] || {classDetailInfo: {}};

        var paymentTypes = [];
        for (var key in metaData.paymentTypes) {
            paymentTypes.push({key: key, name: metaData.paymentTypes[key]});
        }
        var paymentCombo = new ComboManager();
        paymentTypeWrapper._paymentComboWidget = paymentCombo;
        Dom.addClass(paymentCombo.node(), "MemberPaymentType");
        paymentCombo.horizontalAlignment = "right-inside";
        paymentCombo.renderer = thiz.paymentTypeRenderer;
        paymentCombo.comparer = thiz.paymentTypeComparer;
        paymentCombo.setItems(paymentTypes);
        paymentCombo.into(paymentTypeWrapper);
        paymentCombo.getCurrentItemDisplayText = function () {
            return "";
        }
        return paymentTypeContainer;
    }).width("18em");

    paymentTypeColumn.getContentTitle = function (data, row, col) {
        return "";
    };
    this.studentDataTable.column(paymentTypeColumn);

    var emailReceiptCol = new DataTable.DomNodeColumn("Email Receipt", function (data) {
        return thiz.renderEmailReceiptColumn(data);
    }).width("10em");
    this.studentDataTable.column(emailReceiptCol);

    var actions = [{
        id: "delete", type: "delete", title: "Delete",
        isApplicable: function(item) {
            return true;
        },
        handler: function (item) {
            thiz.deleteItemHandler(item);
        }
    }];
    var actionCol = new DataTable.ActionColumn(actions);
    actionCol.title = "";
    this.studentDataTable.column(actionCol.width("3.5em"));

    this.studentDataTable.selector(true, false);
    this.studentDataTable.setDefaultSelectionHandler({
        run: function (item) {}
    });
    this.studentDataTable.useFloatingHeader = true;
    
    this.bind("mouseover", this.showInvalidPopup, this.studentDataTable.node());
    this.bind("mouseout", this.hideInvalidPopup, this.studentDataTable.node());
};

RegistrationsWidget.prototype.showInvalidPopup = function(ev) {
    var target = Dom.getTarget(ev);
    if (!target) return;
    
    if (Dom.findParentWithClass(target, "SuspendedMember")) {
        if (this._infoTips) {
            this._infoTips.kill();
        }
        this._infoTips = InfoTip.show(target, "Member is suspended and will be active when the registration is completed.", false, null, "error", "left-inside", -(Dom.getOffsetWidth(target)/2 + 11));
        this._infoTips.setPopupClass("MemberInvalidPopup");
    }
};

RegistrationsWidget.prototype.hideInvalidPopup = function(ev) {
    var target = Dom.getTarget(ev);

    if(target && target.__tip) {
        target.__tip.isVisible = function(){
            return true;
        };
        InfoTip.show(target);
        if (this._infoTips) {
            this._infoTips.kill();
        }
    }
};

RegistrationsWidget.prototype.renderConflictsColumn = function (conflictsWrapper, data) {
    conflictsWrapper.innerHTML = "";
    Dom.removeClass(conflictsWrapper, "DontOverride");
    Dom.removeClass(conflictsWrapper, "Passed");
    Dom.removeClass(conflictsWrapper, "Override");
    Dom.removeClass(conflictsWrapper, "OverrideChecked");
    Dom.removeClass(conflictsWrapper, "ShowWarningAndDontOverride");
    var conflictsStatus;
    if (!data.allowOverride) {
        Dom.addClass(conflictsWrapper, "DontOverride");
        conflictsStatus = document.createElement("icon");
        Dom.addClass(conflictsStatus, "DontOverride");
        Dom.addClass(conflictsStatus, "alert-octagon");
        conflictsWrapper.appendChild(conflictsStatus);

        var conflictsName = document.createElement("div");
        Dom.addClass(conflictsName, "ConflictsName");
        conflictsName.innerHTML = data.conflictMessage;
        conflictsWrapper.appendChild(conflictsName);
    } else if (data.conflicts == null || Object.getOwnPropertyNames(data.conflicts).length <= 0) {
        Dom.addClass(conflictsWrapper, "Passed");
        conflictsStatus = document.createElement("icon");
        Dom.addClass(conflictsStatus, "check-circle-outline");
        conflictsWrapper.appendChild(conflictsStatus);

        var conflictsName = document.createElement("div");
        Dom.addClass(conflictsName, "ConflictsName");
        conflictsName.innerHTML = data.conflictMessage;
        conflictsWrapper.appendChild(conflictsName);
    } else if (data.conflicts != null && Object.getOwnPropertyNames(data.conflicts).length > 0) {
        Dom.addClass(conflictsWrapper, "Override");
        conflictsStatus = document.createElement("icon");
        Dom.addClass(conflictsStatus, "IsOverride");
        Dom.addClass(conflictsStatus, "alert-octagon");
        conflictsWrapper.appendChild(conflictsStatus);

        var conflictsInput = document.createElement("input");
        conflictsInput.setAttribute("type", "checkbox");
        if (data.overrideConflict) conflictsInput.setAttribute("checked", "checked");
        conflictsInput.setAttribute("id", "overrideConflictCheckbox_" + data.id);
        conflictsWrapper.appendChild(conflictsInput);
        Dom.addClass(conflictsInput, "ConflictsAction");
        var conflictsName = document.createElement("div");
        Dom.addClass(conflictsName, "ConflictsName");
        conflictsName.innerHTML = "Override";
        conflictsWrapper.appendChild(conflictsName);
        if (data.overrideConflict) Dom.addClass(conflictsWrapper, "OverrideChecked");
    }
    
    if (data.showWarningAndDontOverride && !data.allowOverride && data.conflicts != null && Object.getOwnPropertyNames(data.conflicts).length > 0) {
        if (!Dom.hasClass(conflictsStatus, "IsOverride")) Dom.addClass(conflictsStatus, "IsOverride");
        if (!Dom.hasClass(conflictsWrapper, "OverrideChecked")) Dom.addClass(conflictsWrapper, "OverrideChecked");
    }
    if (data.showWarningAndDontOverride && data.conflicts != null && Object.getOwnPropertyNames(data.conflicts).length > 0) {
        Dom.addClass(conflictsWrapper, "ShowWarningAndDontOverride");
    }
};

RegistrationsWidget.prototype.renderRegSlotColumn = function (regSlotWarpper, data) {
    regSlotWarpper.innerHTML = "";
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};
    var slotCombo = new ComboManager();
    Dom.addClass(slotCombo.node(), "MemberRegSlotCombo");
    slotCombo.useHtml = true;
    slotCombo.renderer = this.slotRenderer;
    slotCombo.getDisplayValue = this.slotDisplayValue;
    slotCombo.setItems([null].concat(metaData.classDetailInfo.slots));

    var instructorConflictSlots = metaData.instructorConflictSlots;
    if (instructorConflictSlots && instructorConflictSlots.length > 0) {
    	instructorConflictSlots.forEach(function (id) {
    	       slotCombo.setItemEnabled({id: id}, false);
    	});
    }    

    if (data.assignedSlot >= 0) {
        slotCombo.selectItemByKey("slot", data.assignedSlot, true);
        Dom.addClass(regSlotWarpper, "AssignedSlot");
    } else {
        Dom.removeClass(regSlotWarpper, "AssignedSlot");
    }
    slotCombo.setAttribute("flex", 1);
    slotCombo.into(regSlotWarpper);
    regSlotWarpper._slotComboWidget = slotCombo;

    var iconWrapper = document.createElement("div");
    Dom.addClass(iconWrapper, "SlotIconWrapper");
    var icon = document.createElement("icon");
    Dom.addClass(icon, "information");
    iconWrapper.appendChild(icon);
    regSlotWarpper.appendChild(iconWrapper);
    

};

RegistrationsWidget.prototype.renderPaymentTypeContent = function (paymentTypeContent, data) {
    console.log("renderPaymentTypeContent", data, (data.movedLessonClassInId && data.classTransferring && data.classTransferInfo && data.classTransferInfo.totalAmount > 0));
    if ((data.fee.totalFee > 0 && !data.fee.isWaived) 
        ||(data.movedLessonClassInId && data.classTransferring 
            && (data.classTransferInfo && data.classTransferInfo.totalAmount > 0 || data.classTransferInfo.additionalFee > 0  
            || (data.classTransferInfo.transferSourceKeys &&  data.classTransferInfo.transferSourceKeys.length > 0))
        )) {
            console.log("Remove NoFee");
        Dom.removeClass(paymentTypeContent.parentNode,"NoFee");
    }

    if (data.movedLessonClassInId && data.classTransferring) {
        if (data.classTransferInfo && data.classTransferInfo.totalAmount == 0 && data.classTransferInfo.additionalFee <= 0  
            && (!data.classTransferInfo.transferSourceKeys ||  data.classTransferInfo.transferSourceKeys.length == 0)
                && (!Dom.hasClass(paymentTypeContent.parentNode,"NoFee"))) {
            console.log("Add NoFee, classTransferInfo");
            Dom.addClass(paymentTypeContent.parentNode,"NoFee");
        }    
    } else if ((data.fee.totalFee <= 0 && data.fee.totalFeeWithoutUnappliedPayment == 0) 
            && !data.fee.isWaived && (!Dom.hasClass(paymentTypeContent.parentNode,"NoFee"))) {
            console.log("Add NoFee");
            Dom.addClass(paymentTypeContent.parentNode,"NoFee");
    }
    

    paymentTypeContent.innerHTML = data.paymentInfo.paymentTypeName;
    if (data.paymentInfo.paymentTypeKey == "check") {
        paymentTypeContent.innerHTML = "Check #";
    }
    if (data.paymentInfo.paymentTypeKey == "accountCC") {
        Dom.removeClass(paymentTypeContent.parentNode, "CCMissing");
        Dom.addClass(paymentTypeContent.parentNode, "PayByCC");
        if (data.paymentInfo.ccEnding) {
            paymentTypeContent.innerHTML = data.paymentInfo.ccEnding;
        } else {
            Dom.addClass(paymentTypeContent.parentNode, "CCMissing");
            paymentTypeContent.innerHTML = "Select " + "Credit Card";

        }
    }
    Dom.removeClass(paymentTypeContent.parentNode, "PaymentMissing");
    Dom.removeClass(paymentTypeContent.parentNode, "PaymentCheck");
    if (data.paymentInfo.paymentTypeKey == "paymentMissing") {
        Dom.addClass(paymentTypeContent.parentNode, "PaymentMissing");
    } else if (data.paymentInfo.paymentTypeKey == "check") {
        Dom.addClass(paymentTypeContent.parentNode, "PaymentCheck");
        var checkInput = document.createElement("input");
        Dom.addClass(checkInput, "CheckInput");
        checkInput.setAttribute("type", "text");
        checkInput.value = data.paymentInfo.checkNumber;
        checkInput._lastGoodValue = data.paymentInfo.checkNumber;
        paymentTypeContent.appendChild(checkInput);
    }
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};
    if (metaData.allowClassPaymentPlan && metaData.allowUnappliedPayment 
        && this.options.action != "addClassForMember" && this.options.action != "reEnrollMemberClass") {
        this.renderUseUnappliedPayment(paymentTypeContent, data);
    }
};

RegistrationsWidget.prototype.renderUseUnappliedPayment = function (paymentTypeContent, data) {
    if (!paymentTypeContent) return;
    var paymentTypeContainer = paymentTypeContent.parentNode.parentNode;
    if (!paymentTypeContainer) return;
    var useUnappliedPayment = paymentTypeContainer.getElementsByClassName("UseUnappliedPayment")[0];
    if (data && data.paymentInfo && data.enableUnappliedPayment &&
            (data.paymentInfo.paymentTypeKey == "accountCC"
                || data.paymentInfo.paymentTypeKey == "check"
                || data.paymentInfo.paymentTypeKey == "cash"
                || data.paymentInfo.paymentTypeKey == "waitPaid") 
            && (data.fee.totalFeeWithoutUnappliedPayment > 0
                || (data.movedLessonClassInId && data.classTransferring && data.classTransferInfo 
                    && (data.classTransferInfo.totalAmount > 0 || data.classTransferInfo.additionalFee > 0  )))
            && data.unappliedPaymentAmount > 0 
            && !data.fee.isWaived) {
        if (!useUnappliedPayment) {
            useUnappliedPayment = document.createElement("div");
            useUnappliedPayment.setAttribute("id", "useUnappliedPayment_" + data.id);
            Dom.addClass(useUnappliedPayment, "UseUnappliedPayment");
            paymentTypeContainer.appendChild(useUnappliedPayment);
        }

        var useUPCheckbox = useUnappliedPayment.getElementsByClassName("UseUPCheckbox")[0];
        if (!useUPCheckbox) {
            useUPCheckbox = document.createElement("input");
            useUPCheckbox.setAttribute("id", "useUPCheckbox_" + data.id);
            useUPCheckbox.setAttribute("type", "checkbox");
            Dom.addClass(useUPCheckbox, "UseUPCheckbox");
            useUnappliedPayment.appendChild(useUPCheckbox);
        }
        useUPCheckbox.checked = data.allowUnappliedPayment;

        var useUPLabel = useUnappliedPayment.getElementsByClassName("UseUPLabel")[0];
        if (!useUPLabel) {
            useUPLabel = document.createElement("label");
            useUPLabel.setAttribute("for", "useUPCheckbox_" + data.id);
            Dom.addClass(useUPLabel, "UseUPLabel");
            useUnappliedPayment.appendChild(useUPLabel);
        }
        useUPLabel.innerHTML = "<span class=\"Hint\">Use Unapplied Payment/<br/>Credit</span> (<span class=\"Amount\">" + (ClassUtils.toCurrency(data.unappliedPaymentAmount)) + "</span>)";
        Dom.removeClass(useUnappliedPayment, "Hidden");
    } else {
        if (useUnappliedPayment) Dom.addClass(useUnappliedPayment, "Hidden");
    }
};

RegistrationsWidget.prototype.renderFeeInfo = function (target, isModal) {
    var thiz = this;
    var rowData = DataTable.getRowData(target);
    if (!rowData || !rowData.fee) return;
    var metaData = this.metaDataObject[rowData.classId] || {classDetailInfo: {}};
    if (!metaData.feeDesc) return;
    this.feeInfoPopupContent.innerHTML = "";
    this.feeInfoPopupSlotName.innerHTML = "";
    this.renderFeeInfoRowData = rowData;
    this.updateFeeInfoTitle(target);
    var feeContentTable;
    var isClassTransfer = rowData.movedLessonClassInId > 0 && rowData.classTransferring;
    if (isClassTransfer) {
        feeContentTable = this.renderClassTransferFeeInfo(rowData);
    } else {
        feeContentTable = this.renderNormalFeeInfo(target);
    }
    if (feeContentTable) {
        Dom.addClass(this.feeInfoPopupContent.parentNode, "FeeInfoPopup");
        this.feeInfoPopupContent.appendChild(feeContentTable);
        if (isClassTransfer) {
            // var orgFeeInfo = thiz.renderNormalFeeInfo(target);
            // this.classTransferFeeInfoPopupContent.appendChild(orgFeeInfo);
            Dom.addClass(this.feeInfoPopupContent.parentNode, "ClassTransfer");
            var additionalFeeInput = Dom.findDescendantWithClass(this.feeInfoPopupContent.parentNode, "AdditionalFee");
            thiz.additionalFeeInput = additionalFeeInput;
            thiz.registerEventsToAdditionalInput(thiz.additionalFeeInput)
            if (isModal) {
                var currentClassIn = {};
                if (this.options.movedLessonClassIns) {
                    currentClassIn = this.options.movedLessonClassIns[0];
                }
            
                new ClassTransferFeeDialog().callback(function (feeInfo) {}).open({
                    feeContentTableHtml: feeContentTable,
                    currentClassTitle: currentClassIn.class_title,
                    newClassTitle: rowData.className,
                    feeInfoPopupClickedHandler: function (event) {
                        thiz.feeInfoPopupClickedHandler(event);
                    },
                    feeInfoPopupHeaderClickedHandler: function (event, targetEl) {
                        thiz.feeInfoPopupHeaderClickedHandler(event, targetEl)
                    }, 
                    feeInfoPopupComboChangedHandler: function (event) {
                        thiz.feeInfoPopupComboChangedHandler(event);
                    },
                    feePopupCloseCallback: function () {
                        console.log("ClassTransfer, feePopupCloseCallback", thiz.additionalFeeInput, thiz.isClassTransferChanging);
                        thiz.onHideFeePopup();
                    }
                });
                return;
            }
        } 

        this.feeInfoPopup.show(target, "right-inside", "bottom", 0, 0, true);
    }
};

RegistrationsWidget.prototype.renderNormalFeeInfo = function(target){
    var rowData = DataTable.getRowData(target);
    var feeInfo = this.getFeeInfo(target);
    if (!feeInfo) return null;
    var feeContentTable = document.createElement("table"),
            feeContentTbody = document.createElement("tbody");

    Dom.addClass(feeContentTable, "NormalFees");
    for (var key in feeInfo) {
        var row = document.createElement("tr"),
            labelCol = document.createElement("td"),
            contentCol = document.createElement("td");
        if (feeInfo[key] < 0) {
            Dom.addClass(labelCol, "NegativeAmount");
            Dom.addClass(contentCol, "NegativeAmount");
            contentCol.innerHTML = "<span class=\"AmountContent\">-" + ClassUtils.toCurrency((feeInfo[key] * -1)) + "</span>";
        } else {
            contentCol.innerHTML = "<span class=\"AmountContent\">" +ClassUtils.toCurrency(feeInfo[key]) + "</span>";
        }
        labelCol.innerHTML = key + ":";
        row.appendChild(labelCol);
        row.appendChild(contentCol);
        feeContentTbody.appendChild(row);
    }

    if (Dom.hasClass(target, "TotalFee") || Dom.hasClass(target.parentNode, "TotalFee")) {
        var row = document.createElement("tr"),
            labelCol = document.createElement("td"),
            contentCol = document.createElement("td");

        Dom.addClass(labelCol, "TotalCol");
        Dom.addClass(contentCol, "TotalCol");
        labelCol.innerHTML = "Total Fee:";
        contentCol.innerHTML = ClassUtils.toCurrency(rowData.fee.totalFee);
        row.appendChild(labelCol);
        row.appendChild(contentCol);
        feeContentTbody.appendChild(row);
    }

    feeContentTable.appendChild(feeContentTbody);
    return feeContentTable;
}

RegistrationsWidget.prototype.updateFeeInfoTitle = function (target) {
    var rowData = DataTable.getRowData(target);
    if (Dom.hasClass(target, "ClassFee") || Dom.hasClass(target.parentNode, "ClassFee")) {
        this.feeInfoPopupSlotName.innerHTML = "Class Fee";
    } else if (Dom.hasClass(target, "RegFee") || Dom.hasClass(target.parentNode, "RegFee")) {
        if (rowData.movedLessonClassInId && rowData.classTransferring) {
            this.feeInfoPopupSlotName.innerHTML = "Class Transfer Fee";
        } else {
            this.feeInfoPopupSlotName.innerHTML = "Reg Fee";
        }
    } else if (Dom.hasClass(target, "TotalFee") || Dom.hasClass(target.parentNode, "TotalFee")) {
        this.feeInfoPopupSlotName.innerHTML = this.totalFeeName;
    }
};

RegistrationsWidget.prototype.getFeeInfo = function (target) {
    var feeInfo;
    var rowData = DataTable.getRowData(target);
    if (Dom.hasClass(target, "ClassFee") || Dom.hasClass(target.parentNode, "ClassFee")) {
        feeInfo = rowData.fee.classFeeInfo;
    } else if (Dom.hasClass(target, "RegFee") || Dom.hasClass(target.parentNode, "RegFee")) {
        feeInfo = rowData.fee.regFeeInfo;
    } else if (Dom.hasClass(target, "TotalFee") || Dom.hasClass(target.parentNode, "TotalFee")) {
        feeInfo = rowData.fee.allFeeInfo;
    }
    return feeInfo;
};

RegistrationsWidget.prototype.renderClassTransferFeeInfo = function (rowData, ignoreCalcNextCharge) {
    var thiz = this;
    thiz.isClassTransferChanging = false;
    if (!rowData) return;
    var currentClassIn = {};
    if (this.options.movedLessonClassIns) {
        currentClassIn = this.options.movedLessonClassIns[0];
    }
    var destClassName = rowData.className;
    var sourceClassName = currentClassIn.class_title;
    var headerEl = Dom.newDOMElement({
        _name: "hbox",
        _children: [{
            _name: "span",
            _text: "Class Transfer Fee Options"
        }, {
            _name: "span",
            "class": "CurrentClassName",
            _text: sourceClassName,
            "title": sourceClassName
        }, {
            _name: "icon",
            "class": "arrow-right"
        }, {
            _name: "span",
            class: "TransferClassName",
            _text: destClassName,
            "title": destClassName,
            "flex": 1
        }, {
            _name: "button",
            "type": "button",
            "role": "primary",
            "class": "UpdateTransferFeeButton",
            _children: [{
                _name: "span",
                _text: "Apply"
            }]
        }]

    });
    thiz.feeInfoPopupSlotName.innerHTML = "";
    thiz.feeInfoPopupSlotName.appendChild(headerEl);
    
    var tableChildren = [];
    var hasAssignedPaymentPlan = rowData.paymentPlanId > 0;
    var sourceFees = rowData.classTransferInfo.sourceClassFees;
    var sourceFeeRows = "";
    if (sourceFees) {
        sourceFeeRows = thiz.renderSourceClassTransferFeeRows(sourceFees, rowData.classTransferInfo.transferSourceKeys, hasAssignedPaymentPlan, destClassName);
    }

    if (sourceFeeRows && sourceFeeRows.length > 0) {
        tableChildren.push({
            _name: "vbox",
            _children: [{
                _name: "div",
                _text: "Current Class: " + currentClassIn.class_title,    
            }, {
                _name: "table",
                "class": "ClassTransferFees",
                "ref": rowData.id,
                _html: sourceFeeRows
            }]
        })
    }

    var destFees = rowData.classTransferInfo.destClassFees;
    var destFeeRows = "";
    if (destFees) {
        destFeeRows = thiz.renderDestClassTransferFeeRows(destFees, rowData.classTransferInfo.waiveSourceKeys, rowData.classTransferInfo.paymentTransferSourceKeyTitleMap, sourceClassName, destClassName);
    }
    var destFeeTable = Dom.newDOMElement({
        _name: "table",
        "class": "ClassTransferFees",
        "ref": rowData.id,
        _html: destFeeRows
    });

    var destFeeTableChildren = [];

    if (destFeeRows && destFeeRows.length > 0) {
        destFeeTableChildren.push(Dom.newDOMElement({
            _name: "div",
            _text: "New Class: " + rowData.className
        }));
        destFeeTableChildren.push(destFeeTable);
    }

    var tfoot = Dom.newDOMElement({
        _name: "vbox",
        "class": "",
        _html: thiz.renderClassTransferSummary(rowData.id, rowData.classTransferInfo, hasAssignedPaymentPlan)
    });
    var chargeCatContainer = Dom.findDescendantWithClass(tfoot, "ChargeCategoriesWrapper");
    chargeCatContainer = thiz.renderAdditionalFeeChargeCategoriesCombo(rowData, chargeCatContainer, hasAssignedPaymentPlan);
    destFeeTableChildren.push(tfoot);

    tableChildren.push(Dom.newDOMElement({
        _name: "vbox",
        _children: destFeeTableChildren
    }));

    if (!ignoreCalcNextCharge) {
        thiz.calcRecurringNextCharge(rowData.id, tfoot);
    } else {
        if (!thiz.recurringNextCharge) thiz.recurringNextCharge = {};
        var recurringNextCharge = thiz.recurringNextCharge[rowData.id];
        if (recurringNextCharge) {
            thiz.updateRecurringNextCharge(recurringNextCharge, tfoot);
        } else {
            thiz.calcRecurringNextCharge(rowData.id, tfoot);
        }
    }

    var feeInfoWrapper = Dom.newDOMElement({
        _name: "vbox",
        _children: tableChildren
    });
    return feeInfoWrapper;
};
RegistrationsWidget.prototype.calcRecurringNextCharge = function (rowId, feeTable) {
    var thiz = this;
    if (!thiz.registrationsObject[rowId]) return;
    var rowData = thiz.registrationsObject[rowId];
    console.log("Row data", rowData, thiz.options);
    var classIdMemberIdMap = {};
    classIdMemberIdMap[this.options.classId] = this.options.addedMemberIds;
    var focusRegistrationId = rowData.id;
    var excludedLessonClassInIds = [];
    if (thiz.options.movedLessonClassIns && thiz.options.movedLessonClassIns.length > 0) {
        var classInIds = [];
        for (var i = 0; i < thiz.options.movedLessonClassIns.length; i++) {
            var classIn = thiz.options.movedLessonClassIns[i];
            classInIds.push(classIn.id);
        }
        
        excludedLessonClassInIds = classInIds;
    }

    console.log("calcRecurringNextCharge projectBbhPaymentPlanOfNewRegistration", focusRegistrationId, classIdMemberIdMap, 
        thiz.registrationsObject);
    
    $classToolService.calcRecurringNextCharge(focusRegistrationId, classIdMemberIdMap, thiz.registrationsObject, excludedLessonClassInIds, function (res) {
        console.log("Next Charge Info", res);
        if (!thiz.recurringNextCharge) thiz.recurringNextCharge = {};
        thiz.recurringNextCharge[focusRegistrationId] = res;
        thiz.updateRecurringNextCharge(res, feeTable);
    }, function () {}, "Calculating next recurring charge...");
};

RegistrationsWidget.prototype.updateRecurringNextCharge = function (res, feeTable) {
    var chargeAmountEle = Dom.findDescendantWithClass(feeTable, "NextRecurringAmount");
    var chargeInfoEle = Dom.findDescendantWithClass(feeTable, "NextChargeInfo");
    if (chargeAmountEle && chargeAmountEle && res.nextChargeDate) {
        chargeAmountEle.innerHTML = ClassUtils.toCurrency(res.nextChargeAmount);
        chargeInfoEle.innerHTML = "(" + res.nextChargeClassTitle + " - " 
                        + FormatUtil.formatDateWithTZID(res.nextChargeDate, "date_standard", res.nextClassTimezoneId) + ")";
    } else {
        chargeAmountEle.innerHTML = "-";
        chargeInfoEle.innerHTML = ""        
    }
};

RegistrationsWidget.prototype.renderClassTransferSummary = function (rowId, classTransferInfo, hasAssignedPaymentPlan) {
    var totalAmount = ClassUtils.toCurrency(classTransferInfo.totalAmount);
    var additionalFee = classTransferInfo.additionalFee? classTransferInfo.additionalFee : 0;
    var billedTodayAmount = ClassUtils.toCurrency(classTransferInfo.billedTodayAmount);
    var html = "";
    var ccFee = ""
    var disabled = hasAssignedPaymentPlan? "" : "disabled=\"true\"";
    var additionalType = additionalFee >= 0 ? "CHARGE" : "CREDIT";
    var additionalFeeHtml = 
        '<tr class="AdditionalFeeWrapper">' +
            '<td colspan="4">' +
                '<vbox>' +
                    '<hbox>' +
                        '<label flex="2">Additional Charge or Credit</label>' +
                        '<label flex="1" for="additionalFeeInput">Amount (' + this.currency + '):</label>' +
                        '<label flex="3">Charge Category:</label>' +
                    '</hbox>' +
                '</vbox>' +
                '<vbox>' +
                    '<hbox  class="AdditionalTypeWrapper">' +
                        '<hbox flex="2">' +
                            '<hbox>' +
                                '<input id="additionalTypeCharge" type="radio" class="AdditionalTypeSelector" name="additionalType" value="CHARGE" ' + disabled + (additionalFee >= 0? " checked=true " : "") +  '/>' +
                                '<label for="additionalTypeCharge">Charge</label>' +
                            '</hbox>' +
                            '<hbox>' +
                                '<input id="additionalTypeCredit" type="radio" class="AdditionalTypeSelector" name="additionalType" value="CREDIT" ' + disabled + (additionalFee < 0? " checked=true " : "") +'/>' +
                                '<label for="additionalTypeCredit">Credit</label>' +
                            '</hbox>' +
                        '</hbox>' +
                        '<hbox flex="1" class="AdditionalAmountWrapper">' +
                            '<span class="Currency">' + this.currency + '</span>' +
                            '<input id="additionalFeeInput" class="AdditionalFee" type="number" value="' + Math.abs(additionalFee) + '" ref="' + rowId + '"' + disabled + '/>'+
                        '</hbox>' +
                        '<hbox flex="3">' +
                            '<div class="ChargeCategoriesWrapper"></div>' +
                        '</hbox>' +
                    '</hbox>' +
                '</vbox>' +
            '</td>' +
        '</tr>';
    
    if (classTransferInfo.ccProcessingFee && classTransferInfo.ccProcessingFee > 0){
        ccFee = '<tr class="CcFee"><td class="ColType">' + classTransferInfo.ccProcessingFeeTitle + '</td> ' +
                        '<td class="ColAmount" colspan="3" ref="' + rowId+ '">' + ClassUtils.toCurrency(classTransferInfo.ccProcessingFee) +'</td> ' +
                        '</tr> ';
    }
    html = additionalFeeHtml +
                ccFee +
                '<tr class="TotalAmountWrapper"><td class="ColType">Total</td> ' +
                        '<td class="ColAmount TotalAmount" colspan="3" ref="' + rowId+ '">' + totalAmount +'</td> ' +
                '</tr> ' +
                '<tr class="BilledToday"><td class="ColType">To be billed today:</td> ' +
                    '<td class="ColAmount TotalBilledToday" colspan="3" ref="' + rowId+ '">' + billedTodayAmount + '</td> ' +
                '</tr>' + 
                '<tr class="NextCharge">' +
                    '<td class="ColType"><icon class="credit-card"></icon>Next Recurring Charge <span class="NextChargeInfo"></span></td> ' +
                    '<td class="ColAmount NextRecurringAmount" colspan="3"><icon class="clock"></icon></td> ' +
                '</tr>'; 
    return "<table class=\"ClassTransferFees\" ref=\"" + rowId + "\"><tbody class=\"FeeSummary\">" + html + "</tbody></table>";
};

RegistrationsWidget.prototype.renderDestClassTransferFeeRows = function (fees, addedSourceKeys, paymentTransferSourceKeyTitleMap, sourceClassName, destClassName) {
    var thiz = this;
    var headerRow =  '<thead><tr class="Row Header DestFee">' +
                            '<td class="ColName">Class Fees</td> ' +
                            '<td class="ColAmount ClassName"><span class=\"DestClassName\" title="' + destClassName + '">' + destClassName + '</span></br> Fees</td> ' +
                            '<td class="ColPayment" colspan="2">Waiver Option</td>' +
                            '<td class="ColAmount Due">Amount Due</td></tr></thead>';
    if (!fees || fees.length == 0) {
        return headerRow + "<tr><td class='NoCharge' colspan='4'>No charge found</td></tr>";
    }                            
    var colTypeRows = {"RECURRING":"", "MANUAL":""};
    var feeTypeNames = {"RECURRING":"Recurring Fees", "MANUAL":"One Time Fees"};
    var recurringFeeIndex = 0, manualFeeIndex = 0;
    var highlightCode = "$#HighLightClassName#$";
    var noHighlightCode = "$#NoHighLightClassName#$";
    for (var i in fees){
        var highlightClassName = noHighlightCode;
        var fee = fees[i];
        var scheduleType = "RECURRING";
        if (recurringFeeIndex % 2 == 0) highlightClassName = highlightCode;
        if (fee.scheduleType == "MANUAL") {
            highlightClassName = noHighlightCode;
            scheduleType = "MANUAL";
            if (manualFeeIndex % 2 == 0) highlightClassName = highlightCode;
        }
        var isAddedSourceKey = addedSourceKeys.indexOf(fee.sourceKey) > -1;
        var rows;
        var firstType = false;
        if (colTypeRows && colTypeRows[scheduleType]){
            rows = colTypeRows[scheduleType];
        } else {
            rows = '';
            colTypeRows[scheduleType] = rows;
            firstType = true;
        }
        console.log("Dest fee", fee);
        if (fee.feeItems && fee.feeItems.length > 0) {
            var index = 1;
            var feeRow = '';
            var firstFeeItem;
            for (var k in fee.feeItems){
                var item = fee.feeItems[k];
                console.log("Dest fee items", item);
                var row = thiz.getDestClassTransferFeeRowHtml(fee, item, fee.sourceKey, isAddedSourceKey, (index == 1), 
                        (index == 1) && fee.allowWaive, highlightClassName);
                if (index == fee.feeItems.length){
                    row = row.replace('#firstOfType#', " LastItem #firstOfType# ");
                }
                
                if (index == 1){
                    firstFeeItem = item;
                    if (firstType) {
                        row = row.replace('#feeType#', feeTypeNames[scheduleType]? feeTypeNames[scheduleType] : scheduleType);
                        row = row.replace('#firstOfType#', "TotalAmount FirstOfType");
                    } else{
                        row = row.replace('#firstOfType#', "TotalAmount Others");
                        row = row.replace('#feeType#', "");
                    }
                    row = row.replace('#feeDate#', FormatUtil.formatDate(fee.chargeDate, "date_standard", "server"));
                } else {
                    row = row.replace('#feeType#', "");
                    row = row.replace('#feeDate#', "");
                    row = row.replace('#firstOfType#', item.credit ? "UnappliedAmount" : "");
                }
                row = row.replace('#firstOfType#', "");
                feeRow = feeRow + row;// + (index == 1? "" : row2); // dont display payment plan item row 
                index++;
            }
            var index = 1;
            console.log("Tax", fee.taxItems);
            for (k in fee.taxItems){
                var item = fee.taxItems[k];
                var row = thiz.getDestClassTransferFeeRowHtml(fee, item, fee.sourceKey, isAddedSourceKey, false, false, highlightClassName);
                row = row.replace('#feeType#', "");
                row = row.replace('#feeDate#', "");
                row = row.replace('#firstOfType#', "Tax");
                feeRow = feeRow + row;
                index++;
            }
            rows = rows + feeRow;
            console.log("Unapplied, firstFeeItem", fee.consumedUnappliedAmount, firstFeeItem);
            if (fee.consumedUnappliedAmount && fee.consumedUnappliedAmount > 0 && firstFeeItem){
                var unappliedItem = Object.assign({}, firstFeeItem);
                unappliedItem.amount = -fee.consumedUnappliedAmount;
                unappliedItem.title = fee.consumedUnappliedAmountTitle; //"Unapplied Amount/Credit";
                var row = thiz.getDestClassTransferFeeRowHtml(fee, unappliedItem, fee.sourceKey, isAddedSourceKey, false, false, highlightClassName);
                row = row.replace('#feeType#', "");
                row = row.replace('#feeDate#', "");
                row = row.replace('#firstOfType#', "UnappliedAmount");
                rows = rows + row;
            }
        }
        colTypeRows[scheduleType] = rows;
        
        if (fee.scheduleType == "MANUAL") {
            manualFeeIndex ++;
        } else {
            recurringFeeIndex ++;
        }
    }
    var result = "";
    for (var t in colTypeRows) {
        var typeRowHtml = colTypeRows[t];
        if (t == "MANUAL") {
            if (recurringFeeIndex % 2 == 0) {
                typeRowHtml = typeRowHtml.replaceAll(noHighlightCode, "");
                typeRowHtml = typeRowHtml.replaceAll(highlightCode, "HighLight");
            } else {
                typeRowHtml = typeRowHtml.replaceAll(noHighlightCode, "HighLight");
                typeRowHtml = typeRowHtml.replaceAll(highlightCode, "");
            }
        } else {
            typeRowHtml = typeRowHtml.replaceAll(noHighlightCode, "");
            typeRowHtml = typeRowHtml.replaceAll(highlightCode, "HighLight");
        }
        result = result + typeRowHtml;
    }
    var currentHighLight = "";
    if ((manualFeeIndex + recurringFeeIndex) % 2 == 0) {
        currentHighLight = "";
    } else {
        currentHighLight = "HighLight";
    }
    console.log("paymentTransferSourceKeyTitleMap", paymentTransferSourceKeyTitleMap, currentHighLight, manualFeeIndex + recurringFeeIndex);
    for (var sourceKey in paymentTransferSourceKeyTitleMap){
        var highlightClassName = currentHighLight == "HighLight"? "" : "HighLight" ;
        var c = paymentTransferSourceKeyTitleMap[sourceKey];
        var title = "<span>Transferred from</span> <span class=\"ClassName\" title=\"" + sourceClassName + "\">" + sourceClassName + "</span>" +
                    "</br><span class=\"FeeName\" title=\"" + c.primary + "\">(" + c.primary + ")</span>";
        var amt = c.secondary;
        console.log("paymentTransferSourceKeyTitleMap c", c);
        var amtStr = ClassUtils.toCurrency(-amt);
        var rowHtml = '<tr class="Row DestFee TransferredPayment TotalAmount FeeItem  FirstOfType ' + highlightClassName + '" ref="' + sourceKey + '">' +
                        '<td class="ColName">' +  title + '</td>' +
                        '<td class="ColAmount Transferred" amt="' + amtStr + '"><span>' + amtStr  + '</span></td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>';
        result = result + rowHtml;
        currentHighLight = highlightClassName;
    }

    return headerRow + "<tbody>" + result + "</tbody>";
};

RegistrationsWidget.prototype.getDestClassTransferFeeRowHtml = function(fee, item, sourceKey, isSourceKeyAdded, isFirstFeeItem, isWaive, highlightClassName){
    var paymentStr = '';
    var checked = isSourceKeyAdded? " checked=true " : "";
    var waived = isSourceKeyAdded? " Due Waived " : " Due ";
    var title = item.title;
    var amt = item.amount;
    if (isFirstFeeItem){
        amt = fee.amount - (fee.consumedUnappliedAmount? fee.consumedUnappliedAmount : 0);
        if (fee.balance){
            amt -= fee.balance;
        }
        (amt >= 0) || (amt = 0);
        // title = fee.title;
    }
    
    var discountClass = item.amount < 0? "Discount" : "";
    var colType = '';
    if (isWaive) {
        var id = "waive_"+ sourceKey;
        paymentStr = '<input type="checkbox" class="WaiveFee" ' + checked + 'ref="' + sourceKey + '" id="' + id + '" /><label for="' + id + '">Waive Fee</label>';
    } else if (isFirstFeeItem) {
        paymentStr = '<span class="NonWaivable">Non-waivable</span>';
    }
    // if (isPaymentTransfer /*&& amt > 0*/) {
    //     paymentStr = '<input type="checkbox" class="TransferFee" ' + checked + ' ref="' + sourceKey + '" />';
    // }
    //if (isFirstFeeItem) colType = '<td class="ColType" #rowspan# >#feeType#</td>';
    var dueAmt = (isFirstFeeItem? ClassUtils.toCurrency(amt) : "");
    var template = '<tr class="Row DestFee FeeItem #firstOfType# ' + discountClass + ' ' + highlightClassName + '" ref="' + sourceKey + '">' +
                        '<td class="ColName">' +  title + '</td>' +
                        '<td class="ColAmount ">' + ClassUtils.toCurrency(item.amount) + '</td>' +
                        '<td class="ColPayment" colspan="2">' + paymentStr + '</td>' +
                        '<td class="ColAmount ' + waived + '" amt="' + dueAmt + '"><span>' + (isSourceKeyAdded? "" : dueAmt)  + '</span></td></tr>';
    return template;
}

RegistrationsWidget.prototype.renderSourceClassTransferFeeRows = function (fees, addedSourceKeys, hasAssignedPaymentPlan, destClassName) {
    var thiz = this;
    var paymentName = "Transfer to</br><span class=\"SourceClassName\" title=\"" + destClassName + "\">" + destClassName + "</span>";
    var headerName = "Current Class";
    // var headerRow =  '<tr class="Row Header"><td class="ColType">' + headerName + '</td> ' +
    var headerRow =  '<thead><tr class="Row Header SourceFee">' +
                            '<td class="ColName">Class Fees</td> ' +
                            '<td class="ColAmount">Amount Paid</td> ' +
                            '<td class="ColDate">Date Paid</td> ' +
                            '<td class="ColPayment">' + paymentName + '</td>' + 
                            '<td class="ColAmount Effective"><span>Transferable</br>Amount</span></td></tr></thead>';
    if (!fees || fees.length == 0) {
        return headerRow + "<tbody><tr><td class='NoCharge' colspan='5'>No charge found</td></tr></tbody>";
    }                            
    var colTypeRows = {"RECURRING":"", "MANUAL":""};
    var feeTypeNames = {"RECURRING":"Recurring Fees", "MANUAL":"One Time Fees"};
    var recurringFeeIndex = 0, manualFeeIndex = 0;
    var highlightCode = "$#HighLightClassName#$";
    var noHighlightCode = "$#NoHighLightClassName#$";
    var totalPaid = 0;
    var totalTransferred = 0;
    for (var i in fees){
        var highlightClassName = noHighlightCode;
        var fee = fees[i];
        console.log("Source fee", fee);
        var scheduleType = "RECURRING";
        if (recurringFeeIndex % 2 == 0) highlightClassName = highlightCode;
        if (fee.scheduleType == "MANUAL") {
            highlightClassName = noHighlightCode;
            scheduleType = "MANUAL";
            if (manualFeeIndex % 2 == 0) highlightClassName = highlightCode;
        }
        var isAddedSourceKey = addedSourceKeys.indexOf(fee.sourceKey) > -1;
        var rows;
        var firstType = false;
        if (colTypeRows && colTypeRows[scheduleType]){
            rows = colTypeRows[scheduleType];
        } else {
            rows = '';
            colTypeRows[scheduleType] = rows;
            firstType = true;
        }
        
        if (fee.feeItems && fee.feeItems.length > 0) {
            var index = 1;
            var feeRow = '';
            for (var k in fee.feeItems){
                var item = fee.feeItems[k];
                console.log("Source fee item", item);
                var row = thiz.getSourceClassTransferFeeRowHtml(fee, item, fee.sourceKey, isAddedSourceKey, (index == 1) && fee.allowPaymentTransfer, hasAssignedPaymentPlan, highlightClassName);
                row = row.replace('#feeType#', "");
                row = row.replace('#feeDate#', FormatUtil.formatDate(fee.chargeDate, "date_standard", "server"));
                row = row.replace('#metaInfo#', "TotalAmount FirstOfType");
                feeRow = feeRow + row;
                index++;

                totalPaid += fee.amount;
                totalTransferred += isAddedSourceKey? (fee.amount - fee.balance) : 0;
                break;
            }
            rows = rows + feeRow;
        }
        colTypeRows[scheduleType] = rows;
        
        if (fee.scheduleType == "MANUAL") {
            manualFeeIndex ++;
        } else {
            recurringFeeIndex ++;
        }
    }
    var result = "";
    for (var t in colTypeRows) {
        var typeRowHtml = colTypeRows[t];
        if (t == "MANUAL") {
            if (recurringFeeIndex % 2 == 0) {
                typeRowHtml = typeRowHtml.replaceAll(noHighlightCode, "");
                typeRowHtml = typeRowHtml.replaceAll(highlightCode, "HighLight");
            } else {
                typeRowHtml = typeRowHtml.replaceAll(noHighlightCode, "HighLight");
                typeRowHtml = typeRowHtml.replaceAll(highlightCode, "");
            }
        } else {
            typeRowHtml = typeRowHtml.replaceAll(noHighlightCode, "");
            typeRowHtml = typeRowHtml.replaceAll(highlightCode, "HighLight");
        }
        result = result + typeRowHtml;
    }
    var totalPaidStr = ClassUtils.toCurrency(totalPaid);
    var totalTransferStr = totalTransferred != 0? ClassUtils.toCurrency(-totalTransferred) : 0;
    var transferred = totalTransferred != 0? "Effective Transferred" : "Effective";
    var summaryRow = '<tr class="Row SourceFee Summary">'  +
                        '<td class="Label">Total Paid/Scheduled</td>' +
                        '<td class="ColAmount ">' + totalPaidStr + '</td>' +
                        '<td class="Label TotalTransferred" colspan=2>Total Transferred</td>' +
                        '<td class="ColAmount ' + transferred + '"><span class="TotalTransferredAmount">' + totalTransferStr + '</span></td></tr>'


    return headerRow + "<tbody>" + result + summaryRow +  "</tbody>";
};

RegistrationsWidget.prototype.getSourceClassTransferFeeRowHtml = function(fee, item, sourceKey, isSourceKeyAdded, isPaymentTransfer, hasAssignedPaymentPlan, highlightClassName){
    var paymentStr = '';
    var checked = isSourceKeyAdded? " checked=true " : "";
    var transferred = isSourceKeyAdded? "Effective Transferred" : "Effective";
    var title = item.title;
    var amt = item.amount;
    var chargeAmountStr = ClassUtils.toCurrency(fee.amount);
    var effectiveAmt = fee.amount - fee.balance;
    var effectiveAmtStr = ClassUtils.toCurrency(-effectiveAmt);
    var disabled = hasAssignedPaymentPlan? "" : "disabled=\"true\"";
    if (isPaymentTransfer) {
        paymentStr = '<input type="checkbox" class="TransferFee" ' + checked + ' ref="' + sourceKey + '" ' + disabled + '/>';
    } else {
        paymentStr = '<span class="NotAllowedTransfer">Non-transferable</span>';
        effectiveAmtStr = ClassUtils.toCurrency(0);
    }
    var template = '<tr class="Row SourceFee FeeItem #metaInfo# ' + highlightClassName + '" ref="' + sourceKey + '">'  +
                        '<td class="ColName">' +  title + '</td>' +
                        '<td class="ColAmount ">' + chargeAmountStr + '</td>' +
                        '<td class="ColDate">#feeDate#</td>' +
                        '<td class="ColPayment">' + paymentStr + '</td>' +
                        '<td class="ColAmount ' + transferred + '"><span>' + effectiveAmtStr + '</span></td></tr>'
    return template;
}

RegistrationsWidget.prototype.renderAdditionalFeeChargeCategoriesCombo = function (data, container, hasAssignedPaymentPlan) {
    if (!data) return;
    var metaData = this.metaDataObject[data.classId];
    var chargeCatCombo = new ComboManager();
    chargeCatCombo.useHtml = true;
    chargeCatCombo.renderer = this.chargeCategoryRenderer;
    chargeCatCombo.decorator = this.chargeCategorDecorator;
    chargeCatCombo.setPopupClass("ChargeCategoryPopup");
    chargeCatCombo.getDisplayValue = this.chargeCategoryDisplayValue;
    chargeCatCombo.setItems(metaData.chargeCategories);
    if (!hasAssignedPaymentPlan) chargeCatCombo.setEnable(false);
    container._chargeCatgoryComboWidget = chargeCatCombo;
    if (data.classTransferInfo && data.classTransferInfo.additionalFeeChargeCategoryId) {
         chargeCatCombo.selectItemByKey("id", data.classTransferInfo.additionalFeeChargeCategoryId);
    }
    chargeCatCombo.into(container);
    Dom.addClass(chargeCatCombo.node(), "ChageCategoriesCombo");
    return container;
};


RegistrationsWidget.prototype.waiveClassTransferFee = function(rowData) {
    console.log("waiveClassTransferFee classTransfwaiveClassTransferFee", rowData);
    if (rowData.movedLessonClassInId && rowData.classTransferring) {
        var classTransferInfo = rowData.classTransferInfo;
        console.log("waiveClassTransferFee classTransferInfo", classTransferInfo);
        classTransferInfo.waiveSourceKeys = [];
        for (var i in classTransferInfo.destClassFees) {
            var fee = classTransferInfo.destClassFees[i];
            var isWaivable = fee.allowWaive;
            console.log("waiveClassTransferFee", fee, fee.sourceKey);
            if (isWaivable) classTransferInfo.waiveSourceKeys.push(fee.sourceKey);   
        }
        rowData.isClassTransferChanging = true;
        console.log(" fee.sourceKey classTransferInfo.waiveSourceKeys", classTransferInfo.waiveSourceKeys);
    }
}

RegistrationsWidget.prototype.feeInfoPopupComboChangedHandler = function(event) {
    var e = event.target;
    var thiz = this;
    if (Dom.hasClass(e, "ChageCategoriesCombo")) {
        var table = Dom.findParentWithClass(e, "ClassTransferFees");
        var container = Dom.findParentWithClass(e, "ChargeCategoriesWrapper");
        var selectedItem = container._chargeCatgoryComboWidget.getSelectedItem();
        var rowId = table.getAttribute("ref");
        if (!thiz.registrationsObject[rowId]) return;
        thiz.registrationsObject[rowId].classTransferInfo.additionalFeeChargeCategoryId = selectedItem.id;
        thiz.isClassTransferChanging = true;
        var wrapper = Dom.findParentWithClass(table, "ClassTransferDialogWrapper");
        if (wrapper){
            var btn = Dom.findDescendantWithClass(wrapper, "UpdateTransferFeeButton");
            Dom.setEnabled(true, btn);
        }
    }
}

RegistrationsWidget.prototype.feeInfoPopupHeaderClickedHandler = function (event, targetEl) {
    var updateTransferFeeButton = Dom.findParentWithClass(event.target, "UpdateTransferFeeButton");
    console.log("feeInfoPopupHeaderClickedHandler updateTransferFeeButton", updateTransferFeeButton, event, event.target, targetEl);
    if (updateTransferFeeButton) {
        var thiz = this;
        console.log("feeInfoPopupHeaderClickedHandler", thiz.isClassTransferChanging);
        if (thiz.isClassTransferChanging) {
            thiz.reRenderFeeInfoContent(thiz.renderFeeInfoRowData, targetEl);
        }
        return;
    }
};

RegistrationsWidget.prototype.reRenderFeeInfoContent = function (rowData, targetEl) {
    var thiz = this;
    thiz.cleanFeeInputRegisterredEvents();
    if (!targetEl) targetEl = this.feeInfoPopupContent;
    console.log("reRenderFeeInfoContent feeInfoPopupContent", this.feeInfoPopupContent, targetEl);
    thiz.checkRegistrations([], function () {
        var feeContentTable = thiz.renderClassTransferFeeInfo(rowData, true);
        targetEl.innerHTML = "";
        targetEl.appendChild(feeContentTable);
        var additionalFeeInput = Dom.findDescendantWithClass(targetEl, "AdditionalFee");
        thiz.additionalFeeInput = additionalFeeInput;
        console.log("reRenderFeeInfoContent additionalFeeInput", additionalFeeInput);
        thiz.registerEventsToAdditionalInput(thiz.additionalFeeInput);

        var wrapper = Dom.findParentWithClass(targetEl, "ClassTransferDialogWrapper");
        console.log("reRenderFeeInfoContent wrapper", wrapper, targetEl);
        if (wrapper){
            var btn = Dom.findDescendantWithClass(wrapper, "UpdateTransferFeeButton");
            console.log(" reRenderFeeInfoContent Apply", btn);
            Dom.setEnabled(false, btn);
        }
    });
    return;
};

RegistrationsWidget.prototype.onHideFeePopup = function () {
    this.cleanFeeInputRegisterredEvents();
    if (this.isClassTransferChanging) this.checkRegistrations();
};

RegistrationsWidget.prototype.feeInfoPopupClickedHandler = function (event) {
    var thiz = this;
    // if (!Dom.hasClass(thiz.feeInfoPopupContent.parentNode, "ClassTransfer")){
    //     return;
    // }
    var e = event.target;
    if (Dom.hasClass(e, "AdditionalFee")) {
        thiz.additionalFeeInputChangeHandler(event);
        return;
    }
    if (Dom.hasClass(e, "AdditionalTypeSelector")) {
        var rowEl = Dom.findParentWithClass(e, "AdditionalTypeWrapper"); 
        console.log("AdditionalTypeSelector, rowEl", rowEl);
        if (rowEl) {
            thiz.processAdditionalFeeRow(rowEl);
            return;
        }
        
    }
    if (!Dom.hasClass(e, "TransferFee") && !Dom.hasClass(e, "WaiveFee")) {
        return;
    }
    var table = Dom.findParentWithClass(e, "ClassTransferFees");
    var sourceKey = e.getAttribute("ref");
    var rowId = table.getAttribute("ref");
    var regObj = thiz.registrationsObject[rowId];
    if (!table && !sourceKey && !rowId) {
        console.log("Not found [table, rowId, sourceKey, regObj]", table, rowId, sourceKey, regObj);
        return;
    }
    var classTransferInfo = regObj.classTransferInfo;
    if (Dom.hasClass(e, "TransferFee")) {
        if (e.checked){
            classTransferInfo.transferSourceKeys.push(sourceKey);
        } else {
            var index = classTransferInfo.transferSourceKeys.indexOf(sourceKey);
            (index == -1) || classTransferInfo.transferSourceKeys.splice(index, 1); 
        }
        var totalTransferredAmount = Dom.findDescendantWithClass(table, "TotalTransferredAmount"); 
        console.log("totalTransferredAmount", totalTransferredAmount);
        if (totalTransferredAmount) {
            totalTransferredAmount.innerHTML = "-";
            Dom.removeClass(totalTransferredAmount.parentNode, "Transferred");
        }
        var row = Dom.findParentWithClass(e, "SourceFee");
        console.log("SourceFee Row", row);
        if (row){
            var c = Dom.findDescendantWithClass(row, "Effective");
            console.log("Cell", c);
            if (c) {
                if (Dom.hasClass(c, "Transferred")){
                    Dom.removeClass(c, "Transferred");
                } else {
                    Dom.addClass(c, "Transferred");
                }
            }
        }
        thiz.isClassTransferChanging = true;
    }
    if (Dom.hasClass(e, "WaiveFee")) {
        if (e.checked){
            classTransferInfo.waiveSourceKeys.push(sourceKey);   
        } else {
            var index = classTransferInfo.waiveSourceKeys.indexOf(sourceKey);
            (index == -1) || classTransferInfo.waiveSourceKeys.splice(index, 1); 
        }

        var row = Dom.findParentWithClass(e, "DestFee");
        console.log("DestFee Row", row);
        if (row){
            var c = Dom.findDescendantWithClass(row, "Due");
            console.log("Cell", c);
            if (c) {
                var amt = c.getAttribute("amt")? c.getAttribute("amt") : "";
                if (Dom.hasClass(c, "Waived")){
                    Dom.removeClass(c, "Waived");
                    c.innerHTML = amt;
                } else {
                    Dom.addClass(c, "Waived");
                    c.innerHTML = "";
                }
            }
            
        }

        thiz.isClassTransferChanging = true;
    }

    var wrapper = Dom.findParentWithClass(table, "ClassTransferDialogWrapper");
    console.log("wrapper", wrapper);
    if (wrapper){
        var btn = Dom.findDescendantWithClass(wrapper, "UpdateTransferFeeButton");
        console.log("Apply", btn);
        Dom.setEnabled(true, btn);
    }
    thiz.registrationsObject[rowId].classTransferInfo = classTransferInfo;
};
RegistrationsWidget.prototype.cleanFeeInputRegisterredEvents = function (event){
    var thiz = this;
    console.log("cleanFeeInputRegisterredEvents", thiz.additionalFeeInput);
    if (thiz.additionalFeeInput){
        console.log("cleanFeeInputRegisterredEvents unregisterEvent", thiz.additionalFeeInput);
        Dom.unregisterEvent(thiz.additionalFeeInput, "blur", thiz.additionalFeeInputChangeHandler.bind(thiz), false);
        Dom.unregisterEvent(thiz.additionalFeeInput, "keypress", thiz.additionalFeeInputKeyHandler.bind(thiz), false);
        Dom.unregisterEvent(thiz.additionalFeeInput, "selectionchange", thiz.additionalFeeInputKeyHandler.bind(thiz), false);
        thiz.additionalFeeInput = null;
    }
};

RegistrationsWidget.prototype.registerEventsToAdditionalInput = function (inputEl){
    var thiz = this;
    Dom.registerEvent(thiz.additionalFeeInput, "blur", thiz.additionalFeeInputChangeHandler.bind(thiz), false);
    Dom.registerEvent(thiz.additionalFeeInput, "selectionchange", thiz.additionalFeeInputChangeHandler.bind(thiz), false);
    
    var keyupDelay = 100;
    var keyupTimer;
    Dom.registerEvent(thiz.additionalFeeInput, "keypress", function(event){
        clearTimeout(keyupTimer);
        console.log("keyup:: clear timer", event);
        keyupTimer = setTimeout(function(){
            console.log("keyup:: additionalFeeInputChangeHandler", event);
            thiz.additionalFeeInputChangeHandler(event);
        }, keyupDelay);
    }, false);
};


RegistrationsWidget.prototype.additionalFeeInputChangeHandler = function (event){
    var e = event.target;
    var thiz = this;
    console.log("additionalFeeInputChangeHandler, outside", e);
    if (Dom.hasClass(e, "AdditionalFee")){
        var rowEl = Dom.findParentWithClass(e, "AdditionalTypeWrapper"); 
        console.log("additionalFeeInputChangeHandler, rowEl", rowEl);
        if (rowEl) thiz.processAdditionalFeeRow(rowEl);
        
    }
};

RegistrationsWidget.prototype.additionalFeeInputKeyHandler = function (event){
    var e = event.target;
    var thiz = this;
    console.log("additionalFeeInputKeyHandler, outside", event, e);
    if (Dom.hasClass(e, "AdditionalFee")){
        // var rowEl = Dom.findParentWithClass(e, "AdditionalTypeWrapper"); 
        // console.log("additionalFeeInputChangeHandler, rowEl", rowEl);
        // if (rowEl) thiz.processAdditionalFeeRow(rowEl);
        
    }
};

RegistrationsWidget.prototype.processAdditionalFeeRow = function (rowEl){
    var thiz = this;
    if (Dom.hasClass(rowEl, "AdditionalTypeWrapper")){
        var inputEl =  Dom.findDescendantWithClass(rowEl, "AdditionalFee");
        var table = Dom.findParentWithClass(rowEl, "ClassTransferFees");
        var rowId = table.getAttribute("ref");
        var regObj = thiz.registrationsObject[rowId];
        
        
        var chargeCateContainer = Dom.findDescendantWithClass(table, "ChargeCategoriesWrapper");
        console.log("additionalFeeInputChangeHandler, outside", table, rowId, chargeCateContainer, regObj);
        if (!inputEl && !table && !rowId && !chargeCateContainer) {
            console.log("Not found [table, rowId, regObj]", table, rowId, regObj);
            return;
        }
        var selectedChargeItem = chargeCateContainer._chargeCatgoryComboWidget.getSelectedItem();
        var v = parseFloat(inputEl.value);
        v = Math.abs(v);
        var additionType = document.querySelector('input[name="additionalType"]:checked').value;
        if (additionType == "CREDIT") {
            v = -v;
        }
        var classTransferInfo = regObj.classTransferInfo;
        var currentV = classTransferInfo.additionalFee;
        console.log("compare additionalFeeInputChangeHandler, new and old", v, currentV, additionType);
        if (currentV != v) {
            classTransferInfo.additionalFee = v? v : 0;
            thiz.registrationsObject[rowId].classTransferInfo = classTransferInfo;
            thiz.registrationsObject[rowId].classTransferInfo.additionalFeeChargeCategoryId = selectedChargeItem.id;
            thiz.isClassTransferChanging = true;
            console.log("additionalFeeInputChangeHandler, result", v, thiz.isClassTransferChanging);

            var wrapper = Dom.findParentWithClass(table, "ClassTransferDialogWrapper");
            console.log("wrapper", wrapper);
            if (wrapper){
                var btn = Dom.findDescendantWithClass(wrapper, "UpdateTransferFeeButton");
                console.log("Apply", btn);
                Dom.setEnabled(true, btn);
            }
        }
        
    }
};

RegistrationsWidget.prototype.studentListClickedHandler = function (event) {
    var thiz = this;
    if (Dom.hasClass(event.target, "SlotIconWrapper")
        || Dom.hasClass(event.target.parentNode, "SlotIconWrapper")
        || Dom.hasClass(event.target.parentNode.parentNode, "SlotIconWrapper")) {

        this.slotInstancePopupContent.innerHTML = "";
        var regSlotWarpper = Dom.findParentWithClass(event.target, "RegSlotWarpper");
        if (regSlotWarpper && regSlotWarpper._slotComboWidget) {
            var slotInfo = regSlotWarpper._slotComboWidget.getSelectedItem();
            if (!slotInfo) return;
            this.renderSlotTimesContent(slotInfo);
            Dom.addClass(this.slotInstancePopupContent.parentNode, "SlotInstancePopup");
            this.slotInstancePopup.show(event.target, "right-inside", "bottom", 0, 0, true);
        }
    } else if (/*(!Dom.hasClass(event.target, "DontOverride") && !Dom.hasClass(event.target.parentNode, "DontOverride"))  
                &&*/ (Dom.hasClass(event.target, "IsOverride") || Dom.hasClass(event.target.parentNode, "IsOverride"))) {
        this.showConflictsPopup(event.target);
    } else if (Dom.hasClass(event.target, "ShowWarningAndDontOverride") 
        || Dom.hasClass(event.target.parentNode, "ShowWarningAndDontOverride") 
        || Dom.hasClass(event.target.parentNode.parentNode, "ShowWarningAndDontOverride")) {
        this.showConflictsPopup(event.target);
    } else if (Dom.hasClass(event.target, "RemoveTotalFee") || Dom.hasClass(event.target.parentNode, "RemoveTotalFee")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        rowData.fee.isWaived = true;
        rowData.fee.paymentInfo = {};
        this.registrationsObject[rowData.id].fee.isWaived = true;
        this.renderTotalFeeContent(rowData);
        this.renderFeeNote();
        if (this.allowClassPaymentPlan) {
            this.checkRegistrations();
        } else {
            this.checkRegistrations([rowData.id]);
        }
    } else if (Dom.hasClass(event.target, "AddTotalFee") || Dom.hasClass(event.target.parentNode, "AddTotalFee")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        rowData.fee.isWaived = false;
        this.registrationsObject[rowData.id].fee.isWaived = false;
        this.renderTotalFeeContent(rowData);
        this.renderFeeNote();
        if (this.allowClassPaymentPlan) {
            this.checkRegistrations();
        } else {
            this.checkRegistrations([rowData.id]);
        }
    } else if (Dom.hasClass(event.target, "PaymentTypeContent")) {
        if (Dom.hasClass(event.target.parentNode, "PayByCC")) {
            var rowData = DataTable.getRowData(event.target);
            if (!rowData) return;
            this.openSetupCCDialog(rowData);
        }
    } else if (Dom.hasClass(event.target, "FeeDetailInfo") || Dom.hasClass(event.target.parentNode, "FeeDetailInfo")) {
        this.renderFeeInfo(event.target, true);
    } else if (Dom.hasClass(event.target, "TotalFee") || Dom.hasClass(event.target.parentNode, "TotalFee")) {
        var totalFeeEl = Dom.findParentWithClass(event.target, "TotalFee");
        if (!totalFeeEl) return;
        var feeDetailInfoIcon = Dom.findChildWithClass(totalFeeEl, "FeeDetailInfo");
        if (!feeDetailInfoIcon) return;
        var rowData = DataTable.getRowData(feeDetailInfoIcon);
        if (!rowData || !rowData.fee) return;
        var isClassTransfer = rowData.movedLessonClassInId > 0 && rowData.classTransferring;
        if (!isClassTransfer) return;
        this.renderFeeInfo(feeDetailInfoIcon, true);
    } else if (Dom.hasClass(event.target, "RemoveSubProgFee") || Dom.hasClass(event.target.parentNode, "RemoveSubProgFee")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        rowData.fee.chargedSubProgFee = false;
        this.registrationsObject[rowData.id].fee.chargedSubProgFee = false;
        this.checkRegistrations([rowData.id]);
    } else if (Dom.hasClass(event.target, "AddSubProgFee") || Dom.hasClass(event.target.parentNode, "AddSubProgFee")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        rowData.fee.chargedSubProgFee = true;
        this.registrationsObject[rowData.id].fee.chargedSubProgFee = true;
        this.checkRegistrations([rowData.id]);
    } else if (Dom.hasClass(event.target, "RemoveCouponCodeAction") || Dom.hasClass(event.target.parentNode, "RemoveCouponCodeAction")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        var couponInput = document.getElementById("couponInput_" + rowData.id);
        couponInput.value = "";
        rowData.fee.couponCode = "";
        this.registrationsObject[rowData.id].fee.couponCode = "";
        this.checkRegistrations([rowData.id]);
    } else if (Dom.hasClass(event.target, "PaymentPlanIconWrapper")
        || Dom.hasClass(event.target.parentNode, "PaymentPlanIconWrapper")
        || Dom.hasClass(event.target.parentNode.parentNode, "PaymentPlanIconWrapper")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        if (this.registrationsObject[rowData.id].assignedSlot < 0) {
            Dialog.error("Please assign slot before.");
            return;
        }
        var paymentPlanWarpper = Dom.findParentWithClass(event.target, "PaymentPlanWrapper");
        if (paymentPlanWarpper && paymentPlanWarpper._paymentPlanComboWidget) {
            var paymentPlanItem = paymentPlanWarpper._paymentPlanComboWidget.getSelectedItem();
            if (!paymentPlanItem) return;
            this.showPaymentPlanDetail(event.target, paymentPlanItem, rowData.assignedSlot);
        }
    } else if (Dom.hasClass(event.target, "IconClassInfo")
        || Dom.hasClass(event.target.parentNode, "IconClassInfo")
        || Dom.hasClass(event.target.parentNode.parentNode, "IconClassInfo")) {
        var iconClassInfo = Dom.findParentWithClass(event.target, "IconClassInfo");
        var rowData = DataTable.getRowData(event.target);
        if (iconClassInfo && rowData) {
            this.renderClassContentInfo(rowData);            
            Dom.addClass(this.classInstancePopupContent.parentNode, "ClassInstancePopup");
            this.classInstancePopup.show(iconClassInfo, "left-inside", "bottom", 0, 0, true);
        }
    }
};

RegistrationsWidget.prototype.renderTotalFeeContent = function (data) {
    var totalFeeWrapper = document.getElementById("totalFeeWrapper_" + data.id);
    if (!totalFeeWrapper) return;
    totalFeeWrapper.innerHTML = "";
    if (data.fee.isWaived) {
        var totalFee = document.createElement("div");
        totalFee.setAttribute("id", "totalFee_" + data.id);
        Dom.addClass(totalFee, "TotalFee");
        totalFee.innerHTML = "Waived";
        Dom.addClass(totalFeeWrapper, "Waived");
        totalFeeWrapper.appendChild(totalFee);
        var totalFeeAction = document.createElement("icon");
        Dom.addClass(totalFeeAction, "TotalFeeAction");
        Dom.addClass(totalFeeAction, "AddTotalFee");
        Dom.addClass(totalFeeAction, "plus-circle");
        totalFeeWrapper.appendChild(totalFeeAction);
        var classFee = document.getElementById("classFee_" + data.id);
        if(classFee) Dom.addClass(classFee, "Waived");
        var regFee = document.getElementById("regFee_" + data.id);
        if(regFee) Dom.addClass(regFee, "Waived");

        var subProgFeeWrapper = document.getElementById("subProgAddlFee_" + data.id);
        if(subProgFeeWrapper) Dom.addClass(subProgFeeWrapper, "Waived");

        var paymentTypeWrapper = document.getElementById("paymentTypeWrapper_" + data.id);
        if(paymentTypeWrapper) Dom.addClass(paymentTypeWrapper, "Waived");
        this._removePaymentConflict(data);
        var tableRow = Dom.findParentByTagName(paymentTypeWrapper, "tr");
        if (tableRow) {
            var conflictsWrapper = tableRow.getElementsByClassName("ConflictsWrapper")[0];
            if (conflictsWrapper) this.renderConflictsColumn(conflictsWrapper, data);
        }
    } else if (data.fee.totalFee >= 0 || (data.movedLessonClassInId > 0 && data.classTransferInfo && data.classTransferInfo.billedTodayAmount >= 0)) {
        Dom.removeClass(totalFeeWrapper, "Waived");
        var totalFee = document.createElement("div");
        totalFee.setAttribute("id", "totalFee_" + data.id);
        Dom.addClass(totalFee, "TotalFee");
        totalFee.innerHTML = "";
        var feeContent = document.createElement("div");
        Dom.addClass(feeContent, "FeeContent");
        feeContent.innerHTML = ClassUtils.toCurrency(data.fee.totalFee);
        totalFee.appendChild(feeContent);
        if (data.fee.allFeeInfo && (!ClassUtils.isEmpty(data.fee.allFeeInfo) || data.movedLessonClassInId > 0)) {
            var icon = document.createElement("icon");
            Dom.addClass(icon, "information");
            Dom.addClass(icon, "FeeDetailInfo");
            totalFee.appendChild(icon);
        }

        totalFeeWrapper.appendChild(totalFee);
        if (data.movedLessonClassInId > 0 && data.classTransferring) {
            feeContent.innerHTML = ClassUtils.toCurrency(data.classTransferInfo.billedTodayAmount);
        } else {
            if (data.fee.totalFee > 0 || data.fee.totalFeeWithoutUnappliedPayment > 0){
                var totalFeeAction = document.createElement("icon");
                Dom.addClass(totalFeeAction, "TotalFeeAction");
                Dom.addClass(totalFeeAction, "RemoveTotalFee");
                Dom.addClass(totalFeeAction, "close-circle-outline");
                totalFeeWrapper.appendChild(totalFeeAction);
            }    
        }
        

        var classFee = document.getElementById("classFee_" + data.id);
        if(classFee) Dom.removeClass(classFee, "Waived");
        var regFee = document.getElementById("regFee_" + data.id);
        if(regFee) Dom.removeClass(regFee, "Waived");

        var subProgFeeWrapper = document.getElementById("subProgAddlFee_" + data.id);
        if(subProgFeeWrapper) Dom.removeClass(subProgFeeWrapper, "Waived");

        var paymentTypeWrapper = document.getElementById("paymentTypeWrapper_" + data.id);
        if(paymentTypeWrapper) Dom.removeClass(paymentTypeWrapper, "Waived");

        this._updatePaymentConflict(data.paymentInfo.paymentTypeKey, data);
        var paymentTypeContent = paymentTypeWrapper.getElementsByClassName("PaymentTypeContent")[0];
        this.renderPaymentTypeContent(paymentTypeContent, data);

        var tableRow = Dom.findParentByTagName(paymentTypeWrapper, "tr");
        if (tableRow) {
            var conflictsWrapper = tableRow.getElementsByClassName("ConflictsWrapper")[0];
            if (conflictsWrapper) this.renderConflictsColumn(conflictsWrapper, data);
        }

        var rowData = DataTable.getRowData(totalFeeWrapper);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        var couponWrapper = document.getElementById("coupon_" + rowData.id);
        if (!couponWrapper) return;
        if (data.allowCoupon && couponWrapper._couponComboWidget) couponWrapper._couponComboWidget.setDisabled(false);
    } else if (data.fee.totalFee <= 0 && data.fee.hasAnyFee) {
        Dom.removeClass(totalFeeWrapper, "Waived");
        var totalFee = document.createElement("div");
        totalFee.setAttribute("id", "totalFee_" + data.id);
        Dom.addClass(totalFee, "TotalFee");
        totalFee.innerHTML = "";
        var feeContent = document.createElement("div");
        feeContent.innerHTML = ClassUtils.toCurrency(data.fee.totalFee);
        totalFee.appendChild(feeContent);
        var icon = document.createElement("icon");
        Dom.addClass(icon, "information");
        Dom.addClass(icon, "FeeDetailInfo");
        totalFee.appendChild(icon);
        totalFeeWrapper.appendChild(totalFee);
        // var totalFeeAction = document.createElement("icon");
        // Dom.addClass(totalFeeAction, "TotalFeeAction");
        // Dom.addClass(totalFeeAction, "RemoveTotalFee");
        // Dom.addClass(totalFeeAction, "close-circle-outline");
        // totalFeeWrapper.appendChild(totalFeeAction);

        var classFee = document.getElementById("classFee_" + data.id);
        if(classFee) Dom.removeClass(classFee, "Waived");
        var regFee = document.getElementById("regFee_" + data.id);
        if(regFee) Dom.removeClass(regFee, "Waived");

        var subProgFeeWrapper = document.getElementById("subProgAddlFee_" + data.id);
        if(subProgFeeWrapper) Dom.removeClass(subProgFeeWrapper, "Waived");

        var paymentTypeWrapper = document.getElementById("paymentTypeWrapper_" + data.id);
        if(paymentTypeWrapper) Dom.removeClass(paymentTypeWrapper, "Waived");

        this._updatePaymentConflict(data.paymentInfo.paymentTypeKey, data);
        var paymentTypeContent = paymentTypeWrapper.getElementsByClassName("PaymentTypeContent")[0];
        this.renderPaymentTypeContent(paymentTypeContent, data);

        var tableRow = Dom.findParentByTagName(paymentTypeWrapper, "tr");
        if (tableRow) {
            var conflictsWrapper = tableRow.getElementsByClassName("ConflictsWrapper")[0];
            if (conflictsWrapper) this.renderConflictsColumn(conflictsWrapper, data);
        }

        var rowData = DataTable.getRowData(totalFeeWrapper);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        var couponWrapper = document.getElementById("coupon_" + rowData.id);
        if (!couponWrapper) return;
        if (data.allowCoupon && couponWrapper._couponComboWidget) couponWrapper._couponComboWidget.setDisabled(false);
    }
};

RegistrationsWidget.prototype.studentListChangedHandler = function (event) {
    if (Dom.hasClass(event.target, "ConflictsAction")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        rowData.overrideConflict = event.target.checked;
        this.registrationsObject[rowData.id].overrideConflict = event.target.checked;
        var conflictsWrapper = Dom.findParentWithClass(event.target, "ConflictsWrapper");
        if (!conflictsWrapper) return;
        if (event.target.checked) {
            Dom.addClass(conflictsWrapper, "OverrideChecked");
        } else {
            Dom.removeClass(conflictsWrapper, "OverrideChecked");
        }
        this.checkRegistrations();
    } else if (Dom.hasClass(event.target, "EmailReceiptCheckBox")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        rowData.emailReceipt = event.target.checked;
        this.registrationsObject[rowData.id].emailReceipt = event.target.checked;
    } else if (Dom.hasClass(event.target, "UseUPCheckbox")) {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        var allowUnappliedPayment = event.target.checked;
        var accountId = rowData.accountId;
        for(var i in this.registrationsObject) {
            var reg = this.registrationsObject[i];
            if (reg.accountId != accountId) continue;
            reg.allowUnappliedPayment = allowUnappliedPayment;
        }
        this.checkRegistrations();
    }
};

RegistrationsWidget.prototype.studentListComboChangedHandler = function (event) {
    if (this.changingPaymentType) {
        this.changingPaymentType = false;
        return;
    }
    if (Dom.hasClass(event.target, "MemberPaymentType")) {
        var paymentTypeWrapper = Dom.findParentWithClass(event.target, "PaymentTypeWrapper");
        var paymentItem = paymentTypeWrapper._paymentComboWidget.getSelectedItem();
        this.memberPaymentTypeChangedHandler(paymentTypeWrapper, paymentItem);

    } else if (Dom.hasClass(event.target, "MemberRegSlotCombo")) {
        var regSlotWarpper = Dom.findParentWithClass(event.target, "RegSlotWarpper");
        var slotItem = regSlotWarpper._slotComboWidget.getSelectedItem();
        var rowData = DataTable.getRowData(regSlotWarpper);
        if (!this.registrationsObject[rowData.id]) return;
        if (!slotItem) slotItem = {slot: -1};
        if (slotItem.slot == this.registrationsObject[rowData.id].assignedSlot) return;
        this.registrationsObject[rowData.id].assignedSlot = slotItem.slot;
        rowData.assignedSlot = slotItem.slot;
        if (slotItem.slot >= 0) {
            Dom.addClass(regSlotWarpper, "AssignedSlot");
        } else {
            Dom.removeClass(regSlotWarpper, "AssignedSlot");
        }
        this.checkRegistrations([rowData.id]);
    } else if (Dom.hasClass(event.target, "MemberCouponCombo")) {
        if (!event.fromUser) return;
        var couponWrapper = Dom.findParentWithClass(event.target, "CouponWrapper");
        var couponComboItem = couponWrapper._couponComboWidget.getSelectedItem();
        var rowData = DataTable.getRowData(couponWrapper);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        
        var thiz = this;
        var metaData = this.metaDataObject[rowData.classId] || {classDetailInfo: {}};
        var couponCode = couponComboItem ? couponComboItem.code : "";
        var accountId = rowData.accountId;
        
        var message = "The assigned coupon of all registrations of this account will be cleared.";
        if (couponComboItem) {
            message = "All registrations of this account will be assigned to this coupon \"" + couponComboItem.code + "\".";
        }

        var applyCouponForAllReg = function () {
            Dialog.confirm(message, "", "Yes", function() {
                var checkRegistrationIds = [];
                for (var key in thiz.registrationsObject) {
                    var registration = thiz.registrationsObject[key];
                    if (registration.accountId == accountId) {
                        registration.fee.couponCode = couponCode;
                        checkRegistrationIds.push(registration.id);
                    }
                }
                thiz.checkRegistrations(checkRegistrationIds);
            }, "No", function () {
                couponWrapper._couponComboWidget.selectItemByKey("id", rowData.fee.couponCode, false);
            });
            
        }
        
        var applyCouponForReg = function () {
            rowData.fee.couponCode = couponCode;
            thiz.registrationsObject[rowData.id].fee.couponCode = couponCode;
            thiz.checkRegistrations([rowData.id]);
        };
        
        var hasNonApplyPerReg = false;
        var regCount = 1;
        for (var key in this.registrationsObject) {
            var registration = this.registrationsObject[key];
            if (registration.id != rowData.id && registration.accountId == accountId) {
                regCount ++;
                var registrationCouponCode = registration.fee.couponCode;
                if (thiz._isCouponCodeAppliedToCart(metaData, registrationCouponCode)) {
                    hasNonApplyPerReg = true;
                    break;
                }
            }
        }
        if (regCount > 1) {
            if (((couponComboItem && thiz._isCouponCodeAppliedToCart(metaData, couponComboItem.code)) || hasNonApplyPerReg)
                || (!couponComboItem && hasNonApplyPerReg)) {
                applyCouponForAllReg();
            } else {
                applyCouponForReg();
            }
        } else {
            applyCouponForReg();
        }
        
    } else if (Dom.hasClass(event.target, "PaymentPlanCombo")) {
        var paymentPlanWrapper = Dom.findParentWithClass(event.target, "PaymentPlanWrapper");
        var paymentPlanItem = paymentPlanWrapper._paymentPlanComboWidget.getSelectedItem();
        var rowData = DataTable.getRowData(paymentPlanWrapper);
        var paymentPlanItem = paymentPlanWrapper._paymentPlanComboWidget.getSelectedItem();
        console.log("paymentPlanWrapper, paymentPlanItem", paymentPlanWrapper, paymentPlanItem);
        console.log("rowData", rowData);
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        rowData.paymentPlanId = paymentPlanItem ? paymentPlanItem.id : 0;
        this.registrationsObject[rowData.id].paymentPlanId = paymentPlanItem ? paymentPlanItem.id : 0;
        console.log("rowData.id", rowData.id);
        this.checkRegistrations([rowData.id]);
        if (paymentPlanItem && paymentPlanItem.id > 0 && rowData.assignedSlot >= 0) {
            Dom.addClass(paymentPlanWrapper, "CanViewDetail");
        } else {
            Dom.removeClass(paymentPlanWrapper, "CanViewDetail");
        }
    }

};

RegistrationsWidget.prototype._isCouponCodeAppliedToCart = function (metaData, couponCode) {
    if (metaData && couponCode && couponCode.length && metaData.couponCodes[couponCode]) {
        return metaData.couponCodes[couponCode].isAppliedToCart;
    }
    return false;
};

RegistrationsWidget.prototype.studentListValueUpdatedHandler = function (event) {
    var thiz = this;
    if (Dom.hasClass(event.target, "StartDateWidget")) {
        var widget = event.target.__widget,
        rowData = DataTable.getRowData(event.target);
        if (!widget) return;
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        var startDate = widget.getDate();
        var sddPolicyStartDate = rowData.sddPolicyStartDate;
        var sddPolicyDropDate = rowData.sddPolicyDropDate;
        if (startDate && sddPolicyDropDate && startDate.getTime() > sddPolicyDropDate.getTime()) {
            var metaData = this.metaDataObject[rowData.classId] || {classDetailInfo: {}};            
            Dialog.error("Error", "Cannot update start date to "
            + FormatUtil.formatDateWithTZID(startDate, "date_standard", metaData.classDetailInfo.timezoneId) +
            " because start date is greater than drop date. Roll back to previous choice.", function () {
                event.target.__widget.setDate(ClassUtils.transformToTimeZone(sddPolicyStartDate, metaData.classDetailInfo.timezoneId));
            });
            return;
        }

        rowData.sddPolicyStartDate = startDate;
        this.registrationsObject[rowData.id].sddPolicyStartDate = widget.getDate();
        this.checkRegistrations([rowData.id]);
    } else if (Dom.hasClass(event.target, "DropDateWidget")) {
        var widget = event.target.__widget,
        rowData = DataTable.getRowData(event.target);
        if (!widget) return;
        if (!rowData) return;
        if (!this.registrationsObject[rowData.id]) return;
        var dropDate = widget.getDate();
        var sddPolicyStartDate = rowData.sddPolicyStartDate;
        var sddPolicyDropDate = rowData.sddPolicyDropDate;
        if (sddPolicyStartDate && dropDate && sddPolicyStartDate.getTime() > dropDate.getTime()) {
            var metaData = this.metaDataObject[rowData.classId] || {classDetailInfo: {}};
            Dialog.error("Error", "Cannot update drop date to "
            + FormatUtil.formatDateWithTZID(dropDate, "date_standard", metaData.classDetailInfo.timezoneId) +
            " because start date is greater than drop date. Roll back to previous choice.", function () {
                event.target.__widget.setDate(ClassUtils.transformToTimeZone(sddPolicyDropDate, metaData.classDetailInfo.timezoneId));
            });
            return;
        }

        rowData.sddPolicyDropDate = widget.getDate();
        this.registrationsObject[rowData.id].sddPolicyDropDate = widget.getDate();
        this.checkRegistrations([rowData.id]);
    }
};

RegistrationsWidget.prototype.studentListInputHandler = function (event) {
    if (Dom.hasClass(event.target, "CheckInput")) {
        if (event.data == "." || isNaN(event.target.value) || event.target.value.length > 20) {
            if(!event.target._lastGoodValue) event.target._lastGoodValue = "";
            event.target.value = 0;
            event.target.value = event.target._lastGoodValue;
            return;
        } else {
            event.target._lastGoodValue = event.target.value;
        }
        var thiz = this;
        if (this.inputingCheckNumberTimeout) {
            window.clearTimeout(this.inputingCheckNumberTimeout);
        }
        this.inputingCheckNumberTimeout = window.setTimeout(function () {
            thiz.checkInputChangedHandler(event);
        }, 1000);
    }
};

RegistrationsWidget.prototype.checkInputChangedHandler = function (event) {
    var rowData = DataTable.getRowData(event.target);
    if (!rowData) return;
    if (this.registrationsObject[rowData.id]) {
        this.registrationsObject[rowData.id].paymentInfo.checkNumber = event.target.value;
    }
    this.checkRegistrations();
};

RegistrationsWidget.prototype.addMoreStudentButtonClickedHandler = function () {
    if (this.options.action == "addClassForMember" || this.options.action == "reEnrollMemberClass") return;
    var metaData = this.metaDataObject[this.options.classId] || {classDetailInfo: {}};
    var classInfo = metaData.classDetailInfo, excludeMemberIds = [];
    if (this.registrationsObject) {
        for (var key in this.registrationsObject) {
            excludeMemberIds.push(this.registrationsObject[key].memberId);
        }
    }
    var memberDialogOptions = {
        classId: classInfo.id,
        title: classInfo.title,
        ageText: classInfo.ageText,
        allowedGender: classInfo.allowedGender,
        ageLow: classInfo.ageLow,
        ageHi: classInfo.ageHi,
        excludeMemberIds: excludeMemberIds,
        fromRegistrations: true,
        insuranceOptions: classInfo.insuranceOptions,
        emergencyOptions: classInfo.emergencyOptions,
    };
    var thiz = this;
    new SelectMemberDialog().callback(function (data) {
        if (data && data.addedMemberIds) {
            for (var i = 0; i < data.addedMemberIds.length; i++) {
                thiz.options.addedMemberIds.push(data.addedMemberIds[i]);
            }
            thiz.studentSource.memberIds = thiz.options.addedMemberIds;
            thiz.paginator.refresh();
            thiz.options.invalidateElements();
        }
    }).open(memberDialogOptions);
};

RegistrationsWidget.prototype.addMoreClassesButtonClickedHandler = function () {
    if (this.options.action != "addClassForMember" && this.options.action != "reEnrollMemberClass") return;
    var metaData = this.metaDataObject[this.options.classId] || {classDetailInfo: {}};    
    var classInfo = metaData.classDetailInfo, excludeClassIds = [];
    if (this.registrationsObject) {
        for (var key in this.registrationsObject) {
            excludeClassIds.push(this.registrationsObject[key].classId);
        }
    }
    var classDialogOptions = {
        memberId: this.options.memberId,
        memberFullName: this.options.memberFullName,
        fromRegistrations: true,
        excludeClassIds: excludeClassIds,
        action: this.options.action
    };
    var thiz = this;
    new SelectClassDialog().callback(function (data) {
        if (data && data.addedClassIds) {
            for (var i = 0; i < data.addedClassIds.length; i++) {
                thiz.options.addedClassIds.push(data.addedClassIds[i]);
            }
            thiz.studentSource.classIds = thiz.options.addedClassIds;
            thiz.studentDataTable.columns = [];
            thiz.studentDataTable.actualColumns = [];
            thiz.reloadRegistrationWidget(function () {                
                thiz.studentDataTable.setup();
                thiz.paginator.refresh();
                thiz.options.invalidateElements();
            });
        }
    }).open(classDialogOptions);
};

RegistrationsWidget.prototype.updateRegSlotButtonClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var selectedSlot = this.assignRegSlotCombo.getSelectedItem();
    if (!selectedSlot) return;
    var slotNumber = selectedSlot.slot;
    for (var i = 0; i < selectedItems.length; i ++) {
        if (this.registrationsObject[selectedItems[i].id]) {
            this.registrationsObject[selectedItems[i].id].assignedSlot = slotNumber;
        }
    }
    this.checkRegistrations();
};

RegistrationsWidget.prototype.overrideConflictButtonClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    for (var i = 0; i < selectedItems.length; i ++) {
        var item = selectedItems[i];
        if (item.assignedSlot >= 0 && item.conflicts != null && Object.getOwnPropertyNames(item.conflicts).length > 0) {
            item.overrideConflict = true;
            if (this.registrationsObject[item.id]) this.registrationsObject[item.id].overrideConflict = true;
            var overrideConflictCheckbox = document.getElementById("overrideConflictCheckbox_" + item.id);
            if(overrideConflictCheckbox) overrideConflictCheckbox.checked = true;
            var conflictsWrapper = Dom.findParentWithClass(overrideConflictCheckbox, "ConflictsWrapper");
            if (conflictsWrapper) Dom.addClass(conflictsWrapper, "OverrideChecked");
        }
    }
    this.checkRegistrations();
};

RegistrationsWidget.prototype.removeOverrideConflictButtonClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    for (var i = 0; i < selectedItems.length; i ++) {
        var item = selectedItems[i];
        if (item.assignedSlot >= 0 && item.conflicts != null && Object.getOwnPropertyNames(item.conflicts).length > 0) {
            item.overrideConflict = false;
            if (this.registrationsObject[item.id]) this.registrationsObject[item.id].overrideConflict = false;
            var overrideConflictCheckbox = document.getElementById("overrideConflictCheckbox_" + item.id);
            if(overrideConflictCheckbox) overrideConflictCheckbox.checked = false;
            var conflictsWrapper = Dom.findParentWithClass(overrideConflictCheckbox, "ConflictsWrapper");
            if (conflictsWrapper) Dom.removeClass(conflictsWrapper, "OverrideChecked");
        }
    }
    this.checkRegistrations();
};

RegistrationsWidget.prototype.updatePaymentTypeButtonClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var selectedPaymentType = this.paymentTypeCombo.getSelectedItem();
    if (!selectedPaymentType) return;
    var isClassTransferring = false;
    console.log("updatePaymentTypeButtonClickedHandler", selectedItems);
    if (selectedPaymentType.key == "waive") {
        var ids = [];
        for (var i = 0; i < selectedItems.length; i ++) {
            ids.push(selectedItems[i].id);
            var rowData = selectedItems[i];
            console.log("updatePaymentTypeButtonClickedHandler rowData", rowData);
            if (rowData.movedLessonClassInId && rowData.classTransferring) {
                this.waiveClassTransferFee(rowData);
                isClassTransferring = true;
            } else {
                selectedItems[i].fee.isWaived = true;
                if (this.registrationsObject[selectedItems[i].id]) this.registrationsObject[selectedItems[i].id].fee.isWaived = true;
                this.renderTotalFeeContent(selectedItems[i]);    
            }
        }
        console.log("updatePaymentTypeButtonClickedHandler isClassTransferring", isClassTransferring);
        if (isClassTransferring) {
            this.checkRegistrations();
            return;
        } 
        this.renderFeeNote();
        if (this.allowClassPaymentPlan) {
            this.checkRegistrations();
        } else {
            this.checkRegistrations([rowData.id]);
        }
        return;
    }

    var ids = [];
    for (var i = 0; i < selectedItems.length; i++) {
        var paymentTypeWrapper = document.getElementById("paymentTypeWrapper_" + selectedItems[i].id);
        if (!paymentTypeWrapper) continue;
        ids.push(selectedItems[i].id);
        this.memberPaymentTypeChangedHandler(paymentTypeWrapper, selectedPaymentType, true);
    }
    this.checkRegistrations(ids);
};

RegistrationsWidget.prototype.popupAllowOverrideCheckboxChangedHandler = function (event) {
    if (!this.conflictsInfoPopupOpener) return;
    if (!this.registrationsObject) return;
    var rowData = DataTable.getRowData(this.conflictsInfoPopupOpener);
    if (!rowData) return;
    if (!this.registrationsObject[rowData.id]) return;

    var conflictsAction = this.conflictsInfoPopupOpener.getElementsByClassName("ConflictsAction")[0];
    if (!conflictsAction) return;
    conflictsAction.checked = event.target.checked;
    this.registrationsObject[rowData.id].overrideConflict = event.target.checked;
    rowData.overrideConflict = event.target.checked;
    if (event.target.checked) {
        Dom.addClass(this.conflictsInfoPopupOpener, "OverrideChecked");
    } else {
        Dom.removeClass(this.conflictsInfoPopupOpener, "OverrideChecked");
    }
    this.checkRegistrations();
};

RegistrationsWidget.prototype.updatePaymentPlanButtonClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var paymentPlanItem = this.paymentPlanCombo.getSelectedItem();
    if (!paymentPlanItem) return;
    for (var i = 0; i < selectedItems.length; i ++) {
        if (this.registrationsObject[selectedItems[i].id]) {
            this.registrationsObject[selectedItems[i].id].paymentPlanId = paymentPlanItem.id;
        }
    }
    this.checkRegistrations();
};

RegistrationsWidget.prototype.getRegistrationsData = function () {
    var thiz = this;
    var unappliedPaymentWrapper = Dom.findParentWithClass(thiz.useUnappliedPayment, "UnappliedPaymentWrapper");
    if (unappliedPaymentWrapper && !Dom.hasClass(unappliedPaymentWrapper, "Hidden")){
        for (var key in thiz.registrationsObject) {
            thiz.registrationsObject[key].allowUnappliedPayment = thiz.useUnappliedPayment.checked;
        }
    }
    return this.registrationsObject;
};

RegistrationsWidget.prototype.deleteItemHandler = function (item) {
    if (!item) return;
    if (!this.registrationsObject) return;
    if (!this.registrationsObject[item.id]) return;

    var thiz = this;
    Dialog.confirm("Are you sure you want to delete this item?", "", "Delete", function() {
        if (thiz.options.movedLessonClassIns && thiz.options.movedLessonClassIns.length) {
            thiz.options.movedLessonClassIns = thiz.options.movedLessonClassIns.filter(function(reg) {
                return reg.member_id != item.memberId;
            });
        }
        delete thiz.registrationsObject[item.id];
        if (thiz.options.action == "addClassForMember" || thiz.options.action == "reEnrollMemberClass") {
            if (thiz.options.addedClassIds && thiz.options.addedClassIds.length > 0 && thiz.options.addedClassIds.indexOf(item.classId) >= 0) {
                thiz.options.addedClassIds.splice(thiz.options.addedClassIds.indexOf(item.classId), 1);
                thiz.invalidateElements();
                thiz.studentSource.classIds = thiz.options.addedClassIds;
                thiz.paginator.refresh();
            }
        } else {
            if (thiz.options.addedMemberIds && thiz.options.addedMemberIds.length > 0 && thiz.options.addedMemberIds.indexOf(item.memberId) >= 0) {
                thiz.options.addedMemberIds.splice(thiz.options.addedMemberIds.indexOf(item.memberId), 1);
                thiz.studentSource.memberIds = thiz.options.addedMemberIds;
                thiz.paginator.refresh();
            }
        }
        
        thiz.options.invalidateElements();
    }, "Cancel");

};

RegistrationsWidget.prototype.memberPaymentTypeChangedHandler = function (paymentTypeWrapper, paymentItem, isMultiUpdate) {
    var rowData = DataTable.getRowData(paymentTypeWrapper);
    if (rowData.paymentInfo && rowData.paymentInfo.paymentTypeKey == paymentItem.key) return;
    Dom.removeClass(paymentTypeWrapper, "PayByCC");
    if (this.registrationsObject[rowData.id]) {
        this.registrationsObject[rowData.id].paymentInfo = {};
        this.registrationsObject[rowData.id].paymentInfo.paymentTypeKey = paymentItem.key;
        this.registrationsObject[rowData.id].paymentInfo.paymentTypeName = paymentItem.name;
        this.registrationsObject[rowData.id].paymentInfo.checkNumber = "";
        this._removePaymentConflict(this.registrationsObject[rowData.id]);
        if (!isMultiUpdate) this.checkRegistrations([rowData.id]);

        if (paymentTypeWrapper._paymentComboWidget) {
            this.changingPaymentType = true;
            paymentTypeWrapper._paymentComboWidget.selectItemByKey("key", paymentItem.key);
        }

        this._updatePaymentConflict(paymentItem.key, this.registrationsObject[rowData.id]);
        if (paymentItem.key == "accountCC") {
            Dom.addClass(paymentTypeWrapper, "PayByCC");
            if (!isMultiUpdate) this.openSetupCCDialog(rowData);
        }
        var paymentTypeContent = paymentTypeWrapper.getElementsByClassName("PaymentTypeContent")[0];
        this.renderPaymentTypeContent(paymentTypeContent, this.registrationsObject[rowData.id]);
        
        this.invalidateElements();
        
        var tableRow = Dom.findParentByTagName(paymentTypeWrapper, "tr");
        if (!tableRow) return;
        var conflictsWrapper = tableRow.getElementsByClassName("ConflictsWrapper")[0];
        if (!conflictsWrapper) return;
        this.renderConflictsColumn(conflictsWrapper, this.registrationsObject[rowData.id]);

    }
};

RegistrationsWidget.prototype._removePaymentConflict = function (data) {
    if (data.conflicts){
        !data.conflicts.PAYMENT_INFO_MISSING || (delete data.conflicts.PAYMENT_INFO_MISSING);
        !data.conflicts.PAYMENT_MISSING_CHECK_NUMBER || (delete data.conflicts.PAYMENT_MISSING_CHECK_NUMBER);
        !data.conflicts.PAYMENT_MISSING_ACCOUNT_CC || (delete data.conflicts.PAYMENT_MISSING_ACCOUNT_CC);
    }
}

RegistrationsWidget.prototype._updatePaymentConflict = function (paymentKey, data) {
    /*if (!data.conflicts) return;
    switch (paymentKey) {
        case "check":
            data.paymentInfo.paymentTypeName = "Check #";
            if (!data.conflicts) {
                data.conflicts = {};
            }
            if(!!!data.paymentInfo.checkNumber) {
                data.conflicts.PAYMENT_MISSING_CHECK_NUMBER = this.conflictsObject.PAYMENT_MISSING_CHECK_NUMBER;
            }

            break;
        case "cash":
            data.paymentInfo.paymentTypeName = "Cash";
        break;
        case "accountCC":
            if (data.paymentInfo.ccEnding) {
                data.paymentInfo.paymentTypeName = data.paymentInfo.ccEnding;
                !data.conflicts.PAYMENT_MISSING_ACCOUNT_CC || (delete data.conflicts.PAYMENT_MISSING_ACCOUNT_CC);
            } else {
                data.paymentInfo.paymentTypeName = "Credit Card Missing";
                if (!data.conflicts) {
                    data.conflicts = {};
                }
                data.conflicts.PAYMENT_MISSING_ACCOUNT_CC = this.conflictsObject.PAYMENT_MISSING_ACCOUNT_CC;
            }
            break;
        case "wailistPayLater":
            data.paymentInfo.paymentTypeName = "Waitlist And Pay Later";
            break;
        default:
            break;
    }*/
}

RegistrationsWidget.prototype.assignRegSlotDetailInfoClickedHandler = function (event) {
    var selectedSlot = this.assignRegSlotCombo.getSelectedItem();
    if (!selectedSlot) return;
    var selectedMembers = this.studentDataTable.getSelectedItems();
    if (!selectedMembers || selectedMembers.length == 0) return;

    this.renderSlotTimesContent(selectedSlot);
    Dom.addClass(this.slotInstancePopupContent.parentNode, "SlotInstancePopup");
    this.slotInstancePopup.show(this.assignRegSlotDetailInfo, "left-inside", "bottom", 0, 0, true);
};

RegistrationsWidget.prototype.renderSlotTimesContent = function (selectedSlot) {
    this.slotInstancePopupContent.innerHTML = "";
    if (!selectedSlot.slotTimes || selectedSlot.slotTimes.length == 0) return;
    if (selectedSlot.slotTimes.length > 4) {
        this.slotInstancePopupContent.style.width = "28.5em";
    } else if (selectedSlot.slotTimes.length == 4) {
        this.slotInstancePopupContent.style.width = "19em";
    } else {
        this.slotInstancePopupContent.removeAttribute("style");
    }
    for (var i = 0; i < selectedSlot.slotTimes.length; i ++) {
        var slotTimeElm = document.createElement("div");
        Dom.addClass(slotTimeElm, "SlotTimeItem");
        slotTimeElm.innerHTML = selectedSlot.slotTimes[i];
        this.slotInstancePopupContent.appendChild(slotTimeElm);
    }
    var clearBoth = document.createElement("div");
    Dom.addClass(clearBoth, "ClearBoth");
    this.slotInstancePopupContent.appendChild(clearBoth);
    var slotOpen = (selectedSlot.slotOpen > 0 ? (selectedSlot.slotOpen < 99999? selectedSlot.slotOpen : "No limit") : 0);
    if (selectedSlot.maxLimit >= 99999) {
        slotOpen = "No Limit";
    }

    this.regSlotPopupSlotName.innerHTML = "Reg Slot #" + (selectedSlot.slot + 1)
        + " <span>(slot open: " + slotOpen + ")</span>";
};

RegistrationsWidget.prototype._canViewAccountCardList = function (rowData) {
    return PermissionUtils.isAccountWithAllPermissions(window.LOGIN_INFO, PERMISSION_KEY.AcctWallet_Account_ViewCardList);
};
RegistrationsWidget.prototype.openSetupCCDialog = function (rowData) {
    var thiz = this;    
    var accountId = rowData.accountId;
    
    var accept = this._canViewAccountCardList()
                || accountId == window.LOGIN_INFO.accountId;
    if (accept) {
        $classToolService.getAccountWithPaymentInfo(accountId, function (account) {
            new PaymentSetupDialog().callback(function (paymentInfo) {
                if(paymentInfo && paymentInfo.vaultTokenId) {
                    thiz._updatePayByCC(rowData, paymentInfo);
                } else {
                    thiz.checkRegistrations();
                }
            }).open({account: account, selectedCardId: false});
        }, function () {}, "Loading...");
    } else {
        Dialog.alert("Error", "No Permission to Access", function () {});
    }
    
    
};

RegistrationsWidget.prototype._updatePayByCC = function (rowData, ccArgs) {
    var paymentkey = "accountCC";
    var thiz = this;
    var paymentTypeWrapper = document.getElementById("paymentTypeWrapper_" + rowData.id);
    if (!paymentTypeWrapper) return;
    rowData.paymentInfo.vaultCCUseId = ccArgs.vaultTokenId;    
    this.checkRegistrations();
};

RegistrationsWidget.prototype.reloadRegistrationWithItem = function (itemIds) {
    var thiz = this;
    if (!itemIds || itemIds.length == 0) return;
    var classIds = [], memberIds = [];
    for (var i = 0; i < itemIds.length; i ++) {
        var strs = itemIds[i].split("_");
        var cId = strs[0];
        var mId = strs[1];
        classIds.push(parseInt(cId));
        memberIds.push(parseInt(mId));
    }
    if (thiz.options.movedLessonClassIns && thiz.options.movedLessonClassIns.length) {
        thiz.options.movedLessonClassIns = thiz.options.movedLessonClassIns.filter(function(reg) {
            return (memberIds.indexOf(reg.member_id) > -1);
        });
    }
    thiz.options.addedClassIds = classIds;
    thiz.studentSource.classIds = classIds;
    thiz.options.addedMemberIds = memberIds;
    thiz.studentSource.memberIds = memberIds;
    thiz.paginator.refresh();
};

RegistrationsWidget.prototype.renderFeeNote = function () {
    if (!this.options.classId) return;
    var metaData = this.metaDataObject[this.options.classId] || {classDetailInfo: {}};
    if (!this.registrationsObject) return;
    if (metaData.classDetailInfo.isChargeMonthly) {
        var hasWaivedFee = false;
        for (var key in this.registrationsObject) {
            if (this.registrationsObject[key].fee.isWaived) {
                hasWaivedFee = true;
                break;
            }
        }
        if (hasWaivedFee) {
            Dom.show(this.feeNote);
        } else {
            Dom.hide(this.feeNote);
        }
    } else {
        Dom.hide(this.feeNote);
    }
};

RegistrationsWidget.prototype._prebuildRegistrationId = function(classId, memberId) {
    return classId + "_" + memberId;
};

RegistrationsWidget.prototype._updateMovedLessonClassIn = function() {
    var thiz = this;
    if (this.options.movedLessonClassIns) {
        this.options.movedLessonClassIns.forEach(function(classIn) {
            var key = thiz._prebuildRegistrationId(thiz.options.classId, classIn.member_id);
            if (!thiz.registrationsObject || !thiz.registrationsObject[key]) {
                thiz.registrationsObject[key] = {
                    "memberId": classIn.member_id,
                    "classId": thiz.options.classId,
                    "movedLessonClassInId": classIn.id,
                    "assignedSlot": thiz.options.defaultRegSlot,
                    "paymentPlanId": thiz.options.defaultPaymentPlan
                };
            }
        });
    }
}

RegistrationsWidget.prototype.checkRegistrations = function (selectedIds, callback) {    
    var thiz = this;
    var classId = this.options.classId,
        classIds = this.options.addedClassIds,
        memberId = this.options.memberId,
        memberIds = this.options.addedMemberIds,
        action = this.options.action;
    
    var classIdMemberIdMap = {};
    if (action == "addClassForMember" || action == "reEnrollMemberClass") {
        for (var i = 0; i < classIds.length; i ++) {
            classIdMemberIdMap[classIds[i]] = [memberId];
        }
    } else {
        if (selectedIds && selectedIds.length > 0) {
            classIds = [];
            memberIds = [];
            for (var i = 0; i < selectedIds.length; i ++) {
                var cId = selectedIds[i].substring(0, selectedIds[i].indexOf("_"));
                var mId = selectedIds[i].substring(selectedIds[i].indexOf("_") + 1, selectedIds[i].length);
                classIds.push(cId);
                memberIds.push(mId);
            }
        }
        this._updateMovedLessonClassIn();
        classIdMemberIdMap[classId] = memberIds;
    }
    
    var unappliedPaymentWrapper = Dom.findParentWithClass(thiz.useUnappliedPayment, "UnappliedPaymentWrapper");
    if (unappliedPaymentWrapper && !Dom.hasClass(unappliedPaymentWrapper, "Hidden")){
        for (var key in thiz.registrationsObject) {
            thiz.registrationsObject[key].allowUnappliedPayment = thiz.useUnappliedPayment.checked;
        }
    }
    $classToolService.validateRegistrations(classIdMemberIdMap, this.registrationsObject, function (res) {
        for (var key in res) {
            var resData = res[key];
            var conflictsWrapper = document.getElementById("conflictsWrapper_" + resData.id);
            if (!conflictsWrapper) continue;
            var memberRowData = DataTable.getRowData(conflictsWrapper);
            if (!memberRowData) continue;
            if (!thiz.registrationsObject[memberRowData.id]) continue;
            var d = res[memberRowData.id];
            memberRowData.assignedSlot = d.assignedSlot;
            memberRowData.fee = d.fee;
            memberRowData.conflicts = d.memberRowData;
            memberRowData.allowOverride = d.allowOverride;
            memberRowData.conflictMessage = d.conflictMessage;
            thiz.registrationsObject[memberRowData.id].assignedSlot = d.assignedSlot;
            thiz.registrationsObject[memberRowData.id].fee = d.fee;
            thiz.registrationsObject[memberRowData.id].conflicts = d.conflicts;
            thiz.registrationsObject[memberRowData.id].allowOverride = d.allowOverride;
            thiz.registrationsObject[memberRowData.id].showWarningAndDontOverride = d.showWarningAndDontOverride;
            thiz.registrationsObject[memberRowData.id].conflictMessage = d.conflictMessage;
            thiz.registrationsObject[memberRowData.id].allowCoupon = d.allowCoupon;
            thiz.registrationsObject[memberRowData.id].paymentInfo = d.paymentInfo;
            thiz.registrationsObject[memberRowData.id].unappliedPaymentAmount = d.unappliedPaymentAmount;
            thiz.registrationsObject[memberRowData.id].allowUnappliedPayment = d.allowUnappliedPayment;
            thiz.registrationsObject[memberRowData.id].enableUnappliedPayment = d.enableUnappliedPayment;

            thiz.registrationsObject[memberRowData.id].classTransferInfo = d.classTransferInfo;
            thiz.registrationsObject[memberRowData.id].classTransferring = d.classTransferInfo? d.classTransferInfo.classTransferring : false;
            
            var regSlotWrapper = document.getElementById("regSlotWrapper_" + d.id);
            if (regSlotWrapper) thiz.renderRegSlotColumn(regSlotWrapper, d);

            var classFeeNode = document.getElementById("classFee_" + d.id);
            if (classFeeNode) thiz.renderClassFeeColumn(d);

            var regFeeNode = document.getElementById("regFee_" + d.id);
            if (regFeeNode) thiz.renderRegFeeColumn(d);

            var totalFeeNode = document.getElementById("totalFee_" + d.id);
            if (totalFeeNode) {
                totalFeeNode.innerHTML = "";
                var totalFeeContent = document.createElement("div");
                if (d.fee.isWaived) {
                    totalFeeContent.innerHTML = "Waived";
                } else {
                    if (d.classTransferInfo && d.classTransferInfo.classTransferring){
                        totalFeeContent.innerHTML = ClassUtils.toCurrency(d.classTransferInfo.billedTodayAmount);
                    } else {
                        totalFeeContent.innerHTML = (d.fee.totalFee == 0 && d.fee.totalFeeWithoutUnappliedPayment == 0) ? "" : (ClassUtils.toCurrency(d.fee.totalFee));
                    }
                    
                }
                totalFeeNode.appendChild(totalFeeContent);
                var icon = document.createElement("icon");
                Dom.addClass(icon, "information");
                Dom.addClass(icon, "FeeDetailInfo");
                totalFeeNode.appendChild(icon);
            }
            var couponNode = document.getElementById("coupon_" + d.id);
            if (couponNode) thiz.renderCouponColumn(d);

            var subProgAddlFee = document.getElementById("subProgAddlFee_" + d.id);
            if (subProgAddlFee) thiz.renderSubProgFeeColumn(d);
            memberRowData.conflicts = res[memberRowData.id].conflicts;
            thiz.registrationsObject[memberRowData.id].conflicts = res[memberRowData.id].conflicts;
            thiz.renderConflictsColumn(conflictsWrapper, thiz.registrationsObject[memberRowData.id]);
            thiz.renderStartDropDateColumn(thiz.registrationsObject[memberRowData.id]);
            thiz.renderPaymentPlanColumn(thiz.registrationsObject[memberRowData.id]);
            thiz.renderTotalFeeContent(thiz.registrationsObject[memberRowData.id]);
            thiz.renderFeeNote();
            var paymentTypeWrapper = document.getElementById("paymentTypeWrapper_" + memberRowData.id);
            thiz._updatePaymentConflict(thiz.registrationsObject[memberRowData.id].paymentInfo.paymentTypeKey, thiz.registrationsObject[memberRowData.id]);
            var paymentTypeContent = paymentTypeWrapper.getElementsByClassName("PaymentTypeContent")[0];
            var data = thiz.registrationsObject[memberRowData.id];
            thiz.renderPaymentTypeContent(paymentTypeContent, data);
        }
        thiz.invalidateElements();
        if (callback) callback();
        
    }, function (err) {
    }, "Updating...");
};

RegistrationsWidget.prototype.updateCouponButtonClickedHandler = function () {
    var selectedCouponItem = this.couponCodeCombo.getSelectedItem();
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var metaData = this.metaDataObject[selectedItems[0].classId];
    if (!metaData) return;
    var thiz = this;
    var registrationByAccount = {};
    for (var key in this.registrationsObject) {
        var registration = this.registrationsObject[key];
        if (!registrationByAccount[registration.accountId]) {
            registrationByAccount[registration.accountId] = {
                validated: false,
                hasNonApplyPerReg: false,
                items: []
            };
        }
        var registrationCouponCode = registration.fee.couponCode;
        if (this._isCouponCodeAppliedToCart(metaData, registrationCouponCode)) {
            registrationByAccount[registration.accountId].hasNonApplyPerReg = true;
        }         
        registrationByAccount[registration.accountId].items.push(registration);
    }
    
    var accountNeedApplyAll = []; var hasManyReg = false;
    for (var i = 0; i < selectedItems.length; i ++) {
        var item = selectedItems[i];
        var rba = registrationByAccount[item.accountId];
        if (rba.items.length > 1 && !rba.validated) {
            hasManyReg = true;
            if (((selectedCouponItem && thiz._isCouponCodeAppliedToCart(metaData, selectedCouponItem.code)) || rba.hasNonApplyPerReg)
                || (!selectedCouponItem && rba.hasNonApplyPerReg)) {
                rba.validated = true;
                accountNeedApplyAll.push(rba.items[0].accountFullName);
            }
        }
    }
    
    var applyCouponForReg = function () {
        var ids = [];
        for (var i = 0; i < selectedItems.length; i ++) {
            var item = selectedItems[i];
            var registration = thiz.registrationsObject[item.id];
            registration.fee.couponCode = selectedCouponItem && selectedCouponItem.code || "";
            ids.push(item.id);
        }
        thiz.checkRegistrations(ids);
    };
    
    var message = "The assigned coupon of all registrations of these accounts [" + accountNeedApplyAll.join(", ") + "] will be cleared.";
    if (selectedCouponItem) {
        message = "All registrations of these accounts [" + accountNeedApplyAll.join(", ") + 
            "] will be assigned to this coupon \"" + selectedCouponItem.code + "\".";
    }
    
    if ((!selectedCouponItem && accountNeedApplyAll.length > 0)
        || (selectedCouponItem && thiz._isCouponCodeAppliedToCart(metaData, selectedCouponItem.code) && accountNeedApplyAll.length > 0)
        || accountNeedApplyAll.length > 0 && hasManyReg) {
        Dialog.confirm(message, "", "Yes", function() {
            var checkRegistrationIds = [];
            var updatedAcc = {};
            for (var i = 0; i < selectedItems.length; i ++) {
                var item = selectedItems[i];
                var rba = registrationByAccount[item.accountId];
                if (rba.items.length > 1) {
                    if (!updatedAcc[item.accountId]) {
                        rba.items.forEach(function (r) {
                            r.fee.couponCode = selectedCouponItem && selectedCouponItem.code || "";
                            checkRegistrationIds.push(r.id);
                        });
                        updatedAcc[item.accountId] = true;
                    }
                } else {
                    var registration = thiz.registrationsObject[item.id];
                    registration.fee.couponCode = selectedCouponItem && selectedCouponItem.code || "";
                    checkRegistrationIds.push(item.id);
                }
            }
            thiz.checkRegistrations(checkRegistrationIds);
        }, "No", function () {});    
    } else {
        applyCouponForReg();
    }    
};

RegistrationsWidget.prototype.chargeProgAddlFeeButtonClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var ids = [];
    for (var i = 0; i < selectedItems.length; i ++) {
        selectedItems[i].fee.chargedSubProgFee = true;
        if (this.registrationsObject[selectedItems[i].id]) this.registrationsObject[selectedItems[i].id].fee.chargedSubProgFee = true;
        ids.push(selectedItems[i].id);
    }
    this.checkRegistrations(ids);
};

RegistrationsWidget.prototype.waiveProgAddlFeeButtonClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var ids = [];
    for (var i = 0; i < selectedItems.length; i ++) {
        selectedItems[i].fee.chargedSubProgFee = false;
        if (this.registrationsObject[selectedItems[i].id]) this.registrationsObject[selectedItems[i].id].fee.chargedSubProgFee = false;
        ids.push(selectedItems[i].id);
    }
    this.checkRegistrations(ids);
};

RegistrationsWidget.prototype.sendEmailReceiptClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    for (var i = 0; i < selectedItems.length; i ++) {
        if (this.registrationsObject[selectedItems[i].id]) this.registrationsObject[selectedItems[i].id].emailReceipt = true;
        selectedItems[i].emailReceipt = true;
        this.renderEmailReceiptColumn(selectedItems[i]);
    }
};

RegistrationsWidget.prototype.dontSendEmailReceiptClickedHandler = function () {
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    for (var i = 0; i < selectedItems.length; i ++) {
        if (this.registrationsObject[selectedItems[i].id]) this.registrationsObject[selectedItems[i].id].emailReceipt = false;
        selectedItems[i].emailReceipt = false;
        this.renderEmailReceiptColumn(selectedItems[i]);
    }
};

RegistrationsWidget.prototype.updatePolicyStartDateButtonClickedHandler = function () {
    if (this.options && (this.options.action == "addClassForMember" || this.options.action == "reEnrollMemberClass")) return;
    var thiz = this;
    var policyStartDate = this.policyStartDateWidget.getDate();
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var ids = [];
    var memberNotUpdated = [];
    for (var i = 0; i < selectedItems.length; i ++) {
        var rowData = this.registrationsObject[selectedItems[i].id];
        if (!rowData) continue;
        if (policyStartDate && rowData.sddPolicyDropDate && policyStartDate.getTime() > rowData.sddPolicyDropDate.getTime()) {
            memberNotUpdated.push(rowData.memberFullName);
            continue;
        } else {
            selectedItems[i].sddPolicyStartDate = policyStartDate;
            rowData.sddPolicyStartDate = policyStartDate;
            ids.push(selectedItems[i].id);
        }
    }
    if (memberNotUpdated.length > 0) {
        var metaData = this.metaDataObject[this.options.classId] || {classDetailInfo: {}};
        Dialog.error("Error", "Cannot update [" + memberNotUpdated.join(", ") + "] start date to "
        + FormatUtil.formatDateWithTZID(policyStartDate, "date_standard", metaData.classDetailInfo.timezoneId) +
        " because start date is greater than drop date. Roll back to previous choice.", function () {});
    }
    this.checkRegistrations(ids);
};

RegistrationsWidget.prototype.updatePolicyDropDateButtonClickedHandler = function () {
    if (this.options && this.options.action == "addClassForMember") return;
    var thiz = this;
    var policyDropDate = this.policyDropDateWidget.getDate();
    var selectedItems = this.studentDataTable.getSelectedItems();
    if (!selectedItems) return;
    var ids = [];
    var memberNotUpdated = [];
    for (var i = 0; i < selectedItems.length; i ++) {
        var rowData = this.registrationsObject[selectedItems[i].id];
        if (!rowData) continue;
        if (rowData.sddPolicyStartDate && policyDropDate && rowData.sddPolicyStartDate.getTime() > policyDropDate.getTime()) {
            memberNotUpdated.push(rowData.memberFullName);
            continue;
        } else {
            selectedItems[i].sddPolicyDropDate = policyDropDate;
            rowData.sddPolicyDropDate = policyDropDate;
            ids.push(selectedItems[i].id);
        }
    }
    if (memberNotUpdated.length > 0) {
        var metaData = this.metaDataObject[this.options.classId] || {classDetailInfo: {}};
        Dialog.error("Error", "Cannot update [" + memberNotUpdated.join(", ") + "] drop date to "
        + FormatUtil.formatDateWithTZID(policyDropDate, "date_standard", metaData.classDetailInfo.timezoneId) +
        " because start date is greater than drop date. Roll back to previous choice.", function () {});
    }
    this.checkRegistrations(ids);
};

RegistrationsWidget.prototype.renderCouponColumn = function (data) {
    if (!data) return;
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};
    var wrapper = document.getElementById("coupon_" + data.id);
    if (!wrapper) {
        wrapper = document.createElement("div");
        wrapper.setAttribute("id", "coupon_" + data.id);
        Dom.addClass(wrapper, "CouponWrapper");
    }
    wrapper.innerHTML = "";
    
    if (metaData.hasCoupon) {
        var couponCombo = new ComboManager();
        couponCombo.useHtml = true;
        couponCombo.renderer = this.couponCodeRenderer;
        couponCombo.decorator = this.couponDecorator;
        couponCombo.setPopupClass("ClassCouponCodeComboPopup");
        couponCombo.getDisplayValue = this.couponCodeDisplayValue;
        var couponCodes = [null].concat(Object.values(metaData.couponCodes));
        couponCombo.setItems(couponCodes);
        wrapper._couponComboWidget = couponCombo;
        if (data.fee.couponCode && data.fee.couponCode.length > 0) {
            couponCombo.selectItemByKey("code", data.fee.couponCode);
        }
        couponCombo.into(wrapper);
        Dom.addClass(couponCombo.node(), "MemberCouponCombo");
    }
    return wrapper;
};

RegistrationsWidget.prototype.renderSubProgFeeColumn = function (data) {
    if (!data) return;
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};
    var wrapper = document.getElementById("subProgAddlFee_" + data.id);
    if (!wrapper) {
        wrapper = document.createElement("div");
        wrapper.setAttribute("id", "subProgAddlFee_" + data.id);
    }
    wrapper.innerHTML = "";
    if (metaData.hasSubProgAddlFee) {
        Dom.addClass(wrapper, "SubProgAddlFee");
        if (data.fee.chargedSubProgFee) {
            Dom.removeClass(wrapper, "SubProgWaived");
            var feeContent = document.createElement("div");
            feeContent.innerHTML = ClassUtils.toCurrency(metaData.subProgAddlFee);
            wrapper.appendChild(feeContent);
        } else {
            Dom.addClass(wrapper, "SubProgWaived");
            var feeContent = document.createElement("div");
            feeContent.innerHTML = "";
            wrapper.appendChild(feeContent);
        }
        var removeSubProgFeeAction = document.createElement("icon");
        Dom.addClass(removeSubProgFeeAction, "SubProgFeeAction");
        Dom.addClass(removeSubProgFeeAction, "RemoveSubProgFee");
        Dom.addClass(removeSubProgFeeAction, "close-circle-outline");
        wrapper.appendChild(removeSubProgFeeAction);

        var addSubProgFeeAction = document.createElement("icon");
        Dom.addClass(addSubProgFeeAction, "SubProgFeeAction");
        Dom.addClass(addSubProgFeeAction, "AddSubProgFee");
        Dom.addClass(addSubProgFeeAction, "plus-circle");
        wrapper.appendChild(addSubProgFeeAction);
    }    
    return wrapper;
};

RegistrationsWidget.prototype.renderClassFeeColumn = function (data) {
    if (!data) return;
    var wrapper = document.getElementById("classFee_" + data.id);
    if(!wrapper) {
        wrapper = document.createElement("div");
        wrapper.setAttribute("id", "classFee_" + data.id);
    }
    wrapper.innerHTML = "";
    Dom.addClass(wrapper, "ClassFee");
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};
    if (metaData.allowClassPaymentPlan) {
        var feeContent = document.createElement("div");
        if (data.fee.classFee > 0) {
            feeContent.innerHTML = ClassUtils.toCurrency(data.fee.classFee);
            wrapper.appendChild(feeContent);
            var icon = document.createElement("icon");
            Dom.addClass(icon, "information");
            Dom.addClass(icon, "FeeDetailInfo");
            wrapper.appendChild(icon);
        }        
        if (data.fee.isWaived) {
            Dom.addClass(wrapper, "Waived");
        }
    }    
    return wrapper;
};

RegistrationsWidget.prototype.renderRegFeeColumn = function (data) {
    if (!data) return;
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};
    var wrapper = document.getElementById("regFee_" + data.id);
    if(!wrapper) {
        wrapper = document.createElement("div");
        wrapper.setAttribute("id", "regFee_" + data.id);
    }
    wrapper.innerHTML = "";
    Dom.addClass(wrapper, "RegFee");
    if (metaData.allowClassPaymentPlan) {
        if (data.fee.regFee > 0) {
            var feeContent = document.createElement("div");
            feeContent.innerHTML = ClassUtils.toCurrency(data.fee.regFee);
            wrapper.appendChild(feeContent);
            var icon = document.createElement("icon");
            Dom.addClass(icon, "information");
            Dom.addClass(icon, "FeeDetailInfo");
            wrapper.appendChild(icon);
        }        
        if (data.fee.isWaived) {
            Dom.addClass(wrapper, "Waived");
        }
    }    
    return wrapper;
};

RegistrationsWidget.prototype.renderEmailReceiptColumn = function (data) {
    if (!data) return;
    var emailReceipt = document.getElementById("emailReceipt_" + data.id);
    if(!emailReceipt) {
        emailReceipt = document.createElement("input");
        emailReceipt.setAttribute("type", "checkbox");
        emailReceipt.setAttribute("id", "emailReceipt_" + data.id);
    }
    Dom.addClass(emailReceipt, "EmailReceiptCheckBox");
    emailReceipt.checked = data.emailReceipt;
    return emailReceipt;
};

RegistrationsWidget.prototype.renderPaymentPlanColumn = function (data) {
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};
    var node = document.getElementById("paymentPlanWrapper_" + data.id);
    if (!node) {
        node = Dom.newDOMElement({
            _name: "hbox",
            id: "paymentPlanWrapper_" + data.id,
            "class": "PaymentPlanWrapper"
        });
    }
    node.innerHTML = "";
    if (metaData.allowClassPaymentPlan) {
        var paymentPlanCombo = new ComboManager();
        paymentPlanCombo.useHtml = true;
        paymentPlanCombo.renderer = this.paymentPlanComboRenderer;
        paymentPlanCombo.setItems([null].concat(metaData.classDetailInfo.paymentPlans));
        Dom.addClass(paymentPlanCombo.node(), "PaymentPlanCombo");
        if (data.assignedSlot < 0) {
            Dom.addClass(node, "Disabled");
            paymentPlanCombo.setEnable(false);
            paymentPlanCombo.selectItem(null);
            data.paymentPlanId = 0;
        } else {
            Dom.removeClass(node, "Disabled");
            paymentPlanCombo.setEnable(true);
            if (data.paymentPlanId > 0) paymentPlanCombo.selectItemByKey("id", data.paymentPlanId);
        }
        var comboWrapper = Dom.newDOMElement({
            _name: "div",
            "class": "PaymentPlanComboWrapper",
            flex: "1"
        });
        paymentPlanCombo.into(comboWrapper);
        node.appendChild(comboWrapper);
        node._paymentPlanComboWidget = paymentPlanCombo;

        var paymentPlanIconWrapper = Dom.newDOMElement({
            _name: "div",
            "class": "PaymentPlanIconWrapper",
            _children: [{
                _name: "icon",
                "class": "information"
            }]
        });
        if (data.assignedSlot >= 0 && data.paymentPlanId > 0) {
            Dom.addClass(node, "CanViewDetail");
        } else {
            Dom.removeClass(node, "CanViewDetail");
        }
        node.appendChild(paymentPlanIconWrapper);
    }    
    return node;
};

RegistrationsWidget.prototype.renderStartDropDateColumn = function (data) {
    var metaData = this.metaDataObject[data.classId] || {classDetailInfo: {}};    
    var node = document.getElementById("startDropDateWrapper_" + data.id);
    if (!node) {
        node = Dom.newDOMElement({
            _name: "vbox",
            id: "startDropDateWrapper_" + data.id,
            "class": "StartDropDateWrapper"
        });
    }
    node.innerHTML = "";
    
    if (metaData.classDetailInfo.editableSddStartDateDuringReg || metaData.classDetailInfo.editableSddDropDateDuringReg) {
        var classTimezoneProvider = {
            getTimezoneId: function () {
                return metaData.classDetailInfo.timezoneId;
            },
            getName: function () {
                return "Class time zone";
            }
        };
        
        var startDateWidget = new DateTimePicker();
        startDateWidget.setCustomTimezoneProvider(classTimezoneProvider);
        startDateWidget.setMinDate(ClassUtils.transformToTimeZone(metaData.classDetailInfo.minSddStartDate, metaData.classDetailInfo.timezoneId));
        startDateWidget.setMaxDate(ClassUtils.transformToTimeZone(metaData.classDetailInfo.maxSddStartDate, metaData.classDetailInfo.timezoneId));
        Dom.addClass(startDateWidget.node(), "StartDateWidget");
        var dropDateWidget = new DateTimePicker();
        dropDateWidget.setCustomTimezoneProvider(classTimezoneProvider);
        dropDateWidget.setMinDate(ClassUtils.transformToTimeZone(metaData.classDetailInfo.minSddDropDate, metaData.classDetailInfo.timezoneId));
        dropDateWidget.setMaxDate(ClassUtils.transformToTimeZone(metaData.classDetailInfo.maxSddDropDate, metaData.classDetailInfo.timezoneId));
        Dom.addClass(dropDateWidget.node(), "DropDateWidget");
        if (data.assignedSlot < 0) {
            Dom.addClass(node, "Disabled");
            startDateWidget.setEnabled(false);
            startDateWidget.setDate(null);
            data.sddPolicyStartDate = null;

            dropDateWidget.setEnabled(false);
            dropDateWidget.setDate(null);
            data.sddPolicyDropDate = null;
        } else {
            Dom.removeClass(node, "Disabled");
            startDateWidget.setEnabled(metaData.classDetailInfo.editableSddStartDateDuringReg);
            dropDateWidget.setEnabled(metaData.classDetailInfo.editableSddDropDateDuringReg);
            if (data.sddPolicyStartDate) startDateWidget.setDate(data.sddPolicyStartDate);
            if (data.sddPolicyDropDate) dropDateWidget.setDate(data.sddPolicyDropDate);
        }

        var policyStartDateWrapper = Dom.newDOMElement({
            _name: "hbox",
            id: "policyStartDateWrapper_" + data.id,
            "class": "PolicyStartDateWrapper",
            _children: [{
                _name: "label",
                _html: "S"
            }, startDateWidget]
        });
        var policyDropDateWrapper = Dom.newDOMElement({
            _name: "hbox",
            id: "policyDropDateWrapper_" + data.id,
            "class": "PolicyDropDateWrapper",
            _children: [{
                _name: "label",
                _html: "D"
            }, dropDateWidget]
        });
        node.appendChild(policyStartDateWrapper);
        node.appendChild(policyDropDateWrapper);
    }    
    return node;
};

RegistrationsWidget.prototype.viewPaymentPlanDetailClickedHandler = function (event) {
    var paymentPlanItem = this.paymentPlanCombo.getSelectedItem();
    if (!paymentPlanItem) return;
    //TODO fix assignedSlot
    var assignedSlot = 0;
    this.showPaymentPlanDetail(event.target, paymentPlanItem, assignedSlot);
};

RegistrationsWidget.prototype.showPaymentPlanDetail = function (target, paymentPlanItem, assignedSlot) {
    if (!paymentPlanItem) return;
    var thiz = this;
    var metaData = thiz.metaDataObject[paymentPlanItem.lessonClassId] || {classDetailInfo: {}};
    var options = {
        classInfo: metaData.classDetailInfo,
        selectedSlot: assignedSlot,
        filters: {},
        items: paymentPlanItem.items,
        paymentPlanId: paymentPlanItem.id,
        readOnly: true,
        startProjectedDate: new Date(),
        endProjectedDate: null,
        finishLoadingCallback: function () {
            thiz.paymentPlanDetailPopup.show(target, "center", "bottom", 0, 5, true);
        },
        isClassAdmin: (window.LOGIN_INFO && ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO))
    };
    var isBBhProjection = false;
    for (var i in paymentPlanItem.items) {
        var item = paymentPlanItem.items[i];
        if (item.ratePlanId && item.ratePlanId > 0) {
            isBBhProjection = true;
            break;
        }
    }
    
    if (thiz.options.movedLessonClassIns && thiz.options.movedLessonClassIns.length > 0) {
        var classInIds = [];
        for (var i = 0; i < thiz.options.movedLessonClassIns.length; i++) {
            var classIn = thiz.options.movedLessonClassIns[i];
            classInIds.push(classIn.id);
        }
        
        options.excludedLessonClassInIds = classInIds;
    }

    var rowData = DataTable.getRowData(event.target);
    if (rowData) {
        options.projectedLessonClassInId = 0;
        options.projectedMemberId = rowData.memberId;
    }
    if (rowData.sddPolicyStartDate) options.startProjectedDate = rowData.sddPolicyStartDate;
    if (rowData.sddPolicyDropDate) options.endProjectedDate = rowData.sddPolicyDropDate;
    if ((thiz.options.action == "addClassForMember" || thiz.options.action == "reEnrollMemberClass")&& isBBhProjection){
        var classIds = thiz.options.addedClassIds;
        var classIdMemberIdMap = {};
        for (var i = 0; i < classIds.length; i ++) {
            classIdMemberIdMap[classIds[i]] = [this.options.memberId];
        }
        var focusRegistrationId = rowData.id;
        $classToolService.projectBbhPaymentPlanOfNewRegistration(focusRegistrationId, classIdMemberIdMap, thiz.registrationsObject, function (res) {
            options.externalSource = res;
            widget.__ensureNamespaceLoaded("clpayplan", function (clpayplan) {
                thiz.paymentPlanDetailPopupHeader.innerHTML = paymentPlanItem.name;
                thiz.paymentPlanDetailPopupContent.innerHTML = "";
                Dom.addClass(thiz.paymentPlanDetailPopupContent.parentNode, "PaymentPlanDetailPopup ClassTool");
                new clpayplan.PaymentPlanItemGrid(options).into(thiz.paymentPlanDetailPopupContent);
            });
        }, function (err) {}, "Loading...");
    } else {
        widget.__ensureNamespaceLoaded("clpayplan", function (clpayplan) {
            thiz.paymentPlanDetailPopupHeader.innerHTML = paymentPlanItem.name;
            thiz.paymentPlanDetailPopupContent.innerHTML = "";
            Dom.addClass(thiz.paymentPlanDetailPopupContent.parentNode, "PaymentPlanDetailPopup ClassTool");
            new clpayplan.PaymentPlanItemGrid(options).into(thiz.paymentPlanDetailPopupContent);
        });
    }
    
};

RegistrationsWidget.prototype.renderClassContentInfo = function (itemData) {
    this.slotContentInfo.innerHTML = "";
    var metaData = this.metaDataObject[itemData.classId] || {classDetailInfo: {}};
    var classInfo = metaData.classDetailInfo;    
    this.classPopupProgramName.innerHTML = classInfo.progName;
    this.classPopupSubProgramName.innerHTML = classInfo.subProgName;
    this.classPopupSessionName.innerHTML = classInfo.sessionName;
    this.classPopupLocationName.innerHTML = classInfo.lessonLocName;
    this.classPopupClassStartDate.innerHTML = FormatUtil.formatDate(ClassUtils.transformClassTimezoneToLocal(classInfo.dateStart, classInfo.timezoneId), "date_standard", "local");
    this.classPopupClassEndDate.innerHTML = FormatUtil.formatDate(ClassUtils.transformClassTimezoneToLocal(classInfo.dateEnd, classInfo.timezoneId), "date_standard", "local");
    this.classPopupDuration.innerHTML = classInfo.duration + " mins";    
    this.slotContentInfo.appendChild(SelectClassListWidget.renderSlotsContent(classInfo));    
    
};

RegistrationsWidget.prototype.invalidateElements = function () {
    if (this.options.action == "addClassForMember" || this.options.action == "reEnrollMemberClass") {
        var enableUnappliedPayment; 
        var allowUnappliedPayment = false;
        var unappliedPaymentAmount = 0;
        var showUnappliedPaymentBar = false;
        for (var key in this.registrationsObject) {
            var data = this.registrationsObject[key];
            var isPaymentSetup = (data.paymentInfo.paymentTypeKey == "check" 
                                            || data.paymentInfo.paymentTypeKey == "accountCC" 
                                            || data.paymentInfo.paymentTypeKey == "waitPaid"
                                            || data.paymentInfo.paymentTypeKey == "cash");
            if (data.enableUnappliedPayment) {
                enableUnappliedPayment = true;
                unappliedPaymentAmount = data.unappliedPaymentAmount;
            }
            
            if (enableUnappliedPayment && data.allowUnappliedPayment && isPaymentSetup) {
                allowUnappliedPayment = true;
            }
            
            if (data.enableUnappliedPayment && enableUnappliedPayment) {
                if (data.paymentInfo && isPaymentSetup) {
                    showUnappliedPaymentBar = true;
                    break;
                }
            }
            
        }
        if (showUnappliedPaymentBar && unappliedPaymentAmount > 0) {
            Dom.removeClass(this.useUnappliedPaymentWrapper, "Hidden");
            this.useUnappliedPaymentLabel.innerHTML = "Use Unapplied Payment/Credit</span> (<span class=\"Amount\">" + (ClassUtils.toCurrency(unappliedPaymentAmount)) + "</span>)";
        } else {
            Dom.addClass(this.useUnappliedPaymentWrapper, "Hidden");
        }
        this.useUnappliedPayment.checked = allowUnappliedPayment;
    }
};

RegistrationsWidget.prototype.useUnappliedPaymentChangedHandler = function () {
    this.checkRegistrations();
};

RegistrationsWidget.prototype.showConflictsPopup = function (target) {
    this.conflictsInfoPopupContent.innerHTML = "";
    var rowData = DataTable.getRowData(target);
    if (!rowData || !rowData.conflicts || Object.getOwnPropertyNames(rowData.conflicts).length <= 0) return;

    var ulElm = document.createElement("ul");
    for (var key in rowData.conflicts) {
        var liElm = document.createElement("li");
        liElm.innerHTML = rowData.conflicts[key];
        ulElm.appendChild(liElm);
    }
    this.conflictsInfoPopupContent.appendChild(ulElm);
    Dom.addClass(this.conflictsInfoPopupContent.parentNode, "ConflictsInfoPopup");
    var overrideCheckboxParent = Dom.findParentWithClass(this.popupAllowOverrideCheckbox, "ConfictsInfoPopupFooter");
    Dom.removeClass(overrideCheckboxParent, "DontOverride");
    if (Dom.hasClass(target, "DontOverride") || Dom.hasClass(target.parentNode, "DontOverride")) {
        Dom.addClass(overrideCheckboxParent, "DontOverride");
    }
    this.popupAllowOverrideCheckbox.checked = rowData.overrideConflict;
    var conflictsWrapper = Dom.findParentWithClass(target, "ConflictsWrapper");
    this.conflictsInfoPopupOpener = conflictsWrapper;
    var icon = Dom.findChildWithClass(conflictsWrapper, "alert-octagon");
    if (icon) this.conflictsInfoPopup.show(icon, "right-inside", "bottom", 0, 0, true);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/SearchAccountDialog.js";

function SearchAccountDialog() {
    this.grabHeight = true;
    Dialog.call(this);
    var thiz = this;
    
    this.bind("input", this.searchTextInputHandler, this.searchText);
    this.bind("click", this.searchButtonClickedHandler, this.searchButton);
    
    this.accountSource = {
        order: {
            propertyName: "first_name",
            asc: true
        },
        keyword: "",
        loadPage: function (pageIndex, pageSize, handler, failed) {
            $classToolService.getAccounts(this.keyword,
                pageIndex * pageSize, pageSize, {name: this.order.propertyName, asc: this.order.asc}, function (list) {
                handler(list.result, list.count);
                thiz.searchText.focus();
            }, failed, thiz);
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
    this.initializeDataTable();
}


SearchAccountDialog.prototype.getInnerOffset = function () {
    if (window.innerWidth <= BaseWidget.RESPONSIVE_BREAKPOINTS.lg) {
        return {
            h: 5 * Util.em()
        };
    } else {
        return {
            h: 10 * Util.em()
        };
    }
};

__extend(Dialog, SearchAccountDialog);

SearchAccountDialog.prototype.setup = function (options) {
    var thiz = this;
    this.title = "Search an Account";
    this.options = options;
};

SearchAccountDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];

    return actions;
};

SearchAccountDialog.prototype.onBeforeShow = function () {
    this.accountDataTable.setup();
    var thiz = this;
    this.paginator = new InfiniteScrollPaginator();
    this.paginator._shouldLoadMore = function () {
        return thiz.paginator.renderer.isNearEnd() && thiz.paginator._isMoreItemsAvailable();
    };
    this.paginator._isMoreItemsAvailable = function () {
        return thiz.paginator.lastLoadedIndex >= 0 && ((thiz.paginator.lastLoadedIndex + 1) * thiz.paginator.pageSize < thiz.paginator.total);
    };
    this.paginator.setup({
        showPaginator : true,
        withoutStatus : true,
        onPageLoaded : function(p, count) {
        },
        comparer : function(a, b) {
            return a.transaction_id == b.transaction_id;
        },
        useButtons : false,
        avoidPageSizeRecalculation : true
    });
    this.paginator.needCalculatePageSize = function() {
        return true;
    };
    this.paginator.control(this.accountDataTable);
    this.paginator.setSource(this.accountSource);
};

SearchAccountDialog.prototype.initializeDataTable = function () {
    var thiz = this;
    this.accountDataTable.column(new DataTable.PlainTextColumn("First Name", function (data) {
        return "" + data.firstName;
    }).sortable("first_name").width("1*", "10em"));
    
    this.accountDataTable.column(new DataTable.PlainTextColumn("Last Name", function (data) {
        return "" + data.lastName;
    }).sortable("last_name").width("1*", "10em"));
    
    this.accountDataTable.column(new DataTable.PlainTextColumn("Email", function (data) {
        return "" + data.email;
    }).sortable("email").width("2*", "12em"));
    
    var actions = [{
        id: "add", type: "add", title: "Add",
        isApplicable: function(item) {
            return true;
        },
        handler: function (item, actionNode) {
            thiz.selectAccount(item, actionNode);
        }
    }];
    var actionCol = new DataTable.ActionColumn(actions);
    actionCol.title = "Actions";
    actionCol.getCellContentHtml = function (data, row, col) {
        return '<div class="AccountAction"><button type="button" title="Select" role="primary" action-id="add">Select</button></div>';
    };
    
    this.accountDataTable.column(actionCol.width("7em"));
    
    this.accountDataTable.selector(false, false);
    this.accountDataTable.setDefaultSelectionHandler({
        run: function (item) {}
    });
    this.accountDataTable.useFloatingHeader = true;
};

SearchAccountDialog.prototype.selectAccount = function (item, actionNode) {
    if (!item) return;
    this.close(item);
};

SearchAccountDialog.prototype.searchTextInputHandler = function () {
    var thiz = this;
    if (this.inputingSearchTextTimeout) {
        window.clearTimeout(this.inputingSearchTextTimeout);
    }
    var keyword = this.searchText.value;
    if (keyword.length < 3) return;
    this.inputingSearchTextTimeout = window.setTimeout(function () {
        if (thiz.accountSource.keyword != keyword) {
            thiz.accountSource.keyword = keyword;
            thiz.paginator.refresh();
        }
    }, 500);
};

SearchAccountDialog.prototype.searchButtonClickedHandler = function () {
    if (this.inputingSearchTextTimeout) {
        clearTimeout(this.inputingSearchTextTimeout);
    }
    if (this.accountSource.keyword != this.searchText.value) {
        this.accountSource.keyword = this.searchText.value;
        this.paginator.refresh();
    }
};




if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/SelectClassDialog.js";

function SelectClassDialog() {
    this.grabHeight = true;
    this.grabWidth = true;
    Dialog.call(this);
}

__extend(Dialog, SelectClassDialog);

SelectClassDialog.prototype.getInnerOffset = function () {
    if (window.innerWidth <= BaseWidget.RESPONSIVE_BREAKPOINTS.lg) {
        return {
            w: 5 * Util.em(),
            h: 5 * Util.em()
        };
    } else {
        return {
            h: 10 * Util.em()
        };
    }
};

SelectClassDialog.prototype.setup = function (options) {
    var thiz = this;
    this.title = "Add Classes for Member";
    this.options = options;
    var classListOptions = options;
    this.selectClassListWidget = new SelectClassListWidget(classListOptions).into(this.containerWrapper);
    this.selectClassListWidget._dialog = this;
};

SelectClassDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Next",
            run: function () {
                thiz.nextButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }];
    return actions;
};

SelectClassDialog.prototype.nextButtonClickHandler = function () {
    var thiz = this;    
    var items = this.selectClassListWidget.classDataTable.getSelectedItems();
    var classIds = [];
    console.log("getSelectedItems", items);
    if (items != null && items.length > 0) {
        items.forEach(function (r) {
            classIds.push(r.id);
        });
        var options = {
            memberId: thiz.options.memberId,
            addedClassIds: classIds
        };
        console.log(" SelectClassDialog options", options)
        thiz.close(options);
    } else {
        Dialog.alert("Error", "Please select class first.");
    }
};




if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/SelectClassListWidget.js";

function SelectClassListWidget(options) {
    this.options = options;
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.comparerFunction = function (a, b) {
        return a.id == b.id;
    };
    this.excludeClassIds = this.options.excludeClassIds ? this.options.excludeClassIds : [];
    this.classSource = {
        order: {
            propertyName: "title",
            asc: true
        },
        keyword: "",
        excludeClassIds: thiz.excludeClassIds,
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var searchCriteria = {
                keyword: this.keyword,
                excludeClassIds: this.excludeClassIds,
                pageStart: pageIndex * pageSize, pageSize: pageSize,
                onlyActiveClasses: true,
                searchBy: ["title", "progName", "sessionName"]
            };
            var orders = {
                name: this.order.propertyName, 
                asc: this.order.asc
            };
            $classAdminService.getAddableClassesForMember(searchCriteria, orders, function (list) {
                handler(list.result, list.count);
                if (list.count == 0) {
                    Dom.addClass(thiz.containerWrapper ,"Empty");
                } else {
                    Dom.removeClass(thiz.containerWrapper ,"Empty");
                }
                thiz.searchText.focus();
            }, failed, thiz._dialog);
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
    
    this.initializeDataTable();    
    this.bind("input", this.searchTextInputHandler, this.searchText);
    this.bind("click", this.classListClickedHandler, this.classDataTable.node());
    
    this.slotInfoPopup.popupOpacity = 0.9999;
    this.slotInfoBackgroundBox.translateDelta = 0.5;
    this.slotInfoPopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.slotInfoPopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.slotInfoPopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.slotInfoPopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.slotInfoPopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.slotInfoPopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") Dom.addClass(thiz.slotInfoPopupContent.parentNode, "PopupLeftInside");
        thiz.slotInfoBackgroundBox.onSizeChanged();
    }
}
__extend(BaseTemplatedWidget, SelectClassListWidget);

SelectClassListWidget.prototype.onAttached = function () {
    var thiz = this;
    window.setTimeout(function () {
        thiz.onAttachedDelayed();
    }, 200)

};

SelectClassListWidget.prototype.onAttachedDelayed = function () {    
    this.classDataTable.setup();
    this.classDataTable.comparer = this.comparerFunction;
    var thiz = this;
    this.paginator = new InfiniteScrollPaginator();
    this.paginator._shouldLoadMore = function () {
        return thiz.paginator.renderer.isNearEnd() && thiz.paginator._isMoreItemsAvailable();
    };
    this.paginator._isMoreItemsAvailable = function () {
        return thiz.paginator.lastLoadedIndex >= 0 && ((thiz.paginator.lastLoadedIndex + 1) * thiz.paginator.pageSize < thiz.paginator.total);
    };
    this.paginator.setup({
        showPaginator : true,
        withoutStatus : true,
        onPageLoaded : function(p, count) {
        },
        comparer : thiz.comparerFunction,
        useButtons : false,
        avoidPageSizeRecalculation : true
    });
    this.paginator.needCalculatePageSize = function() {
        return true;
    };
    this.paginator.control(this.classDataTable);
    this.paginator.setSource(this.classSource);
    
};

SelectClassListWidget.prototype.initializeDataTable = function () {
    var thiz = this;
    this.classDataTable.column(new DataTable.PlainTextColumn("Active Class", function (data) {
        return "" + data.title;
    }).sortable("title").width("1*", "10em"));
    
    this.classDataTable.column(new DataTable.PlainTextColumn("Program", function (data) {
        return "" + data.progName;
    }).sortable("progName").width("15em"));
    
    this.classDataTable.column(new DataTable.PlainTextColumn("Session", function (data) {
        if (data.sessionName && data.sessionName.length > 0) {
            return "" + data.sessionName;
        } else {
            return "";
        }        
    }).sortable("sessionName").width("15em"));
    
    this.classDataTable.column(new DataTable.DomNodeColumn("Active Registration", function (data) {
        return Dom.newDOMElement({
            _name: "hbox",
            "class": "ActiveRegistration",
            _children: [
                {
                    _name: "div",
                    _text: "" + data.totalActiveRegister
                }, 
                {
                    _name: "icon",
                    "class": "information RegistrationIcon"
                }
            ]
        });
    }).sortable("totalActiveRegister").width("13em"));
    
    this.classDataTable.disabledCheckBoxWhenCheckAll(false);
    this.classDataTable.selector(true, false);
    this.classDataTable.setDefaultSelectionHandler({
        run: function (item) {}
    });
    this.classDataTable.useFloatingHeader = true;
};

SelectClassListWidget.prototype.searchTextInputHandler = function () {
    var thiz = this;
    if (this.inputingSearchTextTimeout) {
        window.clearTimeout(this.inputingSearchTextTimeout);
    }
    var keyword = thiz.searchText.value;
    this.inputingSearchTextTimeout = window.setTimeout(function () {
        if (thiz.classSource.keyword != keyword) {
            thiz.classSource.keyword = keyword;
            thiz.paginator.refresh();
        }
    }, 500);
};

SelectClassListWidget.prototype.reloadSelectClassListWidget = function () {
    this.paginator.refresh();
};

SelectClassListWidget.prototype.classListClickedHandler = function (e) {
    var thiz = this;
    var rowData = DataTable.getRowData(e.target);
    if (!rowData) return;
    if (Dom.hasClass(e.target, "RegistrationIcon")
        || Dom.hasClass(e.target.parentNode, "RegistrationIcon")
        || Dom.hasClass(e.target.parentNode.parentNode, "RegistrationIcon")) {
            
        var rowData = DataTable.getRowData(e.target);
        if (!rowData.id) return;
        $classAdminService.getClassDetailById(rowData.id, function (res) {
            if (!res.slots || res.slots.length == 0) return;
            thiz.slotInfoPopupContent.innerHTML = "";
            thiz.slotInfoPopupContent.appendChild(SelectClassListWidget.renderSlotsContent(res));
            Dom.addClass(thiz.slotInfoPopupContent.parentNode, "SlotInfoPopup");
            thiz.slotInfoPopup.show(e.target, "right-inside", "bottom", 0, 0, true);
        }, function (err) {}, "Loading...");
        return;
    }
    if (Dom.hasClass(e.target, "DataTableCheck")
        || Dom.hasClass(e.target.parentNode, "DataTableCheck")) {
        return;
    }
    var selectedClass = this.classDataTable.getSelectedItems();
    var index = selectedClass.indexOf(rowData);
    if (index != -1) {
        selectedClass.splice(index, 1);
    } else {
        selectedClass.push(rowData);
    }
    this.classDataTable.selectItems(selectedClass);    
};

SelectClassListWidget.renderSlotsContent = function (itemData) {    
    var slotContentTable = document.createElement("table");
    Dom.addClass(slotContentTable, "TableRegSlot Slots");
    slotContentTable.setAttribute("border", "1");
    slotContentTable.setAttribute("cellspacing", "0");
    slotContentTable.setAttribute("cellpadding", "0");

    var tHead = document.createElement("thead");
    slotContentTable.appendChild(tHead);
    var headerRow = document.createElement("tr");
    tHead.appendChild(headerRow);

    var slotNumberCol = document.createElement("th");
    Dom.addClass(slotNumberCol, "slot-number");
    slotNumberCol.innerHTML = "Slot #";
    headerRow.appendChild(slotNumberCol);

    var slotLimitCol = document.createElement("th");
    Dom.addClass(slotLimitCol, "slot-limit");
    slotLimitCol.innerHTML = "Slot Limit";
    headerRow.appendChild(slotLimitCol);

    var slotOpenCol = document.createElement("th");
    Dom.addClass(slotOpenCol, "CurrentRegistrations");
    slotOpenCol.innerHTML = "Current Registrations";
    headerRow.appendChild(slotOpenCol);    

    var tbody = document.createElement("tbody");
    this.classTableBody = tbody;
    slotContentTable.appendChild(tbody);

    for(var i = 0; i < itemData.slots.length; i ++) {
        if(itemData.slots[i].showable) {
            tbody.appendChild(SelectClassListWidget.createRegSlotRow(itemData.slots[i], itemData.id, itemData.isWaitlist, itemData.isPastClass));                
        }
    }
    var tableSlotWrapper = document.createElement("div");
    Dom.addClass(tableSlotWrapper, "SlotsTable");
    tableSlotWrapper.appendChild(slotContentTable);
    return tableSlotWrapper;
};

SelectClassListWidget.createRegSlotRow = function (slotData, classId, isWaitlist, isPastClass) {
    var row = document.createElement("tr");
    row._classId = classId;
    row._slot = slotData.slot;
    var totalSlotRegister = slotData.slotRegister;
    Dom.addClass(row, "Slot");
    if (slotData.slotRegister < slotData.maxLimit || (slotData.maxLimit == 0 && isWaitlist)){
        Dom.addClass(row, "NotFull");
    }
    row._totalSlotRegister = totalSlotRegister;
    var slotNumberCol = document.createElement("td");
    Dom.addClass(slotNumberCol, "slot-number");
    slotNumberCol.innerHTML = slotData.slotOrder;
    row.appendChild(slotNumberCol);

    var slotLimitCol = document.createElement("td");
    Dom.addClass(slotLimitCol, "slot-limit");
    if(slotData.maxLimit == 99999) {
        slotLimitCol.innerHTML = "No Limit";
    } else {
        slotLimitCol.innerHTML = slotData.maxLimit;
    }
    row.appendChild(slotLimitCol);

    var currentRegistrationsCol = document.createElement("td");
    Dom.addClass(currentRegistrationsCol, "CurrentRegistrations");
    var slotOpen = slotData.openRegistration + "";
    if (slotOpen < 0) slotOpen = "0";
    if (slotOpen >= 99999) slotOpen = "No Limit";
    var registrationEl = Dom.newDOMElement({
        _name: "hbox",
        _children: [
            {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Currently registered members",
                _children: [{_name: "div", _html: "Active"}, {_name: "div", "flex": 1, "class": "Entered", _html: slotData.enteredRegistration + ""}]
            }, {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Available registrations. Does NOT consider any future registrations",
                _children: [{_name: "div", _html: "Open"},
                    {_name: "div", "flex": 1, "class": "Open", _html: slotOpen}]
            }, {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Registrations with a start date in the future",
                _children: [{_name: "div", _html: "Future"}, {_name: "div", "flex": 1, "class": "Future", _html: slotData.futureRegistration + ""}]
            },
            {
                _name: "div",
                "flex": 1,
                "class": "StatusCount",
                "statusHintText": "Waitlisted members",
                _children: [{_name: "div", _html: "Waiting"}, {_name: "div", "flex": 1, "class": "Waitlisted", _html: slotData.waitingRegistration + ""}]
            }
        ]
    });
    currentRegistrationsCol.appendChild(registrationEl);
    row.appendChild(currentRegistrationsCol);
    return row;
};



if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/tools/SelectMemberDialog.js";

function SelectMemberDialog() {
    this.grabHeight = true;
    this.grabWidth = true;
    Dialog.call(this);
}

__extend(Dialog, SelectMemberDialog);

SelectMemberDialog.prototype.getInnerOffset = function () {
    if (window.innerWidth <= BaseWidget.RESPONSIVE_BREAKPOINTS.lg) {
        return {
            w: 5 * Util.em(),
            h: 5 * Util.em()
        };
    } else {
        return {
            h: 10 * Util.em()
        };
    }
};

SelectMemberDialog.prototype.setup = function (options) {
    var thiz = this;
    this.title = "Add New Registrations";
    this.options = options;
    var memberListOptions = options;
    this.memberListWidget = new MemberListWidget(memberListOptions).into(this.containerWrapper);
    this.memberListWidget._dialog = this;
};

SelectMemberDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [
        {
            type: "accept", title: "Select",
            run: function () {
                thiz.selectButtonClickHandler();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }];
    if (ClassAuthUtils.canAddNewAccountMember(window.LOGIN_INFO)) {
        actions.push({
            type: "extra", title: "New Member...", icon: "plus",
            run: function () {
                thiz.newMemberButtonClickedHandler();
            }
        });
        actions.push({
            type: "extra", title: "New Account...", icon: "plus",
            run: function () {
                thiz.newAccountButtonClickedHandler(); 
            }
        });
    }

    return actions;
};

SelectMemberDialog.prototype.selectButtonClickHandler = function () {
    var addedMemberIds = this.memberListWidget.addedMemberIds;
    if (addedMemberIds && addedMemberIds.length > 0) {
        ClassUtils.registrationsTracking.sendEvent(ClassUtils.registrationsTracking.consts.action.selectedMembers, window.TEAM_ALIAS, addedMemberIds.length);
        console.log("Send GA Event: Action :", ClassUtils.registrationsTracking.consts.action.selectedMembers, " Label: ", window.TEAM_ALIAS, " Value: ", addedMemberIds.length);
        var options = {
            classId: this.options.classId,
            addedMemberIds: addedMemberIds
        };
        this.close(options);
    } else {
        Dialog.alert("Error", "Please add member first.");
    }
};


SelectMemberDialog.prototype.newAccountButtonClickedHandler = function () {
    var thiz = this;
    new AddAccountDialog().callback(function (accountData) {
        if (accountData && accountData.id > 0) {
            var account = {
                id: accountData.id,
                email: accountData.email,
                firstName: accountData.firstName,
                lastName: accountData.lastName
            };
            $classToolService.getMemberConfiguration(function (res) {
                var addMemberDialog = new AddMemberDialog();
                addMemberDialog.callback(function (data) {
                    if (addMemberDialog.isAddedMember && addMemberDialog.addedMembers && addMemberDialog.addedMembers.length > 0) {
                        for (var i = 0; i < addMemberDialog.addedMembers.length; i ++) {
                            var m = addMemberDialog.addedMembers[i];
                            m.memberFullName = m.first_name + " " + m.last_name;
                            thiz.memberListWidget.addMember(m, null);
                        }
                        thiz.memberListWidget.reloadMemberListWidget();
                    } else if (data && data.id > 0) {
                        data.memberFullName = data.first_name + " " + data.last_name;
                        thiz.memberListWidget.addMember(data, null);
                        thiz.memberListWidget.reloadMemberListWidget();
                    }
                }).open({memberConfiguration: res, accountObject: account});
            }, function (err) {
                
            }, new Spinner("Loading..."));
        }
    }).open({insuranceOptions: this.options.insuranceOptions, emergencyOptions: this.options.emergencyOptions});
};

SelectMemberDialog.prototype.newMemberButtonClickedHandler = function () {
    var thiz = this;
    var options = {};
    
    $classToolService.getMemberConfiguration(function (res) {
        var addMemberDialog = new AddMemberDialog();
        addMemberDialog.callback(function (data) {
            if (addMemberDialog.isAddedMember && addMemberDialog.addedMembers && addMemberDialog.addedMembers.length > 0) {
                for (var i = 0; i < addMemberDialog.addedMembers.length; i ++) {
                    var m = addMemberDialog.addedMembers[i];
                    m.memberFullName = m.first_name + " " + m.last_name;
                    thiz.memberListWidget.addMember(m, null);
                }
                thiz.memberListWidget.reloadMemberListWidget();
            } else if (data && data.id > 0) {
                data.memberFullName = data.first_name + " " + data.last_name;
                thiz.memberListWidget.addMember(data, null);
                thiz.memberListWidget.reloadMemberListWidget();
            }
        }).open({memberConfiguration: res, insuranceOptions: thiz.options.insuranceOptions});
    }, function (err) {
        
    }, new Spinner("Loading..."));
    
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/CoAComponent.js";

function CoAComponent() {
    BaseTemplatedWidget.call(this);
    this.currentKeyword = "";
    this.bind("click", this.loadDataTable.bind(this, false), this.btnSearch);
    this.bind("keyup", function(event) {
        if (event.keyCode == 13) this.loadDataTable();
    }, this.itemSearchKeyword);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.editCoA.bind(this, []), this.btnAddCoA);
    this.bind("click", this.dataTableClickHandle, this.tableCoAData);
}
__extend(BaseTemplatedWidget, CoAComponent);

CoAComponent.prototype.onAttached = function() {
    this.setupCoADataTable();
}

CoAComponent.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
}

CoAComponent.prototype.onEditDropdownMenuClick = function(event) {
    var thiz = this;
    this.paginator.getSelectedItems(function(items) {
        var ids = items.map(function(pv) {
            return pv.id;
        });
        if (ids.length == 0) return;
        switch (Dom.getAttributeAsString(event.target, "action")) {
            case "edit":
            thiz.editCoA(ids);
            break;
            case "delete":
            // this.deleteCoA(ids);
            break;
            case "hide":
            thiz.hideCoA(ids);
            break;
            case "active":
            thiz.activeCoA(ids);
            break;
            default:
            break;
        }
        thiz.editDropdownMenu.hide();
    });
}

CoAComponent.prototype.editCoA = function(ids) {
    var thiz = this;
    var editDialog = new CoAEditDialog().callback(function(response) {
        if (response) {
            thiz.loadDataTable(true);
        }
    });
    editDialog.open(ids);
}

CoAComponent.prototype.setupCoADataTable = function() {
    var thiz = this;
    var colName = new DataTable.GenericColumn("CoA", function (data) {
        return "<a class=\"CoAName\">" + data.name + "</a>";
    }).sortable("name").width("1*");
    colName.getContentTitle = function (data, row, col) {
        return "" + data.name;
    }
    this.tableCoAData.column(colName);
    this.tableCoAData.column(new DataTable.PlainTextColumn("Active/Hidden", function (data) {
        return (data.hidden ? "Hidden" : "Active");
    }).sortable("hide").width("10em"));
    this.tableCoAData.selector(true, false);
    this.tableCoAData.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.dataTable.addListener({
        onSelectionChanged: function (table, fromUserAction) {
            thiz.editDropdownButton.disabled = thiz.dataTable.getSelectedItems().length ? false : true;
        }
    });
    thiz.tableCoAData.setup();
    thiz.setupPaginator();
};

CoAComponent.prototype.setupPaginator = function() {
    var thiz = this;
    this.paginator.setup({
        getTotalItemText: function(total) {
            return "Total " + total;
        },
        showPaginator: true,
        withoutStatus: true,
        onPageLoaded: function (p, count) {
            var start = p.currentPage * p.pageSize + 1;
            var end = start + count - 1;
            Dom.setInnerText(thiz.currentPageDetail, String.format("Showing items {0}-{1} of {2}", start, end, p.totalItems));
        },
        comparer: function (a, b) {
            return a.id == b.id;
        },
        useButtons: false,
        avoidPageSizeRecalculation: true
    });
    this.paginator.pageSize = 20;
    this.paginator.needCalculatePageSize = function () { return false; };
    this.paginator.control(this.tableCoAData);
    this.paginator.setSource(this.createDataSource());
}

CoAComponent.prototype.createDataSource = function() {
    var thiz = this;
    return {
        order: {
            propertyName: "name",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var order = {
                name: this.order.propertyName,
                asc: this.order.asc,
                ignoreCase: this.order.propertyName == "name"
            };
            $classMetaService.searchLessonCoA(order, pageIndex, pageSize, thiz.currentKeyword, function(data) {
                thiz.data = data;
                thiz.totalDisplay.textContent = (data.count > 1 ? data.count + " CoAs" : data.count + " CoA");
                handler(data.result, data.count);
            }, function(error) {
                console.log("Request data error!", error);
            });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
}

CoAComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.refresh();
}

CoAComponent.prototype.hideCoA = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure to hide " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.setLessonCoAsIsHidden(ids, true, function(updated) {
                SnackBar.show("Data was saved successfully");
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to udpate CoA item(s) with error:", error);
            });
        },
        "Cancel", null);
}

CoAComponent.prototype.activeCoA = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure to active " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.setLessonCoAsIsHidden(ids, false, function(updated) {
                SnackBar.show("Data was saved successfully");
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to update CoA item(s) with error:", error);
            });
        },
        "Cancel", null);
}

CoAComponent.prototype.deleteCoA = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteLessonCoAs(ids, function(deleted) {
                SnackBar.show("" + (deleted ? deleted.length : 0) + " item(s) were deleted");
                if (!deleted || deleted.length < ids.length) {
                    var restList = thiz.tableCoAData.getSelectedItems().filter(function(item) {
                        return deleted.indexOf(item.id) == -1;
                    });
                    restList = restList.map(function(item) {
                        return item.name;
                    });
                    var message = "\"" + restList.join("\", \"") + (restList.length > 1 ? "\" are being used" : "\" is being used");
                    Dialog.alert("" + restList.length + " item(s) can not delete", message);
                }
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to delete CoA item(s) with error:", error);
            });
        },
        "Cancel", null);
}

CoAComponent.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "CoAName")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editCoA([rowData.id]);
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/CoAEditDialog.js";

function CoAEditDialog() {
    ModificationWatchDialog.call(this);
    this.updatedList = [];
    this.current = 0;
    this.hasDataUpdated = false;
    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
}
__extend(ModificationWatchDialog, CoAEditDialog);

CoAEditDialog.prototype.setup = function(ids) {
    if (ids && ids.length > 0) {
        this.updatedList = ids;
        this.title = "Edit CoA";
        if (ids.length > 1) {
            Dom.addClass(this.indexContainer, "Activate");
        }
        this.current = 0;
        this.loadCoAData(ids[0]);
    } else {
        this.title = "Create CoA";
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemName, "Please input 'CoA Name'");
}

CoAEditDialog.prototype.onPrevButtonClick = function() {
    if (this.current > 0) {
        this.current --;
        this.loadCoAData(this.updatedList[this.current]);
        if (this.current == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

CoAEditDialog.prototype.onNextButtonClick = function() {
    if (this.current < this.updatedList.length - 1) {
        this.current ++;
        this.loadCoAData(this.updatedList[this.current]);
        if (this.current == this.updatedList.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
}

CoAEditDialog.prototype.loadCoAData = function(id) {
    var thiz = this;
    $classMetaService.getLessonCoAById(id, function(data) {
        if (data) {
            thiz.displayIndex.textContent = String.format("CoA {0} of {1}", (thiz.current + 1), thiz.updatedList.length);
            thiz.data = data;
            thiz.itemName.value = data.name;
            thiz.itemHidden.checked = data.hidden;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
        }
    }, function(error) {
        console.error("Fail to get CoA: ", error);
    });
}

CoAEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

CoAEditDialog.prototype.getCurrentInputValues = function() {
    return {
        id: this.data ? this.data.id : 0,
        name: this.itemName.value,
        hidden: this.itemHidden.checked
    }
}

CoAEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var coa = this.getCurrentInputValues();
    if (this.updatedList.length > 0 && coa.id > 0) {
        $classMetaService.updateLessonCoA(coa, function(data) {
            SnackBar.show("CoA was saved successfully");
            thiz.hasDataUpdated = true;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            if (callback) callback(coa);
        }, function(error) {
            console.error("Fail to save lesson coa with error", error);
        });
    } else {
        $classMetaService.createLessonCoA(coa, function(data) {
            SnackBar.show("CoA was saved successfully");
            thiz.hasDataUpdated = true;
            coa.id = data;
            if (callback) callback(coa);
        }, function(error) {
            console.error("Fail to save lesson coa with error", error);
        });
    }
}

CoAEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.close(this.hasDataUpdated);
                return false;
            }
        }];
    }
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    if (thiz.updatedList.length < 2) thiz.close(data);
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        }
    ]
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/CouponComponent.js";

function CouponComponent() {
    BaseTemplatedWidget.call(this);
    this.domAttached = false;
    this.currentKeyword = "";
    this.bind("click", this.loadDataTable.bind(this, false), this.btnSearch);
    this.bind("keyup", function(event) {
    	this.paginator.currentPage = 0;	
        if (event.keyCode == 13) this.loadDataTable();
    }, this.itemSearchKeyword);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.editCoupon.bind(this, []), this.btnAddCoupon);
    this.bind("click", this.dataTableClickHandle, this.dataTable);
    Dom.registerEvent(this.itemSearchKeyword, "input", this.searchTextInputHandler.bind(this), true);
    Dom.toggleClass(this.node(), "Editable", this.canViewCreateEditCoupon());
    if (!this.canManageCoupon()) Dom.hide(this.deleteAction);
}
__extend(BaseTemplatedWidget, CouponComponent);

CouponComponent.prototype.onAttached = function (firstTime) {
    if (!firstTime) return;
    var thiz = this;
    new Promise(function(resolve, reject) {
        if (window.LOGIN_INFO && ClassAuthUtils.canManageCoupon(window.LOGIN_INFO)) {
            resolve(window.LOGIN_INFO);
        } else {
            $classAdminService.getAccountInfo(function(loginInfo) {
                resolve(loginInfo);
            }, function(error) { reject(error); });
        }
    }).then(function(loginInfo) {
        thiz.allowClassPaymentPlan = loginInfo.allowClassPaymentPlan;
        thiz.isViewOnly = !ClassAuthUtils.canManageCoupon(loginInfo);
        thiz.setupDataTable();
    });
}

CouponComponent.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
};

CouponComponent.prototype.onEditDropdownMenuClick = function(event) {
    var thiz = this;
    this.paginator.getSelectedItems(function(items) {
        var ids = items.map(function(pv) {
            return pv.id;
        });
        if (ids.length == 0) return;
        switch (Dom.getAttributeAsString(event.target, "action")) {
            case "edit":
                thiz.editCoupon(ids);
                break;
            case "delete":
                if (TEAM_INFO.isAffiliateTeam) {
                    var shared = items.some(function(item) { return item._shared; });
                    if (shared) {
                        Dialog.error("Cannot delete shared coupons");
                        break;
                    }
                }
                thiz.deleteCoupon(ids);
                break;
            default:
                break;
        }
        thiz.editDropdownMenu.hide();
    });
}

CouponComponent.prototype.editLocation = function(ids) {
    var thiz = this;
    var editDialog = new LocationEditDialog().callback(function(response) {
        if (response) {
            thiz.loadDataTable(true);
        }
    });
    editDialog.open(ids);
};

CouponComponent.prototype.setupDataTable = function() {
    var thiz = this;
    var colTitle = new DataTable.GenericColumn("Coupon Title", function (data) {
        return "<a class='CouponTitle'>" + data.title + "</a><icon class=\"file-tree SharedIndicator\" title=\"Shared coupon\"></icon>";
    }).sortable("title").width("1*", "9em");
    colTitle.getContentTitle = function (data, row, col) {
        return "";
    }
    this.dataTable.column(colTitle);
    
    var colSingleUse = new DataTable.GenericColumn("Redemption", function (data) {
        var redemptionText = "";
        if (data.redemptionLimit == "ONCE") {
            redemptionText = "Once";
            if (data.usageId && data.usageId > 0 && data.usageDate && data.redemptionLimit == "ONCE") {
                redemptionText += "<br/><span class=\"CouponRedeem\">" + FormatUtil.formatDate(data.usageDate, "date_standard", "local") + "</span>";
            }
        } else if (data.redemptionLimit == "ONCE_PER_ACCOUNT_TO_CHARGES") {
            redemptionText = "Account/Charges";
        } else if (data.redemptionLimit == "ONCE_PER_ACCOUNT_TO_CART") {
            redemptionText = "Account/Cart";
        } else if (data.redemptionLimit == "UNLIMITED") {
            redemptionText = "Unlimited";
        }
        /*
        if (data.applyPerReg) {
            redemptionText += "<br/><span class=\"CouponLegacy\">Legacy coupon</span>";   
        }
        */
        var html = "<span class=\"RedemptionLimitColumn\" title=\"{1}\" >{0}</span>";
        return String.format(html, redemptionText,
                            data.redemptionLimit == "ONCE" && data.redeemedAccountId > 0 ? ("Used by " + data.redeemedAccountName) : "");
    }).sortable("redemption_limit").width("15em");
    colSingleUse.useHtmlTitle = function() {
        return true;
    }
    colSingleUse.getContentTitle = function() {
        return "";
    }
    colSingleUse.getTitleInfo = function() {
        return "Redemption";
    }
    colSingleUse.dataType = "info";
    this.dataTable.column(colSingleUse);

    var colCode = new DataTable.PlainTextColumn("Code", function (data) {
        return data.code;
    }).sortable("code").width("10em");
    colCode.getContentTitle = function (data, row, col) {
        return "";
    }
    this.dataTable.column(colCode);
    
    var colDiscount = new DataTable.PlainTextColumn("Discount", function (data) {
         return (data.percent > 0 ? data.percent + "%" : Util.toCurrency(data.amount));
    }).width("7.5em");
    colDiscount.dataType = "currency";
    colDiscount.getContentTitle = function (data, row, col) {
        return "";
    }
    this.dataTable.column(colDiscount);
    
    var colLimitAmt = new DataTable.PlainTextColumn("Not to Exceed", function (data) {
        return data.limitAmount <= 0  || !data.limitAmount ? "" : Util.toCurrency(data.limitAmount);
    }).sortable("amt_limit").width("9.5em");
    colLimitAmt.dataType = "currency";
    this.dataTable.column(colLimitAmt);
    
    
    if (!this.allowClassPaymentPlan) {
        var colCoA = new DataTable.PlainTextColumn("CoA", function (data) {
            return data.coaName;
        }).width("12em");
        colCoA.getContentTitle = function (data, row, col) {
            return "";
        }
        this.dataTable.column(colCoA);
    }
    var colStartDate = new DataTable.PlainTextColumn("Start Date", function (data) {
        return FormatUtil.formatDate(data.startDate, "date_standard", "local");
    }).sortable("date_start").width("9em");
    this.dataTable.column(colStartDate);
    var colExpireDate = new DataTable.GenericColumn("Expiration Date", function (data) {
        return "<span class='" + (moment(data.expirationDate).isAfter(new Date(), "day") ? "" : "Expired") + "'>"
                + FormatUtil.formatDate(data.expirationDate, "date_standard", "local") + "</span>";
    }).sortable("date_expiration").width("10.5em");
    colExpireDate.getContentTitle = function (data, row, col) {
        return data.expirationDate;
    }
    this.dataTable.column(colExpireDate);
    
    if (this.canViewCreateEditCoupon()) {
        this.dataTable.selector(true, false);
        this.dataTable.disabledCheckBoxWhenCheckAll(false);
    }
    this.dataTable.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.dataTable.addListener({
        onSelectionChanged: function (table, fromUserAction) {
            thiz.editDropdownButton.disabled = thiz.dataTable.getSelectedItems().length ? false : true;
        }
    });
    this.dataTable.getClassOfRow = function (item) {
        if (item._shared) return "Shared";
        return "";
    };
    this.dataTable.setup();
    this.setupPaginator();
};

CouponComponent.prototype.setupPaginator = function() {
    var thiz = this;

    widget.__ensureNamespaceLoaded("util", function(util) {
        var config = util.paginationUtil.setupPaginatorConfig();

        config.onPageLoaded = function(p, count) {
            util.paginationUtil.setPaginationSummary(thiz.currentPageDetail, p.totalItems, p.currentPage, p.pageSize, count);
        };

        util.paginationUtil.setupPaginatorInstance(thiz.paginator, thiz.dataTable, thiz.createDataSource(), config);
    });
};

CouponComponent.prototype.createDataSource = function() {
    var thiz = this;
    return {
        order: {
            propertyName: "title",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var order = {
                name: this.order.propertyName,
                asc: this.order.asc,
                ignoreCase: this.order.propertyName == "title"
            };
            $classMetaService.searchCoupons(order, pageIndex, pageSize, thiz.currentKeyword, function(data) {
                thiz.data = data;
                thiz.totalDisplay.textContent = (data.count > 1 ? data.count + " Coupons" : data.count + " Coupon");                
                handler(data.result, data.count);
            }, function(error) {
                console.log("Request data error!", error);
            });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
};

CouponComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.refresh();
};

CouponComponent.prototype.editCoupon = function(ids) {
    var thiz = this;
    var editDialog = new CouponEditDialog().callback(function(response) {
        if (response) {
            thiz.loadDataTable(true);
        }
    });
    editDialog.open({ids: ids});
};

CouponComponent.prototype.deleteCoupon = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteCoupon(ids, function(deleted) {
                SnackBar.show("Data was deleted successfully.");
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to delete Coupon item(s) with error:", error);
            });
        },
        "Cancel", null);
};

CouponComponent.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "CouponTitle")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editCoupon([rowData.id]);
    }
};

CouponComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.currentPage = 0;
    this.paginator.refresh();
};

CouponComponent.prototype.searchTextInputHandler = function () {
    var thiz = this;
    if(this.inputingSearchTextTimeout) {
        clearTimeout(this.inputingSearchTextTimeout);
    }
    this.inputingSearchTextTimeout = window.setTimeout(function() {
        thiz.loadDataTable();
    }, 200);
};

CouponComponent.prototype.canViewCreateEditCoupon = function () {
    return ClassAuthUtils.canViewCreateEditCoupon(ACCOUNT_INFO);
};

CouponComponent.prototype.canManageCoupon = function () {
    return ClassAuthUtils.canManageCoupon(ACCOUNT_INFO);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/CouponEditDialog.js";

function CouponEditDialog() {
    ModificationWatchDialog.call(this);
    this.bind("change", this.validateDiscountInput.bind(this), this.radioPercentage);
    this.bind("change", this.validateDiscountInput.bind(this), this.radioDollarAmount);
    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
    this.bind("change", this.redemptionLimitChangedHandler, this.redemptionLimitWrapper);
    this.bind("change", this.applyOnePerAccountChangedHandler, this.applyOnePerAccountWrapper);
    this.isReadonly = !ClassAuthUtils.canViewCreateEditCoupon(ACCOUNT_INFO);
}
__extend(ModificationWatchDialog, CouponEditDialog);

CouponEditDialog.prototype.hasInputValuesChanged = function(values) {
    if (this.currentCoupon._shared) return false;
    return this.isReadonly ? false : this.__base(values).hasInputValuesChanged.apply(this);
};

CouponEditDialog.prototype.asyncSetup = function(options, dialogCallback) {
    var thiz = this;
    this.options = options;
    this.setDatePickerMinDate();
    this.selectAccountChart.renderer = function(item) {
        return item.name;
    }
    this.selectAccountChart.comparer = function(selected, item) {
        return selected.id == item.id;
    }
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        Dom.addClass(this.selectAccountChart.node().parentNode, "Hidden");
    }
    
    if (options.ids != null && options.ids.length > 1) {
        Dom.removeClass(this.indexContainer, "Hidden");
    } else {
        Dom.addClass(this.indexContainer, "Hidden");
    }
    
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemTitle, "Please input 'Coupon Title'")
        .required(this.itemCode, "Please input 'Coupon Code'")
        .custom(new RequiredRule(this.itemStartDate, "Please input date with format 'MM/DD/YYYY'"), function(rule) {
            return rule.input.getDate();
        })
        .custom(new RequiredRule(this.itemExpirationDate, "Please input date with format 'MM/DD/YYYY'"), function(rule) {
            return rule.input.getDate();
        })
        .required(this.itemPercentage, "Input value must be positive value", Condition.checked(this.radioPercentage))
        .min(this.itemPercentage, 0, true, "Input value must be positive value", Condition.checked(this.radioPercentage))
        .required(this.itemDollarAmount, "Input value must be positive value", Condition.checked(this.radioDollarAmount))
        .min(this.itemDollarAmount, 0, true, "Input value must be positive value", Condition.checked(this.radioDollarAmount));
        
        
        
    this.currentCoupon = {title: "", code: "", editable: true};
    var couponConfig = new Promise(function(resolve, reject) {
        $classMetaService.getCouponConfiguration(function(res) {
            thiz.couponConfiguration = res;
            thiz.selectAccountChart.setItems(thiz.couponConfiguration.coaSettingList);
            resolve();
        }, function (err) {reject(error);});
    });
    var promiseAll = [couponConfig];
    this.currentIndex = 0;
    if (options.ids != null && options.ids.length > 0) {
        this.ids = options.ids;
        this.title = "Update Coupon";            
        var couponDetail = new Promise(function(resolve, reject) {
            thiz.loadCouponData(options.ids[0], function () {
                resolve();
            });
        });
        promiseAll.push(couponDetail);
    } else {
        this.title = "Add Coupon";
        this.setSnapshotInputValues(this.getCurrentInputValues());
        this.clearUnsavedNotify();
    }
    

    Promise.all(promiseAll).then(function () {
        thiz.renderCouponDetail();
        dialogCallback();
    });
    
};

CouponEditDialog.prototype.validateDiscountInput = function(event) {
    if (this.radioPercentage.checked) {
        Dom.addClass(this.groupPercentage, "Activate");
        Dom.removeClass(this.groupAmount, "Activate");
        Dom.addClass(this.groupLimitAmount, "Activate");
    } else {
        Dom.removeClass(this.groupPercentage, "Activate");
        Dom.addClass(this.groupAmount, "Activate");
        Dom.removeClass(this.groupLimitAmount, "Activate");
    }
};

CouponEditDialog.prototype.loadCouponData = function(id, callback) {
    var thiz = this;
    $classMetaService.getCouponById(id, function(data) {
        thiz.displayIndex.textContent = String.format("Coupon {0} of {1}", (thiz.currentIndex + 1), thiz.options.ids.length);
        if (data) {}thiz.currentCoupon = data;
        if (callback) callback();
    }, function(error) {
        console.error("Fail to get Coupon:", error);
        if (callback) callback();
    });
};

CouponEditDialog.prototype.renderCouponDetail = function () {
    var thiz = this;
    thiz.itemTitle.value = thiz.currentCoupon.title;
    thiz.itemCode.value = thiz.currentCoupon.code;
    thiz.selectAccountChart.selectItemIfContains({id: thiz.currentCoupon.coaId});
    thiz.itemStartDate.setDate(thiz.currentCoupon.startDate);
    thiz.itemExpirationDate.setDate(thiz.currentCoupon.expirationDate);
    if (thiz.currentCoupon.percent) {
        thiz.radioPercentage.checked = true;
        thiz.itemPercentage.value = thiz.currentCoupon.percent;
        thiz.itemLimitAmount.setValue(thiz.currentCoupon.limitAmount);
    } else {
        thiz.radioDollarAmount.checked = true;
        thiz.itemDollarAmount.setValue(thiz.currentCoupon.amount);
    }
    
    Dom.emitEvent("change", thiz.radioDollarAmount);
    thiz.validateUI();
        
    if (this.currentCoupon.redemptionLimit == "ONCE") {
        this.radio1xUse.checked = true;
    } else if (this.currentCoupon.redemptionLimit == "ONCE_PER_ACCOUNT_TO_CHARGES") {
        this.radio1xUsePerMem.checked = true;
        this.radioOnePerAccount.checked = true;
    } else if (this.currentCoupon.redemptionLimit == "ONCE_PER_ACCOUNT_TO_CART") {
        this.radio1xUsePerAcc.checked = true;
        this.radioOnePerAccount.checked = true;
    } else {
        this.radioMultipleUse.checked = true;
    }
    
    console.log("thiz.getCurrentInputValues()", thiz.getCurrentInputValues());
    thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
    /*
    if (thiz.currentCoupon.id > 0 && thiz.currentCoupon.applyPerReg) {
        thiz.applyPerReg.checked = true;
    } else {
        Dom.addClass(this.applyPerRegWrapper, "Hidden");
    } 
    */   

    if (this.currentCoupon.id && TEAM_INFO.isAffiliateTeam) this.modified = true;

    thiz.clearUnsavedNotify();
};

CouponEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES.concat("p:ValueUpdated");
};

CouponEditDialog.prototype.getCurrentInputValues = function() {
    var coaItem = this.selectAccountChart.getSelectedItem();
    
    var redemptionLimit = "UNLIMITED";
    if (this.radio1xUse.checked)  {
        redemptionLimit = "ONCE";
    } else if (this.radio1xUsePerMem.checked) {
        redemptionLimit = "ONCE_PER_ACCOUNT_TO_CHARGES";
    } else if (this.radio1xUsePerAcc.checked) {
        redemptionLimit = "ONCE_PER_ACCOUNT_TO_CART";
    } else if (this.radioMultipleUse.checked) {
        redemptionLimit = "UNLIMITED";
    }
    
    return {
        id: this.currentCoupon.id ? this.currentCoupon.id : 0,
        title: this.itemTitle.value,
        code: this.itemCode.value,
        coaId: coaItem != null ? coaItem.id : 0,
        startDate: this.itemStartDate.getDate(),
        expirationDate: this.itemExpirationDate.getDate(),
        amount: this.radioDollarAmount.checked ? parseFloat(this.itemDollarAmount.getValue()) : 0,
        percent: this.radioPercentage.checked ? parseFloat(this.itemPercentage.value) : 0,
        redemptionLimit: redemptionLimit,
        limitAmount: this.radioPercentage.checked ? parseFloat(this.itemLimitAmount.getValue()) : 0
    }
};

CouponEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var coupon = this.getCurrentInputValues();
    if (coupon.id > 0) {
        $classMetaService.updateCoupon(coupon, function(data) {
            SnackBar.show("Coupon was saved successfully");
            if (callback) callback(coupon);
        }, function(error) {
            if (error.httpCode != 500) {
                Dialog.alert("Error", error.message);
            } else {
                Dialog.alert("Fail to save Coupon Setting with error", error);
            }
        });
    } else {
        $classMetaService.createCoupon(coupon, function(id) {
            SnackBar.show("Coupon was saved successfully");
            coupon.id = id;
            if (callback) callback(coupon);
        }, function(error) {
            if (error.httpCode != 500) {
                Dialog.alert("Error", error.message);
            } else {
                Dialog.alert("Fail to create Coupon Setting with error", error);
            }
        });
    }
};

CouponEditDialog.prototype.setDatePickerMinDate = function () {
    var minDate = moment.tz(new Date(), TimezoneProviders.server.getTimezoneId()).year(1930).month(0).date(1).hour(0).minute(0).second(0).millisecond(0);
    this.itemStartDate.setMinDate(minDate);
    this.itemExpirationDate.setMinDate(minDate);
};

CouponEditDialog.prototype.onPrevButtonClick = function() {
    var thiz = this;
    if (this.currentIndex > 0) {
        this.currentIndex --;
        this.loadCouponData(this.options.ids[this.currentIndex], function () {
            thiz.renderCouponDetail();
        });
        if (this.currentIndex == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

CouponEditDialog.prototype.onNextButtonClick = function() {
    console.log("onNextButtonClick");
    var thiz = this;
    if (this.currentIndex < this.options.ids.length - 1) {
        this.currentIndex ++;
        this.loadCouponData(this.options.ids[this.currentIndex], function () {
            thiz.renderCouponDetail();
        });
        if (this.currentIndex == this.options.ids.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
};


CouponEditDialog.prototype.redemptionLimitChangedHandler = function (event) {
    if (this.radioOnePerAccount.checked) {
        if (!this.radio1xUsePerMem.checked && !this.radio1xUsePerAcc.checked) {
            this.radio1xUsePerMem.checked = true;
        }
    } else {
        this.radio1xUsePerMem.checked = false;
        this.radio1xUsePerAcc.checked = false;
    }
};

CouponEditDialog.prototype.applyOnePerAccountChangedHandler = function (event) {
    if (this.radio1xUsePerMem.checked || this.radio1xUsePerAcc.checked) {
        this.radioOnePerAccount.checked = true;
    } else {
        this.radioOnePerAccount.checked = false;
    }
};

CouponEditDialog.prototype.validateUI = function () {
    Dom.addClass(this.alertMessage, "Hidden");
    Dom.addClass(this.alertRedemptionLimitMessage, "Hidden");
    Dom.removeClass(this.itemTitleWrapper, "Disabled");
    Dom.removeClass(this.itemCodeWrapper, "Disabled");
    
    this.itemTitle.removeAttribute("disabled", "disabled");
    this.itemCode.removeAttribute("disabled", "disabled");
    this.itemStartDate.setEnabled(true);
    this.itemExpirationDate.setEnabled(true);
    
    Dom.removeClass(this.discountedByWrapper, "Disabled");
    this.radioDollarAmount.removeAttribute("disabled", "disabled");
    this.itemDollarAmount.setEnable(true);
    this.radioPercentage.removeAttribute("disabled", "disabled");
    this.itemPercentage.removeAttribute("disabled", "disabled");
    this.itemLimitAmount.setEnable(true);
    
    Dom.removeClass(this.redemptionLimitWrapper, "Disabled");
    this.radio1xUse.removeAttribute("disabled", "disabled");
    this.radioOnePerAccount.removeAttribute("disabled", "disabled");
    this.radio1xUsePerAcc.removeAttribute("disabled", "disabled");
    this.radio1xUsePerMem.removeAttribute("disabled", "disabled");
    this.radioMultipleUse.removeAttribute("disabled", "disabled");
    
    if (!this.currentCoupon.editable /* || this.currentCoupon.applyPerReg*/) {
        Dom.addClass(this.redemptionLimitWrapper, "Disabled");
        this.radio1xUse.setAttribute("disabled", "disabled");
        this.radioOnePerAccount.setAttribute("disabled", "disabled");
        this.radio1xUsePerAcc.setAttribute("disabled", "disabled");
        this.radio1xUsePerMem.setAttribute("disabled", "disabled");
        this.radioMultipleUse.setAttribute("disabled", "disabled");
        if (this.currentCoupon.redemptionLimit == "ONCE") {
            Dom.removeClass(this.alertMessage, "Hidden");
            Dom.addClass(this.itemTitleWrapper, "Disabled");
            Dom.addClass(this.itemCodeWrapper, "Disabled");
            
            this.itemTitle.setAttribute("disabled", "disabled");
            this.itemCode.setAttribute("disabled", "disabled");
            this.itemStartDate.setEnabled(false);
            this.itemExpirationDate.setEnabled(false);
            
            Dom.addClass(this.discountedByWrapper, "Disabled");
            this.radioDollarAmount.setAttribute("disabled", "disabled");
            this.itemDollarAmount.setEnable(false);
            this.radioPercentage.setAttribute("disabled", "disabled");
            this.itemPercentage.setAttribute("disabled", "disabled");
            this.itemLimitAmount.setEnable(false);
        } else {
            Dom.removeClass(this.alertRedemptionLimitMessage, "Hidden");
        }
    }

    if (this.currentCoupon.id) {
        var readonly = this.isReadonly || this.currentCoupon._shared;
        if (readonly) {
            Dom.doOnSelector(this.dialogBody, "input", function(input) {
                input.disabled = true;
            });
        }
        this.title = readonly ? "Coupon Details" : "Edit Coupon";
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/CurriculumEditDialog.js";

function CurriculumEditDialog() {
    ModificationWatchDialog.call(this);
    this.updatedList = [];
    this.current = 0;
    this.hasDataUpdated = false;
    this.initializedTableSkillData = false;
    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.dataTableClickHandle, this.tableSkillData);
    this.bind("click", this.editSkill.bind(this, []), this.btnAddSkill);
    this.setupSkillDataTable();
}
__extend(ModificationWatchDialog, CurriculumEditDialog);

CurriculumEditDialog.prototype.setup = function(ids) {
    if (ids && ids.length > 0) {
        this.updatedList = ids;
        this.title = "Edit Curriculum";
        if (ids.length > 1) {
            Dom.addClass(this.indexContainer, "Activate");
        }
        this.current = 0;
        this.loadCurrData(ids[0]);
    } else {
        this.title = "Create Curriculum";
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemName, "Please input 'Curriculum Name'");
}

CurriculumEditDialog.prototype.onPrevButtonClick = function() {
    if (this.current > 0) {
        this.current --;
        this.loadCurrData(this.updatedList[this.current]);
        if (this.current == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

CurriculumEditDialog.prototype.onNextButtonClick = function() {
    if (this.current < this.updatedList.length - 1) {
        this.current ++;
        this.loadCurrData(this.updatedList[this.current]);
        if (this.current == this.updatedList.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
}

CurriculumEditDialog.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
}

CurriculumEditDialog.prototype.onEditDropdownMenuClick = function(event) {
    var ids = this.tableSkillData.getSelectedItems();
    ids = ids.map(function(pv) {
        return pv.id;
    });
    if (ids.length == 0) return;
    switch (Dom.getAttributeAsString(event.target, "action")) {
        case "edit":
        this.editSkill(ids);
        break;
        case "delete":
        this.deleteSkills(ids);
        break;
        case "undelete":
        break;
        default:
        break;
    }
    this.editDropdownMenu.hide();
}

CurriculumEditDialog.prototype.editSkill = function(ids) {
    var thiz = this;
    var editDialog = new SkillEditDialog().callback(function(response) {
        if (response) {
            thiz.hasDataUpdated = true;
            thiz.reloadSkillDataTable();
        }
    });
    if (this.data && this.data.id) {
        editDialog.open({currId: this.data.id, ids: ids});
    } else {
        Dialog.confirm("The Curriculum need to be created before create new Skill.", "Would you like to create the Curriculum with current input data?",
            "Create Curriculum", function() {
                thiz.save(function(data) {
                    thiz.data = data;
                    editDialog.open({currId: thiz.data.id, ids: ids});
                });
            },
            "Cancel", null);
    }
}

CurriculumEditDialog.prototype.setupSkillDataTable = function() {
    var thiz = this;
    var colName = new DataTable.GenericColumn("Skill", function (data) {
        return "<a class=\"SkillName\">" + data.name + "</a>";
    }).width("1*");
    colName.getContentTitle = function (data, row, col) {
        return "" + data.name;
    }
    this.tableSkillData.column(colName);
    this.tableSkillData.column(new DataTable.PlainTextColumn("Skill Description", function (data) {
        return (data.desc);
    }).width("2*"));
    var colAction = new DataTable.GenericColumn("", function(data) {
        return "<icon class=\"DragButton menu\"></icon>";
    }).width("3.5em");
    colAction.getContentTitle = function() {
        return "";
    }
    this.tableSkillData.column(colAction);
    this.tableSkillData.selector(true, false);
    this.tableSkillData.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.tableSkillData.disabledCheckBoxWhenCheckAll(false);
    setTimeout(function() {
        thiz.tableSkillData.setup();
        if (thiz.initializedTableSkillData) thiz.tableSkillData.setItems(thiz.data.skills);
        else thiz.initializedTableSkillData = true;
    }, 20);
}

CurriculumEditDialog.prototype.loadCurrData = function(id) {
    var thiz = this;
    $classMetaService.getLessonCurrById(id, function(data) {
        if (data) {
            thiz.displayIndex.textContent = String.format("Curriculum {0} of {1}", (thiz.current + 1), thiz.updatedList.length);
            thiz.data = data;
            thiz.itemName.value = data.name;
            thiz.itemDesc.value = data.desc;
            var snapshot = thiz.getCurrentCurrData();
            snapshot.skillsOrder = data.skills.map(function (item) {
                return item.id;
            });
            thiz.setSnapshotInputValues(snapshot);
            thiz.clearUnsavedNotify();
            thiz.captureTableSkillOrder = JSON.stringify(data.skills.map(function(item) {
                return item.id;
            }));
            if (thiz.initializedTableSkillData) thiz.tableSkillData.setItems(data.skills);
            else thiz.initializedTableSkillData = true;
            if (thiz.dialogBody.scrollHeight > thiz.dialogBody.clientHeight) thiz.invalidateSizing();
            thiz.setupReordering();
        }
    }, function(error) {
        console.error("Fail to get curriculum with ", error);
    });
}

CurriculumEditDialog.prototype.reloadSkillDataTable = function() {
    var thiz = this;
    $classMetaService.searchLessonCurrItemByCurrId(this.data.id, function(data) {
        thiz.tableSkillData.setItems(data);
        thiz.tableSkillData.selectNone();
        thiz.editDropdownButton.disabled = true;
    }, function(error) {
        console.log("Fail to get skill list with error:", error);
    });
}

CurriculumEditDialog.prototype.setupReordering = function () {
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
    .source(this.tableSkillData.node())
    .anchor(function (node) {
        return Dom.hasClass(node, "DragButton");
    })
    .itemInfo(function (anchor) {
        var item = Dom.findParentByTagName(anchor, "tr");
        if (!item) return null;
        return {
            element: item,
            data: item._data
        };
    })
    .destination(this.tableSkillData.body)
    .canDrop(function (data) {
        return true;
    }
    .bind(this))
    .dropAt(dropTargetFinderFunction)
    .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "tr",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        this.emitChangeEvent();
    }.bind(this);
};

CurriculumEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

CurriculumEditDialog.prototype.getCurrentCurrData = function() {
    return {
        id: this.data ? this.data.id : 0,
        name: this.itemName.value,
        desc: this.itemDesc.value
    }
}

CurriculumEditDialog.prototype.getCurrentInputValues = function() {
    var data = this.getCurrentCurrData();
    data.skillsOrder = this.tableSkillData.getOrderingItems().map(function(item) {
        return item.id;
    });
    return data;
}

CurriculumEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

CurriculumEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if (!ValidationManager.run(this.validationRules)) return false;
    var curr = this.getCurrentCurrData();
    if (curr.id != 0) {
        $classMetaService.updateLessonCurr(curr, function() {
            thiz.hasDataUpdated = true;
            SnackBar.show("Data was saved successfully");
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            if (callback) callback(curr);
        }, function(error) {
            console.error("Fail to save curriculum with error: " + error);
        });
        var orders = this.tableSkillData.getOrderingItems().map(function(item) {
            return item.id;
        });
        if (this.captureTableSkillOrder && this.captureTableSkillOrder != JSON.stringify(orders)) {
            $classMetaService.updateLessonCurrItemsOrder(orders, function() {
                console.log("Update Skill Table order successfully");
            }, function(error) {
                console.error("Fail to save Skill Table order");
            })
        }
    } else {
        $classMetaService.createLessonCurr(curr, function(id) {
            thiz.hasDataUpdated = true;
            SnackBar.show("Data was saved successfully");
            curr.id = id;
            this.data = curr;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            if (callback) callback(curr);
        }, function(error) {
            console.error("Fail to save curriculum with error:" + error);
        });
    }
}

CurriculumEditDialog.prototype.deleteSkills = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteLessonCurrItems(ids, function(deleted) {
                SnackBar.show("" + (deleted ? deleted.length : 0) + " item(s) were deleted");
                if (!deleted || deleted.length < ids.length) {
                    var restList = thiz.tableSkillData.getSelectedItems().filter(function(item) {
                        return deleted.indexOf(item.id) == -1;
                    });
                    restList = restList.map(function(item) {
                        return item.name;
                    });
                    Dialog.alert("" + restList.length + " item(s) can not delete", restList.join(", "));
                }
                thiz.reloadSkillDataTable();
            }, function(error) {
                console.log("Fail to delete curriculum item(s) with error:", error);
            });
        },
        "Cancel", null);
}

CurriculumEditDialog.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "SkillName")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editSkill([rowData.id]);
    } else {
        this.editDropdownButton.disabled = this.tableSkillData.getSelectedItems().length > 0 ? false : true;
    }
}

CurriculumEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.close(this.hasDataUpdated);
                return false;
            }
        }];
    }
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    if (thiz.updatedList.length < 2) thiz.close(data);
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        }
    ]
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/DiscountPlanDialog.js";

function DiscountPlanDialog() {
    Dialog.call(this);
    var thiz = this;
    this.bind("p:DiscountPlanItemChanged", function () {
        thiz.invalidateSizing();
    }, this.discountPlanContent);
}


__extend(Dialog, DiscountPlanDialog);

DiscountPlanDialog.prototype.setup = function (options) {
    if (!options) return;
    if (options.discountPlan && options.discountPlan.id > 0) {
        this.title = "Edit Discount Plan";
    } else {
        this.title = "Add Discount Plan";
    }
    this.options = options;
    this.discountPlanWidget = new DiscountPlanWidget(options).into(this.discountPlanContent);
};

DiscountPlanDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.saveDiscountPlan();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                if (thiz.discountPlanWidget && thiz.discountPlanWidget.isDataChanged()) {
                    Dialog.confirm("Are you sure you want to discard the unsaved changes?", null, "Discard changes", function () {
                        thiz.close();
                        return true;
                    },
                    "Cancel", function () {
                        return false;
                    }, null, null);
                } else {
                    return true;
                }
            }
        }
    ]
};

DiscountPlanDialog.prototype.saveDiscountPlan = function() {
    var thiz = this;
    if (!this.discountPlanWidget) return;
    if (!this.discountPlanWidget.validateDiscountData()) return;
    var discountData = this.discountPlanWidget.getDiscountPlanValue();
    $classAdminService.saveDiscountPlan(discountData, function (res) {
        thiz.close(res);
        SnackBar.show("Data was saved successfully");
    }, function (err) {
        Dialog.alert("Fail to save Discount  with error", err.message);
    });
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/FeeAndKitSettingsWidget.js";

function FeeAndKitSettingsWidget(node) {
    BaseTemplatedWidget.call(this);

    this.bind("click", function () {
        this.performCancel();
    }.bind(this), this.cancelButton);

    this.bind("click", function () {
        this.saveSettings();
    }.bind(this), this.saveButton);

    this.feeCalculationCombo.renderer = function (a) {
        return a.desc;
    };
    this.kitCalculationCombo.renderer = function (a) {
        return a.desc;
    };

    var dataChangeHandler = function(event) {
        if (typeof(event.fromUser) != "undefined") {
            if (!event.fromUser) return;
        }

        if (this._snapshotInputValues === null) {
            this.showUnsavedNotify();
            return;
        }
        this._validateInputValues();
    };

    var names = FeeAndKitSettingsWidget.ALL_CHANGED_EVENTS;
    for (var i = 0; i < names.length; i ++) {
        this.bind(names[i], dataChangeHandler, this.node());
    }
};
__extend(BaseTemplatedWidget, FeeAndKitSettingsWidget);

FeeAndKitSettingsWidget.prototype.onAttached = function (firstAttached) {
    if (!firstAttached) return;

    this.fetchSettingInfo();
};

FeeAndKitSettingsWidget.ALL_CHANGED_EVENTS = ["p:ItemSelected", "change", "input"];

FeeAndKitSettingsWidget.prototype.fetchSettingInfo = function () {
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        this.ANNUAL_CALCULATING_OPTIONS = cm.ModuleData.ANNUAL_CALCULATING_OPTIONS;
        this.feeCalculationCombo.setItems(this.ANNUAL_CALCULATING_OPTIONS);
        this.kitCalculationCombo.setItems(this.ANNUAL_CALCULATING_OPTIONS);

        $classMetaService.getAnnualCalculationSetting(function (setting) {
            this.setting = setting;
            this.setupView();
        }.bind(this), function (e) {
            Dialog.error(e.message);
        });
    }.bind(this));
};

FeeAndKitSettingsWidget.prototype.setupView = function () {
    this.clearUnsavedNotify();
    this.populateSettingInfo(this.setting);
    this.setSnapshotInputValues(this.getCurrentInputValues());

    InfoTip.install(this.node(), {
        match: node => Dom.hasClass(node, "InfoTip"),
        getMessage: (target) => {
            return "Once enabled, the Date Calculation & Date Used for Calculation setting will be applied to all the franchisees.";;
        }
    });
};

FeeAndKitSettingsWidget.prototype.populateSettingInfo = function (setting) {
    if (!setting) setting = {};
    
    this.feeCalculationCombo.selectItemById(this.ANNUAL_CALCULATING_OPTIONS.find((item) => item.name == (setting.annualFeeCalculatingOption || "EVERY_12_MONTHS")).id);
    Dom.doOnSelector(this.node(), "input[type='radio'][name='FeeDateCalculationType']", (input) => {
        if (input.value == (setting.annualFeeBasedDateOption || "REGISTRATION_DATE")) {
            input.checked = true;
        } else {
            input.checked = false;
        }
    });

    this.kitCalculationCombo.selectItemById(this.ANNUAL_CALCULATING_OPTIONS.find((item) => item.name == (setting.annualKitCalculatingOption || "EVERY_12_MONTHS")).id);
    Dom.doOnSelector(this.node(), "input[type='radio'][name='KitDateCalculationType']", (input) => {
        if (input.value == (setting.annualKitBasedDateOption || "REGISTRATION_DATE")) {
            input.checked = true;
        } else {
            input.checked = false;
        }
    });

    this.annualFeeCheckbox.checked = setting.annualFeeSettingShared;
    this.annualKitCheckbox.checked = setting.annualKitSettingShared;
};

FeeAndKitSettingsWidget.prototype.saveSettings = function () {
    var values = this.getCurrentInputValues();
    $classMetaService.saveAnnualCalculationSetting(values, function (setting) {
        SnackBar.show("All changes has been saved!");
        this.setting = setting;
        this.setupView();
    }.bind(this), function (e) {
        Dialog.error(e.message);
    });
};

FeeAndKitSettingsWidget.prototype.performCancel = function () {
    Dialog.confirm(
        "Are you sure you want to discard the unsaved changes?",
        null,
        "Discard changes",
        () => {
            setTimeout(() => {
                this.setupView();
            }, 100);
        },
        "Cancel"
    );
};

FeeAndKitSettingsWidget.prototype._validateInputValues = function () {
    var curValues = this.getCurrentInputValues() || {};
    var snapshotValues = this._snapshotInputValues || {};
    if (JSON.stringify(snapshotValues) !== JSON.stringify(curValues)) {
        this.showUnsavedNotify();
    } else {
        this.clearUnsavedNotify();
    }
}

FeeAndKitSettingsWidget.prototype.getCurrentInputValues = function () {
    var settings = Util.clone(this.setting) || {id: -1};
    settings.annualFeeCalculatingOption = this.feeCalculationCombo.getSelectedItem().name;
    settings.annualFeeBasedDateOption = this.feeRegistrationOption.checked ? "REGISTRATION_DATE" : "CLASS_START_DATE";
    settings.annualKitCalculatingOption = this.kitCalculationCombo.getSelectedItem().name;
    settings.annualKitBasedDateOption = this.kitRegistrationOption.checked ? "REGISTRATION_DATE" : "CLASS_START_DATE";
    settings.annualFeeSettingShared = this.annualFeeCheckbox.checked;
    settings.annualKitSettingShared = this.annualKitCheckbox.checked;

    return settings;
};

FeeAndKitSettingsWidget.prototype.setSnapshotInputValues = function (values) {
    if(values && typeof (values) == "object") {
        this._snapshotInputValues = JSON.parse(JSON.stringify(values));
    } else {
        this._snapshotInputValues = values;
    }
};

FeeAndKitSettingsWidget.prototype.showUnsavedNotify = function () {
    this.cancelButton.removeAttribute("disabled");
    this.saveButton.removeAttribute("disabled");
    Dom.removeClass(this.actionContainer, "HiddenUnsavedNotify");
};

FeeAndKitSettingsWidget.prototype.clearUnsavedNotify = function () {
    this.cancelButton.setAttribute("disabled", true);
    this.saveButton.setAttribute("disabled", true);
    Dom.addClass(this.actionContainer, "HiddenUnsavedNotify");
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/LocationComponent.js";

function LocationComponent() {
    BaseTemplatedWidget.call(this);
    this.domAttached = false;
    this.currentKeyword = "";
    this.bind("click", this.loadDataTable.bind(this, false), this.btnSearch);
    this.bind("keyup", function(event) {
        if (event.keyCode == 13) this.loadDataTable();
    }, this.itemSearchKeyword);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.editLocation.bind(this, []), this.btnAddLocation);
    this.bind("click", this.dataTableClickHandle, this.dataTable);
}
__extend(BaseTemplatedWidget, LocationComponent);

LocationComponent.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        if (thiz.domAttached) return;
        thiz.domAttached = true;
        thiz.setupDataTable();
    }, 100);
}

LocationComponent.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
}

LocationComponent.prototype.onEditDropdownMenuClick = function(event) {
    var thiz = this;
    this.paginator.getSelectedItems(function(items) {
        var ids = items.map(function(pv) {
            return pv.id;
        });
        if (ids.length == 0) return;
        switch (Dom.getAttributeAsString(event.target, "action")) {
            case "edit":
            thiz.editLocation(ids);
            break;
            case "delete":
            thiz.deleteLocation(ids);
            break;
            case "undelete":
            break;
            default:
            break;
        }
        thiz.editDropdownMenu.hide();
    });
}

LocationComponent.prototype.editLocation = function(ids) {
    var thiz = this;
    var editDialog = new LocationEditDialog().callback(function(response) {
        if (response) {
            thiz.loadDataTable(true);
        }
    });
    editDialog.open(ids);
}

LocationComponent.prototype.setupDataTable = function() {
    var thiz = this;
    var colName = new DataTable.GenericColumn("Location", function (data) {
        return "<a class=\"LocationName\">" + data.name + "</a>";
    }).sortable("myname").width("2*");
    colName.getContentTitle = function (data, row, col) {
        return "" + data.name;
    }
    this.dataTable.column(colName);
    var colOptions = new DataTable.PlainTextColumn("Hidden", function (data) {
        return (data.hidden ? "Hidden" : "Show");
    }).sortable("options").width("8em");
    colOptions.getContentTitle = function() { return ""; }
    this.dataTable.column(colOptions);
    this.dataTable.column(new DataTable.PlainTextColumn("Description", function (data) {
        return (data.desc || "");
    }).sortable("descr").width("3*"));
    this.dataTable.selector(true, false);
    this.dataTable.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.dataTable.addListener({
        onSelectionChanged: function (table, fromUserAction) {
            thiz.editDropdownButton.disabled = thiz.dataTable.getSelectedItems().length ? false : true;
        }
    });
    this.dataTable.disabledCheckBoxWhenCheckAll(false);
    this.dataTable.setup();
    this.setupPaginator();
}

LocationComponent.prototype.setupPaginator = function() {
    var thiz = this;

    widget.__ensureNamespaceLoaded("util", function(util) {
        var config = util.paginationUtil.setupPaginatorConfig();

        config.onPageLoaded = function(p, count) {
            util.paginationUtil.setPaginationSummary(thiz.currentPageDetail, p.totalItems, p.currentPage, p.pageSize, count);
        };

        util.paginationUtil.setupPaginatorInstance(thiz.paginator, thiz.dataTable, thiz.createDataSource(), config);
    });
};

LocationComponent.prototype.createDataSource = function() {
    var thiz = this;
    return {
        order: {
            propertyName: "myname",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var order = {
                name: this.order.propertyName,
                asc: this.order.asc,
                ignoreCase: this.order.propertyName == "myname"
            };
            $classMetaService.searchLessonLoc(order, pageIndex, pageSize, thiz.currentKeyword, function(data) {
                thiz.data = data;
                thiz.totalDisplay.textContent = (data.count > 1 ? data.count + " Locations" : data.count + " Location");
                handler(data.result, data.count);
            }, function(error) {
                console.log("Request data error!", error);
            });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
}

LocationComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.refresh();
}

LocationComponent.prototype.deleteLocation = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteLessonLocs(ids, function(deleted) {
                SnackBar.show("" + (deleted ? deleted.length : 0) + " item(s) were deleted");
                if (!deleted || deleted.length < ids.length) {
                    var restList = thiz.dataTable.getSelectedItems().filter(function(item) {
                        return deleted.indexOf(item.id) == -1;
                    });
                    restList = restList.map(function(item) {
                        return item.name;
                    });
                    var message = "\"" + restList.join("\", \"") + (restList.length > 1 ? "\" are being used" : "\" is being used");
                    Dialog.alert("" + restList.length + " item(s) can not delete", message);
                }
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to delete Location item(s) with error:", error);
            });
        },
        "Cancel", null);
}

LocationComponent.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "LocationName")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editLocation([rowData.id]);
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/LocationEditDialog.js";

function LocationEditDialog() {
    ModificationWatchDialog.call(this);
    this.updatedList = [];
    this.current = 0;
    this.hasDataUpdated = false;

    this.territorySelector.comparer = function (a, b) {
        return a === b;
    };
    this.territorySelector.renderer = function (data) {
        return data.name;
    };

    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
}
__extend(ModificationWatchDialog, LocationEditDialog);

LocationEditDialog.prototype.asyncSetup = function (ids, callback) {
    var thiz = this;
    $affiliationService.isFeatureEnabled("TERRITORY", function (enable) {
        thiz.territoryEnable = enable;
        if (enable) {
            $territoryAPIService.getAllTerritories(function (territories) {
                thiz.territories = territories;
                thiz.territorySelector.setItems(territories, "noSelectFirst");
                thiz._setup(ids, callback);
            });
        } else {
            thiz._setup(ids, callback);
        }
    });
};

LocationEditDialog.prototype._setup = function(ids, callback) {
    if (ids && ids.length > 0) {
        this.updatedList = ids;
        this.title = "Edit Location";
        if (ids.length > 1) {
            Dom.addClass(this.indexContainer, "Activate");
        }
        this.current = 0;
        this.loadLocationData(ids[0], callback);
    } else {
        this.title = "Create Location";
        callback();
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemName, "Please input 'Location Name'");

    var requiredAddressInfo = TEAM_INFO.isAffiliateTeam || TEAM_INFO.isOwnershipTeam;
    var requiredTerritory = (TEAM_INFO.isAffiliateTeam || TEAM_INFO.isOwnershipTeam) && this.territories && this.territories.length > 0;
    
    if (requiredAddressInfo) {
        this.validationRules.required(this.itemAddress, "Please input 'Location Address'")
        .required(this.itemCity, "Please input 'Location City'")
        .required(this.itemState, "Please input \'Location State\'")
        this.validationRules.required(this.itemZip, "Please input \'Location Zip\'");
        if (requiredTerritory) {
            this.validationRules.required(this.territorySelector, "Please input 'Territory'");
        }
    }

    Dom.toggleClass(this.itemAddressLabel, "Required", requiredAddressInfo);
    Dom.toggleClass(this.itemCityLabel, "Required", requiredAddressInfo);
    Dom.toggleClass(this.itemStateZipLabel, "Required", requiredAddressInfo);
    Dom.toggleClass(this.territoryLabel, "Required", requiredTerritory);
    Dom.toggleClass(this.territoryWrapper, "Inapplicable", !this.territoryEnable);
}

LocationEditDialog.prototype.onPrevButtonClick = function() {
    if (this.current > 0) {
        this.current --;
        this.loadLocationData(this.updatedList[this.current]);
        if (this.current == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

LocationEditDialog.prototype.onNextButtonClick = function() {
    if (this.current < this.updatedList.length - 1) {
        this.current ++;
        this.loadLocationData(this.updatedList[this.current]);
        if (this.current == this.updatedList.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
}

LocationEditDialog.prototype.loadLocationData = function(id, callback) {
    var thiz = this;
    $classMetaService.getLessonLocById(id, function(data) {
        if (data) {
            thiz.displayIndex.textContent = String.format("Location {0} of {1}", (thiz.current + 1), thiz.updatedList.length);
            thiz.data = data;
            thiz.itemName.value = data.name;
            thiz.itemHidden.checked = data.hidden;
            thiz.itemDesc.value = data.desc;
            thiz.itemAddress.value = data.address || "";
            thiz.itemCity.value = data.city || "";
            thiz.itemState.value = data.state || "";
            thiz.itemZip.value = data.zip || "";
            thiz.itemPhone.value = data.phone || "";
            if (thiz.territories) {
                if (!data.territoryId) {
                    thiz.territorySelector.selectItem();
                    Dom.empty(thiz.territorySelector.buttonDisplay);
                } else {
                    thiz.territorySelector.selectItemById(data.territoryId);
                }
            }
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            thiz.invalidateElements();
        }
        callback && callback();
    }, function(error) {
        Dialog.error(error.message || "Failed to get location!");
    });
}

LocationEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

LocationEditDialog.prototype.getCurrentInputValues = function() {
    return {
        id: this.data ? this.data.id : 0,
        name: this.itemName.value,
        hidden: this.itemHidden.checked,
        desc: this.itemDesc.value,
        address: this.itemAddress.value,
        city: this.itemCity.value,
        state: this.itemState.value,
        zip: this.itemZip.value,
        phone: this.itemPhone.value,
        territoryId: this.territorySelector.getSelectedItem()?.id || null
    }
}

LocationEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var loc = this.getCurrentInputValues();
    if (this.updatedList.length > 0 && loc.id > 0) {
        $classMetaService.updateLessonLoc(loc, function(data) {
            SnackBar.show("Location was saved successfully");
            thiz.hasDataUpdated = true;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            if (callback) callback(loc);
        }, function(error) {
            Dialog.error(error.message || "Failed to update location!");
        });
    } else {
        $classMetaService.createLessonLoc(loc, function(data) {
            SnackBar.show("Location was saved successfully");
            thiz.hasDataUpdated = true;
            loc.id = data;
            if (callback) callback(loc);
        }, function(error) {
            Dialog.error(error.message || "Failed to save location!");
        });
    }
}

LocationEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var shareAction =  {
        type: "extra", title: "Copy Link", icon: "link",
        order: -1,
        isApplicable: function() {
            return thiz.data.shareLink || false;
        },
        run: function () {
            var prefix = window.location.protocol + "//"+ window.location.hostname;
            var shareLink = prefix + (thiz.data.shareLink || "");
            if (!shareLink) return;
            var node = Dom.newDOMElement({
                _name: "input",
                value: shareLink,
                position: -99999
            });
            document.body.appendChild(node);
            node.select();
            var success = document.execCommand("copy");
            document.body.removeChild(node);
            var snackBar = SnackBar.show(success ? "Link Copied to Clipboard!" : "Copy Link was unsuccessfully", null, null, success ? null : "close-box", shareLink);
            Dom.addClass(snackBar.node(), "CustomSnackBar");
            snackBar.node().style.left = Math.round((document.body.offsetWidth - snackBar.node().offsetWidth) / 2) + "px";
            
        }
    }
    var actions = [];
    if (this.data && this.data.id > 0) {
        actions.push(shareAction);
    }
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        var cancelAction = {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.close(this.hasDataUpdated);
                return false;
            }
        };
        actions.push(cancelAction);
        
        return actions;
    }
    actions = actions.concat([
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    if (thiz.updatedList.length < 2) thiz.close(data);
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        }
    ]);
    return actions;
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/MapComponent.js";

function MapComponent() {
    BaseTemplatedWidget.call(this);
    this.domAttached = false;
    this.currentKeyword = "";
    this.bind("click", this.loadDataTable.bind(this, false), this.btnSearch);
    this.bind("keyup", function(event) {
        if (event.keyCode == 13) this.loadDataTable();
    }, this.itemSearchKeyword);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.editMap.bind(this, []), this.btnAddMap);
    this.bind("click", this.dataTableClickHandle, this.dataTable);
}
__extend(BaseTemplatedWidget, MapComponent);

MapComponent.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        if (thiz.domAttached) return;
        thiz.domAttached = true;
        thiz.setupDataTable();
    }, 100);
}

MapComponent.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
}

MapComponent.prototype.onEditDropdownMenuClick = function(event) {
    var thiz = this;
    this.paginator.getSelectedItems(function(items) {
        var ids = items.map(function(pv) {
            return pv.id;
        });
        if (ids.length == 0) return;
        switch (Dom.getAttributeAsString(event.target, "action")) {
            case "edit":
            thiz.editMap(ids);
            break;
            case "delete":
            thiz.deleteMap(ids);
            break;
            case "undelete":
            break;
            default:
            break;
        }
        thiz.editDropdownMenu.hide();
    });
}

MapComponent.prototype.editMap = function(ids) {
    var thiz = this;
    var editDialog = new MapEditDialog().callback(function(response) {
        if (response) {
            thiz.loadDataTable(true);
        }
    });
    editDialog.open(ids);
}

MapComponent.prototype.setupDataTable = function() {
    var thiz = this;
    var colName = new DataTable.GenericColumn("Map", function (data) {
        return "<a class=\"MapName\">" + data.name + "</a>";
    }).sortable("myname").width("1*");
    colName.getContentTitle = function (data, row, col) {
        return "" + data.name;
    }
    this.dataTable.column(colName);
    this.dataTable.column(new DataTable.PlainTextColumn("Phone", function (data) {
        return (data.phone);
    }).sortable("phone").width("1*"));
    this.dataTable.column(new DataTable.PlainTextColumn("Address", function (data) {
        return (data.fullAddress);
    }).sortable("address").width("2*"));
    this.dataTable.selector(true, false);
    this.dataTable.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.dataTable.addListener({
        onSelectionChanged: function (table, fromUserAction) {
            thiz.editDropdownButton.disabled = thiz.dataTable.getSelectedItems().length ? false : true;
        }
    });
    this.dataTable.disabledCheckBoxWhenCheckAll(false);
    this.setupPaginator();
    this.dataTable.setup();
}

MapComponent.prototype.setupPaginator = function() {
    var thiz = this;
    this.paginator.setup({
        getTotalItemText: function(total) {
            return "Total " + total;
        },
        showPaginator: true,
        withoutStatus: true,
        onPageLoaded: function (p, count) {
            var start = p.currentPage * p.pageSize + 1;
            var end = start + count - 1;
            Dom.setInnerText(thiz.currentPageDetail, String.format("Showing items {0}-{1} of {2}", start, end, p.totalItems));
        },
        comparer: function (a, b) {
            return a.id == b.id;
        },
        useButtons: false,
        avoidPageSizeRecalculation: true
    });
    this.paginator.pageSize = 20;
    this.paginator.needCalculatePageSize = function () { return false; };
    this.paginator.control(this.dataTable);
    this.paginator.setSource(this.createDataSource());
}

MapComponent.prototype.createDataSource = function() {
    var thiz = this;
    return {
        order: {
            propertyName: "myname",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var order = {
                name: this.order.propertyName,
                asc: this.order.asc,
                ignoreCase: true
            };
            $classMetaService.searchLessonMap(order, pageIndex, pageSize, thiz.currentKeyword, function(data) {
                thiz.data = data;
                thiz.totalDisplay.textContent = (data.count > 1 ? data.count + " Maps" : data.count + " Map");
                handler(data.result, data.count);
            }, function(error) {
                console.log("Request data error!", error);
            });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
}

MapComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.refresh();
}

MapComponent.prototype.deleteMap = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteLessonMaps(ids, function(deleted) {
                SnackBar.show("" + (deleted ? deleted.length : 0) + " item(s) were deleted");
                if (!deleted || deleted.length < ids.length) {
                    var restList = thiz.dataTable.getSelectedItems().filter(function(item) {
                        return deleted.indexOf(item.id) == -1;
                    });
                    restList = restList.map(function(item) {
                        return item.name;
                    });
                    var message = "\"" + restList.join("\", \"") + (restList.length > 1 ? "\" are being used" : "\" is being used");
                    Dialog.alert("" + restList.length + " item(s) can not delete", message);
                }
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to delete Map item(s) with error:", error);
            });
        },
        "Cancel", null);
}

MapComponent.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "MapName")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editMap([rowData.id]);
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/MapEditDialog.js";

function MapEditDialog() {
    ModificationWatchDialog.call(this);
    this.updatedList = [];
    this.current = 0;
    this.hasDataUpdated = false;
    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
}
__extend(ModificationWatchDialog, MapEditDialog);

MapEditDialog.prototype.setup = function(ids) {
    if (ids && ids.length > 0) {
        this.updatedList = ids;
        this.title = "Edit Map";
        if (ids.length > 1) {
            Dom.addClass(this.indexContainer, "Activate");
        }
        this.current = 0;
        this.loadMapData(ids[0]);
    } else {
        this.title = "Create Map";
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemName, "Please input 'Map Name'")
        .required(this.itemAddress, "Please input 'Map Address'")
        .required(this.itemCity, "Please input 'Map City'")
        .required(this.itemState, "Please input \'Map State\'")
        .required(this.itemZip, "Please input \'Map Zip\'");
}

MapEditDialog.prototype.onPrevButtonClick = function() {
    if (this.current > 0) {
        this.current --;
        this.loadMapData(this.updatedList[this.current]);
        if (this.current == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

MapEditDialog.prototype.onNextButtonClick = function() {
    if (this.current < this.updatedList.length - 1) {
        this.current ++;
        this.loadMapData(this.updatedList[this.current]);
        if (this.current == this.updatedList.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
}

MapEditDialog.prototype.loadMapData = function(id) {
    var thiz = this;
    $classMetaService.getLessonMapById(id, function(data) {
        if (data) {
            thiz.displayIndex.textContent = String.format("Map {0} of {1}", (thiz.current + 1), thiz.updatedList.length);
            thiz.data = data;
            thiz.itemName.value = data.name;
            // thiz.itemHidden.checked = data.hidden;
            thiz.itemAddress.value = data.address;
            thiz.itemCity.value = data.city;
            thiz.itemState.value = data.state;
            thiz.itemZip.value = data.zip;
            thiz.itemPhone.value = data.phone;
            thiz.itemDesc.value = data.desc;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
        }
    }, function(error) {
        console.log("Fail to get Map: ", error);
    });
}

MapEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

MapEditDialog.prototype.getCurrentInputValues = function() {
    return {
        id: this.data ? this.data.id : 0,
        name: this.itemName.value,
        // hidden: this.itemHidden.checked,
        address: this.itemAddress.value,
        city: this.itemCity.value,
        state: this.itemState.value,
        zip: this.itemZip.value,
        phone: this.itemPhone.value,
        desc: this.itemDesc.value
    }
}

MapEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var map = this.getCurrentInputValues();
    if (this.updatedList.length > 0 && map.id > 0) {
        $classMetaService.updateLessonMap(map, function(data) {
            SnackBar.show("Map was saved successfully");
            thiz.hasDataUpdated = true;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            if (callback) callback(map);
        }, function(error) {
            console.log("fail to save lesson Map with error", error);
        });
    } else {
        $classMetaService.createLessonMap(map, function(id) {
            SnackBar.show("Map was saved successfully");
            thiz.hasDataUpdated = true;
            map.id = id;
            if (callback) callback(map);
        }, function(error) {
            console.log("Fail to save lesson Map with error", error);
        });
    }
}

MapEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.close(this.hasDataUpdated);
                return false;
            }
        }];
    }
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    if (thiz.updatedList.length < 2) thiz.close(data);
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        }
    ]
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/MembershipClassesComponent.js";

function MembershipClassesComponent(opts) {
    BaseTemplatedWidget.call(this);
    this.options = opts;
    this.bind("click", this.onTabPaneClick, this.tabControl);
    this.install();
    this.activeTabById(this.options.subTab ? this.options.subTab : "program");
}
__extend(BaseTemplatedWidget, MembershipClassesComponent);

MembershipClassesComponent.prototype.install = function() {
    Dom.empty(this.tabControl);
    this.register({
        id: "program",
        title: "Program",
        implementation: ProgramComponent
    });
    this.register({
        id: "subprogram",
        title: "Sub Program",
        implementation: SubProgramComponent
    });
    // this.register({
    //     id: "subprogramBK",
    //     title: "Sub Program BK",
    //     implementation: SubProgramComponentBK
    // });
    this.register({
        id: "session",
        title: "Session",
        implementation: SessionComponent
    });
    this.register({
        id: "zone",
        title: "Zone",
        implementation: ZoneComponent
    });
    this.register({
        id: "skills",
        title: "Skills",
        implementation: SkillsComponent
    });
    this.register({
        id: "location",
        title: "Location",
        implementation: LocationComponent
    });
    this.register({
        id: "map",
        title: "Map",
        implementation: MapComponent
    });
}

MembershipClassesComponent.prototype.onTabPaneClick = function(event) {
    var tabId = Dom.getAttributeAsString(event.target, "tab-id");
    this.options.subTab = tabId;
    // window.location.hash = this.getHashFromTab();
    window.history.pushState(tabId, document.title, "#/membership/classes/" + tabId);
    this.activeTabById(tabId);
}

MembershipClassesComponent.prototype.activeTabById = function(tabId) {
    if (this[tabId]) {
        var node = this[tabId].__node;
        if (this.currentActiveTab) {
            if (this.currentActiveTab.data.id == tabId) return;
            Dom.removeClass(this.currentActiveTab.__node, "Active");
        }
        var f = this[tabId].data.implementation;
        if (typeof(f) == "function") {
            f = new f();
            Dom.empty(this.pageContentWrapper);
            f.into(this.pageContentWrapper);
            Dom.addClass(node, "Active");
            this.currentActiveTab = this[tabId];
        }
    }
}

MembershipClassesComponent.prototype.register = function(data) {
    var node = this._createTabPane(data);
    this[data.id] = {
        data: data,
        __node: node
    };
    this.tabControl.appendChild(node);
}

MembershipClassesComponent.prototype._createTabPane = function(data) {
    var node = Dom.newDOMElement({
        _name: "li",
        _text: data.title,
        class: "TabItem",
        "tab-id": data.id
    });
    return node;
}

MembershipClassesComponent.prototype.getHashFromTab = function(){
    return "/membership/classes/" + this.options.subTab;
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/MembershipWaiversComponent.js";

function MembershipWaiversComponent() {
    ModificationWatchDialog.call(this);
    this.bind("p:ItemSelected", this.onOptionChange.bind(this, this.selectEnable1), this.selectEnable1);
    this.bind("p:ItemSelected", this.onOptionChange.bind(this, this.selectEnable2), this.selectEnable2);
    this.bind("p:ItemSelected", this.onOptionChange.bind(this, this.selectEnable3), this.selectEnable3);
    this.bind("p:ItemSelected", this.onOptionChange.bind(this, this.selectEnable4), this.selectEnable4);
    this.bind("p:ItemSelected", this.onOptionChange.bind(this, this.selectEnable5), this.selectEnable5);
    this.richTextCounterLoaded = 0;
    this.itemTitleMessage.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemTitleMessage);
    this.itemAgmtMessage1.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemAgmtMessage1);
    this.itemAgmtMessage2.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemAgmtMessage2);
    this.itemAgmtMessage3.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemAgmtMessage3);
    this.itemAgmtMessage4.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemAgmtMessage4);
    this.itemAgmtMessage5.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemAgmtMessage5);
    this.itemSuccessMessage.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemSuccessMessage);
    this.itemPromoMessage.updateScrolling = function() {};
    this.bind(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.invalidateDomContentLoaded.bind(this), this.itemPromoMessage);
    
    this.bind("e:TabChange", function (event) {
        event.stopPropagation();
    }, this.waiverTabControl.node());
    
}
__extend(ModificationWatchDialog, MembershipWaiversComponent);

MembershipWaiversComponent.valueTitleComparer = function(selected, item) {
    return selected.value == item.value;
};
MembershipWaiversComponent.valueTitleRenderer = function(item) {
    return item.title;
};
MembershipWaiversComponent.EnableOptions = [{value: 0, title: "NO - Disabled"}, {value: 1, title: "YES"}];
MembershipWaiversComponent.AgreementTypes = [{value: 0, title: "Optional"}, {value: 1, title: "Required"}];

MembershipWaiversComponent.prototype.init = function() {
    this.selectEnable1.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectEnable1.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectType1.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectType1.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectEnable2.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectEnable2.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectType2.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectType2.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectEnable3.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectEnable3.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectType3.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectType3.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectEnable4.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectEnable4.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectType4.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectType4.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectEnable5.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectEnable5.comparer = MembershipWaiversComponent.valueTitleComparer;
    this.selectType5.renderer = MembershipWaiversComponent.valueTitleRenderer;
    this.selectType5.comparer = MembershipWaiversComponent.valueTitleComparer;

    this.selectEnable1.setItems(MembershipWaiversComponent.EnableOptions);
    this.selectType1.setItems(MembershipWaiversComponent.AgreementTypes);
    this.selectEnable2.setItems(MembershipWaiversComponent.EnableOptions);
    this.selectType2.setItems(MembershipWaiversComponent.AgreementTypes);
    this.selectEnable3.setItems(MembershipWaiversComponent.EnableOptions);
    this.selectType3.setItems(MembershipWaiversComponent.AgreementTypes);
    this.selectEnable4.setItems(MembershipWaiversComponent.EnableOptions);
    this.selectType4.setItems(MembershipWaiversComponent.AgreementTypes);
    this.selectEnable5.setItems(MembershipWaiversComponent.EnableOptions);
    this.selectType5.setItems(MembershipWaiversComponent.AgreementTypes);
};

MembershipWaiversComponent.prototype.setup = function() {
    // this.requestWaiverData();
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemAgmtTitle1, "Please input Agreement title", Condition.hasKeySelected(this.selectEnable1, "value", 1))
        .required(this.itemAgmtMessage1, "Please input Argreement message", Condition.hasKeySelected(this.selectEnable1, "value", 1))
        .required(this.itemAgmtTitle2, "Please input Agreement title", Condition.hasKeySelected(this.selectEnable2, "value", 1))
        .required(this.itemAgmtMessage2, "Please input Argreement message", Condition.hasKeySelected(this.selectEnable2, "value", 1))
        .required(this.itemAgmtTitle3, "Please input Agreement title", Condition.hasKeySelected(this.selectEnable3, "value", 1))
        .required(this.itemAgmtMessage3, "Please input Argreement message", Condition.hasKeySelected(this.selectEnable3, "value", 1))
        .required(this.itemAgmtTitle4, "Please input Agreement title", Condition.hasKeySelected(this.selectEnable4, "value", 1))
        .required(this.itemAgmtMessage4, "Please input Argreement message", Condition.hasKeySelected(this.selectEnable4, "value", 1))
        .required(this.itemAgmtTitle5, "Please input Agreement title", Condition.hasKeySelected(this.selectEnable5, "value", 1))
        .required(this.itemAgmtMessage5, "Please input Argreement message", Condition.hasKeySelected(this.selectEnable5, "value", 1));
};

MembershipWaiversComponent.prototype.invalidateDomContentLoaded = function() {
    this.richTextCounterLoaded++;
    if (this.richTextCounterLoaded >= 8) {
        this.waiverTabControl.ensureSizing();
        this.init();
        this.requestWaiverData();
    }
};

MembershipWaiversComponent.prototype.onOptionChange = function(item) {
    var value = item.getSelectedItem().value;
    var target = item.node().parentElement.nextElementSibling;
    if (value == 0) {
        Dom.removeClass(target, "Activated");
    } else {
        Dom.addClass(target, "Activated");
    }
};

MembershipWaiversComponent.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES.concat(RichTextEditor.TEXT_CHANGE_EVENT_NAME);
};

MembershipWaiversComponent.prototype.requestWaiverData = function() {
    var thiz = this;
    $classMetaService.getWaiver(function(data) {
        thiz.data = data;
        thiz.selectEnable1.selectItem(data.agree1Title.trim().length > 0 ? MembershipWaiversComponent.EnableOptions[1] : MembershipWaiversComponent.EnableOptions[0]);
        thiz.selectType1.selectItem(MembershipWaiversComponent.AgreementTypes[data.agree1Optional]);
        thiz.selectEnable2.selectItem(data.agree2Title.trim().length > 0 ? MembershipWaiversComponent.EnableOptions[1] : MembershipWaiversComponent.EnableOptions[0]);
        thiz.selectType2.selectItem(MembershipWaiversComponent.AgreementTypes[data.agree2Optional]);
        thiz.selectEnable3.selectItem(data.agree3Title.trim().length > 0 ? MembershipWaiversComponent.EnableOptions[1] : MembershipWaiversComponent.EnableOptions[0]);
        thiz.selectType3.selectItem(MembershipWaiversComponent.AgreementTypes[data.agree3Optional]);
        thiz.selectEnable4.selectItem(data.agree4Title.trim().length > 0 ? MembershipWaiversComponent.EnableOptions[1] : MembershipWaiversComponent.EnableOptions[0]);
        thiz.selectType4.selectItem(MembershipWaiversComponent.AgreementTypes[data.agree4Optional]);
        thiz.selectEnable5.selectItem(data.agree5Title.trim().length > 0 ? MembershipWaiversComponent.EnableOptions[1] : MembershipWaiversComponent.EnableOptions[0]);
        thiz.selectType5.selectItem(MembershipWaiversComponent.AgreementTypes[data.agree5Optional]);
        thiz.itemTitleMessage.setContent(data.titleMessage);
        thiz.itemAgmtTitle1.value = data.agree1Title;
        thiz.itemAgmtMessage1.setContent(data.agree1Message);
        thiz.itemAgmtTitle2.value = data.agree2Title;
        thiz.itemAgmtMessage2.setContent(data.agree2Message);
        thiz.itemAgmtTitle3.value = data.agree3Title;
        thiz.itemAgmtMessage3.setContent(data.agree3Message);
        thiz.itemAgmtTitle4.value = data.agree4Title;
        thiz.itemAgmtMessage4.setContent(data.agree4Message);
        thiz.itemAgmtTitle5.value = data.agree5Title;
        thiz.itemAgmtMessage5.setContent(data.agree5Message);
        thiz.itemSuccessTitle.value = data.successTitle;
        thiz.itemSuccessMessage.setContent(data.successMessage);
        thiz.itemPromoMessage.setContent(data.promoMessage);
        thiz.waiverTabControl.ensureSizing();
        setTimeout(function() {
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
        }, 100);
    }, function(error) {
        console.error("Fail to get Waiver Data with error:", error);
    });
};

MembershipWaiversComponent.prototype.getFormData = function() {
    return {
        titleMessage: this.itemTitleMessage.getContent(),
        agree1Title: (this.selectEnable1.getSelectedItem().value == 1 ? this.itemAgmtTitle1.value : ""),
        agree1Optional: this.selectType1.getSelectedItem().value,
        agree1Message: this.itemAgmtMessage1.getContent(),
        agree2Title: (this.selectEnable2.getSelectedItem().value == 1 ? this.itemAgmtTitle2.value : ""),
        agree2Optional: this.selectType2.getSelectedItem().value,
        agree2Message: this.itemAgmtMessage2.getContent(),
        agree3Title: (this.selectEnable3.getSelectedItem().value == 1 ? this.itemAgmtTitle3.value : ""),
        agree3Optional: this.selectType3.getSelectedItem().value,
        agree3Message: this.itemAgmtMessage3.getContent(),
        agree4Title: (this.selectEnable4.getSelectedItem().value == 1 ? this.itemAgmtTitle4.value : ""),
        agree4Optional: this.selectType4.getSelectedItem().value,
        agree4Message: this.itemAgmtMessage4.getContent(),
        agree5Title: (this.selectEnable5.getSelectedItem().value == 1 ? this.itemAgmtTitle5.value : ""),
        agree5Optional: this.selectType5.getSelectedItem().value,
        agree5Message: this.itemAgmtMessage5.getContent(),
        successTitle: this.itemSuccessTitle.value,
        successMessage: this.itemSuccessMessage.getContent(),
        promoMessage: this.itemPromoMessage.getContent()
    };
};

MembershipWaiversComponent.prototype.getCurrentInputValues = function() {
    var data = this.getFormData();
    data.agree1_enable = this.selectEnable1.getSelectedItem().value;
    data.agree2_enable = this.selectEnable2.getSelectedItem().value;
    data.agree3_enable = this.selectEnable3.getSelectedItem().value;
    data.agree4_enable = this.selectEnable4.getSelectedItem().value;
    data.agree5_enable = this.selectEnable5.getSelectedItem().value;
    return data;
};

MembershipWaiversComponent.prototype.save = function() {
    if (!ValidationManager.run(this.validationRules)) return;
    var thiz = this;
    $classMetaService.updateWaiver(this.getFormData(), function() {
        SnackBar.show("Data was saved successfully");
        thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
        thiz.clearUnsavedNotify();
    },
    function(error) {
        console.error("Fail to update Waiver data with error:", error);
    });
};

MembershipWaiversComponent.prototype.close = function(data) {
    if (this.hasInputValuesChanged()) {
        this.requestWaiverData();
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/ProgramComponent.js";

function ProgramComponent(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.dataListSource = {
        order: {
            propertyName: "title",
            asc: true
        },
        terms: "",
        loadPage: function (pageIndex, pageSize, handler, failed) {
            $classMetaService.getPrograms(this.terms, pageIndex * pageSize, pageSize,
                {name: this.order.propertyName, asc: this.order.asc, ignoreCase: checkIgnoreCaseProperty(this.order.propertyName)}, function (list) {
                if(list.count > 1) {
                    thiz.totalProgram.innerHTML = list.count + " Programs";
                } else {
                    thiz.totalProgram.innerHTML = list.count + " Program";
                }
                handler(list.result, list.count);
            }, failed);
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };

    function checkIgnoreCaseProperty(propertyName) {
        return propertyName == "title" || propertyName == "descr";
    }

    this.initializeDataTable();

    Dom.registerEvent(this.searchText, "input", this.searchTextInputHandler.bind(this), true);
    this.bind("click", function () {
        if(thiz.dataListSource.terms == thiz.searchText.value) return;
        thiz.dataListSource.terms = thiz.searchText.value;
        thiz.paginator.refresh();
    }, this.searchButton);

    this.bind("click", this.addProgramButtonClickHandler, this.addProgramButton);
    this.bind("click", this.dataTableClickHandler, this.dataTable.node());
    this.bind("click", this.editDropdownButtonHandler, this.editDropdownButton);
    this.bind("click", this.editProgramActionClickHandler, this.editProgramAction);
    this.bind("click", this.deleteProgramActionClickHandler, this.deleteProgramAction);
    this.bind("click", this.editDisplayOrderButtonClickedHandler, this.editDisplayOrderButton);

    this.dataTable.addListener({
        onSelectionChanged: function() {
            if(thiz.dataTable.getSelectedItems().length > 0) {
                thiz.editDropdownButton.removeAttribute("disabled");
            } else {
                thiz.editDropdownButton.setAttribute("disabled", "disabled");
            }
        }
    });
    Dom.toggleClass(this.container, "Editable", this.canViewCreateEditProgram());
    if (!this.canDeleteProgram()) {
        Dom.hide(this.deleteProgramAction);
    }
}

__extend(BaseTemplatedWidget, ProgramComponent);

ProgramComponent.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        thiz.onAttachedDelayed();
    }, 10);
};
ProgramComponent.prototype.onAttachedDelayed = function() {
    var thiz = this;
    this.dataTable.setup();

    widget.__ensureNamespaceLoaded("util", function(util) {
        var config = util.paginationUtil.setupPaginatorConfig();

        config.onPageLoaded = function(p, count) {
            thiz.refreshedAt = new Date().getTime();
            util.paginationUtil.setPaginationSummary(thiz.contentDescription, p.totalItems, p.currentPage, p.pageSize, count);
        };

        util.paginationUtil.setupPaginatorInstance(thiz.paginator, thiz.dataTable, thiz.dataListSource, config);
    });
};

ProgramComponent.prototype.initializeDataTable = function () {
    var programNameColumn = new DataTable.GenericColumn("Program Name", function (data) {
        var backgroundCss = "";
        if(data.titleBgColor &&  data.titleBgColor.length > 0) backgroundCss = 'style="background: #' + data.titleBgColor + ';"';

        var programNameHtml = '<hbox>' +
                                  (backgroundCss.length > 0 ? '<span class="program-color"' + backgroundCss + '></span>' : '') +
                                  '<span flex="1" class="program-name">' + data.title + '</span>' +
                              '</hbox>';
        if(data.thumbnailFilePath && data.thumbnailFilePath.length > 0) {
            programNameHtml += '<div class="program-image"><img src="' + data.thumbnailFilePath + '"/></div>';
        }
        return programNameHtml;
    }).sortable("title").width("1*");
    programNameColumn.getTitleInfo = function() {
        return "Program Name";
    };
    programNameColumn.getContentTitle = function (data, row, col) {
        return "" + data.title;
    };
    this.dataTable.column(programNameColumn);

    var subProgramNameColumn = new DataTable.GenericColumn("Sub Programs", function (data) {
        var subProgramHtml = "";
        for(var i = 0; i < data.subPrograms.length; i ++) {
            subProgramHtml += '<div title="' + data.subPrograms[i].title + '">' + data.subPrograms[i].title + '</div>';
        }
        return subProgramHtml;
    }).width("1*");
    subProgramNameColumn.getContentTitle = function (data, row, col) {
        return "";
    };
    this.dataTable.column(subProgramNameColumn);

    var desciptionColumn = new DataTable.DomNodeColumn("Program Description", function (data) {
        var descr = "" + data.descriptionHtml
        if(descr.length > 200) {
            descr = descr.substring(0, 200) + "...";
        }
        return Dom.newDOMElement({
            _name: "div",
            _html: descr
        });
    }).sortable("descr").width("1*");
    desciptionColumn.getContentTitle = function (data, row, col) {
        return "";
    };
    this.dataTable.column(desciptionColumn);
    if (this.canViewCreateEditProgram()) {
        this.dataTable.selector(true, false);
        this.dataTable.disabledCheckBoxWhenCheckAll(false);
    }
    this.dataTable.setDefaultSelectionHandler({
        run: function (item) {
        }
    });
    this.dataTable.useFloatingHeader = true;
};

ProgramComponent.prototype.searchTextInputHandler = function () {
    var thiz = this;
    if(this.inputingSearchTextTimeout) {
        clearTimeout(this.inputingSearchTextTimeout);
    }
    this.inputingSearchTextTimeout = window.setTimeout(function() {
        thiz.dataListSource.terms = thiz.searchText.value;
        thiz.paginator.refresh();
    }, 200);
};

ProgramComponent.prototype.addProgramButtonClickHandler = function () {
    var thiz = this;
    new ProgramEditDialog().callback(function(programData) {
        if(!programData) return;
        $classMetaService.saveProgram(programData, function(res) {
            thiz.paginator.refresh();
        }, function(err) {});
    }).open({programId: 0});
};

ProgramComponent.prototype.dataTableClickHandler = function (e) {
    var thiz = this;
    var colProgramDescription = Dom.findParentWithClass(e.target, "Col_program_description");
    var itemData = DataTable.getRowData(e.target);
    if(colProgramDescription && itemData && itemData.descriptionHtml && itemData.descriptionHtml.length > 0) {
        this.descriptionPopupContent.innerHTML = itemData.descriptionHtml;
        this.descriptionPopup.show(colProgramDescription, "left-inside", "center", 0, 10, true);
    } else if(Dom.hasClass(e.target, "program-name") && itemData) {
        new ProgramEditDialog().callback(function(programData) {
            if(!programData) return;
            $classMetaService.saveProgram(programData, function(res) {
                thiz.paginator.refresh();
            }, function(err) {});
        }).open({ids: [itemData.id]});
    }

};

ProgramComponent.prototype.editDropdownButtonHandler = function (e) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
};

ProgramComponent.prototype.editProgramActionClickHandler = function () {
    var thiz = this;
    this.editDropdownMenu.hide();
    this.paginator.getSelectedItems(function(selectedItems) {
        if(!selectedItems) return;
        var ids = [];
        for(var i = 0; i < selectedItems.length; i ++) {
            ids.push(selectedItems[i].id);
        }
        if(ids.length == 0) return;
        new ProgramEditDialog().callback(function(programData) {
            if(!programData) return;
            $classMetaService.saveProgram(programData, function(res) {
                thiz.paginator.refresh();
            }, function(err) {});
        }).open({ids: ids});
    });
};

ProgramComponent.prototype.deleteProgramActionClickHandler = function () {
    var thiz = this;
    this.editDropdownMenu.hide();
    this.paginator.getSelectedItems(function(items) {

        var ids = [], itemNotDeletable = "", cannotDeleteCount = 0;
        for(var i = 0; i < items.length; i ++) {
            if(!items[i].deletable) {
                itemNotDeletable += ((itemNotDeletable? ", " : "") + ("\"" + items[i].title + "\""));
                cannotDeleteCount++;
            }
            ids.push(items[i].id);
        }
        if(itemNotDeletable) {
            var names = ["classes"];
            if (AdminConsole.instance.isFeatureEnable("bookings")) {
                names.push("bookings");
            }
            var namesText = names.join("/");
            var str = (cannotDeleteCount > 1)? "Cannot delete " + itemNotDeletable + " because they are currently used in existing " + namesText :
                "Cannot delete " + itemNotDeletable + " because it is currently used in existing " + namesText ;
            Dialog.error("", str, null);
            return;
        }
        if(ids.length == 0) return;

        Dialog.confirm("Are you sure you want to delete selected item(s)?", "", "Delete", function() {
            var busyIndicator = new Spinner("Loading...");
            busyIndicator.busy();

            $classMetaService.deleteProgramsAsync(ids, function (jobId) {
                thiz._onJobExecuted(jobId, function (data) {
                    thiz.paginator.refresh();
                    busyIndicator.done();
                }, function (error) {
                    busyIndicator.done();
                    Dialog.error(error.message || "Error when deleting programs");
                })
            }, function(err) {
                busyIndicator.done();
                Dialog.error(err.message);
            });
        }, "Cancel");
    });
};

ProgramComponent.prototype.editDisplayOrderButtonClickedHandler = function () {
    new EditDisplayOrderDialog().open();
};

ProgramComponent.prototype.canViewCreateEditProgram = function () {
    return ClassAuthUtils.canViewCreateEditProgram(ACCOUNT_INFO);
};

ProgramComponent.prototype.canDeleteProgram = function () {
    return ClassAuthUtils.canManageProgram(ACCOUNT_INFO);
};

ProgramComponent.prototype._onJobExecuted = function(jobId, onSuccess, onError) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var firstTime = true;

    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                firstTime = false;
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        onError({message: job.errorMessage});
                    }
                } else {
                    onError({message: "Job not found."});
                }
            }, function (error) {
                onError(error);
            });
        }, firstTime ? 150 : 500);
    })();
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/ProgramEditDialog.js";

function ProgramEditDialog() {
    ModificationWatchDialog.call(this);
    this.bind("click", this.indexActionNextClickHandler, this.indexActionNext);
    this.bind("click", this.indexActionPrevClickHandler, this.indexActionPrev);
    
}
__extend(ModificationWatchDialog, ProgramEditDialog);

ProgramEditDialog.prototype.setup = function(options) {
    this.options = options;
    this.programIdIndex = 0;
    
    
    this.validationRules = new RuleSet().live(true)
        .required(this.programTitle, String.format("[{0}] is a required field; please enter the correct value.", "Program Name"));
        
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
        this.renderProgramEditDialog(this.options.ids, this.programIdIndex);
    } else {
        $classAdminService.getAccountInfo(function (res) {
            window.LOGIN_INFO.classRegistrationLink = res.classRegistrationLink;
            thiz.renderProgramEditDialog(thiz.options.ids, thiz.programIdIndex);
        }, function (err) {});
    }    
    Dom.toggleClass(this.container, "Editable", ClassAuthUtils.canViewCreateEditProgram(ACCOUNT_INFO));
};

ProgramEditDialog.prototype.getChangeEventNames = function () {
    if (!ClassAuthUtils.canViewCreateEditProgram(ACCOUNT_INFO)) return [];
    return [FileUploadView.FILE_CHANGE_EVENT_NAME, RichTextEditor.TEXT_CHANGE_EVENT_NAME].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES);
};

ProgramEditDialog.prototype.renderProgramEditDialog = function (ids, idIndex) {
    var thiz = this;
    if(ids && ids.length > 0) {
        var editable = ClassAuthUtils.canViewCreateEditProgram(ACCOUNT_INFO);
        if (!editable) {
            var disabledFunc = function(node) {
                Dom.setEnabled(false, node);
            };
            Dom.doOnSelector(this.dialogBody, "input", disabledFunc);
            Dom.doOnSelector(this.dialogBody, "button", disabledFunc);
            this.description.setReadOnly(true);
        }
        this.title = editable ? "Edit Program" : "Program Details";
        if(ids.length > 1) {
            this.editProgramIndex.innerHTML = "Program " + (this.programIdIndex + 1) + " of " + this.options.ids.length;
        } else {
            this.indexAction.parentNode.removeChild(this.indexAction);
        }
        if(this.programIdIndex == 0) {
            Dom.addClass(this.indexActionPrev, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionPrev, "action-disabled");
        }
        if(this.programIdIndex == ids.length - 1) {
            Dom.addClass(this.indexActionNext, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionNext, "action-disabled");
        }
    } else {
        this.title = "Add Program";
        this.indexAction.parentNode.removeChild(this.indexAction);
    }
    this.programImageFileUploadView.dataType = "__lesson__";
    this.programImageFileUploadView.dataUUID = "prog";
    this.programColor.setColor("#000000");
    
    if(!this.options.ids) return;
    if(this.options.ids.length <= 0) return;
    
    $classMetaService.getProgramById(this.options.ids[this.programIdIndex], function(res) {
        thiz.programData = res;
        thiz.programTitle.value = thiz.programData.title;
        thiz.description.setContent(thiz.programData.descriptionHtml);
        thiz.programColor.setColor("#" + thiz.programData.titleBgColor);
        var previewWrappers = thiz.programImageFileUploadView.node().getElementsByClassName("PreviewWrapper");
        if(previewWrappers && previewWrappers.length > 0) {
            for(var i = 0; i < previewWrappers.length; i ++) {
                previewWrappers[i].parentNode.removeChild(previewWrappers[i]);
            }
        }
        thiz.programImageFileUploadView.setCommaSeparatedStoragePaths("");
        if(thiz.programData.thumbnailFilePath && thiz.programData.thumbnailFilePath.length > 0) {
            var thumbnailFilePath = thiz.programData.thumbnailFilePath;
            thumbnailFilePath = thumbnailFilePath.substring(0, thumbnailFilePath.lastIndexOf("?"));
            thiz.programImageFileUploadView.setCommaSeparatedStoragePaths(thumbnailFilePath);
        }
    }, function(err) {});
};

ProgramEditDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var actions = [];
    var body = document.getElementsByTagName("body")[0];
    if (this.options.ids && this.options.ids[this.programIdIndex]) {
/*        
        actions.push({
            type: "accept", title: "Go To Class Reg Inventory",
            isApplicable: function () {
                return true;
            },
            order: -1,
            run: function () {
                var shoppingCartEnable = AdminConsole.instance.isTeamFeatureModuleEnable("shoppingcart");
                if (shoppingCartEnable) {
                    window.open(window.LOGIN_INFO.classRegShoppingLink + "?progId=" + thiz.options.ids[thiz.programIdIndex], "_blank");
                } else {
                    if (body && Dom.hasClass(body, "ClassicLayout")) {
                        window.open("ClassReg.jsp?team=" + TEAM_INFO.alias + "&progId=" + thiz.options.ids[thiz.programIdIndex], "_blank");
                    } else {
                        window.open(window.LOGIN_INFO.classRegistrationLink + "?progId=" + thiz.options.ids[thiz.programIdIndex], "_blank");
                    }
                }
            }
        });
*/        
        actions.push({
            type: "extra", title: "Share", icon: "share",
            order: -3,
            run: function () {
                new ShareClassDialog().open({type: "Program", name: thiz.programData.title, data: {progId: thiz.programData.id}});
            }
        });
    }
    if (this.modified) {
        actions.push({
            type: "accept", title: "Save",
            run: function () {
                thiz.saveProgram();
            }
        });
        actions.push({
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        });
    } else {
        actions.push({
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {return true;}
        });
    }
    return actions;
};
ProgramEditDialog.prototype.saveProgram = function() {
    if(!ValidationManager.run(this.validationRules)) return false;
    // if(!this.validateFormData()) {
    //     return;
    // }
    var thiz = this;
    var filePath = this.programImageFileUploadView.getCommaSeparatedStoragePaths();
    var data = {
        id: (this.programData && this.programData.id) ? this.programData.id : -1,
        title: this.programTitle.value,
        titleBgColor: this.programColor.getRGBColorString().replace("#", ""),
        descriptionHtml: this.description.getContent(),
        thumbnailFilePath: filePath
    };
    thiz.close(data);
};

// ProgramEditDialog.prototype.validateFormData = function () {
//     if(this.programTitle.value.trim().length <= 0) {
//         Dialog.error(String.format("[{0}] is a required field; please enter the correct value.", "Program Name"), "", function() {});
//         return false;
//     }
//     return true;
// };

ProgramEditDialog.prototype.indexActionNextClickHandler = function () {
    if(this.programIdIndex == this.options.ids.length - 1) return;
    this.programIdIndex ++;
    this.renderProgramEditDialog(this.options.ids, this.programIdIndex);
    
};

ProgramEditDialog.prototype.indexActionPrevClickHandler = function () {
    if(this.programIdIndex == 0) return;
    this.programIdIndex --;
    this.renderProgramEditDialog(this.options.ids, this.programIdIndex);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/RatePlanDialog.js";

function RatePlanDialog() {
    Dialog.call(this);
}
__extend(Dialog, RatePlanDialog);

RatePlanDialog.prototype.asyncSetup = function (ratePlan, dialogCallback) {
    if (!ratePlan) return;
    this.ratePlan = ratePlan;
    if (ratePlan.id > 0) {
        this.title = "Edit Rate Plan";
        $classBillByHourService.getRatePlan(ratePlan.id, function (res) {
            this.ratePlanWidget = new RatePlanWidget(res).into(this.ratePlanContent);
            dialogCallback();
        }.bind(this), function (error) {
            dialogCallback();
            Dialog.error(error.message);
        });
    } else {
        this.title = "Add Rate Plan";
        this.ratePlanWidget = new RatePlanWidget(ratePlan).into(this.ratePlanContent);
        dialogCallback();
    }
};

RatePlanDialog.prototype.saveRatePlan = function () {
    if (this.savingRatePlan) return;
    var thiz = this;
    if (!this.ratePlanWidget) return;
    if (!this.ratePlanWidget.isRatePlanInputValid()) return;
    var ratePlan = this.ratePlanWidget.getRatePlanValues();
    ratePlan.id = this.ratePlan && this.ratePlan.id > 0 ? this.ratePlan.id : -1;
    this.savingRatePlan = true;
    $classBillByHourService.saveRatePlan(ratePlan, function (res) {
        thiz.close(res);              
        SnackBar.show("Data was saved successfully");
        window.setTimeout(function() {
            thiz.savingRatePlan = false;
        }, 200);  
    }, function (err) {
        Dialog.error(err.message);
        window.setTimeout(function() {
            thiz.savingRatePlan = false;
        }, 200);  
    });
};

RatePlanDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.saveRatePlan();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                return true;
            }
        }
    ]
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SessionComponent.js";

function SessionComponent() {
    BaseTemplatedWidget.call(this);
    this.domAttached = false;
    this.currentKeyword = "";
    this.bind("click", this.loadDataTable.bind(this, false), this.btnSearch);
    this.bind("keyup", function(event) {
        if (event.keyCode == 13) this.loadDataTable();
    }, this.itemSearchKeyword);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.editSession.bind(this, []), this.btnAddSession);
    this.bind("click", this.dataTableClickHandle, this.dataTable);

    Dom.toggleClass(this.node(), "Editable", ClassAuthUtils.canViewCreateEditSession(ACCOUNT_INFO));
}
__extend(BaseTemplatedWidget, SessionComponent);

SessionComponent.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        if (thiz.domAttached) return;
        thiz.domAttached = true;
        thiz.setupDataTable();
    }, 100);
}

SessionComponent.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
}

SessionComponent.prototype.onEditDropdownMenuClick = function(event) {
    var thiz = this;
    this.paginator.getSelectedItems(function(items) {
        var ids = items.map(function(pv) {
            return pv.id;
        });
        if (ids.lenght == 0) return;
        switch (Dom.getAttributeAsString(event.target, "action")) {
            case "edit":
            thiz.editSession(ids);
            break;
            case "delete":
            thiz.deleteSession(ids);
            break;
            case "undelete":
            break;
            default:
            break;
        }
        thiz.editDropdownMenu.hide();
    });
}

SessionComponent.prototype.editSession = function(ids) {
    var thiz = this;
    var editDialog = new SessionEditDialog().callback(function(response) {
        if (response) {
            thiz.loadDataTable(true);
        }
    });
    editDialog.open(ids);
}

SessionComponent.prototype.setupDataTable = function() {
    var thiz = this;
    var colName = new DataTable.GenericColumn("Session", function (data) {
        return "<a class=\"SessionName\">" + data.name + "</a>";
    }).sortable("myname").width("1*");
    colName.generateId("Session");
    colName.getContentTitle = function (data, row, col) {
        return "" + data.name;
    }
    this.dataTable.column(colName);
    this.dataTable.column(new DataTable.PlainTextColumn("Display Order", function (data) {
        return (data.displayOrder);
    }).sortable("display_order").width("10em"));

    if (ClassAuthUtils.canViewCreateEditSession(ACCOUNT_INFO)) {
        this.dataTable.selector(true, false);
    }
    this.dataTable.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.dataTable.addListener({
        onSelectionChanged: function (table, fromUserAction) {
            thiz.editDropdownButton.disabled = thiz.dataTable.getSelectedItems().length ? false : true;
        }
    });
    this.dataTable.disabledCheckBoxWhenCheckAll(false);
    thiz.dataTable.setup();
    thiz.setupPaginator();
};

SessionComponent.prototype.setupPaginator = function() {
    var thiz = this;

    widget.__ensureNamespaceLoaded("util", function(util) {
        var config = util.paginationUtil.setupPaginatorConfig();

        config.onPageLoaded = function(p, count) {
            util.paginationUtil.setPaginationSummary(thiz.currentPageDetail, p.totalItems, p.currentPage, p.pageSize, count);
        };

        util.paginationUtil.setupPaginatorInstance(thiz.paginator, thiz.dataTable, thiz.createDataSource(), config);
    });
};

SessionComponent.prototype.createDataSource = function() {
    var thiz = this;
    return {
        order: {
            propertyName: "display_order",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var order = {
                name: this.order.propertyName,
                asc: this.order.asc,
                ignoreCase: this.order.propertyName != "display_order"
            };
            $classMetaService.searchLessonSession(order, pageIndex, pageSize, thiz.currentKeyword, function(data) {
                thiz.data = data;
                thiz.totalDisplay.textContent = data.count + " " + (data.count > 1 ? "Sessions" : "Session");
                handler(data.result, data.count);
            }, function(error) {
                console.log("Request data error!", error);
            });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
}

SessionComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.refresh();
}

SessionComponent.prototype.deleteSession = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteLessonSessions(ids, function(deleted) {
                SnackBar.show("" + (deleted ? deleted.length : 0) + " item(s) were deleted");
                if (!deleted || deleted.length < ids.length) {
                    var restList = thiz.dataTable.getSelectedItems().filter(function(item) {
                        return deleted.indexOf(item.id) == -1;
                    });
                    restList = restList.map(function(item) {
                        return item.name;
                    });
                    var message = "\"" + restList.join("\", \"") + (restList.length > 1 ? "\" are being used" : "\" is being used");
                    Dialog.alert("" + restList.length + " item(s) can not delete", message);
                }
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to delete session item(s) with error:", error);
            });
        },
        "Cancel", null);
}

SessionComponent.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "SessionName")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editSession([rowData.id]);
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SessionEditDialog.js";

function SessionEditDialog() {
    ModificationWatchDialog.call(this);
    this.updatedList = [];
    this.current = 0;
    this.hasDataUpdated = false;
    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
}
__extend(ModificationWatchDialog, SessionEditDialog);

SessionEditDialog.prototype.setup = function(ids) {
    if (ids && ids.length > 0) {
        this.updatedList = ids;
        this.title = !ClassAuthUtils.canViewCreateEditSession(ACCOUNT_INFO) ?  ("Session" + " Details") : ("Edit " + "Session");
        if (ids.length > 1) {
            Dom.addClass(this.indexContainer, "Activate");
        }
        this.current = 0;
        this.loadSessionData(ids[0]);
    } else {
        this.title = "Create " + "Session";
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemName, "Please input '" + "Session" + " Name'")
        .custom(new PatternMatchedRule(this.itemOrder, /^\d+$/i, "Session" + " Order must be an positive integer"), function(rule) {
            return rule.input.value;
        });
}

SessionEditDialog.prototype.onPrevButtonClick = function() {
    if (this.current > 0) {
        this.current --;
        this.loadSessionData(this.updatedList[this.current]);
        if (this.current == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

SessionEditDialog.prototype.onNextButtonClick = function() {
    if (this.current < this.updatedList.length - 1) {
        this.current ++;
        this.loadSessionData(this.updatedList[this.current]);
        if (this.current == this.updatedList.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
}

SessionEditDialog.prototype.loadSessionData = function(id) {
    var thiz = this;
    $classMetaService.getLessonSessionById(id, function(data) {
        if (data) {
            thiz.displayIndex.textContent = String.format("Session {0} of {1}", (thiz.current + 1), thiz.updatedList.length);
            thiz.data = data;
            thiz.itemName.value = data.name;
            thiz.itemOrder.value = data.displayOrder;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            if (!ClassAuthUtils.canViewCreateEditSession(ACCOUNT_INFO)) {
                var disabledFunc = function(node) {
                    Dom.setEnabled(false, node);
                };
                Dom.doOnSelector(thiz.dialogBody, "input", disabledFunc);
            }
        }
    }, function(error) {
        console.error("Fail to get session: ", error);
    });
}
SessionEditDialog.prototype.onShown = function() {
    if (!this.data || !this.data.readOnly) return;
    var thiz = this;
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        ClientPropertyUtil.invalidateElements(thiz.dialogBody, cm.ModuleData.__propertySpec);
    });
}
SessionEditDialog.prototype.getChangeEventNames = function () {
    if (!ClassAuthUtils.canViewCreateEditSession(ACCOUNT_INFO)) return [];
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

SessionEditDialog.prototype.getCurrentInputValues = function() {
    return {
        id: this.data ? this.data.id : 0,
        name: this.itemName.value,
        displayOrder: parseInt(this.itemOrder.value)
    }
}

SessionEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var session = this.getCurrentInputValues();
    if (this.updatedList.length > 0 && session.id > 0) {
        $classMetaService.updateLessonSession(session, function(data) {
            SnackBar.show("Session" + " was saved successfully");
            thiz.hasDataUpdated = true;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues);
            thiz.clearUnsavedNotify();
            if (callback) callback(session);
        }, function(error) {
            console.error("Fail to save lesson session with error", error);
        });
    } else {
        $classMetaService.createLessonSession(session, function(data) {
            SnackBar.show("Session" + " was saved successfully");
            thiz.hasDataUpdated = true;
            session.id = data;
            if (callback) callback(session);
        }, function(error) {
            console.error("Fail to save lesson session with error", error);
        });
    }
}

SessionEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.close(this.hasDataUpdated);
                return false;
            }
        }];
    }
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    if (thiz.updatedList.length < 2) thiz.close(data);
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        }
    ]
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SkillEditDialog.js";

function SkillEditDialog() {
    ModificationWatchDialog.call(this);
    this.currId = 0;
    this.updatedList = [];
    this.current = 0;
    this.hasDataUpdated = false;
    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
}
__extend(ModificationWatchDialog, SkillEditDialog);

SkillEditDialog.prototype.setup = function(data) {
    if (data && data.currId) {
        this.currId = data.currId;
    }
    if (data.ids && data.ids.length > 0) {
        this.updatedList = data.ids;
        this.title = "Edit Skill";
        if (data.ids.length > 1) {
            Dom.addClass(this.indexContainer, "Activate");
        }
        this.current = 0;
        this.loadSkillData(data.ids[0]);
    } else {
        this.title = "Create Skill";
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemName, "Please input 'Skill Name'");
}

SkillEditDialog.prototype.onPrevButtonClick = function() {
    if (this.current > 0) {
        this.current --;
        this.loadSkillData(this.updatedList[this.current]);
        if (this.current == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

SkillEditDialog.prototype.onNextButtonClick = function() {
    if (this.current < this.updatedList.length - 1) {
        this.current ++;
        this.loadSkillData(this.updatedList[this.current]);
        if (this.current == this.updatedList.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
}

SkillEditDialog.prototype.loadSkillData = function(id) {
    var thiz = this;
    $classMetaService.getLessonCurrItemById(id, function(data) {
        if (data) {
            thiz.displayIndex.textContent = String.format("Zone {0} of {1}", (thiz.current + 1), thiz.updatedList.length);
            thiz.data = data;
            thiz.itemName.value = data.name;
            thiz.itemDesc.value = data.desc;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
        }
    }, function(error) {
        console.log("Fail to get Skill: ", error);
    });
}

SkillEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

SkillEditDialog.prototype.getCurrentInputValues = function() {
    var data = {
        id: this.data ? this.data.id : 0,
        currId: this.currId,
        name: this.itemName.value,
        desc: this.itemDesc.value
    }
    return data;
}

SkillEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var skill = this.getCurrentInputValues();
    if (this.updatedList.length > 0 && skill.id > 0) {
        $classMetaService.updateLessonCurrItem(skill, function() {
            thiz.hasDataUpdated = true;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
            SnackBar.show("Skill was updated successfully.");
            if (callback) callback(skill);
        }, function(error) {
            console.error("Fail to save lesson Skill with error: " + error);
        });
    } else {
        $classMetaService.createLessonCurrItem(skill, function(id) {
            thiz.hasDataUpdated = true;
            SnackBar.show("Skill was created successfully.");
            skill.id = id;
            if (callback) callback(skill);
        }, function(error) {
            console.error("Fail to save lesson Skill with error: " + error);
        });
    }
}

SkillEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.close(this.hasDataUpdated);
                return false;
            }
        }];
    }
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    if (thiz.updatedList.length < 2) thiz.close(data);
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        }
    ]
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SkillsComponent.js";

function SkillsComponent() {
    var thiz = this;
    var domAttached = false;
    this.currentKeyword = "";
    BaseTemplatedWidget.call(this);
    this.bind("click", this.loadDataTable.bind(this, false), this.btnSearch);
    this.bind("keyup", function(event) {
        if (event.keyCode == 13) this.loadDataTable();
    }, this.itemSearchKeyword);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.editCurriculum.bind(this, []), this.btnAddCurriculum);
    this.bind("click", this.dataTableClickHandle, this.dataTable);
}
__extend(BaseTemplatedWidget, SkillsComponent);

SkillsComponent.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        if (thiz.domAttached) return;
        thiz.domAttached = true;
        thiz.setupDataTable();
    }, 100);
}

SkillsComponent.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
}

SkillsComponent.prototype.onEditDropdownMenuClick = function(event) {
    var thiz = this;
    this.paginator.getSelectedItems(function(items) {
        var ids = items.map(function(pv) {
            return pv.id;
        });
        if (ids.length == 0) return;
        switch (Dom.getAttributeAsString(event.target, "action")) {
            case "edit":
            thiz.editCurriculum(ids);
            break;
            case "delete":
            thiz.deleteCurriculum(ids);
            break;
            case "undelete":
            break;
            default:
            break;
        }
        thiz.editDropdownMenu.hide();
    });
}

SkillsComponent.prototype.editCurriculum = function(ids) {
    var thiz = this;
    var editDialog = new CurriculumEditDialog().callback(function(response) {
        if (response) thiz.loadDataTable(true);
    });
    editDialog.open(ids);
}

SkillsComponent.prototype.setupDataTable = function() {
    var thiz = this;
    var colName = new DataTable.GenericColumn("Curriculum", function (data) {
        return "<a class=\"CurrName\">" + data.name + "</a>";
    }).sortable("myname").width("1*");
    colName.getContentTitle = function (data, row, col) {
        return "" + data.name;
    }
    this.dataTable.column(colName);
    var colSkills = new DataTable.GenericColumn("Skills", function (data) {
        var html = "<ul>";
        for (var i = 0; i < data.skills.length; i++) {
            html += "<li>" + data.skills[i].name + "</li>";
        }
        html += "</ul>";
        return html;
    }).width("1*");
    colSkills.getContentTitle = function (data, row, col) {
        return "";
    }
    this.dataTable.column(colSkills);
    this.dataTable.column(new DataTable.PlainTextColumn("Description", function (data) {
        return (data.desc);
    }).sortable("descr").width("1*"));
    this.dataTable.selector(true, false);
    this.dataTable.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.dataTable.addListener({
        onSelectionChanged: function (table, fromUserAction) {
            thiz.editDropdownButton.disabled = thiz.dataTable.getSelectedItems().length ? false : true;
        }
    });
    this.dataTable.disabledCheckBoxWhenCheckAll(false);
    this.dataTable.setup();
    this.setupPaginator();
}

SkillsComponent.prototype.setupPaginator = function() {
    var thiz = this;

    widget.__ensureNamespaceLoaded("util", function(util) {
        var config = util.paginationUtil.setupPaginatorConfig();

        config.onPageLoaded = function(p, count) {
            util.paginationUtil.setPaginationSummary(thiz.currentPageDetail, p.totalItems, p.currentPage, p.pageSize, count);
        };

        util.paginationUtil.setupPaginatorInstance(thiz.paginator, thiz.dataTable, thiz.createDataSource(), config);
    });
};

SkillsComponent.prototype.createDataSource = function() {
    var thiz = this;
    return {
        order: {
            propertyName: "myname",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var order = {
                name: this.order.propertyName,
                asc: this.order.asc,
                ignoreCase: true
            };
            $classMetaService.searchLessonCurr(order, pageIndex, pageSize, thiz.currentKeyword, function(data) {
                thiz.data = data;
                thiz.totalDisplay.textContent = (data.count > 1 ? data.count + " Curriculums" : data.count + " Curriculum");
                handler(data.result, data.count);
            }, function(error) {
                console.log("request data error!", error);
            });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
}

SkillsComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.refresh();
}

SkillsComponent.prototype.deleteCurriculum = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteLessonCurrs(ids, function(deleted) {
                SnackBar.show("" + (deleted ? deleted.length : 0) + " item(s) were deleted");
                if (!deleted || deleted.length < ids.length) {
                    var restList = thiz.dataTable.getSelectedItems().filter(function(item) {
                        return deleted.indexOf(item.id) == -1;
                    });
                    restList = restList.map(function(item) {
                        return item.name;
                    });
                    var message = "\"" + restList.join("\", \"") + (restList.length > 1 ? "\" are being used" : "\" is being used");
                    Dialog.alert("" + restList.length + " item(s) can not delete", message);
                }
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to delete curriculum item(s) with error:", error);
            });
        },
        "Cancel", null);
}

SkillsComponent.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "CurrName")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editCurriculum([rowData.id]);
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/StartDropPolicyDialog.js";

function StartDropPolicyDialog() {
    Dialog.call(this);
    var thiz = this;
    this.bind("p:DiscountPlanItemChanged", function () {
        thiz.invalidateSizing();
    }, this.discountPlanContent);
}


__extend(Dialog, StartDropPolicyDialog);

StartDropPolicyDialog.prototype.setup = function (options) {
    if (!options) return;
    if (options.policyData && options.policyData.id > 0) {
        this.title = "Edit Start Drop Policy";
    } else {
        this.title = "Add Start Drop Policy";
    }
    this.options = options;
    this.startDropPolicesWidget = new StartDropPoliciesWidget({selectedPolicy: options.policyData}).into(this.policyContent);
};

StartDropPolicyDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.savePolicy();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                if (thiz.startDropPolicesWidget && thiz.startDropPolicesWidget.isDataChanged()) {
                    Dialog.confirm("Are you sure you want to discard the unsaved changes?", null, "Discard changes", function () {
                        thiz.close();
                        return true;
                    },
                    "Cancel", function () {
                        return false;
                    }, null, null);
                } else {
                    return true;
                }
            }
        }
    ]
};

StartDropPolicyDialog.prototype.savePolicy = function() {
    var thiz = this;
    if (!this.startDropPolicesWidget) return;
    if (!this.startDropPolicesWidget.validatePolicyData()) return;
    var policyData = this.startDropPolicesWidget.getPolicyValue();
    $classStartDropDateService.saveStartDropDatePolicy(policyData, function (res) {
        thiz.close(res);
        SnackBar.show("Data was saved successfully");
    }, function (err) {
        Dialog.alert("Fail to save Policy  with error", err.message);
    });
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SubProgramComponent.js";

function SubProgramComponent(node) {
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.bind("p:PageLoaded", function(e) {
        if(!e.detail) return;
        if(e.detail.totalItems > 1) {
            this.totalSubProgram.innerHTML = e.detail.totalItems + " Sub Programs";
        } else {
            this.totalSubProgram.innerHTML = e.detail.totalItems + " Sub Program";
        }
    }, this.dataView.node());




    this.bind("click", this.addSubProgramButtonClickHandler, this.addSubProgramButton);
    
    Dom.toggleClass(this.container, "Editable", this.canViewCreateEditSubProgram());
}

__extend(BaseTemplatedWidget, SubProgramComponent);

SubProgramComponent.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.isClassSetupDone) {
        this.setupDataView();
    } else {
        $classAdminService.getAccountInfo(function (res) {
            window.LOGIN_INFO.allowClassPaymentPlan = res.allowClassPaymentPlan;
            window.LOGIN_INFO.allowStartDropDates = res.allowStartDropDates;
            window.LOGIN_INFO.classRegistrationLink = res.classRegistrationLink;
            window.LOGIN_INFO.classRegShoppingLink = res.classRegShoppingLink;
            thiz.setupDataView();
        }, function (err) {});
    }
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        ClientPropertyUtil.invalidateElements(this.container, cm.ModuleData.__propertySpec);
    }.bind(this));
};

SubProgramComponent.prototype.setupDataView = function() {
    var thiz = this;
    this.dataView.setDefaultSelectionHandler(function(data, fieldName, cell, e) {
        if(Dom.hasClass(e.target, "descr-content") && data) {
            thiz.descriptionPopupContent.innerHTML = data.descr;
            thiz.descriptionPopup.show(e.target, "left-inside", "center", 0, 10, true);
            return;
        }
        new SubProgramEditDialog().callback(function(subProgramData) {
            if(!subProgramData) return;
            thiz.dataView.refreshDataList();
        }).open({ids: [data.id]});
    });


    this.dataView.registerCustomRenderer("title", function (data, value) {
        var children = [{_name: "span", _html: value, "class": "sub-program-name"}];
        if(data.imgHtmlPath) {
            children.push({
                _name: "div", class: "sub-program-image",
                _children: [
                    {_name: "img", src: data.imgHtmlPath}
                ]
            });
        }
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("descr", function (data, value) {
        var descr = "" + data.descr;
        if(descr.length > 200) {
            descr = descr.substring(0, 200) + "...";
        }
        return {
            _name: "div",
            "class": "descr-content",
            _html: descr
        }
    });

    var actions = [
        {
            title: "Edit Sub Program(s)",
            run: function (items) {
                if(!items) return;
                var ids = [];
                for(var i = 0; i < items.length; i ++) {
                    ids.push(items[i].id);
                }
                if(ids.length == 0) return;
                new SubProgramEditDialog().callback(function(subProgramData) {
                    if(!subProgramData) return;
                    thiz.dataView.refreshDataList();
                }).open({ids: ids});

            },
            applicable: function (count, dataView) {
                return count > 0;
            }
        },
        {
            title: "Multi Edit Sub Programs",
            run: function (items) {
                if(!items) return;
                var ids = [];
                for(var i = 0; i < items.length; i ++) {
                    ids.push(items[i].id);
                }
                if(ids.length == 0) return;
                new SubProgramMultiEditDialog().callback(function(data) {
                    if(!data) return;
                    $classMetaService.updateMultiSubProgram(ids, data.programId, data.annualRegAccount, data.annualRegStudent,
                        data.lessonCoupon, data.middleNameRequired, data.hideSlot, data.useUnappliedpayment, function(res) {
                        thiz.dataView.refreshDataList();
                    }, function(err) {});
                }).open();
            },
            applicable: function (count, dataView) {
                return count > 0;
            }
        }
    ];
    if (!(window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan)) {
        actions.push({
            title: "Discount Multi-Setup",
            run: function (items) {
                if(!items) return;
                var ids = [];
                for(var i = 0; i < items.length; i ++) {
                    ids.push(items[i].id);
                }
                if(ids.length == 0) return;
                new SubProgramDiscountSetupDialog().callback(function(discountData) {
                    if(!discountData) return;
                    $classMetaService.updateMultiDiscountSubProgram(ids, discountData.multiStudentsDiscount, discountData.multiClassDiscount, function(res) {
                        thiz.dataView.refreshDataList();
                    }, function(err) {});
                }).open({ids: ids});
            },
            applicable: function (count, dataView) {
                return count > 0;
            }
        });
    }
    if (thiz.canManageSubProgram()) {
        actions.push({
            title: "Delete",
            run: function (items) {
                var ids = [], itemNotDeletable = "", cannotDeleteCount = 0;
                for(var i = 0; i < items.length; i ++) {
                    if(!items[i].deletable) {
                        itemNotDeletable += ((itemNotDeletable? ", " : "") + ("\"" + items[i].title + "\""));
                        cannotDeleteCount++;
                    }
                    ids.push(items[i].id);
                }
                if(itemNotDeletable) {
                    var str = (cannotDeleteCount > 1)? "Cannot delete " + itemNotDeletable + " because their classes have been used" :
                        "Cannot delete " + itemNotDeletable + " because its class has been used" ;
                    Dialog.error("", str, null);
                    return;
                }
    
                if(ids.length == 0) return;
                Dialog.confirm("Are you sure you want to delete selected item(s)?", "", "Delete", function() {
                    var busyIndicator = new Spinner("Loading...");
                    busyIndicator.busy();

                    $classMetaService.deleteSubProgramsAsync(ids, function (jobId) {
                        thiz._onJobExecuted(jobId, function (data) {
                            thiz.dataView.refreshDataList();
                            busyIndicator.done();
                        }, function (error) {
                            busyIndicator.done();
                            Dialog.error(error.message || "Error when deleting sub programs");
                        })
                    }, function(err) {
                        busyIndicator.done();
                        Dialog.error(err.message);
                    });
                }, "Cancel");
            },
            applicable: function (count, dataView) {
                return count > 0;
            }
        });
    }
    if (this.canViewCreateEditSubProgram()) {
        this.dataView.registerActions(actions, "Edit");
    } else {
        this.dataView.isSelectable = false;
    }

    if (this.canManageSubProgram()) { 
        this.dataView.registerActions([{
            title: "Edit Display Order",
            important: true,
            run: function (items) {
                new EditDisplayOrderDialog().open();
            },
            applicable: function (count, dataView) {
                return true;
            }
        }], "Edit Display Order");
    }
};

SubProgramComponent.prototype.addSubProgramButtonClickHandler = function () {
    var thiz = this;
    new SubProgramEditDialog().callback(function(subProgramData) {
        if(!subProgramData) return;
        thiz.dataView.refreshDataList();
    }).open({});
};

SubProgramComponent.prototype.canViewCreateEditSubProgram = function() {
    return ClassAuthUtils.canViewCreateEditSubProgram(ACCOUNT_INFO);
};

SubProgramComponent.prototype.canManageSubProgram = function() {
    return ClassAuthUtils.canManageSubProgram(ACCOUNT_INFO);
};

SubProgramComponent.prototype._onJobExecuted = function(jobId, onSuccess, onError) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var firstTime = true;

    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                firstTime = false;
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        onError({message: job.errorMessage});
                    }
                } else {
                    onError({message: "Job not found."});
                }
            }, function (error) {
                onError(error);
            });
        }, firstTime ? 150 : 500);
    })();
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SubProgramDiscountSetupDialog.js";

function SubProgramDiscountSetupDialog() {
    Dialog.call(this);
    this.multiStudentsDiscount.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.multiClassDiscount.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
}

__extend(Dialog, SubProgramDiscountSetupDialog);

SubProgramDiscountSetupDialog.prototype.setup = function(options) {
    this.title = "Discount Multi Setup";
    this.multiStudentsDiscount.setItems([null, {id: 1, name: "Yes"}, {id: 0, name: "No"}]);
    this.multiClassDiscount.setItems([null, {id: 1, name: "Yes"}, {id: 0, name: "No"}]);
};

SubProgramDiscountSetupDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () { 
                thiz.close({
                    multiStudentsDiscount: thiz.multiStudentsDiscount.getSelectedItem() ? thiz.multiStudentsDiscount.getSelectedItem().id : -1,
                    multiClassDiscount: thiz.multiClassDiscount.getSelectedItem() ? thiz.multiClassDiscount.getSelectedItem().id : -1
                });
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SubProgramEditDialog.js";

function SubProgramEditDialog() {
    ModificationWatchDialog.call(this);
    this.programAssociationCombo.renderer = function (item, selected) {
        if(!item) return "";
        return "" + item.title;
    };
    this.chargeOfAccountCombo.renderer = function (item, selected) {
        if(!item) return "";
        return "" + item.name;
    };
    this.discountPlanCombo.useHtml = true;
    this.discountPlanCombo.setPopupClass("DiscountPlansPopup");
    this.discountPlanCombo.renderer = function(item) {
        if(!item) return "&nbsp;";
        var html = "<vbox class=\"InfoGroup\">"
                + "<hbox class=\"DiscountPlanName\">" + item.name + "</hbox>"
                + "<hbox>"
                + "<span>Multi-Class Discount:"
                + "<span class=\"DisplayValue " + (item.allowMultiClassDiscount ? "" : "OFF") + "\">" + (item.allowMultiClassDiscount ? "Yes" : "No")
                + "</span></span>"
                + "<span> - Multi-Athlete Discount:"
                + "<span class=\"DisplayValue " + (item.allowMultiStudentDiscount ? "" : "OFF") + "\">" + (item.allowMultiStudentDiscount ? "Yes" : "No")
                + "</span></span>"
                + "<span> - Coupons: "
                + "<span class=\"DisplayValue " + (item.allowCoupon ? "" : "OFF") + "\">" + (item.allowCoupon ? "Yes" : "No")
                + "</span></span>"
                + "</hbox>"
                + "</vbox>";
        return html;
    };

    this.policyCombo.useHtml = true;
    this.policyCombo.setPopupClass("PolicyComboPopup");
    this.policyCombo.renderer = function (item) {
        if(!item) return "&nbsp;";
        return "<strong>" + item.name + "</strong>";
    };

    this.annualKitsCategoryCombo.renderer = function (item) {
        return item.name;
    };
    this.annualKitsCategoryCombo.comparer = function (a, b) {
        return a === b;
    };

    this.bind("click", this.indexActionNextClickHandler, this.indexActionNext);
    this.bind("click", this.indexActionPrevClickHandler, this.indexActionPrev);
    this.bind("change", this.additionalFeeDiscountChangeHandler, this.additionalFeeDiscount);
    this.bind("change", this.allLocationSelectionChangeHandler, this.allLocationSelection);
    this.bind("change", this.selectedLocationSelectionChangeHandler, this.selectedLocationSelection);
    this.bind("p:ItemSelected", this.discountPlanChangedHandler, this.discountPlanCombo);
    this.bind("p:ItemSelected", this.policyComboChangedHandler, this.policyCombo);

    this.bind("click", this.newDiscountPlanButtonClickHandler, this.newDiscountPlanButton);
    this.bind("click", this.editDiscountPlanButtonClickHandler, this.editDiscountPlanButton);

    this.bind("click", this.newPolicyButtonClickHandler, this.newPolicyButton);
    this.bind("click", this.editPolicyButtonClickHandler, this.editPolicyButton);

    this.bind("change", this.allowedAnnualKitsChangedHandler, this.allowedAnnualKits);
    this.bind("p:ItemSelected", this.annualKitsCategoryChangedHandler, this.annualKitsCategoryCombo);
    Dom.toggleClass(this.container, "Editable", ClassAuthUtils.canViewCreateEditSubProgram(ACCOUNT_INFO));

    this.provider = {
        type: "error",
        match: function (node) {
            return Dom.hasClass(node, "alert-circle");
        },
        getMessage: function (target) {
            return "";
        }
    };
    InfoTip.install(this.infoTipContainer, this.provider);
    Dom.toggleClass(this.annualKitsSetting, "ActiveSetting", TEAM_INFO.isOwnershipTeam == true);
}

__extend(ModificationWatchDialog, SubProgramEditDialog);

SubProgramEditDialog.prototype.asyncSetup = function (options, dialogCallback) {
    var thiz = this;
    this.options = options;
    this.subProgramIdIndex = 0;
    if(this.options.ids) {
        this.title = "Edit Sub Program";
    } else {
        this.title = "Add Sub Program";
    }

    this.allLocationSelection.checked = true;
    this.locationChipList.setEnabled(false);

    var subProgramConfigurationPromise = new Promise(function(resolve, reject) {
        $classMetaService.getSubProgramConfiguration(function(res) {
            thiz.filters = res;
            resolve();
        }, function (err) {reject(error);});
    });
    var getDiscountPlansPromise = new Promise(function(resolve, reject) {
        if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
            $classAdminService.getDiscountPlans(function (discountPlans) {
                thiz.discountPlans = discountPlans.result;
                resolve();
            }, function (err) {reject(error);});
        } else {
            resolve();
        }
    });
    var getStartDropDatesPromise = new Promise(function(resolve, reject) {
        if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
            $classStartDropDateService.getAllStartDropDatePolicy(function (policies) {
                thiz.startDropPolicies = policies.result;
                resolve();
            }, function (err) {reject(error);});
        } else {
            resolve();
        }
    });
    
    var updateQuestionSettingView = new Promise(function(resolve, reject) {
        thiz.questionSettingContainer.innerHTML = "";
        widget.__ensureNamespaceLoaded("customquestion", (cqPkg) => {
            thiz.questionSettingView = new cqPkg.QuestionApplicationSettingView({
                "application-type": cqPkg.ModuleData.QUESTION_APPLICATION_TYPE.CLASS_SUBPROGRAM.type
            }).into(thiz.questionSettingContainer);
            thiz.questionSettingView.initWith(0, () => resolve());
        });
    });

    Promise.all([subProgramConfigurationPromise, getDiscountPlansPromise, getStartDropDatesPromise, updateQuestionSettingView]).then(function () {
        thiz.renderSubProgramEditDialog(thiz.options.ids, thiz.subsubProgramIdIndex);
        dialogCallback();
    });

    this.validationRules = new RuleSet().live(true)
        .required(this.subProgramTitle, String.format("[{0}] is a required field; please enter the correct value.", "Sub Program Name"))
        .required(this.programAssociationCombo, String.format("[{0}] is a required field; please enter the correct value.", "Program Association"))
        .required(this.additionalFeeTitle, String.format("{0} is a required field; please enter the correct value.", "Additional Fee/Discount [Question]"), Condition.checked(this.additionalFeeDiscount))
        .required(this.feeDiscountName, String.format("{0} is a required field; please enter the correct value.", "Additional Fee/Discount [Fee Name]"), Condition.checked(this.additionalFeeDiscount))
        .required(this.chargeOfAccountCombo, String.format("{0} is a required field; please enter the correct value.", "Additional Fee/Discount [Chart of Account]"), Condition.checked(this.additionalFeeDiscount))
        .custom(new PatternMatchedRule(this.feeToCharge, /^\-?\d+(\.\d+)?$/i, "Session Order must be a decimal value."), function(rule) {
            return rule.input.getValue();
        }, Condition.checked(this.additionalFeeDiscount));
    
    if (TEAM_INFO.isOwnershipTeam) {
        this.validationRules.required(this.annualKitsCategoryCombo, String.format("[{0}] is a required field; please select the correct value.", "Annual Kits Category"), Condition.checked(this.allowedAnnualKits));
    }
    
    this.categoryComboRule = new RuleSet()
        .custom(new GenericRule(this.annualKitsCategoryCombo, () => {
            if (!this.allowedAnnualKits.checked) return true;
            return this.validCategory == true;
        }, "Invalid category."));
};

SubProgramEditDialog.prototype.getChangeEventNames = function () {
    if (!ClassAuthUtils.canViewCreateEditSubProgram(ACCOUNT_INFO)) return [];
    return [FileUploadView.FILE_CHANGE_EVENT_NAME, RichTextEditor.TEXT_CHANGE_EVENT_NAME].concat(ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES);
};


SubProgramEditDialog.prototype.renderSubProgramEditDialog = function (ids, idIndex) {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        Dom.addClass(this.discountSettingForNonCpp, "Hidden");
        Dom.removeClass(this.discountSettingForCpp, "Hidden");
        Dom.removeClass(this.allowUnappliedPayment.parentNode, "Hidden");
        this.discountPlanCombo.setItems([null].concat(thiz.discountPlans));
        this.allowUnappliedPayment.checked = true;
    } else {
        Dom.removeClass(this.discountSettingForNonCpp, "Hidden");
        Dom.addClass(this.discountSettingForCpp, "Hidden");
        Dom.addClass(this.allowUnappliedPayment.parentNode, "Hidden");
    }

    if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
        Dom.removeClass(this.policySetting, "Hidden");
        this.policyCombo.setItems([null].concat(thiz.startDropPolicies));
    } else {
        Dom.addClass(this.policySetting, "Hidden");
    }

    if(this.options.ids) {
        if(this.options.ids.length > 1) {
            this.editProgramIndex.innerHTML = "Sub Program " + (this.subProgramIdIndex + 1) + " of " + this.options.ids.length;
        } else {
            this.indexAction.parentNode.removeChild(this.indexAction);
        }
        if(this.subProgramIdIndex == 0) {
            Dom.addClass(this.indexActionPrev, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionPrev, "action-disabled");
        }
        if(this.subProgramIdIndex == this.options.ids.length - 1) {
            Dom.addClass(this.indexActionNext, "action-disabled");
        } else {
            Dom.removeClass(this.indexActionNext, "action-disabled");
        }
    } else {
        this.indexAction.parentNode.removeChild(this.indexAction);
    }

    if(this.filters.programs) {
        this.programAssociationCombo.setItems(this.filters.programs);
    }
    
    Dom.addClass(this.annualKitsCategoryWrapper, "Inapplicable");
    if (this.filters.productCategories && TEAM_INFO.isOwnershipTeam) {
        this.annualKitsCategoryCombo.setItems(this.filters.productCategories, "noSelectFirst");
    }

    this.subProgramImageFileUploadView.dataType = "__lesson__";
    this.subProgramImageFileUploadView.dataUUID = "subprog";

    var lessonLocs = this.filters.lessonLocs;
    var source = function (term, callback) {
        setTimeout(function () {
            var location = lessonLocs.filter(function (l) {
                if(thiz.locationChipList.getItems().indexOf(l) >= 0) return false;
                return !term || (l.name && l.name.toLowerCase().indexOf(term.toLowerCase().trim()) >= 0);
            });
            callback(location);
        }, 100);
    };
    var renderer = function (location) {
        return (location.name || "");
    };
    thiz.locationChipList.setup(source, renderer);

    Dom.addClass(this.container, "non-additional-fee-discount");
    if(this.filters.coas) {
        this.chargeOfAccountCombo.setItems(this.filters.coas);
    }
    if (this.options.programId > 0) {
        this.programAssociationCombo.selectItemByKey("id", this.options.programId);
    }

    if(!this.options.ids) return;
    if(this.options.ids.length <= 0) return;
    $classMetaService.getSubProgramById(this.options.ids[this.subProgramIdIndex], function(res) {
        console.log("RESSSS", res);
        thiz.subProgramData = res;
        thiz.subProgramTitle.value = res.title;
        thiz.programAssociationCombo.selectItemByKey("id", res.programId);
        thiz.regFeePerFamily.checked = res.regFeePerFamily;
        thiz.regFeePerStudent.checked = res.regFeePerStudent;
        thiz.additionalFeeDiscount.checked = (res.addlFeeTitle && res.addlFeeTitle.length > 0) ? true : false;
        if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
            if (res.discountPlanId > 0) thiz.discountPlanCombo.selectItemByKey("id", res.discountPlanId);
        }
        if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
            if (res.startDropDatePolicyId > 0) thiz.policyCombo.selectItemByKey("id", res.startDropDatePolicyId);
        }
        thiz.additionalFeeDiscountChangeHandler();
        if(thiz.additionalFeeDiscount.checked) {
            thiz.additionalFeeTitle.value = res.addlFeeTitle;
            thiz.answerToChargeFee.checked = res.answerToChargeFee;
            thiz.feeDiscountName.value = res.addlFeeName;
            thiz.feeToCharge.setValue(res.addlFeeAmt);

            if(res.addlFeeCoaId > 0) {
                thiz.chargeOfAccountCombo.selectItemByKey("id", res.addlFeeCoaId);
            }
            var selectedLocations = [],
                locationIdObject = {};
            if(res.addlFeeLocs && res.addlFeeLocs.length > 0) {
                var addlFeeLocs = res.addlFeeLocs.split(",");
                for(var i = 0; i < addlFeeLocs.length; i ++) {
                    locationIdObject[addlFeeLocs[i]] = true;
                }
            }
            if(thiz.filters.lessonLocs && thiz.filters.lessonLocs.length > 0) {
                for(var i = 0; i < thiz.filters.lessonLocs.length; i ++) {
                    if(locationIdObject[thiz.filters.lessonLocs[i].id]) {
                        selectedLocations.push(thiz.filters.lessonLocs[i]);
                    }
                }
            }
            thiz.locationChipList.setItems(selectedLocations);
        }
        thiz.multiStudentsDiscount.checked = res.multiStudentsDiscount;
        thiz.multiClassDiscount.checked = res.multiClassDiscount;
        thiz.lessonCoupon.checked = res.lessonCoupon;
        thiz.middleNameRequired.checked = res.middleNameRequired;
        thiz.showOpenSlot.checked = !res.hideSlotInd;
        
        thiz.description.setContent(res.descriptionHtml);
        var previewWrappers = thiz.subProgramImageFileUploadView.node().getElementsByClassName("PreviewWrapper");
        if(previewWrappers && previewWrappers.length > 0) {
            for(var i = 0; i < previewWrappers.length; i ++) {
                previewWrappers[i].parentNode.removeChild(previewWrappers[i]);
            }
        }
        thiz.subProgramImageFileUploadView.setCommaSeparatedStoragePaths("");
        if(res.thumbnailFilePath && res.thumbnailFilePath.length > 0) {
            var thumbnailFilePath = res.thumbnailFilePath;
            thumbnailFilePath = thumbnailFilePath.substring(0, thumbnailFilePath.lastIndexOf("?"));
            thiz.subProgramImageFileUploadView.setCommaSeparatedStoragePaths(thumbnailFilePath);
        }

        if(res.addlFeeLocs && res.addlFeeLocs.length > 0) {
            thiz.allLocationSelection.checked = false;
            thiz.selectedLocationSelection.checked = true;
            thiz.locationChipList.setEnabled(true);
        }
        if (res.allowUnappliedPayment) {
            thiz.allowUnappliedPayment.checked = true;
        } else {
            thiz.allowUnappliedPayment.checked = false;
        }

        if (TEAM_INFO.isOwnershipTeam) {
            thiz.allowedAnnualKits.checked = res.annualKitsCategoryId > 0;
            if (!thiz.allowedAnnualKits.checked) {
                thiz.annualKitsCategoryCombo.selectItem();
                Dom.empty(thiz.annualKitsCategoryCombo.buttonDisplay);
                Dom.toggleClass(thiz.infoTipContainer, "Showed", false);
            }
            thiz.allowedAnnualKitsChangedHandler();
            if (res.annualKitsCategoryId > 0) {
                thiz.annualKitsCategoryCombo.selectItemByKey("id", res.annualKitsCategoryId);
            }
        }
        thiz.disableShowCommerceAddonStore.checked = res.disableShowCommerceAddonStore || false;

        
        thiz.questionSettingView.setTargetId(thiz.subProgramData.id);
        thiz.questionSettingView.setSelectedQuestionIds(thiz.subProgramData.questionIds);
    }, function(err) {});
};

SubProgramEditDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var actions = [];
    var body = document.getElementsByTagName("body")[0];
    if (this.options.ids && this.options.ids[this.subProgramIdIndex]) {
/*        
        actions.push({
            type: "accept", title: "Go To Class Reg Inventory",
            isApplicable: function () {
                return true;
            },
            order: -1,
            run: function () {
                var shoppingCartEnable = AdminConsole.instance.isTeamFeatureModuleEnable("shoppingcart");
                if (shoppingCartEnable) {
                    window.open(window.LOGIN_INFO.classRegShoppingLink + "?subProgId=" + thiz.options.ids[thiz.subProgramIdIndex], "_blank");
                } else {
                    if (body && Dom.hasClass(body, "ClassicLayout")) {
                        window.open("ClassReg.jsp?team=" + TEAM_INFO.alias + "&subProgId=" + thiz.options.ids[thiz.subProgramIdIndex], "_blank");
                    } else {
                        window.open(window.LOGIN_INFO.classRegistrationLink + "?subProgId=" + thiz.options.ids[thiz.subProgramIdIndex], "_blank");
                    }
                }
            }
        });
*/        
        actions.push({
            type: "extra", title: "Share", icon: "share",
            order: -3,
            run: function () {
                new ShareClassDialog().open({type: "Sub Program", name: thiz.subProgramData.title, data: {subProgId: thiz.subProgramData.id}});
            }
        });
    }

    if (this.modified) {
        actions.push({
            type: "accept", title: "Save",
            run: function () {
                thiz.saveSubProgram();
            }
        });
        actions.push({
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        });
    } else {
        actions.push({
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {return true;}
        });
    }
    return actions;
};

SubProgramEditDialog.prototype.saveSubProgram = function() {
    var rules = TEAM_INFO.isOwnershipTeam ? this.validationRules.set(this.categoryComboRule) : this.validationRules;
    if(!ValidationManager.run(rules)) return false;
    var subProgramData = this.getSubProgramData();
    if (subProgramData) {
        var thiz = this;
        var busyIndicator = new Spinner("Saving...");
        busyIndicator.busy();
        
        $classMetaService.saveSubProgramAsync(subProgramData, function (jobId) {
            thiz._onJobExecuted(jobId, function (data) {
                if (data) {
                    thiz.close(data);
                }
                busyIndicator.done();
            }, function (error) {
                busyIndicator.done();
                Dialog.error(error.message || "Error when saving sub program");
            })
        }, (error) => {
            busyIndicator.done();
            Dialog.error(error.message);
        });
    }
};

SubProgramEditDialog.prototype._onJobExecuted = function(jobId, onSuccess, onError) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var firstTime = true;

    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                firstTime = false;
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        onError({message: job.errorMessage});
                    }
                } else {
                    onError({message: "Job not found."});
                }
            }, function (error) {
                onError(error);
            });
        }, firstTime ? 150 : 500);
    })();
};

SubProgramEditDialog.prototype.getSubProgramData = function() {
    var filePath = this.subProgramImageFileUploadView.getCommaSeparatedStoragePaths();
    var data = {
        id: (this.subProgramData && this.subProgramData.id) ? this.subProgramData.id : -1,
        title: this.subProgramTitle.value,
        programId: this.programAssociationCombo.getSelectedItem() ? this.programAssociationCombo.getSelectedItem().id : 0,
        regFeePerFamily: this.regFeePerFamily.checked,
        regFeePerStudent: this.regFeePerStudent.checked,
        middleNameRequired: this.middleNameRequired.checked,
        hideSlotInd: !this.showOpenSlot.checked,
        descriptionHtml: this.description.getContent(),
        thumbnailFilePath: filePath
    };
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        data.discountPlanId = this.discountPlanCombo.getSelectedItem() ? this.discountPlanCombo.getSelectedItem().id : 0;
        data.multiStudentsDiscount = false;
        data.multiClassDiscount = false;
        data.lessonCoupon = false;
    } else {
        data.multiStudentsDiscount = this.multiStudentsDiscount.checked ? 1 : 0;
        data.multiClassDiscount = this.multiClassDiscount.checked ? 1 : 0;
        data.lessonCoupon = this.lessonCoupon.checked ? 1 : 0;
    }
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
        data.startDropDatePolicyId = this.policyCombo.getSelectedItem() ? this.policyCombo.getSelectedItem().id : 0;
    } else {
        data.startDropDatePolicyId = 0;
    }

    if(this.additionalFeeDiscount.checked) {
        data.addlFeeTitle = this.additionalFeeTitle.value;
        data.answerToChargeFee = this.answerToChargeFee.checked;
        data.addlFeeName = this.feeDiscountName.value;
        data.addlFeeAmt = this.feeToCharge.getValue();
        data.addlFeeCoaId = this.chargeOfAccountCombo.getSelectedItem() ? this.chargeOfAccountCombo.getSelectedItem().id : 0;
        var selectedLocations = this.locationChipList.getItems();
        var locationIds = [];
        if(selectedLocations && selectedLocations.length > 0) {
            for(var i = 0; i < selectedLocations.length; i ++) {
                locationIds.push(selectedLocations[i].id);
            }
        }
        data.addlFeeLocs = locationIds.join(",");
    } else {
        data.addlFeeTitle = "";
        data.answerToChargeFee = 0;
        data.addlFeeName = "";
        data.addlFeeAmt = 0;
        data.addlFeeCoaId = 0;
        data.addlFeeLocs = "";
    }
    data.allowUnappliedPayment = this.allowUnappliedPayment.checked;
    data.annualKitsCategoryId = this.allowedAnnualKits.checked ? this.annualKitsCategoryCombo.getSelectedItem().id : null;
    data.disableShowCommerceAddonStore = this.disableShowCommerceAddonStore.checked;
    data.questionIds = this.questionSettingView.getSelectedQuestionIds();

    return data;
};

SubProgramEditDialog.prototype.indexActionNextClickHandler = function () {
    if(this.subProgramIdIndex == this.options.ids.length - 1) return;
    this.subProgramIdIndex ++;
    this.renderSubProgramEditDialog(this.options.ids, this.subProgramIdIndex);

};

SubProgramEditDialog.prototype.indexActionPrevClickHandler = function () {
    if(this.subProgramIdIndex == 0) return;
    this.subProgramIdIndex --;
    this.renderSubProgramEditDialog(this.options.ids, this.subProgramIdIndex);
};

SubProgramEditDialog.prototype.additionalFeeDiscountChangeHandler = function () {
    Dom.toggleClass(this.container, "non-additional-fee-discount", this.additionalFeeDiscount.checked ? false : true);
};

SubProgramEditDialog.prototype.allLocationSelectionChangeHandler = function () {
    if(this.allLocationSelection.checked) {
        this.locationChipList.setItems([]);
        this.locationChipList.setEnabled(false);
    }
};

SubProgramEditDialog.prototype.selectedLocationSelectionChangeHandler = function () {
    if(this.selectedLocationSelection.checked) {
        this.locationChipList.setEnabled(true);
    }
};

SubProgramEditDialog.prototype.newDiscountPlanButtonClickHandler = function () {
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        var discountPlan = {
            key: Util.newUUID(),
            allowMultiClassDiscount: true,
            allowMultiStudentDiscount: true,
            allowCoupon: true,
            classDiscountItems: [],
            athleteDiscountItems: []
        };
        this.openDiscountPlanDialog(discountPlan)
    }
};

SubProgramEditDialog.prototype.editDiscountPlanButtonClickHandler = function () {
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        var discountPlan = this.discountPlanCombo.getSelectedItem();
        if (!discountPlan) return;
        discountPlan.key = Util.newUUID();
        this.openDiscountPlanDialog(discountPlan)
    }
};

SubProgramEditDialog.prototype.openDiscountPlanDialog = function (discountPlanData) {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        var discountPlanOptions = {
            discountPlan: discountPlanData,
            discountConfiguration: {
                discountApplicationTypes: window.LOGIN_INFO.discountApplicationTypes,
                discountOrderTypes: window.LOGIN_INFO.discountOrderTypes
            }
        };
        new DiscountPlanDialog().callback(function (discountData) {
            if (discountData) thiz.renderDiscountPlanCombo();
        }).open(discountPlanOptions);
    }
};

SubProgramEditDialog.prototype.renderDiscountPlanCombo = function () {
    var thiz = this;
    $classAdminService.getDiscountPlans(function (discountPlans) {
        thiz.discountPlans = discountPlans.result;
        thiz.discountPlanCombo.setItems([null].concat(thiz.discountPlans), true);
        thiz.discountPlanCombo.selectItemByKey("id", thiz.discountPlanCombo.getSelectedItem().id);
    }, function (err) {})
};

SubProgramEditDialog.prototype.discountPlanChangedHandler = function () {
    var selectedItem = this.discountPlanCombo.getSelectedItem();
    if (selectedItem) {
        this.editDiscountPlanButton.removeAttribute("disabled");
    } else {
        this.editDiscountPlanButton.setAttribute("disabled", "disabled");
    }
};

SubProgramEditDialog.prototype.policyComboChangedHandler = function () {
    var selectedItem = this.policyCombo.getSelectedItem();
    if (selectedItem) {
        this.editPolicyButton.removeAttribute("disabled");
    } else {
        this.editPolicyButton.setAttribute("disabled", "disabled");
    }
};


SubProgramEditDialog.prototype.newPolicyButtonClickHandler = function () {
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        var policy = {key: Util.newUUID()};
        this.openPolicyDialog(policy)
    }
};

SubProgramEditDialog.prototype.editPolicyButtonClickHandler = function () {
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
        var policy = this.policyCombo.getSelectedItem();
        if (!policy) return;
        policy.key = Util.newUUID();
        this.openPolicyDialog(policy)
    }
};

SubProgramEditDialog.prototype.openPolicyDialog = function (policyData) {
    var thiz = this;
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowStartDropDates) {
        new StartDropPolicyDialog().callback(function (data) {
            if (data) {
                $classStartDropDateService.getAllStartDropDatePolicy(function (policies) {
                    thiz.startDropPolicies = policies.result;
                    thiz.policyCombo.setItems([null].concat(thiz.startDropPolicies), true);
                    thiz.policyCombo.selectItemByKey("id", data.id, true);
                }, function (err) {});
            }
        }).open({policyData: policyData});
    }
};

SubProgramEditDialog.prototype.onShown = function () {
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        ClientPropertyUtil.invalidateElements(this.container, cm.ModuleData.__propertySpec);
    }.bind(this));
}

SubProgramEditDialog.prototype.allowedAnnualKitsChangedHandler = function () {
    Dom.toggleClass(this.annualKitsCategoryWrapper, "Inapplicable", !this.allowedAnnualKits.checked);
};

SubProgramEditDialog.prototype.annualKitsCategoryChangedHandler = function () {
    var category = this.annualKitsCategoryCombo.getSelectedItem();
    if (!category) return;

    var next = () => {
        Dom.toggleClass(this.infoTipContainer, "Showed", !this.validCategory);
        ValidationManager.run(this.categoryComboRule);
    };

    $promoKitAPIService.validatePromoKitCategory(category.id, function () {
        this.validCategory = true;
        next();
    }.bind(this), function (error) {
        this.provider.getMessage = function (target) {
            return error.message;
        };
        this.validCategory = false;
        next();
    }.bind(this));
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/SubProgramMultiEditDialog.js";

function SubProgramMultiEditDialog() {
    Dialog.call(this);

    this.programAssociationCombo.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.title;
    };
    this.regFeePerFamilyCombo.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.regFeePerStudentCombo.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.lessonCouponCombo.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.middleNameRequiredCombo.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.showOpenSlotCombo.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
    this.useUnappliedPaymentCombo.renderer = function (item, selected) {
        if(!item) return "--Not Change--";
        return "" + item.name;
    };
}

__extend(Dialog, SubProgramMultiEditDialog);

SubProgramMultiEditDialog.prototype.setup = function() {
    var thiz = this;
    this.title = "Multi-Edit Sub Program";
    $classMetaService.getSubProgramConfiguration(function(res) {
        thiz.filters = res;
        thiz.renderSubProgramMultiEditDialog();
    }, function(err) {});
};

SubProgramMultiEditDialog.prototype.renderSubProgramMultiEditDialog = function () {
    var thiz = this;
    this.renderCombo(this.programAssociationCombo, this.filters.programs);
    this.renderCombo(this.regFeePerFamilyCombo, this.getYesNoOptions());
    this.renderCombo(this.regFeePerStudentCombo, this.getYesNoOptions());
    this.renderCombo(this.lessonCouponCombo, this.getYesNoOptions());
    this.renderCombo(this.middleNameRequiredCombo, this.getYesNoOptions());
    this.renderCombo(this.showOpenSlotCombo, this.getYesNoOptions());
    this.renderCombo(this.useUnappliedPaymentCombo, this.getYesNoOptions());

    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassPaymentPlan) {
        Dom.hide(this.couponWrapper);
        this.middleNameRequiredWrapper.style["margin-left"] = 0;
        this.couponMidNameWrapper.appendChild(this.showSlotWrapper);
    } else {
        Dom.hide(this.useUnappliedPaymentWrapper);
    }
};

SubProgramMultiEditDialog.prototype.getYesNoOptions = function () {
    return [{id: 1, name: "Yes"}, {id: 0, name: "No"}];
};

SubProgramMultiEditDialog.prototype.renderCombo = function (combo, items) {
    var list = items;
    if(!list) list = [];
    list.unshift(null);
    combo.setItems(list);
};

SubProgramMultiEditDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.saveSubProgram();
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};

SubProgramMultiEditDialog.prototype.saveSubProgram = function() {
    var subProgramData = this.getSubProgramData();
    if(subProgramData) this.close(subProgramData);
};

SubProgramMultiEditDialog.prototype.showErrorMessage = function (message, inputToFocus) {
    var thiz = this;
    Dialog.error(message, "", function() {
        if(inputToFocus) {
            window.setTimeout(function() {
                inputToFocus.focus();
            }, 200);
        }
    });
};

SubProgramMultiEditDialog.prototype.getSubProgramData = function() {
    var programId = -1;
    if(this.programAssociationCombo.getSelectedItem()) programId = this.programAssociationCombo.getSelectedItem().id;
    var data = {
        programId: programId,
        annualRegAccount: this.regFeePerFamilyCombo.getSelectedItem() ? this.regFeePerFamilyCombo.getSelectedItem().id : -1,
        annualRegStudent: this.regFeePerStudentCombo.getSelectedItem() ? this.regFeePerStudentCombo.getSelectedItem().id : -1,
        lessonCoupon: this.lessonCouponCombo.getSelectedItem() ? this.lessonCouponCombo.getSelectedItem().id : -1,
        middleNameRequired: this.middleNameRequiredCombo.getSelectedItem() ? this.middleNameRequiredCombo.getSelectedItem().id : -1,
        useUnappliedpayment: this.useUnappliedPaymentCombo.getSelectedItem() ? this.useUnappliedPaymentCombo.getSelectedItem().id : -1
    };
    var hideSlot = -1;
    if(this.showOpenSlotCombo.getSelectedItem()) {
        if(this.showOpenSlotCombo.getSelectedItem().id == 0) {
            hideSlot = 1;
        } else {
            hideSlot = 0;
        }
    }
    data.hideSlot = hideSlot;
    return data;
};

SubProgramMultiEditDialog.prototype.onShown = function () {
    widget.__ensureNamespaceLoaded("cm", function (cm) {
        ClientPropertyUtil.invalidateElements(this.container, cm.ModuleData.__propertySpec);
    }.bind(this));
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/ZoneComponent.js";

function ZoneComponent() {
    BaseTemplatedWidget.call(this);
    this.domAttached = false;
    this.currentKeyword = "";
    this.bind("click", this.loadDataTable.bind(this, false), this.btnSearch);
    this.bind("keyup", function(event) {
        if (event.keyCode == 13) this.loadDataTable();
    }, this.itemSearchKeyword);
    this.bind("click", this.onDropdownButtonHandlerClick, this.editDropdownButton);
    this.bind("click", this.onEditDropdownMenuClick, this.groupMenuAction);
    this.bind("click", this.editZone.bind(this, []), this.btnAddZone);
    this.bind("click", this.dataTableClickHandle, this.dataTable);
}
__extend(BaseTemplatedWidget, ZoneComponent);

ZoneComponent.prototype.onAttached = function() {
    var thiz = this;
    window.setTimeout(function() {
        if (thiz.domAttached) return;
        thiz.domAttached = true;
        thiz.setupDataTable();
    }, 100);
}

ZoneComponent.prototype.onDropdownButtonHandlerClick = function (event) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
}

ZoneComponent.prototype.onEditDropdownMenuClick = function(event) {
    var thiz = this;
    this.paginator.getSelectedItems(function(items) {
        var ids = items.map(function(pv) {
            return pv.id;
        });
        if (ids.length == 0) return;
        switch (Dom.getAttributeAsString(event.target, "action")) {
            case "edit":
            thiz.editZone(ids);
            break;
            case "delete":
            thiz.deleteZone(ids);
            break;
            case "undelete":
            break;
            default:
            break;
        }
        thiz.editDropdownMenu.hide();
    });
}

ZoneComponent.prototype.editZone = function(ids) {
    var thiz = this;
    var editDialog = new ZoneEditDialog().callback(function(response) {
        if (response) {
            thiz.loadDataTable(true);
        }
    });
    editDialog.open(ids);
}

ZoneComponent.prototype.setupDataTable = function() {
    var thiz = this;
    var colName = new DataTable.GenericColumn("Zone", function (data) {
        return "<a class=\"ZoneName\">" + data.name + "</a>";
    }).sortable("myname").width("1*");
    colName.getContentTitle = function (data, row, col) {
        return "" + data.name;
    }
    this.dataTable.column(colName);
    this.dataTable.column(new DataTable.PlainTextColumn("Description", function (data) {
        return (data.desc);
    }).sortable("descr").width("2*"));
    this.dataTable.selector(true, false);
    this.dataTable.setDefaultSelectionHandler({
        run: function (link) {
        }
    });
    this.dataTable.addListener({
        onSelectionChanged: function (table, fromUserAction) {
            thiz.editDropdownButton.disabled = thiz.dataTable.getSelectedItems().length ? false : true;
        }
    });
    this.dataTable.disabledCheckBoxWhenCheckAll(false);
    this.dataTable.setup();
    this.setupPaginator();
}

ZoneComponent.prototype.setupPaginator = function() {
    var thiz = this;

    widget.__ensureNamespaceLoaded("util", function(util) {
        var config = util.paginationUtil.setupPaginatorConfig();

        config.onPageLoaded = function(p, count) {
            util.paginationUtil.setPaginationSummary(thiz.currentPageDetail, p.totalItems, p.currentPage, p.pageSize, count);
        };

        util.paginationUtil.setupPaginatorInstance(thiz.paginator, thiz.dataTable, thiz.createDataSource(), config);
    });
};

ZoneComponent.prototype.createDataSource = function() {
    var thiz = this;
    return {
        order: {
            propertyName: "myname",
            asc: true
        },
        loadPage: function (pageIndex, pageSize, handler, failed) {
            var order = {
                name: this.order.propertyName,
                asc: this.order.asc,
                ignoreCase: true
            };
            $classMetaService.searchLessonPZone(order, pageIndex, pageSize, thiz.currentKeyword, function(data) {
                thiz.data = data;
                thiz.totalDisplay.textContent = (data.count > 1 ? data.count + " Zones" : data.count + " Zone");
                handler(data.result, data.count);
            }, function(error) {
                console.log("Request data error!", error);
            });
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
}

ZoneComponent.prototype.loadDataTable = function(forced) {
    if (forced) {
        this.itemSearchKeyword.value = "";
        this.currentKeyword = "";
    } else {
        var keyword = this.itemSearchKeyword.value.trim();
        if (this.currentKeyword == keyword) return;
        this.currentKeyword = keyword;
    }
    this.paginator.refresh();
}

ZoneComponent.prototype.deleteZone = function(ids) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete " + ids.length + " selected item(s)?", "",
        "Yes", function() {
            $classMetaService.deleteLessonPZones(ids, function(deleted) {
                SnackBar.show("" + (deleted ? deleted.length : 0) + " item(s) were deleted");
                if (!deleted || deleted.length < ids.length) {
                    var restList = thiz.dataTable.getSelectedItems().filter(function(item) {
                        return deleted.indexOf(item.id) == -1;
                    });
                    restList = restList.map(function(item) {
                        return item.name;
                    });
                    var message = "\"" + restList.join("\", \"") + (restList.length > 1 ? "\" are being used" : "\" is being used");
                    Dialog.alert("" + restList.length + " item(s) can not delete", message);
                }
                thiz.loadDataTable(true);
            }, function(error) {
                console.log("Fail to delete Zone item(s) with error:", error);
            });
        },
        "Cancel", null);
}

ZoneComponent.prototype.dataTableClickHandle = function(event) {
    if (Dom.hasClass(event.target, "ZoneName")) {
        var rowData = DataTable.getRowData(event.target);
        if (rowData && rowData.id) this.editZone([rowData.id]);
    }
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/meta/ZoneEditDialog.js";

function ZoneEditDialog() {
    ModificationWatchDialog.call(this);
    this.updatedList = [];
    this.current = 0;
    this.hasDataUpdated = false;
    this.bind("click", this.onPrevButtonClick, this.buttonPrev);
    this.bind("click", this.onNextButtonClick, this.buttonNext);
}
__extend(ModificationWatchDialog, ZoneEditDialog);

ZoneEditDialog.prototype.setup = function(ids) {
    if (ids && ids.length > 0) {
        this.updatedList = ids;
        this.title = "Edit Zone";
        if (ids.length > 1) {
            Dom.addClass(this.indexContainer, "Activate");
        }
        this.current = 0;
        this.loadZoneData(ids[0]);
    } else {
        this.title = "Create Zone";
    }
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.itemName, "Please input 'Zone Name'");
}

ZoneEditDialog.prototype.onPrevButtonClick = function() {
    if (this.current > 0) {
        this.current --;
        this.loadZoneData(this.updatedList[this.current]);
        if (this.current == 0) this.buttonPrev.setAttribute("disabled", true);
        this.buttonNext.removeAttribute("disabled");
    }
}

ZoneEditDialog.prototype.onNextButtonClick = function() {
    if (this.current < this.updatedList.length - 1) {
        this.current ++;
        this.loadZoneData(this.updatedList[this.current]);
        if (this.current == this.updatedList.length - 1) this.buttonNext.setAttribute("disabled", true);
        this.buttonPrev.removeAttribute("disabled");
    }
}

ZoneEditDialog.prototype.loadZoneData = function(id) {
    var thiz = this;
    $classMetaService.getLessonPZoneById(id, function(data) {
        if (data) {
            thiz.displayIndex.textContent = String.format("Zone {0} of {1}", (thiz.current + 1), thiz.updatedList.length);
            thiz.data = data;
            thiz.itemName.value = data.name;
            thiz.itemDesc.value = data.desc;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues());
            thiz.clearUnsavedNotify();
        }
    }, function(error) {
        console.log("Fail to get zone: ", error);
    });
}

ZoneEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
}

ZoneEditDialog.prototype.getCurrentInputValues = function() {
    return {
        id: this.data ? this.data.id : 0,
        name: this.itemName.value,
        desc: this.itemDesc.value
    }
}

ZoneEditDialog.prototype.save = function(callback) {
    var thiz = this;
    if(!ValidationManager.run(this.validationRules)) return false;
    var zone = this.getCurrentInputValues();
    if (this.updatedList.length > 0 && zone.id > 0) {
        $classMetaService.updateLessonPZone(zone, function(data) {
            SnackBar.show("Zone was saved successfully");
            thiz.hasDataUpdated = true;
            thiz.setSnapshotInputValues(thiz.getCurrentInputValues);
            thiz.clearUnsavedNotify();
            if (callback) callback(zone);
        }, function(error) {
            console.log("Fail to save lesson zone with error", error);
        });
    } else {
        $classMetaService.createLessonPZone(zone, function(data) {
            SnackBar.show("Zone was saved successfully");
            thiz.hasDataUpdated = true;
            zone.id = data;
            if (callback) callback(zone);
        }, function(error) {
            console.log("Fail to save lesson zone with error", error);
        });
    }
}

ZoneEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {
                thiz.close(this.hasDataUpdated);
                return false;
            }
        }];
    }
    return [
        {
            type: "accept", title: "Save",
            run: function () {
                thiz.save(function(data) {
                    if (thiz.updatedList.length < 2) thiz.close(data);
                });
                return false;
            }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        }
    ]
}


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/AccountManageMemberWidget.js";

function AccountManageMemberWidget(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
    this.LOGIN_INFO = options.LOGIN_INFO;
    var thiz = this;
    this.busy = false;
    this.ACTIVE_MEMBER_STATUS = 20;
    this.expandAnnualRegFeeControl = true;
    this.lessonClasses = {};
    this.filterMap = {};
    this.dataView._convertFilterMap = function (valueMap) {
        var map = {};
        if (valueMap) {
            for (var name in valueMap) map[name] = valueMap[name];
        }
        map.ownerAccountId = "" + thiz.options.accountInfo.id;
        return map;
    };
    this.dataView.onSpecificationLoaded = function(spec) {
        if (!thiz._canViewRegistrationFinancialInfo()) {
            if (!spec.disabledColumns) spec.disabledColumns = [];
            spec.disabledColumns.push("paymentPlanTotalAmount");
        }
        thiz.initFilterMapping(spec.filters);
    };
    this.dataView.isSettingColumnApplicable = function (column) {
        return !(thiz.dataView.spec.disabledColumns.find(function (c) {
            return c == column.id;
        }));
    };

    this.bind("p:PageLoaded", function () {
        var summary = this.dataView.lastResultExtra.summary;
        thiz.totalMember.innerText = this.dataView.getDiscoveredTotalItems();
        thiz.totalEntered.innerText = summary.totalEntered;
        thiz.totalWaiting.innerText = summary.totalWaiting;
        thiz.totalCanceled.innerText = summary.totalCanceled;
        thiz.totalFuture.innerText = summary.totalFuture;
    }, this.dataView);
    this.dataView.setDefaultSelectionHandler(this.dataViewClickedHandler.bind(this));
    this.bind("p:PopupHidden", function () {
         if (thiz._lastFocusedLink) Dom.removeClass(thiz._lastFocusedLink, "Focused");
    }, this.paymentPlanPopup);
    this.bind("p:PopupHidden", function () {
         if (thiz._lastFocusedLink) Dom.removeClass(thiz._lastFocusedLink, "Focused");
    }, this.slotInstancePopup);
    this.bind("p:PopupHidden", function () {
         if (thiz._lastFocusedLink) Dom.removeClass(thiz._lastFocusedLink, "Focused");
    }, this.costumesPopup);
    this.bind("p:ItemSelected", this.dataViewComboChangedHandler, this.dataView);
    this.bind("click", function(event) {
        if (Dom.hasClass(thiz.btnToggle.parentNode, "Expanded")) {
            Dom.removeClass(thiz.btnToggle.parentNode, "Expanded");
        } else {
            Dom.addClass(thiz.btnToggle.parentNode, "Expanded");
        }
    }, this.btnToggle);
    this.bind("p:ValueUpdated", function() {
        thiz.updateAccountAnnualRegPaidDate(thiz.account, thiz.accountPaidDatePicker.getDate());
    }, this.accountPaidDatePicker.node());

    this.bind("click", function(event) {
        Dialog.confirm(
            "Are you sure you want to remove the Annual Fee Date?",
            "Removing the Annual Fee Date will require the Annual Fee to be paid in the next registration.",
            "Delete",
            function () {
                thiz.updateAccountAnnualRegPaidDate(thiz.account, null);
            },
            "Cancel"
        );
    }, this.accountClearPaidDate);
    if (!thiz._canClearPaidDate()) Dom.hide(this.accountClearPaidDate);

    this.bind("p:ValueUpdated", this.dataViewStartDropDateChangedHandler, this.dataView);
    this.memberAnnualPaidRepeater.populator = function(member, binding, node, index) {
        if (member.fake) {
            Dom.addClass(node, "Fake");
            return;
        }
        binding._data = member;
        binding.memberDisplayName.innerText = member.memberFullName;
        binding.memberDisplayName.title = member.memberFullName;
        var isNotPaid = thiz.isNotPaid(member.dtLregfee);
        binding.memberPaidDateValue.innerText = (isNotPaid ? "Not Paid" : FormatUtil.formatDate(member.dtLregfee, "date_standard", "local"));
        if (!isNotPaid) {
            binding.memberPaidDatePicker.setDate(member.dtLregfee);
            Dom.toggleClass(binding.memberPaidDateValue.parentNode, "Expired", member.annualRegDateExpired == true);
        }
        Dom.toggleClass(binding.memberDisplayName.parentNode, "NotPaid", isNotPaid);
        Dom.registerEvent(binding.memberPaidDatePicker.node(), "p:ValueUpdated", function(event) {
            thiz.updateMemberAnnualRegPaidDate(binding._data, binding.memberPaidDatePicker.getDate());
        });
        Dom.registerEvent(binding.memberClearPaidDate, "click", function(event) {
            Dialog.confirm(
                "Are you sure you want to remove the Annual Fee Date?",
                "Removing the Annual Fee Date will require the Annual Fee to be paid in the next registration.",
                "Delete",
                function () {
                    thiz.updateMemberAnnualRegPaidDate(binding._data, null);
                },
                "Cancel"
            );
        });


        Dom.toggleClass(binding.memberDisplayName.parentNode, "NotPaid", isNotPaid);
        // Dom.toggleClass(thiz.accountDisplayName.parentNode, "NotPaid", isNotPaid);
        if (!thiz._canClearPaidDate()) Dom.hide(binding.memberClearPaidDate);
    };
    this.dataView.registerActions([{
        title: "Move Class...",
        run: function (registrations) {
            if (!thiz._canMoveReenrollClass()) return;
            var memberMap = registrations.reduce(function(a, c) {
                if (!a[c.member_id]) a[c.member_id] = 1;
                else a[c.member_id] += 1;
                return a;
            }, {});
            for (var memId in memberMap) {
                if (memberMap[memId] > 1) {
                    Dialog.error("Moving registrations of the same member to a single class is not allowed. Please don't select each member more than once.");
                    return;
                }
            }
            for (var i = 0; i < registrations.length; i++) {
                if (registrations[i].canceled) {
                    Dialog.error("Moving inactive registrations is not allowed. Please select only active registrations and try again");
                    return;
                }
            }
            new ClassSelectorDialog().callback(function(toClass) {
                console.log("# selected class:", toClass);
                if (!toClass) return;
                thiz.openClassAddToolDialog(registrations, toClass);
            }).open(registrations);
        },
        visible: function(count, dataView) {
            return thiz._canMoveReenrollClass();
        }.bind(this),
        applicable: function (count, dataView) {
            return count > 0;
        }
    },
    {
        title: "Re-enroll...",
        run: function (registrations) {
            thiz.reactiveRegistration(registrations);
        },
        visible: function(count, dataView) {
            return thiz._canMoveReenrollClass();
        }.bind(this),
        applicable: function (count, dataView) {
            return count > 0;
        }
    }], "Actions...");
    this.dataView.registerCustomRenderer("sex", function (data, value) {
        return {
            _name: "span",
            _text: data.memberGender || ""
        };
    });
    this.dataView.registerCustomRenderer("waiting", {
        renderer: function(data, value) {
            var wrapper = Dom.newDOMElement({_name: "span"});
            thiz.getClassDetail(data.class_id).then(function(classInfo) {
                var status = (!data.canceled && data.waiting) ? "Waiting" : ((data.canceled || thiz.isDropDatePassed(data))? "Inactive" : "Active");
                status = (status == "Active" && thiz.isFutureReg(classInfo, data)) ? "Future" : status;

                var _children = [];
                if (data.waiting && (data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key)) {
                    _children.push({
                        _name: "icon",
                        "class": "alert-circle InfoLink PaymentPending",
                        "message": ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.msg
                    });
                } else if (data.canceled && (data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.REJECTED.key)) {
                    _children.push({
                        _name: "icon",
                        "class": "alert-circle InfoLink PaymentRejected",
                        "message": ClassUtils.PAYMENT_AUTHORIZED_STATUS.REJECTED.msg
                    });
                } else if (data.memberAgreementStatus == "REQUIRED_NOT_SIGNED") {
                    _children.push({
                        _name: "icon",
                        "class": "alert-circle RequiredNotSigned",
                        "message": "A required agreement needs to be signed"
                    });
                } else {
                    if (data.memberAgreementStatus == "OPTIONAL_NOT_SIGNED") {
                        _children.push({
                            _name: "icon",
                            "class": "alert-circle OptionalNotSigned",
                            "message": "An optional agreement has not been signed"
                        });
                    }
                }
                _children.push({
                    _name: "span",
                    class: status,
                    _text: status
                });
                var node = {
                    _name: "vbox",
                    _children: [
                        {
                            _name: "hbox",
                            _children: _children
                        }
                    ]
                };

                if (data.hasTransferred) {
                    node._children.push({
                        _name: "hbox",
                        _children: [
                            {
                                _name: "hbox",
                                class: "TransferredBox",
                                _children: [
                                    {
                                        _name: "span",
                                        class: "TransferredLabel",
                                        _text: "Transferred"
                                    },
                                    {
                                        _name: "icon",
                                        class: "InfoLink TransferredActionLink  arrow-down-drop-circle"
                                    }
                                ]
                            }
                        ]
                    });
                }

                wrapper.appendChild(Dom.newDOMElement(node));
            });
            return wrapper;
        },
        useDOMNode: true
    });
    this.dataView.registerCustomRenderer("class_title", function (data, value) {
        return {
            _name: "vbox",
            class: "ClassInfo",
            _children: [
                {_name: "span", _text: value}
                // {_name: "span", _text: data.session_name},
                // {_name: "span", _text: data.skills}
            ]
        }
    });

    this.dataView.registerCustomRenderer("slot", {
        renderer: function (data, value) {
            if (thiz._canChangeSlotPaymentPlanStartDropDate()) {
                var wrapper = document.createElement("hbox");
                thiz.getClassDetail(data.class_id).then(function(classInfo) {
                    var combo = new ComboManager();
                    combo.renderer = function (data) {
                        if (!data) return "";
                        var displayText = "Reg Slot #" + (data.slot + 1) + " | " + data.slotRegister
                            + "/" + (data.slotOpen == 99999 ? "No Limit" : data.slotOpen) + " Reg"
                            + " | " + data.slotTimes.join(",");

                        return displayText;
                    };
                    combo.getDisplayValue = function (data) {
                        return (data ? "#" + (data.slot + 1) : "");
                    };

                    var slotItems = Util.clone(classInfo.slots);
                    slotItems.sort(function(a, b) {
                        return (a.slot > b.slot ? 1 : -1);
                    });
                    var filteredSlots = slotItems.filter(function(item) {return item.slot == value});
                    slotItems = (filteredSlots.length == 0 && data.canceled) ? [null].concat(slotItems) : slotItems;
                    combo.setItems(slotItems);
                    combo.selectItemByKey("slot", value, true);

                    var isWaitPaid = thiz.isWaitPaid(data);
                    if (data.canceled || isWaitPaid) combo.setDisabled(true);
                    if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                        combo.setDisabled(true);
                    }
                    wrapper.appendChild(combo.node());
                    var infoLink = Dom.newDOMElement({
                        _name: "span",
                        class: "InfoLink SlotDetail" + (filteredSlots.length == 0 ? " Disabled" : ""),
                        _children: [{_name: "icon", class: "information"}]
                    });
                    wrapper.appendChild(infoLink);
                });
                return wrapper;
            } else {
                var wrapper = Dom.newDOMElement({_name: "hbox", class: "InfoLink SlotDetail"});
                thiz.getClassDetail(data.class_id).then(function(classInfo) {
                    if (classInfo.slots.filter(function(item) { return item.slot == value }).length > 0) {
                        wrapper.appendChild(Dom.newDOMElement({_name: "span", class: "DisplayValue", _text: "#" + (value + 1)}));
                        wrapper.appendChild(Dom.newDOMElement({_name: "icon", class: "information"}));
                    }
                });
                return wrapper;
            }
        },
        useDOMNode: true
    });

    this.dataView.registerCustomRenderer("start_drop_date_policy_start_date", {
        renderer: function (data, value) {
            var wrapper = Dom.newDOMElement({_name: "vbox", class: "StartDropDateContainer"});
            thiz.getClassDetail(data.class_id).then(function(classInfo) {
                console.log("# classInfo: ", data.class_id, classInfo.startDropDatePolicyId, classInfo.subProgStartDropDatePolicyId);
                if (!classInfo) return;
                if (!classInfo.editableSddStartDateAfterReg && !classInfo.editableSddDropDateAfterReg
                        && !data.start_drop_date_policy_start_date && !data.start_drop_date_policy_drop_date) return;
                var classTimezoneProvider = {
                    getTimezoneId: function () {
                        return classInfo.timezoneId;
                    },
                    getName: function () {
                        return "Class time zone";
                    }
                };

                var startDatePicker = new DateTimePicker();
                startDatePicker.setDate(value);
                var startDateWrapper = Dom.newDOMElement({
                    _name: "hbox",
                    class: "StartDropDatePolicy StartDate",
                    _children: [{ _name: "label", _text: "S:"}]
                });

                startDatePicker.setCustomTimezoneProvider(classTimezoneProvider);
                startDatePicker.setMinDate(ClassUtils.transformToTimeZone(classInfo.minSddStartDate, classInfo.timezoneId));
                startDatePicker.setMaxDate(ClassUtils.transformToTimeZone(classInfo.maxSddStartDate, classInfo.timezoneId));
                if (!classInfo.editableSddStartDateAfterReg) startDatePicker.setEnabled(false);
                startDateWrapper.appendChild(startDatePicker.node());
                wrapper.appendChild(startDateWrapper);

                var dropDatePicker = new DateTimePicker();
                dropDatePicker.setDate(data.start_drop_date_policy_drop_date);
                var dropDateWrapper = Dom.newDOMElement({
                    _name: "hbox",
                    class: "StartDropDatePolicy DropDate",
                    _children: [{ _name: "label", _text: "D:"}]
                });
                dropDatePicker.setCustomTimezoneProvider(classTimezoneProvider);
                dropDatePicker.setMinDate(ClassUtils.transformToTimeZone(classInfo.minSddDropDate, classInfo.timezoneId));
                dropDatePicker.setMaxDate(ClassUtils.transformToTimeZone(classInfo.maxSddDropDate, classInfo.timezoneId));
                if (!classInfo.editableSddDropDateAfterReg || !thiz._canUpdateStartDropDate()) dropDatePicker.setEnabled(false);
                dropDateWrapper.appendChild(dropDatePicker.node());
                wrapper.appendChild(dropDateWrapper);
            });
            return wrapper;
        },
        useDOMNode: true
    });
    this.dataView.registerCustomRenderer("dt_created", function (data, value) {
        return {
            _name: "span",
            _text: FormatUtil.formatDate(value, "date_standard", "local")
        };
    });
    this.dataView.registerCustomRenderer("payment_plan_name", {
        renderer: function (data, value) {
            var wrapper = document.createElement("hbox");
            if (!data.payment_plan_id) return wrapper;
            if (thiz._canChangeSlotPaymentPlanStartDropDate()) {
                var combo = new ComboManager();
                combo.renderer = function(data) {
                    return data.name;
                };
                thiz.getClassDetail(data.class_id).then(function(classInfo) {
                    combo.setItems(Util.clone(classInfo.paymentPlans));
                    var paymentPlanId = data.payment_plan_id;
                    combo.selectItemById(paymentPlanId);
                });
                var isWaitPaid = thiz.isWaitPaid(data);
                if (data.canceled || isWaitPaid) combo.setDisabled(true);
                if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                    combo.setDisabled(true);
                }
                wrapper.appendChild(combo.node());
                if (thiz._canViewRegistrationFinancialInfo()) {
                    wrapper.appendChild(Dom.newDOMElement({
                        _name: "span",
                        class: "InfoLink PaymentPlanDetail",
                        _children: [{_name: "icon", class: "information"}]
                    }));
                }
            } else {
                var infoLink = Dom.newDOMElement({
                    _name: "hbox",
                    class: "InfoLink PaymentPlanDetail",
                    _children: [
                        {_name: "span", class: "DisplayValue", _text: value, title: value },
                        thiz._canViewRegistrationFinancialInfo() ? {_name: "icon", class: "information"} : undefined
                    ]
                });
                return infoLink;
            }
            return wrapper;
        },
        useDOMNode: true
    });
    this.dataView.registerCustomRenderer("paymentPlanTotalAmount", function(data, value) {
        var totalFee = data.addl_fee_amt + data.fee_class_amt + data.fee_reg_account_amt + data.fee_reg_mem_amt
                + data.fee_reg_year_account_amt + data.fee_reg_year_student_amt + data.fee_tax_amt;
        var discount = data.disc_mcl_amt + data.disc_mstd_amt + data.lesson_coupon_amt;
        return {
            _name: "span",
            _text: (totalFee - discount > 0) ? Util.toCurrency(totalFee - discount) : ""
        };
    });
    this.dataView.registerCustomRenderer("actions", this.dataView.createActionColumnHandler(
        {
            icon: "arrow-right-bold-circle",
            title: "Move Class",
            role: "primary",
            applicable: function(data) {
                if (!thiz._canMoveReenrollClass()) {
                    return false;
                }
                if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                    return false;
                }
                if (!data.dt_dob) return false;
                return !data.canceled;
            }.bind(this),
            run: function (data, callback, event) {
                if (!thiz._canMoveReenrollClass()) return;
                new ClassSelectorDialog().callback(function(dest) {
                    if (!dest) return;
                    thiz.openClassAddToolDialog([data], dest);
                }).open([data]);
            }
        },
        {
            spec: function (data, value) {
                var isWaitPaid = thiz.isWaitPaid(data);
                var title = "Pay & Approve";
                var icon = "checkbox-marked-circle";
                if (!data.canceled && !data.paid && !data.waiting) {
                    title = "Pay";
                    icon = "cash-usd";
                }
                if (isWaitPaid) {
                    title = "Open Billing";
                    icon = "cash-usd";
                }

                var disabled = false;
                if (!data.payment_plan_id || data.paid || data.canceled
                    || (isWaitPaid && !thiz._canViewBilling())
                    || (!isWaitPaid && !thiz._canApproveWaitlistRegistration())
                    || (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key)) {
                    disabled = true;
                }
                var s = {
                    _name: "button",
                    "title": title,
                    "class": "ActionButton IconOnly" + ((!data.canceled && !data.paid && !data.waiting) ? " Alert" : ""),
                    "action-role": "primary",
                    _children: [
                        {_name: "icon", "class": icon}
                    ]
                };
                if (disabled) s.disabled = disabled;
                /* if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                    s.disabled = true;
                } */
                return s;
            }.bind(this),
            run: function(data, callback, event) {
                var isWaitPaid = thiz.isWaitPaid(data);
                if (!data.payment_plan_id || data.paid || data.canceled
                    || (isWaitPaid && !thiz._canViewBilling())
                    || (!isWaitPaid && !thiz._canApproveWaitlistRegistration())
                    || (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key)) return;
                if (isWaitPaid) {
                    thiz.options.moveToBillingSummaryTab();
                } else {
                    thiz.payAndApprove.apply(thiz, arguments);
                }
            }
        },
        {
            spec: function (data, value) {
                var title = "Cancel Registration";
                var icon = "close";
                var role = "danger";
                var disabled = (!data.payment_plan_id || !thiz._canCancelRegsitration());
                if (data.canceled) {
                    title = "Re-enroll";
                    icon = "restart";
                    role = "primary";
                    disabled = !thiz._canMoveReenrollClass() || !data.dt_dob;
                } else if (data.waiting){
                    disabled = true;
                }
                var s = {
                    _name: "button",
                    "title": title,
                    "class": "ActionButton IconOnly",
                    "action-role": role,
                    _children: [
                        {_name: "icon", "class": icon}
                    ]
                };
                if (disabled) s.disabled = true;
                if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                    s.disabled = true;
                }
                return s;
            }.bind(this),
            run: function(data, callback, event) {
                if (!data.payment_plan_id) return;
                if (data.canceled) {
                    thiz.reactiveRegistration.call(thiz, [data], callback, event);
                } else if (!data.waiting) {
                    thiz.cancelRegistration.apply(thiz, arguments);
                }
            }
        }
    ));

    this.dataView.registerCustomRenderer("calculatedAge", function (data, value) {
        var ageText = "";
        if (value > 0) {
            ageText = data.calculatedAgeText;
        }
        return {
            _name: "span",
            _text: ageText
        };
    });
    this.dataView.registerCustomRenderer("costumeIds", function (data, value) {
        if (value && value.length) {
            var text = value.length + " item" + (value.length == 1 ? "" : "s");
            return {
                _name: "hbox",
                class: "CostumesDetail InfoLink",
                _children: [
                    {_name: "span", class: "DisplayValue", _text: text, title: text },
                    {_name: "icon", class: "information"}
                ]
            };
        }
        return "";
    });

    this.slotInstancePopup.popupOpacity = 0.9999;
    this.bind("click", function () {
        thiz.slotInstancePopup.hide();
    }, this.slotInstancePopupArrow);
    this.slotInstancePopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        }
        thiz.slotInstanceBackgroundBox.onSizeChanged();
    }

    InfoTip.install(this.dataView.node(), {
        match: function (node) {
            return Dom.hasClass(node, "alert-circle");
        },
        getMessage: function (target) {
            return Dom.newDOMElement({
                _name: "div",
                "class": "SignedHintText",
                _html: target.getAttribute("message")
            })
        }
    });

    this.isWaitPaid = function (data) {
        var ret = (!data.waiting && !data.canceled && !data.paid && !!data.wait_paid_charge_ids);
        return ret;
    }

    var canManageAnnualKitDate = this.canManageAnnualKitDates();
    this.memberAnnualKitsRepeaterView.populator = function(data, binding, node, index) {
        var isNotApproved = thiz.isNotApproved(data.annualKitDate);
        Dom.setInnerText(binding.memberDisplayName, data.fullName);
        binding.memberDisplayName.title = data.fullName;
        Dom.setInnerText(binding.memberApprovedDateValue, isNotApproved ? "Not Approved" : FormatUtil.formatDate(data.annualKitDate, "date_standard", "local"));
        if (!isNotApproved) {
            binding.memberApprovedDatePicker.setDate(data.annualKitDate);
            Dom.toggleClass(binding.memberApprovedDateValue.parentNode, "Expired", data.annualKitDateExpired == true);
        }

        Dom.toggleClass(binding.memberDisplayName.parentNode, "NotApproved", isNotApproved);
        Dom.toggleClass(binding.memberClearApprovedDate, "Inapplicable", !canManageAnnualKitDate);
        Dom.toggleClass(binding.viewOrderDetail, "Inapplicable", !data.lastSubmittedTrackingId || !canManageAnnualKitDate);
    };

    this.bind("click", function (event) {
        Dom.toggleClass(this.annualKitToggleButton.parentNode, "Expanded", !Dom.hasClass(this.annualKitToggleButton.parentNode, "Expanded"));
    }, this.annualKitToggleButton);

    this.bind("click", function (event) {
        var target = event.target;
        var data = Dom.findUpwardForData(target, "_repeaterData");
        if (Dom.hasClass(target, "AnonId_memberClearApprovedDate")) {
            Dialog.confirm(
                "Are you sure you want to remove the Annual Kit Date?",
                "Removing the Annual Kit Date will send an Annual Kit in the next registration.",
                "Delete",
                function () {
                    thiz.updateMemberApprovedDate([data.id], null);
                },
                "Cancel"
            );
            return;
        }

        if (Dom.hasClass(target, "AnonId_viewOrderDetail")) {
            widget.__ensureNamespaceLoaded("promokit", function (promokitPkg) {
                new promokitPkg.AnnualKitOrderDetailDialog().open({ trackingId: data.lastSubmittedTrackingId });
            })
            return;
        }

    }, this.memberAnnualKitsRepeaterView.node());

    this.bind("p:ValueUpdated", function (event) {
        var target = event.target;
        var data = Dom.findUpwardForData(target, "_repeaterData");
        var approvedDate = target.__widget.getDate();
        thiz.updateMemberApprovedDate([data.id], approvedDate);
    }, this.memberAnnualKitsRepeaterView.node());
}
__extend(BaseTemplatedWidget, AccountManageMemberWidget);

AccountManageMemberWidget.prototype.onAttached = function(firstAttached) {
    var thiz = this;
    BaseWidget.invalidateResponsiveBreakpointClasses(this.node());
    this.refreshDataList = this.dataView.refreshDataList.bind(this.dataView);
    if (firstAttached) {
        window.setTimeout(function() {
            thiz.initAccountAnnualRegistration();
            thiz.dataView.boot();
            CommonEvent.listener(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED, thiz.refreshDataList);
            thiz.initMemberAnnualKits();
        }, 100);
    }
};
AccountManageMemberWidget.prototype.onDetached = function() {
    this.paymentPlanPopup.kill();
    this.slotInstancePopup.kill();
    this.costumesPopup.kill();
    CommonEvent.removeEvent(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED, this.refreshDataList);
};
AccountManageMemberWidget.prototype.initFilterMapping = function(filterMap) {
    var thiz = this;
    filterMap.forEach(function(filterObject) {
        thiz.filterMap[filterObject.fieldName] = filterObject.values;
    });
};

AccountManageMemberWidget.prototype.initAccountAnnualRegistration = function(account, paidDate) {
    if (!this.canViewAnnualRegistration()) {
        Dom.removeClass(this.btnToggle.parentNode, "Active");
        return;
    }
    Dom.addClass(this.btnToggle.parentNode, "Active");
    Dom.toggleClass(this.annualRegFeesContainer, "ReadOnly", !this._canUpdateAnnualRegFee());
    var thiz = this;
    $classAdminService.getAnnualRegByAccountId(this.options.accountInfo.id,
        function(account) {
            thiz.account = account;
            thiz.accountDisplayName.innerText = account.fullName;
            thiz.accountDisplayName.title = account.fullName;
            var isNotPaid = thiz.isNotPaid(account.dtLregfee);
            thiz.accountPaidDateValue.innerText = (isNotPaid ? "Not Paid" : FormatUtil.formatDate(account.dtLregfee, "date_standard", "local"));
            if (!isNotPaid) {
                thiz.accountPaidDatePicker.setDate(account.dtLregfee);
                Dom.toggleClass(thiz.accountPaidDateValue.parentNode, "Expired", account.annualRegDateExpired == true);
            }
            Dom.toggleClass(thiz.accountDisplayName.parentNode, "NotPaid", isNotPaid);
            var lackOfMem = account.memberList.length % 4;
            if (lackOfMem != 0) lackOfMem = 4 -lackOfMem;
            var memList = account.memberList.concat([]);
            for (var i = 0; i < lackOfMem; i++) {
                memList.push({fake: true});
            }
            thiz.memberAnnualPaidRepeater.setItems(memList);
        },
        function(error) {
            console.log("Error: fail to get Annual Registration of account");
        });
};

AccountManageMemberWidget.prototype.canViewAnnualRegistration = function() {
    return ClassAuthUtils.canViewAnnualRegistration() || this.options.accountInfo.id == this.LOGIN_INFO.accountId;
}

AccountManageMemberWidget.prototype.canViewAnnualKitDates = function() {
    return (ClassAuthUtils.canManageAnnualKitDates() || this.options.accountInfo.id == this.LOGIN_INFO.accountId) && (TEAM_INFO.isAffiliateTeam || TEAM_INFO.isOwnershipTeam);
};

AccountManageMemberWidget.prototype.canManageAnnualKitDates = function() {
    return ClassAuthUtils.canManageAnnualKitDates();
};

AccountManageMemberWidget.prototype._canMoveReenrollClass = function() {
    return ClassAuthUtils.canMoveReenrollClass(this.LOGIN_INFO);
};
AccountManageMemberWidget.prototype._canUpdateAnnualRegFee = function() {
    return ClassAuthUtils.canEditAccountMemberAnnualRegFee(this.LOGIN_INFO, this.options.accountInfo.id);
};
AccountManageMemberWidget.prototype._canClearPaidDate = function() {
    return ClassAuthUtils.canEditAccountMemberAnnualRegFee(this.LOGIN_INFO, this.options.accountInfo.id);
};
AccountManageMemberWidget.prototype._canChangeSlotPaymentPlanStartDropDate = function() {
    return ClassAuthUtils.canChangeSlotPaymentPlanStartDropDate(this.LOGIN_INFO);
};
AccountManageMemberWidget.prototype._canUpdateStartDropDate = function() {
    return this._canChangeSlotPaymentPlanStartDropDate() || this.options.accountInfo.id == this.LOGIN_INFO.accountId;
};
AccountManageMemberWidget.prototype._canCancelRegsitration = function() {
    return ClassAuthUtils.canDenyWaitlistCancelRegsitration(this.LOGIN_INFO);
};
AccountManageMemberWidget.prototype._canUpdateStartDropDate = function() {
    return this._canChangeSlotPaymentPlanStartDropDate() || this.options.accountInfo.id == this.LOGIN_INFO.accountId;
};
AccountManageMemberWidget.prototype._canViewBilling = function() {
    return ClassAuthUtils.canViewBilling(this.LOGIN_INFO);
};
AccountManageMemberWidget.prototype._canApproveWaitlistRegistration = function(data) {
    return ClassAuthUtils.canApproveWaitlistRegistration(this.LOGIN_INFO);
};
AccountManageMemberWidget.prototype._canViewRegistrationFinancialInfo = function() {
    return ClassAuthUtils.canViewClassRegistrationFinancialInfo() || this._isMyAccount();
};
AccountManageMemberWidget.prototype._isMyAccount = function() {
    return this.options.accountInfo.id == this.LOGIN_INFO.accountId;
};

AccountManageMemberWidget.prototype.isStartDateEditable = function(policy, registration) {
    if (policy == null) return false;
    var limitDate = new Date(registration.dt_registration.getTime());
    limitDate.setDate(limitDate.getDate() + policy.maxFutureRegistrationLimitDays);
    if (policy.allowParentEditStartDate && registration.allowEditStartDateWhenRegCompleted && limitDate > new Date()) {
        return true;
    }
    return false;
};
AccountManageMemberWidget.prototype.isDropDateEditable = function(policy, registration) {
    if (policy == null) return false;
    var limitDate = new Date(registration.dt_registration.getTime());
    limitDate.setDate(limitDate.getDate() + policy.maxFutureRegistrationLimitDays);
    if (policy.allowParentEditDropDate && registration.allowEditDropDateWhenRegCompleted && limitDate < new Date()) {
        return true;
    }
    return false;
};

AccountManageMemberWidget.prototype.isNotPaid = function(dd) {
    if (dd == null) return true;
    return dd.getFullYear() == 1930;
};
AccountManageMemberWidget.prototype.updateAccountAnnualRegPaidDate = function(account, paidDate) {
    var thiz = this;
    $classAdminService.updateAccountAnnualRegPaidDate(account.id, paidDate,
        function(data) {
            SnackBar.show("Your changes have been saved.");
            console.log("# account's annualRegPaidDate saved");

            $classAdminService.getAnnualRegByAccountId(account.id, function (accountRegInfo) {
                if (!accountRegInfo) return;
                thiz.accountDisplayName.innerText = accountRegInfo.fullName;
                thiz.accountDisplayName.title = accountRegInfo.fullName;
                var isNotPaid = thiz.isNotPaid(accountRegInfo.dtLregfee);
                thiz.accountPaidDateValue.innerText = (isNotPaid ? "Not Paid" : FormatUtil.formatDate(accountRegInfo.dtLregfee, "date_standard", "local"));
                if (!isNotPaid) {
                    thiz.accountPaidDatePicker.setDate(accountRegInfo.dtLregfee);
                }
                Dom.toggleClass(thiz.accountPaidDateValue.parentNode, "Expired", accountRegInfo.annualRegDateExpired == true);
                Dom.toggleClass(thiz.accountDisplayName.parentNode, "NotPaid", isNotPaid);
            }, function (error) {
                Dialog.error(error.message);
            });
        },
        function(error) {
            console.log("fail to update annualRegPaidDate for account:", account);
        });
};
AccountManageMemberWidget.prototype.updateMemberAnnualRegPaidDate = function(member, paidDate) {
    var thiz = this;
    member.dtLregfee = paidDate;
    $classAdminService.updateMemberAnnualRegPaidDate(member.id, paidDate,
        function(data) {
            SnackBar.show("Your changes have been saved.");
            console.log("# member's annualRegPaidDate saved");

            thiz.initAccountAnnualRegistration();
        },
        function(error) {
            console.log("fail to update annualRegPaidDate for member:", member);
        });
};

AccountManageMemberWidget.prototype.dataViewComboChangedHandler = function(event) {
    var thiz = this;
    if (!event.fromUser) return;
    var rowData = DataTable.getRowData(event.target);
    if (!rowData) return;
    var selectedData = ComboManager.prototype.getSelectedItem.call(event.target.__widget);
    if (Dom.hasClass(event.target.nextSibling, "SlotDetail")) {
        if (!event.fromUser) return;
        window.defaultIndicator.busy("Saving...");
        $classAdminService.updateStudentRegSlot({classInId: rowData.id, classId: rowData.class_id, id: rowData.member_id}, selectedData.slot,
            function(data) {
                window.defaultIndicator.done();
                rowData.slot = selectedData.slot;
                if (thiz.lessonClasses[rowData.class_id]) thiz.lessonClasses[rowData.class_id].updatedRegSlot = true;
            },
            function(error) {
                window.defaultIndicator.done();
                Dialog.alert("Error", (error && error.message ? error.message : error), function() {
                    event.target.__widget.selectItemByKey("slot", rowData.slot);
                });
            });
    } else if (Dom.hasClass(event.target.nextSibling, "PaymentPlanDetail")) {
        window.defaultIndicator.busy("Saving...");
        $classAdminService.saveAssignedStudents([{classInId: rowData.id, paymentPlanId: selectedData.id}], false, function(data) {
            window.defaultIndicator.done();
            rowData.payment_plan_id = selectedData.id;
        }, function(error) {
            window.defaultIndicator.done();
            console.console.error("[ERROR] fail to update PaymentPlan data with error:", error);
        });
    }
};
AccountManageMemberWidget.prototype.dataViewStartDropDateChangedHandler = function(event) {
    var thiz = this;
    if (!Dom.hasClass(event.target.parentNode, "StartDropDatePolicy")) return;
    var rowData = DataTable.getRowData(event.target);
    var date = event.target.__widget.getDate();
    var startDateBefore = rowData.start_drop_date_policy_start_date;
    var dropDateBefore = rowData.start_drop_date_policy_drop_date;
    var data = {
        lessonClassInId: rowData.id,
        sddPolicyStartDate: rowData.start_drop_date_policy_start_date,
        sddPolicyDropDate: rowData.start_drop_date_policy_drop_date
    }
    if (Dom.hasClass(event.target.parentNode, "StartDate")) {
        if (date && data.sddPolicyDropDate && date.getTime() > data.sddPolicyDropDate.getTime()) {
            Dialog.error("Error", "Cannot update start date to "
            + FormatUtil.formatDateWithTZID(date, "date_standard", rowData.timezone_id) +
            " because start date is greater than drop date. Roll back to previous choice.", function () {
                event.target.__widget.setDate(ClassUtils.transformToTimeZone(data.sddPolicyStartDate, rowData.timezone_id));
            });
            return;
        }
        data.sddPolicyStartDate = date;
    }
    if (Dom.hasClass(event.target.parentNode, "DropDate")) {
        if (date && data.sddPolicyStartDate && data.sddPolicyStartDate.getTime() > date.getTime()) {
            Dialog.error("Error", "Cannot update drop date to "
            + FormatUtil.formatDateWithTZID(date, "date_standard", rowData.timezone_id) +
            " because start date is greater than drop date. Roll back to previous choice.", function () {
                event.target.__widget.setDate(ClassUtils.transformToTimeZone(data.sddPolicyDropDate, rowData.timezone_id));
            });
            return;
        }
        data.sddPolicyDropDate = date;
    }
    window.defaultIndicator.busy("Saving...");
    $classAdminService.updateStartDropDatePolicy(data,
        function(res) {
            window.defaultIndicator.done();
            rowData.start_drop_date_policy_start_date = data.sddPolicyStartDate;
            rowData.start_drop_date_policy_drop_date = data.sddPolicyDropDate;
        },
        function(error) {
            window.defaultIndicator.done();
            Dialog.error("Error", error.message, function () {
                if (Dom.hasClass(event.target.parentNode, "StartDate")) {
                    event.target.__widget.setDate(ClassUtils.transformToTimeZone(startDateBefore, rowData.timezone_id));
                }
                if (Dom.hasClass(event.target.parentNode, "DropDate")) {
                    event.target.__widget.setDate(ClassUtils.transformToTimeZone(dropDateBefore, rowData.timezone_id));
                }
            });
        });
};
AccountManageMemberWidget.prototype.dataViewClickedHandler = function(data, fieldName, cell, event) {
    if (this._lastFocusedLink) Dom.removeClass(this._lastFocusedLink, "Focused");

    var link = Dom.findParentWithClass(event.target, "InfoLink");
    if (!link) return;

    this._lastFocusedLink = link;
    Dom.addClass(link, "Focused");

    if (Dom.hasClass(link, "SlotDetail")) {
        this.showSlotDetail(link, data);
        return;
    }
    if (Dom.hasClass(link, "PaymentPlanDetail")) {
        this.showPaymentPlanDetail(link, data);
        return;
    }
    if (Dom.hasClass(link, "CostumesDetail")) {
        this.showCostumesDetail(link, data);
        return;
    }
    if (Dom.hasClass(link, "TransferredActionLink")) {
        this.showClassTransferDetail(link, data.transferClassInItems);
        return;
    }
};

AccountManageMemberWidget.prototype.showClassTransferDetail = function(target, transferClassInItems) {
    if (!transferClassInItems || transferClassInItems.length < 1) return;
    if (!this.classTransferPopup) this.classTransferPopup = new __pkg.RegistrationClassTransferPopup();
    this.classTransferPopup.showPopupAt(target, transferClassInItems);
};

AccountManageMemberWidget.prototype.getClassDetail = function(classId) {
    var thiz = this;
    return new Promise(function(resolve, reject) {
        if (thiz.busy) {
            setTimeout(function() {
                thiz.getClassDetail(classId).then(resolve);
            }, 20);
        } else {
            thiz.busy = true;
            if (thiz.lessonClasses[classId] && !thiz.lessonClasses[classId].updatedRegSlot) {
                resolve(thiz.lessonClasses[classId]);
                thiz.busy = false;
                return;
            }
            $classAdminService.getClassDetailById(classId, function(classInfo) {
                thiz.lessonClasses[classId] = classInfo;
                resolve(classInfo);
                thiz.busy = false;
            }, function(error) {
                console.log("Fail to get ClassDetail with id:", classId);
                reject(error);
                thiz.busy = false;
            });
        }
    });
};
AccountManageMemberWidget.prototype.showSlotDetail = function(target, data) {
    var thiz = this;
    var slot = data.slot;
    this.getClassDetail(data.class_id).then(function(classInfo) {
        classInfo.slots.forEach(function(item) {
            if (item.slot == slot) {
                thiz.renderSlotTimesContent(item);
            }
        });
        Dom.addClass(thiz.slotInstancePopupContent.parentNode, "SlotInstancePopup");
        thiz.slotInstancePopup.show(target, "right-inside", "bottom", 0, 0, true);
    });
};

AccountManageMemberWidget.prototype.renderSlotTimesContent = function (selectedSlot) {
    this.slotInstancePopupContent.innerHTML = "";
    if (!selectedSlot.slotTimes || selectedSlot.slotTimes.length == 0) return;
    if (selectedSlot.slotTimes.length > 4) {
        this.slotInstancePopupContent.style.width = "28.5em";
    } else if (selectedSlot.slotTimes.length == 4) {
        this.slotInstancePopupContent.style.width = "19em";
    } else {
        this.slotInstancePopupContent.removeAttribute("style");
    }
    for (var i = 0; i < selectedSlot.slotTimes.length; i ++) {
        var slotTimeElm = document.createElement("div");
        Dom.addClass(slotTimeElm, "SlotTimeItem");
        slotTimeElm.innerHTML = selectedSlot.slotTimes[i];
        this.slotInstancePopupContent.appendChild(slotTimeElm);
    }
    var clearBoth = document.createElement("div");
    Dom.addClass(clearBoth, "ClearBoth");
    this.slotInstancePopupContent.appendChild(clearBoth);
    var slotOpen = (selectedSlot.slotOpen > 0 ? (selectedSlot.slotOpen < 99999? selectedSlot.slotOpen : "No limit") : 0);
    if (selectedSlot.maxLimit >= 99999) {
        slotOpen = "No Limit";
    }

    this.regSlotPopupSlotName.innerHTML = "Reg Slot #" + (selectedSlot.slot + 1)
        + " <span>(slot open: " + slotOpen + ")</span>";
};

AccountManageMemberWidget.prototype.showPaymentPlanDetail = function(target, data) {
    if (!this._canViewRegistrationFinancialInfo()) return;
    var thiz = this;
    var payment_plan_id = data.payment_plan_id;
    var slot = data.slot;
    this.getClassDetail(data.class_id).then(function(classInfo) {
        var gridData = {
            classInfo: classInfo,
            items: [],//paymentPlan.items,
            selectedSlot: slot,
            paymentPlanId: payment_plan_id,
            startProjectedDate: data.dt_created,
            filters: {},
            callback: null,
            readOnly: true,
            isClassAdmin: ClassAuthUtils.canCreateEditDeleteClass(thiz.LOGIN_INFO),
            projectedLessonClassInId: data.id
        };
        console.log("AccountManageMemberWidget.showPaymentPlanDetail", data.id, data);
        if (data.start_drop_date_policy_start_date) {
            gridData.startProjectedDate = data.start_drop_date_policy_start_date;
        }
        if (data.start_drop_date_policy_drop_date) {
            gridData.endProjectedDate = data.start_drop_date_policy_drop_date;
        }
        classInfo.paymentPlans.forEach(function(pp) {
            if (pp.id == payment_plan_id) {
                gridData.items = pp.items;
            }
        });
        thiz.paymentPlanPopup.popupContainer.innerHTML = "";

        gridData.finishLoadingCallback = function () {
            thiz.paymentPlanPopup.show(target, "left-inside", "top", 0, 5, true);
        };
        thiz.paymentPlanItemGrid = new __pkg.PaymentPlanItemGrid(gridData).into(thiz.paymentPlanPopup.popupContainer);
    });
};
AccountManageMemberWidget.prototype.showCostumesDetail = function(target, data) {
    var thiz = this;
    this.costumesPopup.popupContainer.innerHTML = "";
    this.getClassDetail(data.class_id).then(function(classInfo) {
        var costumes = (classInfo.costumeInfos || []).filter(function(costume) {
            return data.costumeIds.indexOf(costume.id) >= 0;
        });
        widget.createWidgetAsync("costume", "CostumeInfosView", {}, function(costumeInfosView) {
            costumeInfosView.into(thiz.costumesPopup.popupContainer);
            costumeInfosView.setCostumes(costumes, function() {
                thiz.costumesPopup.show(target, "right-inside", "bottom", 0, 5, true);
            });
        });
    });
};

AccountManageMemberWidget.prototype.openClassAddToolDialog = function (movedLessonClassIns, newClassInfo) {
    var thiz = this;
    thiz.isRegistrationsChanged = false;
    console.log("MOVE CLASS movedLessonClassIn", movedLessonClassIns);
    console.log("MOVE CLASS newClassInfo", newClassInfo);
    var memberIds = movedLessonClassIns.map(function(classIn) {
        return classIn.member_id;
    });
    
    var defaultPaymentPlan = -1;
    if (newClassInfo && newClassInfo.paymentPlans && newClassInfo.paymentPlans.length == 1) {
        defaultPaymentPlan = newClassInfo.paymentPlans[0].id;
    }
    var defaultRegSlot = -1;
    if (newClassInfo.assignedSlot >= 0) {
        defaultRegSlot = newClassInfo.assignedSlot;
    } else if (newClassInfo.slots && newClassInfo.slots.length == 1) {
        defaultRegSlot = newClassInfo.slots[0].slot;
    }
    
    var registrationsOptions = {
        classId: newClassInfo.id,
        title: newClassInfo.title,
        defaultRegSlot: defaultRegSlot,
        defaultPaymentPlan: defaultPaymentPlan,
        movedLessonClassIns: movedLessonClassIns,
        addedMemberIds: memberIds,
        registrationsChanged: function (isRegistrationsChanged) {
            thiz.isRegistrationsChanged = isRegistrationsChanged;
        }
    };
    var registrationsDialog = new RegistrationsDialog().callback(function (registrationsData) {
        if (thiz.isRegistrationsChanged) {
            if (window.__pkg.widget.namespaces.finance) {
                CommonEvent.fireEvent("finance", window.__pkg.widget.namespaces.finance.AccountLedgerWidget.EV_ON_DATAVIEW_DATA_CHANGE, {});
            }
            CommonEvent.fireEvent(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED);
        }
    }).open(registrationsOptions);
};

AccountManageMemberWidget.prototype.cancelRegistration = function (data, callback, event) {
    var thiz = this;
    if (!this._canCancelRegsitration()) return;
    Dialog.confirmDangerousAction("Do you want to cancel the registration for student \"" + data.memberFullName + "\"?", "",
        "Cancel registration", function() {
            window.defaultIndicator.busy("Waiting...");
            $classAdminService.cancelRegistration(data.id, function () {
                    SnackBar.show("The registration for student " + data.memberFullName + " is canceled.");
                    thiz._registrationChanged = true;
                    if (window.__pkg.widget.namespaces.finance) {
                        CommonEvent.fireEvent("finance", window.__pkg.widget.namespaces.finance.AccountLedgerWidget.EV_ON_DATAVIEW_DATA_CHANGE, {});
                    }
                    window.defaultIndicator.done();
                },
                function(error) {
                    window.defaultIndicator.done();
                    console.log("Fail to cancel the registration for this student with error:", error);
                });
        },
        "Cancel", function() {});
};

AccountManageMemberWidget.prototype.payAndApprove = function (data, callback, event) {
    if ((!this._canApproveWaitlistRegistration()) || !data.payment_plan_id || (data.paid && !data.waiting) || data.canceled) {
        return;
    }

    var thiz = this;
    this._registrationChanged = true;
    var alias = typeof(ADMIN_CONTEXT) != "undefined" ? ADMIN_CONTEXT.teamAlias :
        typeof (g_teamAlias) != "undefined" ? g_teamAlias :
        typeof (TEAM_INFO) != "undefined" ? (TEAM_INFO.teamAlias || TEAM_INFO.alias) : "";

    var url = String.format("/LClassInPay.jsp?team={0}&stringid={1}_{2}_{3}&permission=finance", alias, data.account_id, data.reg_idx, data.idx);
    var iframeContentDialog = new IFrameContentDialog({src: url, title: "Pay & Approve"});
    iframeContentDialog.getDialogActions = function() {
        return [
            {
                type: "cancel", title: "Close",
                isCloseHandler: true,
                run: function () {
                    if (window.__pkg.widget.namespaces.finance) {
                        CommonEvent.fireEvent("finance", window.__pkg.widget.namespaces.finance.AccountLedgerWidget.EV_ON_DATAVIEW_DATA_CHANGE, {});
                    }
                    CommonEvent.fireEvent(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED);
                    return true;
                }
            }
        ];
    }
    iframeContentDialog.open();
};


AccountManageMemberWidget.prototype.reactiveRegistration = function(registrations, callback, event) {
    if (!this._canMoveReenrollClass()) return;
    var thiz = this;
    var memberMap = registrations.reduce(function(a, c) {
        var key = "" + c.member_id + "_" + c.class_id;
        if (!a[key]) a[key] = 1;
        else a[key] += 1;
        return a;
    }, {});
    for (var memId in memberMap) {
        if (memberMap[memId] > 1) {
            Dialog.alert("Error", "Re-enroll registrations of the same member to a single class's slot is not allowed.");
            return;
        }
    }
    var activeRegistrationName = [], inactiveRegistration = [], inactiveMember = [],
        inactiveRegistrationMemberId = 0, isMultiMember = false;;
    for (var i = 0; i < registrations.length; i ++) {
        if (registrations[i].canceled) {
            if (registrations[i].member_status_id != this.ACTIVE_MEMBER_STATUS) {
                inactiveMember.push(registrations[i].memberFullName);
            } else {
                inactiveRegistration.push(registrations[i]);
                if (inactiveRegistrationMemberId == 0) inactiveRegistrationMemberId = registrations[i].member_id;
                if (inactiveRegistrationMemberId != registrations[i].member_id) isMultiMember = true;
            }
        } else {
            var message = registrations[i].class_title + ", slot #" + (registrations[i].slot + 1) + " of member " + registrations[i].memberFullName;
            activeRegistrationName.push(message);
        }
    }

    if (isMultiMember) {
        Dialog.alert("Error", "Cannot re-enroll for multi members at same time.");
        return;
    }

    if (activeRegistrationName.length || inactiveMember.length) {
        var errorMessage = "";
        if (activeRegistrationName.length) {
            errorMessage += "[" + activeRegistrationName.join(", ") + "] won't be re-enrolled.";
        } else if (inactiveMember.length) {
            if (errorMessage.length) errorMessage += " ";
            errorMessage += "[" + inactiveMember.join(", ") + "] is inactive member can not be re-enrolled.";
        }

        Dialog.confirm(errorMessage + " Continue to re-enroll the other registrations?", "",
        "Re-enroll", function() {
            thiz._reactiveRegistrations(inactiveRegistration);
        },
        "Cancel", function() {});
    } else {
        var targetStr = inactiveRegistration.length > 1 ? (inactiveRegistration.length + " registrations") : inactiveRegistration[0].memberFullName;
        Dialog.confirm(targetStr + " will be re-enrolled in the class. Continue?", "",
            "Re-enroll", function() {
                thiz._reactiveRegistrations(inactiveRegistration);
            },
            "Cancel", function() {});
    }
};

AccountManageMemberWidget.prototype._reactiveRegistrations = function(data) {
    console.log("AccountManageMemberWidget.prototype._reactiveRegistrations");
    if (!data.length) {
        Dialog.error("There is no cancelled registration to be re-enrolled. Please choose at least one cancelled registration to re-enroll.");
        return;
    }
    var thiz = this;
    var addedClassIds = [], mapMemberSlot = {};
    data.forEach(function (registration) {
        mapMemberSlot[registration.class_id + "_" + registration.member_id] = registration.slot;
        addedClassIds.push(registration.class_id);
    });


    widget.__ensureNamespaceLoaded("classtool", function (classtool) {
        new classtool.RegistrationsDialog().callback(function (data) {
        }).open({
            memberId: data[0].member_id,
            memberFullName: data[0].memberFullName,
            addedClassIds: addedClassIds,
            action: "reEnrollMemberClass",
            isReenrollingReg: true,
            mapMemberSlot: mapMemberSlot,
            registrationsChanged: function (changed) {
                if (changed) thiz.dataView.refreshDataList();
            }
        });
    });
}

AccountManageMemberWidget.prototype.isFutureReg = function(classInfo, data){
    var thiz = this;
    console.log(data);
    if (data.start_drop_date_policy_start_date && data.start_drop_date_policy_start_date > new Date()) return true;
    return false;
};


AccountManageMemberWidget.prototype.isDropDatePassed = function(data){
    var thiz = this;
    if (data.start_drop_date_policy_drop_date) {
        var d = new Date(data.start_drop_date_policy_drop_date);
        d.setDate(d.getDate() + 1);
        if (d < new Date()) return true;
    }
    return false;
}

AccountManageMemberWidget.prototype.initMemberAnnualKits = function (callback) {
    if (!this.canViewAnnualKitDates()) {
        Dom.addClass(this.annualKitContainer, "Inapplicable");
        return;
    }

    Dom.removeClass(this.annualKitContainer, "Inapplicable");
    Dom.toggleClass(this.annualKitContainer, "ReadOnly", !this.canManageAnnualKitDates());
    var thiz = this;
    $promoKitAPIService.getMemberAnnualKitDateInfosByAccountId(this.options.accountInfo.id, function (members) {
        if (!members) return;
        thiz.memberAnnualKitsRepeaterView.setItems(members);
        callback && callback();
    }, function (error) {
        Dialog.error(error.message);
    });
};

AccountManageMemberWidget.prototype.isNotApproved = function (dd) {
    if (!dd) return true;
    return dd.getFullYear() == 1930;
};

AccountManageMemberWidget.prototype.updateMemberApprovedDate = function (memberIds, approvedDate) {
    var thiz = this;
    $promoKitAPIService.updateMemberAnnualKitDate(memberIds, approvedDate, function () {
        thiz.initMemberAnnualKits(function () {
            SnackBar.show("Your changes have been saved.");
        });
    }, function (error) {
        Dialog.error(error.message);
    });
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/AssignRegSlotDialog.js";

function AssignRegSlotDialog() {
    Dialog.call(this);
    this.title = "Re-enroll Registrations";
}
__extend(Dialog, AssignRegSlotDialog);

AssignRegSlotDialog.prototype.setup = function(options) {
    var thiz = this;
    this.registrations = options.registrations;
    this.lessonClasses = options.lessonClasses;
    this.setupDataTable();

    this.bind("click", this.dataTableClickedHandler.bind(this), this.dataTable);
    this.bind("p:ItemSelected", this.dataTableComboChangedHandler, this.dataTable);
    this.bind("p:PopupHidden", function () {
         if (thiz._lastFocusedLink) Dom.removeClass(thiz._lastFocusedLink, "Focused");
    }, this.slotInstancePopup);

    this.slotInstancePopup.popupOpacity = 0.9999;
    this.bind("click", function () {
        thiz.slotInstancePopup.hide();
    }, this.slotInstancePopupArrow);
    this.slotInstancePopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        }
        thiz.slotInstanceBackgroundBox.onSizeChanged();
    }
};

AssignRegSlotDialog.prototype.onHide = function() {
    this.slotInstancePopup.kill();
};

AssignRegSlotDialog.prototype.setupDataTable = function() {
    var thiz = this;
    this.dataTable.column(new DataTable.GenericDomColumn("Member/Account", function (data) {
        return {
            _name: "vbox",
            _children: [
                {
                    _name: "strong",
                    _text: data.memberFullName
                }, {
                    _name: "span",
                    _text: data.account_name
                }, {
                    _name: "span",
                    class: "AccountEmail",
                    _text: data.email
                }
            ]
        };
    }).width("1*"));
    this.dataTable.column(new DataTable.PlainTextColumn("Class Registered", function(data) {
        return thiz.lessonClasses[data.class_id].title;
    }).width("1*"));
    this.dataTable.column(new DataTable.DomNodeColumn("Slot", function(data) {
        var wrapper = document.createElement("hbox");
        var combo = new ComboManager();
        combo.renderer = function(data) {
            return (data ? "#" + (data.slot + 1) : "");
        }
        var slotItems = Util.clone(thiz.lessonClasses[data.class_id].slots);
        slotItems.sort(function(a, b) {
            return (a.slot > b.slot ? 1 : -1);
        });
        var slot = data.slot;
        slotItems = (slotItems.filter(function(item) {item.slot == slot}).length == 0 && data.canceled) ? [null].concat(slotItems) : slotItems;
        combo.setItems(slotItems);
        combo.selectItemByKey("slot", slot, true);
        wrapper.appendChild(combo.node());
        var infoLink = Dom.newDOMElement({
            _name: "span",
            class: "InfoLink SlotDetail " + (combo.getSelectedItem() ? "" : "Disabled"),
            _children: [{_name: "icon", class: "information"}]
        });
        wrapper.appendChild(infoLink);
        return wrapper;
    }).width("10em"));
    this.dataTable.selector(false);
    window.setTimeout(function() {
        thiz.dataTable.setup();
        thiz.dataTable.setItems(thiz.registrations);
    }, 20);
};

AssignRegSlotDialog.prototype.dataTableClickedHandler = function(event) {
    var thiz = this;
    if (this._lastFocusedPaymentPlanLink) Dom.removeClass(this._lastFocusedPaymentPlanLink, "Focused");

    var link = Dom.findParentWithClass(event.target, "InfoLink");
    if (!link) return;

    this._lastFocusedPaymentPlanLink = link;
    Dom.addClass(link, "Focused");
    var rowData = DataTable.getRowData(event.target);
    if (Dom.hasClass(link, "SlotDetail") && !Dom.hasClass(link, "Disabled")) {
        this.showSlotDetail(link, rowData);
        return;
    }
};

AssignRegSlotDialog.prototype.showSlotDetail = function(target, data) {
    var thiz = this;
    var slot = data.slot;
    this.lessonClasses[data.class_id].slots.forEach(function(item) {
        if (item.slot == slot) {
            thiz.renderSlotTimesContent(item);
        }
    });
    Dom.addClass(this.slotInstancePopupContent.parentNode, "SlotInstancePopup");
    this.slotInstancePopup.show(target, "right-inside", "bottom", 0, 0, true);
};

AssignRegSlotDialog.prototype.renderSlotTimesContent = function (selectedSlot) {
    this.slotInstancePopupContent.innerHTML = "";
    if (!selectedSlot.slotTimes || selectedSlot.slotTimes.length == 0) return;
    if (selectedSlot.slotTimes.length > 4) {
        this.slotInstancePopupContent.style.width = "28.5em";
    } else if (selectedSlot.slotTimes.length == 4) {
        this.slotInstancePopupContent.style.width = "19em";
    } else {
        this.slotInstancePopupContent.removeAttribute("style");
    }
    for (var i = 0; i < selectedSlot.slotTimes.length; i ++) {
        var slotTimeElm = document.createElement("div");
        Dom.addClass(slotTimeElm, "SlotTimeItem");
        slotTimeElm.innerHTML = selectedSlot.slotTimes[i];
        this.slotInstancePopupContent.appendChild(slotTimeElm);
    }
    var clearBoth = document.createElement("div");
    Dom.addClass(clearBoth, "ClearBoth");
    this.slotInstancePopupContent.appendChild(clearBoth);

    this.regSlotPopupSlotName.innerHTML = "Reg Slot #" + (selectedSlot.slot + 1);
};

AssignRegSlotDialog.prototype.dataTableComboChangedHandler = function(event) {
    var thiz = this;
    var rowData = DataTable.getRowData(event.target);
    if (!rowData) return;
    var selectedData = ComboManager.prototype.getSelectedItem.call(event.target.__widget);
    rowData.slot = (!selectedData ? null : selectedData.slot);
    Dom.toggleClass(event.target.nextSibling, "Disabled", !selectedData);
};

AssignRegSlotDialog.prototype.validateData = function(data) {
    for (var i = 0; i < data.length; i++) {
        var reg = data[i];
        var filter = this.lessonClasses[reg.class_id].slots.filter(function(item) {return item.slot == reg.slot});
        if (filter.length == 0) return false;
    }
    return true;
};

AssignRegSlotDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Re-enroll",
            run: function() {
                var data = thiz.dataTable.getItems();
                if (!thiz.validateData(data)) {
                    Dialog.error("Missing registration slot.", "Please select slot and try again.");
                    return;
                }
                thiz.close(data);
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.close(false);
            }
        }
    ];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/ClassEditRegistrationWidget.js";

function ClassEditRegistrationWidget(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
    var thiz = this;
    this.ACTIVE_MEMBER_STATUS = 20;
    this._registrationChanged = false;
    this._slotChanged = false;
    this.dataView.onSpecificationLoaded = function (spec) {
        if (!options) return;
        var slots = [];
        var paymentPlans = [];
        if (options.classInfo && options.classInfo.slots) {
            slots = options.classInfo.slots.map(function (slot) {
                return {
                    key: "" + slot.slot,
                    value: "#" + (slot.slot + 1) + " (" + (slot.slotTimes || []).join (", ") + ")"
                };
            });
            if (spec && spec.filters) {
                spec.filters.forEach(function (filter) {
                    if (filter.fieldName == "slot") filter.values = slots;
                })
            }
        }
        if (options.classInfo && options.classInfo.paymentPlans) {
            paymentPlans = options.classInfo.paymentPlans.map(function (plan) {
                return {
                    key: "" + plan.id,
                    value: plan.name
                };
            }).sort(function(a, b) {
                return (a.value > b.value ? 1 : -1);
            });
        }
        if (spec && spec.filters) {
            spec.filters.forEach(function (filter) {
                if (filter.fieldName == "slot") filter.values = slots;
                if (filter.fieldName == "payment_plan_id") filter.values = paymentPlans;
            });
        }
    };
    this.dataView._convertFilterMap = function (valueMap) {
        var map = {};
        if (valueMap) {
            for (var name in valueMap) map[name] = valueMap[name];
        }
        map.class_id = "" + thiz.options.classInfo.id;
        return map;
    };
    this.bind("p:PageLoaded", function () {
        var summary = this.dataView.lastResultExtra.summary;
        // thiz.summaryLabel.innerHTML = String.format("<span>{0}</span> member(s)", this.dataView.getDiscoveredTotalItems());
        thiz.totalMember.innerText = this.dataView.getDiscoveredTotalItems();
        thiz.totalEntered.innerText = summary.totalEntered;
        thiz.totalWaiting.innerText = summary.totalWaiting;
        thiz.totalCanceled.innerText = summary.totalCanceled;
        thiz.totalFuture.innerText = summary.totalFuture;
    }, this.dataView);
    this.dataView.setDefaultSelectionHandler(this.dataViewClickedHandler.bind(this));
    this.bind("p:PopupHidden", function () {
         if (thiz._lastFocusedPaymentPlanLink) Dom.removeClass(thiz._lastFocusedPaymentPlanLink, "Focused");
    }, this.paymentPlanPopup);
    this.bind("p:ItemSelected", this.dataViewComboChangedHandler, this.dataView);
    this.bind("p:ValueUpdated", this.dataViewStartDropDateChangedHandler, this.dataView);
    this.bind("input", this.inputHandler, this.dataView);
    this.slotInstancePopup.popupOpacity = 0.9999;
    this.bind("click", function () {
        thiz.slotInstancePopup.hide();
    }, this.slotInstancePopupArrow);
    this.slotInstancePopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        }
        thiz.slotInstanceBackgroundBox.onSizeChanged();
    }

    InfoTip.install(this.dataView.node(), {
        match: function (node) {
            return Dom.hasClass(node, "alert-circle");
        },
        getMessage: function (target) {
            return Dom.newDOMElement({
                _name: "div",
                "class": "SignedHintText",
                _html: target.getAttribute("message")
            })
        }
    });
    
    this.isWaitPaid = function (data) {
        return (!data.waiting && !data.canceled && !data.paid && data.wait_paid_charge_ids);
    }
}
__extend(BaseTemplatedWidget, ClassEditRegistrationWidget);

ClassEditRegistrationWidget.prototype.onAttached = function(firstAttached) {
    var thiz = this;
    if (firstAttached) {
        window.setTimeout(function() {
            if (window.LOGIN_INFO && window.LOGIN_INFO.hasOwnProperty("enableGroupAttendanceNote")) {
                thiz.init();
            } else {
                $classAdminService.getAccountInfo(function (res) {
                    window.LOGIN_INFO.enableGroupAttendanceNote = res.enableGroupAttendanceNote;
                    window.LOGIN_INFO.enableClassRooomAttendanceNote = res.enableClassRooomAttendanceNote;
                    window.LOGIN_INFO.classRoomAttendanceNoteLabel = res.classRoomAttendanceNoteLabel;  
                    thiz.init();
                }, function (err) {});
            }
        }, 100);
    }
};

ClassEditRegistrationWidget.prototype.reloadClassInfo = function(classInfo) {
    this.options.classInfo = classInfo;
    this._registrationChanged = false;
};

ClassEditRegistrationWidget.prototype.reload = function(){
    console.log("Reload filter and data list");
    if (this.dataView && typeof(this.dataView.reloadFiltersAndDataList) == 'function') this.dataView.reloadFiltersAndDataList();
};

ClassEditRegistrationWidget.prototype.isRegistrationChanged = function(){
    return this._registrationChanged;
};

ClassEditRegistrationWidget.prototype.isSlotChanged = function(){
    return this._slotChanged;
};

ClassEditRegistrationWidget.prototype.resetSlotChanged = function(){
    this._slotChanged = false;
};

ClassEditRegistrationWidget.prototype.isFutureReg = function(data){
    var thiz = this;
    if (data.start_drop_date_policy_start_date && data.start_drop_date_policy_start_date > new Date()) return true;
    return false;
}

ClassEditRegistrationWidget.prototype.isDropDatePassed = function(data){
    var thiz = this;
    if (data.start_drop_date_policy_drop_date) {
        var d = new Date(data.start_drop_date_policy_drop_date);
        d.setDate(d.getDate() + 1);
        if (d < new Date()) return true;
    }
    return false;
}

ClassEditRegistrationWidget.prototype.init = function() {
    var thiz = this;
    this.classTimezoneProvider = {
        getTimezoneId: function () {
            return thiz.options.classInfo.timezoneId;
        },
        getName: function () {
            return "Class time zone";
        }
    };

    if (LOGIN_INFO) {
        var actions = [];
        
        if (this._canMoveReenrollClass()) {
            actions.push({
                title: "Bulk Transfer...",
                run: function (regs) {
                    var registrations = Util.clone(regs);
                    var memberMap = registrations.reduce(function(a, c) {
                        if (!a[c.member_id]) a[c.member_id] = 1;
                        else a[c.member_id] += 1;
                        return a;
                    }, {});
                    for (var memId in memberMap) {
                        if (memberMap[memId] > 1) {
                            Dialog.error("Moving registrations of the same member to a single class is not allowed. Please don't select each member more than once.");
                            return;
                        }
                    }
                    for (var i = 0; i < registrations.length; i++) {
                        if (registrations[i].canceled) {
                            Dialog.error("Moving inactive registrations is not allowed. Please select only active registrations and try again");
                            return;
                        }
                        if (registrations[i].payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) { //only pending
                            Dialog.error("Moving pending authorized registrations is not allowed. Please select only active registrations and try again");
                            return;
                        }
                    }
                    new ClassSelectorDialog().callback(function(toClass) {
                        console.log("# selected class:", toClass);
                        if (!toClass) return;
                        thiz.openClassAddToolDialog(registrations, toClass);
                    }).open(registrations);
                },
                visible: function(count, dataView) {
                    return true;
                }.bind(this),
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
        }
        if (this._canDenyWaitlistCancelRegsitration()) {
            actions.push({
                title: "Deny Waitlist",
                run: function (regs) {
                    var ids = [];
                    for (var i = 0; i < regs.length; i++) {
                        if (regs[i].payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) { //only pending
                            Dialog.error("Moving pending authorized registrations is not allowed. Please select only active registrations and try again");
                            return;
                        }
                        ids.push(regs[i].id);
                    }
                    if (!ids || ids.length == 0) return;
                    Dialog.confirmDangerousAction("Are you sure you want to remove the selected Student from the Waitlist?",
                    "This will delete them from the class.",
                    "Remove Waitlist", function() {
                        window.defaultIndicator.busy("Waiting...");
                        $classAdminService.removeWaitList(ids, function () {
                            window.defaultIndicator.done();
                            SnackBar.show("Waitlist is removed.");
                        }, function(error) {
                            window.defaultIndicator.done();
                            if (error && error.message){
                                Dialog.error(error.message);
                            } else {
                                Dialog.error("Fail to remove Waitlist");
                            }
                            console.log("Fail to remove Waitlist with error:", error);
                        });
                    },
                    "Cancel", function() {});
                },
                visible: function(count, dataView) {
                    return true;
                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            })
        };
        
        if (this._canMoveReenrollClass()) {
            actions.push({
                title: "Re-enroll...",
                run: function (registrations) {
                  for (var i = 0; i < registrations.length; i++) {
                        if (registrations[i].payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) { //only pending
                            Dialog.error("Re-enrolling pending authorized registrations is not allowed. Please select only active registrations and try again");
                            return;
                        }
                    }

                    thiz.reactiveRegistration(registrations);
                },
                visible: function(count, dataView) {
                    return true;
                }.bind(this),
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
        }
        
        if (this._canDenyWaitlistCancelRegsitration()) {
            actions.push({
                title: "Cancel Reg",
                run: function (registrations) {
                    thiz.cancelRegistrations(registrations);
                },
                visible: function(count, dataView) {
                    return true;
                }.bind(this),
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
        }
        
        if (this._canExportClassRegistrations()) {
            actions.push({
                title: "Export Registrations",
                runOnIds: function (ids) {
                    console.log("prepare and export excel file");
                    // thiz.dataView.export("Excel", ids);
                    $classAdminService.generateDownloadableRegistrationsAsExcel(ids, function (fileUrl) {
                        Util.initiateDownload(fileUrl);
                    }, "Exporting...");
                },
                visible: function(count, dataView) {
                    return true;
                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
        }
        this.dataView.registerActions(actions, "Actions...");

        var emailActions = [{
            title: "Email" + (ADMIN_CONTEXT.isSMSEnabled ? "/SMS" : "") + "/Push Custom Message",
            icon: "hexagon-multiple",
            run: function (registrations) {
                var ids = registrations.map(function (reg) {
                    return reg.account_id;
                });
                widget.__ensureNamespaceLoaded("util", function (util) {
                    new util.CommunicationDialog().open({dataType: "account", ids: ids, extra: {communicationTargetType: "Class_Registrations"}});
                }, "Loading...");
            },
            visible: function(count, dataView) {
                return this._canSendMessage() || (this._onlyEmailSMSPushMyInstructorClassAccountMember() && ClassUtils.isMyInstructorAssigned(thiz.options.classInfo, LOGIN_INFO.accountId));
            }.bind(this),
            applicable: function (count, dataView) {
                return count > 0;
            }
        }];

        if (LOGIN_INFO && LOGIN_INFO.allowWaiver) {
            emailActions.push({
                title: "Send Agreement Review Reminder",
                icon: "email",
                run: function () {
                    var ids = [];
                    thiz.dataView.getSelectedItems(function (items) {
                        for (var i = 0; i < items.length; i ++) {
                            ids.push(items[i].account_id);
                        }
                        thiz.sendAgreementReview(ids);
                    });
                },
                visible: function(count, dataView) {
                    return thiz._canSendAgreementReviewReminder();
                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
            emailActions.push({
                title: "Edit & Send Agreement Review Reminder",
                icon: "email",
                run: function () {
                    var ids = [];
                    thiz.dataView.getSelectedItems(function (items) {
                        for (var i = 0; i < items.length; i ++) {
                            ids.push(items[i].account_id);
                        }
                        thiz.sendAgreementReview(ids, true);
                    });
                },
                visible: function(count, dataView) {
                    return thiz._canSendAgreementReviewReminder();
                },
                applicable: function (count, dataView) {
                    return count > 0;
                }
            });
        }
        this.dataView.registerActions(emailActions, "Communicate");
    }

    this.dataView.registerCustomRenderer("name", function (data, value) {
        var ageText = data.calculatedAgeText;
        var nameObjects = [{
                            _name: "strong",
                            class: "MemberFullName" + (thiz._canViewLimitBasicAccountMemberInfo() ? " InfoLink" : ""),
                            _text: value
                        }];
        if (data.payLater){
            nameObjects.push({
                            _name: "span",
                            "title": "Registration fee is due",
                            "class": "InfoLink PayLater Alert",
                            _children: [{_name: "icon", "class": "cash-usd"}]
                        });
        }
        
                        
        return {
            _name: "vbox",
            _children: [
                {  
                    _name: "span",
                    _children: nameObjects
                    
                },  {
                    _name: "span",
                    class: "MemberAge",
                    _text: ageText + (data.memberGender ? (", " + data.memberGender) : "")
                }, {
                    _name: "span",
                    class: "AccountFullName" + (thiz._canViewLimitBasicAccountMemberInfo() ? " InfoLink" : ""),
                    _text: data.account_name
                }, {
                    _name: "span",
                    class: "AccountEmail",
                    _text: data.email
                }
            ]
        };
    });
    this.dataView.registerCustomRenderer("first_name", function (data, _value) {
        return {
            _name: "span",
            class: "AccountFullName" + (thiz._canViewLimitBasicAccountMemberInfo() ? " InfoLink" : ""),
            _text: data.first_name
        };
    });
    this.dataView.registerCustomRenderer("last_name", function (data, _value) {
         return {
            _name: "span",
            class: "AccountFullName" + (thiz._canViewLimitBasicAccountMemberInfo() ? " InfoLink" : ""),
            _text: data.last_name
        };
    });
    this.dataView.registerCustomRenderer("slot", {
        renderer: function (data, value) {
            var wrapper = document.createElement("hbox");
            var combo = new ComboManager();
            combo.renderer = function(data) {
                return (data ? "#" + (data.slot + 1) : "");
            }
            var slotItems = Util.clone(thiz.options.classInfo.slots);
            slotItems.sort(function(a, b) {
                return (a.slot > b.slot ? 1 : -1);
            });
            var filteredSlots = slotItems.filter(function(item) {return item.slot == value});
            slotItems = (filteredSlots.length == 0 && data.canceled) ? [null].concat(slotItems) : slotItems;
            combo.setItems(slotItems);
            combo.selectItemByKey("slot", value, true);
            var isWaitPaid = thiz.isWaitPaid(data);
            if (data.canceled || isWaitPaid) combo.setDisabled(true);
            if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                combo.setDisabled(true);
            }
            if (!thiz._canChangeSlotPaymentPlanStartDropDate()) combo.setDisabled(true);
            wrapper.appendChild(combo.node());
            var infoLink = Dom.newDOMElement({
                _name: "span",
                class: "InfoLink SlotDetail" + (filteredSlots.length == 0 ? " Disabled" : ""),
                _children: [{_name: "icon", class: "information"}]
            });
            wrapper.appendChild(infoLink);
            return wrapper;
        },
        useDOMNode: true
    });
    this.dataView.registerCustomRenderer("start_drop_date_policy_start_date", {
        renderer: function (data, value) {
            var wrapper = Dom.newDOMElement({_name: "vbox", class: "StartDropDateContainer"});
            var classInfo = thiz.options.classInfo;
            if (!classInfo) return wrapper
            if (classInfo.editableSddStartDateAfterReg  || classInfo.editableSddDropDateAfterReg
                    || value || data.start_drop_date_policy_drop_date) {
                var startDatePicker = new DateTimePicker();
                startDatePicker.setCustomTimezoneProvider(thiz.classTimezoneProvider);
                startDatePicker.setDate(ClassUtils.transformToTimeZone(value, data.timezone_id));
                startDatePicker.setMinDate(ClassUtils.transformToTimeZone(classInfo.minSddStartDate, data.timezone_id));
                startDatePicker.setMaxDate(ClassUtils.transformToTimeZone(classInfo.maxSddStartDate, data.timezone_id));
                if (!classInfo.editableSddStartDateAfterReg || !thiz._canChangeSlotPaymentPlanStartDropDate()) startDatePicker.setEnabled(false);
                var startDateWrapper = Dom.newDOMElement({
                    _name: "hbox",
                    class: "StartDropDatePolicy StartDate",
                    _children: [{ _name: "label", _text: "S:"}]
                });
                startDateWrapper.appendChild(startDatePicker.node());
                wrapper.appendChild(startDateWrapper);
                var dropDatePicker = new DateTimePicker();
                dropDatePicker.setCustomTimezoneProvider(thiz.classTimezoneProvider);
                dropDatePicker.setDate(ClassUtils.transformToTimeZone(data.start_drop_date_policy_drop_date, data.timezone_id));
                dropDatePicker.setMinDate(ClassUtils.transformToTimeZone(classInfo.minSddDropDate, data.timezone_id));
                dropDatePicker.setMaxDate(ClassUtils.transformToTimeZone(classInfo.maxSddDropDate, data.timezone_id));
                if (!classInfo.editableSddDropDateAfterReg || !thiz._canChangeSlotPaymentPlanStartDropDate()) dropDatePicker.setEnabled(false);

                var dropDateWrapper = Dom.newDOMElement({
                    _name: "hbox",
                    class: "StartDropDatePolicy DropDate",
                    _children: [{ _name: "label", _text: "D:"}]
                });
                dropDateWrapper.appendChild(dropDatePicker.node());
                wrapper.appendChild(dropDateWrapper);
            }
            return wrapper;

        },
        useDOMNode: true
    });
    this.dataView.registerCustomRenderer("waiting", function (data, value) {
        var status = (!data.canceled && data.waiting) ? "Waiting" : ((data.canceled || thiz.isDropDatePassed(data))? "Inactive" : "Active");
        status = (status == "Active" && thiz.isFutureReg(data)) ? "Future" : status;
        var _children = [];
        if (data.waiting && (data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key)) {
            _children.push({
                _name: "icon",
                "class": "alert-circle InfoLink PaymentPending",
                "message": ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.msg
            });
        } else if (data.canceled && (data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.REJECTED.key)) {
            _children.push({
                _name: "icon",
                "class": "alert-circle InfoLink PaymentRejected",
                "message": ClassUtils.PAYMENT_AUTHORIZED_STATUS.REJECTED.msg
            });
        } else if (data.memberAgreementStatus == "REQUIRED_NOT_SIGNED") {
            _children.push({
                _name: "icon",
                "class": "alert-circle InfoLink RequiredNotSigned",
                "message": "A required agreement needs to be signed"
            });
        } else {
            if (data.memberAgreementStatus == "OPTIONAL_NOT_SIGNED") {
                _children.push({
                    _name: "icon",
                    "class": "alert-circle InfoLink OptionalNotSigned",
                    "message": "An optional agreement has not been signed"
                });
            }
        }
        _children.push({
            _name: "span",
            class: status,
            _text: status
        });

        var node = {
            _name: "vbox",
            _children: [
                {
                    _name: "hbox",
                    _children: _children
                }
            ]
        };

        if (data.hasTransferred) {
            node._children.push({
                _name: "hbox",
                _children: [
                    {
                        _name: "hbox",
                        class: "TransferredBox",
                        _children: [
                            {
                                _name: "span",
                                class: "TransferredLabel",
                                _text: "Transferred"
                            },
                            {
                                _name: "icon",
                                class: "InfoLink TransferredActionLink  arrow-down-drop-circle"
                            }
                        ]
                    }
                ]
            });
        }
        return node;
    });
    this.dataView.registerCustomRenderer("dt_created", function (data, value) {
        return {
            _name: "span",
            _text: FormatUtil.formatDate(value, "date_standard", "local")
        };
    });
    this.dataView.registerCustomRenderer("paymentPlanName", {
        renderer: function (data, value) {
            var wrapper = document.createElement("hbox");
            var combo = new ComboManager();
            combo.renderer = function(data) {
                return data.name;
            }
            combo.setItems(Util.clone(thiz.options.classInfo.paymentPlans));
            var paymentPlanId = data.payment_plan_id;
            combo.selectItemById(paymentPlanId);
            var isWaitPaid = thiz.isWaitPaid(data);
            if (data.canceled || isWaitPaid) combo.setDisabled(true);
            if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                combo.setDisabled(true);
            }
            if (!thiz._canChangeSlotPaymentPlanStartDropDate()) combo.setDisabled(true);
            wrapper.appendChild(combo.node());
            var infoLink = Dom.newDOMElement({
                _name: "span",
                class: "InfoLink PaymentPlanDetail",
                _children: [{_name: "icon", class: "information"}]
            });
            wrapper.appendChild(infoLink);
            return wrapper;
        },
        useDOMNode: true
    });
    this.dataView.registerCustomRenderer("paymentPlanTotalAmount", function(data, value) {
        var totalFee = data.addl_fee_amt + data.fee_class_amt + data.fee_reg_account_amt + data.fee_reg_mem_amt
                + data.fee_reg_year_account_amt + data.fee_reg_year_student_amt + data.fee_tax_amt;
        var discount = data.disc_mcl_amt + data.disc_mstd_amt + data.lesson_coupon_amt;
        return {
            _name: "span",
            _text: (totalFee - discount > 0 && data.paid) ? Util.toCurrency(totalFee - discount) : ""
        };
    });
    this.dataView.registerCustomRenderer("actions", this.dataView.createActionColumnHandler(
        {
            spec: function (data, value) {
                var spec = {
                    _name: "button",
                    "title": "Transfer " + data.name,
                    "class": "ActionButton IconOnly",
                    "action-role": "primary",
                    _children: [
                        {_name: "icon", "class": "arrow-right-bold-circle"}
                    ]
                };
                
                if (!thiz._canMoveReenrollClass()) spec.disabled = true;
                if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                    spec.disabled = true;
                }
                if (!data.dt_dob) return false;
                if (data.canceled) spec.disabled = true;
                return spec;
            },
            run: function (data, callback, event) {
                if (!thiz._canMoveReenrollClass()) return;
                new ClassSelectorDialog().callback(function(dest) {
                    if (!dest) return;
                    thiz.openClassAddToolDialog([data], dest);
                }).open([data]);
            }
        },
        {
            spec: function(data, value) {
                var isWaitPaid = thiz.isWaitPaid(data);
                var spec = {
                    _name: "button",
                    "title": ((!data.waiting && !data.canceled && !data.paid) ? (!isWaitPaid? "Pay" : "Open Billing") : "View Billing"),
                    "class": "ActionButton IconOnly" + ((!data.waiting && !data.canceled && !data.paid) ? " Alert" : ""),
                    "action-role": "primary",
                    _children: [
                        {_name: "icon", "class": ((!data.waiting && !data.canceled && !data.paid) ? "cash-usd" : "cash")}
                    ]
                };
                if (!data.waiting && !data.canceled && !data.paid && !isWaitPaid) { // legacy PAY & Approve
                    if (!thiz._canApproveWaitlistRegistration()) spec.disabled = true;    
                } else { // VIEW BILLING && OPEN BILLING
                    if (!thiz._canViewBilling() || !thiz._canViewAccountMemberDetail()) spec.disabled = true;
                }
                if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                    spec.disabled = true;
                }
                return spec;
            },
            run: function(data, callback, event) {
                var isWaitPaid = thiz.isWaitPaid(data);
                
                if (!data.canceled && !data.waiting && !data.paid && !isWaitPaid) {
                    thiz.payAndApprove.apply(thiz, arguments);
                } else {
                    if (!thiz._canViewBilling()) return false;
                    thiz.openAccountDetailDialog(data.account_id, "finance-billing-summary", "clpayplan.ClassEditRegistrationWidget", function (data) {
                        console.log("RELOAD registration after account detail");
                        if (isWaitPaid) {
                            thiz._registrationChanged = true;
                            thiz.dataView.refreshDataList();   
                        }
                    });
                }
            }
        },
        {
            icon: "email",
            title: "Send Email",
            role: "primary",
            applicable: function(data) {
                return thiz._canSendMessage();
            }.bind(this),
            run: function(data, callback, event) {
                thiz.sendEmailToAccounts.call(thiz, [data]);
            }
        },
        {
            spec: function (data, value) {
                var title = "Pay & Approve";
                var icon = "checkbox-marked-circle";
                var role = "primary";
                var disabled = false;
                if (data.canceled) {
                    title = "Re-enroll";
                    icon = "restart";
                    disabled = (!thiz._canMoveReenrollClass() || !data.payment_plan_id || data.member_status_id != thiz.ACTIVE_MEMBER_STATUS || !data.dt_dob);
                } else if (!data.waiting) {
                    title = "Cancel Registration";
                    icon = "close";
                    role = "danger";
                    disabled = (!thiz._canDenyWaitlistCancelRegsitration() || !data.payment_plan_id);
                } else {
                    disabled = (!thiz._canApproveWaitlistRegistration() || !data.payment_plan_id || data.paid);
                }

                var s = {
                    _name: "button",
                    "title": title,
                    "class": "ActionButton IconOnly",
                    "action-role": role,
                    _children: [
                        {_name: "icon", "class": icon}
                    ]
                };
                if (disabled) s.disabled = disabled;
                if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
                    s.disabled = true;
                }
                return s;
            }.bind(this),
            run: function(data, callback, event) {
                var button = Dom.findParentByTagName(event.target, "button");
                if (button && button.disabled) return; 
                if (data.canceled) {
                    thiz.reactiveRegistration.call(thiz, [data], callback, event);
                } else if (!data.waiting) {
                    thiz.cancelRegistration.apply(thiz, arguments);
                } else if (!(data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key)){
                    thiz.payAndApprove.apply(thiz, arguments);
                }
            }
        }
    ));
    this.dataView.registerCustomRenderer("grouping", {
        renderer: function (data, value) {
            var wrapper = Dom.newDOMElement({_name: "vbox", class: "AttendanceNoteContainer"});
            if (window.LOGIN_INFO && window.LOGIN_INFO.enableGroupAttendanceNote) {
                var inputId = Util.newUUID();
                var groupWrapper = Dom.newDOMElement({
                    _name: "vbox",
                    class: "AttendanceNoteGroupWrapper",
                    _children: [
                        { _name: "label", _text: "Group:", "for": inputId},
                        {
                            _name: "div",
                            _children: [
                            thiz._canEditAttendanceNotes() ?
                            { 
                                _name: "input",
                                "id": inputId, 
                                "type": "text",
                                "class": "AttendanceNoteGroup",
                                value: data.grouping
                            } : {
                                _name: "span", 
                                "class": "AttendanceNoteGroup",
                                _text: data.grouping
                            }]
                        }
                    ]
                });
                wrapper.appendChild(groupWrapper);
            }
            
            
            //TODO check permission to disabled text box
            if (window.LOGIN_INFO && window.LOGIN_INFO.enableClassRooomAttendanceNote) {
                var inputId = Util.newUUID();
                var classroomWrapper = Dom.newDOMElement({
                    _name: "vbox",
                    class: "AttendanceNoteClassroomWrapper",
                    _children: [
                        { _name: "label", _text: window.LOGIN_INFO.classRoomAttendanceNoteLabel + ":", "for": inputId},
                        {
                            _name: "div",
                            _children: [
                            thiz._canEditAttendanceNotes() ?
                            { 
                                _name: "input", 
                                "id": inputId,
                                "type": "text",
                                "class": "AttendanceNoteClassroom",
                                value: data.classroom
                            } :
                            { 
                                _name: "span", 
                                "class": "AttendanceNoteClassroom",
                                _text: data.classroom
                            }]
                        }
                    ]
                });
                wrapper.appendChild(classroomWrapper);
            }
            return wrapper;
        },
        useDOMNode: true
    });
    this.dataView.registerCustomRenderer("dt_wait_reg_link_sent", function (data, _value) {
        var date = data.dt_wait_reg_link_sent ? moment(data.dt_wait_reg_link_sent).format("MM/DD/YYYY hh:mm:ss A") : "";
        return {
            _name: "span",
            _text: date
        };
    });
    thiz.dataView.boot();
};

ClassEditRegistrationWidget.prototype._canMoveReenrollClass = function() {
    return ClassAuthUtils.canMoveReenrollClass(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canDenyWaitlistCancelRegsitration = function() {
    return ClassAuthUtils.canDenyWaitlistCancelRegsitration(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canViewBilling = function() {
    return ClassAuthUtils.canViewBilling(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canSendMessage = function() {
    return ClassAuthUtils.canEmailSMSPushAccountMember(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._onlyEmailSMSPushMyInstructorClassAccountMember = function() {
    return ClassAuthUtils.onlyEmailSMSPushMyInstructorClassAccountMember(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canApproveWaitlistRegistration = function(data) {
    return ClassAuthUtils.canApproveWaitlistRegistration(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canViewAccountMemberDetail = function() {
    return ClassAuthUtils.canViewAccountMemberDetail(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canViewLimitBasicAccountMemberInfo = function() {
    return ClassAuthUtils.canViewLimitBasicAccountMemberInfo(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canChangeSlotPaymentPlanStartDropDate = function() {
    return ClassAuthUtils.canChangeSlotPaymentPlanStartDropDate(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canSendAgreementReviewReminder = function() {
    return ClassAuthUtils.canSendAgreementReviewReminder(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canExportClassRegistrations = function() {
    return ClassAuthUtils.canExportClassRegistrations(LOGIN_INFO) ||
        ClassAuthUtils.canExportMyInstructorClassRegistration(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype._canEditAttendanceNotes = function() {
    return ClassAuthUtils.canEditAttendanceNotes(LOGIN_INFO);
};
ClassEditRegistrationWidget.prototype.isStartDateEditable = function(policy, registration) {
    if (policy == null) return false;
    var limitDate = new Date(registration.dt_registration.getTime());
    limitDate.setDate(limitDate.getDate() + policy.maxFutureRegistrationLimitDays);
    if (policy.allowParentEditStartDate && registration.allowEditStartDateWhenRegCompleted && limitDate > new Date()) {
        return true;
    }
    return false;
};

ClassEditRegistrationWidget.prototype.isDropDateEditable = function(policy, registration) {
    if (policy == null) return false;
    var limitDate = new Date(registration.dt_registration.getTime());
    limitDate.setDate(limitDate.getDate() + policy.maxFutureRegistrationLimitDays);
    if (policy.allowParentEditDropDate && registration.allowEditDropDateWhenRegCompleted && limitDate < new Date()) {
        return true;
    }
    return false;
};

ClassEditRegistrationWidget.prototype.onDetached = function() {
    this.paymentPlanPopup.kill();
};

ClassEditRegistrationWidget.prototype.sendEmailToAccounts = function(registrations) {
    var ids = registrations.map(function (reg) {
        return reg.account_id;
    });
    $emailService.getReceipientInfos("email", "account", ids, function(result) {
        if (result.recipients.length > 0) {
            widget.__ensureNamespaceLoaded("ama", function(ama) {
                new ama.EmailMessageDialog(function(attachments, message, callback) {
                    $emailService.sendMessage("email", "account", ids, attachments, message, function(result) {
                        SnackBar.show("Email message sent.");
                        if (callback) callback();
                    }, function(e) {
                        ama.util.handleSendEmailError(e);
                    }, "Sending...");

                }).open({title: "Send New Email", info: result, contextTitle: "account"});
            }.bind(this));
        } else {
            Dialog.error("There are no accounts that you selected with valid emails");
        }
    }, function(e){
    }, "Loading...");


};

ClassEditRegistrationWidget.prototype.dataViewComboChangedHandler = function(event) {
    var thiz = this;
    var rowData = DataTable.getRowData(event.target);
    if (!rowData) return;
    var selectedData = ComboManager.prototype.getSelectedItem.call(event.target.__widget);
    if (Dom.hasClass(event.target.nextSibling, "SlotDetail")) {
        if (!event.fromUser) return;
        window.defaultIndicator.busy("Saving...");
        $classAdminService.updateStudentRegSlot({classInId: rowData.id, classId: rowData.class_id, id: rowData.member_id}, selectedData.slot,
            function(data) {
                window.defaultIndicator.done();
                rowData.slot = selectedData.slot;
                thiz._registrationChanged = true;
                thiz._slotChanged = true;
            },
            function(error) {
                window.defaultIndicator.done();
                Dialog.alert("Error", (error && error.message ? error.message : error), function() {
                    event.target.__widget.selectItemByKey("slot", rowData.slot);
                });
            });
    } else if (Dom.hasClass(event.target.nextSibling, "PaymentPlanDetail")) {
        window.defaultIndicator.busy("Saving...");
        $classAdminService.saveAssignedStudents([{classInId: rowData.id, paymentPlanId: selectedData.id}], false, function(data) {
            window.defaultIndicator.done();
            rowData.slot = selectedData.id;
            thiz._registrationChanged = true;
        }, function(error) {
            window.defaultIndicator.done();
            console.error("[ERROR] fail to update PaymentPlan data with error:", error);
        });
    }
};

ClassEditRegistrationWidget.prototype.dataViewStartDropDateChangedHandler = function(event) {
    var thiz = this;
    if (!Dom.hasClass(event.target.parentNode, "StartDropDatePolicy")) return;
    var rowData = DataTable.getRowData(event.target);
    var date = event.target.__widget.getDate();
    var startDateBefore = rowData.start_drop_date_policy_start_date;
    var dropDateBefore = rowData.start_drop_date_policy_drop_date;
    var data = {
        lessonClassInId: rowData.id,
        sddPolicyStartDate: rowData.start_drop_date_policy_start_date,
        sddPolicyDropDate: rowData.start_drop_date_policy_drop_date
    }
    if (Dom.hasClass(event.target.parentNode, "StartDate")) {
        if (date && data.sddPolicyDropDate && date.getTime() > data.sddPolicyDropDate.getTime()) {
            Dialog.error("Error", "Cannot update start date to "
            + FormatUtil.formatDateWithTZID(date, "date_standard", rowData.timezone_id) +
            " because start date is greater than drop date. Roll back to previous choice.", function () {
                event.target.__widget.setDate(ClassUtils.transformToTimeZone(data.sddPolicyStartDate, rowData.timezone_id));
            });
            return;
        }
        data.sddPolicyStartDate = date;
    }
    if (Dom.hasClass(event.target.parentNode, "DropDate")) {
        if (date && data.sddPolicyStartDate && data.sddPolicyStartDate.getTime() > date.getTime()) {
            Dialog.error("Error", "Cannot update drop date to "
            + FormatUtil.formatDateWithTZID(date, "date_standard", rowData.timezone_id) +
            " because start date is greater than drop date. Roll back to previous choice.", function () {
                event.target.__widget.setDate(ClassUtils.transformToTimeZone(data.sddPolicyDropDate, rowData.timezone_id));
            });
            return;
        }
        data.sddPolicyDropDate = date;
    }
    window.defaultIndicator.busy("Saving...");
    $classAdminService.updateStartDropDatePolicy(data,
        function(res) {
            window.defaultIndicator.done();
            rowData.start_drop_date_policy_start_date = data.sddPolicyStartDate;
            rowData.start_drop_date_policy_drop_date = data.sddPolicyDropDate;
        },
        function(error) {
            window.defaultIndicator.done();
            Dialog.error("Error", error.message, function () {
                if (Dom.hasClass(event.target.parentNode, "StartDate")) {
                    event.target.__widget.setDate(ClassUtils.transformToTimeZone(startDateBefore, rowData.timezone_id));
                }
                if (Dom.hasClass(event.target.parentNode, "DropDate")) {
                    event.target.__widget.setDate(ClassUtils.transformToTimeZone(dropDateBefore, rowData.timezone_id));
                }
            });
        });
};

ClassEditRegistrationWidget.prototype.dataViewClickedHandler = function(data, fieldName, cell, event) {
    var thiz = this;
    if (this._lastFocusedPaymentPlanLink) Dom.removeClass(this._lastFocusedPaymentPlanLink, "Focused");

    var link = Dom.findParentWithClass(event.target, "InfoLink");
    if (!link) return;

    this._lastFocusedPaymentPlanLink = link;
    Dom.addClass(link, "Focused");

    if (Dom.hasClass(link, "MemberFullName")) {
        if (!thiz._canViewLimitBasicAccountMemberInfo()) return;
        widget.__ensureNamespaceLoaded("ama", function (ama) {
            new ama.MembersDetailDialog().callback(function(updated) {
                if (updated) thiz.dataView.refreshDataList();
            }).open({ids: [data.member_id]});
        }.bind(this));
    }
    if (Dom.hasClass(link, "AccountFullName")) {
        this.openAccountDetailDialog(data.account_id, "", "clpayplan.ClassEditRegistrationWidget", function (data) {
            console.log("RELOAD registration after account detail");
            thiz._registrationChanged = true;
            thiz.dataView.refreshDataList();
        }, true);
    }
    if (Dom.hasClass(link, "SlotDetail") && !Dom.hasClass(link, "Disabled")) {
        this.showSlotDetail(link, data);
        return;
    }
    if (Dom.hasClass(link, "PaymentPlanDetail")) {
        this.showPaymentPlanDetail(link, data);
        return;
    }
    if (Dom.hasClass(link, "RequiredNotSigned") || Dom.hasClass(link, "OptionalNotSigned")) {
        this.openAccountDetailDialog(data.account_id, "agreements", "clpayplan.ClassEditRegistrationWidget", function (data) {
            thiz._registrationChanged = true;
            thiz.dataView.refreshDataList();
        });
        
        return;
    }

    if (Dom.hasClass(link, "TransferredActionLink")) {
        this.showClassTransferDetail(link, data.transferClassInItems);
        return;
    }
    
};

ClassEditRegistrationWidget.prototype.showClassTransferDetail = function(target, transferClassInItems) {
    if (!transferClassInItems || transferClassInItems.length < 1) return;
    if (!this.classTransferPopup) this.classTransferPopup = new __pkg.RegistrationClassTransferPopup();
    this.classTransferPopup.showPopupAt(target, transferClassInItems);
};

ClassEditRegistrationWidget.prototype.openAccountDetailDialog = function (accountId, targetTab, fromWidget, dialogCallback, forViewingLimitInfo) {
    if (forViewingLimitInfo && !this._canViewLimitBasicAccountMemberInfo()
        || !forViewingLimitInfo && !this._canViewAccountMemberDetail()) {
        return;
    }
    
    widget.__ensureNamespaceLoaded("ama", function (ama) {
        new ama.AccountsDetailDialog().callback(dialogCallback).open({ids: [accountId], targetTab: targetTab || "", fromWidget: fromWidget || ""});
    }.bind(this));
};
ClassEditRegistrationWidget.prototype.openClassAddToolDialog = function (movedLessonClassIns, newClassInfo) {
    var thiz = this;
    thiz.isRegistrationsChanged = false;
    var memberIds = movedLessonClassIns.map(function(classIn) {
        return classIn.member_id;
    });
    
    var defaultPaymentPlan = -1;
    if (newClassInfo && newClassInfo.paymentPlans && newClassInfo.paymentPlans.length == 1) {
        defaultPaymentPlan = newClassInfo.paymentPlans[0].id;
    }
    var defaultRegSlot = -1;
    if (newClassInfo.assignedSlot >= 0) {
        defaultRegSlot = newClassInfo.assignedSlot;
    } else if (newClassInfo.slots && newClassInfo.slots.length == 1) {
        defaultRegSlot = newClassInfo.slots[0].slot;
    }
    
    var registrationsOptions = {
        classId: newClassInfo.id,
        title: newClassInfo.title,
        defaultRegSlot: defaultRegSlot,
        defaultPaymentPlan: defaultPaymentPlan,
        movedLessonClassIns: movedLessonClassIns,
        addedMemberIds: memberIds,
        registrationsChanged: function (isRegistrationsChanged) {
            thiz.isRegistrationsChanged = isRegistrationsChanged;
        }
    };
    var registrationsDialog = new RegistrationsDialog().callback(function (registrationsData) {
        if (thiz.isRegistrationsChanged) {
            if (window.__pkg.widget.namespaces.finance) {
                CommonEvent.fireEvent("finance", window.__pkg.widget.namespaces.finance.AccountLedgerWidget.EV_ON_DATAVIEW_DATA_CHANGE, {});
            }
            CommonEvent.fireEvent(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED);
        }
    }).open(registrationsOptions);
};

ClassEditRegistrationWidget.prototype.cancelRegistration = function (data, callback, event) {
    if (!this._canDenyWaitlistCancelRegsitration()) return;
    var thiz = this;
    Dialog.confirmDangerousAction("Do you want to cancel the registration for student \"" + data.memberFullName + "\"?", "",
        "Cancel Registration", function() {
            window.defaultIndicator.busy("Waiting...");
            $classAdminService.cancelRegistration(data.id, function () {
                    window.defaultIndicator.done();
                    SnackBar.show("The registration for student " + data.memberFullName + " is canceled.");
                    thiz._registrationChanged = true;
                },
                function(error) {
                    window.defaultIndicator.done();
                    console.log("Fail to cancel the registration for this student with error:", error);
                });
        },
        "Cancel", function() {});
};

ClassEditRegistrationWidget.prototype.payAndApprove = function (data, callback, event) {
    if ((!this._canApproveWaitlistRegistration()) || !data.payment_plan_id || (data.paid && !data.waiting) || data.canceled) {
        return;
    }
    
    var thiz = this;
    this._registrationChanged = true;
    var alias = typeof(ADMIN_CONTEXT) != "undefined" ? ADMIN_CONTEXT.teamAlias :
        typeof (g_teamAlias) != "undefined" ? g_teamAlias :
        typeof (TEAM_INFO) != "undefined" ? (TEAM_INFO.teamAlias || TEAM_INFO.alias) : "";

    var url = String.format("/LClassInPay.jsp?team={0}&stringid={1}_{2}_{3}&permission=finance", alias, data.account_id, data.reg_idx, data.idx);
    var iframeContentDialog = new IFrameContentDialog({src: url, title: "Pay & Approve"});
    iframeContentDialog.getDialogActions = function() {
        return [
            {
                type: "cancel", title: "Close",
                isCloseHandler: true,
                run: function () {
                    console.log("CLOSE PAY AND APPOVE", thiz, thiz.dataView);
                    CommonEvent.fireEvent(ClassUtils.MODULE_CLASSMGMT, ClassUtils.EVENT_REGISTRATION_DATA_CHANGED);
                    return true;
                }
            }
        ];
    }
    iframeContentDialog.open();
};

ClassEditRegistrationWidget.prototype.reactiveRegistration = function(registrations, callback, event) {
    if (!this._canMoveReenrollClass()) return;
    var thiz = this;
    var memberMap = registrations.reduce(function(a, c) {
        if (!a[c.member_id]) a[c.member_id] = 1;
        else a[c.member_id] += 1;
        return a;
    }, {});
    for (var memId in memberMap) {
        if (memberMap[memId] > 1) {
            Dialog.alert("Error", "Re-enroll registrations of the same member to a single class is not allowed.");
            return;
        }
    }

    var activeRegistrationName = [], inactiveRegistration = [], inactiveMember = [], 
        inactiveRegistrationMemberId = 0;
    for (var i = 0; i < registrations.length; i ++) {
        if (registrations[i].canceled) {
            if (registrations[i].member_status_id != this.ACTIVE_MEMBER_STATUS) {
                inactiveMember.push(registrations[i].memberFullName);
            } else {
                inactiveRegistration.push(registrations[i]);
                if (inactiveRegistrationMemberId == 0) inactiveRegistrationMemberId = registrations[i].member_id;
            }            
        } else {
            var message = registrations[i].class_title + ", slot #" + (registrations[i].slot + 1) + " of member " + registrations[i].memberFullName;
            activeRegistrationName.push(message);
        }
    }

    if (activeRegistrationName.length || inactiveMember.length) {
        var errorMessage = "";
        if (activeRegistrationName.length) {
            errorMessage += "[" + activeRegistrationName.join(", ") + "] won't be re-enrolled.";
        } else if (inactiveMember.length) {
            if (errorMessage.length) errorMessage += " ";
            errorMessage += "[" + inactiveMember.join(", ") + "] is inactive member can not be re-enrolled.";            
        }       
        
        Dialog.confirm(errorMessage + " Continue to re-enroll the other registrations?", "",
        "Re-enroll", function() {
            thiz._reactiveRegistrations(inactiveRegistration);
        },
        "Cancel", function() {});
    } else {
        var targetStr = inactiveRegistration.length > 1 ? (inactiveRegistration.length + " registrations") : inactiveRegistration[0].memberFullName;
        Dialog.confirm(targetStr + " will be re-enrolled in the class. Continue?", "",
            "Re-enroll", function() {
                thiz._reactiveRegistrations(inactiveRegistration);
            },
            "Cancel", function() {});
    }
};

ClassEditRegistrationWidget.prototype._reactiveRegistrations = function(data) {
    if (!data.length) {
        Dialog.error("There is no cancelled registration to be re-enrolled. Please choose at least one cancelled registration to re-enroll.");
        return;
    }
    var thiz = this;
    var addedMemberIds = [], mapMemberSlot = {};
    data.forEach(function (registration) {
        mapMemberSlot[registration.class_id + "_" + registration.member_id] = registration.slot;
        addedMemberIds.push(registration.member_id);
    });
    
    $classAdminService.getClassDetailById(data[0].class_id, function (classData) {
        var registrationsOptions = {
            classId: classData.id,
            title: classData.title,
            ageText: classData.ageText,
            allowedGender: classData.allowedGender,
            ageLow: classData.ageLow,
            ageHi: classData.ageHi,
            dateAgeUp: classData.dateAgeUp,
            insuranceOptions: classData.insuranceOptions,
            emergencyOptions: classData.emergencyOptions,
            addedMemberIds: addedMemberIds,
            mapMemberSlot: mapMemberSlot,
            isReenrollingReg: true,
            registrationsChanged: function (changed) {
                if (changed) thiz.dataView.refreshDataList();                
            }
        };
        var registrationsDialog = new RegistrationsDialog().callback(function (registrationsData) {
        }).open(registrationsOptions);
    }, function (err) {
        
    }, "Loading...");    
};

ClassEditRegistrationWidget.prototype.showSlotDetail = function(target, data) {
    var thiz = this;
    this.options.classInfo.slots.forEach(function(item) {
        if (item.slot == data.slot) {
            thiz.renderSlotTimesContent(item);
        }
    });
    Dom.addClass(this.slotInstancePopupContent.parentNode, "SlotInstancePopup");
    this.slotInstancePopup.show(target, "right-inside", "bottom", 0, 0, true);
};

ClassEditRegistrationWidget.prototype.renderSlotTimesContent = function (selectedSlot) {
    this.slotInstancePopupContent.innerHTML = "";
    if (!selectedSlot.slotTimes || selectedSlot.slotTimes.length == 0) return;
    if (selectedSlot.slotTimes.length > 4) {
        this.slotInstancePopupContent.style.width = "28.5em";
    } else if (selectedSlot.slotTimes.length == 4) {
        this.slotInstancePopupContent.style.width = "19em";
    } else {
        this.slotInstancePopupContent.removeAttribute("style");
    }
    for (var i = 0; i < selectedSlot.slotTimes.length; i ++) {
        var slotTimeElm = document.createElement("div");
        Dom.addClass(slotTimeElm, "SlotTimeItem");
        slotTimeElm.innerHTML = selectedSlot.slotTimes[i];
        this.slotInstancePopupContent.appendChild(slotTimeElm);
    }
    var clearBoth = document.createElement("div");
    Dom.addClass(clearBoth, "ClearBoth");
    this.slotInstancePopupContent.appendChild(clearBoth);

    this.regSlotPopupSlotName.innerHTML = "Reg Slot #" + (selectedSlot.slot + 1);
};

ClassEditRegistrationWidget.prototype.showPaymentPlanDetail = function(target, data) {
    var gridData = {
        classInfo: this.options.classInfo,
        items: [],//paymentPlan.items,
        selectedSlot: data.slot,
        paymentPlanId: data.payment_plan_id,
        startProjectedDate: data.dt_created,
        filters: {},
        callback: null,
        readOnly: true,
        isClassAdmin: ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO),
        projectedLessonClassInId: data.id
    };
    if (data.start_drop_date_policy_start_date) {
        gridData.startProjectedDate = data.start_drop_date_policy_start_date;
    }
    if (data.start_drop_date_policy_drop_date) {
        gridData.endProjectedDate = data.start_drop_date_policy_drop_date;
    }
    this.options.classInfo.paymentPlans.forEach(function(pp) {
        if (pp.id == data.payment_plan_id) {
            gridData.items = pp.items;
        }
    });
    this.paymentPlanPopup.popupContainer.innerHTML = "";

    var thiz = this;
    gridData.finishLoadingCallback = function () {
        thiz.paymentPlanPopup.show(target, "left-inside", "top", 0, 5, true);
    };
    this.paymentPlanItemGrid = new __pkg.PaymentPlanItemGrid(gridData).into(this.paymentPlanPopup.popupContainer);
};

ClassEditRegistrationWidget.prototype.sendAgreementReview = function (ids, editable) {
    var emailContentInfo = {
        subject: "Please Review Agreements on Your Account",
        message: ClassUtils.getAreementEmailContentTemaplate(ADMIN_CONTEXT.teamAlias, LOGIN_INFO.myAccountAgreementLink)
    };
    widget.__ensureNamespaceLoaded("ama", function(ama) {
        $waiverNotificationService.getReceipientInfosForAgreement("email", "account", ids, function (res) {
            if (res.recipients.length > 0) {
                if (editable) {
                    new ama.EmailMessageDialog(function(attachments, message, callback) {

                        $waiverNotificationService.sendAgreementReview("email", "account", ids, attachments, message, function(result) {
                            SnackBar.show("Email message sent.");
                            if (callback) callback();
                        }, function(e) {
                            ama.util.handleSendEmailError(e);
                        }, "Sending...");

                    }).open({title: "Send Agreement Review Reminder", info: res, contextTitle: "account", emailContentInfo: emailContentInfo});
                } else {
                    $waiverNotificationService.sendAgreementReview("email", "account", ids, [], emailContentInfo, function (result) {
                        SnackBar.show("Email message sent.");
                    }, function(e) {
                        ama.util.handleSendEmailError(e);
                    }, "Sending...");
                }
            } else {
                Dialog.error("There are no accounts that you selected with valid emails");
            }
        }, function(e){

        }, "Loading...");
    }.bind(this));
};

ClassEditRegistrationWidget.prototype.cancelRegistrations = function (registrations) {
    var thiz = this;
    var memberNames = [], activeRegIds = [], activeRegsMemberNames = [], notActiveRegIds = [], notActiveRegMemberNames = [];
    registrations.forEach(function (data) {
        memberNames.push(data.memberFullName);
        var status = (!data.canceled && data.waiting) ? "Waiting" : ((data.canceled || thiz.isDropDatePassed(data))? "Inactive" : "Active");
        if (status == "Active") {
            activeRegIds.push(data.id);
            activeRegsMemberNames.push(data.memberFullName);
        } else {
            notActiveRegIds.push(data);
            notActiveRegMemberNames.push((data.memberFullName + " (slot #)" + (data.slot + 1)));
        }
    });

    Dialog.confirmDangerousAction("Do you want to cancel these registrations?", "",
        "Cancel Registration", function() {
            if (activeRegIds.length > 0 && activeRegIds.length == registrations.length) {
                thiz.doCancelRegistrations(activeRegIds, activeRegsMemberNames);
            } else if (notActiveRegIds.length > 0) {
                Dialog.confirmDangerousAction("These registrations cannot be cancelled: " +
                " \"" + notActiveRegMemberNames.join(", ") + "\"", "Continue to cancel the other registrations?",
                    "Cancel Registration", function() {
                        thiz.doCancelRegistrations(activeRegIds, activeRegsMemberNames);
                    },
                    "Cancel", function() {});
            }
        },
        "Cancel", function() {});
};

ClassEditRegistrationWidget.prototype.doCancelRegistrations = function (ids, activeRegsMemberNames) {
    if (ids.length == 0) {
        SnackBar.show("There are no registration is cancelled.");
        return;
    }
    var thiz = this;
    window.defaultIndicator.busy("Waiting...");
    $classAdminService.cancelRegistrations(ids, function () {
        window.defaultIndicator.done();
        SnackBar.show("The registration for student " + " \"" + activeRegsMemberNames.join(", ") + "\" is canceled.");
        thiz._registrationChanged = true;
    },
    function(error) {
        window.defaultIndicator.done();
        console.log("Fail to cancel the registration for this student with error:", error);
    });
};



ClassEditRegistrationWidget.prototype.inputHandler = function(event) {
    if (!this._canEditAttendanceNotes()) return;
    if (!Dom.hasClass(event.target, "AttendanceNoteGroup")
        && !Dom.hasClass(event.target, "AttendanceNoteClassroom")) {
        return;
    }
    var thiz = this;
    if (this.inputingAttendanceNoteTimeout) {
        window.clearTimeout(thiz.inputingAttendanceNoteTimeout);
    }
    this.inputingAttendanceNoteTimeout = window.setTimeout(function () {
        var rowData = DataTable.getRowData(event.target);
        if (!rowData) return;
        var grouping = rowData.grouping ? rowData.grouping : "";
        var classroom = rowData.classroom ? rowData.classroom : "";
        if (Dom.hasClass(event.target, "AttendanceNoteGroup")) {
            grouping = event.target.value.trim();
        } else if (Dom.hasClass(event.target, "AttendanceNoteClassroom")) {
            classroom = event.target.value.trim();
        }
        $classAdminService.updateAttendanceNote(grouping, classroom, rowData.id, function (res) {
            rowData.grouping = grouping;
            rowData.classroom = classroom;
        }, function (error) {
            Dialog.error("Error", error.message, function () {
                if (Dom.hasClass(event.target.parentNode, "AttendanceNoteGroup")) {
                    event.target.value = rowData.grouping;
                }
                if (Dom.hasClass(event.target.parentNode, "AttendanceNoteClassroom")) {
                    event.target.value = rowData.classroom;
                }
            });
        }, "Saving...");
    }, 1000);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/ClassRegFeeEditDialog.js";

function ClassRegFeeEditDialog() {
    ModificationWatchDialog.call(this);
    this.title = "Class Registration Fee Per Family";
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.feePerFamily, "Please input 'Fee Amount'")
        .min(this.feePerFamily, 0, false, "'Fee Amount' value must be greater than or equal 0");

    this.feePerFamilyCoa.comparer = function(selected, item) {
        return selected.id == item.id;
    };
    this.feePerFamilyCoa.renderer = function(item) {
        return item.name;
    };
}
__extend(ModificationWatchDialog, ClassRegFeeEditDialog);

ClassRegFeeEditDialog.prototype.setup = function(data) {
    this.classInfo = data.classInfo;
    this.filters = data.filters;

    this.feePerFamily.setValue(this.classInfo.familyRegFee || 0);
    this.feePerFamilyCoa.setItems(this.filters.chargeCategories);

    if (this.classInfo.familyRegCoaId) {
        this.feePerFamilyCoa.selectItemById(this.classInfo.familyRegCoaId);
    }
    this.setSnapshotInputValues(this.getCurrentInputValues());
};

ClassRegFeeEditDialog.prototype.getChangeEventNames = function() {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

ClassRegFeeEditDialog.prototype.getCurrentInputValues = function() {
    return {
        familyRegFee: (this.feePerFamily.getValue() ? parseFloat(this.feePerFamily.getValue()) : 0),
        familyRegCoaId: this.feePerFamilyCoa.getSelectedItem() ? this.feePerFamilyCoa.getSelectedItem().id : 0
    };
};

ClassRegFeeEditDialog.prototype.save = function(callback) {
    if (!ValidationManager.run(this.validationRules)) return false;
    if (callback) callback(this.getCurrentInputValues());
};

ClassRegFeeEditDialog.prototype.getDialogActions = function () {
    var thiz = this;
    var actions = [].concat(ModificationWatchDialog.prototype.getDialogActions.call(this));

    actions.push({
        type: "extra", title: "Remove Fee",
        run: function () {
            thiz.close({
                familyRegFee: 0,
                familyRegCoaId: this.feePerFamilyCoa.getSelectedItem() ? this.feePerFamilyCoa.getSelectedItem().id : 0
            });
            return false;
        }
    });

    return actions;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/ClassSelectorDialog.js";

function ClassSelectorDialog() {
    Dialog.call(this);
    this.grabHeight = true;
    this.title = "Move Class";
    this.options = {};
    this.filterMap = {};
    var thiz = this;
    this.bind("p:PageLoaded", function(e) {
        if (!e.detail) return;
        if (e.detail.totalItems > 1) {
            thiz.totalClassCount.innerHTML = e.detail.totalItems + " Classes";
        } else {
            thiz.totalClassCount.innerHTML = e.detail.totalItems + " Class";
        }
    }, this.dataView.node());
    this.dataView._convertFilterMap = function (valueMap) {
        var map = {};
        if (valueMap) {
            for (var name in valueMap) map[name] = valueMap[name];
        }
        map.excludedClassIds = thiz.options.map(function(reg) { return reg.class_id; });
        map.paymentPlanRequired = true;
        map.slotRequired = true;
        return map;
    };
    this.dataView.onSpecificationLoaded = function(spec) {
        thiz.initFilterMapping(spec.filters);
    };
    this.dataView.setDefaultSelectionHandler(function(data, fieldName, cell, event) {
        if (thiz.slotDetailPopupShowed) {
            thiz.slotDetailPopupShowed = false;
            return;
        }
        if ("timeSlot" != fieldName) {
            thiz.close(data);
        }
    });

    this.slotRenderer = function (data, selected) {
        if (!data) return "&nbsp;";
        var text = "<strong>Reg Slot #" + (data.slot + 1) + "</strong> | ";
        if (data.maxLimit >= 99999) {
            text += data.slotRegister;
        } else {
            if (data.slotOpen <= 0) {
                text += "Full";
            } else {
                text += data.slotRegister + "/" + data.maxLimit;
            }
        }
        text += " Reg  |";
        var maxLength = 2;
        if (data.slotTimes.length < 2) maxLength = data.slotTimes.length;
        for (var i = 0; i < maxLength; i++) {
            text += "<span>&nbsp;&nbsp;" + data.slotTimes[i] + "</span>";
        }
        if (data.slotTimes.length > maxLength) text += " +" + (data.slotTimes.length - maxLength);

        var _children = [{
            _name: "div",
            _html: text
        }];

        return Dom.newDOMElement({
            _name: "hbox",
            "class": "TransferClassSlotComboItem",
            _children: _children
        });
    };
    this.slotDisplayValue = function (data) {
        if (!data) return "&nbsp;";
        return "RS #" + (data.slot + 1);
    };

    this.slotInstancePopup.popupOpacity = 0.9999;
    this.slotInstanceBackgroundBox.translateDelta = 0.5;
    this.slotInstancePopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        }
        thiz.slotInstanceBackgroundBox.onSizeChanged();
    }

    Dom.registerEvent(this.dataView.node(), "click", this.dataViewClickedHandler.bind(this), true);
    this.bind("p:ItemSelected", this.dataViewComboChangedHandler, this.dataView.node());
    this.bind("p:PopupHidden", function () {
        window.setTimeout(function() {
            thiz.slotDetailPopupShowed = false;
        }, 100);
    }, this.slotInstancePopup);

    this.bind("p:SelectionChanged", this.dataViewSelectionChanged, this.dataView);

}
__extend(Dialog, ClassSelectorDialog);

ClassSelectorDialog.prototype.initFilterMapping = function(filterMap) {
    var thiz = this;
    filterMap.forEach(function(filterObject) {
        thiz.filterMap[filterObject.fieldName] = filterObject.values;
        if (filterObject.fieldName == "session_id" && filterObject.extra) {
            filterObject.extra.noneSelectionText = "All " + "Sessions";
        }
    });
};

ClassSelectorDialog.prototype.setup = function(registrations) {
    this.options = registrations;
    this.headerTitle.innerHTML = "<label>Move <strong>"
        + (registrations.length > 1 ? (registrations.length + " selected Registrations</strong>")
            : (registrations[0].name + "'s Registration</strong> from class <strong>" + registrations[0].class_title + "</strong>"))
        + " to new class</label>";
    var thiz = this;
    window.setTimeout(function() {
        thiz.setupDataView();
        thiz.dataView.boot();
    }, 100);
};

ClassSelectorDialog.prototype.setupDataView = function() {
    this.dataView.registerCustomRenderer("dateStart", function (data, value) {
        var children = [];
        if(data.dateStart) children.push({_name: "div", _html: FormatUtil.formatDate(data.dateStart, "date_standard", "local")});
        if(data.dateEnd) children.push({_name: "div", _html: FormatUtil.formatDate(data.dateEnd, "date_standard", "local")});
        return {
            _name: "div",
            _children: children
        }
    });
    this.dataView.registerCustomRenderer("duration", function (data, value) {
        return {
            _name: "div",
            _html: value + "m"
        }
    });

    var thiz = this;

    this.dataView.registerCustomRenderer("timeSlot", {
        renderer: function (data, value) {
            var slotCombo = new ComboManager();
            Dom.addClass(slotCombo.node(), "TransferClassRegSlotCombo");
            slotCombo.useHtml = true;
            slotCombo.renderer = thiz.slotRenderer;
            slotCombo.getDisplayValue = thiz.slotDisplayValue;
            slotCombo.setItems([null]);
            return {
                _name: "hbox",
                "class": "TimeSlotWrapper",
                _children: [
                    slotCombo, {
                        _name: "icon",
                        "class": "TransferClassSlotInfoIcon information"
                    }
                ]
            };
        },
        useDOMNode: true
    });


};
ClassSelectorDialog.prototype.shouldShowUnapplicableButtons = function () {
    return true;
};

ClassSelectorDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "accept", title: "Transfer to selected class",
            isApplicable: function () {
                var items = thiz.dataView.getSelectedItems();
                if (items && items.length == 1) return true;
                return false;
            },
            run: function () {
                var items = this.dataView.getSelectedItems();
                if (items && items.length == 1) {
                    thiz.close(items[0]);
                }
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.close(false);
            }
        }
    ];
};


ClassSelectorDialog.prototype.dataViewClickedHandler = function (event) {
    if (this.slotDetailPopupShowed) {
        this.slotInstancePopup.hide();
        event.stopPropagation();
        return;
    }

    var slotInfoButton = Dom.findParentWithClass(event.target, "TransferClassSlotInfoIcon");
    if (slotInfoButton) {
        event.stopPropagation();
        var regSlotCombo = Dom.findChildWithClass(slotInfoButton.parentNode, "TransferClassRegSlotCombo");
        if (!regSlotCombo) return;
        var selectedSlot = regSlotCombo.__widget.getSelectedItem();
        if (selectedSlot) {
            this.showSlotDetail(slotInfoButton, selectedSlot);
            this.slotDetailPopupShowed = true;
        }
        return;
    }

    var regSlotCombo = Dom.findParentWithClass(event.target, "TransferClassRegSlotCombo");
    if (regSlotCombo) {
        var thiz = this;
        event.stopPropagation();
        var rowData = DataTable.getRowData(regSlotCombo);
        if (!rowData) return;
        if (!this.loadedClassInfoMap) this.loadedClassInfoMap = {};
        var loadedClass = this.loadedClassInfoMap[rowData.id];
        if (loadedClass) {
            regSlotCombo.__widget.show();
        } else {
            $classAdminService.getClassDetailById(rowData.id, function (res) {
                thiz.loadedClassInfoMap[rowData.id] = res;
                thiz.fillSlotCombo(regSlotCombo, res.slots);
                regSlotCombo.__widget.show();
            }, function (err) {

            }, "Loading...");
        }
        return;
    }
};

ClassSelectorDialog.prototype.fillSlotCombo = function (slotCombo, items) {
    if (slotCombo && items && items.length > 0) {
        slotCombo.__widget.setItems([null].concat(items));
    }
};

ClassSelectorDialog.prototype.dataViewComboChangedHandler = function (event) {
    var regSlotCombo = Dom.findParentWithClass(event.target, "TransferClassRegSlotCombo");
    if (!regSlotCombo) return;
    var rowData = DataTable.getRowData(regSlotCombo);
    if (!rowData) return;
    var selectedSlot = regSlotCombo.__widget.getSelectedItem();
    if (selectedSlot) {
        rowData.assignedSlot = selectedSlot.slot;
        Dom.addClass(regSlotCombo.parentNode, "AssignedSlot");
    } else {
        rowData.assignedSlot = -1;
        Dom.removeClass(regSlotCombo.parentNode, "AssignedSlot");
    }
};

ClassSelectorDialog.prototype.showSlotDetail = function (target, selectedSlot) {
    this.slotInstancePopupContent.innerHTML = "";
    if (!selectedSlot.slotTimes || selectedSlot.slotTimes.length == 0) return;
    if (selectedSlot.slotTimes.length > 4) {
        this.slotInstancePopupContent.style.width = "28.5em";
    } else if (selectedSlot.slotTimes.length == 4) {
        this.slotInstancePopupContent.style.width = "19em";
    } else {
        this.slotInstancePopupContent.removeAttribute("style");
    }
    for (var i = 0; i < selectedSlot.slotTimes.length; i ++) {
        var slotTimeElm = document.createElement("div");
        Dom.addClass(slotTimeElm, "SlotTimeItem");
        slotTimeElm.innerHTML = selectedSlot.slotTimes[i];
        this.slotInstancePopupContent.appendChild(slotTimeElm);
    }
    var clearBoth = document.createElement("div");
    this.slotInstancePopupContent.appendChild(clearBoth);
    this.regSlotPopupSlotName.innerHTML = "Reg Slot #" + (selectedSlot.slot + 1);
    Dom.addClass(this.slotInstancePopupContent.parentNode, "TransferClassSlotInstancePopup");
    this.slotInstancePopup.show(target, "right-inside", "bottom", 0, 0, true);
};

ClassSelectorDialog.prototype.dataViewSelectionChanged = function () {
    this.invalidateElements();
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/ComposeEmailDialog.js";

function ComposeEmailDialog(sender) {
    this.grabHeight = true;
    Dialog.call(this);
    this.sender = sender;
}
__extend(Dialog, ComposeEmailDialog);

ComposeEmailDialog.prototype.setup = function (data) {
    this.title = data.title || "New message";
    this.data = data;
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.subjectText, "Please enter email subject.");

    this.domains = ["com", "net", "org"];
    if (window.LOCALE) {
        this.domains.push(window.LOCALE.language == "en-US" ? "us" : window.LOCALE.language == "en-AU" ? "au" : "uk");
    }
    var thiz = this;
    var source = function (term, callback) {
        if (!term || term.length == 0) {
            callback([]);
            return;
        }
        var items = [];
        var p = term.indexOf("@");
        var d = term.lastIndexOf(".");

        if (term.match(ValidationManager.patterns.EMAIL_REGEX)) {
           items.push(term);
        }
        if (p > 0 && d > p && d == term.length - 1) {
            for (var i = 0; i < thiz.domains.length; i++) {
                items.push(term + thiz.domains[i]);
            };
        }
        callback(items);
    };
    var renderer = function (email) {
        return email;
    };
    this.moreRecipients.isSelectItemEvent = function(event) {
        return event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN
            || event.keyCode == DOM_VK_SPACE || event.keyCode == DOM_VK_COMMA;
    }
    this.moreRecipients.setup(source, renderer);
    var infoText = data.recipients.length + " " + data.contextTitle + "(s).";
    Dom.setInnerText(this.toInfoLabel, infoText);

    this.bind("click", function() {
        InfoTip.show(this.toInfoLabel,
            data.recipients.map(function(r) {return r.address;}).join(", ") , false, null, "tooltip", "left-inside", 0);
    }, this.toInfoLabel);

};

ComposeEmailDialog.prototype.handleSend = function() {
    if (!ValidationManager.run(this.validationRules)) return;
    var files = this.fileUploadView.getSelectedLocalFiles();
    var extraReceipients = this.moreRecipients.getItems() || [];
    var extraEmail = this.moreRecipients.autoCompleteInput.node().value.trim();
    if (extraEmail.length > 0 && extraEmail.match(ValidationManager.patterns.EMAIL_REGEX)) {
        extraReceipients.push(extraEmail);
    }
    var recipients = this.data.recipients.concat(extraReceipients.map(function(r) {
        return { name: "", address: r };
    }));
    var emailData = {
        subject: this.subjectText.value.trim(),
        recipients: recipients,
        message: this.messageEditor.getContent(),
        extraStyles: this.messageEditor.getContentStylesheet()
    };
    var thiz = this;
    if (!thiz.sender) {
        this.close();
        return;
    }
    this.sender.send(emailData, files, this.close.bind(this));
};

ComposeEmailDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return  [
        {
            type: "accept", title: "Send",
            run: function () { thiz.handleSend(); return false; }
        }, {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/NewPaymentPlanItemDialog.js";

function NewPaymentPlanItemDialog() {
    ModificationWatchDialog.call(this);
    this._useSmoothReszing = true;
    this.bind("change", this.radioItemValueChanged, this.containerWrapper);
    this.bind("click", this.addNRChargeAtItemClickedHandler, this.addNRChargeAtItem);
    this.bind("p:ValueUpdated", this.nrChargeAtWrapperUpdatedHandler, this.nrChargeAtWrapper);
    this.bind("p:ItemSelected", this.nrChargeAtSelectedHandler, this.nrChargeAtWrapper);
    this.bind("click", this.nrChargeAtItemsClikedHandler, this.nrChargeAtItems);
    this.bind("p:CurrencyValueChanged", this.chargeItemAmountChangedHandler, this.nrChargeAtWrapper);
    this.bind("p:ItemSelected", this.rChargeEveryMonthlyComboChangedHandler, this.rChargeEveryMonthlyCombo);
    this.bind("p:ItemSelected", function (e) {
        if (e.fromUser) this.selectedRatePlan = this.rpRatePlanCombo.getSelectedItem();
        this.rpRatePlanSelectionChangedHandler();
    }.bind(this), this.rpRatePlanCombo);
    this.bind("click", function () {
        var selectedRatePlan = this.rpRatePlanCombo.getSelectedItem();
        this.selectedRatePlan = selectedRatePlan;
        new RatePlanDialog().callback(function (data) {
            if (data) {
                this.loadRatePlanList();
                var ppi = this.options.paymentPlanItem;
                if (ppi && ppi.ratePlanId == data.id) {
                    ppi.ratePlan = data;
                    Dom.emitEvent(ClassEditPaymentPlanTab.RATE_PLAN_CHANGE, this.options.editAction, {paymentPlanItem: ppi});
                }
            }
        }.bind(this)).open(selectedRatePlan);
    }.bind(this), this.editRatePlanButton);
    this.bind("click", function () {
        new RatePlanDialog().callback(function (data) {
            if (data) this.loadRatePlanList(function () {
                thiz.selectedRatePlan = data;
                thiz.rpRatePlanCombo.selectItemByKey("id", data.id, true);
                var ppi = thiz.options.paymentPlanItem;
                if (ppi) {
                    ppi.ratePlan = data;
                    Dom.emitEvent(ClassEditPaymentPlanTab.RATE_PLAN_CHANGE, thiz.options.editAction, {paymentPlanItem: ppi});
                }
            });
        }.bind(this)).open({id: -1});
    }.bind(this), this.newRatePlanButton);

    this.bind("mouseenter", this.showProrateItemInfo, this.rProrateItemSessionInfo);
    this.bind("mouseleave", this.hideProrateItemInfo, this.rProrateItemSessionInfo);
    this.bind("mouseenter", this.showProrateItemInfo, this.rProrateItemPaymentCycleInfo);
    this.bind("mouseleave", this.hideProrateItemInfo, this.rProrateItemPaymentCycleInfo);
    this.bind("mouseenter", this.showProrateItemInfo, this.rProrateItemFullCycleInfo);
    this.bind("mouseleave", this.hideProrateItemInfo, this.rProrateItemFullCycleInfo);
    this.bind("click", this.viewRatePlanClickedHandler, this.viewRatePlanLink);

    this.paymentScheduleType = ClassUtils.PAYMENT_SCHEDULE_TYPE;
    this.chargeTimeType = ClassUtils.CHARGE_TIME_TYPE;
    this.rpChargeTimeTypeItems = [{ id: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, name: "Registration"},
                        {id: ClassUtils.CHARGE_TIME_TYPE.CLASS_START, name: "Class Start"},
                        {id: ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY, name: "Next Charge Date - Ignore first class day"},
                        {id: ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_AFTER_FIRST_CLASS_DAY, name: "Next Charge Date - Charge after first class day"}];
    this.dueByItems = [{name: ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT, label: "Billing Manager Default"},
                       {name: ClassUtils.DUE_TIME_TYPE.CLASS_END, label: "Class End Date"}];
    this.rDueByItems = [{id: ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT, name: "Billing Manager Default"},
                        {id: ClassUtils.DUE_TIME_TYPE.CLASS_END, name: "Class End Date"}];
    this.paymentRecurringMode = ClassUtils.PAYMENT_RECURRING_MODE;
    this.paymentRecurringModeItems = [{id: ClassUtils.PAYMENT_RECURRING_MODE.MONTHLY, name: "Monthly"},
                        {id: ClassUtils.PAYMENT_RECURRING_MODE.EVERY_FIXED_PERIOD, name: "Every fixed period"}];
    this.nrChargeTimeType = [{name: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, label: "Registration"},
                             {name: ClassUtils.CHARGE_TIME_TYPE.CLASS_START, label: "Class Start"}];

    this.dayOfMonth = [{id: 1, name: "1st"}, {id: 2, name: "2nd"}, {id: 3, name: "3rd"}];
    for (var i = 4; i <= 20; i ++) {
        this.dayOfMonth.push({id: i, name: i + "th"});
    }
    this.dayOfMonth.push({id: 21, name: "21st"});
    this.dayOfMonth.push({id: 22, name: "22nd"});
    this.dayOfMonth.push({id: 23, name: "23rd"});
    for (var i = 24; i <= 28; i ++) {
        this.dayOfMonth.push({id: i, name: i + "th"});
    }
    this.dayOfMonth.push({id: 99, name: "Last day of month"});

    this.dueByItemReneder = function (data, selected) {
        if (!data) return "";
        return data.name
    };
    this.chargeCategory.renderer = this.dueByItemReneder;
    this.rChargeEveryMonthlyCombo.renderer = this.dueByItemReneder;
    this.rpRatePlanCombo.renderer = this.dueByItemReneder;

    this.iInstallmentAmountPercentageValue.switchToPercentMode();

    const WEEKS_DAY = [
        { value: 1, name: "Sunday" }, { value: 2, name: "Monday" }, { value: 3, name: "Tuesday" },
        { value: 4, name: "Wednesday" }, { value: 5, name: "Thursday" }, { value: 6, name: "Friday" }, { value: 7, name: "Saturday" }
    ];

    this.rChargeEveryWeeklyCombo.renderer = function (wd) { return wd.name; };
    this.rChargeEveryWeeklyCombo.comparer = function (a, b) {
        if (!a) return !b;
        if (!b) return false;

        return a.value == b.value;
    };

    this.rChargeEveryWeeklyCombo.setItems(WEEKS_DAY);

    var thiz = this;
    this.validationRules = new RuleSet()
        .live(true)
        .required(this.chargeName, "Please input " + "Charge Name" + ".")
        .rule(new GenericRule(thiz.amountPerAthlete, function (rule) {
            if ((thiz.typeRecurring.checked || thiz.typeInstallmentPlan.checked) && !thiz.amountPerAthlete.getValue()) return false;
            return true;
        }, "Charge Amount" + " must be at least 0.5."))
        .rule(new GenericRule(thiz.amountPerAthlete, function (rule) {
            if ((thiz.typeRecurring.checked || thiz.typeInstallmentPlan.checked) && thiz.amountPerAthlete.getValue() && thiz.amountPerAthlete.getValue() < 0.5) return false;
            return true;
        }, "Charge Amount" + " must be at least 0.5."))
        .rule(new GenericRule(thiz.typeRecurring, function (rule) {
            if (!thiz.typeRecurring.checked && !thiz.typeNonRecurring.checked && !thiz.typeRatePlan.checked && !thiz.typeInstallmentPlan.checked) return false;
            return true;
        }, "Please choose " + "Charge Type" + "."))
        .rule(new GenericRule(thiz.iInstallmentAmountFlatRate, function (rule) {
            if (thiz.typeInstallmentPlan.checked && !thiz.iInstallmentAmountFlatRate.checked && !thiz.iInstallmentAmountPercentage.checked) {
                return false;
            }
            return true;
        }, "Please choose how the installments are billed"))
        .rule(new GenericRule(thiz.iInstallmentAmountFlatRateValue, function (rule) {
            if (thiz.typeInstallmentPlan.checked && thiz.iInstallmentAmountFlatRate.checked) {
                var value = thiz.iInstallmentAmountFlatRateValue.getValue();
                if (isNaN(value) || !value || value < 0.5 || value > thiz.amountPerAthlete.getValue()) return false;
            }
            return true;
        }, "Please enter a valid flat rate"))
        .rule(new GenericRule(thiz.iInstallmentAmountPercentageValue, function (rule) {
            if (thiz.typeInstallmentPlan.checked && thiz.iInstallmentAmountPercentage.checked) {
                var value = thiz.iInstallmentAmountPercentageValue.getValue();
                if (isNaN(value) || !value || value < 0.5 || value > 100) return false;
            }
            return true;
        }, "Please enter a valid percentage"))
        .rule(new GenericRule(thiz.rFirstChargeRegistration, function (rule) {
            if (!thiz.rFirstChargeRegistration.checked && !thiz.rFirstChargeClassStart.checked && !thiz.rFirstChargeNextChargeDate.checked
                && thiz.paymentPlanItem && thiz.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING) {
                return false;
            }

            if (thiz.typeInstallmentPlan.checked && !thiz.rFirstChargeRegistration.checked && !thiz.rFirstChargeNextChargeDate.checked) {
                return false;
            }

            return true;
        }, "Please choose First Charge."))
        .rule(new GenericRule(thiz.rChargeCycleMonthly, function (rule) {
            if ((thiz.typeRecurring.checked || thiz.typeInstallmentPlan.checked)
                && !thiz.rChargeCycleMonthly.checked && !thiz.rChargeCycleWeekly.checked && !thiz.rChargeCycleFixedPeriod.checked) {
                return false;
            }
            return true;
        }, "Please choose Charge Cycle."))
        .rule(new GenericRule(thiz.rChargeCycleFixedPeriodLengthInput, function (rule) {
            if ((thiz.typeRecurring.checked || thiz.typeInstallmentPlan.checked) && thiz.rChargeCycleFixedPeriod.checked) {
                var value = Util.getInputValueAsIntNumber(thiz.rChargeCycleFixedPeriodLengthInput.value);
                if (isNaN(value) || value <= 0 || value > 100) return false;
            }
            return true;
        }, "Please enter a valid number of days"))
        .rule(new GenericRule(thiz.rChargeEndClassStart, function (rule) {
            if (thiz.typeInstallmentPlan.checked
                && !thiz.rChargeEndClassStart.checked && !thiz.rChargeEndClassEnd.checked && !thiz.rChargeEndSpecificDate.checked) {
                return false;
            }
            return true;
        }, "Please choose an End Date."))
        .rule(new GenericRule(thiz.rChargeSpecificDatePicker, function (rule) {
            if (thiz.typeInstallmentPlan.checked && thiz.rChargeEndSpecificDate.checked) {
                if (!ValidationManager.run(thiz.rChargeSpecificDatePicker.getValidationRuleSet())) return false;
                var date = thiz.rChargeSpecificDatePicker.getDate();
                if (!date) return false;
            }
            return true;
        }, "Please choose a valid specific End Date"))
        .rule(new GenericRule(thiz.rDueBySystemDefault, function (rule) {
            if (!thiz.rDueBySystemDefault.checked && !thiz.rDueByClassEnd.checked
                && (thiz.typeRecurring.checked || thiz.typeInstallmentPlan.checked)) {
                return false;
            }
            return true;
        }, "Please choose Due By."))
        .rule(new GenericRule(thiz.rProrateItemSession, function (rule) {
            if (thiz.typeRecurring.checked && thiz.rProrateCharge.checked
                && !thiz.rProrateItemSession.checked && !thiz.rProrateItemPaymentCycle.checked && !thiz.rProrateItemFullCycle.checked) return false;

            if (thiz.typeInstallmentPlan.checked && thiz.rProrateCharge.checked && !thiz.rProrateItemSession.checked) return false;
            return true;
        }, "Please choose Prorate Charge By."))
        .rule(new GenericRule(thiz.addNRChargeAtItem, function (rule) {
            if (thiz.typeNonRecurring.checked && thiz.nrChargeAtItems.getItems().length == 0) {
                Dialog.error("Please add Charge.");
                return false;
            }
            return true;
        }, "Please add Charge."))
        .rule(new GenericRule(thiz.rpRatePlanCombo, function (rule) {
            if (thiz.typeRatePlan.checked && !thiz.rpRatePlanCombo.getSelectedItem()) {
                Dialog.error("Please select a Rate Plan.");
                return false;
            }
            return true;
        }, "Please select a Rate Plan."));
}
__extend(ModificationWatchDialog, NewPaymentPlanItemDialog);


NewPaymentPlanItemDialog.prototype.asyncSetup = function(options, dialogCallback) {
    this.options = options;
    this.title = "Add Payment Plan Item";
    this.paymentPlanItem = {};
    this.chargeItemsValidationObject = {};
    this.contraintValues = this.options.contraintValues;
    var thiz = this;
    this.customTimezoneProvider = {
        getTimezoneId: function () {
            return thiz.contraintValues.timezoneId;
        },
        getName: function () {
            return "Class time zone";
        }
    };

    if (this.contraintValues && this.contraintValues.showDiscountableField) {
        if (this.typeRecurring.checked || this.typeNonRecurring.checked) {
            Dom.removeClass(this.discountableWrapper, "Hidden");
        }
    } else {
        Dom.addClass(this.discountableWrapper, "Hidden");
    }

    if (this.contraintValues.maxDate) {
        this.rChargeSpecificDatePicker.setMaxDate(this.contraintValues.maxDate);
    }

    this.rChargeSpecificDatePicker.setCustomTimezoneProvider(this.customTimezoneProvider);

    if (window.LOGIN_INFO && !window.LOGIN_INFO.allowRatePlan) {
        Dom.addClass(this.ratePlanTypeWrapper, "Hidden");
        Dom.addClass(this.ratePlanContentWrapper, "Hidden");
    }
    var callback = function () {
        if (this.options && this.options.paymentPlanItem) {
            this.title = "Edit Payment Plan Item";

            this.paymentPlanItem = Util.clone(this.options.paymentPlanItem);
            console.log("PPITEM", this.paymentPlanItem);

            this.renderInfo();
            this.typeRecurring.setAttribute("disabled", "disabled");
            this.typeNonRecurring.setAttribute("disabled", "disabled");
            this.typeRatePlan.setAttribute("disabled", "disabled");
            this.typeInstallmentPlan.setAttribute("disabled", "disabled");
            if (this.paymentPlanItem.scheduleType != ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN) {
                Dom.removeClass(this.chargeCategoryWrapper, "Hidden");
            }
            dialogCallback();

        } else {
            this.paymentPlanItem = {
                key: Util.newUUID(),
                dayOfMonth: 1,
                recurringMode: "MONTHLY"
            };
            if (this.contraintValues && !this.contraintValues.enableRatePlanChargeType) {
                this.typeRatePlan.setAttribute("disabled", "disabled");
            }

            this.renderInfo();
            dialogCallback();
        }
    }.bind(this);

    this.loadRatePlanList(callback);

};

NewPaymentPlanItemDialog.prototype.loadRatePlanList = function(callback) {
    if (this.paymentPlanItem.scheduleType && this.paymentPlanItem.scheduleType != ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN) {
        callback();
        return;
    }
    $classBillByHourService.getRatePlans(function (ratePlans) {
       this.rpRatePlanCombo.setItems(ratePlans);
       if (!ratePlans || !ratePlans.length) {
           this.editRatePlanButton.setAttribute("disabled", "disabled");
           this.rpRatePlanCombo.setDisabled(true);
       } else {
           this.editRatePlanButton.removeAttribute("disabled");
           this.rpRatePlanCombo.setDisabled(false);
       }
       if (this.selectedRatePlan && this.selectedRatePlan.id && ratePlans) {
           this.rpRatePlanCombo.selectItemById(this.selectedRatePlan.id);
       }
       if (callback) callback();
   }.bind(this));
}

NewPaymentPlanItemDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES.concat(["p:ValueUpdated", "CHARGE_ITEM_CHANGED"]);
};

NewPaymentPlanItemDialog.prototype.renderInfo = function () {
    var thiz = this;
    if (this.contraintValues.isFirstItem) this.paymentPlanItem.name = "Class Tuition";
    var nrChargeAtItems = [{key: Util.newUUID(), dueTimeType: ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT}];
    this.nrChargeAtItems.populator = function (data, binding, node) {
        node._nrChargeAtItem = data;
        thiz.chargeItemsValidationObject[data.key] = thiz.initChargeItemValidation(binding, data);
        console.log("chargeItemsValidationObject of item:", data.key, data);

        if (data.amount) binding.nrChargeAmount.setValue(data.amount);
        if (thiz.contraintValues.minDate) {
            binding.nrChargeAtSelection.setMinDate(thiz.contraintValues.minDate);
            binding.nrDueBySelection.setMinDate(thiz.contraintValues.minDate);
        }
        if (thiz.contraintValues.maxDate) {
            binding.nrChargeAtSelection.setMaxDate(thiz.contraintValues.maxDate);
            binding.nrDueBySelection.setMaxDate(thiz.contraintValues.maxDate);
        }

        binding.nrChargeAtSelection.setNamedOptions(thiz.nrChargeTimeType);
        binding.nrChargeAtSelection.setCustomTimezoneProvider(thiz.customTimezoneProvider);
        binding.nrDueBySelection.setCustomTimezoneProvider(thiz.customTimezoneProvider);
        if (data && data.chargeTimeType) {
            if (data.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
                binding.nrChargeAtSelection.setDate(data.specificChargeDate);
                binding.nrDueBySelection.setMinDate(data.specificChargeDate);
            } else {
                binding.nrChargeAtSelection.setDate(data.chargeTimeType);
            }
        }
        if (data.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
            binding.nrDueBySelection.setNamedOptions([{name: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, label: "Registration"}].concat(thiz.dueByItems));
            binding.nrDueBySelection.setDate(ClassUtils.CHARGE_TIME_TYPE.REGISTRATION);
            binding.nrDueBySelection.setEnabled(false);
        } else {
            binding.nrDueBySelection.setNamedOptions(thiz.dueByItems);
            binding.nrDueBySelection.setEnabled(true);
            if (data && data.dueTimeType) {
                if (data.dueTimeType == ClassUtils.DUE_TIME_TYPE.SPECIFIC_DATE) {
                    binding.nrDueBySelection.setDate(data.specificDueDate);
                } else if (data.dueTimeType) {
                    binding.nrDueBySelection.setDate(data.dueTimeType);
                }
            }
        }

        var chargeOnDate;
        if (data.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
            chargeOnDate = thiz.contraintValues.classStartDate;
        } else if (data.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
            chargeOnDate = binding.nrChargeAtSelection.getDate();
        }
        thiz.renderNRDueByExamble(binding.nrDueBySelection.getDate(), chargeOnDate, binding.nrDueByDateEx);

        node.__dueBySelectionWidget = binding.nrDueBySelection;
        node.__chargeAmountWidget = binding.nrChargeAmount;
        node.__dueByExampleElement = binding.nrDueByDateEx;
    };

    this.chargeCategory.setItems(this.options.chargeCategories);
    this.rChargeEveryMonthlyCombo.setItems(this.dayOfMonth);

    if (this.paymentPlanItem && this.paymentPlanItem.key && this.paymentPlanItem.key.length > 0) {
        this.chargeName.value = this.paymentPlanItem.name ? this.paymentPlanItem.name : "";
        if (this.contraintValues && this.contraintValues.showDiscountableField && this.paymentPlanItem.discountable) {
            this.isDiscountable.checked = true;
            this.isNonDiscountable.checked = false;
        } else {
            this.isNonDiscountable.checked = true;
            this.isDiscountable.checked = false;
        }
        this.amountPerAthlete.setValue(this.paymentPlanItem.amount);
        this.chargeCategory.selectItemByKey("id", this.paymentPlanItem.chargeCategoryId);

        var typeRadioInput = null;

        if (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL) {
            this.typeNonRecurring.checked = true;
            typeRadioInput = this.typeNonRecurring;

            this.radioChangedHandler(this.typeNonRecurring);
            nrChargeAtItems = this.paymentPlanItem.manualChargeDates;
            this.nrProrateCharge.checked = this.paymentPlanItem.prorateCharge;
            this.nrProrateNoClassDay.checked = this.paymentPlanItem.prorateOnNoClassDays;
            this.radioChangedHandler(this.nrProrateCharge);
        } else if (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING || this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.INSTALLMENT_PLAN) {

            var recurring = (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING);

            this.typeRecurring.checked = recurring;
            this.typeInstallmentPlan.checked = !recurring;

            typeRadioInput = recurring ? this.typeRecurring : this.typeInstallmentPlan;

            this.radioChangedHandler(recurring ? this.typeRecurring : this.typeInstallmentPlan);

            if (this.paymentPlanItem.firstChargeOption == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
                this.rFirstChargeRegistration.checked = true;
                this.useSeparatedRegCharge.checked = this.paymentPlanItem.regChargeSeparated;
                this.radioChangedHandler(this.rFirstChargeRegistration);
            } else {
                if (recurring) {
                    if (this.paymentPlanItem.firstChargeOption == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
                        this.rFirstChargeClassStart.checked = true;
                        this.radioChangedHandler(this.rFirstChargeClassStart);
                    } else if (this.paymentPlanItem.firstChargeOption == ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY) {
                        this.ignoreFristClassDay.checked = true;
                        this.radioChangedHandler(this.ignoreFristClassDay);
                    } else if (this.paymentPlanItem.firstChargeOption == ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_AFTER_FIRST_CLASS_DAY) {
                        this.chargeAfterFristClassDay.checked = true;
                        this.radioChangedHandler(this.chargeAfterFristClassDay);
                    }
                } else {
                    if (this.paymentPlanItem.firstChargeOption == ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY) {
                        this.rFirstChargeNextChargeDate.checked = true;
                        this.radioChangedHandler(this.rFirstChargeNextChargeDate);
                    }
                }
                
                this.useSeparatedRegCharge.checked = false;
            }


            if (this.paymentPlanItem.recurringMode == ClassUtils.PAYMENT_RECURRING_MODE.MONTHLY) {
                this.rChargeCycleMonthly.checked = true;
                this.rChargeEveryMonthlyCombo.selectItemByKey("id", this.paymentPlanItem.dayOfMonth);
            } else if (this.paymentPlanItem.recurringMode == ClassUtils.PAYMENT_RECURRING_MODE.WEEKLY) {
                this.rChargeCycleWeekly.checked = true;
                this.rChargeEveryWeeklyCombo.selectItemByKey("value", this.paymentPlanItem.dayOfWeek);
            } else if (this.paymentPlanItem.recurringMode == ClassUtils.PAYMENT_RECURRING_MODE.EVERY_FIXED_PERIOD) {
                this.rChargeCycleFixedPeriod.checked = true;
                this.rChargeCycleFixedPeriodLengthInput.value = this.paymentPlanItem.recurringLength;
            }


            if (this.paymentPlanItem.prorateCharge) {
                this.rProrateCharge.checked = true;
                this.radioChangedHandler(this.rProrateCharge);

                if (recurring) {
                    if (this.paymentPlanItem.prorationMode == ClassUtils.PRORATION_MODE.SESSION) {
                        this.rProrateItemSession.checked = true;
                        this.radioChangedHandler(this.rProrateItemSession);
                    } else if (this.paymentPlanItem.prorationMode == ClassUtils.PRORATION_MODE.CYCLE) {
                        this.rProrateItemPaymentCycle.checked = true;
                        this.radioChangedHandler(this.rProrateItemPaymentCycle);
                    } else if (this.paymentPlanItem.prorationMode == ClassUtils.PRORATION_MODE.FORCE_FULL_CYCLE) {
                        this.rProrateItemFullCycle.checked = true;
                        this.radioChangedHandler(this.rProrateItemFullCycle);
                    }
                } else {
                    this.rProrateItemSession.checked = true;
                    this.radioChangedHandler(this.rProrateItemSession);
                }

                if (this.paymentPlanItem.prorateOnNoClassDays) this.rProrateNoClassDay.checked = true;
            }

            if (this.paymentPlanItem.recurrentDueTimeType == ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT) this.rDueBySystemDefault.checked = true;
            if (this.paymentPlanItem.recurrentDueTimeType == ClassUtils.DUE_TIME_TYPE.CLASS_END) this.rDueByClassEnd.checked = true;

            if (!recurring) {
                var flat = this.paymentPlanItem.installmentMode == ClassUtils.INSTALLMENT_MODE.FLAT_RATE;
                this.iInstallmentAmountFlatRate.checked = flat;
                this.iInstallmentAmountPercentage.checked = !flat;

                if (flat) {
                    this.iInstallmentAmountFlatRateValue.setValue(this.paymentPlanItem.installmentFlatAmount);
                } else {
                    var formattedValue = Util.formatNumber(this.paymentPlanItem.installmentPercentage * 100, {maximumFractionDigits: 2});
                    this.iInstallmentAmountPercentageValue.setValue(formattedValue);
                }

                if (this.paymentPlanItem.endDateOption == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
                    this.rChargeEndClassStart.checked = true;
                } else if (this.paymentPlanItem.endDateOption == ClassUtils.CHARGE_TIME_TYPE.CLASS_END) {
                    this.rChargeEndClassEnd.checked = true;
                } else if (this.paymentPlanItem.endDateOption == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
                    this.rChargeEndSpecificDate.checked = true;
                    this.rChargeSpecificDatePicker.setDate(this.paymentPlanItem.specificEndDate);
                }
            }
        } else if (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN) {
            this.typeRatePlan.checked = true;
            typeRadioInput = this.typeRatePlan;

            this.radioChangedHandler(this.typeRatePlan);
            this.rpRatePlanCombo.selectItemByKey("id", this.paymentPlanItem.ratePlanId);
            this.rpRatePlanSelectionChangedHandler();
        }

        if (typeRadioInput && this.options.paymentPlanItem) {
            var container = typeRadioInput.parentNode;
            container.parentNode.querySelectorAll(".RadioItemInfo").forEach((c, i) => {
                Dom.addClass(c, "Readonly");
                Dom.toggleClass(c, "Selected", c == container);
            });
        }
    }

    var registrationItems = [], classStartItems = [], specificDateItems = [];
    for (var i = 0; i < nrChargeAtItems.length; i++) {
        if (nrChargeAtItems[i].chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
            registrationItems.push(nrChargeAtItems[i]);
        } else if (nrChargeAtItems[i].chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
            classStartItems.push(nrChargeAtItems[i]);
        } else {
            specificDateItems.push(nrChargeAtItems[i]);
        }
    }
    specificDateItems.sort(function (obj1, obj2) {
        if (obj2.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
            return 1;
        }
        if (obj1.specificChargeDate && obj2.specificChargeDate) {
            return obj1.specificChargeDate.getTime() - obj2.specificChargeDate.getTime();
        }
    });

    this.nrChargeAtItems.setItems(registrationItems.concat(classStartItems).concat(specificDateItems));
    this.validateNRProrateCharge();

    this.renderExampleInfo();
};

NewPaymentPlanItemDialog.prototype.radioItemValueChanged = function (event) {
    this.radioChangedHandler(event.target);
};

NewPaymentPlanItemDialog.prototype.radioChangedHandler = function (target) {
    if (!Dom.hasClass(target, "RProrateNoClassDay")) {
        var wrapper = target.parentNode.parentNode;
        if (!wrapper) return;
        var items = wrapper.getElementsByClassName("RadioItemInfo");
        for (var i = 0; i < items.length; i++) {
            Dom.removeClass(items[i], "RadioSelected");
        }
        Dom.addClass(target.parentNode, "RadioSelected");
    }

    if (Dom.hasClass(target, "ChargeType")) {
        this.chargeTypeRadioChangedHandler(target);
    } else if (Dom.hasClass(target, "RFirstChargeItem")) {
        this.rFirstChargeChangedHandler(target);
    } else if (Dom.hasClass(target, "RChargeCycleItem")) {
        this.rChargeCycleChangedHandler(target);
    } else if (Dom.hasClass(target, "RChargeMonthlyItem")) {
        this.rChargeMonthlyItemChangedHandler(target);
    } else if (Dom.hasClass(target, "RProrateChargeItem")) {
        this.rProrateChargeItemChangedHandler(target);
    }  else if (Dom.hasClass(target, "RProrateCharge")) {
        this.rProrateChargeChangedHandler(target);
    } else if (Dom.hasClass(target, "RUseSeparatedRegCharge")) {
        this.rUseSeparatedRegChargeChangeHandler(target);
    } else if (Dom.hasClass(target, "NRProrateCharge")) {
        this.nrProrateChargeChangedHandler(target);
    }
};

NewPaymentPlanItemDialog.prototype.chargeTypeRadioChangedHandler = function (target) {
    if (!target) return;
    this.paymentPlanItem.scheduleType = target.value;
    Dom.removeClass(this.chargeCategoryWrapper, "Hidden");
    Dom.removeClass(this.containerWrapper, "Recurring");
    Dom.removeClass(this.containerWrapper, "InstallmentPlan");
    Dom.removeClass(this.containerWrapper, "Manual");


    if (target.value == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING || target.value == ClassUtils.PAYMENT_SCHEDULE_TYPE.INSTALLMENT_PLAN) {
        Dom.addClass(this.nonRecurringContentWrapper, "Hidden");
        Dom.removeClass(this.recurringContentWrapper, "Hidden");
        Dom.addClass(this.ratePlanContentWrapper, "Hidden");
        Dom.addClass(this.containerWrapper, target.value == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING ? "Recurring" : "InstallmentPlan");
        if (this.contraintValues && this.contraintValues.showDiscountableField) {
            Dom.removeClass(this.discountableWrapper, "Hidden");
        }
        Dom.removeClass(this.chargeCategoryWrapper, "Hidden");
    } else if (target.value == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL){
        Dom.removeClass(this.nonRecurringContentWrapper, "Hidden");
        Dom.addClass(this.recurringContentWrapper, "Hidden");
        Dom.addClass(this.ratePlanContentWrapper, "Hidden");
        Dom.addClass(this.containerWrapper, "Manual");
        if (this.contraintValues && this.contraintValues.showDiscountableField) {
            Dom.removeClass(this.discountableWrapper, "Hidden");
        }
        Dom.removeClass(this.chargeCategoryWrapper, "Hidden");
    } else {
        Dom.addClass(this.nonRecurringContentWrapper, "Hidden");
        Dom.addClass(this.recurringContentWrapper, "Hidden");
        Dom.removeClass(this.ratePlanContentWrapper, "Hidden");
        Dom.addClass(this.discountableWrapper, "Hidden");
        Dom.addClass(this.chargeCategoryWrapper, "Hidden");
    }
    var thiz = this;
    window.setTimeout(function () {
        thiz.invalidateSizing();
    }, 50);
};

NewPaymentPlanItemDialog.prototype.rFirstChargeChangedHandler = function (target) {
    if (!target) return;
    this.paymentPlanItem.firstCharge = target.value;
    if (target.value == ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY
        || target.value == ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_AFTER_FIRST_CLASS_DAY) {
        this.rFirstChargeNextChargeDate.checked = true;
        Dom.addClass(this.rFirstChargeNextChargeDate.parentNode, "RadioSelected");
    } else if (target.value != "NEXT_CHARGE_DATE") {
        this.ignoreFristClassDay.checked = false;
        this.chargeAfterFristClassDay.checked = false;
    } else if (target.value == "NEXT_CHARGE_DATE") {
        this.ignoreFristClassDay.checked = true;
        Dom.addClass(this.ignoreFristClassDay.parentNode, "RadioSelected");
        this.paymentPlanItem.firstCharge = ClassUtils.CHARGE_TIME_TYPE.NEXT_CHARGE_DATE_IGNORE_FIRST_CLASS_DAY;
    }
};

NewPaymentPlanItemDialog.prototype.rChargeCycleChangedHandler = function (target) {
    if (!target) return;
    this.paymentPlanItem.recurringMode = target.value;

    if (this.paymentPlanItem.recurringMode == ClassUtils.PAYMENT_RECURRING_MODE.MONTHLY) {
        this.paymentPlanItem.dayOfMonth = this.rChargeEveryMonthlyCombo.getSelectedItem().id;
    } else if (this.paymentPlanItem.recurringMode == ClassUtils.PAYMENT_RECURRING_MODE.WEEKLY) {
        this.paymentPlanItem.dayOfWeek = this.rChargeEveryWeeklyCombo.getSelectedItem().value;
    } else if (this.paymentPlanItem.recurringMode == ClassUtils.PAYMENT_RECURRING_MODE.EVERY_FIXED_PERIOD) {
        this.paymentPlanItem.recurringLength = Util.getInputValueAsIntNumber(this.rChargeCycleFixedPeriodLengthInput.value);
    }
    // if (target.value == ClassUtils.PAYMENT_RECURRING_MODE.MONTHLY) {
    //     Dom.removeClass(this.rChargeCycleMonthlyContent, "Hidden");
    // } else {
    //     Dom.addClass(this.rChargeCycleMonthlyContent, "Hidden");
    // }
    // var thiz = this;
    // window.setTimeout(function () {
    //     thiz.invalidateSizing();
    // }, 50);
};

NewPaymentPlanItemDialog.prototype.rChargeMonthlyItemChangedHandler = function (target) {
    if (!target) return;
    this.paymentPlanItem.chargeMonthlyItem = target.value;
};

NewPaymentPlanItemDialog.prototype.rProrateChargeChangedHandler = function (target) {
    if (!target) return;
    this.paymentPlanItem.prorateCharge = target.checked;
    if (this.paymentPlanItem.prorateCharge) {
        Dom.removeClass(this.rProrateChargeContent , "Disabled");
    } else {
        Dom.addClass(this.rProrateChargeContent , "Disabled");
    }
};
NewPaymentPlanItemDialog.prototype.rUseSeparatedRegChargeChangeHandler = function (target) {
    if (!target) return;
    this.paymentPlanItem.regChargeSeparated = target.checked;
};
NewPaymentPlanItemDialog.prototype.rProrateChargeItemChangedHandler = function (target) {
    if (!target) return;
    if (target.checked) this.paymentPlanItem.prorationMode = target.value;
};

NewPaymentPlanItemDialog.prototype.addNRChargeAtItemClickedHandler = function () {

    var newData = {key: Util.newUUID(), dueTimeType: ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT};
    var previousItems = this.nrChargeAtItems.getItems();
    if (previousItems && previousItems.length > 0) {
        var lastItem = previousItems[previousItems.length - 1];
        newData.amount = lastItem.amount;
        newData.dueTimeType = lastItem.dueTimeType;
        newData.specificDueDate = lastItem.specificDueDate;
        if (newData.dueTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) newData.dueTimeType = ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT;
        if (lastItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
            newData.chargeTimeType = ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE;
            newData.specificChargeDate = lastItem.specificChargeDate;
        }
    }

    this.nrChargeAtItems.appendItems([newData]);
    var thiz = this;
    window.setTimeout(function () {
        thiz.invalidateSizing();
    }, 50);
};

NewPaymentPlanItemDialog.prototype.nrChargeAtWrapperUpdatedHandler = function (event) {
    if (Dom.hasClass(event.target, "AnonId_nrChargeAtSelection")) {
        var rowData = Dom.findUpwardForData(event.target, "_nrChargeAtItem");
        if (!rowData) return;
        var chargeTimeType = event.target.__widget.getDate();
        if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION || chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
            rowData.chargeTimeType = chargeTimeType;
            rowData.specificChargeDate = null;
            rowData.specificDueDate = null;
        } else {
            rowData.chargeTimeType = ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE;
            rowData.specificChargeDate = chargeTimeType;
        }

        var _nrChargeAtItem = Dom.findUpwardForNodeWithData(event.target, "_nrChargeAtItem");
        if (!_nrChargeAtItem) return;
        if (_nrChargeAtItem.__dueBySelectionWidget) {
            if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
                var selected = _nrChargeAtItem.__dueBySelectionWidget.getDate();
                _nrChargeAtItem.__dueBySelectionWidget.setNamedOptions([{name: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, label: "Registration"}].concat(this.dueByItems));
                if (selected) _nrChargeAtItem.__dueBySelectionWidget.setDate(selected);
            } else {
                var selected = _nrChargeAtItem.__dueBySelectionWidget.getDate();
                if (selected == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) selected = ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT;
                _nrChargeAtItem.__dueBySelectionWidget.setNamedOptions(this.dueByItems);
                if (selected) _nrChargeAtItem.__dueBySelectionWidget.setDate(selected);
            }

            var dueTimeType = _nrChargeAtItem.__dueBySelectionWidget.getDate();
            if (dueTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION
                || dueTimeType == ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT
                || dueTimeType == ClassUtils.DUE_TIME_TYPE.CLASS_END) {
                rowData.dueTimeType = dueTimeType;
                rowData.specificDueDate = null;
            } else if (dueTimeType) {
                rowData.dueTimeType = ClassUtils.DUE_TIME_TYPE.SPECIFIC_DATE;
                rowData.specificDueDate = dueTimeType;
            }

            if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
                _nrChargeAtItem.__dueBySelectionWidget.setMinDate(this.contraintValues.regDate);
            } else if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
                _nrChargeAtItem.__dueBySelectionWidget.setMinDate(this.contraintValues.classStartDate);
            } else {
                _nrChargeAtItem.__dueBySelectionWidget.setMinDate(chargeTimeType);
            }
            if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
                _nrChargeAtItem.__dueBySelectionWidget.setDate(ClassUtils.CHARGE_TIME_TYPE.REGISTRATION);
                _nrChargeAtItem.__dueBySelectionWidget.setEnabled(false);
            } else {
                _nrChargeAtItem.__dueBySelectionWidget.setEnabled(true);
            }
        }
        this.validateNRProrateCharge();
        var chargeOnDate;
        if (rowData.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
            chargeOnDate = this.contraintValues.classStartDate;
        } else if (rowData.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
            chargeOnDate = rowData.specificChargeDate;
        }
        var _nrChargeAtItem = Dom.findUpwardForNodeWithData(event.target, "_nrChargeAtItem");
        this.renderNRDueByExamble(dueTimeType, chargeOnDate, _nrChargeAtItem.__dueByExampleElement);

    } else if (Dom.hasClass(event.target, "AnonId_nrDueBySelection")) {
        var rowData = Dom.findUpwardForData(event.target, "_nrChargeAtItem");
        if (!rowData) return;
        var dueTimeType = event.target.__widget.getDate();
        if (dueTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION
            || dueTimeType == ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT
            || dueTimeType == ClassUtils.DUE_TIME_TYPE.CLASS_END) {
            rowData.dueTimeType = dueTimeType;
            rowData.specificDueDate = null;
        } else {
            rowData.dueTimeType = ClassUtils.DUE_TIME_TYPE.SPECIFIC_DATE;
            rowData.specificDueDate = dueTimeType;
        }
        var chargeOnDate;
        if (rowData.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
            chargeOnDate = this.contraintValues.classStartDate;
        } else if (rowData.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
            chargeOnDate = rowData.specificChargeDate;
        }
        var _nrChargeAtItem = Dom.findUpwardForNodeWithData(event.target, "_nrChargeAtItem");
        this.renderNRDueByExamble(dueTimeType, chargeOnDate, _nrChargeAtItem.__dueByExampleElement);
    }
};

NewPaymentPlanItemDialog.prototype.nrChargeAtSelectedHandler = function (event) {
    if (Dom.hasClass(event.target, "AnonId_dueByCombo")) {
        var dueByWidget = event.target.__widget;
        if (!dueByWidget) return;
        var nrChargeAtItem = Dom.findUpwardForData(event.target, "_nrChargeAtItem");
        var row = Dom.findUpwardForNodeWithData(event.target, "_nrChargeAtItem");
        if (!nrChargeAtItem) return;
        if (!row) return;
        nrChargeAtItem.dueBy = dueByWidget.getSelectedItem().id;
    }
};

NewPaymentPlanItemDialog.prototype.nrChargeAtItemsClikedHandler = function (event) {
    if (Dom.hasClass(event.target, "DeleteChargeAtItemAction")
        || Dom.hasClass(event.target.parentNode, "DeleteChargeAtItemAction")
        || Dom.hasClass(event.target.parentNode.parentNode, "DeleteChargeAtItemAction")
        || Dom.hasClass(event.target.parentNode.parentNode.parentNode, "DeleteChargeAtItemAction")) {

        this.nrChargeAtItems.deleteRow(event.target);
        Dom.emitEvent("CHARGE_ITEM_CHANGED", this.nrChargeAtItems);
        this.validateNRProrateCharge();

        var nrChargeAtItem = Dom.findUpwardForData(event.target, "_nrChargeAtItem");
        if (nrChargeAtItem && this.chargeItemsValidationObject[nrChargeAtItem.key]) delete this.chargeItemsValidationObject[nrChargeAtItem.key];

        var thiz = this;
        window.setTimeout(function () {
            thiz.invalidateSizing();
        }, 50);
    }
};

NewPaymentPlanItemDialog.prototype.nrProrateChargeChangedHandler = function (target) {
    if (target.checked) {
        Dom.removeClass(this.nrProrateNoClassDayWrapper, "Disabled");
    } else {
        this.nrProrateNoClassDay.checked = false;
        Dom.addClass(this.nrProrateNoClassDayWrapper, "Disabled");
    }
};


NewPaymentPlanItemDialog.prototype.save = function (callback) {
    var valid = true;
    if (!ValidationManager.run(this.validationRules)) valid = false;
    var data = {
        id: this.paymentPlanItem.id ? this.paymentPlanItem.id : 0,
        key: this.paymentPlanItem.key,
        name: this.chargeName.value,
        amount: this.amountPerAthlete.getValue(),
        chargeCategoryId: this.chargeCategory.getSelectedItem() ? this.chargeCategory.getSelectedItem().id : 0,
        scheduleType: this.paymentPlanItem.scheduleType
    };
    if (this.contraintValues && this.contraintValues.showDiscountableField) {
        data.discountable = this.isDiscountable.checked;
    }

    var manualChargeDates = [];
    if (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL) {
        data.recurringMode = null;
        data.dayOfMonth = 0;
        data.recurrentDueTimeType = null;
        data.prorateCharge = false;
        data.prorateOnNoClassDays = false;
        data.amount = 0;

        if (this.validateNRProrateCharge()) {
            data.prorateCharge = this.nrProrateCharge.checked;
            if (data.prorateCharge) {
                data.prorateOnNoClassDays = this.nrProrateNoClassDay.checked;
            } else {
                data.prorateOnNoClassDays = false;
            }
        }

        var items = this.nrChargeAtItems.getItems();
        console.log("VALIDATE ITEMS", items)
        if (items && items.length > 0) {
            for (var i = 0; i < items.length; i++) {
                var validations = this.chargeItemsValidationObject[items[i].key];
                console.log("validations of charge item", items[i].id, (items[i].id > 0), items[i].key, items[i], validations);
                if (validations) {
                    console.log("Valid charge item", items[i].key, items[i]);
                    if (!ValidationManager.run(validations)) {
                        console.log("validations of charge item fail");
                        valid = false;
                    }
                }
                var item = {
                    paymentPlanItemId: items[i].paymentPlanItemId,
                    chargeTimeType: items[i].chargeTimeType,
                    specificChargeDate: items[i].specificChargeDate,
                    dueTimeType: items[i].dueTimeType,
                    specificDueDate: items[i].specificDueDate,
                    amount: items[i].amount,
                    key: (items[i].id > 0? items[i].id : Util.newUUID()),
                    id: items[i].id
                };
                if (item.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
                    item.dueTimeType = ClassUtils.CHARGE_TIME_TYPE.REGISTRATION;
                    item.specificDueDate = null;
                }
                manualChargeDates.push(item);
            }
        }
        console.log("MANUAL ITEM", manualChargeDates);
        if (!valid) return false;
        data.manualChargeDates = manualChargeDates;
    } else if (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING || this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.INSTALLMENT_PLAN) {
        var recurring = this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING;

        data.chargeOverrides = this.paymentPlanItem.chargeOverrides;
        data.firstChargeOption = this.paymentPlanItem.firstCharge;
        data.regChargeSeparated = (data.firstChargeOption == "REGISTRATION" && this.paymentPlanItem.regChargeSeparated);

        data.recurringMode = this.paymentPlanItem.recurringMode;

        data.dayOfMonth = this.rChargeEveryMonthlyCombo.getSelectedItem().id;
        data.dayOfWeek = this.rChargeEveryWeeklyCombo.getSelectedItem().value;
        data.recurringLength = Util.getInputValueAsIntNumber(this.rChargeCycleFixedPeriodLengthInput.value);

        data.prorateCharge = this.rProrateCharge.checked;
        if (data.prorateCharge) {
            if (recurring) {
                data.prorationMode = this.paymentPlanItem.prorationMode;
            } else {
                data.prorationMode = ClassUtils.PRORATION_MODE.SESSION;
            }

            data.prorateOnNoClassDays = this.rProrateNoClassDay.checked;

        } else {
            data.prorateOnNoClassDays = false;
            data.prorationMode = null;
        }

        if (this.rDueBySystemDefault.checked) data.recurrentDueTimeType = this.rDueBySystemDefault.value;
        if (this.rDueByClassEnd.checked) data.recurrentDueTimeType = this.rDueByClassEnd.value;

        if (!recurring) {
            if (this.iInstallmentAmountFlatRate.checked) {
                data.installmentMode = ClassUtils.INSTALLMENT_MODE.FLAT_RATE;
                data.installmentFlatAmount = this.iInstallmentAmountFlatRateValue.getValue();
            } else {
                data.installmentMode = ClassUtils.INSTALLMENT_MODE.PERCENTAGE;
                data.installmentPercentage = this.iInstallmentAmountPercentageValue.getValue() / 100;
            }

            data.specificEndDate = null;
            if (this.rChargeEndClassStart.checked) {
                data.endDateOption = ClassUtils.CHARGE_TIME_TYPE.CLASS_START;
            } else if (this.rChargeEndClassEnd.checked) {
                data.endDateOption = ClassUtils.CHARGE_TIME_TYPE.CLASS_END;
            } else if (this.rChargeEndSpecificDate.checked) {
                data.endDateOption = ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE;
                data.specificEndDate = this.rChargeSpecificDatePicker.getDate();
            }
        }
    } else {
        var selectedRatePlanItem = this.rpRatePlanCombo.getSelectedItem();
        data.ratePlanId = selectedRatePlanItem ? selectedRatePlanItem.id : 0;
        data.discountable = selectedRatePlanItem & selectedRatePlanItem.discountable;
    }
    console.log("Save PPP", data);
    if (!valid) return;
    this.close(data);
};

NewPaymentPlanItemDialog.prototype.validateNRProrateCharge = function () {
    if (!this.paymentPlanItem) return false;
    var isShow = false;
    if (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL) {
        var items = this.nrChargeAtItems.getItems();
        if (items && items.length > 0) {
            for (var i = 0; i < items.length; i++) {
                if (items[i].chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION
                    || items[i].chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
                    isShow = true;
                    break;
                }
            }
        }
    }
    if (isShow) {
        Dom.removeClass(this.nrProrateChargeWrapper, "Hidden");
    } else {
        Dom.addClass(this.nrProrateChargeWrapper, "Hidden");
    }
    var thiz = this;
    window.setTimeout(function () {
        thiz.invalidateSizing();
    }, 50);
    return isShow;
};

NewPaymentPlanItemDialog.prototype.chargeItemAmountChangedHandler = function (event) {
    var nrChargeAtItem = Dom.findUpwardForData(event.target, "_nrChargeAtItem");
    var row = Dom.findUpwardForNodeWithData(event.target, "_nrChargeAtItem");
    if (!nrChargeAtItem) return;
    if (!row) return;
    nrChargeAtItem.amount = row.__chargeAmountWidget.getValue();
};

NewPaymentPlanItemDialog.prototype.initChargeItemValidation = function (binding, data) {
    if (!binding) return;
    var thiz = this;
    var validationRules = new RuleSet()
        .live(true)
        .rule(new GenericRule(binding.nrChargeAmount, function (rule) {
            if (thiz.typeNonRecurring.checked && !binding.nrChargeAmount.getValue()) return false;
            return true;
        }, "Charge Amount" + " must be at least 0.5."))
        .rule(new GenericRule(binding.nrChargeAmount, function (rule) {
            if (thiz.typeNonRecurring.checked && binding.nrChargeAmount.getValue() && binding.nrChargeAmount.getValue() < 0.5) return false;
            return true;
        }, "Charge Amount" + " must be at least 0.5."))
        .rule(new GenericRule(binding.nrChargeAtSelection, function (rule) {
            if (thiz.typeNonRecurring.checked && !binding.nrChargeAtSelection.getDate()) return false;
            return true;
        }, "Please input " + "Charge At" + "."))
        .rule(new GenericRule(binding.nrChargeAtSelection, function (rule) {
            var chargeItems = thiz.nrChargeAtItems.getItems();
            if (chargeItems && chargeItems.length > 0) {
                for (var i = 0; i < chargeItems.length; i++) {
                    if (data.key == chargeItems[i].key) continue;
                    if (data.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
                        if (data.specificChargeDate && chargeItems[i].chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE
                            && chargeItems[i].specificChargeDate && data.specificChargeDate.getTime() == chargeItems[i].specificChargeDate.getTime()) {
                            return false;
                        }
                    } else if (data.chargeTimeType == chargeItems[i].chargeTimeType) {
                        return false;
                    }
                }
            }
            return true;
        }, "Duplicate " + "Charge At" + "."))
        .rule(new GenericRule(binding.nrDueBySelection, function (rule) {
            if (thiz.typeNonRecurring.checked && !binding.nrDueBySelection.getDate()) return false;
            return true;
        }, "Please input Due By."));

    return validationRules;
};

NewPaymentPlanItemDialog.prototype.renderExampleInfo = function () {
    var dayOfMonth = this.rChargeEveryMonthlyCombo.getSelectedItem() ? this.rChargeEveryMonthlyCombo.getSelectedItem().id : null;
    this.getDueTimeExampleInfo(dayOfMonth, function (dueTimeExamples) {
        this.rDueByDefaultExample.innerHTML = dueTimeExamples[ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT];
        this.rDueByClassEndExample.innerHTML = dueTimeExamples[ClassUtils.DUE_TIME_TYPE.CLASS_END];
    }.bind(this));
};

NewPaymentPlanItemDialog.prototype.getDueTimeExampleInfo = function (dayOfMonth, callback) {
    var tzid = TimezoneProviders.team?.getTimezoneId() || TimezoneProviders.server?.getTimezoneId() || TimezoneProviders.local?.getTimezoneId();
    var currentDate = moment(new Date());
    var startDate = moment.tz([currentDate.year(), currentDate.month(), currentDate.date()], tzid);
    if (this.contraintValues.classStartDate && startDate.isBefore(this.contraintValues.classStartDate)) {
        startDate = moment.tz([this.contraintValues.classStartDate.getFullYear(), this.contraintValues.classStartDate.getMonth(),
            this.contraintValues.classStartDate.getDate()], tzid);
    }

    var chargedTxt = window.top.TeamLocalizer.getString("charged");
    var rcseHtml = "EXAMPLE: An installment " + chargedTxt + " on <strong>",
        rDueByClassEndExampleHtml = "EXAMPLE: An installment " + chargedTxt + " on <strong>",
        rDueByDefaultExampleHtml = "EXAMPLE: An installment " + chargedTxt + " on <strong>";
    if (dayOfMonth) {
        if (dayOfMonth == 99) {
            startDate.date(1);
            startDate.add("M", 1);
            startDate.add("d", -1);
        } else {
            startDate.date(dayOfMonth);
        }
        rcseHtml += " " + FormatUtil.formatDateWithTZID(startDate, "date_standard", tzid);
        rDueByClassEndExampleHtml += " " + FormatUtil.formatDateWithTZID(startDate, "date_standard", tzid);
        rDueByDefaultExampleHtml += " " + FormatUtil.formatDateWithTZID(startDate, "date_standard", tzid);
    }
    rcseHtml += "</strong> will be collected on <strong>"
        + FormatUtil.formatDateWithTZID(this.contraintValues.classStartDate, "date_standard", tzid) + "</strong>";
    //this.rClassStartExample.innerHTML = rcseHtml;

    rDueByClassEndExampleHtml += "</strong> will be collected on <strong>"
        + FormatUtil.formatDateWithTZID(this.contraintValues.classEndDate, "date_standard", tzid) + "</strong>";

    var thiz = this;
    $classAdminService.getDueDate(startDate.toDate(), function (res) {
        rDueByDefaultExampleHtml += "</strong> will be collected on <strong>"
            + FormatUtil.formatDateWithTZID(res, "date_standard", tzid) + "</strong>";
        var exampleResult = {};
        exampleResult[ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT] = rDueByDefaultExampleHtml;
        exampleResult[ClassUtils.DUE_TIME_TYPE.CLASS_END] = rDueByClassEndExampleHtml;
        callback(exampleResult);
    }, function (err) {});
};

NewPaymentPlanItemDialog.prototype.rChargeEveryMonthlyComboChangedHandler = function () {
    this.renderExampleInfo();
};

NewPaymentPlanItemDialog.prototype.renderNRDueByExamble = function (dueBy, chargeOnDate, element) {
    console.log("NewPaymentPlanItemDialog.renderNRDueByExamble",
                "\n", dueBy,
                "\n", chargeOnDate,
                "\n", this.options.contraintValues);
    element.innerHTML = "";
    var thiz = this;
    if (dueBy == ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT) {
        if (chargeOnDate) {
            var orgTimezoneId = this.options.contraintValues.orgTimezoneId? this.options.contraintValues.orgTimezoneId : this.options.contraintValues.timezoneId;
            var momentChargeOnDate = moment(chargeOnDate).tz(orgTimezoneId);
            console.log("After moment", "\n", chargeOnDate,
                    "\n", momentChargeOnDate.format(),
                    "\n", orgTimezoneId, this.options.contraintValues.timezoneId,
                    "\n", momentChargeOnDate.year(), momentChargeOnDate.month(), momentChargeOnDate.date());
            var onDate = moment.tz([momentChargeOnDate.year(), momentChargeOnDate.month(), momentChargeOnDate.date()], this.options.contraintValues.timezoneId);
            $classAdminService.getDueDate(onDate.toDate(), function (res) {
                element.innerHTML = "(" + FormatUtil.formatDate(res, "date_standard", "team") + ")";
            }, function (err) {});
        }
    } else if (dueBy == ClassUtils.DUE_TIME_TYPE.CLASS_END) {
        if (this.contraintValues && this.contraintValues.classEndDate) {
            element.innerHTML = "(" + FormatUtil.formatDate(this.contraintValues.classEndDate, "date_standard", "team") + ")";
        }
    }
};

NewPaymentPlanItemDialog.prototype.showProrateItemInfo = function (event) {
    if (this.hideProrateItemInfoTimer) {
        window.clearTimeout(this.hideProrateItemInfoTimer);
        this.hideProrateItemInfoTimer = null;
    }
    if (this._extraFeeTips) {
        this._extraFeeTips.kill();
    }
    this._extraFeeTips = InfoTip.show(event.target, event.target.getAttribute("info-message"), true, null, "tooltip", "left-inside", -(Dom.getOffsetWidth(event.target)/2 + 7), 1);
};

NewPaymentPlanItemDialog.prototype.hideProrateItemInfo = function (event) {
    if (this.hideProrateItemInfoTimer) {
        window.clearTimeout(this.hideProrateItemInfoTimer);
        this.hideProrateItemInfoTimer = null;
    }
    var thiz = this;
    this.hideProrateItemInfoTimer = window.setTimeout(function () {
        if (thiz._extraFeeTips) {
            thiz._extraFeeTips.hide();
            thiz._extraFeeTips.kill();
        }
        thiz.hideProrateItemInfoTimer = null;
    }, 50);
};

NewPaymentPlanItemDialog.prototype.rpRatePlanSelectionChangedHandler = function () {
    var ratePlan = this.rpRatePlanCombo.getSelectedItem();
    if (!ratePlan) return;
    var getItemName = function (list, value, comparer) {
        if (!comparer) comparer = function (item) {
            return item.id == value;
        }

        var result = list.filter(comparer);
        return result && result.length ? result[0].name : value;
    }
    var recurrs = getItemName(this.paymentRecurringModeItems, ratePlan.recurringMode);
    recurrs += " - " + getItemName(this.dayOfMonth, ratePlan.dayOfMonth);
    this.rpRecurrsLabel.innerHTML = "<strong>" + recurrs + "</strong>";

    this.getDueTimeExampleInfo(ratePlan.dayOfMonth, function (dueTimeExamples) {
        var paymentDueTimeHtml = "<div><strong>" + getItemName(this.rDueByItems, ratePlan.recurrentDueTimeType);
        paymentDueTimeHtml += "</strong> <div class=\"Example\">" + dueTimeExamples[ratePlan.recurrentDueTimeType] + "</div></div>";
        this.rpPaymentDueLabel.innerHTML = paymentDueTimeHtml;
    }.bind(this));

    var firstChargeType = getItemName(this.rpChargeTimeTypeItems, ratePlan.firstChargeOption);
    this.rpFirstChargeLabel.innerHTML = "<strong>" + firstChargeType + "</strong>";
    this.rpChargeCategoryLabel.innerHTML = "<strong>" + getItemName(this.options.chargeCategories, ratePlan.chargeCategoryId) + "</strong>";
    var proration = ratePlan.prorateCharge && ratePlan.prorateOnNoClassDays ? "Yes - Prorate on No Class Days" : (ratePlan.prorateCharge ? "Yes" : "No");
    this.rpProtateLabel.innerHTML = "<strong>" + proration + "</strong>";
    var discountInfo = ratePlan.discountable ? "Yes - " + ratePlan.discountPlanName : "No";
    this.rpDiscountLabel.innerHTML = "<strong>" + discountInfo + "</strong>";
};

NewPaymentPlanItemDialog.prototype.viewRatePlanClickedHandler = function () {
    var ratePlan = this.rpRatePlanCombo.getSelectedItem();
    if (!ratePlan) return;
    console.log(ratePlan);
    new ViewRatePlanDialog().callback(function (data) {
    }).open({ratePlanId: ratePlan.id});
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/PaymentPlanAddStudentDialog.js";

function PaymentPlanAddStudentDialog() {
    Dialog.call(this);
    this.grabHeight = true;
    this.title = "Assign Students to Payment Plan";
    var thiz = this;
    this.bind("input", this.searchTextInputHandler.bind(this), this.itemKeyword);
    this.bind("click", this.dataTableClickHandler.bind(this), this.memberDataTable);
    this.selectPaymentPlan.getConfigs = function() {
        return {
            mode: SelectBox.MODE_DROPDOWN,
            multipleSelect: true,
            useExplicitSelectLinks: true,
            noneSelectionText: "All Payment Plans"
        };
    };
    this.selectPaymentPlan.parseData = function(data) {
        return {
            value: data.id,
            text: data.name
        };
    };
    this.selectPaymentPlan.setup();
    this.bind("p:SelectionChanged", function(event) {
        thiz.requestData();
    }, this.selectPaymentPlan);
    var thiz = this;

    this.bind("click", function(e){
        console.log("option", thiz.options);
        var classData = thiz.options? thiz.options.classInfo : null;
        if(!classData) return;
        thiz.isRegistrationsChanged = false;
        var registrationsOptions = {
            classId: classData.id,
            title: classData.title,
            ageText: classData.ageText,
            allowedGender: classData.allowedGender,
            ageLow: classData.ageLow,
            ageHi: classData.ageHi,
            dateAgeUp: classData.dateAgeUp,
            insuranceOptions: classData.insuranceOptions,
            addedMemberIds: [],
            registrationsChanged: function (isRegistrationsChanged) {
                thiz.isRegistrationsChanged = isRegistrationsChanged;
            }
        };
        widget.__ensureNamespaceLoaded("classtool", function (classtool) {
            var registrationsDialog = new RegistrationsDialog().callback(function (registrationsData) {
                console.log("thiz.isRegistrationsChanged", thiz.isRegistrationsChanged);
                if (thiz.isRegistrationsChanged && thiz.options && typeof(thiz.options.classReloadCallback) == "function") {
                    thiz.options.classReloadCallback();
                }
            }).open(registrationsOptions);
        });

    }, this.btnNewRegistration);
    if (window.LOGIN_INFO && window.LOGIN_INFO.allowClassToolAddNewRegistrations && ClassAuthUtils.canAddRegistrationForMember(window.LOGIN_INFO)) {
        Dom.removeClass(this.btnNewRegistration, "Hidden");
    }
}
__extend(Dialog, PaymentPlanAddStudentDialog);

PaymentPlanAddStudentDialog.prototype.setup = function(options) {
    this.options = options;
    console.log("!@# PaymentPlanAddStudentDialog - options:", options);
    this.itemCPPName.innerText = options.paymentPlanName || "";
    var thiz = this;
    this.selectPaymentPlan.setItems(options.classInfo.paymentPlans.filter(function(pp) {
        return pp.id != options.paymentPlanId;
    }));
    setTimeout(this.setupDataTable.bind(this), 50);
};

PaymentPlanAddStudentDialog.prototype.requestData = function() {
    var thiz = this;
    var filterObject = {
    	classId: this.options.classInfo.id,
    	excludePaymentPlanId: this.options.paymentPlanId,
    	keyword: this.itemKeyword.value,
    	paymentPlanIds: this.selectPaymentPlan.getValues()
    };
    var assignedStudents = this.options.assignedStudents;
    var checkExcluded = function(data) {
        var i = 0;
        while(i < assignedStudents.length) {
            var student = assignedStudents[i];
            if (student.id == data.id && student.slot == data.slot) return false;
            i++;
        }
        return true;
    };
    var order = this.memberDataTable.getOrder();
    $classAdminService.getRegistrationsOfClass(filterObject, {name: order.propertyName, asc: order.asc},
        function (data) {
            thiz.memberDataTable.setItems(data.result.filter(checkExcluded));
            thiz.invalidateSizing();
        }, function (err) {
            console.error("failed", err);
        });
};

PaymentPlanAddStudentDialog.prototype.searchTextInputHandler = function () {
    var thiz = this;
    if (this.inputingSearchTextTimeout) {
        clearTimeout(this.inputingSearchTextTimeout);
    }
    this.inputingSearchTextTimeout = window.setTimeout(function () {
        if (thiz.searchKeyword != thiz.itemKeyword.value) {
            thiz.searchKeyword = thiz.itemKeyword.value;
            thiz.requestData();
        }
    }, 250);
};

PaymentPlanAddStudentDialog.prototype.setupDataTable = function() {
    var thiz = this;
    this.memberDataTable.column(new DataTable.GenericDomColumn("Student Name", function(data) {
        
        
        var childrens = [{
            _name: "div",
            _text: (data.firstName + " " + data.lastName)
        }];
        
        
        
        if (data.payLater){
            childrens.push({
                _name: "span",
                "title": "Registration fee is due",
                "class": "InfoLink PayLater Alert",
                _children: [{_name: "icon", "class": "cash-usd"}]
            });
        }
        
        return Dom.newDOMElement({
            _name: "hbox",
            "class": "StudentName",
            _children: childrens
        });
        
        
    }).sortable("memberFullName").width("1*", "14em"));
    this.memberDataTable.column(new DataTable.PlainTextColumn("Slot", function(data) {
        return (data.slot + 1);
    }).sortable("slot").width("5em"));
    this.memberDataTable.column(new DataTable.PlainTextColumn("Age", function(data) {
        return data.age;
    }).sortable("age").width("5em"));
    this.memberDataTable.column(new DataTable.PlainTextColumn("Gender", function(data) {
        return data.gender;
    }).sortable("gender").width("7em"));
    this.memberDataTable.column(new DataTable.PlainTextColumn("Account", function(data) {
        return (data.accountFirstName + " " + data.accountLastName);
    }).sortable("accountFullName").width("12em"));
    this.memberDataTable.column(new DataTable.PlainTextColumn("Current Payment Plan", function(data) {
        return data.paymentPlanName || "";
    }).sortable("paymentPlanName").width("15em"));
    this.memberDataTable.currentOrder = {propertyName: "memberFullName", asc: true};
    this.memberDataTable.useFloatingHeader = true;
    this.memberDataTable.selector(true);
    this.memberDataTable.comparer = function(a, b) {
        return (a && b && a.id == b.id && a.slot == b.slot);
    };
    this.memberDataTable.addListener({onSelectionChanged: thiz.invalidateElements.bind(thiz)});
    this.memberDataTable.addOrderRequestListener({changeOrder: function(order) {
        thiz.memberDataTable.setOrder(order);
        thiz.requestData();
    }});
    this.memberDataTable.disabledCheckBoxWhenCheckAll(false);
    this.memberDataTable.selectable = function (data) {
        return thiz.isSelectable(data);
    };
    this.memberDataTable.setup();
    this.requestData();
};


PaymentPlanAddStudentDialog.prototype.isWaitPaid = function (data) {
    return (!data.waiting && !data.canceled && !data.paid && data.waitPaidChargeIds);
};

PaymentPlanAddStudentDialog.prototype.isSelectable = function (data) {
    var isWaitPaid = this.isWaitPaid(data);
        if (data.canceled || isWaitPaid) {
            return false;
        }
        if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
            return false;
        }
        if (!ClassAuthUtils.canChangeSlotPaymentPlanStartDropDate()) {
            return false;   
        }
        return true;
};

PaymentPlanAddStudentDialog.prototype.dataTableClickHandler = function(event) {
    if (Dom.hasClass(event.target, "DataTableCheck")) return;
    var rowData = DataTable.getRowData(event.target);
    if (!this.isSelectable(rowData)) return;
    var selectedMembers = this.memberDataTable.getSelectedItems();
    var index = selectedMembers.indexOf(rowData);
    if (index != -1) {
        selectedMembers.splice(index, 1);
    } else {
        selectedMembers.push(rowData);
    }
    this.memberDataTable.selectItems(selectedMembers);
};

PaymentPlanAddStudentDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var selectedMembers = this.memberDataTable.getSelectedItems();
    return [
        {
            type: "accept", title: "Assign Selected" + (selectedMembers.length ? "(" + selectedMembers.length + ")" : ""),
            isCloseHandler: true,
            isEnabled: function() {return selectedMembers.length > 0;},
            run: function () {
                console.log("SELECTED", selectedMembers);
                thiz.close(selectedMembers);
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.close(false);
            }
        }
    ];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/PaymentPlanItemGrid.js";

var PaymentPlanItemGrid = function(options) {
    PaymentPlanItemGrid.ANNUAL_REG_ACCOUNT = "AnnualRegAccount";
    PaymentPlanItemGrid.ANNUAL_REG_STUDENT = "AnnualRegStudent";
    PaymentPlanItemGrid.FAMILY_REG_FEE = "FamilyRegFee";
    PaymentPlanItemGrid.PAYMENT_ITEM_NAME = "PaymentItemName";
    PaymentPlanItemGrid.SUBTOTAL_BY_ITEM = "SubTotalByItem";
    PaymentPlanItemGrid.SUBTOTAL_BY_MONTH = "SubTotalByMonth";
    PaymentPlanItemGrid.ITEM_ACTIONS = "ItemActions";
    PaymentPlanItemGrid.REGISTRATION = "Registration";
    PaymentPlanItemGrid.CLASS_START = "ClassStart";
    PaymentPlanItemGrid.TOTAL_AMOUNT = "TotalAmount";
    PaymentPlanItemGrid.EMPTY_PAYMENT_PLAN = "__Empty_Payment_Plan__";
    PaymentPlanItemGrid.RATE_PLAN_COST_ALTERNATIVE = "";
    PaymentPlanItemGrid.RATE_PLAN_NO_COST = -1;
    PaymentPlanItemGrid.PROCESSING_FEE_KEY = "ProcessingFee";

    PaymentPlanItemGrid.HEADER_NAMES = {}
    PaymentPlanItemGrid.HEADER_NAMES[PaymentPlanItemGrid.PAYMENT_ITEM_NAME] = {name: "Payment Item Name"};
    PaymentPlanItemGrid.HEADER_NAMES[PaymentPlanItemGrid.SUBTOTAL_BY_ITEM] = {name: "Subtotal", desc: "by Item"};
    PaymentPlanItemGrid.HEADER_NAMES[PaymentPlanItemGrid.SUBTOTAL_BY_MONTH] = {name: "Subtotal", desc: "by Month"};
    PaymentPlanItemGrid.HEADER_NAMES[PaymentPlanItemGrid.ITEM_ACTIONS] = {name: "Action"};
    PaymentPlanItemGrid.HEADER_NAMES[PaymentPlanItemGrid.REGISTRATION] = {name: "Registration", desc: "start/end date"};
    PaymentPlanItemGrid.HEADER_NAMES[PaymentPlanItemGrid.CLASS_START] = {name: "Class Start"};
    PaymentPlanItemGrid.ACTION_ICONS = {
        "edit": "<span class=\"PaymentPlanItem Edit\" ppi-key=\"@ppiKey\"><icon class=\"pencil\"></icon></span>",
        "delete": "<span class=\"PaymentPlanItem Delete\" ppi-key=\"@ppiKey\"><icon class=\"close-circle\"></icon></span>"
    };
    PaymentPlanItemGrid.DEFAULT_MAX_PROJECTED_COLUMNS = 5;
    PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS = 1;
    PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS = PaymentPlanItemGrid.DEFAULT_MAX_PROJECTED_COLUMNS;
    PaymentPlanItemGrid.REGISTRATION_CLASS_START = "<span class=\"Registration\">Registration & </span> <br><span class=\"ClassStart\">Class Start</span>";
    PaymentPlanItemGrid.REGISTRATION_CLASS_START_DESC = "Registration & Class Start";

    function PaymentPlanItemGrid(options) {
        PaymentPlanItemGrid.RATE_PLAN_COST_ALTERNATIVE = "<span class=\"RatePlanNoCost\">" + ClassUtils.showAlternativeCost("--") + "</span>";
        var thiz = this;
        this.options = options;
        BaseTemplatedWidget.call(this);
        this.classInfo = {};
        this.filters = {}
        this.existingItems = [];
        this.selectedSlot = -1;
        this.totalAmount = 0;
        this.readOnly = false;
        this.isClassAdmin = false;
        this.paymentPlanId = 0;
        this.forceValidation = false;
        this.isFirstSetup = true;
        this.isDualFirstCol = false;
        this.isFirstItem = true;
        this.chargeOverrides = {};
        this.startProjectedDate = new Date();
        this.endProjectedDate = null;
        this.enableDiscountField = false;
        this.projectedMemberId = 0;
        this.projectedLessonClassInId = 0;
        
        this.isRatePlanIncluded = false;
        this.uniqueChargeDates = [];
        this.uniqueChargeMonths = [];
        this.totalOneTimeAmount = 0;
        this.totalRatePlanOneTimeAmount = "";
        this.needBuildPaymentDescription = false;
        if(options){
        	if (this.options.maxProjectedColums) {
        		PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS = this.options.maxProjectedColums;
       		} else {
       			PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS = PaymentPlanItemGrid.DEFAULT_MAX_PROJECTED_COLUMNS;
       		}
            this.classInfo = options.classInfo;
            this.filters = options.filters;
            this.selectedSlot = options.selectedSlot == null ? this.classInfo.slots[0].slot : options.selectedSlot;
            this.existingItems = options.items? options.items : [];
            this.readOnly = options.readOnly? options.readOnly : false;
            this.isClassAdmin = options.isClassAdmin? options.isClassAdmin : false;
            this.assigningRatePlan = options.assigningRatePlan? options.assigningRatePlan : false;
            this.isDualFirstCol = options.isDualFirstCol? options.isDualFirstCol : false;
            this.paymentPlanId = options.paymentPlanId;
            var minDate = this.classInfo.dateStart;
            if (this.classInfo.date4Register.getTime() < this.classInfo.dateStart.getTime()) {
                minDate = this.classInfo.date4Register;
            }
            this.startProjectedDate = options.startProjectedDate? options.startProjectedDate : minDate;
            this.registrationProjectedDate = options.registrationProjectedDate || null;
            this.endProjectedDate = options.endProjectedDate? options.endProjectedDate : this.classInfo.dateEnd;
            this.classEndDateFormat = FormatUtil.formatDateWithTZID(this.classInfo.dateEnd, "date_standard", this.classInfo.timezoneId);
            this.classStartDateFormat = FormatUtil.formatDateWithTZID(this.classInfo.dateStart, "date_standard", this.classInfo.timezoneId);
            this.enableDiscountField = this.classInfo? (this.classInfo.isDiscMultiClasses || this.classInfo.isDiscMultiStudents) : this.enableDiscountField;

            this.projectedMemberId = options.projectedMemberId? options.projectedMemberId : 0;
            this.projectedLessonClassInId = options.projectedLessonClassInId? options.projectedLessonClassInId : 0;
            this.isShowRatePlanCost = (this.projectedLessonClassInId > 0 || this.projectedMemberId != 0);
            if (options.needBuildPaymentDescription) this.needBuildPaymentDescription = options.needBuildPaymentDescription;
        }
        this._setupProjector();
        if(options.gridChangeCallback) {
            this.gridChangeCallback = options.gridChangeCallback;
        }
        if(options.finishLoadingCallback) {
            this.finishLoadingCallback = options.finishLoadingCallback;
        }
        this.didAttached = false;

        this.bind("p:PopupHidden", function(e){
            var c = thiz.projectorItems.querySelector("tr td.Focus");
            if (c) Dom.removeClass(c, "Focus");
        }, this.projectionPopup);

        this.bind(ClassEditPaymentPlanTab.RATE_PLAN_CHANGE, function(event) {
            window.defaultIndicator.busy("Loading...");
            thiz._loadProjection(event.paymentPlanItem).then(function(res){
                thiz._appendProjection(res, true);
                if(window.defaultIndicator) window.defaultIndicator.done();
            }).catch(function(err) {
                console.log("Cannot project this payment plan item", err);
                if(window.defaultIndicator) window.defaultIndicator.done();
                Dialog.error("Cannot project this payment plan item");
            });
        });
	    this.bind("click", this.viewRateChartLinkClickedHandler, this.viewRateChartLink);

        InfoTip.install(this.ratePlanContent, {
            match: function (node) {
                return Dom.hasClass(node, "RatePlanFeeHintText");
            },
            getMessage: function (target) {
                return Dom.newDOMElement({
                    _name: "div",
                    _html: "You will be charged " + target.getAttribute("ratePlanFee") + " once for all classes in this rate plan."
                })
            }
        });
    }

    __extend(BaseTemplatedWidget, PaymentPlanItemGrid);

    PaymentPlanItemGrid.prototype.updateClassInfo = function(classInfo){
        this.classInfo = classInfo;
        this.isClassInfoChanged = true;
    }

    PaymentPlanItemGrid.prototype.onAttached = function() {
        if(this.didAttached) return;
        this.didAttached = true;
        window.setTimeout(this.onAttachedDelayed.bind(this), 10);
        
    };

    PaymentPlanItemGrid.prototype._setupProjector = function(){
        var thiz = this;
        if (this.readOnly) {
            Dom.addClass(this.paymentPlanProjector, "ReadOnly");
            var totalCell = this.projectorFooter.querySelector("td.TotalAmount");
            totalCell.removeAttribute("colspan");
        }
        if (!this.isClassAdmin) {
            Dom.addClass(this.paymentPlanProjector, "NonClassAdmin");
        }
        if (this.getSubTotalByMonthTitle) Dom.setInnerText(this.totalTittle, this.getSubTotalByMonthTitle());
        var gridClickHandler = function(event) {
            var target = Dom.getTarget(event);
            var row = Dom.findUpward(target, new DomTagNameEvaluator("tr"));
            if (!row) return;
            var nav = Dom.findUpward(target, {
                eval: function (n) {
                    return Dom.hasClass(n, "Indicator") && Dom.hasClass(n, "Prev");
                },
            });
            if (nav) {
                thiz._slideHeader(-1);
                return;
            };

            nav = Dom.findUpward(target, {
                eval: function (n) {
                    return Dom.hasClass(n, "Indicator") && Dom.hasClass(n, "Next");
                },
            });
            if (nav) {
                thiz._slideHeader(1);
                return;
            };

            var ppiKey = row.getAttribute("ppi-key") + "";
            if(!ppiKey) return;
            var ppi = thiz.paymentPlanItems[ppiKey];
            if(!ppi) return;

            var editAction = Dom.findUpward(target, {
                eval: function (n) {
                    return Dom.hasClass(n, "PaymentPlanItem Edit") && Dom.isTag(n, "span");
                },
            });
            if (editAction && !thiz.readOnly) {
                thiz._openPaymentPlanItemDialog(ppi, editAction);
                return;
            }
            var deleteAction = Dom.findUpward(target, {
                eval: function (n) {
                    return Dom.hasClass(n, "PaymentPlanItem Delete") && Dom.isTag(n, "span");
                },
            });

            if (deleteAction && !thiz.readOnly) {
                thiz._deletePaymentPlanItem(ppi);
                return;
            }

            var viewRatePlan = Dom.findUpward(target, {
                eval: function (n) {
                    return Dom.hasClass(n, "RatePlanIndicator") && !Dom.hasClass(n, "Disable");
                }
            });
            if (viewRatePlan) {
                if (thiz.assigningRatePlan){
                    thiz.viewRateChart(ppi, viewRatePlan);
                } else {
                    thiz.viewRatePlan(ppi, viewRatePlan);
                }
                return;
            }

            var cell = Dom.findUpward(target, {
                eval: function (n) {
                    return Dom.hasClass(n, "Editable")
                            && ((Dom.hasClass(n, "ProjectedCell") && Dom.isTag(n, "td"))
                                    || Dom.hasClass(PaymentPlanItemGrid.CLASS_START)
                                    || Dom.hasClass(PaymentPlanItemGrid.REGISTRATION));
                },
            });
            if (!cell && ((Dom.hasClass(target, PaymentPlanItemGrid.CLASS_START) && Dom.hasClass(target, "Editable") && target.getAttribute("projected-slot-key") == PaymentPlanItemGrid.CLASS_START)
                || (Dom.hasClass(target, PaymentPlanItemGrid.REGISTRATION) && Dom.hasClass(target, "Editable") && target.getAttribute("projected-slot-key") == PaymentPlanItemGrid.REGISTRATION))) {
                cell = target;
            }

            if (cell && !thiz.readOnly) {
                var colKey = cell.getAttribute("projected-slot-key");
                if(!colKey) return;
                if(Dom.hasClass(cell, PaymentPlanItemGrid.CLASS_START) || Dom.hasClass(cell, PaymentPlanItemGrid.REGISTRATION)) {
                    var p = Dom.findUpward(cell, {
                        eval: function (n) {
                            return Dom.hasClass(n, "Editable") && Dom.hasClass(n, "ProjectedCell") && Dom.isTag(n, "td") ;
                        },
                    });
                    if (p) {
                        Dom.addClass(p, "Focus");
                        if (colKey == PaymentPlanItemGrid.CLASS_START && p.getAttribute("projected-slot-key") == PaymentPlanItemGrid.REGISTRATION) {
                            colKey = PaymentPlanItemGrid.REGISTRATION;
                        }
                    }
                } else {
                    Dom.addClass(cell, "Focus");
                }

                thiz._openChargeDialog(cell, ppi, colKey);
                return;
            }
        };

        Dom.registerEvent(this.paymentPlanProjector, "click", gridClickHandler, false);
    }

    PaymentPlanItemGrid.prototype.onAttachedDelayed = function() {
        var thiz = this;
        this._init();
    };


    PaymentPlanItemGrid.prototype._init = function() {
        var thiz = this;
        this._cleanProjector();
        var rows = [];
        if(this.existingItems && this.existingItems.length){
            for (var i = 0; i < this.existingItems.length; i++) {
                if (!this.isSpecialPaymentPlanItem(this.existingItems[i].key)) rows.push(this.existingItems[i]);
            }
        }
        this.existingItems = [];
        var d = this.classInfo.annualRegAccountAmt;
        if (this.classInfo && this.classInfo.enableAnnualRegAccount && (d > 0)){
            var p = PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.ANNUAL_REG_ACCOUNT, d);
            this.existingItems.push(p);
        }
        d = this.classInfo.annualRegStudentAmt;
        if (this.classInfo && this.classInfo.enableAnnualRegStudent && d > 0){
            var p = PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.ANNUAL_REG_STUDENT, d);
            this.existingItems.push(p);
        }
        if (this.classInfo && this.classInfo.familyRegFee > 0){
            var p = PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.FAMILY_REG_FEE, this.classInfo.familyRegFee);
            this.existingItems.push(p);
        }

        this.existingItems = this.existingItems.concat(rows);

        this._buildGridStructure();
        this._updatePaymentPlanItemRows();

        this._updateNavigator();
        this._updateSubTotalByMonths();
        this._gridChangeCallback();
        if(!(this.existingItems && this.existingItems.length)){
            this.existingItems.push(PaymentPlanItemGrid.buildEmptyPaymentPlanItem());
        }
        if(this.existingItems && this.existingItems.length){
            this._reloadExistingPlanItems(this.existingItems);
        } else {
            setTimeout(function(){
                thiz._moveToMonth(new Date(), thiz.classInfo.timezoneId);
            }, 100);
        }
        
    }
    PaymentPlanItemGrid.prototype._moveToMonth = function (currentDate, tz) {
        if (!currentDate) return;
        var thiz = this;
        var m = moment.tz(currentDate, tz).format('YYYYMM');
        for (var i = 0; i < thiz.projectedColumns.length; i++) {
            var isFirstMonthAfterCurrent = false;
            var k = thiz.projectedColumns[i];
            if (k != PaymentPlanItemGrid.REGISTRATION && k != PaymentPlanItemGrid.CLASS_START) {
                var p = parseInt(k);
                var n = parseInt(m);
                isFirstMonthAfterCurrent = (k > n);
            }
            if (k == m || isFirstMonthAfterCurrent) {
                var l = thiz.projectedColumns.length;
                if (i > PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS) {
                    var steps = 0;
                    if (i + (PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS -  PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS) > l){
                        steps = l - (PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS);
                    } else {
                        steps = i - thiz.firstVisibleHeaderIndex - PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS;
                    }
                    thiz._slideHeader(steps);
                } else if (i > PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS && l > this.totalVisibleColumns){
                    steps = i - PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS;
                    thiz._slideHeader(steps);
                }
                return;
            }
        }
    }

    PaymentPlanItemGrid.prototype.setSelectedSlot = function(newSlot) {
        if(this.selectedSlot != newSlot) {
            this.selectedSlot = newSlot;
        }
    }

    PaymentPlanItemGrid.prototype.reloadProjector = function(slot) {
        this.existingItems = this.getPaymentPlanItems();
        var thiz = this;
        var rowsOrder = [].concat(this.rowsOrder);
        var paymentPlanItems = this.paymentPlanItems;
        var projectedSlots = this.projectedSlots;
        this.selectedSlot = slot;

        this._cleanProjector();
        this.rowsOrder = rowsOrder;
        this.paymentPlanItems = paymentPlanItems
        this.projectedSlots = projectedSlots;
        this._buildGridStructure();
        this._updatePaymentPlanItemRows();
        var forceReload = false;;
        if (this.isClassInfoChanged) {
            forceReload = this._normalizeFamilyRegFee(this.existingItems, this.classInfo.familyRegFee);
            this.isClassInfoChanged = false;
            if(!(this.existingItems && this.existingItems.length)){
                this.existingItems.push(PaymentPlanItemGrid.buildEmptyPaymentPlanItem());
            }
        }
        if((this.existingItems && this.existingItems.length) || forceReload){
            this.paymentPlanItems = {};
            this._reloadExistingPlanItems(this.existingItems, forceReload);
        }

    }

    PaymentPlanItemGrid.prototype._normalizeFamilyRegFee = function(items, feeAmount) {
        var forceReload = false;
        var thiz = this;
        if(items && items.length){
            var existingPos = -1;
            for(var i = 0; i < items.length; i++) {
                if(items[i].key == PaymentPlanItemGrid.FAMILY_REG_FEE){
                    isExisting = true;
                    existingPos = i;
                    break;
                }
            }
            if (!(existingPos >= 0) && feeAmount) {
                var p = PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.FAMILY_REG_FEE, feeAmount);
                items.push(p);
            } else if(existingPos >= 0 && feeAmount == 0) {
                items.splice(existingPos, 1);
                var k = thiz.rowsOrder.indexOf(PaymentPlanItemGrid.FAMILY_REG_FEE);
                (k < 0) || (thiz.rowsOrder.splice(k, 1));
                forceReload = true;
                thiz._removePaymentPlanItemFromSubTotalByMonth(PaymentPlanItemGrid.FAMILY_REG_FEE);
            } else if(existingPos >= 0 && feeAmount != 0) {
                var p = PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.FAMILY_REG_FEE, feeAmount);
                items[existingPos] = p;
            }
        } else if (feeAmount) {
            var p = PaymentPlanItemGrid.buildSpecialPaymentPlanItem(PaymentPlanItemGrid.FAMILY_REG_FEE, feeAmount);
            items.push(p);
        }
        return forceReload;
    }

    PaymentPlanItemGrid.prototype._cleanProjector = function(slot) {
        this.projectedColumns = [PaymentPlanItemGrid.REGISTRATION];
        this.DEFAULT_HEADER_LENGTH = this.projectedColumns.length;
        this.headerCellContent = {};
        var startDate = FormatUtil.formatDateWithTZID(this.classInfo.date4Register, "date_standard", this.classInfo.timezoneId);
        var endDate = FormatUtil.formatDateWithTZID(this.classInfo.date4RegisterEnd, "date_standard", this.classInfo.timezoneId);
        this.headerCellContent[PaymentPlanItemGrid.REGISTRATION] = {title: PaymentPlanItemGrid.REGISTRATION, desc: startDate + " - " + endDate};
//      this.headerCellContent[PaymentPlanItemGrid.CLASS_START] = {title: "Class Start"};
        this.subTotalByMonths = {};
        this.subTotalByMonths[PaymentPlanItemGrid.REGISTRATION] = {};
//      this.subTotalByMonths[PaymentPlanItemGrid.CLASS_START] = {};
        this.subTotalByMonths[PaymentPlanItemGrid.TOTAL_AMOUNT] = {};
        this.totalAmount = 0;
        this.rowsOrder = [];
        this.paymentPlanItems = {};
        this.projectedSlots = {};
        this.firstVisibleHeaderKey = null;
        this.firstVisibleHeaderIndex = -1;
        this.totalVisibleColumns = 0;
        this.isFirstSetup = true;

        var row = this.projectorItems.querySelector("tr");
        while (row) {
            row.parentNode.removeChild(row);
            row = this.projectorItems.querySelector("tr");
        }
        var cell = this.projectorHeader.querySelector("th.ProjectedCol");
        while (cell) {
            cell.parentNode.removeChild(cell);
            cell = this.projectorHeader.querySelector("th.ProjectedCol");
        }

        cell = this.projectorFooter.querySelector("td.Fee");
        while (cell) {
            cell.parentNode.removeChild(cell);
            cell = this.projectorFooter.querySelector("td.Fee");
        }
    }


    PaymentPlanItemGrid.prototype.createPaymentPlanItem = function() {
        var thiz = this;
        this._openPaymentPlanItemDialog();
    };

    PaymentPlanItemGrid.prototype._openPaymentPlanItemDialog = function(ppi, editAction) {
        var thiz = this;
        var showDiscountableField = this.enableDiscountField;
        var minDate = thiz.classInfo.dateStart;
        if (thiz.classInfo.date4Register.getTime() < thiz.classInfo.dateStart.getTime()) {
            minDate = thiz.classInfo.date4Register;
        }

        // only one RATE PLAN charge is supported
        var hasRatePlanChargeItem = false;
        for (var key in this.paymentPlanItems) {
            var item = this.paymentPlanItems[key];
            if (item.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN) {
                hasRatePlanChargeItem = true;
                break;
            }
        }

        var openData = {
            editAction: editAction,
            chargeCategories: this.filters.chargeCategories,
            contraintValues: {
                minDate: minDate,
                maxDate: thiz.classInfo.dateEnd,
                regDate: thiz.classInfo.date4Register,
                classStartDate: thiz.classInfo.dateStart,
                classEndDate: thiz.classInfo.dateEnd,
                timezoneId: thiz.classInfo.timezoneId,
                isFirstItem: thiz.isFirstItem,
                showDiscountableField: showDiscountableField,
                enableRatePlanChargeType: !hasRatePlanChargeItem,
                orgTimezoneId: thiz.classInfo.orgTimezoneId
            }};
        if (ppi) {
            openData.paymentPlanItem = ppi;
        }
        new __pkg.NewPaymentPlanItemDialog().callback(function(data) {
            if(!data) return;
            if(!data.key) data.key = Util.newUUID();
            window.defaultIndicator.busy("Loading...");
            thiz._loadProjection(data).then(function(res){
                thiz._appendProjection(res, true);
                Dom.emitEvent(ClassEditPaymentPlanTab.CPP_PAYMENT_PLAN_CHANGE, thiz.node(), {paymentPlanItem: res.paymentPlanItem});
                if(window.defaultIndicator) window.defaultIndicator.done();
            }).catch(function(err) {
                console.log("Cannot project this payment plan item", err);
                if(window.defaultIndicator) window.defaultIndicator.done();
                Dialog.error("Cannot project this payment plan item");
            });
        }).open(openData);
    };

    PaymentPlanItemGrid.prototype._deletePaymentPlanItem = function(ppi) {
        var thiz = this;
        Dialog.confirmDangerousAction("Do you want to delete this payment plan item \"" + ppi.name + "\"?", null, "Delete", function(){
            delete thiz.paymentPlanItems[ppi.key];
            delete thiz.projectedSlots[ppi.key];
            var pos = thiz.rowsOrder.indexOf(ppi.key);
            if(pos >= 0) {
                thiz.rowsOrder.splice(pos, 1);
            }
            var row = thiz.projectorItems.querySelector("tr[ppi-key=\"" + ppi.key + "\"]");
            if(row) row.parentNode.removeChild(row);
            thiz._removePaymentPlanItemFromSubTotalByMonth(ppi.key);
            thiz._updateSubTotalByMonths();
            thiz._updatePaymentPlanItemRows();
            Dom.emitEvent(ClassEditPaymentPlanTab.CPP_PAYMENT_PLAN_CHANGE, thiz.node(), {paymentPlanItem: ppi});
        },
        "Cancel", function() {}, null, null);
    }

    PaymentPlanItemGrid.prototype._convertProjectedCharge = function(ppi, chargeItem) {
        return {
            paymentPlanItemKey: ppi.key,
            paymentPlanItemId: ppi.id,
            sourceId: chargeItem.sourceId,
            key: chargeItem.key,
            dayDiff: chargeItem.dayDiff,
            chargeTimeType: chargeItem.chargeTimeType,
            specificChargeDate: chargeItem.date,
            dueTimeType: chargeItem.dueTimeType,
            specificDueDate: chargeItem.dueDate,
            dayOfMonth: ppi.dayOfMonth,
            amount: chargeItem.amount,
            overrideKey: chargeItem.overrideKey,
            manualChargeKey: chargeItem.key
        }
    }

    PaymentPlanItemGrid.prototype._openChargeDialog = function(target, ppi, colKey) {
        var thiz = this;
        thiz.projectionPopupContent.innerHTML = "";
        var projectedSlots = this.projectedSlots[ppi.key];
        var charges = [];
        var chargeOverrides = {};
        var currentManualChargeKeys = [];
        var manualChargeDatesMap = {};
        if (ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL && ppi.manualChargeDates) {
            for (var i = 0; i < ppi.manualChargeDates.length; i++) {
                var chargeItem = ppi.manualChargeDates[i];
                var k = (chargeItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE? chargeItem.specificChargeDate.getTime() : chargeItem.chargeTimeType);
                manualChargeDatesMap[k] = chargeItem;
            }
        }
        if (projectedSlots && projectedSlots[colKey] && projectedSlots[colKey].charges) {
            var editingKeys = [];
            if (colKey == PaymentPlanItemGrid.REGISTRATION) {
                editingKeys.push(colKey);
                editingKeys.push(PaymentPlanItemGrid.CLASS_START);
            } else if (colKey == PaymentPlanItemGrid.CLASS_START) {
                editingKeys.push(PaymentPlanItemGrid.REGISTRATION);
                editingKeys.push(colKey);
            } else {
                editingKeys.push(colKey);
            }
            for (var l = 0; l < editingKeys.length; l++) {
                var aKey = editingKeys[l];
                for (var i = 0; i < projectedSlots[aKey].charges.length; i++) {
                    var chargeItem = projectedSlots[aKey].charges[i];
                    var convertItem = thiz._convertProjectedCharge(ppi, chargeItem);
                    charges.push(convertItem);
                    if(ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL){
                        var k = (chargeItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE? chargeItem.date.getTime() : chargeItem.chargeTimeType);
                        currentManualChargeKeys.push(k);
                        var m = manualChargeDatesMap[k];
                        !m || (convertItem.manualChargeKey = m.key);
                    } else if (thiz.chargeOverrides[ppi.key]){
                        var k = chargeItem.overrideKey;
                        var o = thiz.chargeOverrides[ppi.key][k];
                        !o || (chargeOverrides[k] = o);
                    }

                }
            }

        }
        var minDate = thiz.classInfo.dateStart,
            maxDate = thiz.classInfo.dateEnd;
        if (colKey && colKey != PaymentPlanItemGrid.REGISTRATION && colKey != PaymentPlanItemGrid.CLASS_START) {
            var y = colKey.substring(0, 4);
            var m = colKey.substring(4, colKey.length);
            minDate = moment.tz(y + "-" + m + "-01 00:00:00", thiz.classInfo.timezoneId).toDate();
            maxDate = moment(minDate).add(1, "months").subtract(1, "minutes").toDate();
            if (maxDate.getTime() > thiz.classInfo.dateEnd.getTime()) maxDate = thiz.classInfo.dateEnd;
        }

        if (minDate.getTime() < thiz.classInfo.dateStart.getTime()) minDate = thiz.classInfo.dateStart;
        if (ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL || ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.INSTALLMENT_PLAN) {
            if (thiz.classInfo.date4Register.getTime() < thiz.classInfo.dateStart.getTime()) minDate = thiz.classInfo.date4Register;
        }

        var params = {
            paymentPlanItem: ppi,
            charges: charges,
            chargeOverrides: chargeOverrides,
            contraintValues: {
                minDate: minDate,
                maxDate: maxDate,
                regDate: thiz.classInfo.date4Register,
                classStartDate: thiz.classInfo.dateStart,
                classEndDate: thiz.classInfo.dateEnd,
                timezoneId: thiz.classInfo.timezoneId,
                orgTimezoneId: thiz.classInfo.orgTimezoneId
            },
            invalidatePosition: function () {
                thiz.projectionPopup.invalidatePosition();
            },
            applyProjectionHandler: function(addedCharges, removedChargeItems) {
                Dom.removeClass(target, "Focus");
                thiz.applyProjectionHandler(ppi, addedCharges, removedChargeItems, currentManualChargeKeys);
            },
            cancelProjectionHandler: function() {
                Dom.removeClass(target, "Focus");
                thiz.cancelProjectionHandler(ppi);
            },
            removeAllProjectionHandler: function() {
                Dom.removeClass(target, "Focus");
                thiz.removeAllProjectionHandler(ppi, currentManualChargeKeys);
            },
            removeOverrideProjectionHandler: function() {
                Dom.removeClass(target, "Focus");
                thiz.removeOverrideProjectionHandler(ppi, chargeOverrides);
            }
        };
        if (ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL) {
            if (!charges || charges.length == 0) {
                if (colKey == PaymentPlanItemGrid.REGISTRATION) {
                    params.defaultChargeAt = ClassUtils.CHARGE_TIME_TYPE.REGISTRATION;
                } else if (colKey == PaymentPlanItemGrid.CLASS_START) {
                    params.defaultChargeAt = ClassUtils.CHARGE_TIME_TYPE.CLASS_START;
                } else if (colKey.match(/^([0-9]{4,4})([0-9]{2,2})$/)) {
                    var spec = {
                        year: parseInt(RegExp.$1, 10),
                        month: Math.max(0, parseInt(RegExp.$2, 10) - 1),
                        date: 1,
                        hour: 0,
                        minute: 0,
                        second: 0,
                        milisecond: 0
                    };
                    params.defaultChargeAt = moment.tz(spec, thiz.classInfo.timezoneId).toDate();
                }
            }
        }

        if (params.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING) Dom.addClass(thiz.projectionPopupContent, "Recurring");
        new __pkg.ProjectionChargeEditWidget(params).into(thiz.projectionPopupContent);
        thiz.projectionPopup.show(target, "center", "bottom", 0, 5, true);
    };


    PaymentPlanItemGrid.prototype.applyProjectionHandler = function(ppi, addedCharges, removedChargeItems, currentManualChargeKeys) {
        this.projectionPopup.hide();
        var thiz = this;
        if(ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL){
            var removedChargeKeys = [];
            for (var i = 0; i < removedChargeItems.length; i++) {
                var chargeItem = removedChargeItems[i];
                var k = (chargeItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE? chargeItem.specificChargeDate.getTime() : chargeItem.chargeTimeType);
                removedChargeKeys.push(k);
            }
            var manualChargeMap = {};
            var newManualCharges = [];
            for (i = 0; i < ppi.manualChargeDates.length; i++) {
                var chargeItem = ppi.manualChargeDates[i];
                var k = (chargeItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE? chargeItem.specificChargeDate.getTime() : chargeItem.chargeTimeType);
                if(removedChargeKeys.indexOf(k) > -1) continue;
                manualChargeMap[k] = chargeItem;
                newManualCharges.push(chargeItem);
            }
            ppi.manualChargeDates = newManualCharges;
            var newAddedKeys = [];
            for (i = 0; i < addedCharges.length; i++) {
                var nc = addedCharges[i];
                var key = nc.chargeTimeType;
                if (nc.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
                    key = nc.specificChargeDate.getTime();
                }
                newAddedKeys.push(key);
                var currentManualCharge = manualChargeMap[key];
                if (!currentManualCharge) {
                    var m = this._convertToManualCharge(nc);
                    m.paymentPlanItemId = ppi.id;
                    ppi.manualChargeDates.push(m);
                    manualChargeMap[key] = m;
                } else {
                    var m = this._convertToManualCharge(nc);
                    manualChargeMap[key].chargeTimeType = m.chargeTimeType;
                    manualChargeMap[key].dayDiff = 0;
                    manualChargeMap[key].dueTimeType = m.dueTimeType;
                    manualChargeMap[key].paymentPlanItemId = ppi.id;
                    manualChargeMap[key].specificChargeDate = m.specificChargeDate;
                    manualChargeMap[key].amount= m.amount;
                    manualChargeMap[key].specificDueDate = m.specificDueDate;
                }
            }

            if(currentManualChargeKeys) {
                var removedKeys = [];
                for (i = 0; i < currentManualChargeKeys.length; i++){
                    if(newAddedKeys && newAddedKeys.indexOf(currentManualChargeKeys[i]) > -1) continue;
                    removedKeys.push(currentManualChargeKeys[i]);
                }

                newManualCharges = [];
                for (var i = 0; i < ppi.manualChargeDates.length; i++) {
                    var chargeItem = ppi.manualChargeDates[i];
                    var k = (chargeItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE? chargeItem.specificChargeDate.getTime() : chargeItem.chargeTimeType);
                    if(removedKeys.indexOf(k) > -1)  continue;
                    newManualCharges.push(ppi.manualChargeDates[i]);
                }
                ppi.manualChargeDates = newManualCharges;
            }
        } else {
            var ppiOverrideChage = this.chargeOverrides[ppi.key];
            if(!ppiOverrideChage) {
                ppiOverrideChage = {};
                this.chargeOverrides[ppi.key] = ppiOverrideChage;
            }
            for (var i = 0; i < addedCharges.length; i++){
                ppiOverrideChage[addedCharges[i].targetOverrideKey] = addedCharges[i];
            }
            var allOverrides = [];
            for (var o in ppiOverrideChage) {
                allOverrides.push(ppiOverrideChage[o]);
            }
            ppi.chargeOverrides = allOverrides;
        }
        thiz._loadProjection(ppi).then(function(res){
            thiz._appendProjection(res, true);
            Dom.emitEvent(ClassEditPaymentPlanTab.CPP_PAYMENT_PLAN_CHANGE, thiz.node(), {paymentPlanItem: res.paymentPlanItem});
            if(window.defaultIndicator) window.defaultIndicator.done();
        }).catch(function(err) {
            if(window.defaultIndicator) window.defaultIndicator.done();
        });
    };

    PaymentPlanItemGrid.prototype._convertToManualCharge = function(editedCharge) {
        return {
            id: editedCharge.id? editedCharge.id : 0,
            key: editedCharge.key? editedCharge.key : "",
            chargeTimeType: editedCharge.chargeTimeType,
            dayDiff: 0,
            dueTimeType: editedCharge.dueTimeType,
            specificDueDate: editedCharge.specificDueDate,
            paymentPlanItemId: 0,
            specificChargeDate: editedCharge.specificChargeDate,
            amount: editedCharge.amount
        }
    }

    PaymentPlanItemGrid.prototype.cancelProjectionHandler = function(paymentPlanItem, colKey) {
        this.projectionPopup.hide();
    };

    PaymentPlanItemGrid.prototype.removeAllProjectionHandler = function(ppi, currentChargeKeys) {
        this.projectionPopup.hide();
        var thiz = this;
        var newManualCharges = [];
        for (var i = 0; i < ppi.manualChargeDates.length; i++) {
            var chargeItem = ppi.manualChargeDates[i];
            var k = (chargeItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE? chargeItem.specificChargeDate.getTime() : chargeItem.chargeTimeType);
            if(currentChargeKeys.indexOf(k) > -1)  continue;
            newManualCharges.push(ppi.manualChargeDates[i]);
        }
        ppi.manualChargeDates = newManualCharges;
        thiz._loadProjection(ppi).then(function(res){
            thiz._appendProjection(res, true);
            Dom.emitEvent(ClassEditPaymentPlanTab.CPP_PAYMENT_PLAN_CHANGE, thiz.node(), {paymentPlanItem: res.paymentPlanItem});
            if(window.defaultIndicator) window.defaultIndicator.done();
        }).catch(function(err) {
            if(window.defaultIndicator) window.defaultIndicator.done();
        });
    };

    PaymentPlanItemGrid.prototype.removeOverrideProjectionHandler = function(ppi, chargeOverrides) {
        this.projectionPopup.hide();
        if (!chargeOverrides) return;
        var thiz = this;
        var ppiOverrideChage = this.chargeOverrides[ppi.key];
        if(!ppiOverrideChage) return;
        var removedKeys = [];
        for (var k in chargeOverrides) {
            removedKeys.push(k);
        }
        var allOverrides = [];
        var overridesMap = {};
        for (var o in ppiOverrideChage) {
            if (removedKeys.indexOf(o) > -1) continue;
            allOverrides.push(ppiOverrideChage[o]);
            overridesMap[o] = ppiOverrideChage[o];
        }
        ppi.chargeOverrides = allOverrides;
        this.chargeOverrides[ppi.key] = overridesMap;
        thiz._loadProjection(ppi).then(function(res){
            thiz._appendProjection(res, true);
            Dom.emitEvent(ClassEditPaymentPlanTab.CPP_PAYMENT_PLAN_CHANGE, thiz.node(), {paymentPlanItem: res.paymentPlanItem});
            if(window.defaultIndicator) window.defaultIndicator.done();
        }).catch(function(err) {
            if(window.defaultIndicator) window.defaultIndicator.done();
        });
    };

    PaymentPlanItemGrid.prototype._reloadExistingPlanItems = function(existingItems, forceReload) {
        if(existingItems && existingItems.length){
            var thiz = this;
            var projectedInfo = {}

            var processingFn = function(ppItems) {
                for (var i = 0; i < ppItems.length; i++){
                    var ppi = ppItems[i].paymentPlanItem;
                    if (!ppi.key) ppi.key = Util.newUUID();
                    thiz._appendProjection(ppItems[i]);
                }
                thiz._updateGrid();
                thiz.emitRevenueChange(thiz.node(), thiz.paymentPlanId);
                if(typeof(thiz.finishLoadingCallback) == "function") thiz.finishLoadingCallback();
                thiz._gridChangeCallback(existingItems, thiz.forceValidation, thiz.isFirstSetup);
                if (thiz.isFirstSetup) {
                    setTimeout(function(){
                        thiz._moveToMonth(new Date(), thiz.classInfo.timezoneId);
                    }, 100);
                }
                thiz.isFirstSetup = false;
                
            }
            if (thiz.options.externalSource) {
                    processingFn (thiz.options.externalSource);
            } else {
                if (thiz.projectedLessonClassInId > 0) {
                    projectedInfo = {lessonClassInId: thiz.projectedLessonClassInId};
                } else {
                    projectedInfo = {classInfo: thiz.classInfo,
                        slot: thiz.selectedSlot,
                        paymentPlanItems: existingItems,
                        startDate: thiz.startProjectedDate,
                        endDate: thiz.endProjectedDate,
                        lessonClassInId: thiz.projectedLessonClassInId,
                        memberId: thiz.projectedMemberId
                    };
                }

                if (thiz.options.excludedLessonClassInIds && thiz.options.excludedLessonClassInIds.length > 0) {
                    projectedInfo.excludedLessonClassInIds = thiz.options.excludedLessonClassInIds;
                }
                projectedInfo.registrationDate = this.registrationProjectedDate || new Date();
                thiz.loadPaymentPlanItems(projectedInfo, processingFn);
            }

            return;
        } else {
            this.projectorItems.innerHTML = "";
            this._removePaymentPlanItemFromSubTotalByMonth(PaymentPlanItemGrid.FAMILY_REG_FEE);
            if(forceReload) {
                this._gridChangeCallback();
            }
        }


    }
    
    PaymentPlanItemGrid.prototype._buildPaymentDescription =  function(projectedPpi){
        if (this.needBuildPaymentDescription){
            var tzId = this.classInfo.timezoneId;
            var projectedCharges = projectedPpi.projectedCharges;
            var isPpiRatePlan = projectedPpi.paymentPlanItem.ratePlanId && projectedPpi.paymentPlanItem.ratePlanId > 0;
            console.log("::: Plan #" + this.paymentPlanId + "; PPI #"   + projectedPpi.paymentPlanItem.id + " -> name:", 
                tzId, projectedPpi.paymentPlanItem.name, "Rate plan:" + isPpiRatePlan, projectedPpi);
            if (projectedCharges && projectedCharges.length > 0){
                for (var i = 0; i < projectedCharges.length; i ++){
                    var s = projectedCharges[i];
                    var amt = ClassUtils.round(s.amount);
                    if (amt <= 0 && !isPpiRatePlan) {
                        console.log("        -> Zero Charge, no amount", s.amount, amt, this.uniqueChargeDates, this.uniqueChargeMonths);
                        continue;
                    }
                    if (s.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION){
                        if (s.amount > 0 ) this.totalOneTimeAmount += s.amount ;
                        if (s.amount == -1 ) this.totalRatePlanOneTimeAmount = ClassUtils.showAlternativeCost("--") ;
                            
                    } else if (s.date){
                        if (projectedPpi.paymentPlanItem.key == PaymentPlanItemGrid.PROCESSING_FEE_KEY) {
                            console.log("        -> Processing fee PPI, no added to count");
                            continue;
                        }
                        var key = s.dateCounterKey; //FormatUtil.formatDateWithTZID(s.date, "date_standard", tzId);
                        if (!this.uniqueChargeDates.includes(key)) this.uniqueChargeDates.push(key);
                        var monthKey = s.monthCounterKey;//FormatUtil.formatDateWithTZID(s.date, "monthyear", tzId);
                        if (!this.uniqueChargeMonths.includes(monthKey)) this.uniqueChargeMonths.push(monthKey);
                        console.log("        -> Charge, date:", s.date, " date key:", key, "length:" + this.uniqueChargeDates.length, "monthKey:" + monthKey, "length:" + this.uniqueChargeMonths.length, "Amount:" + s.amount, "Around:" + amt);
                    }  
                }
            }
            console.log("      => Result:::", projectedPpi.paymentPlanItem.name, projectedPpi.paymentPlanItem.id, this.totalOneTimeAmount , this.uniqueChargeDates, this.uniqueChargeMonths);
        }
    }
    
    PaymentPlanItemGrid.prototype._composePaymentDescriptionOld = function (node, paymentPlanId){
        // Dom.emitEvent(ClassEditPaymentPlanTab.CPP_REVENUE_CHANGE, this.node(), {totalAmount: Dom.getText(totalCell), paymentPlanId: this.paymentPlanId});
        console.log("      ==> [OLD]Compose payment string:::", node, paymentPlanId, this.needBuildPaymentDescription, this.totalOneTimeAmount);
        if (!this.needBuildPaymentDescription) return "";
        var paymentDescription = "";
        var totalOneTimeAmountStr = "";
        if (this.uniqueChargeMonths.length > 12){
            var durationStr = "";
            if (this.uniqueChargeMonths.length > 14) {
                var totalMonths = this.uniqueChargeMonths.length;
                var years = Math.floor(totalMonths / 12);
                var remainingMonths = totalMonths % 12; 
                durationStr = "";
                if (years > 0) {
                    durationStr += years + " year" + (years === 1 ? " " : "s ");
                }

                if (remainingMonths > 0) {
                    durationStr += remainingMonths + " month" + (remainingMonths === 1 ? "" : "s");
                }
            } else {
                durationStr += this.uniqueChargeMonths.length + " months";
            }
            if (this.totalOneTimeAmount == 0){
                paymentDescription = "Subscription for maximum " + durationStr;
            }

            if (this.totalOneTimeAmount > 0){
                paymentDescription = "One-time with subscription for maximum " + durationStr;
            }
        
        } else {
            if (this.uniqueChargeDates.length == 0 && this.totalOneTimeAmount > 0){
                paymentDescription = ClassUtils.toCurrency(this.totalOneTimeAmount) + " one-time payment";
            }

            if (this.uniqueChargeDates.length > 0 && this.totalOneTimeAmount == 0){
                paymentDescription = "Maximum " + this.uniqueChargeDates.length + " additional payment" + (this.uniqueChargeDates.length > 1? "s" : "");
            }

            if (this.uniqueChargeDates.length > 0 && this.totalOneTimeAmount > 0){
                paymentDescription = "One-time with maximum " + this.uniqueChargeDates.length + " additional payment" + (this.uniqueChargeDates.length > 1? "s" : "");
            }
        }
        console.log("      ==> [OLD]Compose payment string, result :::", paymentDescription);
        return paymentDescription;
        
    }
    
    PaymentPlanItemGrid.prototype._composePaymentDescription = function (node, paymentPlanId){
        // Dom.emitEvent(ClassEditPaymentPlanTab.CPP_REVENUE_CHANGE, this.node(), {totalAmount: Dom.getText(totalCell), paymentPlanId: this.paymentPlanId});
        console.log("      ==> Compose payment string:::", node, paymentPlanId, this.needBuildPaymentDescription, this.totalOneTimeAmount);
        if (!this.needBuildPaymentDescription) return "";
        var paymentDescription = "";
        var totalOneTimeAmountStr = "";
        
        var isRatePlan = this.isRatePlanIncluded;
        var totalOneTimeAmount = this.totalOneTimeAmount;
        if (isRatePlan){
            if (this.totalOneTimeAmount > 0) {
                totalOneTimeAmountStr = ClassUtils.toCurrency(this.totalOneTimeAmount);
            }
            if (this.totalRatePlanOneTimeAmount) {
                if (totalOneTimeAmount == 0) totalOneTimeAmount = 1;
                if (totalOneTimeAmountStr) totalOneTimeAmountStr += " + "; 
                totalOneTimeAmountStr += this.totalRatePlanOneTimeAmount;
            }
        } else {
            totalOneTimeAmountStr = ClassUtils.toCurrency(this.totalOneTimeAmount);
        }
        if (this.uniqueChargeMonths.length > 12){
            var durationStr = "";
            if (this.uniqueChargeMonths.length > 14) {
                durationStr = ClassUtils.formatDurationInMonths(this.uniqueChargeMonths.length);
            } else {
                durationStr += this.uniqueChargeMonths.length + " months";
            }
            if (totalOneTimeAmount == 0){
                paymentDescription = `Subscription for maximum ${durationStr}`;
            }

            if (totalOneTimeAmount > 0 ){
                paymentDescription = `One-time with subscription for maximum ${durationStr}`;
            }
        
        } else {
            if (this.uniqueChargeDates.length == 0 && (totalOneTimeAmount > 0)){
                paymentDescription = `${totalOneTimeAmountStr} one-time payment`;
            }

            var pluralPayment = ClassUtils.pluralize(this.uniqueChargeDates.length, "additional payment");
            if (this.uniqueChargeDates.length > 0 && this.totalOneTimeAmount == 0){
                paymentDescription = `Maximum  ${pluralPayment}`;
            }

            if (this.uniqueChargeDates.length > 0 && (totalOneTimeAmount > 0 || totalOneTimeAmount == -1)){
                paymentDescription = `One-time with maximum ${pluralPayment}`;
            }
        }
        console.log("      ==> Compose payment string, result :::", paymentDescription, totalOneTimeAmountStr, totalOneTimeAmount);
        return paymentDescription;
        
    }

    PaymentPlanItemGrid.prototype.emitRevenueChange = function (node, paymentPlanId){
        // Dom.emitEvent(ClassEditPaymentPlanTab.CPP_REVENUE_CHANGE, this.node(), {totalAmount: Dom.getText(totalCell), paymentPlanId: this.paymentPlanId});
        console.log("      ==> Emit payment string:::", node, paymentPlanId, this.needBuildPaymentDescription, this.totalOneTimeAmount);
        if (!this.needBuildPaymentDescription) return;
        var options = {};
        if (paymentPlanId && paymentPlanId > 0){
            options["paymentPlanId"] = paymentPlanId;
        }
        options["paymentDescription"] = this._composePaymentDescription(node, paymentPlanId);
        options["OLD_paymentDescription"] = this._composePaymentDescriptionOld(node, paymentPlanId);
        console.log("      ==> Emit event options :::", this.node(), options);
        Dom.emitEvent(ClassEditPaymentPlanTab.CPP_REVENUE_CHANGE, this.node(), options);
        
    }

    PaymentPlanItemGrid.buildEmptyPaymentPlanItem = function(){
        var key = PaymentPlanItemGrid.EMPTY_PAYMENT_PLAN;
        var regFeeAmt = 0.01;
        var ppi = {
            "id": 0,
            "name": key,
            "paymentPlanId": 0,
            "key": key,
            "scheduleType": ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL,
            "amount": regFeeAmt,
            "totalAmount": regFeeAmt,
            "manualChargeDates": [
            ]
        }
        return ppi;
    }

    PaymentPlanItemGrid.buildSpecialPaymentPlanItem = function(key, amount){
        var name = key; // PaymentPlanItemGrid.HEADER_NAMES[key].name;
        var regFeeAmt = amount, classFeeAmt = 0;
        var ppi = {
            "id": 0,
            "name": name,
            "paymentPlanId": 0,
            "key": key,
            "scheduleType": ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL,
            "amount": (regFeeAmt > 0? regFeeAmt : 0) + (classFeeAmt > 0? classFeeAmt : 0),
            "totalAmount": (regFeeAmt > 0? regFeeAmt : 0) + (classFeeAmt > 0? classFeeAmt : 0),
            "manualChargeDates": [
                {
                    "id": 0,
                    "amount": (regFeeAmt > 0? regFeeAmt : 0) + (classFeeAmt > 0? classFeeAmt : 0),
                    "chargeTimeType": ClassUtils.CHARGE_TIME_TYPE.REGISTRATION,
                    "dueTimeType": ClassUtils.CHARGE_TIME_TYPE.REGISTRATION,
                }
            ]
        }

        return ppi;
    }

    PaymentPlanItemGrid.prototype._reorderRows = function(){
        var row0 = [];
        var row1 = [];
        var row2 = [];
        var rows = [];
        var pushRow = function(key){
            if(key == PaymentPlanItemGrid.ANNUAL_REG_ACCOUNT) {
                row0.length || row0.push(key);
            } else if(key == PaymentPlanItemGrid.ANNUAL_REG_STUDENT) {
                row1.length || row1.push(key);
            } else if(key == PaymentPlanItemGrid.FAMILY_REG_FEE) {
                row2.length || row2.push(key);
            } else  rows.push(key);
        }
        for (var i = 0; i < this.rowsOrder.length; i++) {
            var k = this.rowsOrder[i];
            pushRow(k);
        }
        this.rowsOrder = [].concat(row0, row1, row2, rows);
    }

    PaymentPlanItemGrid.prototype._loadProjection = function(ppi, resolve, reject) {
        var thiz = this;
        return new Promise(function(resolve, reject) {
            $classAdminService.getProjectionPlan(thiz.classInfo, thiz.selectedSlot, ppi, thiz.startProjectedDate, thiz.endProjectedDate, thiz.registrationProjectedDate, function(res) {
                resolve(res);
            }, function(err) {
                reject(err);
            });
        });
    }

    PaymentPlanItemGrid.prototype._updateSubTotalByMonths = function(firstTime) {
        for(var i = 0; i < this.totalVisibleColumns; i++) {
            var k = this.projectedColumns[this.firstVisibleHeaderIndex + i] + "";
            if (i < PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS) { //!!!firstTime &&
                k = this.projectedColumns[i] + "";
            };
            var foot = this.projectorFooter.querySelector("td.Fee.Col" + i);
            foot.setAttribute("projected-slot-key", k);
            var valCell = foot.querySelector("span.Value");
            var col = this.subTotalByMonths[k];
            if(!col || !valCell) {
                continue;
            }
            var colSum = 0;
            var useRatePlan = false;
            for (var r in col) {
                if (col[r] == PaymentPlanItemGrid.RATE_PLAN_NO_COST) {
                    useRatePlan = true;
                    continue;
                }
                colSum += col[r];
            }
            if (useRatePlan) {
                valCell.innerHTML = (colSum > 0? (Util.toCurrency(colSum) + " + ") : "") + PaymentPlanItemGrid.RATE_PLAN_COST_ALTERNATIVE;
            } else {
                valCell.innerHTML = Util.toCurrency(colSum);
            }
        }

        var total = 0;
        var hasRatePlanWithoutCost = false;
        var isHaveRatePlan = false;
        for (var key in this.paymentPlanItems) {
            var ppi = this.paymentPlanItems[key];
            var isRatePlan = ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN;
            if (!isHaveRatePlan) isHaveRatePlan = ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN;
            if (isRatePlan && !this.isShowRatePlanCost)  {
                hasRatePlanWithoutCost = isRatePlan;
                continue;
            }
            if(ppi.totalAmount) total += ppi.totalAmount;
        }
        var totalCell = this.projectorFooter.querySelector("td.TotalAmount span.Value");
        var totalWrapper = this.projectorFooter.querySelector("td.TotalAmount");
        if(totalCell && totalWrapper) {
            if (hasRatePlanWithoutCost) {
                totalCell.innerHTML = (total > 0? (Util.toCurrency(total)  + " + "): "") + PaymentPlanItemGrid.RATE_PLAN_COST_ALTERNATIVE;
            } else {
                totalCell.innerHTML = Util.toCurrency(total)
            }
            if (hasRatePlanWithoutCost && !Dom.hasClass(totalWrapper, "RatePlan")) {
                Dom.addClass(totalWrapper, "RatePlan");
            }
            if (!hasRatePlanWithoutCost && Dom.hasClass(totalWrapper, "RatePlan")) {
                Dom.removeClass(totalWrapper, "RatePlan")
            }
        }
        this.totalAmount = total;
        
        //Dom.emitEvent(ClassEditPaymentPlanTab.CPP_REVENUE_CHANGE, this.node(), {totalAmount: Dom.getText(totalCell), paymentPlanId: this.paymentPlanId});
    }

    PaymentPlanItemGrid.prototype._updateSubTotalByMonth = function(colKey, rowKey, val) {
        if (!this.subTotalByMonths[colKey]) {
            this.subTotalByMonths[colKey] = {};
        }
        this.subTotalByMonths[colKey][rowKey] = val;
    }

    PaymentPlanItemGrid.prototype._removePaymentPlanItemFromSubTotalByMonth = function(rowKey) {
        var total = 0;
        for (var c in this.subTotalByMonths) {
            if (c == PaymentPlanItemGrid.TOTAL_AMOUNT) continue;
            var col = this.subTotalByMonths[c];
            if (col) {
                var colSum = 0;
                for (var r in col) {
                    if (r == rowKey) {
                        delete col[r];
                    } else{
                        colSum += col[r];
                    }
                }
                var footerCell = this.projectorFooter.querySelector("td[projected-slot-key=\"" + c + "\"] span.Value");
                if(footerCell) footerCell.innerHTML = Util.toCurrency(colSum);
                total += colSum;
            }
        }

        total = 0;
        for (var key in this.paymentPlanItems) {
            var ppi = this.paymentPlanItems[key];
            if(ppi.totalAmount) total += ppi.totalAmount;
        }
        var totalCell = this.projectorFooter.querySelector("td.TotalAmount span.Value");
        if(totalCell) totalCell.innerHTML = Util.toCurrency(total);
        this.totalAmount = total;
        this.subTotalByMonths[PaymentPlanItemGrid.TOTAL_AMOUNT] = total;
    }

    PaymentPlanItemGrid.prototype._buildGridStructure = function(){
        var existingRows = this.projectorItems.querySelectorAll("tr");
        var headerChanged = (this.totalVisibleColumns <= this.DEFAULT_HEADER_LENGTH && this.projectedColumns && this.projectedColumns.length == this.DEFAULT_HEADER_LENGTH);
        var rowSubTotalByItems = {};
        if(existingRows && existingRows.length > 0){
            for (var j = 0; j < existingRows.length; j++) {
                var r = existingRows[j];
                var key = r.getAttribute("ppi-key");
                if(!key) continue;
                var s = r.querySelector("td.SubTotalByItem");
                if(!s) continue;
                rowSubTotalByItems[key] = s;
            }
        }
        var endPos = this.subTotalByItemHead;
        var endFooterPos = this.totalAmountCell;
        var i = (this.firstVisibleHeaderKey? this.firstVisibleHeaderIndex : 0) + this.totalVisibleColumns;
        var headerCells = [];
        for(;i < this.projectedColumns.length; i++) {
            if (this.totalVisibleColumns >= PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS) break;
            var colKey = this.projectedColumns[i];
            if (!this.firstVisibleHeaderKey) {
                this.firstVisibleHeaderKey = colKey;
                this.firstVisibleHeaderIndex = this.projectedColumns.indexOf(colKey);
            }
            var cell = this._buildHeaderCell(colKey, this.totalVisibleColumns);
            var cellFooter = this._buildFooterCell(colKey, this.totalVisibleColumns);
            if (cell){
                Dom.insertBefore(cell, endPos);
                Dom.insertBefore(cellFooter, endFooterPos);
                this.totalVisibleColumns++;
                headerChanged = true;
            }
            for (var p in rowSubTotalByItems) {
                var c = this._buildEmptyFeeCell(p, colKey);
                if (c && rowSubTotalByItems[p]) Dom.insertBefore (c, rowSubTotalByItems[p]);
            }
            headerCells.push(cell);
        }

        return headerChanged;
    };

    PaymentPlanItemGrid.prototype._buildHeaderCell = function(key, pos){
        var c = this.headerCellContent[key];
        if (!c) return null;
        return Dom.newDOMElement({
                        _name: "th",
                        _html: this._buildHeaderCellHtml(c, key),
                        "projected-slot-key": key,
                        "col-pos": pos,
                        class: "ProjectedCol  Col" + pos});
    };

    PaymentPlanItemGrid.prototype._buildHeaderCellHtml = function(cellContent, key){
        var html = cellContent.desc? ("<div Class=\"Desc\">" + cellContent.desc + "</div>") : "";
        html = "<vbox><div class=\"Header\">" + cellContent.title +"</div>" + html + "</vbox>";
        if (key == PaymentPlanItemGrid.REGISTRATION && this.isDualFirstCol) {
            return "<hbox class=\"DualCol Wrapper\" title=\"" + PaymentPlanItemGrid.REGISTRATION_CLASS_START_DESC + "\"><vbox><div class=\"Header\">" + PaymentPlanItemGrid.REGISTRATION_CLASS_START +"</div></vbox></hbox>";
        }else if (key == PaymentPlanItemGrid.REGISTRATION){
            return "<hbox class=\"Wrapper\" title=\"" + cellContent.desc + "\"><vbox><div class=\"Header\">" + cellContent.title +"</div></vbox></hbox>";
        }
        return "<div class=\"Wrapper\">" + html +"</div>";
    };

    PaymentPlanItemGrid.prototype._buildFooterCell = function(key, pos){
        var val = 0;// this.subTotalByMonths[key];
        if(!val) val = 0;
        val = Util.toCurrency(val);
        return Dom.newDOMElement({
                        _name: "td",
                        _html: "<vbox><hbox><span class=\"Value\" flex=\"1\">" + val + "</span></hbox></vbox>",
                        "projected-slot-key": key,
                        "col-pos": pos,
                        class: "Fee  " + key + " Col" + pos});
    };

    PaymentPlanItemGrid.prototype._updatePaymentPlanItemRows = function(){
        this.projectorItems.innerHTML = "";
        this._reorderRows();
        for(var i =0; i < this.rowsOrder.length; i++) {
            var row = this._buildPaymentPlanItemRow(this.rowsOrder[i]);
            if (row) {
                this.projectorItems.appendChild(row);
            }
        }
        if (!this.rowsOrder.length && !this.readOnly) {
            var html = "<th class=\"ItemHeader\"><hbox></hbox></th>" +
                "<td class=\"NoItems ProjectedCell Fee\" colspan=\"" + (this.totalVisibleColumns + 0) + "\"><vbox><hbox><span class=\"Desc\" flex=\"1\">No payment plan item found</span></hbox></vbox></td>" +
                "<td class=\"SubTotalByItem\" projected-slot-key=\"SubTotalByItem\"><vbox><hbox><span class=\"Value\" flex=\"1\"></span></hbox></vbox></td>" +
                "<td class=\"Actions\" ></td>";

            var r = Dom.newDOMElement({
                            _name: "tr",
                            _html: html,
                            "ppi-key": PaymentPlanItemGrid.EMPTY_PAYMENT_PLAN,
                            class: "PlanItemFee"});
            this.projectorItems.appendChild(r);
        }
    }
    PaymentPlanItemGrid.prototype._getDueBy = function(chargeObj, chargeOverrideObj) {
        var dueBy = "";
        var dueTimeType = chargeObj.dueTimeType;
        if (chargeOverrideObj && chargeOverrideObj.overrideDueTimeType) {
            dueTimeType = chargeOverrideObj.overrideDueTimeType;
        }
        if (dueTimeType == ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT) {
            dueBy = "Billing Default"
        } else if (dueTimeType == ClassUtils.DUE_TIME_TYPE.CLASS_END) {
            dueBy = this.classEndDateFormat;
        } else if (chargeObj.dueDate){
            dueBy = FormatUtil.formatDateWithTZID(chargeObj.dueDate, "date_standard", this.classInfo.timezoneId)
        }
        dueBy = dueBy? ("Due By: " + dueBy): "";
        return dueBy;
    }
    PaymentPlanItemGrid.prototype._buildPaymentPlanItemRow = function(key){
        var ppi = this.paymentPlanItems[key];
        if(!ppi) return null;
        console.log("ppi", key, ppi);
        var projectedSlots = this.projectedSlots[key];
        if(!projectedSlots) return null;
        var actionHtml = "";
        var registrationFee = 0;
        var classStartFee = 0;
        var classStartHint = "";
        var subTotalByItem = 0;
        var rowClazz = "PlanItemFee ";
        var isSpecialRow = false;
        var isRecurring = ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING;
        var isInstallmentPlan = ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.INSTALLMENT_PLAN;
        var isManual = ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL;
        var isRatePlan = ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN;
        var isProcessingFee = ppi.key == PaymentPlanItemGrid.PROCESSING_FEE_KEY;
        if (!(this.isSpecialPaymentPlanItem(key))) {
            actionHtml += PaymentPlanItemGrid.ACTION_ICONS["edit"];
            actionHtml += PaymentPlanItemGrid.ACTION_ICONS["delete"];
            actionHtml = actionHtml.replace(/\@ppiKey/g, key);
            actionHtml = "<vbox><hbox>" + actionHtml + "</hbox></vbox>";
        } else {
            rowClazz = "ScpecialRow ";
            isSpecialRow = true;
        }
        rowClazz += key;
        var chargeOverrides = {};
        if (ppi.chargeOverrides && ppi.chargeOverrides.length) {
            for (var i = 0; i < ppi.chargeOverrides.length; i++) {
                chargeOverrides[ppi.chargeOverrides[i].targetOverrideKey] = ppi.chargeOverrides[i];
            }
        }

        var p = projectedSlots[PaymentPlanItemGrid.REGISTRATION];
        if (p && p.charges && p.charges.length > 0) {
            registrationFee = p.charges[0].amount? p.charges[0].amount : 0;
        }
        this._updateSubTotalByMonth(PaymentPlanItemGrid.REGISTRATION, key, registrationFee);

        p = projectedSlots[PaymentPlanItemGrid.CLASS_START];
        var classStartColKey = "";
        if (p && p.charges && p.charges.length > 0) {
            if(p.charges[0]){
                classStartColKey = moment.tz(p.charges[0].date, this.classInfo.timezoneId).format('YYYYMM');
                classStartFee = p.charges[0].amount? p.charges[0].amount : 0;
                classStartHint = "Class Start: " + FormatUtil.formatDateWithTZID(p.charges[0].date, "date_standard", this.classInfo.timezoneId);
                classStartHint += ". " + this._getDueBy(p.charges[0], chargeOverrides[p.charges[0].overrideKey]);
            }

        }

        var chargesHtml = "";
        var j = 0;
        var cellClazz =  (isSpecialRow? "" : "ProjectedCell ") + "Fee ";
        !isManual || (cellClazz = "Manual " + cellClazz);
        !isRatePlan || (cellClazz = "RatePlan " + cellClazz);
        !isRecurring || (cellClazz = "Recurring " + cellClazz);
        var addChargeHtml = ((!this.isSpecialPaymentPlanItem(key) && ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL && !this.readOnly)? "<div class=\"AddCharge\"><icon class=\"plus-circle\"></icon></div>" :"");
        var editableClazz = (this.readOnly || isRatePlan)? " " : " Editable ";
        var thiz = this;
        var buildCellCostStr = function(val, isSubTotalCell) {
            return isRatePlan && !thiz.isShowRatePlanCost? (isSubTotalCell? PaymentPlanItemGrid.RATE_PLAN_COST_ALTERNATIVE : "Hourly") : Util.toCurrency(val);
        }
        var validateCellCost = function (val) {
            return isRatePlan && !thiz.isShowRatePlanCost? PaymentPlanItemGrid.RATE_PLAN_NO_COST : val;
        }
        if (isProcessingFee && this.buildProcessingFeeRow) chargesHtml = this.buildProcessingFeeRow(key, colKey);
        for (i = 0; i < this.projectedColumns.length; i++) {
            if (isProcessingFee) break;
            if (j == this.totalVisibleColumns) break;
            var colClazz = "ChargeCell Col" + j + " ";
            var colKey = (j < PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS)? this.projectedColumns[j] : this.projectedColumns[this.firstVisibleHeaderIndex + j];
            if (colKey == PaymentPlanItemGrid.REGISTRATION) {
                colClazz += (this.isSpecialPaymentPlanItem(key)? "" : ((isRecurring || isInstallmentPlan)? "" : editableClazz)) + ((registrationFee > 0) || (classStartFee > 0)? "" : " Empty ");
                var colHtml = "";
                var innerSum = 0;
                if (registrationFee) {
                    var aFeeStr = buildCellCostStr(registrationFee);
                    colHtml += "<hbox class=\"Registration " + (this.isSpecialPaymentPlanItem(key)? "" : ((isRecurring || isInstallmentPlan)? "" : editableClazz))
                                    + "\" title=\"Due By: Registration\" projected-slot-key=\"Registration\"><span class=\"Value\" flex=\"1\">"
                                    + aFeeStr + "<span></hbox>";
                    var aFee = validateCellCost(registrationFee);
                    (aFee < 0) || (innerSum += aFee);
                    (aFee != PaymentPlanItemGrid.RATE_PLAN_NO_COST) || (innerSum = PaymentPlanItemGrid.RATE_PLAN_NO_COST);
                }
                if (classStartColKey && classStartFee && this.isDualFirstCol) {
                    var slot = projectedSlots[PaymentPlanItemGrid.CLASS_START];
                    var aFeeStr = buildCellCostStr(classStartFee);
                    colHtml += "<hbox class=\"ClassStart " + (this.isSpecialPaymentPlanItem(key)? "" : ((isRecurring || isInstallmentPlan)? "" : editableClazz)) + "\" projected-slot-key=\"ClassStart\" title=\""
                                    + classStartHint + "\"><span class=\"ChargeDate\">" + ClassUtils.getDaySuffix(slot.charges[0].date, this.classInfo.timezoneId)
                                    + "</span><span class=\"Value\" flex=\"1\">"
                                    + aFeeStr + "<span></hbox>";
                    var aFee = validateCellCost(classStartFee);
                    (aFee < 0) || (innerSum += aFee);
                    (aFee != PaymentPlanItemGrid.RATE_PLAN_NO_COST) || (innerSum = PaymentPlanItemGrid.RATE_PLAN_NO_COST);
                }
                if(!colHtml) {
                    !colHtml || (colHtml = "<vbox>" + colHtml + "</vbox>");
                    chargesHtml += "<td class=\"" + colClazz + (!(isRecurring || isInstallmentPlan)? cellClazz : " Fee ") + "\" projected-slot-key=\"Registration\" col-pos=\"0\" >" + addChargeHtml + "</td>";
                } else {
                    colHtml = "<vbox>" + colHtml + "</vbox>";
                    chargesHtml += "<td class=\"" + colClazz + (!(isRecurring || isInstallmentPlan)? cellClazz : " Fee ") + "\" col-pos=\"0\" >" + colHtml + "</td>";
                }

                j++;
                this._updateSubTotalByMonth(colKey, key, innerSum);
                continue;
            }
            var innerChargeHtml = "<td class=\"" + colClazz + cellClazz  + "\" col-pos=\"" + j + "\" projected-slot-key=\"" + colKey+ "\">" + addChargeHtml + "</td>";
            var innerSum = 0;
            var slot;
            if (colKey == classStartColKey && !this.isDualFirstCol) {
                var slot = projectedSlots[PaymentPlanItemGrid.CLASS_START];
                var aFeeStr = buildCellCostStr(classStartFee);
                var aFee = validateCellCost(classStartFee);
                (aFee < 0) || (innerSum += aFee);
                (aFee != PaymentPlanItemGrid.RATE_PLAN_NO_COST) || (innerSum = PaymentPlanItemGrid.RATE_PLAN_NO_COST);
                classStartHint = "Charged on a member's first class day.\n" + classStartHint;
                innerChargeHtml = "<hbox class=\"ClassStart " + ((isRecurring || isInstallmentPlan)? "" : editableClazz) + "\" projected-slot-key=\"ClassStart\" title=\""
                                        + classStartHint + "\"><span class=\"ChargeDate\">" + ClassUtils.getDaySuffix(slot.charges[0].date, this.classInfo.timezoneId) + "</span><span class=\"Value\" flex=\"1\">"
                                        + aFeeStr + "<span></hbox>";
                colClazz += (isManual? editableClazz : "");;
            } else {
                innerChargeHtml = "";
            }
            var slot = projectedSlots[colKey];
            if (slot && slot.charges && slot.charges.length > 0) {
                colClazz += editableClazz;
                slot.charges.sort(function(c1, c2){
                    return c1.date.getTime() - c2.date.getTime();
                });
                for(var k = 0; k < slot.charges.length; k++) {
                    var val = slot.charges[k].amount? slot.charges[k].amount : 0;

                    var aFee = validateCellCost(val);
                    (aFee < 0) || (innerSum += aFee);
                    (aFee != PaymentPlanItemGrid.RATE_PLAN_NO_COST) || (innerSum = PaymentPlanItemGrid.RATE_PLAN_NO_COST);

                    val = buildCellCostStr(val);
                    var aClaszz = "";
                    var dueBy = this._getDueBy(slot.charges[k], chargeOverrides[slot.charges[k].overrideKey]);
                    if(!(slot.charges[k].chargeOverrideId == undefined || slot.charges[k].chargeOverrideId == null) && !isManual ) aClaszz = " class=\"Overrided\" ";
                    innerChargeHtml += "<hbox " + aClaszz + "  title=\"" + dueBy + "\"><span class=\"ChargeDate\">" + ClassUtils.getDaySuffix(slot.charges[k].date, this.classInfo.timezoneId) + "</span><span class=\"Value\" flex=\"1\">" + val + "<span></hbox>";
                }
            }
            if (innerChargeHtml) {
                this._updateSubTotalByMonth(colKey, key, innerSum);
                innerChargeHtml = "<td class=\"" + colClazz + cellClazz  + "\" col-pos=\"" + j + "\"  projected-slot-key=\"" + colKey+ "\"><vbox>" + innerChargeHtml + "</vbox></td>";
                chargesHtml += innerChargeHtml;
            } else{
                colClazz = colClazz + " Empty " + (this.isSpecialPaymentPlanItem(key)? "" : (isManual? editableClazz : ""));
                chargesHtml += ("<td class=\"" + colClazz + cellClazz  + "\" col-pos=\"" + j + "\" projected-slot-key=\"" + colKey+ "\">" + addChargeHtml + "</td>");
            }
            j++;
        }
        subTotalByItem = ppi.totalAmount;
        var nameHtml = "<span flex=\"1\">" + ppi.name + "</span>";
        nameHtml += (ppi.discountable ? "<vbox class=\"DiscountIndicator\"><span>D</span></vbox>" : "");
        nameHtml += (ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING? "<vbox class=\"RecurringIndicator\"><icon class=\"autorenew\"></icon></vbox>" : "");
        var ratePlanDisableClass = (!this.isShowRatePlanCost && !this.assigningRatePlan)? "Disable" : "";
        nameHtml += (ppi.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN? "<vbox class=\"RatePlanIndicator " + ratePlanDisableClass + "\"><icon class=\"clock\"></icon></vbox>" : "");
        var subTotalStr = buildCellCostStr(subTotalByItem, true);
        var html ="<th class=\"ItemHeader\"><hbox>" + nameHtml + "</hbox></th>" +
            chargesHtml +
                    "<td class=\"SubTotalByItem\" projected-slot-key=\"SubTotalByItem\"><vbox><hbox><span class=\"Value\" flex=\"1\">" +
                    subTotalStr + "</span></hbox></vbox></td>" +
                    "<td class=\"Actions\" >" + actionHtml + "</td>";
        return Dom.newDOMElement({
                        _name: "tr",
                        _html: html,
                        "ppi-key": key,
                        class: rowClazz});
    };

    PaymentPlanItemGrid.prototype.isSpecialPaymentPlanItem = function(ppiKey) {
        return (ppiKey == PaymentPlanItemGrid.ANNUAL_REG_ACCOUNT || ppiKey == PaymentPlanItemGrid.ANNUAL_REG_STUDENT || ppiKey == PaymentPlanItemGrid.FAMILY_REG_FEE);
    }

    PaymentPlanItemGrid.prototype._buildEmptyFeeCell = function(ppiKey, colKey) {
        var cellClazz = (this.isSpecialPaymentPlanItem(ppiKey)? "" : "ProjectedCell ") + "Fee  ";
        return Dom.newDOMElement({
                        _name: "td",
                        _html: "",
                        "projected-slot-key": colKey,
                        class: "Empty  " + cellClazz + colKey});
    };

    PaymentPlanItemGrid.prototype._updateGrid = function(aKey, isSliding) {
        var updateRows = this._buildGridStructure();
        for(var i = 0; i < this.totalVisibleColumns; i++) {
            if (i < PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS) continue;
            var k = this.projectedColumns[this.firstVisibleHeaderIndex + i] + "";
            var head = this.projectorHeader.querySelector("th.ProjectedCol.Col" + i);
            var headKey = head.getAttribute("projected-slot-key");
            head.innerHTML = this._buildHeaderCellHtml(this.headerCellContent[k], k);
            if (headKey == k) continue;
            updateRows = true;
            head.setAttribute("projected-slot-key", k);
        }
        if (updateRows) {
            this._updatePaymentPlanItemRows();
        } else if (aKey) {
            var row = this._buildPaymentPlanItemRow(aKey);
            var currentRow = this.projectorItems.querySelector("tr[ppi-key=\"" + aKey + "\"]");
            if (row) {
                if(currentRow) {
                    currentRow.innerHTML = row.innerHTML;
                } else {
                    this.projectorItems.appendChild(row);
                }

            }
        }
        this._updateNavigator();
        this._updateSubTotalByMonths(!isSliding);
        if(!isSliding) this._gridChangeCallback();
    };

    PaymentPlanItemGrid.prototype._slideHeader = function (step) {
        if (this.firstVisibleHeaderIndex + step < 0) return;
        if (this.firstVisibleHeaderIndex + step + this.totalVisibleColumns > this.projectedColumns.length) return;
        this.firstVisibleHeaderIndex = this.firstVisibleHeaderIndex + step;
        this.firstVisibleHeaderKey = this.projectedColumns[this.firstVisibleHeaderIndex];
        this._updateGrid(null, true);

    }

    PaymentPlanItemGrid.prototype._updateNavigator = function() {
        if (this.projectedColumns.length > PaymentPlanItemGrid.MAX_PROJECTED_COLUMNS) {
            if (!Dom.hasClass(this.paymentPlanProjector, "MoreNext"))
            Dom.addClass(this.paymentPlanProjector, "MoreNext MorePrev");
        } else {
            Dom.removeClass(this.paymentPlanProjector, "MoreNext");
            Dom.removeClass(this.paymentPlanProjector, "MorePrev");
        }
        Dom.removeClass(this.paymentPlanProjector, "DisableNext");
        Dom.removeClass(this.paymentPlanProjector, "DisablePrev");
        if(this.firstVisibleHeaderIndex <= 0 && !Dom.hasClass(this.paymentPlanProjector, "DisablePrev")) Dom.addClass(this.paymentPlanProjector, "DisablePrev");
        if(((this.firstVisibleHeaderIndex + this.totalVisibleColumns) >= (this.projectedColumns.length)) && !Dom.hasClass(this.paymentPlanProjector, "DisableNext")) Dom.addClass(this.paymentPlanProjector, "DisableNext");
        if (!this.isClassAdmin) {
            this.subTotalByItemHead.setAttribute("width", "1%");
        }
        var totalColWidth = this.isClassAdmin? 60: 65;
        var cells = this.projectorHeader.querySelectorAll("th.ProjectedCol");
        for(var i = 0; i < cells.length; i++) {
            var c = cells[i];
            var a = c.getAttribute("projected-slot-key");
            if(a && a == PaymentPlanItemGrid.REGISTRATION) {
                this.maxHeaderHeight = c.offsetHeight;
            }
            c.setAttribute("width", (totalColWidth/this.totalVisibleColumns) + "%");
        }

    };

    PaymentPlanItemGrid.prototype._appendProjection = function(projectedPpi, forceUpdateGrid) {
        if ((!this.rowsOrder || !this.rowsOrder.length) && projectedPpi.paymentPlanItem.key != PaymentPlanItemGrid.EMPTY_PAYMENT_PLAN ) {
            this.projectorItems.innerHTML = "";
        }
        var isRatePlan = projectedPpi.paymentPlanItem.ratePlanId && projectedPpi.paymentPlanItem.ratePlanId > 0;
        this.isRatePlanIncluded = this.isRatePlanIncluded || isRatePlan;
            
        var projectionSlots = projectedPpi.projectionSlots;
        var projectionMap = {};
        var newHeaderCells = [];
        for (var i = 0; i < projectionSlots.length; i ++) {
            var s = projectionSlots[i];
            this._updateSubTotalByMonth(s.key, projectedPpi.paymentPlanItem.key, 0);
            if (!s.slotTimeType && this.projectedColumns.indexOf(s.key) == -1) {
                newHeaderCells.push(s.key);
                this.headerCellContent[s.key] = {title: s.title, desc1: s.subTitle};
            }
            if (s.slotTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
                projectionMap[PaymentPlanItemGrid.REGISTRATION] = s;
            } else if (s.slotTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
                projectionMap[PaymentPlanItemGrid.CLASS_START] = s;
                var headerCellContent = this.headerCellContent[PaymentPlanItemGrid.CLASS_START];
                if (headerCellContent) headerCellContent.desc = s.subTitle;
            } else {
                projectionMap[s.key] = s;
            }
        }
        if(projectedPpi.paymentPlanItem.chargeOverrides && projectedPpi.paymentPlanItem.chargeOverrides.length){
            this.chargeOverrides[projectedPpi.paymentPlanItem.key] = {}
            for (i = 0; i < projectedPpi.paymentPlanItem.chargeOverrides.length; i++) {
                var c = projectedPpi.paymentPlanItem.chargeOverrides[i];
                this.chargeOverrides[projectedPpi.paymentPlanItem.key][c.targetOverrideKey] = c;
            }
        }

        if (!this.projectedColumns || this.projectedColumns.length <= this.DEFAULT_HEADER_LENGTH) {
            this.projectedColumns  = [].concat(this.projectedColumns, newHeaderCells);
        } else if (newHeaderCells && newHeaderCells.length > 0){
            i = this.DEFAULT_HEADER_LENGTH; // from CLASS_START
            var specialHeaderCells = this.projectedColumns.slice(0, i);
            var normalHeaderCells = this.projectedColumns.slice(i);
            var newProjectedCells = [];
            for (var j = 0; j < newHeaderCells.length; j++) {
                newProjectedCells.push(parseInt(newHeaderCells[j]));
            }
            for (var j = 0; j < normalHeaderCells.length; j++) {
                newProjectedCells.push(parseInt(normalHeaderCells[j]));
            }
            newProjectedCells = newProjectedCells.sort(function (a, b) {
                return a - b;
            });
            newProjectedCells = [].concat(specialHeaderCells, newProjectedCells);
            this.projectedColumns = newProjectedCells;
        }
        if (projectedPpi.paymentPlanItem.key != PaymentPlanItemGrid.EMPTY_PAYMENT_PLAN) {
            this.paymentPlanItems[projectedPpi.paymentPlanItem.key] = projectedPpi.paymentPlanItem;
            this.projectedSlots[projectedPpi.paymentPlanItem.key] = projectionMap;
            if(this.rowsOrder.indexOf(projectedPpi.paymentPlanItem.key) == -1) {
                this.rowsOrder.push(projectedPpi.paymentPlanItem.key);
            }

            if (projectedPpi.projectedRatePlan) {
                this.paymentPlanItems[projectedPpi.paymentPlanItem.key]["projectedRatePlan"] = projectedPpi.projectedRatePlan;
            }
        }

        this.forceValidation = true;
        if (!this.isSpecialPaymentPlanItem(projectedPpi.paymentPlanItem.key) && projectedPpi.paymentPlanItem.key != PaymentPlanItemGrid.EMPTY_PAYMENT_PLAN) {
            this.isFirstItem = false;
        }
        if (this.isSpecialPaymentPlanItem(projectedPpi.paymentPlanItem.key)) {
            projectedPpi.paymentPlanItem.name += " <span class=\"IfApplicable\">(if applicable)</span>";
        }
        if (forceUpdateGrid) {
            this._updateGrid(projectedPpi.paymentPlanItem.key);
        }
        this._buildPaymentDescription(projectedPpi);
        
        
    }

    PaymentPlanItemGrid.prototype._gridChangeCallback = function (){
        if (typeof(this.gridChangeCallback) == "function") {
            this.gridChangeCallback(this.getPaymentPlanItems(), this.forceValidation, this.isFirstSetup);
            this.forceValidation = true;
        }
    }
    PaymentPlanItemGrid.prototype.getPaymentPlanItems = function (){
        var items = [];
        for (var i = 0; i < this.rowsOrder.length; i++){
            var item = this.paymentPlanItems[this.rowsOrder[i]];
            !item || items.push(item);
        }
        return items;
    }

    PaymentPlanItemGrid.prototype.viewRatePlan = function (ppi, target) {
        var projectedRatePlan = ppi.projectedRatePlan;
        this.minutePerWeek.innerHTML = projectedRatePlan.totalHoursProjectedClass + " minutes per week";
        this.totalHours.innerHTML = projectedRatePlan.totalHoursAllClasses + " minutes per week";
        this.ratePlanNameLabel.innerHTML = "Rate Plan " + projectedRatePlan.ratePlanName + ":";
        this.ratePlanFee.innerHTML = Util.toCurrency(projectedRatePlan.appliedRatePlanItemAmount) + "/month";
        this.ratePlanFeeHint.setAttribute("ratePlanFee", Util.toCurrency(projectedRatePlan.appliedRatePlanItemAmount));
        this.ratePlanPopup.show(target, "right", "bottom", -20, 5, true);

        this.workingPaymentPlanItem = ppi;
        this.workingRatePlanTarget = target;
    };

    PaymentPlanItemGrid.prototype.viewRateChart = function (ppi, target) {
        var ratePlanOptions = {
            ratePlanName: ppi.ratePlan.name,
            ratePlanItems: ppi.ratePlan.items
        };
        if (this.options && this.options.formWidget && this.options.formWidget == "PaymentPlanWidget") {
            ratePlanOptions.formWidget = "PaymentPlanWidget";
            this.rateChartContent.innerHTML = "";
            new __pkg.RateChartItemsTable(ratePlanOptions).into(this.rateChartContent);
            this.rateChartPopup.show(target, "right", "bottom", -20, 5, true);
        } else {
            new __pkg.ViewRateChartDialog().callback(function(data) {
            }).open(ratePlanOptions);
        }
    };

    PaymentPlanItemGrid.prototype.viewRateChartLinkClickedHandler = function () {
        if (!this.workingPaymentPlanItem) return;
        if (!this.workingRatePlanTarget) return;
        this.ratePlanPopup.hide();
        this.viewRateChart(this.workingPaymentPlanItem, this.workingRatePlanTarget);
    };

    PaymentPlanItemGrid.prototype.loadPaymentPlanItems = function (projectedInfo, processingFn) {
        $classAdminService.projectMultiItemsForRegistration(projectedInfo, processingFn, "Loading...");
    };


    return PaymentPlanItemGrid;
}();


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/PaymentPlanRegAssignmentWidget.js";

function PaymentPlanRegAssignmentWidget(options) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.options = options;
    this._enabled = false;
    this._savedStudents = [];
    this._assignedStudents = [];
    this.classId = options.classInfo.id;
    this.isInitializing = true;
    if (options.assignedStudents && options.assignedStudents.length) {
        this._savedStudents = options.assignedStudents.map(function(student) {
            student.saved = true;
            return student;
        });
        this.appendStudentsTag([]);
    }
    this.getPaymentPlanInfo = options.getPaymentPlanInfo;
    this.bind("click", this.assignStudent.bind(this), this.btnAssignStudent);
    this.bind("click", this.sendEmail.bind(this), this.linkSendMail);

    this.classReloadCallback = function() {
        console.log("ASSIGN STUDENT RELOAD CALLBACK", thiz.assignmentDialog);
        !thiz.assignmentDialog || thiz.assignmentDialog.close();
        Dom.emitEvent(ClassEditPaymentPlanTab.SAVE_GOTO_ASSIGN_STUDENT, thiz.node(), {fromClassTool: true, openedPaymentPlanKey: thiz.paymentPlanKey});
    }
}
__extend(BaseTemplatedWidget, PaymentPlanRegAssignmentWidget);

PaymentPlanRegAssignmentWidget.prototype.updateClassInfo = function(classInfo){
}

PaymentPlanRegAssignmentWidget.prototype.onAttached = function() {
    window.setTimeout(this.onAttachedDelayed.bind(this), 10);
};

PaymentPlanRegAssignmentWidget.prototype.onAttachedDelayed = function() {
    //this.requestPaymentPlanList();
    if (ClassAuthUtils.canChangeSlotPaymentPlanStartDropDate()) {
        Dom.show(this.btnAssignStudent);
    } else {
        Dom.hide(this.btnAssignStudent);
    }
};

PaymentPlanRegAssignmentWidget.prototype._setEnabled = function(enabled) {
    this._enabled = enabled;
    Dom.setEnabled(enabled, this.btnAssignStudent);
    Dom.toggleClass(this.node(), "Disabled", !enabled);
};

PaymentPlanRegAssignmentWidget.prototype.enable = function() {
    this._setEnabled(true);
};

PaymentPlanRegAssignmentWidget.prototype.disable = function() {
    this._setEnabled(false);
};

PaymentPlanRegAssignmentWidget.prototype.assignStudent = function() {
    var paymentPlan = this.getPaymentPlanInfo();
    console.log("assignStudent", paymentPlan, paymentPlan.isClassChanging);
    var thiz = this;
    thiz.paymentPlanKey = paymentPlan.key;
    if (paymentPlan && paymentPlan.isClassChanging) {
        Dialog.confirm("This class is being changed and hasn't been saved yet. Please save before assigning student", "",
            "Save and Go to Assign student", function() {
                Dom.emitEvent(ClassEditPaymentPlanTab.SAVE_GOTO_ASSIGN_STUDENT, thiz.node(), {openedPaymentPlanKey: thiz.paymentPlanKey});
            },
            "Cancel", function() {});
    } else {
        this._openAssignDialog(paymentPlan);
    }
};
PaymentPlanRegAssignmentWidget.prototype.openAssignDialog = function(paymentPlan) {
    var paymentPlan = this.getPaymentPlanInfo();
    this._openAssignDialog(paymentPlan);
};
PaymentPlanRegAssignmentWidget.prototype._openAssignDialog = function(paymentPlan) {
    var paymentPlanName = paymentPlan ? paymentPlan.name: "";
    this.assignmentDialog = new __pkg.PaymentPlanAddStudentDialog()
        .callback(this.assignNewStudents.bind(this));
    this.assignmentDialog.open({classInfo: this.options.classInfo,
            paymentPlanId: paymentPlan.id,
            paymentPlanName: paymentPlanName,
            assignedStudents: this._assignedStudents,
            classReloadCallback: this.classReloadCallback});
}

PaymentPlanRegAssignmentWidget.prototype.assignNewStudents = function (students) {
    var thiz = this;
    if (!students) return;
    console.log("ASSIGNED NEW STUDENT", students);
    var paymentPlan = this.getPaymentPlanInfo();
    if (!paymentPlan) return;
    var paymentPlanId = paymentPlan.id;
    if (!paymentPlanId) {
        Dialog.error("Invalid payment plan");
        return;
    }
    window.defaultIndicator.busy("Loading...");
    students.forEach(function(student) {
        student.paymentPlanId = paymentPlanId;
    });
    $classAdminService.saveAssignedStudents(students, false, function(res) {
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    }, function(err) {
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
    });

}
PaymentPlanRegAssignmentWidget.prototype.appendStudentsTag = function(data) {
    var thiz = this;
    if (!data) return;
    console.log("ASSIGNED STUDENT", data);
    Dom.doOnSelector(this.btnAssignStudent.parentNode, ".Student", function(childNode) {
        if (Dom.hasClass(childNode, "Student")) {
            childNode.remove();
        }
    });
    this._assignedStudents = this._savedStudents.concat(data);
    this._assignedStudents.forEach(function(student) {
        var studentTag = Dom.newDOMElement({
                _name: "span",
                _text: student.firstName + " " + student.lastName + " (#" + (student.slot + 1) + ")",
                class: "Student"
            });
        Dom.insertBefore(studentTag, thiz.btnAssignStudent);
        thiz.bind("click", function() {
            thiz.showStudentPaymentPlanProjection(student.id);
        }, studentTag);
    });
    // CommonEvent.fireEvent(ClassEditDialog.MODULE_CLASSMGMT, ClassEditPaymentPlanTab.CPP_ASSIGNED_STUDENT_CHANGE, {assignedStudents: thiz._assignedStudents, isInitializing: thiz.isInitializing});
    thiz.isInitializing = false;
    thiz.totalStudents.innerText = thiz._assignedStudents.length;
    Dom.toggleClass(thiz.linkSendMail, "Hidden", (thiz._assignedStudents.length == 0) || !ClassAuthUtils.canEmailSMSPushAccountMember());
    thiz.updateRevenueLabel();
};

PaymentPlanRegAssignmentWidget.prototype.showStudentPaymentPlanProjection = function(data) {
    var thiz = this;
    new __pkg.StudentProjectionDialog().callback(function(isDataModified) {
        // if (isDataModified) thiz.classReloadCallback();
    }).open(data);
};

PaymentPlanRegAssignmentWidget.prototype.prepareRecipients = function(studentIds, callback) {
    console.log("# PaymentPlanRegAssignmentWidget - sendEmail");
    var thiz = this;
    var recipients = [];
    window.defaultIndicator.busy("Prepare recipients...");
    $classAdminService.getPaymentPlanAssignedRelatedRecipients(studentIds, function(data) {
        window.defaultIndicator.done();
        callback(data);
    }, function(error) {
        window.defaultIndicator.done();
    });
};

PaymentPlanRegAssignmentWidget.prototype.sendEmail = function() {
    var thiz =  this;
    if (!this._assignedStudents.length) {
        Dialog.alert("Assigned List is empty", "Please assign student and try again.");
        return;
    }
    var studentIds = this._assignedStudents.map(function(student) {
        return student.id;
    });
    this.prepareRecipients(studentIds, function(recipientInfos) {
        console.log("# prepare send email to:", recipientInfos);
        if (!recipientInfos || recipientInfos.length == 0) {
            Dialog.alert("No email sended.", "Recipient list is empty");
            return;
        }
        new __pkg.ComposeEmailDialog({send: thiz._sendEmail.bind(thiz)})
            .callback(function(data) {
                console.log("Message:", data);
            }).open({
                title: "Payment Plan Email",
                ccingTitle: "[CC Title]",
                contextTitle: "recipient",
                recipients: recipientInfos
            });
    });
};

PaymentPlanRegAssignmentWidget.prototype._sendEmail = function(msg, attachments, callback) {
    var thiz = this;
    window.defaultIndicator.busy("Sending...");
    $classAdminService.sendPaymentPlanAssignedStudentEmail(msg.recipients, msg.subject, msg.message, attachments, thiz.getPaymentPlanInfo(),
        function(result) {
            window.defaultIndicator.done();
            SnackBar.show("Email message sent.");
            if (callback) callback();
        }, function(e) {
            window.defaultIndicator.done();
            Dialog.error("Send email failed.");
            if (callback) callback();
        });
};

PaymentPlanRegAssignmentWidget.prototype.getAssignedStudents = function() {
    return this._assignedStudents;
};

PaymentPlanRegAssignmentWidget.prototype.setRevenue = function(value) {
    this.revenue = value;
    this.updateRevenueLabel();
};

PaymentPlanRegAssignmentWidget.prototype.updateRevenueLabel = function() {
    var value = this.revenue || 0;
    value *= this.getAssignedStudents().length;
    this.totalRevenue.innerText = Util.toCurrency(value);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/PaymentPlanSelectorDialog.js";

function PaymentPlanSelectorDialog() {
    Dialog.call(this);
    this.grabHeight = true;
    this.title = "Copy Payment Plans";
    var thiz = this;
    this.lessonClasses = {};
    this.bind("input", function() {
        if (thiz.filterTimeout) window.clearTimeout(thiz.filterTimeout);
        thiz.filterTimeout = window.setTimeout(thiz.requestData.bind(thiz), 350);
    }, this.itemKeyword);
    this.selectLessonClass.getConfigs = function() {
        return {
            mode: SelectBox.MODE_DROPDOWN,
            multipleSelect: true,
            useExplicitSelectLinks: true,
            noneSelectionText: "All Classes"
        };
    };
    this.selectLessonClass.parseData = function(data) {
        return {
            value: data.id,
            text: data.title
        };
    };
    this.selectLessonClass.setup();
    this.bind("p:SelectionChanged", function(event) {
        if (thiz.filterTimeout) window.clearTimeout(thiz.filterTimeout);
        thiz.filterTimeout = window.setTimeout(thiz.requestData.bind(thiz), 550);
    }, this.selectLessonClass);
    this.bind("p:PopupHidden", function () {
         if (thiz._lastFocusedPaymentPlanLink) Dom.removeClass(thiz._lastFocusedPaymentPlanLink, "Focused");
    }, this.paymentPlanPopup);
}
__extend(Dialog, PaymentPlanSelectorDialog);

PaymentPlanSelectorDialog.prototype.setup = function(classInfo) {
    this.classInfo = classInfo;
    this.labelClassName.innerText = classInfo.title;
    var thiz = this;
    $classAdminService.filterClassWithPaymentPlan([this.classInfo.id],
        function(data) {
            thiz.classFilterList = data.result;
            thiz.selectLessonClass.setItems(data.result);
            thiz.setupDataTable();
        },
        function(error) {
            console.error("Fail to init filter");
        });
};

PaymentPlanSelectorDialog.prototype.setupDataTable = function() {
    var thiz = this;
    var colPlanName = new DataTable.GenericColumn("Payment Plan Name", function (data) {
        return data.name;
    }).sortable("name").width("1*", "10em");
    this.dataTable.column(colPlanName);
    var colClassName = new DataTable.PlainTextColumn("Class", function (data) {
        return data.classTitle;
    }).width("1*", "10em");
    this.dataTable.column(colClassName);
    var colAction = new DataTable.GenericDomColumn("Preview", function (data) {
        return {
            _name: "span",
            class: "InfoLink",
            _children: [
                {_name: "icon", class: "information"}
            ]
        };
    }).width("8em");
    this.dataTable.column(colAction);
    this.dataTable.selector(true, false);
    this.dataTable.currentOrder = {propertyName: "name", asc: true};
    this.dataTable.setDefaultSelectionHandler({
        run: function (data, event) {
            var link = Dom.findParentWithClass(event.target, "InfoLink");
            if (!link) return;
            if (thiz._lastFocusedPaymentPlanLink) Dom.removeClass(thiz._lastFocusedPaymentPlanLink, "Focused");
            thiz._lastFocusedPaymentPlanLink = link;
            Dom.addClass(link, "Focused");
            thiz.showPaymentPlanDetail(event.target, data);
        }
    });
    this.dataTable.useFloatingHeader = true;
    this.dataTable.addListener({onSelectionChanged: thiz.invalidateElements.bind(thiz)});
    this.dataTable.addOrderRequestListener({
        changeOrder: function(order) {
            thiz.dataTable.setOrder(order);
            thiz.requestData();
        }});
        
    this.dataTable.disabledCheckBoxWhenCheckAll(false);
    this.dataTable.setup();
    this.requestData();
};

PaymentPlanSelectorDialog.prototype.requestData = function() {
    var keyword = this.itemKeyword.value;
    var selectedClasses = this.selectLessonClass.getSelectedData();
    if (!selectedClasses.length) selectedClasses = this.classFilterList;
    var classIds = selectedClasses.map(function(classInfo) {
        return classInfo.id;
    });
    var thiz = this;
    var order = this.dataTable.getOrder();
    $classAdminService.filterPaymentPlans(this.classInfo.id, classIds, keyword, {name: order.propertyName, asc: order.asc, ignoreCase: true},
        function(plans) {
            if (!plans.length) SnackBar.show("No Payment Plan found!");
            thiz.dataTable.setItems(plans);
        },
        function(error) {
            console.error("fail to get PaymentPlan list with error:", (error && error.message ? error.message : error));
        });
};

PaymentPlanSelectorDialog.prototype.getClassDetail = function(classId) {
    var thiz = this;
    return new Promise(function(resolve, reject) {
        if (thiz.lessonClasses[classId]) {
            resolve(thiz.lessonClasses[classId]);
            return;
        }
        window.defaultIndicator.busy("Loading...");
        $classAdminService.getClassDetailById(classId, function(classInfo) {
            window.defaultIndicator.done();
            thiz.lessonClasses[classId] = classInfo;
            resolve(classInfo);
        }, function(error) {
            window.defaultIndicator.done();
            console.log("Fail to get ClassDetail with id:", classId);
            reject(error);
        });
    });
};

PaymentPlanSelectorDialog.prototype.showPaymentPlanDetail = function(target, data) {
    var thiz = this;
    this.getClassDetail(data.lessonClassId).then(function(classInfo) {
        var gridData = {
            classInfo: classInfo,
            items: [],//paymentPlan.items,
            selectedSlot: data.slot,
            paymentPlanId: data.id,
            startProjectedDate: data.dt_created,
            filters: {},
            callback: null,
            readOnly: true,
            assigningRatePlan: true,
            isClassAdmin: (window.LOGIN_INFO && ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO))
        };
        classInfo.paymentPlans.forEach(function(pp) {
            if (pp.id == data.id) {
                gridData.items = pp.items;
            }
        });
        thiz.paymentPlanPopup.popupContainer.innerHTML = "";

        gridData.finishLoadingCallback = function () {
            thiz.paymentPlanPopup.show(target, "left-inside", "top", 0, 5, true);
        };
        thiz.paymentPlanItemGrid = new __pkg.PaymentPlanItemGrid(gridData).into(thiz.paymentPlanPopup.popupContainer);
    });
};

PaymentPlanSelectorDialog.prototype.fillPaymentPlans = function(paymentPlans) {
    return new Promise(function(resolve, reject) {
        $classAdminService.fillPaymentPlans(paymentPlans,
            function(plans) {
                resolve(plans);
            },
            function(error) {
                reject(error);
            });
    });
}

PaymentPlanSelectorDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var selectedPlans = this.dataTable.getSelectedItems();
    return [
        {
            type: "accept", title: "Copy Selected" + (selectedPlans.length ? "(" + selectedPlans.length + ")" : ""),
            isCloseHandler: true,
            isEnabled: function() {return selectedPlans.length > 0;},
            run: function () {
                thiz.fillPaymentPlans(selectedPlans).then(function(plans) {
                    var copyPlans = plans.map(function(plan) {
                        console.log("CLONE Plan:", plan.name, plan.items.length);
                        plan.id = 0;
                        plan.key = Util.newUUID();
                        plan.assignedStudents = [];
                        plan.defaultInRegistration = false;
                        plan.items.forEach(function(item) {
                            item.id = 0;
                        });
                        return plan;
                    });
                    thiz.close(copyPlans);
                });
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.close(false);
            }
        }
    ];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/PaymentPlanWidget.js";

function PaymentPlanWidget(options) {
    BaseTemplatedWidget.call(this);
    this.classId = 0;
    this.classInfo = {};
    this.filters = {};
    this.paymentPlan = {};
    this.selectedSlot = 0;
    if (options) {
        this.classId = options.classId;
        this.classInfo = options.classInfo;
        this.filters = options.filters;
        this.paymentPlan = options.paymentPlan? options.paymentPlan : {};
        this.selectedSlot = options.selectedSlot? options.selectedSlot : this.selectedSlot;
        this.validateChange = typeof(options.validateChangeCallback) == "function"? options.validateChangeCallback : function(){};
    }
    var thiz = this;
    this.didSetup = false;
    this.bind("click", this.addPaymentPlanItemHandler, this.btnAddPaymentPlanItem);

    this.bind("click", this.clonePlanHandler, this.btnClonePlan);
    this.bind("click", this.deletePlanHandler, this.btnDelete);
    this.bind("click", this.discardChangeHandler, this.btnDiscardChange);
    thiz.gridChangeCallback = function(paymentPlanItems, forceValidation, isFirstSetup) {
        if (thiz.paymentPlanName.value) {
            thiz.paymentPlanAssignment.enable();
            if ( paymentPlanItems && paymentPlanItems.length > 0) thiz.classSlotSelector.removeAttribute("disabled");
        } else {
            thiz.paymentPlanAssignment.disable();
            thiz.classSlotSelector.setAttribute("disabled", true);
        }
        var paymentPlan = thiz.getPaymentPlan();
        if (paymentPlan && paymentPlan.id && isFirstSetup) return;
        Dom.emitEvent(ClassEditPaymentPlanTab.CPP_SAVE_PLAN, thiz.node(), {paymentPlan: paymentPlan, isEditing: true, isFirstSetup: isFirstSetup});

        if(forceValidation){
            if(!ValidationManager.run(thiz.validationRules)) return;
        }
        Dom.hasClass(thiz.btnDiscardChange, "Hidden") || Dom.addClass(thiz.btnDiscardChange, "Hidden");
        Dom.removeClass(thiz.btnDelete, "Hidden");


    };

    thiz.getPaymentPlan = function() {
        var p = (thiz.paymentPlan && (thiz.paymentPlan.id || thiz.paymentPlan.key))? thiz.paymentPlan : {};
        p.name = thiz.paymentPlanName.value;
        p.visibleInRegistration = thiz.allowDisplayAtRegistration.checked;
        if (window.LOGIN_INFO.allowWaiver) {
            p.defaultInRegistration = thiz.defaultInRegistration.checked;
        }
        p.items = thiz.paymentPlanItemGrid.getPaymentPlanItems();
        p.assignedStudents = thiz.paymentPlanAssignment.getAssignedStudents();
        p.totalAmount = thiz.paymentPlanItemGrid.totalAmount;
        if(!p.key) p.key = Util.newUUID();
        p.isClassChanging = thiz.validateChange();
        thiz.paymentPlan = p;
        return p;
    }

    thiz.classSlotSelector.renderer = function(item, selected) {
        return "Viewing reg slot <strong>#" + item.slotOrder + "</strong>";
    };
    thiz.classSlotSelector.useHtml = true;

    var enterNameTimer;
    var f = function() {
        enterNameTimer = null;
        if(!ValidationManager.run(thiz.validationRules)) {
            thiz.paymentPlanAssignment.disable();
            return;
        }
        Dom.hasClass(thiz.btnDiscardChange, "Hidden") || Dom.addClass(thiz.btnDiscardChange, "Hidden");
        Dom.removeClass(thiz.btnDelete, "Hidden");
        thiz.classSlotSelector.removeAttribute("disabled");
        thiz.paymentPlanAssignment.enable();
        Dom.emitEvent(ClassEditPaymentPlanTab.CPP_SAVE_PLAN, thiz.node(), {paymentPlan: thiz.getPaymentPlan(), isEditing: true});
    }

    this.bind("p:ItemSelected", this.classSlotChangeHandler, this.classSlotSelector.node());
    this.bind("change", function () {
        f();
        if (!thiz.allowDisplayAtRegistration.checked && thiz.defaultInRegistration.checked) thiz.defaultInRegistration.checked = false;
        Dom.emitEvent(ClassEditPaymentPlanTab.CPP_CHANGE_REGISTRATION_DEFAULT, thiz.node(), {paymentPlan: thiz.getPaymentPlan(), isEditing: true});
    }, this.allowDisplayAtRegistration);
    this.bind("change", function () {
        f();
        if (thiz.defaultInRegistration.checked) thiz.allowDisplayAtRegistration.checked = true;
        Dom.emitEvent(ClassEditPaymentPlanTab.CPP_CHANGE_REGISTRATION_DEFAULT, thiz.node(), {paymentPlan: thiz.getPaymentPlan(), isEditing: true});
    }, this.defaultInRegistration);

    this.bind(ClassEditPaymentPlanTab.CPP_PAYMENT_PLAN_CHANGE, function (event) {
        Dom.emitEvent(ClassEditPaymentPlanTab.CPP_SAVE_PLAN, thiz.node(), {paymentPlan: thiz.getPaymentPlan(), isEditing: true});
    });

    this.bind(ClassEditPaymentPlanTab.CPP_REVENUE_CHANGE, function (event) {
        var amount = 0;
        if(event.totalAmount) amount = event.totalAmount;
        thiz.paymentPlanAssignment.setRevenue(amount);
    });

    this.validationRules = new RuleSet()
        .live(true)
        .required(this.paymentPlanName, "Please input Payment Plan name");

    if ((!this.classInfo.paymentPlans || !this.classInfo.paymentPlans.length) && !Dom.hasClass(this.btnDelete, "Hidden")) {
        Dom.addClass(this.btnDelete, "Hidden");
    }

    if ((this.classInfo.paymentPlans && this.classInfo.paymentPlans.length)) {
        Dom.addClass(this.btnDiscardChange, "Hidden");
    }

    if (this.classInfo.paymentPlans && this.paymentPlan && this.paymentPlan.id > 0 && this.paymentPlan.assignedStudents && this.paymentPlan.assignedStudents.length) {
        this.btnDelete.setAttribute("disabled", true);
    }


    this.bind("keydown", function(){
        if(enterNameTimer) {
            return;
        }
        enterNameTimer = setTimeout(function() {
            f();
        }, 300);

    }, this.paymentPlanName);

    thiz.classSlotSelector.setAttribute("disabled", true);
}

__extend(BaseTemplatedWidget, PaymentPlanWidget);

PaymentPlanWidget.prototype.onAttached = function() {
    window.setTimeout(this.onAttachedDelayed.bind(this), 10);
};

PaymentPlanWidget.prototype.onAttachedDelayed = function() {

};
PaymentPlanWidget.prototype.openAssignDialog = function(options) {
    if (options && this.paymentPlan && this.paymentPlan.key && options.openedPaymentPlanKey && (this.paymentPlan.key == options.openedPaymentPlanKey)) {
        this.paymentPlanAssignment.openAssignDialog();
    } else {
        Dialog.error("Invalid payment plan (key: " + options.openedPaymentPlanKey + ")");
    }
};
PaymentPlanWidget.prototype.setup = function(options) {
    if (this.didSetup) return;
    this.didSetup = true;
    var thiz = this;
    var gridData = {
        classInfo: this.classInfo,
        filters: this.filters,
        gridChangeCallback: this.gridChangeCallback,
        finishLoadingCallback: function() {
            console.log("Finish loading");
        },
        paymentPlanId: 0,
        isClassAdmin: true,
        isDualFirstCol: true,
        assigningRatePlan: true
    };
    var assignedData = {
        classId: this.classId,
        classInfo: this.classInfo,
        getPaymentPlanInfo: this.getPaymentPlan
    };

    if((this.paymentPlan && (this.paymentPlan.id || this.paymentPlan.key))) {
        this.paymentPlanName.value = this.paymentPlan.name;
        this.allowDisplayAtRegistration.checked = this.paymentPlan.visibleInRegistration;
        this.defaultInRegistration.checked = this.paymentPlan.defaultInRegistration;
        gridData.paymentPlanId = this.paymentPlan.id;
        gridData["items"] = this.paymentPlan.items;
        assignedData["assignedStudents"] = this.paymentPlan.assignedStudents;

        Dom.removeClass(this.paymentPlanDetailPane, "Creating");
        Dom.addClass(this.paymentPlanDetailPane, "Editing");
        if(this.paymentPlan.assignedStudents && this.paymentPlan.assignedStudents.length > 0) {
            this.btnDelete.setAttribute("disabled", true);
        } else {
            this.btnDelete.removeAttribute("disabled");
        }
    }

    var minDate = this.classInfo.dateStart;
    if (this.classInfo.date4Register.getTime() < this.classInfo.dateStart.getTime()) {
        minDate = this.classInfo.date4Register;
    }

    gridData.registrationProjectedDate = gridData.startProjectedDate || minDate;

    var slots = this.classInfo.slots? this.classInfo.slots : [];
    this.classSlotSelector.setItems(this.classInfo.slots? this.classInfo.slots : []);
    this.selectedSlot = this.selectedSlot? this.selectedSlot : (slots[0].slot);
    gridData.selectedSlot = this.selectedSlot;
    gridData.formWidget = "PaymentPlanWidget";
    this.paymentPlanItemGrid = new __pkg.PaymentPlanItemGrid(gridData).into(this.paymentPlanItemsContainer);
    this.paymentPlanAssignment = new __pkg.PaymentPlanRegAssignmentWidget(assignedData).into(this.studentAssignmentContainer);
    if (options && options.openAssign && options.activePaymentPlanKey && options.activePaymentPlanKey == this.paymentPlan.key) {
        options.openAssign = false;
        setTimeout(function(){
            thiz.paymentPlanAssignment.openAssignDialog();
        }, 300);
    }

    var startDate = FormatUtil.formatDateWithTZID(this.classInfo.dateStart, "date_standard", this.classInfo.timezoneId);
    var endDate = FormatUtil.formatDateWithTZID(this.classInfo.dateEnd, "date_standard", this.classInfo.timezoneId);
    this.classDates.innerHTML = startDate + " - " + endDate;
    if (!!!this.paymentPlan.id) {
        this.allowDisplayAtRegistration.checked = this.paymentPlan.visibleInRegistration;
        this.defaultInRegistration.checked = this.paymentPlan.defaultInRegistration;
    }
    if (!window.LOGIN_INFO.allowWaiver) {
        Dom.hide(this.defaultInRegistration.parentNode);
    }
}
PaymentPlanWidget.prototype.updateClassInfo = function(classInfo){
    this.classInfo = classInfo;
    !this.paymentPlanItemGrid || this.paymentPlanItemGrid.updateClassInfo(classInfo);
    !this.paymentPlanAssignment || this.paymentPlanAssignment.updateClassInfo(classInfo);
}
PaymentPlanWidget.prototype.validate = function() {
    if(!ValidationManager.run(this.validationRules)) return false;
    return true;
}

PaymentPlanWidget.prototype.classSlotChangeHandler = function() {
    if(!this.paymentPlanItemGrid) return;
    this.selectedSlot = this.classSlotSelector.getSelectedItem()? this.classSlotSelector.getSelectedItem().slot : this.classInfo.slots[0].slot;
    this.paymentPlanItemGrid.reloadProjector(this.selectedSlot);
}

PaymentPlanWidget.prototype.addPaymentPlanItemHandler = function () {
    this.paymentPlanItemGrid.createPaymentPlanItem();
};


PaymentPlanWidget.prototype.clonePlanHandler = function () {
    var thiz = this;
    var p = Util.clone(this.getPaymentPlan());
    p.id = 0;
    p.key = Util.newUUID();
    p.name = "[CLONE] " + p.name;
    p.defaultInRegistration = false;
    p.assignedStudents = [];
    for(var i = 0; i < p.items.length; i++) {
        var item = p.items[i];
        item.id = 0;
        if(!thiz.paymentPlanItemGrid.isSpecialPaymentPlanItem(item.key)) item.key = Util.newUUID();
        item.paymentPlanId = 0;
    }
    Dom.removeClass(thiz.paymentPlanDetailPane, "Creating");
    if(!Dom.hasClass(thiz.paymentPlanDetailPane, "Editing")) Dom.removeClass(thiz.paymentPlanDetailPane, "Editing");
    Dom.emitEvent(ClassEditPaymentPlanTab.CPP_SAVE_PLAN, this.node(), {paymentPlan: p});
};


PaymentPlanWidget.prototype.savePlanHandler = function () {
    if(!ValidationManager.run(this.validationRules)) return;
    //this._updatePaymentPlanRevenue();

};

PaymentPlanWidget.prototype._updatePaymentPlanRevenue = function () {
    var thiz = this;
    var p = this.getPaymentPlan();
/*
    $classAdminService.getTotalAmountPerSlots(thiz.classInfo, p.items, function(data) {
        var revenue = 0;
        for (var i = 0; i < p.assignedStudents.length; i++) {
            var student = p.assignedStudents[i];
            var amount = data[student.slot];
            student.paymentPlanTotalAmount = amount? amount : 0;
            revenue += student.paymentPlanTotalAmount;
        }

        Dom.removeClass(thiz.paymentPlanDetailPane, "Creating");
        if(!Dom.hasClass(thiz.paymentPlanDetailPane, "Editing")) Dom.removeClass(thiz.paymentPlanDetailPane, "Editing");
        p.revenue = revenue;
        Dom.emitEvent(ClassEditPaymentPlanTab.CPP_SAVE_PLAN, thiz.node(), {paymentPlan: p});

    }, function(error) {
    });
*/
};

PaymentPlanWidget.prototype.discardChangeHandler = function () {
    Dom.emitEvent(ClassEditPaymentPlanTab.CPP_DELETE_PLAN, this.node(), {paymentPlan: this.paymentPlan});
};

PaymentPlanWidget.prototype.deletePlanHandler = function () {
    var thiz = this;
    Dialog.confirmDangerousAction("Are you sure you want to delete this Payment Plan?", "",
        "Delete", function() {
            Dom.emitEvent(ClassEditPaymentPlanTab.CPP_DELETE_PLAN, thiz.node(), {paymentPlan: thiz.getPaymentPlan()});
        },
        "Cancel", function() {});
};

PaymentPlanWidget.prototype.updateProjectorHandler = function(){
    if (this.paymentPlanItemGrid) {
        this.paymentPlanItemGrid.reloadProjector(this.selectedSlot);
    }
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/PaymentPlansAdminWidget.js";

function PaymentPlansAdminWidget(n) {
    BaseTemplatedWidget.call(this);
    
    this.bind("click", this.dataTableClickedHandler, this.dataView);
    this.bind("p:PageLoaded", this._handleDataViewLoaded.bind(this), this.dataView);
    
    this.initDataView();
}
__extend(BaseTemplatedWidget, PaymentPlansAdminWidget);

PaymentPlansAdminWidget.prototype.onAttached = function (isFirst) {
    if (!isFirst) return;
};

PaymentPlansAdminWidget.prototype._handleDataViewLoaded = function () {
    this.totalItem.innerHTML = this.dataView.getDiscoveredTotalItems();
};


PaymentPlansAdminWidget.prototype.initDataView = function () {
    var actions = [{
        title: "Edit Plan(s)",
        run: function (items) {
            
        },
        applicable: function (count, dataView) {
            return count > 0;
        }
    }, {
        title: "Delete",
        run: function (items) {
            
        },
        applicable: function (count, dataView) {
            return count > 0;
        }
    }];
    this.dataView.registerActions(actions, "Edit");
    
    this.dataView.registerCustomRenderer("name", function (data, value) {
        value = "General Payment Plan";
        return {
            _name: "div",
            _html: value,
            title: value
        }
    });
    
    this.dataView.registerCustomRenderer("amount", function (data, value) {
        value = 530;
        return {
            _name: "div",
            _html: Util.toCurrency(value),
            title: Util.toCurrency(value)
        }
    });
    
    this.dataView.registerCustomRenderer("useCount", function (data, value) {
        value = 5;
        return {
            _name: "hbox",
            "class": "UseCountWrapper",
            _children: [{
                _name: "div",
                "class": "UseCountContent",
                _children: [{
                    _name: "span",
                    _html: value,
                    title: value
                }, {
                    _name: "icon",
                    "class": "arrow-down-drop-circle"
                }]
            }]
        }
    });
    
    this.dataView.registerCustomRenderer("updatedBy", function (data, value) {
        value = "Tom Fristoe";
        return {
            _name: "div",
            _html: value,
            title: value
        }
    });
    
    this.dataView.registerCustomRenderer("lastUpdated", function (data, value) {
        value = new Date();
        return {
            _name: "div",
            _html: FormatUtil.formatDate(value, "datetime_standard", "local"),
            title: FormatUtil.formatDate(value, "datetime_standard", "local")
        }
    });
    
};

PaymentPlansAdminWidget.prototype.dataTableClickedHandler = function (event) {
    if (Dom.hasClass(event.target, "UseCountContent")
        || Dom.hasClass(event.target.parentNode, "UseCountContent")
        || Dom.hasClass(event.target.parentNode.parentNode, "UseCountContent")) {
            
    }
};



if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/ProjectionChargeEditItemWidget.js";

function ProjectionChargeEditItemWidget(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
    var comboRenderer = function (data, selected) {
        if (!data) return "";
        return data.name;
    }
    
    this.rChargeAt.renderer = comboRenderer;
    this.rDueBy.renderer = comboRenderer;

    this.nrChargeTimeType = [{name: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, label: "Registration"},
                             {name: ClassUtils.CHARGE_TIME_TYPE.CLASS_START, label: "Class Start"}];
    this.nrDueByItems = [{name: ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT, label: "Billing Default"},
                         {name: ClassUtils.DUE_TIME_TYPE.CLASS_END, label: "Class End"}];

    this.rChargeTimeType = [{id: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, name: "Registration"},
                            {id: ClassUtils.CHARGE_TIME_TYPE.CLASS_START, name: "Class Start"}];
    this.rDueByItems = [{id: ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT, name: "Billing Default"},
                        {id: ClassUtils.DUE_TIME_TYPE.CLASS_END, name: "Class End"}];

    this.dayOfMonth = [{id: 1, name: "1st"}, {id: 2, name: "2nd"}, {id: 3, name: "3rd"}];
    for (var i = 4; i <= 28; i ++) {
        this.dayOfMonth.push({id: i, name: i + "th"});
    }
    this.dayOfMonth.push({id: 99, name: "Last day of month"});

    this.bind("click", this.deleteChargeButtonClickedHandler, this.deleteChargeButton);
    this.bind("p:ValueUpdated", this.nrChargeAtUpdatedHandler, this.nrChargeAt);
    this.bind("p:ValueUpdated", this.nrDueByUpdatedHandler, this.nrDueBy);
    this.bind("p:ValueUpdated", this.rChargeAtUpdatedHandler, this.rChargeAt);
    this.bind("p:ItemSelected", this.rDueByUpdatedHandler, this.rDueBy);
    

    var thiz = this;
    var duplicateChargeAtRule = new GenericRule(thiz.nrChargeAt, function (rule) {
        console.log("Start rule here", thiz.options);
        if (thiz.paymentPlanItem && thiz.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL) {
            if(thiz.options && (typeof thiz.options.validate == "function")) {
                console.log("HERE 2123", thiz._getValues());
                return thiz.options.validate(thiz._getValues());
            }
        }
        return true;
    }, "This " + "Charge At" + " value is duplicated");
    var emptyChargeAtRule = new GenericRule(thiz.nrChargeAt, function (rule) {
        if (thiz.paymentPlanItem && thiz.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL
            && !thiz.nrChargeAt.getDate()) return false;
        return true;
    }, "Please input " + "Charge At");
    this.chargeAtRules = new RuleSet()
                        .live(true)
                        .rule(emptyChargeAtRule)
                        .rule(duplicateChargeAtRule);
    this.validationRules = new RuleSet().live(true);
    if (this.options) {
        var paymentPlanItem = this.options;
        var isManual = paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL;
        if (isManual) {
            this.validationRules = this.validationRules.rule(new GenericRule(thiz.chargeAmount, function (rule) {
                                                                if (!thiz.chargeAmount.getValue()) return false;
                                                                return true;
                                                            }, "Please input " + "Charge Amount"))
                                                       .rule(new GenericRule(thiz.chargeAmount, function (rule) {
                                                                if (thiz.chargeAmount.getValue() && thiz.chargeAmount.getValue() < 0.5) return false;
                                                                return true;
                                                            }, "Charge Amount" + " must be at least $0.50"));
        } else {
            this.validationRules = this.validationRules.rule(new GenericRule(thiz.chargeAmount, function (rule) {
                if (thiz.chargeAmount.getValue() && thiz.chargeAmount.getValue() < 0.5) return false;
                return true;
            }, "Charge Amount" + " must be $0.00 or at least $0.50"));
        }
        this.validationRules = this.validationRules.rule(new GenericRule(thiz.rChargeAt, function (rule) {
                                    if (thiz.paymentPlanItem && thiz.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING
                                        && !thiz.rChargeAt.getDate()) return false;
                                    return true;
                                }, "Please input " + "Charge Amount"))
                                .rule(new GenericRule(thiz.rDueBy, function (rule) {
                                    if (thiz.paymentPlanItem && thiz.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING
                                        && !thiz.rDueBy.getSelectedItem()) return false;
                                    return true;
                                }, "Please input Due By"))
                                .rule(emptyChargeAtRule)
                                .rule(duplicateChargeAtRule)
                                .rule(new GenericRule(thiz.nrDueBy, function (rule) {
                                    if (thiz.paymentPlanItem && thiz.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL
                                        && !thiz.nrDueBy.getDate()) return false;
                                    return true;
                                }, "Please input Due By"));
    }
    
}
__extend(BaseTemplatedWidget, ProjectionChargeEditItemWidget);

ProjectionChargeEditItemWidget.prototype.onAttached = function (firstTime) {
    var thiz = this;
    if (!firstTime) return;
    if (!this.options) return;
    var paymentPlanItem = this.options;
    if (!paymentPlanItem) return;
    this.paymentPlanItem = paymentPlanItem;
    var chargeItem = paymentPlanItem.chargeItem;
    var chargeOverride = paymentPlanItem.chargeOverride;
    if (!chargeItem) return;
    this.chargeItem = chargeItem;
    this.chargeOverride = chargeOverride;
    var isManual = paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL;
    console.log("OPEND CHARGE ITEM EDITOR", chargeItem, chargeOverride);
    if(!this.chargeItem.key) {
        this.chargeItem.id = 0;
        this.chargeItem.key = Util.newUUID();
    }
    if(!this.chargeItem.manualChargeKey) {
        this.chargeItem.manualChargeKey = Util.newUUID();
    }
    var thiz = this;
    this.customTimezoneProvider = {
        getTimezoneId: function () {
            return thiz.options.contraintValues.timezoneId;
        },
        getName: function () {
            return "Class time zone";
        }
    };
    this.rChargeAt.setCustomTimezoneProvider(this.customTimezoneProvider);
    this.nrChargeAt.setCustomTimezoneProvider(this.customTimezoneProvider);
    this.nrDueBy.setCustomTimezoneProvider(this.customTimezoneProvider);

    if (thiz.options.contraintValues && thiz.options.contraintValues.minDate) {
        this.rChargeAt.setMinDate(thiz.options.contraintValues.minDate);
        this.nrChargeAt.setMinDate(thiz.options.contraintValues.minDate);
        this.nrDueBy.setMinDate(thiz.options.contraintValues.minDate);
    }

    if (thiz.options.contraintValues && thiz.options.contraintValues.maxDate) {
        this.rChargeAt.setMaxDate(thiz.options.contraintValues.maxDate);
        this.nrChargeAt.setMaxDate(thiz.options.contraintValues.maxDate);
        this.nrDueBy.setMaxDate(thiz.options.contraintValues.maxDate);
    }

    console.log("ON ATTACHED", chargeItem, chargeOverride)
    if (isManual && chargeItem.amount >= 0) this.chargeAmount.setValue(chargeItem.amount);
    if (!isManual) this.chargeAmount.setValue(chargeOverride && chargeOverride.overrideAmount >= 0 ? chargeOverride.overrideAmount : chargeItem.amount);

    if (paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL) {
        this.nrChargeAt.setNamedOptions(this.nrChargeTimeType);
        var chargeTimeType = chargeItem.chargeTimeType;
        if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
            this.nrChargeAt.setDate(chargeItem.specificChargeDate);
            this.nrDueBy.setMinDate(chargeItem.specificChargeDate);
        } else if (chargeTimeType) {
            this.nrChargeAt.setDate(chargeItem.chargeTimeType);
        }
        if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
            this.nrDueBy.setNamedOptions([{name: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, label: "Registration"}].concat(this.nrDueByItems));
            this.nrDueBy.setDate(ClassUtils.CHARGE_TIME_TYPE.REGISTRATION);
            this.nrDueBy.setEnabled(false);
        } else {
            this.nrDueBy.setNamedOptions(this.nrDueByItems);
            this.nrDueBy.setEnabled(true);
            if (chargeItem.dueTimeType == ClassUtils.DUE_TIME_TYPE.SPECIFIC_DATE) {
                this.nrDueBy.setDate(chargeItem.specificDueDate);
            } else if (chargeItem.dueTimeType) {
                this.nrDueBy.setDate(chargeItem.dueTimeType);
            } else {
                this.nrDueBy.setDate(ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT);
            }
        }
        Dom.addClass(this.rChargeAtWrapper, "Hidden");
        Dom.addClass(this.rDueByWrapper, "Hidden");
        Dom.removeClass(this.nrChargeAtWrapper, "Hidden");
        Dom.removeClass(this.nrDueByWrapper, "Hidden");
        Dom.removeClass(this.deleteAction, "Hidden");
        
        var chargeOnDate;
        if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
            chargeOnDate = thiz.options.contraintValues.classStartDate;
        } else if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
            chargeOnDate = chargeItem.specificChargeDate;
        }
        this.renderDueByExamble(this.nrDueBy.getDate(), chargeOnDate, this.nrDueByExample);
    } else {
        this.rChargeAt.setDate(chargeOverride && chargeOverride.overrideDate? chargeOverride.overrideDate : chargeItem.specificChargeDate);
        this.rDueBy.setItems(this.rDueByItems, true);
        this.rDueBy.selectItemByKey("id", chargeOverride? chargeOverride.overrideDueTimeType : chargeItem.dueTimeType);
        Dom.removeClass(this.rChargeAtWrapper, "Hidden");
        Dom.removeClass(this.rDueByWrapper, "Hidden");
        Dom.addClass(this.nrChargeAtWrapper, "Hidden");
        Dom.addClass(this.nrDueByWrapper, "Hidden");
        this.renderDueByExamble(this.rDueBy.getSelectedItem().id, this.rChargeAt.getDate(), this.rDueByExample);
    }
    
};

ProjectionChargeEditItemWidget.prototype.getValues = function () {
    if (!this.paymentPlanItem) return;
    if (!this.chargeItem) return;
    if (!ValidationManager.run(this.validationRules)) return;
    return this._getValues();
};

ProjectionChargeEditItemWidget.prototype._getValues = function(){
    if (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.MANUAL) {
        var data = {amount: this.chargeAmount.getValue(), id: this.chargeItem.id, key: this.chargeItem.key};
        var chargeAt = this.nrChargeAt.getDate();
        if (chargeAt == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION || chargeAt == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
            data.chargeTimeType = chargeAt;
            data.specificChargeDate = null;
        } else {
            data.specificChargeDate = chargeAt;
            data.chargeTimeType = ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE;
        }
        var dueBy = this.nrDueBy.getDate();
        if (dueBy == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION
            || dueBy == ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT
            || dueBy == ClassUtils.DUE_TIME_TYPE.CLASS_END) {
            data.dueTimeType = dueBy;
            data.specificDueDate = null;
        } else {
            data.dueTimeType = ClassUtils.DUE_TIME_TYPE.SPECIFIC_DATE;
            data.specificDueDate = dueBy;
        }
        if (data.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
            data.dueTimeType = ClassUtils.CHARGE_TIME_TYPE.REGISTRATION;
            data.specificDueDate = null;
        }
        data.manualChargeKey = this.chargeItem.manualChargeKey? this.chargeItem.manualChargeKey : Util.newUUID();
        return data;
    } else {
        var r = {
            id: (this.chargeOverride && this.chargeOverride.id? this.chargeOverride.id : this.chargeItem.id),
            key: this.chargeItem.key,
            fromDate: (this.chargeOverride && this.chargeOverride.fromDate? this.chargeOverride.fromDate : this.chargeItem.specificChargeDate),
            overrideAmount: ((this.chargeItem.amount != this.chargeAmount.getValue() || !this.chargeAmount.getValue())? this.chargeAmount.getValue() : -1),
            overrideDate: (this.chargeItem.specificChargeDate.getTime() != this.rChargeAt.getDate().getTime())? this.rChargeAt.getDate() : null,
            overrideDueTimeType: this.rDueBy.getSelectedItem() ? this.rDueBy.getSelectedItem().id : "",
            targetOverrideKey: this.chargeItem.overrideKey
        };
        console.log("New charge override//this.chargeItem.amount//this.chargeAmount.getValue()", r, this.chargeItem.amount, this.chargeAmount.getValue());
        return r;
    }
}

ProjectionChargeEditItemWidget.prototype.deleteChargeButtonClickedHandler = function () {
    if (typeof(this.options.deleteChargeItemClickedHandler) == "function") {
        this.options.deleteChargeItemClickedHandler(this._uuid);
    }
};

ProjectionChargeEditItemWidget.prototype.nrChargeAtUpdatedHandler = function () {
    if(!ValidationManager.run(this.chargeAtRules)) return;
    var chargeTimeType = this.nrChargeAt.getDate();
    var selectedDueBy = this.nrDueBy.getDate();
    if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
        this.nrDueBy.setNamedOptions([{name: ClassUtils.CHARGE_TIME_TYPE.REGISTRATION, label: "Registration"}].concat(this.nrDueByItems));
        this.nrDueBy.setDate(ClassUtils.CHARGE_TIME_TYPE.REGISTRATION);
        this.nrDueBy.setEnabled(false);
    } else {
        this.nrDueBy.setEnabled(true);
        this.nrDueBy.setNamedOptions(this.nrDueByItems);
        if (selectedDueBy == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
            this.nrDueBy.setDate(ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT);
        } else {
            if (selectedDueBy) {
                this.nrDueBy.setDate(selectedDueBy);
            } else {
                this.nrDueBy.setDate(ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT);
            }
        }
    }
    var contraintValues = this.options.contraintValues;
    var chargeOnDate;
    if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) {
        this.nrDueBy.setMinDate(contraintValues.regDate);
        this.nrDueBy.setMaxDate(contraintValues.maxDate);
    } else if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
        this.nrDueBy.setMinDate(contraintValues.classStartDate);
        this.nrDueBy.setMaxDate(contraintValues.maxDate);
        chargeOnDate = contraintValues.classStartDate;
    } else {
        this.nrDueBy.setMinDate(chargeTimeType);
        this.nrDueBy.setMaxDate(contraintValues.maxDate);
        this.rChargeAt.setMinDate(contraintValues.minDate);
        this.rChargeAt.setMaxDate(contraintValues.maxDate);
        chargeOnDate = chargeTimeType;
    }
    this.renderDueByExamble(this.nrDueBy.getDate(), chargeOnDate, this.nrDueByExample);
};

ProjectionChargeEditItemWidget.prototype.renderDueByExamble = function (dueBy, chargeOnDate, element) {
    console.log("ProjectionChargeEditItemWidget.renderDueByExamble", 
        "\n", dueBy, 
        "\n", chargeOnDate, 
        "\n", this.options.contraintValues);
    element.innerHTML = "";
    var thiz = this;
    if (dueBy == ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT) {
        if (chargeOnDate) {
            var orgTimezoneId = this.options.contraintValues.orgTimezoneId? this.options.contraintValues.orgTimezoneId : this.options.contraintValues.timezoneId;
            var momentChargeOnDate = moment(chargeOnDate).tz(orgTimezoneId);
            console.log("After moment", "\n", chargeOnDate, 
                    "\n", momentChargeOnDate.format(),  
                    "\n", orgTimezoneId, this.options.contraintValues.timezoneId, 
                    "\n", momentChargeOnDate.year(), momentChargeOnDate.month(), momentChargeOnDate.date());
            var onDate = moment.tz([momentChargeOnDate.year(), momentChargeOnDate.month(), momentChargeOnDate.date()], this.options.contraintValues.timezoneId);
            $classAdminService.getDueDate(onDate.toDate(), function (res) {
                element.innerHTML = "(" + FormatUtil.formatDate(res, "date_standard", "team") + ")";
            }, function (err) {});
        }
    } else if (dueBy == ClassUtils.DUE_TIME_TYPE.CLASS_END) {
        if (this.options.contraintValues && this.options.contraintValues.classEndDate) {
            element.innerHTML = "(" + FormatUtil.formatDate(this.options.contraintValues.classEndDate, "date_standard", "team") + ")";    
        }
    }
};

ProjectionChargeEditItemWidget.prototype.nrDueByUpdatedHandler = function () {
    var chargeTimeType = this.nrChargeAt.getDate();
    var chargeOnDate;
    if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
    } else if (chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.CLASS_START) {
        chargeOnDate = this.options.contraintValues.classStartDate;
    } else {
        chargeOnDate = this.nrChargeAt.getDate();
    }
    this.renderDueByExamble(this.nrDueBy.getDate(), chargeOnDate, this.nrDueByExample);
};

ProjectionChargeEditItemWidget.prototype.rChargeAtUpdatedHandler = function () {
    this.renderDueByExamble(this.rDueBy.getSelectedItem().id, this.rChargeAt.getDate(), this.rDueByExample);
};

ProjectionChargeEditItemWidget.prototype.rDueByUpdatedHandler = function () {
    this.renderDueByExamble(this.rDueBy.getSelectedItem().id, this.rChargeAt.getDate(), this.rDueByExample);
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/ProjectionChargeEditWidget.js";

function ProjectionChargeEditWidget(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;

    this.bind("click", this.removeAllButtonClickedHandler, this.removeAllButton);
    this.bind("click", this.removeOverrideButtonClickedHandler, this.removeAllOverride);
    this.bind("click", this.cancelButtonClickedHandler, this.cancelButton);
    this.bind("click", this.applyButtonClickedHandler, this.applyButton);
    this.bind("click", this.newChargeButtonClickedHandler, this.newChargeButton);
    this.removedChargeItems = [];
    this.bind("p:CurrencyValueChanged", this.validateFormChangedHandler, this.projectionEditContent);
    this.bind("p:ValueUpdated", this.validateFormChangedHandler, this.projectionEditContent);
    var thiz = this;
    this.bind("p:ItemSelected", function(){
        if (event && event.fromUser) thiz.validateFormChangedHandler(event);
    }, this.projectionEditContent);

}
__extend(BaseTemplatedWidget, ProjectionChargeEditWidget);

ProjectionChargeEditWidget.prototype.onAttached = function () {
    if (!this.options) return;
    if (!this.options.paymentPlanItem) return;
    this.projectionEditContent.innerHTML = "";
    var paymentPlanItem = this.options.paymentPlanItem;
    if (!paymentPlanItem) return;
    var chargeDates = this.options.charges;//paymentPlanItem.chargeDates;
    var chargeOverrides = this.options.chargeOverrides;
    this.paymentPlanItem = paymentPlanItem;
    console.log("EDIT CHARGE, onAttached charge/chargeOverride", chargeDates, chargeOverrides);

    if (paymentPlanItem.scheduleType == "MANUAL") {
        Dom.show(this.projectionNewChargeAction);
        Dom.show(this.removeAllButton);
        Dom.hide(this.removeAllOverride);
    } else {
        Dom.hide(this.projectionNewChargeAction);
        Dom.hide(this.removeAllButton);
        Dom.show(this.removeAllOverride);
    }

    this.__itemWidgets = [];
    var thiz = this;
    if (chargeDates && chargeDates.length > 0) {
        for (var i = 0; i < chargeDates.length; i++) {
            var chargeOverride = chargeOverrides[chargeDates[i].overrideKey];
            var options = {
                amount: paymentPlanItem.amount,
                scheduleType: paymentPlanItem.scheduleType,
                chargeItem: chargeDates[i],
                chargeOverride: chargeOverride,
                contraintValues: this.options.contraintValues,
                deleteChargeItemClickedHandler: function (uuid) {
                    thiz.deleteChargeItemClickedHandler(uuid);
                },
                validate: function(object){
                    console.log("ASADASDSA 2");
                    return thiz.validateChargeDate(object, true);
                }
            };
            console.log("EDIT CHARGE ITEMS", chargeDates[i], chargeOverride);
            var itemWidget = new __pkg.ProjectionChargeEditItemWidget(options);
            itemWidget._uuid = Util.newUUID();
            itemWidget.into(this.projectionEditContent);
            this.__itemWidgets.push(itemWidget);
            if (chargeOverride) this.removeAllOverride.removeAttribute("disabled");
        }
    } else {
        var options = {
            amount: paymentPlanItem.amount,
            scheduleType: paymentPlanItem.scheduleType,
            chargeItem: {},
            contraintValues: this.options.contraintValues,
            deleteChargeItemClickedHandler: function (uuid) {
                thiz.deleteChargeItemClickedHandler(uuid);
            },
            validate: function(object){
                console.log("ASADASDSA 3");
                return thiz.validateChargeDate(object, true);
            }
        };

        if (this.options.defaultChargeAt) {
            if (this.options.defaultChargeAt instanceof Date) {
                options.chargeItem.chargeTimeType = ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE;
                options.chargeItem.specificChargeDate = this.options.defaultChargeAt;
            } else {
                options.chargeItem.chargeTimeType = this.options.defaultChargeAt;
            }
        }

        var itemWidget = new __pkg.ProjectionChargeEditItemWidget(options);
        itemWidget._uuid = Util.newUUID();
        itemWidget.into(this.projectionEditContent);
        this.__itemWidgets.push(itemWidget);
    }

};

ProjectionChargeEditWidget.prototype.deleteChargeItemClickedHandler = function (uuid) {
    if (this.__itemWidgets && this.__itemWidgets.length > 0) {
        var i = 0, deleteWidget;
        for (i; i < this.__itemWidgets.length; i++) {
            if (this.__itemWidgets[i]._uuid == uuid) {
                deleteWidget = this.__itemWidgets[i];
                break;
            }
        }
    }
    if (deleteWidget) {
        this.removedChargeItems.push(deleteWidget.chargeItem);
        this.__itemWidgets.splice(i, 1);
        deleteWidget.node().parentNode.removeChild(deleteWidget.node());
    }
    this.applyButton.removeAttribute("disabled");

};

ProjectionChargeEditWidget.prototype.removeAllButtonClickedHandler = function () {
    var thiz = this;
    Dialog.confirm("Are you sure you want to remove all items?", "", "Remove", function() {
        if (typeof(thiz.options.removeAllProjectionHandler) == "function") {
            thiz.options.removeAllProjectionHandler();
        }
    }, "Cancel");
};

ProjectionChargeEditWidget.prototype.removeOverrideButtonClickedHandler = function () {
    var thiz = this;
    Dialog.confirm("Are you sure you want to remove override?", "", "Remove", function() {
        if (typeof(thiz.options.removeOverrideProjectionHandler) == "function") {
            thiz.options.removeOverrideProjectionHandler();
        }
    }, "Cancel");
};

ProjectionChargeEditWidget.prototype.cancelButtonClickedHandler = function () {
    if (typeof(this.options.cancelProjectionHandler) == "function") {
        this.options.cancelProjectionHandler();
    }
};

ProjectionChargeEditWidget.prototype.collectchargeDates = function () {
    if (this.__itemWidgets && this.__itemWidgets.length > 0) {
        if(!this.manualChargeDatesMap || !this.manualChargeDatesKeyMap) this._buildManualMaps();
        var chargeDates = [];
        var valid = true;
        for (var i = 0; i < this.__itemWidgets.length; i++) {
            var data = this.__itemWidgets[i].getValues();
            if(!data) return null;
            if (this.validateChargeDate(data)) {
                chargeDates.push(data);
            } else {
                valid = false;
                var chargeAtVal = (data.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE)?
                            moment.tz(data.specificChargeDate, this.__itemWidgets[i].nrChargeAt.getTZID()).format(this.__itemWidgets[i].nrChargeAt.getFormat())
                            : data.chargeTimeType;
                if (data) {
                    console.log("Duplicate Charge At Specific Date ["+ chargeAtVal + "]");
                    Dialog.error("Duplicate Charge At Specific Date ["+ chargeAtVal + "]");
                    return null;
                } else {
                    this.manualChargeDatesMap[data.specificChargeDate.getTime()] = 1;
                }
            }
        }
        if (valid) return chargeDates;
        else return null;
    }
    return [];
}
ProjectionChargeEditWidget.prototype._buildManualMaps = function(){
    this.manualChargeDatesMap = {};
    this.manualChargeDatesKeyMap = {};

    for (var i = 0; i < this.paymentPlanItem.manualChargeDates.length; i++) {
        var chargeItem = this.paymentPlanItem.manualChargeDates[i];
        var k = (chargeItem.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE)? chargeItem.specificChargeDate.getTime() : chargeItem.chargeTimeType;
        this.manualChargeDatesMap[k] = chargeItem.key;
        this.manualChargeDatesKeyMap[chargeItem.key] = k;
    }
    console.log("this.manualChargeDatesMap", this.manualChargeDatesMap, this.manualChargeDatesKeyMap);
}


ProjectionChargeEditWidget.prototype.validateChargeDate = function (chargeObj, forceBuildMap){
    console.log("Start validate");
    if (!chargeObj) return false;
    if(!this.paymentPlanItem || (this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.RECURRING || this.paymentPlanItem.scheduleType == ClassUtils.PAYMENT_SCHEDULE_TYPE.INSTALLMENT_PLAN)) return true;
    if(!this.manualChargeDatesMap || !this.manualChargeDatesKeyMap || forceBuildMap) this._buildManualMaps();
    var k = (chargeObj.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE)? chargeObj.specificChargeDate.getTime() : chargeObj.chargeTimeType;
    var newKey = chargeObj.manualChargeKey;
    if (this.manualChargeDatesMap[k] && this.manualChargeDatesMap[k] == newKey) return true;// same
    if (!this.manualChargeDatesMap[k] && !this.manualChargeDatesKeyMap[newKey]) { // new
        this.manualChargeDatesMap[k] = newKey;
        this.manualChargeDatesKeyMap[newKey] = [k];
        return true;
    }
    if (!this.manualChargeDatesMap[k] && this.manualChargeDatesKeyMap[newKey] && this.manualChargeDatesMap[this.manualChargeDatesKeyMap[newKey]]){ // change ChartAt
        delete this.manualChargeDatesMap[this.manualChargeDatesKeyMap[newKey]];
        this.manualChargeDatesMap[k] = newKey;
        this.manualChargeDatesKeyMap[newKey] = [k];
        return this.validateChargeDate(chargeObj);

    }
    return false;
}

ProjectionChargeEditWidget.prototype.applyButtonClickedHandler = function () {
    if (!this.options) return;
    if (!this.options.paymentPlanItem) return;
    var paymentPlanItem = this.options.paymentPlanItem;
    // var chargeItemsObject = {};
    var chargeDates = this.collectchargeDates();
    if (!(chargeDates && chargeDates.length >= 0)) return;
    if (typeof(this.options.applyProjectionHandler) == "function") {
        this.options.applyProjectionHandler(chargeDates, this.removedChargeItems);
    }
};

ProjectionChargeEditWidget.prototype.newChargeButtonClickedHandler = function () {
    var paymentPlanItem = this.options.paymentPlanItem;
    if (!paymentPlanItem) return;
    if (!this.__itemWidgets) this.__itemWidgets = [];
    var thiz = this;
    var defaultAmount = 0,
        defaultDueTimeType = null,
        defaultDuecificDueDate = null,
        defaultChargeTimeType = null,
        defaultSpecificChargeDate = null;
    if (this.__itemWidgets.length > 0) {
        var previousItem = this.__itemWidgets[this.__itemWidgets.length - 1];
        var values = previousItem._getValues();
        if (values) {
            defaultAmount = values.amount || 0;
            defaultDueTimeType = values.dueTimeType;
            defaultDuecificDueDate = values.specificDueDate;
            if (values.chargeTimeType == ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE) {
                defaultChargeTimeType = ClassUtils.CHARGE_TIME_TYPE.SPECIFIC_DATE;
                defaultSpecificChargeDate = values.specificChargeDate;
            }
        }
    }
    if (defaultDueTimeType == ClassUtils.CHARGE_TIME_TYPE.REGISTRATION) defaultDueTimeType = ClassUtils.DUE_TIME_TYPE.SYSTEM_DEFAULT;
    var options = {
        amount: paymentPlanItem.amount || defaultAmount,
        scheduleType: paymentPlanItem.scheduleType,
        chargeItem: {
            amount: paymentPlanItem.amount || defaultAmount,
            dueTimeType: defaultDueTimeType,
            specificDueDate: defaultDuecificDueDate,
            chargeTimeType: defaultChargeTimeType,
            specificChargeDate: defaultSpecificChargeDate
        },
        contraintValues: this.options.contraintValues,
        deleteChargeItemClickedHandler: function (uuid) {
            thiz.deleteChargeItemClickedHandler(uuid);
        },
        validate: function(object){
            return thiz.validateChargeDate(object, true);
        }
    };
    var itemWidget = new __pkg.ProjectionChargeEditItemWidget(options);
    itemWidget._uuid = Util.newUUID();
    itemWidget.into(this.projectionEditContent);
    this.__itemWidgets.push(itemWidget);
    this.applyButton.removeAttribute("disabled");
    if (this.options && typeof(this.options.invalidatePosition) == "function") {
        this.options.invalidatePosition();
    }
};

ProjectionChargeEditWidget.prototype.validateFormChangedHandler = function (event) {
    this.applyButton.removeAttribute("disabled");
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/RateChartItemsTable.js";

function RateChartItemsTable(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;
}
__extend(BaseTemplatedWidget, RateChartItemsTable);

RateChartItemsTable.prototype.onAttached = function (isFirstTime) {
    if (!isFirstTime) return;
    this._setupHourlyRateTable();
    if (this.options && this.options.ratePlanItems) {
        this.hourlyRateTable.setup();
        this.hourlyRateTable.setItems(this.options.ratePlanItems);
        var ratePlanName = "";
        if (this.options.formWidget == "PaymentPlanWidget") {
            ratePlanName = this.options.ratePlanName;
        } else {
            ratePlanName = "Rate Plan " + this.options.ratePlanName;
        }
        this.ratePlanName.innerHTML = ratePlanName;
    }
};

RateChartItemsTable.prototype._setupHourlyRateTable = function () {
    var thiz = this;
    this.hourlyRateTable.column(new DataTable.PlainTextColumn("Up to Hours per Week", function (data) {
        var hourText = data.limitTime.hour ? (data.limitTime.hour + " " + (data.limitTime.hour > 1 ? "hours" : "hour")) : "";
        var minuteText = data.limitTime.minute ? data.limitTime.minute + " " + (data.limitTime.minute > 1 ? "minutes" : "minute") : "";
        if (data.unlimited) {
            return (hourText + " " + minuteText + " & Up").trim();
        }
        return "Up to " + hourText + " " + minuteText;
    }).width("25em"));

    this.hourlyRateTable.column(new DataTable.PlainTextColumn("Rate per Month", function (data) {
        return Util.toCurrency(data.amount);
    }).width("12em"));
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/RegistrationClassTransferPopup.js";

function RegistrationClassTransferPopup(options) {
    BaseTemplatedWidget.call(this);
    this.options = options;

    this.classTransferList.populator = function (data, binding, node) {
        binding.transferClassTitle.innerHTML = data.type == "DESTINATION" ? "Transferred to " : "Transferred from ";
        binding.transferClassTitle.innerHTML += data.classTitle + " | " +  data.slotName;
        binding.transferClassTitle.style.color = data.programColorCode;
        Dom.toggleClass(binding.transferClassTitle, "DeletedClass", data.deleted);
        binding.transferClassProgName.innerHTML = data.programName;
        binding.transferClassSubProgName.innerHTML = data.subProgramName;
        binding.transferClassDuration.innerHTML = data.classLength + " mins";
        Dom.hide(binding.paymentPlanSubRow);
        if (data.paymentPlanName && data.paymentPlanName.length > 0) {
            Dom.show(binding.paymentPlanSubRow);
            binding.transferClassPaymentPlan.innerHTML = data.paymentPlanName;
        }
        binding.transferClassDate.innerHTML = FormatUtil.formatDate(data.startDate, "date_standard", "local") + " to " + FormatUtil.formatDate(data.endDate, "date_standard", "local");
        binding.transferClassRegDate.innerHTML = FormatUtil.formatDate(data.createdDate, "date_standard", "local");
        binding.classTransferredDate.innerHTML = FormatUtil.formatDate(data.transferredDate, "datetime_standard", "local");
        binding.transferByAccount.innerHTML = data.transferredByAccountName;
        binding.transferClassLocationName.innerHTML = data.locationName || "No Location";
        Dom.toggleClass(node, "HasLocation", data.locationId);
    
        Dom.hide(binding.transferClassProgColor);
        if(data.programColorCode && data.programColorCode.length > 0) {
            Dom.show(binding.transferClassProgColor);
            binding.transferClassProgColor.style.background = "#" + data.programColorCode;
            binding.transferClassProgName.style.border = "0";
        }
    
        Dom.hide(binding.startDropDateSubRow);
        if (data.startDropDatePolicyStartDate || data.startDropDatePolicyDropDate) {
            var policyStartDate = data.startDropDatePolicyStartDate ? FormatUtil.formatDate(data.startDropDatePolicyStartDate, "date_standard", "local") : FormatUtil.formatDate(data.startDate, "date_standard", "local");
            var policyEndDate = data.startDropDatePolicyDropDate ? FormatUtil.formatDate(data.startDropDatePolicyDropDate, "date_standard", "local") : FormatUtil.formatDate(data.endDate, "date_standard", "local");
            binding.transferClassStartDropDate.innerHTML = policyStartDate + " - " + policyEndDate;
            Dom.show(binding.startDropDateSubRow);
        }
    
        binding.regSlotContent.innerHTML = "";
        if (data.regSlot && data.regSlot.length > 0) {
            var regSlotContent = "";
            for(var i = 0; i < data.regSlot.length; i ++) {
                regSlotContent += "<div>" + data.regSlot[i] + "</div>";
            }
            binding.regSlotContent.innerHTML = regSlotContent;
        }
    }
}
__extend(BaseTemplatedWidget, RegistrationClassTransferPopup);

RegistrationClassTransferPopup.prototype.onAttached = function(firstAttached) {
    if (!firstAttached) return;
};

RegistrationClassTransferPopup.prototype.showPopupAt = function(targetNode, classTransferItems) {
    this.targetNode = targetNode;
    this.classTransferList.setItems(classTransferItems, function() {
        Dom.addClass(this.classTransferContainer.parentNode, "ClassTransferInstancePopup");
        this.classTransferPopup.show(this.targetNode, "middle", "bottom", 0, 0, true);
    }.bind(this));
}



if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/RegistrationPaymentPlanItemGrid.js";

function RegistrationPaymentPlanItemGrid (options) {
    RegistrationPaymentPlanItemGrid.RATE_PLAN_COST_ALTERNATIVE = "<span class=\"RatePlanNoCost\">" + ClassUtils.showAlternativeCost("--") + "</span>"; 
    this.options = options;
    __pkg.PaymentPlanItemGrid.call(this, options);
}
__extend(__pkg.PaymentPlanItemGrid, RegistrationPaymentPlanItemGrid);

RegistrationPaymentPlanItemGrid.prototype.getTemplatePath = function () {
    return this.getTemplatePrefix() + __pkg.PaymentPlanItemGrid.name + ".xhtml";
};

RegistrationPaymentPlanItemGrid.prototype.onAttached = function () {
    if(this.didAttached) return;
    this.didAttached = true;
    window.setTimeout(this.onAttachedDelayed.bind(this), 10);
};

RegistrationPaymentPlanItemGrid.prototype.loadPaymentPlanItems = function (projectedInfo, processingFn) {
    $shoppingCartService.projectMultiItemsForClass(projectedInfo, processingFn, "Loading...");
}

RegistrationPaymentPlanItemGrid.prototype.getSubTotalByMonthTitle = function () {
    return "Total";
};

RegistrationPaymentPlanItemGrid.prototype._validateProcessingFee = function (fee, colKey) {
    var useRatePlan = false;
    var ratePlanSlots = this._getRatePlanSlots();
    if (ratePlanSlots) {
        var slot = ratePlanSlots[colKey];
        useRatePlan = this._isRatePlanSlot(slot);

        if (!useRatePlan) {
            var classStartSlot = ratePlanSlots[__pkg.PaymentPlanItemGrid.CLASS_START];
            var classStartColKey = this._getClassStartKey(classStartSlot);
            if (classStartColKey && classStartColKey == colKey) useRatePlan = this._isRatePlanSlot(classStartSlot);
        }
    }

    if (!useRatePlan) return (fee > 0 ? Util.toCurrency(fee) : "");
    return (fee > 0 ? Util.toCurrency(fee) + " + " : "<span class=\"EmptyCost\">0</span>") + RegistrationPaymentPlanItemGrid.RATE_PLAN_COST_ALTERNATIVE;
};

RegistrationPaymentPlanItemGrid.prototype._getClassStartKey = function (slot) {
    if (!slot.charges || slot.charges.length <= 0) return "";
    return moment.tz(slot.charges[0].date, this.classInfo.timezoneId).format('YYYYMM');
};

RegistrationPaymentPlanItemGrid.prototype._getRatePlanSlots = function () {
    for (var key in this.paymentPlanItems) {
        var ppi = this.paymentPlanItems[key];
        if (ppi.scheduleType != ClassUtils.PAYMENT_SCHEDULE_TYPE.RATE_PLAN) continue;
        return this.projectedSlots[ppi.key];
    }
};

RegistrationPaymentPlanItemGrid.prototype._isRatePlanSlot = function (slot) {
    return slot && slot.charges && slot.charges.length > 0 && slot.charges[0].amount <= __pkg.PaymentPlanItemGrid.RATE_PLAN_NO_COST;
};

RegistrationPaymentPlanItemGrid.prototype._buildProcessingFeeCellByColKey = function (fee, colKey) {
    var aFeeStr = this._validateProcessingFee(fee, colKey);
    return aFeeStr
            ? "<hbox class=" + colKey
                + " projected-slot-key=" + colKey + "><span class=\"Value\" flex=\"1\">"
                + aFeeStr + "<span></hbox>"
            : "";
};

RegistrationPaymentPlanItemGrid.prototype._buildProcessingFeeValueStr = function (fee, colKey) {
    var aFeeStr = this._validateProcessingFee(fee, colKey);
    return "<span class=\"Value\" flex=\"1\">" + aFeeStr + "<span>";
};

RegistrationPaymentPlanItemGrid.prototype.buildProcessingFeeRow = function (key, colKey) {
    var ppi = this.paymentPlanItems[key];
    if(!ppi) return null;
    var projectedSlots = this.projectedSlots[key];
    if(!projectedSlots) return null;

    var registrationFee = 0, classStartFee = 0;
    var classStartColKey = "";
    var p = projectedSlots[__pkg.PaymentPlanItemGrid.REGISTRATION];
    if (p && p.charges && p.charges.length > 0) {
        registrationFee = p.charges[0].amount? p.charges[0].amount : 0;
    }
    var p = projectedSlots[__pkg.PaymentPlanItemGrid.CLASS_START];
    if (p && p.charges && p.charges.length > 0) {
        if(p.charges[0]){
            classStartColKey = moment.tz(p.charges[0].date, this.classInfo.timezoneId).format('YYYYMM');
            classStartFee = p.charges[0].amount? p.charges[0].amount : 0;
        }
    }

    var cellClazz = "ProjectedCell Fee ";
    var chargesHtml = "";
    var j = 0;
    for (var i = 0; i < this.projectedColumns.length; i++) {
        if (j == this.totalVisibleColumns) break;
        var colClazz = "ChargeCell ProcessingFee Col" + j + " ";
        var colKey = (j < __pkg.PaymentPlanItemGrid.NUMBER_FIRST_FROZEN_COLUMNS)? this.projectedColumns[j] : this.projectedColumns[this.firstVisibleHeaderIndex + j];
        if (colKey == __pkg.PaymentPlanItemGrid.REGISTRATION) {
            colClazz += ((registrationFee > 0) || (classStartFee > 0) ? "" : " Empty ");
            var colHtml = "";
            var innerSum = 0;
            if (registrationFee) {
                colHtml += this._buildProcessingFeeCellByColKey(registrationFee, colKey);
                var aFee = registrationFee;
                (aFee < 0) || (innerSum += aFee);
            }
            if (classStartColKey && classStartFee && this.isDualFirstCol) {
                colHtml += this._buildProcessingFeeCellByColKey(classStartFee, colKey);
                var aFee = classStartFee;
                (aFee < 0) || (innerSum += aFee);
            }
            if(!colHtml) {
                colHtml = "<vbox>" + this._buildProcessingFeeCellByColKey(0, colKey) + "</vbox>";
                chargesHtml += "<td class=\"" + colClazz + cellClazz + "\" projected-slot-key=\"Registration\" col-pos=\"0\" >" + colHtml +"</td>";
            } else {
                colHtml = "<vbox>" + colHtml + "</vbox>";
                chargesHtml += "<td class=\"" + colClazz + cellClazz + "\" col-pos=\"0\" >" + colHtml + "</td>";
            }
            
            j++;
            this._updateSubTotalByMonth(colKey, key, innerSum);
            continue;
        }
        var innerChargeHtml = "<td class=\"" + colClazz + cellClazz  + "\" col-pos=\"" + j + "\" projected-slot-key=\"" + colKey+ "\">" + "</td>";
        var innerSum = 0;
        if (colKey == classStartColKey && !this.isDualFirstCol) {
            var aFee = classStartFee;
            (aFee < 0) || (innerSum += aFee);
            innerChargeHtml = this._buildProcessingFeeCellByColKey(classStartFee, colKey)
        } else {
            innerChargeHtml = "";
        }
        var slot = projectedSlots[colKey];
        if (slot && slot.charges && slot.charges.length > 0) {
            slot.charges.sort(function(c1, c2){
                return c1.date.getTime() - c2.date.getTime();
            });
            for(var k = 0; k < slot.charges.length; k++) {
                var val = slot.charges[k].amount? slot.charges[k].amount : 0;
                
                var aFee = val;
                (aFee < 0) || (innerSum += aFee);
                
                innerChargeHtml += this._buildProcessingFeeCellByColKey(val, colKey);
            }
        }
        if (innerChargeHtml) {
            this._updateSubTotalByMonth(colKey, key, innerSum);
            innerChargeHtml = "<td class=\"" + colClazz + cellClazz  + "\" col-pos=\"" + j + "\"  projected-slot-key=\"" + colKey+ "\"><vbox>" + innerChargeHtml + "</vbox></td>";
            chargesHtml += innerChargeHtml;
        } else{
            var cell = this._buildProcessingFeeCellByColKey(0, colKey);
            innerChargeHtml += cell ? "<vbox>" + cell + "</vbox>" : "";
            innerChargeHtml = "<td class=\"" + colClazz + cellClazz  + "\" col-pos=\"" + j + "\"  projected-slot-key=\"" + colKey+ "\">" + innerChargeHtml + "</td>";
            chargesHtml += innerChargeHtml;
        }
        j++;
    }
    return chargesHtml;
};

if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/SelectDefaultPaymentPlanDialog.js";

function SelectDefaultPaymentPlanDialog() {
    Dialog.call(this);
    this.paymentPlanCombo.renderer = function (item, selected) {
        if (item.name && item.name.length) return "" + item.name;
        return "<i>[No Plan Name]</i>";
    };
    
}
__extend(Dialog, SelectDefaultPaymentPlanDialog);

SelectDefaultPaymentPlanDialog.prototype.setup = function(options) {
    this.options = options;
    this.title = "Select Payment Plan";
    this.paymentPlanCombo.useHtml = true;
    this.paymentPlanCombo.setItems(options.paymentPlanListItems);
};

SelectDefaultPaymentPlanDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [{
        type: "accept", title: "Save",
        isCloseHandler: true,
        isEnabled: function() {return true},    
        run: function () {
            thiz.close(this.paymentPlanCombo.getSelectedItem());
        }
    }];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/StudentProjectionClassDetail.js";

function StudentProjectionClassDetail(data) {
    BaseTemplatedWidget.call(this);
    this.data = data;
    this.classInfo = null;
    this.paymentPlans = [];
    this.paymentPlanId = this.data.paymentPlanId;
    var thiz = this;
    this.repeaterRegSlot.populator = function(data, binding) {
        binding.titleSlotTime.innerText = data;
    };
    this.regSlotCombo.comparer = function(a, b) {
        return a.slot == b.slot;
    };
    this.regSlotCombo.renderer = function(data) {
        return "Registration Slot #" + (data.slot + 1);
    };
    this.bind("click", this.showSlotDetail.bind(this), this.iconSlotDetail);
    this.paymentPlanCombo.comparer = Util.sameId;
    this.paymentPlanCombo.renderer = function(data) {
        return data.name;
    };
    this.bind("p:ItemSelected", function(event) {
        if (event.fromUser) thiz.renderPaymentPlanDetail();
    }, this.regSlotCombo);
    this.bind("p:ItemSelected", function(event) {
        if (event.fromUser) thiz.renderPaymentPlanDetail();
    }, this.paymentPlanCombo);
    this.bind("p:PopupHidden", function () {
         if (thiz._lastFocusedLink) Dom.removeClass(thiz._lastFocusedLink, "Focused");
    }, this.slotInstancePopup);
    this.slotInstancePopup.popupOpacity = 0.9999;
    this.bind("click", function () {
        thiz.slotInstancePopup.hide();
    }, this.slotInstancePopupArrow);
    this.slotInstancePopup.onBeforeVisible = function (x, y, hAlign, vAlign) {
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        Dom.removeClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        if (vAlign == "top") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignTop");
        } else {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupAlignBottom");
        }
        if (hAlign == "left-inside") {
            Dom.addClass(thiz.slotInstancePopupContent.parentNode, "PopupLeftInside");
        }
        thiz.slotInstanceBackgroundBox.onSizeChanged();
    }
}
__extend(BaseTemplatedWidget, StudentProjectionClassDetail);

StudentProjectionClassDetail.EVT_PAYMENT_PLAN_CHANGE = "evt:payment_plan_change";

StudentProjectionClassDetail.prototype.onAttached = function() {
    this.renderClassInfo(this.data);
};

StudentProjectionClassDetail.prototype.renderClassInfo = function(data) {
    var classStartDate = FormatUtil.formatDateWithTZID(data.startDate, "date_standard", data.timezoneId);
    var classEndDate = FormatUtil.formatDateWithTZID(data.endDate, "date_standard", data.timezoneId);
    this.titleClassName.innerText = data.title;
    this.titleSlotNumber.innerText = data.slotName;
    this.titleClassTime.innerText = classStartDate + " - " + classEndDate;
    if(data.programColorCode && data.programColorCode.length > 0) {
        this.programColor.style.background = "#" + data.programColorCode;
    } else {
        this.programColor.parentNode.removeChild(this.programColor);
    }
    this.titleProgName.innerText = data.programName;
    this.titleSubProg.innerText = data.subProgramName;
    this.titleLocation.innerText = data.locationName;
    this.itemRegSkill.innerText = String.format("{0} of {1}", data.skills.filter(function(s) {return s.passed;}).length, data.skills.length);
    this.itemAttendance.innerText = String.format("{0} of {1}", data.attendance, data.totalAttendance);
    this.repeaterRegSlot.setItems(data.regSlot);

    this.requestLessonClassDetail(data.classId);

    var isWaitPaid = this.isWaitPaid(data);
    if (data.canceled || isWaitPaid) {
        this.regSlotCombo.setDisabled(true);
        this.paymentPlanCombo.setDisabled(true);
    }
    if (data.waiting && data.payment_authorized_status == ClassUtils.PAYMENT_AUTHORIZED_STATUS.PENDING.key) {
        this.regSlotCombo.setDisabled(true);
        this.paymentPlanCombo.setDisabled(true);
    }

    if (!ClassAuthUtils.canChangeSlotPaymentPlanStartDropDate()) {
        this.regSlotCombo.setDisabled(true);
        this.paymentPlanCombo.setDisabled(true);
    }
};

StudentProjectionClassDetail.prototype.isWaitPaid = function (data) {
    return (!data.waiting && !data.canceled && !data.paid && data.waitPaidChargeIds);
};

StudentProjectionClassDetail.prototype.requestLessonClassDetail = function(classId) {
    var thiz = this;
    $classAdminService.getClassDetailById(classId, function(classDetail) {
        thiz.classInfo = classDetail;
        thiz.regSlotCombo.setItems(classDetail.slots);
        thiz.regSlotCombo.selectItemByKey("slot", thiz.data.slotId);
        if (classDetail.paymentPlans && classDetail.paymentPlans.length) {
            thiz.paymentPlanCombo.setItems(classDetail.paymentPlans);
            thiz.paymentPlanCombo.selectItemById(thiz.paymentPlanId);
            thiz.renderPaymentPlanDetail();
        }
        Dom.toggleClass(thiz.paymentPlanCombo.node().parentNode, "NoPaymentPlan", (!classDetail.paymentPlans || !classDetail.paymentPlans.length));
    }, function(error) {
        console.log("Error:", error);
    }, window.defaultIndicator);
};

StudentProjectionClassDetail.prototype.showSlotDetail = function(event) {
    var thiz = this;
    var slot = this.regSlotCombo.getSelectedItem();
    this.classInfo.slots.forEach(function(item) {
        if (item.slot == slot.slot) {
            thiz.renderSlotTimesContent(item);
        }
    });
    Dom.addClass(this.slotInstancePopupContent.parentNode, "SlotInstancePopup");
    thiz.slotInstancePopup.show(event.target, "right-inside", "bottom", 0, 0, true);
};

StudentProjectionClassDetail.prototype.renderSlotTimesContent = function (selectedSlot) {
    this.slotInstancePopupContent.innerHTML = "";
    if (!selectedSlot.slotTimes || selectedSlot.slotTimes.length == 0) return;
    if (selectedSlot.slotTimes.length > 4) {
        this.slotInstancePopupContent.style.width = "28.5em";
    } else if (selectedSlot.slotTimes.length == 4) {
        this.slotInstancePopupContent.style.width = "19em";
    } else {
        this.slotInstancePopupContent.removeAttribute("style");
    }
    for (var i = 0; i < selectedSlot.slotTimes.length; i ++) {
        var slotTimeElm = document.createElement("div");
        Dom.addClass(slotTimeElm, "SlotTimeItem");
        slotTimeElm.innerHTML = selectedSlot.slotTimes[i];
        this.slotInstancePopupContent.appendChild(slotTimeElm);
    }
    var clearBoth = document.createElement("div");
    Dom.addClass(clearBoth, "ClearBoth");
    this.slotInstancePopupContent.appendChild(clearBoth);

    this.regSlotPopupSlotName.innerHTML = "Reg Slot #" + (selectedSlot.slot + 1);
};

StudentProjectionClassDetail.prototype.renderPaymentPlanDetail = function() {
    var paymentPlan = this.paymentPlanCombo.getSelectedItem();
    var regSlot = this.regSlotCombo.getSelectedItem();
    if ((!this.selectedPaymentPlan || (this.selectedPaymentPlan.id != paymentPlan.id))
            || (!this.selectedSlot || (this.selectedSlot.id != regSlot.slot))) {
        this.selectedPaymentPlan = paymentPlan;
        this.selectedSlot = regSlot;
        var gridData = {
            classInfo: this.classInfo,
            items: paymentPlan.items,
            selectedSlot: regSlot.slot,
            paymentPlanId: paymentPlan.id,
            startProjectedDate: this.data.startDate,
            endProjectedDate: this.data.endDate,
            filters: {},
            callback: null,
            readOnly: true,
            isClassAdmin: (window.LOGIN_INFO && ClassAuthUtils.canCreateEditDeleteClass(window.LOGIN_INFO)),
            projectedLessonClassInId: this.data.classInId

        };
        this.paymentPlanContainer.innerHTML = "";
        this.paymentPlanItemGrid = new __pkg.PaymentPlanItemGrid(gridData).into(this.paymentPlanContainer);
        Dom.emitEvent(StudentProjectionClassDetail.EVT_PAYMENT_PLAN_CHANGE, this.node());
    }
};

StudentProjectionClassDetail.prototype.getValue = function() {
    if (!this.classInfo || !this.selectedPaymentPlan) return null;
    return {
        modified: (this.paymentPlanId != this.selectedPaymentPlan.id || this.data.slotId != this.selectedSlot.slot),
        data: {
            id: this.data.memberId,
            classId: this.classInfo.id,
            regIdx: this.data.regIdx,
            classInId: this.data.classInId,
            slot: this.selectedSlot.slot,
            paymentPlanId: this.selectedPaymentPlan.id
        }
    };
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/StudentProjectionDialog.js";

function StudentProjectionDialog(node) {
    this.grabHeight = true;
    BoldDialog.call(this);
    this.bannerImageUrl = "";
    Dom.addClass(this.dialogFrame, "StudentProjectionDialog");
    var thiz = this;
    this.bind(StudentProjectionClassDetail.EVT_PAYMENT_PLAN_CHANGE, function(event) {
        thiz._values = thiz.studentProjectionView.getValues();
        console.log("-- VALUES:", this._values);
        thiz.invalidateElements();
    }, this.studentProjectionView);
}
__extend(BoldDialog, StudentProjectionDialog);

StudentProjectionDialog.prototype.asyncSetup = function (studentId, callback) {
    var thiz = this;
    this.title = "None";
    if (callback) callback();
    var indicator = new Spinner("Loading...");
    indicator.busy();
    this.studentProjectionView.loadMemberInfo(studentId, function() {
        indicator.done();
    });
};

StudentProjectionDialog.prototype.onShown = function() {
    this.invalidateElements();
};

StudentProjectionDialog.prototype.isDataModified = function() {
    if (!this._values) return false;
    return this._values.find(function(value) {
        return value.modified;
    });
};

StudentProjectionDialog.prototype.getModifiedData = function () {
    return this._values.filter(function(val) {
        return val.modified;
    }).map(function(val) {
        return val.data;
    });
};

StudentProjectionDialog.prototype.saveAssignedStudents = function(students) {
    var thiz = this;
    var students = this.getModifiedData();
    if (!students || !students.length) return;
    window.defaultIndicator.busy("Loading...");
    $classAdminService.saveAssignedStudents(students, true, function(res) {
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
        thiz.close(true);
    }, function(error) {
        if(window.defaultIndicator) { window.defaultIndicator.done(); }
        Dialog.alert("Error", error.message);
    });
};

StudentProjectionDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return [
        {
            type: "accept", title: "Save Changes",
            isCloseHandler: true,
            isEnabled: this.isDataModified.bind(this),
            run: function () {
                thiz.saveAssignedStudents();
                return false;
            }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                if (thiz.isDataModified()) {
                    Dialog.confirm("Are you sure you want to discard the unsaved changes?", "",
                        "Discard changes", function() {
                            thiz.close(false);
                        },
                        "Cancel", function() {});
                    return false;
                }
                return true;
            }
        }
    ];
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/StudentProjectionView.js";

function StudentProjectionView() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.bind("click", function() {
        thiz.copyClipboard(thiz.member.id, "ID");
    }, this.copyIdButton);
    this.bind("click", this.printStudentPaymentPlanDetail.bind(this), this.btnPrint);
}
__extend(BaseTemplatedWidget, StudentProjectionView);

StudentProjectionView.prototype.onAttached = function() {
    setTimeout(this.onAttachedDelayed.bind(this), 50);
};

StudentProjectionView.prototype.onAttachedDelayed = function() {
    // console.log("# StudentProjectionView Attached");
};

StudentProjectionView.prototype.loadMemberInfo = function(studentId, callback) {
    var thiz = this;
    this.studentId = studentId;
    $classAmaService.getMemberLightInfoById(studentId, function(data) {
        thiz.renderStudentInfo(data);
        thiz.loadRegisteredClass(studentId);
        if (callback) callback();
    }, function(error) {
        console.error("Fail to get Member Info with error:", error);
        if (callback) callback();
    });
};

StudentProjectionView.prototype.loadRegisteredClass = function(studentId) {
    var thiz = this;
    $classAmaService.getMemberClasses(studentId, 1, 0, function(data) {
        thiz._classes = data;
        if (!data) return;
        thiz.itemClassCount.innerText = data.length;
        var paymentPlanTotalAmount = 0;
        thiz.classDetailContainer.innerHTML = "";
        data.forEach(function(classDetail) {
            paymentPlanTotalAmount += classDetail.paymentPlanTotalAmount;
            classDetail.memberId = studentId;
            var classPaymentPlanView = new __pkg.StudentProjectionClassDetail(classDetail);
            classPaymentPlanView.into(thiz.classDetailContainer);
        });
        // thiz.itemGrandTotalAmount.innerText = Util.toCurrency(paymentPlanTotalAmount);
    }, function(error) {
        console.error("Fail to get registered Classes:", error);
    });
};

StudentProjectionView.prototype.renderStudentInfo = function(member) {
    this.member = member || {id: 0};
    this.memberName.innerHTML = member.firstName + " " + member.lastName;
    var title = member.id ? ("ID: " + member.id) : "";
    this.memberName.title = title;
    // this.switchMemberCombo.node().title = Dom.getInnerText(this.memberName) + ", " + title;
    this.accountNameLabel.innerHTML = member.accountFirstName + " " + member.accountLastName;
    this.accountNameLabel.title = member.accountId ? ("ID: " + member.accountId) : "";
    this.avatarView.setUrl("/rest/ondeck/member/photo/cdn/" + TEAM_INFO.alias + "/" + member.id + "?w=100&t=" + (new Date().getTime()), "/v2/images/avatar.jpg");

    var age = moment().diff(member.dt_dob, 'years');
    Dom.setInnerText(this.dobLabel, isNaN(age) ? "" : age);
    Dom.setInnerText(this.genderLabel, member.sex ? "Male" : "Female");

    var status = undefined;
    Util.getEnumValues(MemberStatus).forEach(function (e) {
        if (e.code == member.memberStatusId) {
            status = e;
        }
    });
    Dom.setInnerText(this.memberStatusLabel, status ? status.displayName : "");
    this.memberStatusLabel.setAttribute("_status", status ? status.type : "");

    Dom.toggleClass(this.deleteStatusInfo, "Deleted", member.deleted != 0);

    var thiz = this;
    if (window.LOGIN_INFO && ClassAuthUtils.canViewAccountMemberDetail(window.LOGIN_INFO)) {
        window.widget.__ensureNamespaceLoaded("ama", function (ama) {
            Dom.addClass(thiz.accountNameLabel, "InfoLink");
            thiz.bind("click", function() {
                var accountDetailDialog = new ama.AccountsDetailDialog().callback(function() {
                    thiz.loadRegisteredClass(thiz.studentId);
                });
                accountDetailDialog.open({"ids": [thiz.member.accountId], fromWidget: "clpayplan.ClassEditRegistrationWidget"});
            }, thiz.accountNameLabel);
        });
    }
};

StudentProjectionView.prototype.copyClipboard = function(text, name) {
    var node = Dom.newDOMElement({
        _name: "input",
        value: text,
        position: -99999
    });
    document.body.appendChild(node);
    node.select();
    var success = document.execCommand("copy");
    document.body.removeChild(node);
    if (name) {
        SnackBar.show(success ? (name + " copied to clipboard!") : ("Copy " + name + " was unsuccessfully"), null, null, success ? null : "close-box");
        return;
    }
    SnackBar.show( success ? "URL copied to clipboard!" : "Copy URL was unsuccessfully", null, null, success ? null : "close-box");
};

StudentProjectionView.prototype.printStudentPaymentPlanDetail = function() {
    var paymentPlanIds = this._classes.map(function(lessonClass) {
        return lessonClass.paymentPlanId;
    });
    return;
};

StudentProjectionView.prototype.getValues = function() {
    var values = [];
    Dom.doOnChild(this.classDetailContainer, {
        eval: function(node) {
            return Dom.hasClass(node, "widget_StudentProjectionClassDetail");
    }}, function(child) {
        var data = child.__widget.getValue();
        if (data) values.push(data);
    });
    return values;
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/TestView.js";

function TestView(n) {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, TestView);

TestView.prototype.onAttached = function() {
};


if (window) window.__currentScriptPath = "/v2/classmgmt/widgets/clpayplan/ViewRateChartDialog.js";

function ViewRateChartDialog() {
    Dialog.call(this);
    var thiz = this;
    
    
}

__extend(Dialog, ViewRateChartDialog);

ViewRateChartDialog.prototype.setup = function(options) {
    this.title = "Rate Chart";
    new __pkg.RateChartItemsTable(options).into(this.containerWrapper);
};

ViewRateChartDialog.prototype.getDialogActions = function() {
    var thiz = this;
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/cms/admin/ModuleInitializer.js";

ConfigurationItemsView.registerEditor("String", ConfigurationItemDialog);
ConfigurationItemsView.registerEditor("Number", ConfigurationItemDialog);
ConfigurationItemsView.registerEditor("Boolean", ConfigurationItemDialog);
ConfigurationItemsView.registerEditor("Color", ConfigurationItemDialog);
ConfigurationItemsView.registerEditor("Date", ConfigurationItemDialog);
ConfigurationItemsView.registerEditor("File", ConfigurationItemDialog);
ConfigurationItemsView.registerEditor("Enum", ConfigurationItemDialog);
ConfigurationItemsView.registerEditor("Html", ConfigurationItemDialog);


if (window) window.__currentScriptPath = "/cms/admin/scripts/CalendarNotificationMenuProvider.js";

function CalendarNotificationMenuProvider(ref) {
    this.ref = ref;
};


if (window) window.__currentScriptPath = "/v2/noclassschedules/widgets/BrowseClassDialog.js";

function BrowseClassDialog() {
    ModificationWatchDialog.call(this);
    
    this.bind("change", this.filterClasses, this.filterActiveClass);
    this.bind("change", this.filterClasses, this.filterInActiveClass);
    this.bind("input", this.filterClasses, this.filterText);
    this.bind("change", this.classListRepeaterViewChangedHandler, this.classListRepeaterView);
    
    var thiz = this;
    this.classListRepeaterView.populator = function (data, binding, node) {
        Dom.setInnerText(binding.className, data.title);
        binding.className.setAttribute("title", data.title);
        binding.classSelection.value = data.id;
        binding.classSelection._classData = data;
        if (thiz.selectedClassesObject && thiz.selectedClassesObject[data.id]) {
            binding.classSelection.checked = true;
        }
    };
    
}
__extend(ModificationWatchDialog, BrowseClassDialog);

BrowseClassDialog.prototype.getModifiedEventTarget = function () {
    return this.classListRepeaterView.node();
};

BrowseClassDialog.prototype.asyncSetup = function (options, dialogCallback) {
    var thiz = this;
    this.options = options;
    this.selectedClasses = options.selectedClasses || [];
    this.selectedClassesObject = {};
    this.selectedClasses.forEach(function (item) {
        thiz.selectedClassesObject[item.id] = item;
    });
    this.title = "Browse Classes";
    Dom.addClass(thiz.container.parentNode.parentNode, "BrowseClassDialogContent");
    this.renderBrowseClassDialog(dialogCallback);
};

BrowseClassDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

BrowseClassDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var actions = [];
    if (this.modified) {
        actions.push({
            type: "accept", title: "Select",
            run: function () {
                thiz.applySelectedClasses();
            }
        });
        actions.push({
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel();
                return false;
            }
        });
    } else {
        actions.push({
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {return true;}
        });
    }
    return actions;
};

BrowseClassDialog.prototype.filterClasses = function () {
    var thiz = this;
    if(this.inputingSearchTextTimeout) {
        clearTimeout(this.inputingSearchTextTimeout);
    }
    this.inputingSearchTextTimeout = window.setTimeout(function() {
        thiz.renderBrowseClassDialog();
    }, 200);
};

BrowseClassDialog.prototype.renderBrowseClassDialog = function (callback) {
    var thiz = this;
    var classStatus = -1;
    if (this.filterActiveClass.checked && this.filterInActiveClass.checked) {
        classStatus = -1
    } else if (this.filterActiveClass.checked && !this.filterInActiveClass.checked) {
        classStatus = 1;
    } else if (!this.filterActiveClass.checked && this.filterInActiveClass.checked) {
        classStatus = 2;
    }
    $classAdminService.browseClassForSchedule(this.filterText.value, classStatus, function (res) {
        thiz.classListRepeaterView.setItems(res.result);
        if (callback) callback();
    }, function () {
        if (callback) callback();
    }, "Loading...");
};

BrowseClassDialog.prototype.classListRepeaterViewChangedHandler = function (event) {
    var classSelection = Dom.findParentWithClass(event.target, "ClassSelection");
    if (!classSelection) return;
    if (!this.selectedClasses) this.selectedClasses = [];
    var classData = classSelection._classData;
    if (!classData) return; 
    
    if (classSelection.checked) {
        this.selectedClasses.push(classData);
        this.selectedClassesObject[classData.id] = classData;
    } else {
        var itemIndex = -1;
        for (var i = 0; i < this.selectedClasses.length; i ++) {
            var selectedItem = this.selectedClasses[i];
            if (selectedItem.id == classData.id) {
                itemIndex = i;
                break;
            }
        }
        if (itemIndex >= 0) {
            this.selectedClasses.splice(itemIndex, 1);
            if (this.selectedClassesObject && this.selectedClassesObject[classData.id]) {
                delete this.selectedClassesObject[classData.id];
            }
        }
    }
};

BrowseClassDialog.prototype.applySelectedClasses = function () {
    this.close(this.selectedClasses);
};




if (window) window.__currentScriptPath = "/v2/noclassschedules/widgets/NoClassSchedule.js";

function NoClassSchedule(options) {
    this.options = options;
    BaseTemplatedWidget.call(this);
    var thiz = this;
    
    this.dataListSource = {
        order: {
            propertyName: "createdAt",
            asc: false
        },
        terms: "",
        loadPage: function (pageIndex, pageSize, handler, failed) {
            $noClassSchedulesService.getSchedules(this.terms, pageIndex * pageSize, pageSize, {name: this.order.propertyName, asc: this.order.asc}, function (list) {
                if(list.count > 1) {
                    thiz.totalDisplay.innerHTML = list.count + " Schedules";
                } else {
                    thiz.totalDisplay.innerHTML = list.count + " Schedule";
                }
                handler(list.result, list.count);
            }, failed);
        },
        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };
    this.initializeDataTable();
    
    
    Dom.registerEvent(this.searchText, "input", this.searchTextInputHandler.bind(this), true);
    this.bind("click", function () {
        if(thiz.dataListSource.terms == thiz.searchText.value) return;
        thiz.dataListSource.terms = thiz.searchText.value;
        thiz.paginator.currentPage = 0;
        thiz.paginator.refresh();
    }, this.searchButton);
    this.bind("click", this.btnAddSheduleButtonHandler, this.btnAddShedule);
    this.bind("click", this.editDropdownButtonHandler, this.editDropdownButton);
    this.bind("click", this.editScheduleActionClickHandler, this.editScheduleAction);
    this.bind("click", this.deleteScheduleActionClickHandler, this.deleteScheduleAction);
    this.bind("click", this.dataTableClickHandler, this.dataTable);
    
    this.dataTable.addListener({
        onSelectionChanged: function() {
            if(thiz.dataTable.getSelectedItems().length > 0) {
                thiz.editDropdownButton.removeAttribute("disabled");
            } else {
                thiz.editDropdownButton.setAttribute("disabled", "disabled");
            }
        }
    });
    
}
__extend(BaseTemplatedWidget, NoClassSchedule);

NoClassSchedule.prototype.onAttached = function(firstTime) {
    if (!firstTime) return;

    var thiz = this;
    this.dataTable.setup();

    widget.__ensureNamespaceLoaded("util", function(util) {
        var config = util.paginationUtil.setupPaginatorConfig();

        config.onPageLoaded = function(p, count) {
            thiz.refreshedAt = new Date().getTime();
            util.paginationUtil.setPaginationSummary(thiz.contentDescription, p.totalItems, p.currentPage, p.pageSize, count);
        };

        util.paginationUtil.setupPaginatorInstance(thiz.paginator, thiz.dataTable, thiz.dataListSource, config);
    });
};

NoClassSchedule.prototype.initializeDataTable = function () {
    var scheduleNameCol = new DataTable.GenericDomColumn("Schedule Name", function (data) {
        return "<a class=\"ScheduleName\">" + data.scheduleName + "</a>";
    }).sortable("name").width("1*");
    scheduleNameCol.getContentTitle = function (data, row, col) {
        return "" + data.scheduleName;
    };
    
    this.dataTable.column(scheduleNameCol);
    this.dataTable.column(new DataTable.GenericDomColumn("No Classes Date", function (data) {
        var _children = [];
        
        if (data.noClassDates && data.noClassDates.length > 0) {
            for (var i = 0; i < data.noClassDates.length; i ++) {
                var noClassDates = data.noClassDates[i];
                var text = "";
                if (noClassDates.fromDate) text += FormatUtil.formatDate(noClassDates.fromDate, "date_standard", "local");
                if (noClassDates.toDate) text += " - " + FormatUtil.formatDate(noClassDates.toDate, "date_standard", "local");
                _children.push(Dom.newDOMElement({
                    _name: "span",
                    _text: text
                }));
            }
        } 
        return Dom.newDOMElement({
            _name: "div",
            _children: _children
        });
    }).width("2*"));
    
    this.dataTable.column(new DataTable.GenericColumn("Date Created", function (data) {
        return "" + FormatUtil.formatDate(data.createdAt, "date_standard", "local");
    }).sortable("createdAt").width("12em"));
    
    this.dataTable.selector(true, false);
    this.dataTable.disabledCheckBoxWhenCheckAll(false);
    this.dataTable.setDefaultSelectionHandler({
        run: function (item) {
        }
    });
};

NoClassSchedule.prototype.editDropdownButtonHandler = function (e) {
    this.editDropdownMenu.show(this.editDropdownButton, "left-inside", "bottom", 0, 1, true);
};

NoClassSchedule.prototype.btnAddSheduleButtonHandler = function () {
    this.openScheduleEditDialog([]);
};

NoClassSchedule.prototype.editScheduleActionClickHandler = function () {
    var thiz = this;
    this.editDropdownMenu.hide();
    this.paginator.getSelectedItems(function(selectedItems) {
        if(!selectedItems) return;
        var ids = [];
        for(var i = 0; i < selectedItems.length; i ++) {
            ids.push(selectedItems[i].id);
        }
        if(ids.length == 0) return;
        thiz.openScheduleEditDialog(ids);
    });
};

NoClassSchedule.prototype.openScheduleEditDialog = function (ids) {
    var thiz = this;
    new ScheduleEditDialog().callback(function(data) {
        if(!data) return;
        $noClassSchedulesService.saveSchedule(data, function(jobId) {
            thiz._onJobExecuted(jobId, function (schedule) {
                thiz.paginator.refresh();
            }, function (err) {
                Dialog.error(err.errorMessage || "Error when saving Schedule.");
            }, "Generating slot instance...");
        }, function(err) {}, "Saving...");
    }).open({ids: ids});
};

NoClassSchedule.prototype._onJobExecuted = function(jobId, onSuccess, onError, executingMessage) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var busyIndicator = new Spinner(executingMessage);
    busyIndicator.busy();
    
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                        busyIndicator.done();
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        busyIndicator.done();
                        onError({errorMessage: job.errorMessage});
                    }
                } else {
                    busyIndicator.done();
                    onFailed({errorMessage: "Job not found."});
                }
            }, function (error) {
                busyIndicator.done();
                onFailed(error);
            });
        }, 1000);
    })();
};

NoClassSchedule.prototype.deleteScheduleActionClickHandler = function () {
    var thiz = this;
    this.editDropdownMenu.hide();
    this.paginator.getSelectedItems(function(selectedItems) {
        var allClassesSchedule = null;
        var hasAssignedClassSchedule = false;
        var ids = [];
        
        for(var i = 0; i < selectedItems.length; i ++) {
            if (selectedItems[i].appliedAllClass) {
                allClassesSchedule = selectedItems[i];
            }
            if (selectedItems[i].classIds && selectedItems[i].classIds.length > 0) {
                hasAssignedClassSchedule = true;
            }
            ids.push(selectedItems[i].id);
        }
        
        if(ids.length == 0) return;
        
        var msg = "";
        if (allClassesSchedule != null) {
            msg = "The schedule " + allClassesSchedule.scheduleName + " is assigned to all classes. ";
        }
        if (hasAssignedClassSchedule) {
            msg = "The schedule is assigned to existing class. ";
        }

        Dialog.confirm(msg + "Are you sure you want to delete selected item(s)?", "", "Delete", function() {
            $noClassSchedulesService.deleteSchedule(ids, function(jobId) {
                thiz._onJobExecuted(jobId, function () {
                    thiz.paginator.refresh();
                }, function (err) {
                    Dialog.error(err.errorMessage || "Error when deleting Schedule.");
                }, "Generating slot instance...");
            }, function(err) {}, "Deleting...");
        }, "Cancel");
        
    });
};

NoClassSchedule.prototype.searchTextInputHandler = function () {
    var thiz = this;
    if(this.inputingSearchTextTimeout) {
        clearTimeout(this.inputingSearchTextTimeout);
    }
    this.inputingSearchTextTimeout = window.setTimeout(function() {
        thiz.dataListSource.terms = thiz.searchText.value;
        thiz.paginator.currentPage = 0;
        thiz.paginator.refresh();
    }, 200);
};

NoClassSchedule.prototype.dataTableClickHandler = function(event) {
    var scheduleNameEl = Dom.findParentWithClass(event.target, "ScheduleName");
    if (!scheduleNameEl) return;
    var rowData = DataTable.getRowData(event.target);
    this.openScheduleEditDialog([rowData.id]);
};


if (window) window.__currentScriptPath = "/v2/noclassschedules/widgets/ScheduleEditDialog.js";

function ScheduleEditDialog() {
    ModificationWatchDialog.call(this);
    
    Dom.registerEvent(this.noClassDaysWrapper, "click", this.noClassDaysWrapperClickedHandler.bind(this), true);
    Dom.registerEvent(this.container, "click", this.dialogClickedHandler.bind(this), true);
    this.bind("click", this.indexActionNextClickHandler, this.indexActionNext);
    this.bind("click", this.indexActionPrevClickHandler, this.indexActionPrev);
    this.bind("click", this.addSingleDateButtonClickedHandler, this.addSingleDateButton);
    this.bind("click", this.addDateRangeButtonClickedHandler, this.addDateRangeButton);
    this.bind("change", this.applyToWrapperChangedHandler, this.applyToWrapper);
    this.bind("click", this.selectClassButtonClickedHandler, this.selectClassButton);
    this.bind("click", this.selectedClassWrapperChangedHandler, this.selectedClassItemWrapper);
    
    var thiz = this;
    
    this.bind("p:PopupShown", function () {
        Dom.addClass(thiz.singleDate.calendarPane.parentNode.parentNode, "ScheduleDateTimePicker");
    }, this.singleDate.pickerPopup);
    
    this.bind("p:PopupShown", function () {
        Dom.addClass(thiz.fromDate.calendarPane.parentNode.parentNode, "ScheduleDateTimePicker");
    }, this.fromDate.pickerPopup);
    
    this.bind("p:PopupShown", function () {
        Dom.addClass(thiz.toDate.calendarPane.parentNode.parentNode, "ScheduleDateTimePicker");
    }, this.toDate.pickerPopup);
    
    this.selectedDateObject = {};
    this.singleDate.getDisabledDate = function () {
        return thiz.buildSelectedDateObject();
    };
    this.fromDate.getDisabledDate = function () {
        return thiz.buildSelectedDateObject();
    };
    this.toDate.getDisabledDate = function () {
        return thiz.buildSelectedDateObject();
    };
    
}
__extend(ModificationWatchDialog, ScheduleEditDialog);

ScheduleEditDialog.prototype.asyncSetup = function (options, dialogCallback) {
    var thiz = this;
    this.options = options;
    this.scheduleIdIndex = 0;
    this.validationRules = new RuleSet().live(true)
        .required(this.scheduleName, String.format("{0} is required. Please enter a value.", "Schedule Name"))
        .required(this.noClassDayValue, "Please, add at least a date or a date range to \"No-class days\".")
        .custom(new GenericRule(thiz.selectedClassValue, function () {
            if (thiz.applyToSelectedClass.checked && thiz.selectedClassValue.value == "") {
                return false;
            }
            return true;
        }, "Please, assign at least one class to this schedule."));
        
    this.singleDateValidationRules = new RuleSet().live(true)
        .required(this.singleDate, String.format("{0} is required. Please enter a value.", "Single Date"));
    
    this.noClassDateNoRules = new RuleSet().live(true)
        .custom(new GenericRule(thiz.singleDate, function () {
            return true;
        }, ""))
        .custom(new GenericRule(thiz.fromDate, function () {
            return true;
        }, ""))
        .custom(new GenericRule(thiz.toDate, function () {
            return true;
        }, ""));
        
    this.dateRangeValidationRules = new RuleSet().live(true)
        .required(this.fromDate, String.format("{0} is required. Please enter a value.", "From Date"))
        .required(this.toDate, String.format("{0} is required. Please enter a value.", "To Date"))
        .custom(new GenericRule(thiz.toDate, function () {
            var fromDate = thiz.fromDate.getDate();
            var toDate = thiz.toDate.getDate();
            if (fromDate && toDate && fromDate.getTime() >= toDate.getTime()) {
                return false;
            }
            return true;
        }, "[From Date] must be earlier than [To Date]."))
        .custom(new GenericRule(thiz.fromDate, function () {
            var fromDate = thiz.fromDate.getDate();
            var toDate = thiz.toDate.getDate();
            if (!fromDate) return true;
            if (!toDate) return true;
            for (var key in thiz.selectedDateObject) {
                if (thiz.currentSelectedDateId && thiz.currentSelectedDateId == key) continue;
                var dateObject = thiz.selectedDateObject[key].dateRange;
                if (dateObject.fromDate.getTime() >= fromDate.getTime() 
                    && dateObject.fromDate.getTime() <= toDate.getTime()) {
                    return false;
                }
                if (dateObject.toDate
                    && dateObject.toDate.getTime() >= fromDate.getTime() 
                    && dateObject.toDate.getTime() <= toDate.getTime()) {
                    return false;
                }
            }
            return true;
        }, "This date range was overlapped."))
        .custom(new GenericRule(thiz.toDate, function () {
            var fromDate = thiz.fromDate.getDate();
            var toDate = thiz.toDate.getDate();
            if (!fromDate) return true;
            if (!toDate) return true;
            for (var key in thiz.selectedDateObject) {
                if (thiz.currentSelectedDateId && thiz.currentSelectedDateId == key) continue;
                var dateObject = thiz.selectedDateObject[key].dateRange;
                if (dateObject.fromDate.getTime() >= fromDate.getTime() 
                    && dateObject.fromDate.getTime() <= toDate.getTime()) {
                    return false;
                }
                if (dateObject.toDate
                    && dateObject.toDate.getTime() >= fromDate.getTime() 
                    && dateObject.toDate.getTime() <= toDate.getTime()) {
                    return false;
                }
            }
            return true;
        }, "This date range was overlapped."));    
    this.renderScheduleEditDialog(dialogCallback);
};

ScheduleEditDialog.prototype.renderScheduleEditDialog = function (dialogCallback) {
    var thiz = this;
    var couponConfig = new Promise(function(resolve, reject) {
        $coreService.loadClientModuleData("noclassschedules", function (data) {
            thiz.scheduleConfiguration = data;
            resolve();
        }, function (error) {
            reject(error);
        });
    });
    var promiseAll = [couponConfig];
    
    if(this.options.ids && this.options.ids.length > 0) {
        this.title = "Edit Schedule";
        var scheduleDetail = new Promise(function(resolve, reject) {
            $noClassSchedulesService.getScheduleById(thiz.options.ids[thiz.scheduleIdIndex], function (res) {
                thiz.currentSchedule = res;
                resolve();
            }, function (err) {reject(error);}, "Loading...");
        });
        promiseAll.push(scheduleDetail);
    } else {
        this.title = "Add Schedule";
    }
    
    Promise.all(promiseAll).then(function () {
        thiz.renderScheduleDetail();
        if (dialogCallback) dialogCallback();
    });
};

ScheduleEditDialog.prototype.getChangeEventNames = function () {
    return ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES;
};

ScheduleEditDialog.prototype.renderScheduleDetail = function () {
    this.selectedNoClassDays = [];
    this.selectedClasses = [];
    this.selectedDateObject = {};
    var fromDateInput = this.fromDate.getValidationUITarget();
    if (fromDateInput) fromDateInput.setAttribute("placeholder", "from");
    
    var toDateInput = this.toDate.getValidationUITarget();
    if (toDateInput) toDateInput.setAttribute("placeholder", "to");
    
    if(this.options.ids && this.options.ids.length > 1) {
        this.editScheduleIndex.innerHTML = "Schedule " + (this.scheduleIdIndex + 1) + " of " + this.options.ids.length;
    } else {
        this.indexAction.parentNode.removeChild(this.indexAction);
    }
    if (this.scheduleIdIndex == 0) {
        Dom.addClass(this.indexActionPrev, "ActionDisabled");
    } else {
        Dom.removeClass(this.indexActionPrev, "ActionDisabled");
    }
    if(this.scheduleIdIndex == this.options.ids.length - 1) {
        Dom.addClass(this.indexActionNext, "ActionDisabled");
    } else {
        Dom.removeClass(this.indexActionNext, "ActionDisabled");
    }
    this.noClassDayValue.value = "";
    this.noClassDaysWrapper.innerHTML = "";
    this.selectedClassValue.value = "";
    this.selectedClassItemWrapper.innerHTML = "";
    Dom.hide(this.warningSelectClass);
    this.selectClassButton.setAttribute("disabled", "disabled");
    Dom.addClass(this.selectedClassWrapper, "Disabled");
    if (this.scheduleConfiguration && this.scheduleConfiguration.isExistingAllClassesSchedule 
        && !(this.currentSchedule && this.currentSchedule.appliedAllClass)) {
        this.applyToSelectedClass.setAttribute("disabled", "disabled");
        this.selectClassButton.setAttribute("disabled", "disabled");
        Dom.addClass(this.selectedClassItemWrapper, "Disabled");
        Dom.show(this.warningSelectClass);
    } else {
        Dom.removeClass(this.selectedClassWrapper, "Disabled");
        this.applyToSelectedClass.removeAttribute("disabled");
        Dom.removeClass(this.selectedClassItemWrapper, "Disabled");
    }
    
    if (!this.currentSchedule) return;
    this.scheduleName.value = this.currentSchedule.scheduleName;
    if (this.currentSchedule.noClassDates && this.currentSchedule.noClassDates.length > 0) {
        for (var i = 0; i < this.currentSchedule.noClassDates.length; i ++) {
            var noClassDate = this.currentSchedule.noClassDates[i];
            this.addSelectedDate(noClassDate.id, noClassDate.fromDate, noClassDate.toDate);
        }
    }
    
    if (this.currentSchedule.appliedAllClass) {
        this.applyToAllClass.checked = true;
    } else if (this.currentSchedule.classIds && this.currentSchedule.classIds.length > 0 && this.currentSchedule.lessonClasses) {
        for (var key in this.currentSchedule.lessonClasses) {
            this.selectedClasses.push({id: key, title: this.currentSchedule.lessonClasses[key]});
        }
        this.applyToSelectedClass.checked = true;
        this.selectClassButton.removeAttribute("disabled");
        this.renderSelectedClass(this.selectedClasses);
    } else {
        this.applyToNoClass.checked = true;
    }
};

ScheduleEditDialog.prototype.getDialogActions = function() {
    var thiz = this;
    var actions = [];
    
    if (this.modified) {
        actions.push({
            type: "accept", title: "Save",
            run: function () {
                thiz.saveSchedule();
            }
        });
        actions.push({
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () {
                thiz.performCancel(thiz.hasDataUpdated);
                return false;
            }
        });
    } else {
        actions.push({
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () {return true;}
        });
    }
    return actions;
};

ScheduleEditDialog.prototype.saveSchedule = function() {
    if(!ValidationManager.run(this.validationRules)) return false;
    var noClassDates = [];
    for (var key in this.selectedDateObject) {
        var dateObject = this.selectedDateObject[key];
        var dateItem = {fromDate: dateObject.dateRange.fromDate};
        if (dateObject.dateRange.toDate) dateItem.toDate = dateObject.dateRange.toDate;
        noClassDates.push(dateItem);
    }
    
    var classIds = [];
    if (this.selectedClasses && this.selectedClasses.length > 0 && this.applyToSelectedClass.checked) {
        for (var i = 0; i < this.selectedClasses.length; i ++) {
            classIds.push(this.selectedClasses[i].id);
        }
    }
    var data = {
        id: this.currentSchedule ? this.currentSchedule.id : 0,
        scheduleName: this.scheduleName.value,
        noClassDates: noClassDates,
        classIds: classIds,
        appliedAllClass: this.applyToAllClass.checked
    };
    this.close(data);
};

ScheduleEditDialog.prototype.indexActionNextClickHandler = function () {
    if(this.scheduleIdIndex == this.options.ids.length - 1) return;
    this.scheduleIdIndex ++;
    this.renderScheduleEditDialog();
    this.clearUnsavedNotify();
};

ScheduleEditDialog.prototype.indexActionPrevClickHandler = function () {
    if(this.scheduleIdIndex == 0) return;
    this.scheduleIdIndex --;
    this.clearUnsavedNotify();
    this.renderScheduleEditDialog();
};

ScheduleEditDialog.prototype.addSingleDateButtonClickedHandler = function () {
    if(!ValidationManager.run(this.singleDateValidationRules)) return false;
    var dataUUID = Util.newUUID();
    this.addSelectedDate(dataUUID, this.singleDate.getDate());
    this.disableAllActiveDate();
    Dom.emitEvent("input", this.noClassDayValue, {});
    this.singleDate.setDate(null);
    
    //ensure the value in the input should be clear when date is disabled.
    if (this.fromDate.getDate() == null || this.toDate.getDate() == null) {
        this.fromDate.setDate(null);
        this.toDate.setDate(null);
    }
};

ScheduleEditDialog.prototype.addDateRangeButtonClickedHandler = function () {
    if(!ValidationManager.run(this.dateRangeValidationRules)) return false;
    var dataUUID = Util.newUUID();
    this.addSelectedDate(dataUUID, this.fromDate.getDate(), this.toDate.getDate());
    this.disableAllActiveDate();
    Dom.emitEvent("input", this.noClassDayValue, {});
    this.fromDate.setDate(null);
    this.toDate.setDate(null);
    
    //ensure the value in the input should be clear when date is disabled.
    if (this.singleDate.getDate() == null) {
        this.singleDate.setDate(null);
    }
};

ScheduleEditDialog.prototype.addSelectedDate = function (dataUUID, fromDate, toDate) {
    var dateItem = {
        id: dataUUID,
        dateRange: {
            fromDate: fromDate
        }
    };
    var formattedDate = FormatUtil.formatDate(fromDate, "date_standard", "local");
    if (toDate) {
        dateItem.dateRange.toDate = toDate;
        formattedDate += " - " + FormatUtil.formatDate(toDate, "date_standard", "local");
    } 
    if (this.currentSelectedDateId) {
        dateItem.id = this.currentSelectedDateId;
    } else {
        this.selectedNoClassDays.push(dateItem.id);
    }
    this.selectedDateObject[dateItem.id] = dateItem;
    this.appendNoClassDayItem(dateItem.id, formattedDate);
    this.fillNoClassDayValue();
};

ScheduleEditDialog.prototype.appendNoClassDayItem = function (dataUUID, text) {
    var dateItems = Dom.findChildrenWithClass(this.noClassDaysWrapper, "NoClassDayItem");
    var updated = false;
    if (dateItems && dateItems.length > 0) {
        dateItems.forEach(function (item) {
            if (item.getAttribute("id") == dataUUID) {
                var textEl = item.getElementsByClassName("NoClassDayText")[0];
                if (textEl) {
                    textEl.innerHTML = text;
                    updated = true;
                }
            }
        });
    }
    if (updated) return;
    var el = Dom.newDOMElement({
        _name: "div",
        id: dataUUID,
        "class": "NoClassDayItem",
        _children: [{
            _name: "hbox",
            _children: [
                {
                    _name: "div",
                    "flex": "1",
                    "class": "NoClassDayText",
                    _text: text
                }, {
                    _name: "icon",
                    "class": "close RemoveNoClassDay" 
                }
            ]
        }]
    });
    this.noClassDaysWrapper.appendChild(el);
};

ScheduleEditDialog.prototype.fillNoClassDayValue = function () {
    this.noClassDayValue.value = "";
    var values = [];
    if (this.selectedNoClassDays && this.selectedNoClassDays.length > 0) {
        this.selectedNoClassDays.forEach(function (selected) {
            values.push(selected);
        });        
    }
    this.noClassDayValue.value = values.join(",");
};

ScheduleEditDialog.prototype.buildSelectedDateObject = function () {
    var timezoneId = TimezoneProviders["server"].getTimezoneId();
    var selectedObject = {};
    for (var key in this.selectedDateObject) {
        if (this.currentSelectedDateId == key) continue;
        var dateRangeObject = this.selectedDateObject[key].dateRange;
        var fromDate = moment.tz(dateRangeObject.fromDate, timezoneId);
        if (dateRangeObject.toDate) {
            var toDate = moment.tz(dateRangeObject.toDate, timezoneId);
            while (fromDate.valueOf() <= toDate.valueOf()) {
                selectedObject[fromDate.valueOf()] = fromDate;
                fromDate.add("d", 1);
            }
        } else {
            selectedObject[fromDate.valueOf()] = fromDate;
        }
    }
    return selectedObject;
};

ScheduleEditDialog.prototype.noClassDaysWrapperClickedHandler = function (event) {
    var removeButton = Dom.findParentWithClass(event.target, "RemoveNoClassDay");
    var noClassDayItem = Dom.findParentWithClass(event.target, "NoClassDayItem");
    if (removeButton) {
        if (this.selectedNoClassDays && this.selectedNoClassDays.length > 0) {
            var itemIndex = -1;
            for (var i = 0; i < this.selectedNoClassDays.length; i ++) {
                var selectedItem = this.selectedNoClassDays[i];
                if (selectedItem == noClassDayItem.getAttribute("id")) {
                    itemIndex = i;
                    delete this.selectedDateObject[selectedItem];
                    break;
                }
            }
            if (itemIndex >= 0) this.selectedNoClassDays.splice(itemIndex, 1);
        }
        this.noClassDaysWrapper.removeChild(noClassDayItem);
        this.fillNoClassDayValue();
        Dom.emitEvent("input", this.selectedClassValue, {});
    } else if (noClassDayItem) {
        var id = noClassDayItem.getAttribute("id");
        this.currentSelectedDateId = id;
        this.singleDate.setDate(null);
        this.fromDate.setDate(null);
        this.toDate.setDate(null);
        ValidationManager.run(this.noClassDateNoRules);
        var dateItems = Dom.findChildrenWithClass(this.noClassDaysWrapper, "NoClassDayItem");
        if (dateItems && dateItems.length > 0) {
            dateItems.forEach(function (dateItem) {
                Dom.removeClass(dateItem, "Active");
            });
        }
        Dom.addClass(noClassDayItem, "Active");
        var selectedDateItem = this.selectedDateObject[id].dateRange;
        if (selectedDateItem.fromDate && selectedDateItem.toDate) {
            this.fromDate.setDate(this.selectedDateObject[id].dateRange.fromDate);
            this.toDate.setDate(this.selectedDateObject[id].dateRange.toDate);
        } else {
            this.singleDate.setDate(this.selectedDateObject[id].dateRange.fromDate);
        }
        event.stopPropagation();
    } else {
        if (this.modified) {
            var validationRules = new RuleSet().live(true)
                .required(this.noClassDayValue, "Please, add at least a date or  a date range to \"No-class days\".");
            ValidationManager.run(validationRules);
        }
    }
};

ScheduleEditDialog.prototype.applyToWrapperChangedHandler = function () {
    if (this.applyToSelectedClass.checked) {
        this.selectClassButton.removeAttribute("disabled");
        Dom.removeClass(this.selectedClassWrapper, "Disabled");
    } else {
        this.selectClassButton.setAttribute("disabled", "disabled");
        Dom.addClass(this.selectedClassWrapper, "Disabled");
    }
};

ScheduleEditDialog.prototype.selectClassButtonClickedHandler = function () {
    var thiz = this;
    new BrowseClassDialog().callback(function(data) {
        if (data) {
            thiz.selectedClasses = data;
            thiz.renderSelectedClass(data);
            Dom.emitEvent("input", thiz.selectedClassValue, {});
        }
    }).open({selectedClasses: Util.clone(thiz.selectedClasses)});
};

ScheduleEditDialog.prototype.renderSelectedClass = function (selectedClasses) {
    var thiz = this;
    this.selectedClassItemWrapper.innerHTML = "";
    var ids = [];
    selectedClasses.forEach(function (classItem) {
        ids.push(classItem.id);
        var el = Dom.newDOMElement({
            _name: "div",
            id: classItem.id,
            "class": "SelectedClassItem",
            _children: [{
                _name: "hbox",
                _children: [
                    {
                        _name: "div",
                        "flex": "1",
                        _text: classItem.title,
                        "title": classItem.title
                    }, {
                        _name: "icon",
                        "class": "close RemoveClass" 
                    }
                ]
            }]
        });
        thiz.selectedClassItemWrapper.appendChild(el);
    });
    
    this.selectedClassValue.value = ids.join(",");
    
};

ScheduleEditDialog.prototype.selectedClassWrapperChangedHandler = function (event) {
    var thiz = this;
    var removeButton = Dom.findParentWithClass(event.target, "RemoveClass");
    if (removeButton) {
        var classItem = Dom.findParentWithClass(removeButton, "SelectedClassItem");
        if (this.selectedClasses && this.selectedClasses.length > 0) {
            var itemIndex = -1;
            for (var i = 0; i < this.selectedClasses.length; i ++) {
                var selectedItem = this.selectedClasses[i];
                if (selectedItem.id == classItem.getAttribute("id")) {
                    itemIndex = i;
                    break;
                }
            }
            if (itemIndex >= 0) this.selectedClasses.splice(itemIndex, 1);
        }
        this.selectedClassItemWrapper.removeChild(classItem);
        this.selectedClassValue.value = this.selectedClasses.join(",");
        Dom.emitEvent("input", this.selectedClassValue, {});
    } else {
        var validationRules = new RuleSet().live(true)
            .custom(new GenericRule(thiz.selectedClassValue, function () {
                if (thiz.applyToSelectedClass.checked && thiz.selectedClassValue.value == "") {
                    return false;
                }
                return true;
            }, "Please, assign at least one class to this schedule."));
        ValidationManager.run(validationRules);
    }
};

ScheduleEditDialog.prototype.dialogClickedHandler = function (event) {
    if (!this.currentSelectedDateId) return;
    var singleDatePicker = Dom.findParentWithClass(event.target, "AnonId_singleDate");
    var fromDatePicker = Dom.findParentWithClass(event.target, "AnonId_fromDate");
    var toDatePicker = Dom.findParentWithClass(event.target, "AnonId_toDate");
    var addDateButton = Dom.findParentWithClass(event.target, "AddDateButton");
    if (addDateButton) return;
    
    var currentDateRange = this.selectedDateObject[this.currentSelectedDateId];
    if (currentDateRange.dateRange.toDate) {
        if (fromDatePicker || toDatePicker) return;
    } else {
        if (singleDatePicker) return;
    }
    this.disableAllActiveDate();
    this.singleDate.setDate(null);
    this.fromDate.setDate(null);
    this.toDate.setDate(null);
};

ScheduleEditDialog.prototype.disableAllActiveDate = function () {
    this.currentSelectedDateId = 0;
    var dateItems = Dom.findChildrenWithClass(this.noClassDaysWrapper, "NoClassDayItem");
    if (dateItems && dateItems.length > 0) {
        dateItems.forEach(function (dateItem) {
            Dom.removeClass(dateItem, "Active");
        });
    }
};






if (window) window.__currentScriptPath = "/cms/admin/scripts/OrgProfileProvider.js";

function OrgProfileProvider () {
    this.registerPermissionTabMap();
}

OrgProfileProvider.prototype.registerPermissionTabMap = function () {
    this.PERMISSION_TAB_MAP = {};
    this.PERMISSION_TAB_MAP[PERMISSION_KEY.OrgProfile_GeneralProfile_View] = "general";
    this.PERMISSION_TAB_MAP[PERMISSION_KEY.OrgProfile_Membership_View] = "membership";
    this.PERMISSION_TAB_MAP[PERMISSION_KEY.OrgProfile_ContactUsSetting_View] = "feedback";
}

OrgProfileProvider.prototype.getDefaultAccessableTab = function () {
    for (var key of Object.keys(this.PERMISSION_TAB_MAP)) {
        if (PermissionUtils.hasAllPermissions(key)) return this.PERMISSION_TAB_MAP[key];
    }
}

OrgProfileProvider.prototype.getMenus = function (callback) {
    var availableTab = this.getDefaultAccessableTab();
    callback([
        {
            id: "team-profile-settings",
            name: function() {
                if (AdminConsole.instance.userSession && AdminConsole.instance.userSession.ymcaRelated && TEAM_INFO && TEAM_INFO.sportType == "swimming") {
                    return "League Profile";
                }
                return "Org Profile & Settings";
            },
            visible: function () {
                return PermissionUtils.hasAnyPermission(
                    PERMISSION_KEY.OrgProfile_GeneralProfile_View,
                    PERMISSION_KEY.OrgProfile_Membership_View,
                    PERMISSION_KEY.OrgProfile_ContactUsSetting_View
                );
            },
            implementation: "teamprofile:TeamProfileSettingView"
        }
    ]);
}
if (window) window.__currentScriptPath = null;
