
if (window && !window.__currentScriptPath) window.__currentScriptPath = null;


if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-dom.js";

/*
    Evolus Commons DOM
    Copyright (c) Evolus Solutions. All rights reserved.

    $Id: evolus.common-dom.js,v 1.4 2007/06/06 08:43:42 dgthanhan Exp $
*/

/*
    @dependencies: <none>
*/

/*
    Reference Definition
*/

if (!window.console) window.console = {};
if (!window.console.log) window.console.log = function () { };

if (window.EVOLUS_COMMON_DOM) {
    window.EVOLUS_COMMON_DOM.count ++;
    window.console.log("Reference Error:\n" + "Duplicated references of Evolus Common Dom found. Ref. count = " + (window.EVOLUS_COMMON_DOM.count));
} else {
    window.EVOLUS_COMMON_DOM = new Object();
    window.EVOLUS_COMMON_DOM.count = 1;
}

(function(d,g){d[g]||(d[g]=function(g){return this.querySelectorAll("."+g)},Element.prototype[g]=d[g])})(document,"getElementsByClassName");


var Namespaces = { };

Namespaces["p"] = "http://www.evolus.vn/Namespace/Pencil";
Namespaces["svg"] = "http://www.w3.org/2000/svg";
Namespaces["xlink"] = "http://www.w3.org/1999/xlink";
Namespaces["xul"] = "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
Namespaces["html"] = "http://www.w3.org/1999/xhtml";
Namespaces["xbl"] = "http://www.mozilla.org/xbl";

Namespaces["inkscape"] = "http://www.inkscape.org/namespaces/inkscape";
Namespaces["dc"] = "http://purl.org/dc/elements/1.1/";
Namespaces["cc"] = "http://creativecommons.org/ns#";
Namespaces["rdf"] = "http://www.w3.org/1999/02/22-rdf-syntax-ns#";
Namespaces["sodipodi"] = "http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd";

var PencilNamespaces = Namespaces;


Namespaces.resolve = function (prefix) {
    var uri = Namespaces[prefix];
    if (uri) return uri;

    return null;
};

function Dom() {
}


Dom.workOn = function (xpath, node, worker) {
    var nodes = Dom.getList(xpath, node);

    for (var i = 0; i < nodes.length; i ++) {
        worker(nodes[i]);
    }
    return nodes.length;
};
Dom.getText = function (node) {
    return node.textContent;
};

Dom.getSingle = function (xpath, node) {
    if (document.all) {
        node.ownerDocument.setProperty("SelectionLanguage", "XPath");
        return node.selectSingleNode(xpath);
    }
    var doc = node.ownerDocument ? node.ownerDocument : node;
    var xpathResult = doc.evaluate(xpath, node, Namespaces.resolve, XPathResult.ANY_TYPE, null);
    return xpathResult.iterateNext();
};
Dom.getSingleValue = function (xpath, node) {
    var doc = node.ownerDocument ? node.ownerDocument : node;
    var xpathResult = doc.evaluate(xpath, node, Namespaces.resolve, XPathResult.ANY_TYPE, null);
    var node = xpathResult.iterateNext();

    return node ? node.nodeValue : null;
};
Dom.getList = function (xpath, node) {
    //alert(node.selectNodes);
    if (document.all) {
        node.ownerDocument.setProperty("SelectionLanguage", "XPath");
        return node.selectNodes(xpath);
    }

    var doc = node.ownerDocument ? node.ownerDocument : node;
    var xpathResult = doc.evaluate(xpath, node, Namespaces.resolve, XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
    var nodes = [];
    var next = xpathResult.iterateNext();
    while (next) {
        nodes.push(next);
        next = xpathResult.iterateNext();
    }

    return nodes;
}
Dom.setEnabled = function (enabled) {
    for (var i = 1; i < arguments.length; i ++) {
        var node = arguments[i];
        if (!node) continue;
        node.disabled = !enabled;
        if (enabled) {
            if (node.removeAttribute) {
                node.removeAttribute("disabled");
            }
        } else {
            if (node.setAttribute) {
                node.setAttribute("disabled", "true");
            }
        }
    }
};
Dom.getChildValue = function (xpath, node) {
    try {
        return Dom.getSingle(xpath, node).nodeValue;
    } catch (e) {
        return null;
    }
};
Dom.isElementExistedInDocument = function(element) {
    while (element) {
        if (element == document) {
            return true;
        }
        element = element.parentNode;
    }
    return false;
}

Dom.registerEvent = function (target, event, handler, capture) {
    if (!target) {
        //console.log("Can not register event to NULL target", event, handler);
        return;
    }
    if (event == "wheel") {
        window.addWheelListener(target, handler, capture);
        return;
    }

    var useCapture = false;
    if (capture) {
        useCapture = true;
    }
    if (target.addEventListener) {
        target.addEventListener(event, handler, useCapture);
    } else if (target.attachEvent) {
        target.attachEvent("on" + event, handler);
    }
};

Dom.unregisterEvent = function (target, event, handler, capture) {
    var useCapture = false;
    if (capture) {
        useCapture = true;
    }
    if (target.removeEventListener) {
        target.removeEventListener(event, handler, useCapture);
    } else if (target.dettachEvent) {
        target.dettachEvent("on" + event, handler);
    }
};
Dom.registerListActionHandlers = function (container, dataPropertyName, classBasedHandlers, eventName) {
    Dom.registerEvent(container, eventName || "click", function (e) {
        var containerNode = Dom.findUpwardForNodeWithData(e.target, dataPropertyName);
        if (!containerNode) return;
        var data = containerNode[dataPropertyName];

        if (typeof(classBasedHandlers) == "function") {
            classBasedHandlers(data, e, containerNode);
            return;
        }

        for (var className in classBasedHandlers) {
            var node = Dom.findParentWithClass(e.target, className);
            if (!node) continue;

            classBasedHandlers[className](data, e, containerNode);
        }
    });
};


Dom.empty = function (node) {
    if (!node) return;
    while (node.firstChild) {
        node.removeChild(node.firstChild);
    }
};

Dom.parser = new DOMParser();
Dom.serializer = new XMLSerializer();
Dom.parseToNode = function (xml, dom) {
    var doc = Dom.parser.parseFromString(xml, "text/xml");
    if (!doc || !doc.documentElement
            || doc.documentElement.namespaceURI == "http://www.mozilla.org/newlayout/xml/parsererror.xml") {
        return null;
    }
    var node = doc.documentElement;
    if (dom) return dom.importNode(node, true);

    return node;
}
Dom.parseDocument = function (xml) {
    var dom = Dom.parser.parseFromString(xml, "text/xml");
    return dom;
};

Dom.disableEvent = function (node, event) {
    Dom.registerEvent(node, event, function(ev) {Dom.cancelEvent(ev);}, true );
};

Dom.getEvent = function (e) {
    return window.event ? window.event : e;
};

Dom.getTarget = function (e) {
    if (!e) return {};
    if (e.target) return e.target;
    var event = Dom.getEvent(e);
    return event.srcElement ? event.srcElement : event.originalTarget;
};

Dom.getWheelDelta = function (e) {
    var event = Dom.getEvent(e);
    var delta = 0;
    if (event.wheelDelta) { /* IE/Opera. */
            delta = event.wheelDelta/120;
            /** In Opera 9, delta differs in sign as compared to IE.
                */
    } else if (event.detail) { /** Mozilla case. */
            /** In Mozilla, sign of delta is different than in IE.
                * Also, delta is multiple of 3.
                */
            delta = -event.detail/3;
    }

    return delta;
};

Dom.emitEvent = function (name, sourceElement, options) {
    var evt = null;
    if (document.createEvent) {
        evt = document.createEvent("HTMLEvents");
        if (evt.initEvent) {
            evt.initEvent(name, true, false);
        }
    } else if (document.createEventObject) {
        evt = document.createEventObject();
        evt.eventType = name;
    }
    if (!evt) {
       //console.log("Can not find method create event to emit event" , name);
       return;
    }
    evt.eventName = name;

    for (n in options) evt[n] = options[n];

    //console.log("emit event on " , sourceElement.tagName, name);
    if (sourceElement.dispatchEvent) {
        sourceElement.dispatchEvent(evt);
    } else if (sourceElement.fireEvent) {
        sourceElement.fireEvent('on'+ evt.eventType, evt);
    } else if (sourceElement[name]) {
        sourceElement[name]();
    } else if (sourceElement['on'+name]) {
        sourceElement['on'+name]();
    }


//POLYFILL: CustomEvent for unsupported browsers
(function () {

    if ( typeof window.CustomEvent === "function" ) return false;

    function CustomEvent ( event, params ) {
        params = params || { bubbles: false, cancelable: false, detail: undefined };
        var evt = document.createEvent( 'CustomEvent' );
        evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
        return evt;
    }

    CustomEvent.prototype = window.Event.prototype;

    window.CustomEvent = CustomEvent;
})();};

Dom.emitCustomEvent = function (name, sourceElement, options) {
    sourceElement.dispatchEvent(
        new CustomEvent(name, {
            detail: options || {}
        }
    ));
};

Dom.getEventOffset = function (e, to) {
    var x = 0;
    var y = 0;

    if (to) {
        x = Dom.getOffsetLeft(to);
        y = Dom.getOffsetTop(to);
    }

    var event = Dom.getEvent(e);
    if (typeof(event.pageX) != "undefined" || typeof(event.pageY) != "undefined") {
        return {
            x: event.pageX - x,
            y: event.pageY - y
        }
    } else {
        return {
            x: event.clientX + Dom.getScrollLeft() - x,
            y: event.clientY + Dom.getScrollTop() - y
        }
    }
};

Dom.getTouchOffset = function (t, to) {
    var x = 0;
    var y = 0;

    if (to) {
        x = Dom.getOffsetLeft(to);
        y = Dom.getOffsetTop(to);
}

    return {
        x: t.pageX - x,
        y: t.pageY - y
    }
};

Dom.getEventScreenX = function (event) {
    if (event.touches && event.touches.length == 1) {
        return event.touches[0].screenX;
    } else {
        return event.screenX;
    }
};
Dom.getEventScreenY = function (event) {
    if (event.touches && event.touches.length == 1) {
        return event.touches[0].screenY;
    } else {
        return event.screenY;
    }
};
Dom.isMultiTouchEvent = function (event) {
    return event.touches && event.touches.length > 1;
};

Dom.cancelEvent = function (e) {
    var event = Dom.getEvent(e);
    if (event.preventDefault) event.preventDefault();
    else event.returnValue = false;
};
Dom.cancelEventBubbling = function (e) {
    if (event.stopPropagation) {
        event.stopPropagation();
    } else {
        e.cancelBubble = true;
    }
}

Dom.addClass = function (node, className) {
    if (!node) return;
    if ((" " + node.className + " ").indexOf(" " + className + " ") >= 0) return;
    node.className += " " + className;
};
Dom.removeClass = function (node, className) {
    if (!node) return;
    if (node.className == className) {
        node.className = "";
        return;
    }
    var re = new RegExp("(^" + className + " )|( " + className + " )|( " + className + "$)", "g");
    var reBlank = /(^[ ]+)|([ ]+$)/g;
    node.className = node.className ? node.className.replace(re, " ").replace(reBlank, "") : "";
};
Dom.toggleClass = function (node, className, add) {
    if (typeof(add) == "undefined") add = !Dom.hasClass(node, className);

    if (add) {
        Dom.addClass(node, className);
    } else {
        Dom.removeClass(node, className);
    }
}


Dom.getOffsetLeft = function (control) {
    var offset = control.offsetLeft;
    var parent = control.offsetParent;
    if (parent) if (parent != control) return offset + Dom.getOffsetLeft(parent);
    return offset;
};

Dom.getOffsetTop = function (control) {
    var offset = control.offsetTop;
    var parent = control.offsetParent;
    if (parent) if (parent != control) {
        var d = parent.scrollTop || 0;
        return offset + Dom.getOffsetTop(parent) - d;
    }
    return offset;
};

Dom.getOffsetHeight = function (control) {
    return control ? control.offsetHeight : 0;
};

Dom.getOffsetWidth = function (control) {
    return control ? control.offsetWidth : 0;
};

Dom.getWindowHeight = function () {
  if ( typeof( window.innerWidth ) == 'number' ) {
    return window.innerHeight;
  } else if ( document.documentElement &&
      ( document.documentElement.clientWidth || document.documentElement.clientHeight ) ) {
    return document.documentElement.clientHeight;
  } else if ( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
    return document.body.clientHeight;
  }
  return 0;
};

Dom.getWindowWidth = function () {
  if ( typeof( window.innerWidth ) == 'number' ) {
    return window.innerWidth;
  } else if ( document.documentElement &&
      ( document.documentElement.clientWidth || document.documentElement.clientHeight ) ) {
    return document.documentElement.clientWidth;
  } else if ( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {
    return document.body.clientWidth;
  }
  return 0;
};

Dom.getScrollTop = function () {
  if ( typeof( window.pageYOffset ) == 'number' ) {
    //Netscape compliant
    return window.pageYOffset;
  } else if ( document.body && ( document.body.scrollLeft || document.body.scrollTop ) ) {
    //DOM compliant
    return  document.body.scrollTop;
  } else if ( document.documentElement &&
      ( document.documentElement.scrollLeft || document.documentElement.scrollTop ) ) {
    //IE6 standards compliant mode
    return  document.documentElement.scrollTop;
  }
  return 0;
};

Dom.getScrollLeft = function () {
  if ( typeof( window.pageXOffset ) == 'number' ) {
    //Netscape compliant
    return window.pageXOffset;
  } else if ( document.body && ( document.body.scrollLeft || document.body.scrollTop ) ) {
    //DOM compliant
    return  document.body.scrollLeft;
  } else if ( document.documentElement &&
      ( document.documentElement.scrollLeft || document.documentElement.scrollTop ) ) {
    //IE6 standards compliant mode
    return  document.documentElement.scrollLeft;
  }
  return 0;
};
Dom.reformHTML = function (node) {
};
Dom.appendAfter = function (fragment, node) {
    if (!node.parentNode) {
        return;
    }
    if (node.nextSibling) {
        node.parentNode.insertBefore(fragment, node.nextSibling);
    } else {
        node.parentNode.appendChild(fragment);
    }
    //Dom.reformHTML(node.parentNode);
};
Dom.insertBefore = function (fragment, node) {
    if (!node.parentNode) {
        return;
    }
    node.parentNode.insertBefore(fragment, node);
    Dom.reformHTML(node.parentNode);
};
Dom.appendParent = function (fragment, node) {
    if (!node.parentNode) {
        return;
    }
    node.parentNode.appendChild(fragment);
    Dom.reformHTML(node.parentNode);
};
Dom.prependParent = function (fragment, node) {
    if (!node.parentNode) {
        return;
    }
    if (node.parentNode.childNodes.length > 0) {
        node.parentNode.insertBefore(fragment, node.parentNode.childNodes[0]);
    } else {
        node.parentNode.appendChild(fragment);
    }
    Dom.reformHTML(node.parentNode);
};
Dom.append = function (fragment, node) {
    node.appendChild(fragment);
    Dom.reformHTML(node);
};
Dom.prepend = function (fragment, node) {
    if (node.childNodes.length > 0) {
        node.insertBefore(fragment, node.childNodes[0]);
    } else node.appendChild(fragment);
    Dom.reformHTML(node);
};
Dom.replace = function (fragment, node) {
    if (!node.parentNode) {
        return;
    }
    node.parentNode.replaceChild(fragment, node);
    Dom.reformHTML(node.parentNode);
};
Dom._getOptionProperty = function (data, name) {
    if (!data) return undefined;
    if (data.getAttribute) {
        if (!data.hasAttribute(name)) return undefined;
        return data.getAttribute(name);
    } else {
        return data[name];
    }
}
Dom.getAttributeAsInt = function (node, attrName, defaultValue) {
    var literal = Dom._getOptionProperty(node, attrName);
    if (typeof(literal) == "undefined") return defaultValue;
    if (typeof(literal) == "number") return literal;

    return parseInt(literal, 10);
}
Dom.getAttributeAsFloat = function (node, attrName, defaultValue) {
    var literal = Dom._getOptionProperty(node, attrName);
    if (typeof(literal) == "undefined") return defaultValue;
    if (typeof(literal) == "number") return literal;

    return parseFloat(literal);
}
Dom.getAttributeAsBoolean = function (node, attrName, defaultValue) {
    var literal = Dom._getOptionProperty(node, attrName);
    if (typeof(literal) == "undefined") return defaultValue;
    if (typeof(literal) == "boolean") return literal;

    return "true" == ("" + literal);
}
Dom.getAttributeAsString = function (node, attrName, defaultValue) {
    var literal = Dom._getOptionProperty(node, attrName);
    if (typeof(literal) == "undefined") return defaultValue;

    return "" + literal;
}
Dom.xmlToFragment = function (xml) {
    var doc = null;
    var wrappedXml = "<root>" + xml + "</root>";
    if (document.implementation.createDocument) {
        var parser = new DOMParser();
        doc = parser.parseFromString(wrappedXml, "text/xml");
    } else {
        doc = new ActiveXObject("Microsoft.XMLDOM");
        doc.loadXML(wrappedXml);
    }
    var fragment = doc.createDocumentFragment();
    var root = doc.documentElement;
    for(var i = 0; i < root.childNodes.length; i++) {
        fragment.appendChild(root.childNodes[i].cloneNode(true));
    }
    return fragment;

};
Dom.importNode = function (doc, node, importChildren) {
    if (doc.importNode) return doc.importNode(node, importChildren);
    var i = 0;
    switch (node.nodeType) {
        case 11: // DOCUMENT FRAGMENT
            var newNode = doc.createDocumentFragment();
            if (importChildren) {
                for(i = 0; i < node.childNodes.length; i++) {
                    var clonedChild = Dom.importNode(doc, node.childNodes[i], true);
                    if (clonedChild) newNode.appendChild(clonedChild);
                }
            }
            return newNode;
        case 1: // ELEMENT
            var newNode = doc.createElement(node.nodeName);
            for(i = 0; i < node.attributes.length; i++){
                newNode.setAttribute(node.attributes[i].name, node.attributes[i].value);
            }
            if (importChildren) {
                for(i = 0; i < node.childNodes.length; i++) {
                    var clonedChild = Dom.importNode(doc, node.childNodes[i], true);
                    if (clonedChild) newNode.appendChild(clonedChild);
                }
            }
            return newNode;
        case 3: // TEXT
            return doc.createTextNode(node.nodeValue);
    }
    return null;
};
Dom.get = function (id, doc) {
    var targetDocument = doc ? doc : document;
    return targetDocument.getElementById(id);
};
Dom.getTags = function (tag, doc) {
    var targetDocument = doc ? doc : document;
    return targetDocument.getElementsByTagName(tag);
};
Dom.getTag = function (tag, doc) {
    var targetDocument = doc ? doc : document;
    return targetDocument.getElementsByTagName(tag)[0];
};
Dom.isChildOf = function (parent, child) {
    if (!parent || !child) {
        return false;
    }
    if (parent == child) {
        return true;
    }
    return Dom.isChildOf(parent, child.parentNode);
};
Dom.findUpwardWithEval = function (node, evaluator, limit) {
    if (node == null || (limit && limit(node))) {
        return null;
    }
    if (evaluator.eval(node)) {
        return node;
    }
    return Dom.findUpward(node.parentNode, evaluator);
};
Dom.findUpward = function (node, evaluator) {
    try {
        if (node == null) {
            return null;
        }
        if (evaluator.eval) {
            return Dom.findUpwardWithEval(node, evaluator);
        }
        if (evaluator(node)) {
            return node;
        }
        return Dom.findUpward(node.parentNode, evaluator);
    } catch (e) { return null; }
};
Dom.findUpwardForData = function (node, dataName) {
    var n = Dom.findUpwardForNodeWithData(node, dataName);
    if (!n) return undefined;
    return n[dataName];
};
Dom.findUpwardForNodeWithData = function (node, dataName) {
    var n = Dom.findUpward(node, function (x) {
        return typeof(x[dataName]) != "undefined";
    });

    return n;
};
Dom.doUpward = function (node, evaluator, worker) {
    if (node == null) {
        return;
    }
    var ok = evaluator.eval ? evaluator.eval(node) : evaluator(node);
    if (ok) {
        if (worker.work) {
            worker.work(node);
        } else {
            worker(node);
        }
    }
    return Dom.doUpward(node.parentNode, evaluator, worker);
};
Dom.findChild = function (node, evaluator, recursive) {
    if (!node || !node.childNodes) return null;

    for (var i = 0; i < node.childNodes.length; i++) {
        var child = node.childNodes[i];
        if (evaluator.eval(child)) return child;
        else if (recursive) {
            var result = Dom.findChild(child, evaluator, recursive);
            if (result) return result;
        }
    }

    return null;
};
Dom.doOnChild = function (node, evaluator, worker) {
    if (!node || !node.childNodes) return null;

    for (var i = 0; i < node.childNodes.length; i++) {
        var child = node.childNodes[i];
        if (evaluator.eval(child)) worker(child);
    }

};
Dom.doOnSelector = function (node, selector, visitor) {
    Array.prototype.forEach.call(node.querySelectorAll(selector), visitor);
};
Dom.doOnAllChildren = function (node, worker) {
    Dom.doOnChild(node, DomAcceptAllEvaluator, worker);
};
Dom.doOnChildRecursively = function (node, evaluator, worker) {
    if (!node || !node.childNodes) return null;

    for (var i = 0; i < node.childNodes.length; i++) {
        var child = node.childNodes[i];
        var ok = evaluator.eval ? evaluator.eval(child) : evaluator(child);
        if (ok) worker(child);
        Dom.doOnChildRecursively(child, evaluator, worker);
    }

};
Dom.findChildTag = function (node, tag) {
    return Dom.findChild(node, new DomTagNameEvaluator(tag));
};

Dom.findChildWithClass = function (node, className) {
    return Dom.findChild(node, {eval: function (node) {
        return (" " + node.className + " ").indexOf(" " + className + " ") >= 0;
    }});
};

Dom.findChildren = function (parentNode, evaluator, recursive) {
    var results = [];
    var children = parentNode.childNodes;
    for (var i = 0; i < children.length; i++ ) {
        var child = children[i];
        if (evaluator.eval(child)) {
            results.push(child);
        } else if (recursive) {
            if (child.childNodes.length > 0) results = results.concat(Dom.findChildren(child, evaluator, recursive));
        }
    }
    return results;
};

Dom.findChildrenWithClass = function (parentNode, className, recursive) {
    return Dom.findChildren(parentNode, {eval: function (node) {
            return Dom.hasClass(node, className);
        }
    }, recursive);
};

Dom.findChildrenByTagName = function (parentNode, tagName, recursive) {
    return Dom.findChildren(parentNode, {
        tagName: tagName.toUpperCase(),
        eval: function (node) {
            return node.tagName && node.tagName.toUpperCase && (node.tagName.toUpperCase() == this.tagName);
        }
    }, recursive);
};

Dom.findDescendantWithClass = function (node, className) {
    if (!node || !node.childNodes) return null;

    for (var i = 0; i < node.childNodes.length; i++) {
        var child = node.childNodes[i];
        if ((" " + child.className + " ").indexOf(" " + className + " ") >= 0) return child;
        var descendant = Dom.findDescendantWithClass(child, className);
        if (descendant) return descendant;
    }

    return null;
};
function DomTagNameEvaluator(tagName) {
    this.tagName = tagName.toUpperCase();
}
DomTagNameEvaluator.prototype.eval = function (node) {
    return node && node.tagName && node.tagName.toUpperCase && (node.tagName.toUpperCase() == this.tagName);
};
Dom.findParentWithClass = function (node, className) {
    return Dom.findUpward(node, {
        className: className,
        eval: function (node) {
            return (" " + node.className + " ").indexOf(" " + this.className + " ") >= 0;
        }
    });
};
Dom.findParentByTagName = function (node, tagName) {
    return Dom.findUpward(node, {
        tagName: tagName.toUpperCase(),
        eval: function (node) {
            return node.tagName && node.tagName.toUpperCase && (node.tagName.toUpperCase() == this.tagName);
        }
    });
}
Dom.findParentWithProperty = function (node, property) {
    if (node == null) {
        return null;
    }
    if (typeof(node[property]) != "undefined") {
        return node;
    }
    return Dom.findParentWithProperty(node.parentNode, property);
};
Dom.findParentWithAttribute = function (node, attName, attValue) {
    if (node == null) {
        return null;
    }
    //alert(node);
    if (node.getAttribute) {
        var value = node.getAttribute(attName);
        if (value) {
            if (!attValue) return node;
            if (attValue == value) return node;
        }
    }
    return Dom.findParentWithAttribute(node.parentNode, attName, attValue);
};
Dom.findNonEditableParent = function (node) {
    if (node == null) {
        return null;
    }
    return Dom.findNonEditableParent(node.parentNode);
};
Dom.isTag = function (node, tagName) {
    return (node.tagName && node.tagName.toUpperCase && node.tagName.toUpperCase() == tagName.toUpperCase());
};
Dom.hasClass = function (node, className) {
    return (" " + node.className + " ").indexOf(" " + className + " ") >= 0;
};
Dom.findFirstChild = function(node, tagName) {
    for (var i = 0; i < node.childNodes.length; i ++) {
        var child = node.childNodes[i];
        if (Dom.isTag(child, tagName)) {
            return child;
        }
    }
    return null;
}
Dom.findFirstChildWithClass = function(node, className) {
    for (var i = 0; i < node.childNodes.length; i ++) {
        var child = node.childNodes[i];
        if ((" " + child.className + " ").indexOf(" " + className + " ") >= 0) {
            return child;
        }
    }
    return null;
};
Dom.findLastChild = function(node, tagName) {
    for (var i = node.childNodes.length - 1; i >= 0; i --) {
        var child = node.childNodes[i];
        if (Dom.isTag(child, tagName)) {
            return child;
        }
    }
    return null;
}
Dom.findLastChildWithClass = function(node, className) {
    for (var i = node.childNodes.length - 1; i >= 0; i --) {
        var child = node.childNodes[i];
        if ((" " + child.className + " ").indexOf(" " + className + " ") >= 0) {
            return child;
        }
    }
    return null;
}
Dom.getDocumentBody = function () {
    return document.getElementsByTagName("body")[0];
};
Dom.attrEncode = function (s, preserveCR) {
    preserveCR = preserveCR ? '&#13;' : '\n';
    return ('' + s) /* Forces the conversion to string. */
        .replace(/&/g, '&amp;') /* This MUST be the 1st replacement. */
        .replace(/'/g, '&apos;') /* The 4 other predefined entities, required. */
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        /*
        You may add other replacements here for HTML only
        (but it's not necessary).
        Or for XML, only if the named entities are defined in its DTD.
        */
        .replace(/\r\n/g, preserveCR) /* Must be before the next replacement. */
        .replace(/[\r\n]/g, preserveCR);
        ;
};
Dom.htmlEncode = function (s) {
    if (!Dom.htmlEncodePlaceHolder) {
        Dom.htmlEncodePlaceHolder = document.createElement("div");
    }
    Dom.htmlEncodePlaceHolder.innerHTML = "";
    Dom.htmlEncodePlaceHolder.appendChild(document.createTextNode(s));
    return Dom.htmlEncodePlaceHolder.innerHTML.replace(/[\n]/g, "<br/>");
};
Dom.htmlStrip = function (s) {
    if (!Dom.htmlEncodePlaceHolder) {
        Dom.htmlEncodePlaceHolder = document.createElement("div");
    }
    Dom.htmlEncodePlaceHolder.innerHTML = s;
    var t = Dom.getInnerText(Dom.htmlEncodePlaceHolder);
    Dom.htmlEncodePlaceHolder.innerHTML = "";
    return t;
};
Dom.setInnerText = function (node, text) {
    node.innerHTML = "";
    node.appendChild(node.ownerDocument.createTextNode(text));
};
Dom.getInnerText = function (node) {
    if (document.all) return node.innerText;
    if (node.textContent) return node.textContent;
    if (node.firstChild && node.firstChild.value) return node.firstChild.value;

    return "";
};

Dom.getIndexInParent = function (node, restrictedClass) {
    var parentNode = node.parentNode;
    var index = 0;
    for (var i = 0; i < parentNode.childNodes.length; i++) {
        var currentNode = parentNode.childNodes[i];
        if (restrictedClass && !Dom.hasClass(currentNode, restrictedClass)) continue;
        if (currentNode === node) return index;
        index ++;
    }
    return -1;
}

Dom.getChildByIndex = function (parentNode, index, restrictedClass) {
    if (index >= parentNode.childNodes.length) return null;
    if (!restrictedClass) return parentNode.childNodes[index];
    for (var i = 0, j = 0; i < parentNode.childNodes.length; i++) {
        var node = parentNode.childNodes[i];
        if (Dom.hasClass(node, restrictedClass)) {
            if (j == index) return node;
            j++;
        }
    }
    return null;
}

Dom.installBehavior = function(target, eventName, checker, handler) {
    Dom.registerEvent(target, eventName, function(e) {
                            if (checker.check(e)) {
                                handler.positive();
                            } else {
                                handler.nagative();
                            }
                        });
    Dom.registerEvent(window, "load", function(e) {
                            if (checker.check(null, target)) {
                                handler.positive();
                            } else {
                                handler.nagative();
                            }
                        });
};
Dom._makeSimpleNodeFunction = function (name) {
    return function (text, classNames, children) {
        var spec = {
            _name: name,
            _text: text
        };
        if (classNames) spec["class"] = classNames;
        if (children) spec._children = children;
        return spec;
    };
};
Dom._makeSimpleContainerFunction = function (name) {
    return function () {
        var spec = {
            _name: name
        };

        for (var i = 0; i < arguments.length; i ++) {
            var arg = arguments[i];
            if (typeof (arg) == "string") {
                spec["class"] = arg;
            } else {
                if (!spec._children) spec._children = [];
                spec._children.push(arg);
            }
        }

        return spec;
    };
};

["span", "label", "strong"].forEach(function (tag) {
    Dom[tag] = Dom._makeSimpleNodeFunction(tag);
});

["hbox", "vbox", "div"].forEach(function (tag) {
    Dom[tag] = Dom._makeSimpleContainerFunction(tag);
});


Dom.newDOMElement = function (spec, doc, holder) {
    if (typeof(spec.node) == "function" && spec instanceof BaseWidget) return spec.node();
    if (spec.getAttribute) return spec;

    var ownerDocument = doc ? doc : document;
    var e = spec._uri ? ownerDocument.createElementNS(spec._uri, spec._name) : ownerDocument.createElement(spec._name);

    for (name in spec) {
        if (name.match(/^_/)) continue;

        if (name.match(/^([^:]+):(.*)$/)) {
            var prefix = RegExp.$1;
            var localName = RegExp.$2;
            var uri = Namespaces[prefix];
            e.setAttributeNS(uri, name, spec[name]);
        } else {
            var attrValue = spec[name];
            if (typeof(attrValue) != "undefined") {
                e.setAttribute(name, attrValue);
                if (name == "class") {
                    Dom.addClass(e, attrValue);
                }
            }
        }
    }

    if (spec._text) {
        e.appendChild(e.ownerDocument.createTextNode(spec._text));
    }
    if (spec._cdata) {
        e.appendChild(e.ownerDocument.createCDATASection(spec._cdata));
    }
    if (spec._html) {
        e.innerHTML = spec._html;
    }
    if (spec._children && spec._children.length > 0) {
        e.appendChild(Dom.newDOMFragment(spec._children, e.ownerDocument, holder || null));
    }

    if (holder && spec._id) {
        holder[spec._id] = e;
    }

    return e;
};
Dom.newDOMFragment = function (specs, doc, holder) {
    var ownerDocument = doc ? doc : document;
    var f = ownerDocument.createDocumentFragment();

    for (var i = 0; i < specs.length; i ++) {
        if (specs[i]) {
            var n = Dom.newDOMElement(specs[i], ownerDocument, holder || null);
            f.appendChild(n);
        }
    }
    return f;
};

function DomSelectedChecker(targetElement) {
    this.targetElement = targetElement;
}
DomSelectedChecker.prototype.check = function (event, t) {
    var target = this.targetElement ? this.targetElement : (t ? t : Dom.getTarget(event));
    return target.checked || target.selected;
};
Dom.SELECTED_CHECKER = new DomSelectedChecker();


var DomAcceptAllEvaluator = {
    eval: function (target) { return true; }
};
function DomValueIsChecker(value) {
    this.value = value;
}
DomValueIsChecker.prototype.check = function (event, t) {
    var target = t ? t : Dom.getTarget(event);

    if (target.value && target.value == this.value) {
        return true;
    }

    if (target.selectedIndex && target.options && target.options[target.selectedIndex]) {
        if (target.options[target.selectedIndex].value == this.value) {
            return true;
        }
    }

    return false;
};

function DomValueInChecker(values) {
    this.values = values;
}
DomValueInChecker.prototype.check = function (event, t) {
    var target = t ? t : Dom.getTarget(event);

    var value = null;
    if (target.value) {
        value = target.value;
    }

    if (target.selectedIndex && target.options && target.options[target.selectedIndex]) {
        value = target.options[target.selectedIndex].value;
    }

    if (value && this.values.indexOf("|" + value + "|") >= 0) {
        return true;
    }
    return false;
};

function DomEnableToggleHandler(control) {
    this.control = control;
}
DomEnableToggleHandler.prototype.positive = function() {
    var firstControl = Dom.disableControls(this.control, false);
    if (firstControl && firstControl.focus) {
        firstControl.focus();
        firstControl.select();
    }
};
DomEnableToggleHandler.prototype.nagative = function() {
    Dom.disableControls(this.control, true);
};
Dom.disableControls = function (element, disabled) {
    var nodeName = element.nodeName.toUpperCase();
    if (nodeName == "INPUT" || nodeName == "TEXTAREA" || nodeName == "SELECT") {
        element.disabled = disabled;

        return element;
    } else if (element.childNodes) {
        var firstControl = null;
        for (var i = 0; i < element.childNodes.length; i ++) {
            var control = Dom.disableControls(element.childNodes[i], disabled);
            if (!firstControl) firstControl = control;
        }
        return firstControl;
    }
};
Dom.calculateSystemScrollbarSize = function () {
    if (Dom.calculatedSystemScrollbarSize) {
        return Dom.calculatedSystemScrollbarSize;
    }

    var wrapper = document.createElement("div");
    wrapper.style.overflow = "scroll";
    wrapper.style.visibility = "hidden";
    wrapper.style.position = "absolute";

    var inner = document.createElement("div");
    inner.style.width = "10px";
    inner.style.height = "10px";
    wrapper.appendChild(inner);

    document.body.appendChild(wrapper);

    Dom.calculatedSystemScrollbarSize = {
        w: Dom.getOffsetWidth(wrapper) - Dom.getOffsetWidth(inner),
        h: Dom.getOffsetHeight(wrapper) - Dom.getOffsetHeight(inner)
    };

    document.body.removeChild(wrapper);

    return Dom.calculatedSystemScrollbarSize;
};

Dom.getBoundingClientRect = function (target) {
    var box = target.getBoundingClientRect();
    var newBox = {top: box.top, bottom: box.bottom, left: box.left, right: box.right};
    newBox.width = box.right - box.left;
    newBox.height = box.bottom - box.top;
    return newBox;
};

Dom.getIframeDocument = function(target) {
    var doc = "";
    if (target.contentDocument) { // DOM
        doc = target.contentDocument;
    } else if (target.contentWindow) { // IE win
        doc = target.contentWindow.document;
    }
    return doc.body.innerHTML
}
Dom.hide = function (node) {
    node.style.display = "none";
};
Dom.show = function (node) {
    var name = node.localName.toLowerCase();
    node.style.display = (name == "box" ||  name == "vbox" || name == "hbox") ? "flex" : "block";
};

Dom.onResize = function (element, callback, useContentSize) {
    var w = undefined;
    var h = undefined;

    (function check() {
        if (!document.body.contains(element)) {
            window.setTimeout(function () {
                if (document.body.contains(element)) check();
            }, 500);
            return;
        }
        try {

            var w0 = useContentSize ? element.scrollWidth : element.offsetWidth;
            var h0 = useContentSize ? element.scrollHeight : element.offsetHeight;

            if (w !== w0 || h !== h0) {
                w = w0;
                h = h0;
                callback();
            }

        } catch (e) {

        } finally {
            window.setTimeout(check, 500);
        }
    })();
};
Dom.onTimer = function (element, callback, interval) {
    (function check() {
        if (!document.body.contains(element)) {
            window.setTimeout(function () {
                if (document.body.contains(element)) check();
            }, interval || 500);
            return;
        }
        try {

            callback();

        } catch (e) {

        } finally {
            window.setTimeout(check, interval || 500);
        }
    })();
};

function DomVisibilityToggleHandler(control) {
    this.control = control;
}
DomVisibilityToggleHandler.prototype.positive = function() {
    this.control.style.display = "";
};
DomVisibilityToggleHandler.prototype.nagative = function() {
    this.control.style.display = "none";
};


var Browser = (function () {
    var isIE = /*@cc_on!@*/false || !!document.documentMode;
    var isChrome = !!window.chrome && !!window.chrome.webstore;
    var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
    var isFirefox = typeof InstallTrigger !== 'undefined';
    var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && safari.pushNotification));
    var isBlink = (isChrome || isOpera) && !!window.CSS;
    var isEdge = !isIE && !!window.StyleMedia;
    return {
        // Opera 8.0+
        isOpera: isOpera,

        // Firefox 1.0+
        isFirefox: isFirefox,

        // Safari 3.0+ "[object HTMLElementConstructor]"
        isSafari: isSafari,

        // Internet Explorer 6-11
        isIE: isIE,

        // Edge 20+
        isEdge: isEdge,

        // Chrome 1+
        isChrome: isChrome,

        // Blink engine detection
        isBlink: isBlink,

        cssPrefix: (isIE || isEdge) ? "-ms-" : ((isChrome || isSafari || isBlink) ? "-webkit-" : (isOpera ? "-o-" : "-moz-"))
    };
})();

(function(window,document) {

    var prefix = "", _addEventListener, onwheel, support;

    // detect event model
    if ( window.addEventListener ) {
        _addEventListener = "addEventListener";
    } else {
        _addEventListener = "attachEvent";
        prefix = "on";
    }

    // detect available wheel event
    support = "onwheel" in document.createElement("div") ? "wheel" : // Modern browsers support "wheel"
              document.onmousewheel !== undefined ? "mousewheel" : // Webkit and IE support at least "mousewheel"
              "DOMMouseScroll"; // let's assume that remaining browsers are older Firefox

    window.addWheelListener = function( elem, callback, useCapture ) {
        _addWheelListener( elem, support, callback, useCapture );

        // handle MozMousePixelScroll in older Firefox
        if( support == "DOMMouseScroll" ) {
            _addWheelListener( elem, "MozMousePixelScroll", callback, useCapture );
        }
    };

    function _addWheelListener( elem, eventName, callback, useCapture ) {
        elem[ _addEventListener ]( prefix + eventName, support == "wheel" ? callback : function( originalEvent ) {
            !originalEvent && ( originalEvent = window.event );

            // create a normalized event object
            var event = {
                // keep a ref to the original event object
                originalEvent: originalEvent,
                target: originalEvent.target || originalEvent.srcElement,
                type: "wheel",
                deltaMode: originalEvent.type == "MozMousePixelScroll" ? 0 : 1,
                deltaX: 0,
                deltaZ: 0,
                preventDefault: function() {
                    originalEvent.preventDefault ?
                        originalEvent.preventDefault() :
                        originalEvent.returnValue = false;
                }
            };

            // calculate deltaY (and deltaX) according to the event
            if ( support == "mousewheel" ) {
                event.deltaY = - 1/40 * originalEvent.wheelDelta;
                // Webkit also support wheelDeltaX
                originalEvent.wheelDeltaX && ( event.deltaX = - 1/40 * originalEvent.wheelDeltaX );
            } else {
                event.deltaY = originalEvent.detail;
            }

            // it's time to fire the callback
            return callback( event );

        }, useCapture || false );
    }

})(window,document);

//quert selector polyfill for :scope
try {
    // test for scope support
    document.createElement('a').querySelector(':scope *');
} catch (error) {
    console.log("Applying query selector scope polyfill for this old browser.");

    (function () {
        // scope regex
        var scope = /:scope\b/gi;

        // polyfilled <Element>.querySelector
        var querySelectorWithScope = polyfill(Element.prototype.querySelector);

        Element.prototype.querySelector = function querySelector(selectors) {
            return querySelectorWithScope.apply(this, arguments);
        };

        // polyfilled <Element>.querySelectorAll
        var querySelectorAllWithScope = polyfill(Element.prototype.querySelectorAll);

        Element.prototype.querySelectorAll = function querySelectorAll(selectors) {
            return querySelectorAllWithScope.apply(this, arguments);
        };

        function polyfill(originalQuerySelector) {
            return function (selectors) {
                // whether selectors contain :scope
                var hasScope = selectors && scope.test(selectors);

                if (hasScope) {
                    // element id
                    var id = this.getAttribute('id');

                    if (!id) {
                        // update id if falsey or missing
                        this.id = 'q' + Math.floor(Math.random() * 9000000) + 1000000;
                    }

                    // modify arguments
                    arguments[0] = selectors.replace(scope, '#' + this.id);

                    // result of the original query selector
                    var elementOrNodeList = originalQuerySelector.apply(this, arguments);

                    if (id === null) {
                        // remove id if missing
                        this.removeAttribute('id');
                    } else if (!id) {
                        // restore id if falsey
                        this.id = id;
                    }

                    return elementOrNodeList;
                } else {
                    // result of the original query sleector
                    return originalQuerySelector.apply(this, arguments);
                }
            };
        }
    })();
}

var navSpecHandlers = [];
function registerNavSpecHandler(pattern, handler) {
    navSpecHandlers.push({
        pattern: pattern,
        handler: handler
    });

    tryNavSpecHandlers();
}
function tryNavSpecHandlers() {
    var url = window.location.href;
    var i = url.indexOf("?");
    if (i < 0) return;

    var nav = url.substring(i + 1);
    if (!nav) return;
    for (var i = 0; i < navSpecHandlers.length; i ++) {
        var spec = navSpecHandlers[i];
        var m = spec.pattern.exec(nav);
        if (!m) continue;

        try {
            spec.handler.apply(window, m);
        } catch (e) { }
//        url = url.substring(0, i);
//        (window.wrappedWindowLocation || window.location).href = url;
        return;
    }
}
Dom.registerEvent(window, "load", tryNavSpecHandlers, false);


if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-net.js";

var CommonNet = (function () {
    function makeRequestFunction(method, useQueryString) {
        return function (path, params, resolve, reject, listener, mime) {
            var request = new XMLHttpRequest();
            request.addEventListener("load", function () {
                try {
                    if (request.status != 200) {
                        reject(new Error("Response = " + request.status));
                        return;
                    }

                    var json = request.responseText;
                    var object = null;
                    try {
                        if (json) object = JSON.parse(json);
                    } catch(err) {
                        console.error(err);
                    }
                    resolve(object);
                } finally {
                    if (listener) listener.done();
                }
            });
            var isGet = (method == "GET");
            var url = path;
            var body = "";
            if (params) {
                for (var name in params) {
                    if (body) body += "&";
                    body += name + "=";
                    body += encodeURIComponent("" + params[name]);
                }

                if (useQueryString) {
                    url += url.indexOf("?") < 0 ? "?" : "&";
                    url += body;

                    body = null;
                }
            }
            if (mime) request.overrideMimeType(mime);
            request.open(method, url);
            if (method == "POST") {
                request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            }
            request.send(isGet ? null : body);
            if (listener) listener.busy();
        };
    }
    return {
        get: makeRequestFunction("GET", true),
        post: makeRequestFunction("POST", false),
        postWithQueryString: makeRequestFunction("POST", true)
    }
})();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-validation.js";

(function (installationScope) {

function __ext() {
    var __base = arguments[0];
    var sub = arguments[1];

    sub.prototype = Object.create(__base.prototype);
    sub.prototype.constructor = sub;
    sub.__base = __base;

    return sub;
}

var ValidationManager = {
    patterns: {
        URL_REGEX: /^(?:(?:https?:)?\/\/)\w+[\w-]*(?:\.[\w\.-]+)+.*/,
        // ref: http://emailregex.com/
        EMAIL_REGEX: /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
    }
};
ValidationManager.patterns.RELATIVE_URL_REGEX = new RegExp("(" + /^\/\w.+$/.source + ")|(" + ValidationManager.patterns.URL_REGEX.source + ")");

function getDOMNode(input) {
    return (typeof (input.node) == "function") ? input.node() : input;
};
function saveValidationResult(input, result) {
    ensureListeners(input);

    var node = getDOMNode(input);
    Dom.toggleClass(node, "CV_Invalid", !result.valid);
    node._cvValidationResult = result;

    if (input.getFocusNode) {
        input.getFocusNode()._cvValidationResult = result;
    }
};

function handleInputFocus(event) {
    var node = Dom.findUpwardForNodeWithData(event.target, "_cvValidationResult");
    if (!node) return;

    invalidateTip(node._cvValidationResult);
}
function invalidateTip(result) {
    var node = getDOMNode(result.input);
    var infoTipAnchor = result.input.getValidationUITarget ? result.input.getValidationUITarget() : node;
    if (node._cvLastInfoTip) {
        node._cvLastInfoTip.close();
        if (node._cvLastInfoTip.popupContainer && document.body.contains(node._cvLastInfoTip.popupContainer)) {
            document.body.removeChild(node._cvLastInfoTip.popupContainer);
        }
    }
    if (!result.valid) {
        var message = typeof(result.message) == "function" ? result.message() : result.message;
        node._cvLastInfoTip = InfoTip.show(infoTipAnchor, message, true, null, "error");
    }
}
function handleInputBlur(event) {
    var node = Dom.findUpwardForNodeWithData(event.target, "_cvValidationResult");
    node = getDOMNode(node._cvValidationResult.input);
    if (!node) return;
    if (node._cvLastInfoTip) node._cvLastInfoTip.close();
}
function handleInputChange(event) {
    var node = Dom.findUpwardForNodeWithData(event.target, "_cvValidationResult");
    var result = node._cvValidationResult;
    if (!result.liveValidation) return;
    var newResult = result.rule.validate({});
    newResult.liveValidation = result.liveValidation;
    saveValidationResult(newResult.input, newResult);
    invalidateTip(newResult);
}
function ensureListeners(input) {
    if (input._cvFocusListenerInstalled) return;

    var node = getDOMNode(input);
    var focusNode = input.getFocusNode ? input.getFocusNode() : node;

    Dom.registerEvent(focusNode, "focus", handleInputFocus, true);
    Dom.registerEvent(focusNode, "blur", handleInputBlur, true);

    Dom.registerEvent(node, "input", handleInputChange);
    Dom.registerEvent(node, "p:ItemSelected", handleInputChange);
    Dom.registerEvent(node, "p:ValueUpdated", handleInputChange);
    Dom.registerEvent(node, "p:SelectionChanged", handleInputChange);
    Dom.registerEvent(node, "text-change", handleInputChange);
    Dom.registerEvent(node, "p:FileModified", handleInputChange);
    Dom.registerEvent(node, "p:Pos_QuantityValueChanged", handleInputChange);
    Dom.registerEvent(node, "p:Pos_CurrencyValueChanged", handleInputChange);

    input._cvFocusListenerInstalled = true;
}

ValidationManager.run = function (ruleSet) {
    var context = {
        ruleSet: ruleSet
    };

    var allValid = true;
    var failedInputs = [];
    for (var i = 0; i < ruleSet.rules.length; i ++) {
        var rule = ruleSet.rules[i];
        if (failedInputs.indexOf(rule.input) >= 0) continue;

        var result = rule.validate(context);
        result.liveValidation = ruleSet.liveValidation;

        saveValidationResult(result.input, result);

        if (!result.valid) {
            failedInputs.push(result.input);

            if (allValid) {
                if (typeof(result.input.focus) == "function") {
                    result.input.focus();
                } else {
                    var node = getDOMNode(result.input);
                    var focusNode = result.input.getFocusNode ? result.input.getFocusNode() : node;
                    if (typeof(focusNode.focus) == "function") focusNode.focus();
                }
            }
            allValid = false;
        }
    }

    return allValid;
};

function RuleSet() {
    this.rules = [];
    this.liveValidation = false;
}
RuleSet.prototype._add = function (rule, condition) {
    this.rules.push(condition ? new ConditionalRule(rule, condition) : rule);
};
RuleSet.prototype.custom = function(baseRule, getValueFunction, condition) {
    if (!(baseRule instanceof BaseRule)) return this;
    if (getValueFunction) {
        baseRule.getValue = function() {
            return getValueFunction(this);
        }
    }
    this._add(baseRule, condition);
    return this;
}
RuleSet.prototype.required = function (input, message, condition) {
    this._add(new RequiredRule(input, message), condition);
    return this;
};
RuleSet.prototype.pattern = function (input, regex, message, condition) {
    this._add(new PatternMatchedRule(input, regex, message), condition);
    return this;
};
RuleSet.prototype.dateAfter = function (input, refInput, message, condition) {
    this._add(new DateAfterRule(input, refInput, message), condition);
    return this;
};
RuleSet.prototype.min = function (input, min, exclusive, message, condition) {
    this._add(new MinValueRule(input, min, exclusive, message), condition);
    return this;
};
RuleSet.prototype.max = function (input, min, exclusive, message, condition) {
    this._add(new MaxValueRule(input, min, exclusive, message), condition);
    return this;
};
RuleSet.prototype.number = function (input, options, message, condition) {
    this._add(new NumberValueRule(input, options, message), condition);
    return this;
};
RuleSet.prototype.rule = function (rule) {
    this._add(rule);
    return this;
};
RuleSet.prototype.set = function (ruleSet) {
    this.rules = this.rules.concat(ruleSet.rules);
    return this;
};
RuleSet.prototype.live = function (live) {
    this.liveValidation = live;
    return this;
};

function BaseRule(input, message) {
    this.input = input;
    this.message = message;
}

BaseRule.prototype.getValue = function () {
    if (this.input.getAttribute) {
        if (this.input.localName == "input" || this.input.localName == "textarea") return this.input.value.trim();
    }

    if (this.input instanceof ComboManager) return this.input.getSelectedItem();
    if (this.input instanceof FileUploadView) {
        var path = this.input.getCommaSeparatedStoragePaths();
        return path && path.length > 0 ? path : undefined;
    }
    if (this.input instanceof DateTimePicker) return this.input.getDate();
    if (this.input instanceof RichTextEditor) return this.input.getContent();

    return this.input.getValue ? this.input.getValue() : undefined;
};

BaseRule.prototype.failed = function (message) {
    return {
        valid: false,
        input: this.input,
        rule: this,
        message: message || this.message
    };
};
BaseRule.prototype.ok = function (message) {
    return {
        valid: true,
        input: this.input,
        rule: this,
        message: message || ""
    };
};

function RequiredRule(input, message) {
    BaseRule.call(this, input, message);
}
__ext(BaseRule, RequiredRule);

RequiredRule.prototype.validate = function (context) {
    var value = this.getValue();
    if (!value) return this.failed();
    if (!value.toString().trim()) return this.failed();

    return this.ok();
};


function PatternMatchedRule(input, regex, message) {
    BaseRule.call(this, input, message);
    this.regex = regex;
}
__ext(BaseRule, PatternMatchedRule);

PatternMatchedRule.prototype.validate = function (context) {
    var value = this.getValue();
    if (value == undefined || (value.length > 0 && !value.toString().match(this.regex))) return this.failed();

    return this.ok();
};

function MinValueRule(input, min, exclusive, message) {
    BaseRule.call(this, input, message);
    this.min = min;
    this.exclusive = exclusive;
}
__ext(BaseRule, MinValueRule);

MinValueRule.prototype.validate = function (context) {
    var value = this.input.valueAsNumber;
    if (isNaN(value)) return this.ok();

    if ((value < this.min && !this.exclusive) || (value <= this.min && this.exclusive)) return this.failed();

    return this.ok();
};
function MaxValueRule(input, max, exclusive, message) {
    BaseRule.call(this, input, message);
    this.max = max;
    this.exclusive = exclusive;
}
__ext(BaseRule, MaxValueRule);

MaxValueRule.prototype.validate = function (context) {
    var value = this.input.valueAsNumber;
    if (isNaN(value)) return this.ok();

    if ((value > this.max && !this.exclusive) || (value >= this.max && this.exclusive)) return this.failed();

    return this.ok();
};
function NumberValueRule(input, options, message) {
    BaseRule.call(this, input, message);
    this.options = options;
}
__ext(BaseRule, NumberValueRule);

NumberValueRule.prototype.validate = function (context) {
    var value = this.options.isInteger ? Util.getInputValueAsIntNumber(this.input.value) : Util.getInputValueAsFloatNumber(this.input.value);
    if (isNaN(value)) return this.options.required ? this.failed() : this.ok();

    if (!isNaN(this.options.max)) {
        if ((value > this.options.max && !this.options.exclusiveMax)
            || (value >= this.options.max && this.options.exclusiveMax)) return this.failed();
    }

    if (!isNaN(this.options.min)) {
        if ((value < this.options.min && !this.options.exclusiveMin)
            || (value <= this.options.min && this.options.exclusiveMin)) return this.failed();
    }


    if (this.options.isInteger) {
        var floatValue = Util.getInputValueAsFloatNumber(this.input.value);
        if (Math.round(floatValue) != floatValue) {
            return this.failed();
        }
    }

    return this.ok();
};

function DateAfterRule(input, refInput, message) {
    BaseRule.call(this, input, message);
    this.refInput = refInput;
}
__ext(BaseRule, DateAfterRule);

DateAfterRule.prototype.validate = function (context) {
    var date1 = this.refInput.getDate();
    var date2 = this.input.getDate();

    if (!date1) return date2 ? this.failed() : this.ok();
    return (date2 && date2.getTime() > date1.getTime()) ? this.ok() : this.failed();
};

function GenericRule(input, validationFunction, message) {
    BaseRule.call(this, input, message);
    if (typeof(validationFunction) != "function") {
        throw "The validation callback is required!";
    }
    this.validationFunction = validationFunction;
}
__ext(BaseRule, GenericRule);
GenericRule.prototype.validate = function (context) {
    return this.validationFunction.call(this, context) ? this.ok() : this.failed();
};


function ConditionalRule(rule, condition) {
    BaseRule.call(this, rule.input, rule.message);
    if (typeof(condition) != "function") {
        throw "The condition is required!";
    }
    this.rule = rule;
    this.condition = condition;
}
__ext(BaseRule, ConditionalRule);

ConditionalRule.prototype.validate = function (context) {
    if (!this.condition()) return this.ok();

    return this.rule.validate(context);
};

var Condition = {
    checked: function (input) {
        return function () {
            return input.checked;
        };
    },
    notEmpty: function (input) {
        return function () {
            return input.value ? (input.value.toString().trim() ? true : false) : false;
        };
    },
    hasKeySelected: function (combo, key, value) {
        return function () {
            var item = combo.getSelectedItem();
            if (!item) return false;
            return item[key] == value;
        }
    },
    or: function () {
        var conditions = [];
        for (var i = 0; i < arguments.length; i ++) {
            conditions.push(arguments[i]);
        }
        return function () {
            for (var i = 0; i < conditions.length; i ++) {
                if (conditions[i]()) return true;
            }

            return false;
        };
    },
    and: function () {
        var conditions = [];
        for (var i = 0; i < arguments.length; i ++) {
            conditions.push(arguments[i]);
        }
        return function () {
            for (var i = 0; i < conditions.length; i ++) {
                if (!conditions[i]()) return false;
            }

            return true;
        };
    },
    not: function (c) {
        return function () {
            return !c();
        };
    }
}


installationScope.ValidationManager = ValidationManager;
installationScope.RuleSet = RuleSet;
installationScope.RequiredRule = RequiredRule;
installationScope.PatternMatchedRule = PatternMatchedRule;
installationScope.GenericRule = GenericRule;
installationScope.Condition = Condition;
})(window);


if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-navigation.js";

var CommonNavigation = (function () {
    var activeModule = null;
    var rootModule = null;
    var currentPath = [];
    var handlingHashChange = false;
    var updatingPathMemory = false;
    var ignoreNextHashChange = false;
    var lastAutoNavigation = null;

    function setRoot(navigationModule, callback) {
        rootModule = navigationModule;
        currentPath = [];

        navigateToCurrentHash(callback);
    }

    function handleHashChange(event) {
        console.log("Hash changed: ", window.location.hash, rootModule, ignoreNextHashChange, updatingPathMemory);
        if (!rootModule) return;
        if (ignoreNextHashChange) {
            ignoreNextHashChange = false;
            return;
        }
        if (updatingPathMemory) return;

        navigateToCurrentHash(function () {
        });
    }

    function navigateToCurrentHash(callback) {
        console.log("navigateToCurrentHash: ", window.location.hash);

        updatingPathMemory = true;
        lastAutoNavigation = null;
        var hash = "" + window.location.hash;
        var steps = hash.replace(/^#(\/)?/, "").split("/");
        var i = 0;
        while (i <= currentPath.length - 1
                && i <= steps.length - 1
                && currentPath[i].name == steps[i]) i ++;

        // close trailing module
        if (i <= currentPath.length - 1) {
            for (var j = currentPath.length - 1; j >= i; j --) {
                if (currentPath[j].module.close) currentPath[j].module.close();
                currentPath.splice(j, 1);
            }
        }

        var postRunnable = function () {
            if (lastAutoNavigation) {
                if (lastAutoNavigation.currentModule == currentPath[currentPath.length - 1].module) {
                    push(lastAutoNavigation.name, lastAutoNavigation.childModule, "replace");
                }
            }

            if (currentModule && currentModule.onFinishAsLeaf) {
                currentModule.onFinishAsLeaf(function () {
                    if (callback) callback();
                    updatingPathMemory = false;
                })
            } else {
                if (callback) callback();
                updatingPathMemory = false;
            }
        }

        if (i <= steps.length - 1) {
            var j = i - 1;
            var currentModule = (i >= 1) ? currentPath[i - 1].module : rootModule;

            var next = function () {
                j ++;
                if (j >= steps.length || !currentModule.navigate) {
                    postRunnable();
                    return;
                }

                var name = steps[j];

                if (!name) {
                    next();
                    return;
                }
                currentModule.navigate(name, function (module) {
                    if (!module) {
                        window.history.replaceState("", "", calculateHash());
                        postRunnable();
                        return;
                    }
                    currentPath.push({
                        name: name,
                        module: module
                    });

                    currentModule = module;
                    next();
                });
            };

            next();
        } else {
            postRunnable();
        }
    }

    function calculateHash() {
        var h = "#";
        for (var i = 0; i < currentPath.length; i ++) {
            var step = currentPath[i];
            h += "/" + step.name;
        }

        return h;
    }

    function push(name, module, replace, markIgnore) {
        currentPath.push({
            name: name,
            module: module
        });

        var h = calculateHash();

        if (!replace) {
            if (markIgnore) {
                if (window.location.hash != h){
                    ignoreNextHashChange = true;
                    window.location.hash = h;
                }
            } else {
                window.location.hash = h;
            }
        } else {
            window.history.replaceState("", "", h);
        }
    }

    function onNavigateToChildModule(currentModule, name, childModule, isAuto) {
        if (updatingPathMemory) {
            if (isAuto) {
                lastAutoNavigation = {
                    currentModule: currentModule,
                    name: name,
                    childModule: childModule
                };
            }
            return;
        }

        if (currentModule) {
            var i = currentPath.map(function (a) {
                return a.module;
            }).indexOf(currentModule);

            if (i >= 0) {
                if (i + 1 < currentPath.length) {
                    currentPath.splice(i + 1, currentPath.length - i - 1);
                }
            } else {
                if (currentModule != rootModule) return;
                currentPath = [];
            }
        }

        push(name, childModule, false, "markIgnore");
    };

    function onNavigationModuleClosed(module) {
        if (updatingPathMemory) return;

        var i = currentPath.map(function (a) {
            return a.module;
        }).indexOf(module);
        if (i < 0) return;
        currentPath.splice(i, currentPath.length - i);

        var newHash = calculateHash();
        if (window.location.hash != newHash) {
            ignoreNextHashChange = true;
            window.location.hash = newHash;
        }
    }

    function newUnnavigatableModule() {
        return {
            navigate: function (name, callback) {callback(null);},
            close: function () {}
        }
    }

    function encodeModuleNameForParams(params) {
        var qs = "";
        var first = true;
        for (var name in params) {
            if (!first) qs += "&";
            first = false;
            qs += name + "=" + encodeURIComponent("" + params[name]);
        }

        return "p:" + btoa(qs).replace(/[=]+$/g, "");
    }

    function buildNavigationParamParser(spec) {
        var parser = {};
        for (var key in spec) {

            var value = spec[key];
            if (!value) continue;

            var dataFunc = null;
            var dataName = null;

            if (typeof(value) == "function") {
                dataFunc = value;
            } else if (typeof(value) == "string") {
                dataFunc = NavigationParamHandler[value];
            } else if (typeof(value) == "object") {
                dataName = value.name;
                dataFunc = value.getData || NavigationParamHandler[value.type];
            }
            if (!dataFunc) continue;

            dataName = dataName || key;
            parser[key] = {
                name: dataName,
                getData: dataFunc
            };
        }
        return parser;
    }

    function parseParamsForData(path, parser) {
        var params = path.split(";");
        var data = {};
        var succeeded = false;
        try {
            for (var i = 0; i < params.length; i++) {
                var param = params[i];
                if (param.indexOf(":") < 0) continue;

                var nameValue = param.split(":");
                if (nameValue.length != 2) continue;

                var name = nameValue[0];
                var value = nameValue[1];
                if (value == null || typeof(value) == "undefined" || value == "") continue;

                var handler = parser[name];
                if (!handler) continue;
                try {
                    var dataName = handler.name || name;
                    value = handler.getData && handler.getData(value) || hanlder(value) || value;

                    if (value == null || typeof(value) == "undefined" || value == "") continue;
                    if (handler.isValid && !handler.isValid(value)) continue;

                    data[dataName] = value;
                    succeeded = true;
                } catch (e) {
                }
            }
        } catch (e) {
            console.log("Error when parsing navigation params", e);
            succeeded = false;
        }
        return succeeded ? data : null;
    }

    window.addEventListener("hashchange", handleHashChange, false);

    return {
        setRoot: setRoot,
        onNavigateToChildModule: onNavigateToChildModule,
        onNavigationModuleClosed: onNavigationModuleClosed,
        newUnnavigatableModule: newUnnavigatableModule,
        encodeModuleNameForParams: encodeModuleNameForParams,
        buildNavigationParamParser: buildNavigationParamParser,
        parseParamsForData: parseParamsForData
    }
})();

var GLOBAL_NAVIGATION_PARAM_PATTERN = /^[\w]+\:[\w\,\-\.]+(\;[\w]+\:[\w\,\-\.]+)*$/;
var NavigationParamHandler = {
    String: function (value) {
        return value;
    },
    Date: function (value) {
        var time = parseInt(value, 10);
        if (isNaN(time)) return null;
        if (time == -1262304000000) return null; //NOTE: 1/1/1930 00:00:00 GMT is considered as NULL in TU
        return new Date(time);
    },
    List: function (value) {
        if (value == null || typeof(value) == "undefined") return null;
        var list = value.split(",");
        var isValid = true;
        list.forEach(function (v) {
            if (v == null || !v.length) isValid = false;
        });

        return isValid ? list : null;
    },
    Range: function (value) {
        if (value == null || typeof(value) == "undefined" || value == "") return null;
        var regex = /^((\-?)[\d\.]+)?(to((\-?)[\d\.]+))?$/g;
        if (value.match(regex)) {
            var matcher = regex.exec(value);
            var from = matcher[1];
            if (from != null &&  typeof(from) != "undefined" && isNaN(Number(from))) return null;
            if (typeof(from) == "undefined") from = null;

            var to = matcher[4];
            if (to != null &&  typeof(to) != "undefined" && isNaN(Number(to))) return null;
            if (typeof(to) == "undefined") to = null;

            if (from == null && to == null) return null;

            return {
                from: from,
                to: to
            };

        }
        return null;
    },
    DateRange: function (value) {
        var bound = NavigationParamHandler.Range(value);
        if (!bound) return null;

        if (bound.from != null) {
            bound.from = NavigationParamHandler.Date(bound.from);
        }
        if (bound.to != null) {
            bound.to = NavigationParamHandler.Date(bound.to);
        }
        if (bound.from == null && bound.to == null) return null;

        return bound;
    }
}


/*
Module Inteface = {
    navigate: function (id, callback) {} -> Return module in callback
}
*/


if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-data.js";

(function (_scope) {
    
    
    var latin =["ab", "aberant", "abscidit", "acervo", "ad", "addidit", "adhuc", "adsiduis", "adspirate", "aequalis", "aer", "aera", "aere", "aeris", "aestu", "aetas", "aethera", "aethere", "agitabilis", "aliis", "aliud", "alta", "altae", "alto", "ambitae", "amphitrite", "animal", "animalia", "animalibus", "animus", "ante", "aquae", "arce", "ardentior", "astra", "aurea", "auroram", "austro", "bene", "boreas", "bracchia", "caeca", "caecoque", "caeleste", "caeli", "caelo", "caelum", "caelumque", "caesa", "calidis", "caligine", "campoque", "campos", "capacius", "carentem", "carmen", "cepit", "certis", "cesserunt", "cetera", "chaos:", "cingebant", "cinxit", "circumdare", "circumfluus", "circumfuso", "coegit", "coeperunt", "coeptis", "coercuit", "cognati", "colebat", "concordi", "congeriem", "congestaque", "consistere", "contraria", "conversa", "convexi", "cornua", "corpora", "corpore", "crescendo", "cum", "cuncta", "cura", "declivia", "dedit", "deducite", "deerat", "dei", "densior", "deorum", "derecti", "descenderat", "deus", "dextra", "di", "dicere", "diffundi", "diremit", "discordia", "dispositam", "dissaepserat", "dissociata", "distinxit", "diu", "diversa", "diverso", "divino", "dixere", "dominari", "duae", "duas", "duris", "effervescere", "effigiem", "egens", "elementaque", "emicuit", "ensis", "eodem", "erant", "erat", "erat:", "erectos", "est", "et", "eurus", "evolvit", "exemit", "extendi", "fabricator", "facientes", "faecis", "fecit", "feras", "fert", "fidem", "figuras", "finxit", "fixo", "flamina", "flamma", "flexi", "fluminaque", "fontes", "foret", "forma", "formaeque", "formas", "fossae", "fratrum", "freta", "frigida", "frigore", "fronde", "fuerant", "fuerat", "fuit", "fulgura", "fulminibus", "galeae", "gentes", "glomeravit", "grandia", "gravitate", "habendum", "habentem", "habentia", "habitabilis", "habitandae", "haec", "hanc", "his", "homini", "hominum", "homo", "horrifer", "humanas", "hunc", "iapeto", "ignea", "igni", "ignotas", "illas", "ille", "illi", "illic", "illis", "imagine", "in", "inclusum", "indigestaque", "induit", "iners", "inmensa", "inminet", "innabilis", "inposuit", "instabilis", "inter", "invasit", "ipsa", "ita", "iudicis", "iuga", "iunctarum", "iussit", "lacusque", "lanient", "lapidosos", "lege", "legebantur", "levitate", "levius", "liberioris", "librata", "ligavit:", "limitibus", "liquidas", "liquidum", "litem", "litora", "locavit", "locis", "locoque", "locum", "longo", "lucis", "lumina", "madescit", "magni", "manebat", "mare", "margine", "matutinis", "mea", "media", "meis", "melior", "melioris", "membra", "mentes", "mentisque", "metusque", "militis", "minantia", "mixta", "mixtam", "moderantum", "modo", "moles", "mollia", "montes", "montibus", "mortales", "motura", "mundi", "mundo", "mundum", "mutastis", "mutatas", "nabataeaque", "nam", "natura", "naturae", "natus", "ne", "nebulas", "nec", "neu", "nisi", "nitidis", "nix", "non", "nondum", "norant", "nova", "nubes", "nubibus", "nullaque", "nulli", "nullo", "nullus", "numero", "nunc", "nuper", "obliquis", "obsistitur", "obstabatque", "occiduo", "omni", "omnia", "onerosior", "onus", "opifex", "oppida", "ora", "orba", "orbe", "orbem", "orbis", "origine", "origo", "os", "otia", "pace", "parte", "partim", "passim", "pendebat", "peragebant", "peregrinum", "permisit", "perpetuum", "persidaque", "perveniunt", "phoebe", "pinus", "piscibus", "plagae", "pluvialibus", "pluviaque", "poena", "pondere", "ponderibus", "pondus", "pontus", "porrexerat", "possedit", "posset:", "postquam", "praebebat", "praecipites", "praeter", "premuntur", "pressa", "prima", "primaque", "principio", "pro", "pronaque", "proxima", "proximus", "pugnabant", "pulsant", "quae", "quam", "quanto", "quarum", "quem", "qui", "quia", "quicquam", "quin", "quinta", "quisque", "quisquis", "quod", "quoque", "radiis", "rapidisque", "recens", "recepta", "recessit", "rectumque", "regat", "regio", "regna", "reparabat", "rerum", "retinebat", "ripis", "rudis", "sanctius", "sata", "satus", "scythiam", "secant", "secrevit", "sectamque", "secuit", "securae", "sed", "seductaque", "semina", "semine", "septemque", "sibi", "sic", "siccis", "sidera", "silvas", "sine", "sinistra", "sive", "sole", "solidumque", "solum", "sorbentur", "speciem", "spectent", "spisso", "sponte", "stagna", "sua", "subdita", "sublime", "subsidere", "sui", "suis", "summaque", "sunt", "super", "supplex", "surgere", "tanta", "tanto", "tegi", "tegit", "tellure", "tellus", "temperiemque", "tempora", "tenent", "tepescunt", "terra", "terrae", "terram", "terrarum", "terras", "terrenae", "terris", "timebat", "titan", "tollere", "tonitrua", "totidem", "totidemque", "toto", "tractu", "traxit", "triones", "tuba", "tum", "tumescere", "turba", "tuti", "ubi", "ulla", "ultima", "umentia", "umor", "unda", "undae", "undas", "undis", "uno", "unus", "usu", "ut", "utque", "utramque", "valles", "ventis", "ventos", "verba", "vesper", "videre", "vindice", "vis", "viseret", "vix", "volucres", "vos", "vultus", "zephyro", "zonae"];

    // just switch language like this! You can also do this in a script block on the page.
    var loremLang = latin;

    /* Characters to end a sentence with. Repeat for frequencies (i.e. most sentences end in a period) */
    var endings = "................................??!";

    /* randomly returns true with a certain chance (a percentage) */
    function chance(percentage){
        return (Math.floor(Math.random() * 100) < percentage);
    }

    /* capitalizes a word */
    function capitalize(aString){
        return aString.substring(0,1).toUpperCase() + aString.substring(1, aString.length);
    }

    /* returns a random lorem word */
    function getLoremWord(){
        return loremLang[Math.floor(Math.random()*loremLang.length)];
    }

    function getLoremEnding(){
        var i = Math.floor(Math.random()*endings.length);
        return endings.substring(i, i+1);
    }

    /* inserts a number of lorem words. Does not append a space at the end. */
    function loremIpsum(numWords){
        var s = "";
        for(var i=0; i<numWords-1; i++){
            s += getLoremWord() + " ";
        }
        s += getLoremWord();

        return s;
    }

    /* inserts a sentence of random words. Appends a space at the end. */
    function loremIpsumSentence(numWords){
        var s = "";
        s += capitalize(getLoremWord()) + " ";
        s += loremIpsum(numWords-1);
        s += getLoremEnding();
        s += " ";

        return s;
    }

    /* inserts a sentence of random words, sometimes with extra punctuation. Appends a space at the end. */
    function loremIpsumSentence2(numWords){
        var s = "";
        s += capitalize(getLoremWord()) + " ";
        var part1 = 0;
        if(chance(50)){
            // insert a comma or other punctuation within the sentence
            part1 = Math.floor(Math.random() * numWords-2);
            s += loremIpsum(part1);
            s += ", ";
        } else {
            s += " ";
        }
        s += loremIpsum(numWords - part1 - 1);
        s += getLoremEnding();
        s += " ";

        return s;
    }

    /* inserts a paragraph of sentences of random words. */
    function loremIpsumParagraph(numWords){
        var s = "";
        var words = numWords;
        while(words > 0){
            if(words > 10){
                w = Math.floor(Math.random() * 8) + 2;
                s += loremIpsumSentence2(w);
                words = words - w;
            } else {
                s += loremIpsumSentence2(words);
                words = 0;
            }
        }

        return s;
    }
    //randomizer
    var DataRandomizer = {
        randomize: function (schema, c) {
            if (!schema) return schema;
            var context = c || {};
            if (typeof(schema.randomize) == "function") return schema.randomize(context);
            if (typeof(schema) == "object") {
                if (schema instanceof Date) return new Date(schema.getTime());
                if (schema instanceof Array) return schema.map(function (e, i) { return DataRandomizer.randomize(e, context); });
                
                var object = {};
                for (var name in schema) {
                    object[name] = DataRandomizer.randomize(schema[name], context);
                }
                
                return object;
            }
            
            return schema;
        },
        index: function () {
            return {
                randomize: function (context) {
                    return context.index + 1;
                }
            }
        },
        array: function (elementSchema, min, max) {
            return {
                randomize: function (context) {
                    var a = min || 0;
                    var b = max || 100000;
                    var count = Math.round(a + (b - a) * Math.random());
                    
                    var list = [];
                    for (var i = 0; i < count; i ++) list.push(DataRandomizer.randomize(elementSchema, {index: i, parent: context}));
                    
                    return list;
                }
            }
        },
        float: function (min, max) {
            return {
                randomize: function (context) {
                    return Math.round((min + Math.random() * (max - min)) * 100) / 100;
                }
            }
        },
        integer: function (min, max) {
            return {
                randomize: function (context) {
                    return min + Math.round(Math.random() * (max - min));
                }
            }
        },
        boolean: function () {
            return {
                randomize: function (context) {
                    return Math.random() > 0.5;
                }
            }
        },
        oneOf: function (items) {
            return {
                randomize: function (context) {
                    return items[Math.round(Math.random() * (items.length - 1))];
                }
            }
        },
        someOf: function (items, min, max, separator) {
            return {
                randomize: function (context) {
                    min = Math.max(min, 0);
                    max = Math.min(max, items.length);
                    var count = min + Math.round(Math.random() * (max - min));
                    
                    var result = [].concat(items);
                    while (result.length > count) {
                        var index = Math.round(Math.random() * (result.length - 1));
                        result.splice(index, 1);
                    }
                    
                    return separator ? result.join(separator) : result;
                }
            }
        },
        _STRING_GENERATOR: {
            lorem: function (min, max) {
                min = parseInt(min.trim(), 10);
                max = parseInt(max.trim(), 10)
                return capitalize(loremIpsum(min + Math.round(Math.random() * (max - min))));
            },
            float: function (min, max) {
                min = parseFloat(min.trim());
                max = parseFloat(max.trim());
                return min + Math.random() * (max - min);
            },
            integer: function (min, max) {
                min = parseInt(min.trim(), 10);
                max = parseInt(max.trim(), 10)
                return min + Math.round(Math.random() * (max - min));
            },
            uuid: function () {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                  });
            },
            sku: function () {
                return DataRandomizer._STRING_GENERATOR.uuid().substring(0, 12);
            }
        },
        string: function (pattern) {
            return {
                randomize: function (context) {
                    return pattern.replace(/\{([a-z0-9\-]+)\(([^\)]*)\)\}/g, function (all, generator, args) {
                        var f = DataRandomizer._STRING_GENERATOR[generator];
                        if (!f) return all;
                        return f.apply(this, args ? args.split(",") : []);
                    });
                }
            }
        }
    }
    
    
    var productSchema = {
        "id": 0,
        "name": DataRandomizer.string("{lorem(4,10)}"),
        "categoryId": DataRandomizer.oneOf([1, 2, 3]),
        "brandId": DataRandomizer.oneOf([1, 2, 3, 4]),
        "taxExempt": DataRandomizer.boolean(),
        "published": DataRandomizer.boolean(),
        "description": DataRandomizer.string("<p><strong>{lorem(10,20)}</strong></p><p>{lorem(50, 100)}</p><p>{lorem(10, 20)}</p><p>{lorem(100, 300)}</p>"),
        "variants": DataRandomizer.array({
                "id": 0,
                "productItemId": 0,
                "colorId": DataRandomizer.oneOf([1, 2, 3, 4]),
                "imageUrls": DataRandomizer.someOf(["/demo-c/sample/null/545b8156cae3ecb28077c07aa3aa2965_075343-tsm-med.jpg",
                                                    "/demo-c/sample/null/55d430602c56ef6b0d39bbae3a507884_036661-t-thumb.jpg",
                                                    "/demo-c/sample/null/da07349fd13b7d81202795526b00bdf2_071166-tsm-med.jpg",
                                                    "/demo-c/sample/null/649df89fa6be490e2f42654f270207bf_096966-t-thumb.jpg"], 1, 3, ","),
                "options": DataRandomizer.array({
                        "id": 0,
                        "sku": DataRandomizer.string("{sku()}"),
                        "sizeId": DataRandomizer.oneOf([1, 2, 3, 4, 5, 6, 7, 8, 9, 10]),
                        "stock": {
                            "id": 0,
                            "quantity": DataRandomizer.integer(5, 150),
                            "cost": DataRandomizer.float(3, 500),
                            "price": DataRandomizer.float(5, 700)
                        }
                    }, 2, 6),
                "order": 0
            }, 1, 4)
    };
    
    _scope.DataRandomizer = DataRandomizer;
    
})(window);

if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-eventhub.js";

var CommonEvent = (function () {

    function getEventName(moduleName, name) {
        return moduleName + ":" + name;
    }

    function fireEvent(moduleName, eventName, data) {
        Dom.emitEvent(getEventName(moduleName, eventName), window.document.body, {data: data});
    }

    function listener(moduleName, eventName, handler) {
        Dom.registerEvent(window.document.body, getEventName(moduleName, eventName), handler, false);
    }

    function removeEvent(moduleName, eventName, handler) {
        Dom.unregisterEvent(window.document.body, getEventName(moduleName, eventName), handler, false);
    }
    return {
        fireEvent: fireEvent,
        listener: listener,
        removeEvent: removeEvent
    };
})();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-asyncaction.js";

var AsyncAction = (function () {
    var DEFAULT_RESULT_HANDLER = function (state) {
        if (state.resultType == "Redirect") {
            window.location.href = state.redirectURL;
        } else if (state.resultType == "Error") {
            Dialog.error("Error", state.errorMessage);
        } else {
            console.error("Unhandled state result: " + state.resultType);
        }
    };

    var POLLING_INTERVAL = 1000;

    function getActualURL(url) {
        if (!url.match(/legacy.*[\?&]url=([^&]+)/)) return url;
        return decodeURIComponent(RegExp.$1);
    }

    function startHttpRequest(form, onSuccess, onFailed) {
        var formData = form.formData || new URLSearchParams(new FormData(form)).toString();
        var request = new XMLHttpRequest();

        var url = getActualURL(form.action);

        request.open("POST", url, true);
        request.setRequestHeader("X-Rio-AsyncExpected", "true");
        request.setRequestHeader("X-Rio-LegacyWrapped", (url != form.action));
        request.setRequestHeader("Content-Type", form.contentType || "application/x-www-form-urlencoded");
        request.onreadystatechange = function() {
            if (request.readyState != 4) return;

            if (request.status == 200) {
                onSuccess(request.responseText, request);
            } else {
                onFailed(request.status, request.statusText, request);
            }
        };

        request.send(formData);
    }

    function asyncSubmit(form, messageHandlers, providedResultHandler) {
        var resultHandler = providedResultHandler || DEFAULT_RESULT_HANDLER;
        var overlay = new ProgressIndicatorOverlay();
        overlay.busy();

        var onSuccess = function (json) {
            var info = null;

            console.log("JSON", json);

            try {
                info = JSON.parse(json);
            } catch (e) {
                console.error(e);
            }

            console.log(info);

            if (!info) {
                overlay.done();
                return;
            }

            var checker = function () {
                console.log("Checker running...");
                $asyncWorkerManager.getWorkerState(info.uuid, function (state) {
                    console.log("State", state);
                    if (!state) {
                        overlay.done();
                        return;
                    }
                    if(state.stateProgress !== undefined) {
                        overlay.progress(state.stateProgress);
                    }
                    if (state.finished) {
                        overlay.done();
                        resultHandler(state);
                    } else {
                        if (state.activeMessage) {
                            var f = messageHandlers[state.activeMessage.message.messageName];
                            var reply = function (result) {
                                $asyncWorkerManager.replyMessageRequest(state.uuid, state.activeMessage.uuid, result, function () {});
                                setTimeout(checker, POLLING_INTERVAL);
                            }

                            if (!f) {
                                console.error("Unhandled message", state.activeMessage);
                                reply(null);
                            } else {
                                f(state.activeMessage, state, function (handlerResult) {
                                    reply(handlerResult);
                                });
                            }
                        } else {
                            setTimeout(checker, POLLING_INTERVAL);
                        }
                    }
                }, function (e) {
                    console.log("getWorkerState error", e);
                    overlay.done();
                });
            }

            checker();
        };

        var onFailed = function (code, reason, request) {
            overlay.done();
            Dialog.error("Error handling form submission: " + reason);
        };

        startHttpRequest(form, onSuccess, onFailed);
    };

    function asyncDo(list, asyncWorker, callback) {
        var index = -1;
        (function doNext() {
            index ++;
            if (index >= list.length) {
                callback();
                return;
            }

            asyncWorker(list[index], doNext);
        })();
    }

    return {
        asyncSubmit: asyncSubmit,
        asyncDo: asyncDo
    };
})();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/common-xorigin.js";

var CrossOriginUtil = (function () {
    function registerCrossOriginPopup(ownerWindow, popupEntry) {
        if (!ownerWindow._xorigin_initialized || !window._xorigin_this_initialized) {
            ownerWindow._xorigin_initialized = true;
            window._xorigin_this_initialized = true;
            
            ownerWindow._xorigin_popupEntries = [];
            
            ownerWindow.addEventListener("message", function (event) {
                if (ownerWindow.TEAM_INFO && ownerWindow.TEAM_INFO.rootDomainPrefix) {
                    if (event.origin != ownerWindow.TEAM_INFO.rootDomainPrefix) {
                        console.error("Rejected message from bad origin", event);
                    }
                }
                var entry = null;
                ownerWindow._xorigin_popupEntries.forEach(function (e) {
                    if (e.frameWindow == event.source) {
                        entry = e;
                    }
                });
                
                if (!entry) {
                    console.log("Entry not found");
                    return;
                }
                
                handleMessageEvent(entry, event, ownerWindow);
            }, false);
        }
        
        ownerWindow._xorigin_popupEntries.push(popupEntry);
    }
    
    function handleMessageEvent(entry, event, ownerWindow) {
        if (event.data._type == "sys:close") {
            var closePopup = function() {
                entry.nodes.forEach(function (n) {
                    n.parentNode.removeChild(n);
                });
            };
            
            if (entry.handler && entry.handler.onClose) {
                entry.handler.onClose(event.data, function (accepted) {
                    if (accepted) closePopup();
                });
            } else {
                closePopup();
            }
            
            return;
        }
        
        if (entry.handler && entry.handler.onMessage) {
            entry.handler.onMessage(event.data);
        }
    }
    
    
    return {
        findParentWindow: function (uriPatternOrMatcher) {
            var currentWindow = window;
            var m = function (win) {
                if (typeof(uriPatternOrMatcher) == "function") return uriPatternOrMatcher(win);
                return win.location.href.match(uriPatternOrMatcher);
            };
            try {
                while (true) {
                    if (m(currentWindow)) return currentWindow;
                    if (currentWindow == currentWindow.parent) return null;
                    currentWindow = currentWindow.parent;
                }
            } catch (e) {}
        },
        openMessagingBasedPopup: function (url, params, handler, options) {
            var ownerWindow = (options && options.findOwnerWindow && options.findOwnerWindow()) || window.top;
            
            var popupEntry = {
                url: url,
                params: params,
                handler: handler,
                options: options
            };
            registerCrossOriginPopup(ownerWindow, popupEntry);
            
            var overlay = ownerWindow.document.createElement("div");
            overlay.style.cssText = "position: fixed; top: 0px; left: 0px; bottom: 0px; right: 0px; z-index: 1002; background: rgba(0, 0, 0, 0.2);";
            ownerWindow.document.body.appendChild(overlay);
            
            var container = ownerWindow.document.createElement("div");
            var width = Math.round((options && options.getWidth && options.getWidth(ownerWindow)) || (ownerWindow.innerWidth * 0.5));
            var hMargin = Math.round((ownerWindow.innerWidth - width) / 2);
            var height = Math.round((options && options.getHeight && options.getHeight(ownerWindow)) || (ownerWindow.innerHeight * 0.95));
            var vMargin = Math.round((ownerWindow.innerHeight - height) / 2);
            container.style.cssText = "display: flex; flex-direction: column; position: fixed; top: " + vMargin + "px; left: " + hMargin + "px; width: " + width + "px; height: " + height + "px; z-index: 1002; background: #FFF; box-shadow: 0px 0px 7px 3px #00000033;";
            if (options && options.styles && options.styles.container) {
                for (var styleName in options.styles.container) {
                    container.style.setProperty(styleName, options.styles.container[styleName]);
                }
            }
            ownerWindow.document.body.appendChild(container);
            
            var iframe = ownerWindow.document.createElement("iframe");
            iframe.style.cssText = "flex: 1 1 auto; border: none;"
            if (options && options.styles && options.styles.iframe) {
                for (var styleName in options.styles.iframe) {
                    iframe.style.setProperty(styleName, options.styles.iframe[styleName]);
                }
            }
            container.appendChild(iframe);
            iframe.setAttribute("src", url);
            
            popupEntry.nodes = [overlay, container];
            popupEntry.frameWindow = iframe.contentWindow;
            
            if (!options || !options.implicitClose) {
                var closeImage = ownerWindow.document.createElement("img");
                closeImage.style.cssText = "position: absolute; z-index: 1; width: 2em; height: 2em; top: -0.75em; right: -0.75em; border-radius: 50%; background: #999;";
                container.appendChild(closeImage);
                closeImage.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGgAAABoCAYAAAAdHLWhAAAAAXNSR0IArs4c6QAACL5JREFUeJztnWuMXVUVx3+rogHqI21pbbXYEqrUEtQmECuUFrBQkwoJSqJRC9gYDEYTjRoJH9SQGD8ZjdAPIPXJwwQ1lQ8YWkofY5Ui0WZIH9gRWjumEwqpFZCilb8f9jkzN9N773ntfc6+nfNLJpl2zt5r3f2/a519zn4ZkSFpOnAVcDVwDXBBYJP7gU3AZmCrmb0S2N7gIeksSZ+U9FtJr6k5Tkj6jaQbJJ3ZdLs0jqQlkjZIeqVBUXrxsqS7JYWO4PiQdJ2kx5tt/0JslvSRptstKHJp7FZJB5pt60rskbRO0puabk+vSPqCpBeabVuvjEn6bB1tZyErl3QR8GPg4pB2GmQIuNnMng1lYFqoiiV9Cxjm9BUH4HLgb5K+EsqA9wiS9HbgV8By33VHzsPAjWZ23GelXgWStAr4JTDLZ70DxGHgY2b2lK8KvaU4SbcDjzJ1xQE4F9gpaa2vCitHkKQ3Aw8CH63uzmnFj8zslqqVVBJI0izcO6ylVR05TdkCXGtmr5atoLRAkuYBO4BFZeuYIjwBrDazf5UpXEogSe8A/gAsKFN+CvIXYKWZvVS0YOFOQpLWttKKU4SlwCMq8YqokECSzsbl1fcUNdTCcuAhSYXaPPfFScUbgfcXdKxlguuAu4oUKKLmXbhRzpZq3CrpS3kvztVJkPRF4M7SLrV0Y7WZbcq6KFMgSUuBJ4EzfHjVMs4x4AIzO9rvor4pTm5c/te04oRgBnBf1kVZ96AfAOd5caelG9ckt4+e9Exxki7BpbaWsPwbWNgr1XWNIEkG3BvSq5Zxzga+1+uPvVLc54H3BXHnVDYAT9dkqwjDuOH6OlgraVmuKyVNl/RiTZMvfibJJM2UtK8mm3kYlvPJ5Hysg115BfpmTQ7dI5dKU7uzFYdI+yTN7PCrTpHWZInzNrkZlaG5p4f9pkXaJ2l2F7/qEml3lkB31OBE33dRciLtrcGPyexRF3Em+XZ3DX50H5mWdIbC33u6Rk4PkeqMpK6R08Uvk0vNIen++kfSpwIbziVOAyLlEmeSbyFFel3SqaPUkn4f0OgvijRAh09zJf01oF/7JM0p6dv9Af36/mRj5wY0JknPS1pcQaQQE+4LR06HT4uTzxSKF5T0cNMH1U+UcbQAs4EdKiGSmY3hptiOePRnBFiR9Sa5G8ln2IH7TKGYRTIzNxXohoDGUmIRaQS4PGJxUj6eGp0XMFS7cVQlV62perp7RtLckrYXJ77XxSi4CKp7GPscYJu69VQy6IikgyXsjuCmPo0VLZj4ugPne128U9Il04ArazSaMhcYqlGkNK2VFWeIetLaZK43Sc/S3KDcGK7hCt9bJM3HNdzCjEt9iFMqLXpgv0lSQ8ZTQop0EPjQgIoDBFxhV4A03WVFwimY2Si9091BBjdyxolBIPAvUirOaNH6YhIHIIYU18kormEL99KSdPdH4CTlxVmY1BGFOBCfQOBEWmFmzxUtKOk84KSZHS5R9nxgGzC/aNmQxCgQVIikMiSRM0Rk4kA896DJzKfkPakoMYsD8UZQyiium1z4fpKH2MWBeCMoJY0k7w04COJA/AKBewj1KtKgiAPxp7hOSj/bdNLRHY9eHBiMCEqpHEkdr4YGQhwYLIGmJIMkUOUUl/HuLkoGRSAv9x8YPJEGoZPgTZxOBqWzEHsEpa98vD+odkRSkIdgX8QsUDBxUpJ3fVGLFKtAtb0sjV2kGAX6B264ocyY0AJJhfcQSmytTGxHRWydhKoDdkPJP0+bAbuYIsiHOAup8MahI90VnscQilgE8iVOShWRRohIpBhS3BhuzMeXOJ0M/OSRaUDhsX+PpHPiQogDE5FUuJEjiaTnpgGPN2S8yoTFueSbVQqDLdKWpgSqS5yURVQXqfByFQ9sscTpIzUaHcM95xwoWlDVdxquMk97MbAdKLVksiRzUuM7qy1lyc0RlVjRkPjoaynkAVVbIxRy6WMn22Cim/1gGYcLcpTqac3HHt1V0t1+YAX1pLv7x3+TNEPSyYDfhhgXER9QvIuI/yNpBiQRZGbHgN+VcTYnm5NvXyHkvuXbCLO7/SJgexmRks/ymH+XxtmYaDKBpDUBvxFSuY0s6jjvLraNLCTpim5GTdKhwIbbrWCy2dvPga8FNi5J6zMaYY6a2fFqr+LYTOlz/RyYrnpOa4x5O7KZXfyqazuyw5Le2O9LgqSv1uCIFO+GfsNqbkO/7KM/JZ0p90BZB+mWmLGIk9LElpj71eXgja7bMku6Cfhpppp+2AAsAy6syV5ehoE/AzfXZG+NmT0y+T/77Zv9BPDBoC61pGwxs1Xd/tBPoA/gTo5qCct/gcW9TjPuOeRtZruBvl3iFi/c0e+o6b6nn8gdrrEbKLU7VUsmu4BLzez1XhfkOZ7mItzNsj0BxS8vARdmbRmQOavHzJ4GvuzLq5Zxbsyzn0OuaVdmth74SWWXWlJuM7ONeS7MfY6qpDfgToBcWdarFgAeMLNP57240EG3kt6CG5dvj4YuxybcA+nJvAUKn0Qsd9DtLuD8omWnOH/CTZY5UaRQ2aOiF+Ammc8rU34Ksge4zMyOFy1Yam62mR3CvT9rclbqoPAksLyMOFBh8ryZ/R0nUu8RwJatwBVm9s+yFVRa3WBmzwOXMrEup2WC+8zsKjN7tUollZefJKF7NfBQ1bpOI75jZmt9VFSqk9ALSd8FbvNZ5wCyzsy8PdR7FQhA0mW4E3aDb8YXGbuAm8zsGZ+Vel9hZ2Y7gSXAD33XHSkngK+b2TLf4kCACOpE0sXAz4H3hrTTIJuAW5LHjiAEXaNqZk+Z2RLgdqBSbyYyjgCfMbPVIcWpFUnnSLpT0ms1zZIJwYuSviHprKbbMxiS3iVpvaTjjTZ1MQ5J+raktzbdfrUi6XpJDzfb9j05JuleScubbqfGkTsBeZ2kxyT9r0FRXpb0gKRrlTUFtyaC9uLKIDft9kpgFfBh4N2BTe4FHk1+thcdDgjN/wEEY32LEVrzQgAAAABJRU5ErkJggg==";
                closeImage.setAttribute("title", "Close");
                closeImage.onmouseover = function () { closeImage.style.background = "#FF0000";};
                closeImage.onmouseout = function () { closeImage.style.background = "#999";};
                
                closeImage.addEventListener("click", function () {
                    var closePopup = function() {
                        popupEntry.nodes.forEach(function (n) {
                            n.parentNode.removeChild(n);
                        });
                    };
                    
                    if (popupEntry.handler && popupEntry.handler.onClose) {
                        popupEntry.handler.onClose(null, function (accepted) {
                            if (accepted) closePopup();
                        });
                    } else {
                        closePopup();
                    }
                });
            }
        }
    };
})();

if (window) window.__currentScriptPath = "/framework/webui/framework/js/dnd.js";

function DragAndDropManager(container) {
    this.container = container;
    DragAndDropManager.managers.push(this);
}

DragAndDropManager.managers = [];

DragAndDropManager.getManagersAfterValidation = function() {
    var m = [];
    for (var i = 0; i < DragAndDropManager.managers.length; i ++) {
        var manager = DragAndDropManager.managers[i];
        var valid = (manager.sourceContainer && document.body.contains(manager.sourceContainer))
            || (manager.destContainer && document.body.contains(manager.destContainer));
        if (!valid) {
            m.push(manager);
        }
    }
    for (var i = 0; i < m.length; i ++) {
        m[i].destroy();
    }
    return DragAndDropManager.managers;
};

DragAndDropManager.hasOngoingDrag = function () {
    return DragAndDropManager.dragSource;
}
DragAndDropManager.prototype.source = function (sourceContainer) {
    this.sourceContainer = sourceContainer;
    return this;
};
DragAndDropManager.prototype.anchor = function (draggbleAnchorFunction) {
    this.draggbleAnchorFunction = draggbleAnchorFunction;
    return this;
};
DragAndDropManager.prototype.itemInfo = function (itemInfoFunction) {
    this.itemInfoFunction = itemInfoFunction;
    return this;
};
DragAndDropManager.prototype.destination = function (destContainer) {
    this.destContainer = destContainer;
    return this;
};
DragAndDropManager.prototype.dropAt = function (droppableFinderFunction) {
    this.droppableFinderFunction = droppableFinderFunction;
    return this;
};
DragAndDropManager.prototype.canDrop = function (canDropFunction) {
    this.checkAccept = canDropFunction;
    return this;
};
DragAndDropManager.DROP_AT_CONTAINER = function (horizontal, subContainerFinder, itemBoundGetter) {
    var finder = function (event, manager) {
        var nearest = null;
        var d = 0;
        var before = false;

        //get all target containers
        var containers = [];
        function appendContainerRecursive(container) {
            containers.push(container);
            if (subContainerFinder) {
                var subContainers = subContainerFinder(container);
                if (subContainers) {
                    for (var i = 0; i < subContainers.length; i ++) {
                        var subContainer = subContainers[i];
                        appendContainerRecursive(subContainer);
                    }
                }
            }
        }
        appendContainerRecursive(manager.destContainer);

        //find matching containers
        var x = event.clientX;
        var y = event.clientY;
        var smallestContainer = containers.filter(function (container) {
            var rect = container.getBoundingClientRect();

            return rect.left <= x && x <= rect.left + rect.width
                    && rect.top <= y && y <= rect.top + rect.height;
        }).reduce(function (a, b) {
            if (a.contains(b)) return b;
            return a;
        });

        for (var i = 0; i < smallestContainer.childNodes.length; i ++) {
            var child = smallestContainer.childNodes[i];
            if (child.nodeType != Node.ELEMENT_NODE || child == manager.currentDropHintNode || child._isDropHint) continue;

            var rect = itemBoundGetter ? itemBoundGetter(child) : child.getBoundingClientRect();
            var dx = event.clientX - (rect.left + rect.width / 2);
            var dy = event.clientY - (rect.top + rect.height / 2);
            var d2 = Math.sqrt(dx * dx + dy * dy);

            if (!nearest || d > d2) {
                nearest = child;
                d = d2;
                before = horizontal ? (dx < 0) : (dy < 0);
            }
        }

        if (!nearest) {
            return {
                element: smallestContainer,
                mode: DragAndDropManager.DROP_APPEND
            };
        }

        if (before) {
            return {
                nearest: nearest,
                element: nearest,
                mode: DragAndDropManager.DROP_PREV_SIBLING
            };
        } else {
            var next = nearest.nextElementSibling;
            while (next && next._isDropHint) next = next.nextElementSibling;

            if (next) {
                return {
                    nearest: nearest,
                    element: next,
                    mode: DragAndDropManager.DROP_PREV_SIBLING
                };
            } else {
                return {
                    element: smallestContainer,
                    mode: DragAndDropManager.DROP_APPEND
                };
            }
        }
    };

    return finder;
};

DragAndDropManager.prototype.setup = function () {
    if (this.sourceContainer) {
        this.handleMouseDownFunction = this.handleMouseDown.bind(this);
        Dom.registerEvent(this.sourceContainer, "mousedown", this.handleMouseDownFunction, false);
    }
    if (DragAndDropManager.managers.length == 1) {
        Dom.registerEvent(document, "mouseup", DragAndDropManager.handleGlobalMouseUp, false);
        Dom.registerEvent(document, "mousemove", DragAndDropManager.handleGlobalMouseMove, false);
    }
    return this;
};
DragAndDropManager.prototype.destroy = function () {
    if (this.sourceContainer) {
        Dom.unregisterEvent(this.sourceContainer, "mousedown", this.handleMouseDownFunction, false);
    }
    this._removeDragImage();
    this._removeDropHint();
    var index = DragAndDropManager.managers.indexOf(this);
    DragAndDropManager.managers.splice(index, 1);

    if (DragAndDropManager.managers.length == 0) {
        Dom.unregisterEvent(document, "mouseup", DragAndDropManager.handleGlobalMouseUp, false);
        Dom.unregisterEvent(document, "mousemove", DragAndDropManager.handleGlobalMouseMove, false);
    }
};

DragAndDropManager.handleGlobalMouseMove = function (event) {
    var managers = DragAndDropManager.getManagersAfterValidation();
    for (var i = 0; i < managers.length; i ++) {
        managers[i].handleMouseMove(event);
    }
};
DragAndDropManager.handleGlobalMouseUp = function (event) {
    try {
        var managers = DragAndDropManager.getManagersAfterValidation();
        for (var i = 0; i < managers.length; i ++) {
            var manager = managers[i];
            if (manager.destContainer) manager.handleDestinationMouseUp(event);
        }

        if (DragAndDropManager.dragSource) {
            if (DragAndDropManager.draggableDataAccepted) {
                DragAndDropManager.dragSource.handleDragSourceAccepted(event);
            } else {
                DragAndDropManager.dragSource.handleDragSourceCanceled(event);
            }
        }

        for (var i = 0; i < managers.length; i ++) {
            var manager = managers[i];
            manager.handleDragFinished(DragAndDropManager.draggableDataAccepted);
        }
    } finally {
        DragAndDropManager.cleanup();
    }
};
DragAndDropManager.cleanup = function () {
    if (DragAndDropManager.draggable) Dom.removeClass(DragAndDropManager.draggable, "CurrentDraggable");
    DragAndDropManager.draggable = null;
    DragAndDropManager.draggedData = null;
    DragAndDropManager.dragSource = null;
    DragAndDropManager.draggableDataAccepted = false;
}
DragAndDropManager.prototype._findDraggableInfo = function (event) {
    var element = null;

    try {
        element = Dom.findUpward(event.target, function (node) {
            var draggable = this.draggbleAnchorFunction(node);
            if (draggable) return true;
            return false;
        }.bind(this));
    } catch (e) {
        console.error(e);
        return null;
    }

    if (!element) return null;
    var info = this.itemInfoFunction(element);

    return info;
};
DragAndDropManager.prototype._findDropTarget = function (event) {
    var dropTarget = this.droppableFinderFunction(event, this);

    return dropTarget;
};
DragAndDropManager.prototype.handleDragFinished = function (accepted) {
    if (this.autoScrollTimer) {
        window.clearTimeout(this.autoScrollTimer);
        this.autoScrollTimer = null;
    }
    if (this.dropAimedTimer) {
        window.clearTimeout(this.dropAimedTimer);
        this.dropAimedTimer = null;
    }

    this._removeDropHint();

    if (this.onDragFinished) this.onDragFinished(accepted);
    BaseWidget.unregisterClosable(this);
};
DragAndDropManager.prototype.handleMouseDown = function (event) {
    if (this.dropAimedTimer) {
        window.clearTimeout(this.dropAimedTimer);
        this.dropAimedTimer = null;
    }

    if (!this.sourceContainer) return;

    var draggableInfo = this._findDraggableInfo(event);
    if (!draggableInfo) return;

    Dom.cancelEvent(event);

    /*
     * storing these into global scope to enable cross-manager dragging
     */
    DragAndDropManager.draggable = draggableInfo.element;
    DragAndDropManager.draggedData = draggableInfo.data;
    DragAndDropManager.dragSource = this;
    DragAndDropManager.draggableDataAccepted = false;

    DragAndDropManager.draggableSize = {
        width: Dom.getOffsetWidth(DragAndDropManager.draggable),
        height: Dom.getOffsetHeight(DragAndDropManager.draggable)
    };

    var rect = DragAndDropManager.draggable.getBoundingClientRect();
    this.draggableDx = event.clientX - rect.left;
    this.draggableDy = event.clientY - rect.top + (document.body.getBoundingClientRect().top);

    var wrapper = document.createElement("div");
    Dom.addClass(wrapper, "DragImageWrapper");
    wrapper.style.position = "absolute";
    wrapper.style.width = rect.width + "px";
    wrapper.style.height = rect.height + "px";
    wrapper.style.top = rect.top + "px";
    wrapper.style.left = rect.left + "px";
    wrapper.style.cursor = "pointer";
    wrapper.style.boxShadow = "0px 0px 0.2em rgba(0, 0, 0, 0.3)";
    wrapper.style.opacity = 0.9;
    wrapper.appendChild(this.createDragImageNode());

    document.body.appendChild(wrapper);
    this.dragImage = wrapper;
    
    DragAndDropManager.activeDragSource = this;

    BaseWidget.registerClosable(this);

    if (this.onDragStart) this.onDragStart();

    Dom.addClass(DragAndDropManager.draggable, "CurrentDraggable");
};
DragAndDropManager.prototype.handleMouseMove = function (event) {
    if (!DragAndDropManager.hasOngoingDrag()) return;

    if (this == DragAndDropManager.activeDragSource) {
        this._handleDragSourceMouseMove(event);
    }
    if (this.destContainer) {
        this._handleDestinationMouseMove(event);
    }
};
DragAndDropManager.prototype._handleDragSourceMouseMove = function (event) {
    Dom.cancelEvent(event);

    var x = event.clientX - this.draggableDx;
    var y = event.clientY - this.draggableDy;

    this.dragImage.style.left = x + "px";
    this.dragImage.style.top = y + "px";
};
DragAndDropManager.prototype.handleDragSourceAccepted = function (event) {
    Dom.cancelEvent(event);
    this._removeDragImage();

    if (this.onDragAccepted) this.onDragAccepted(DragAndDropManager.draggable, DragAndDropManager.draggedData);
};
DragAndDropManager.prototype.handleDragSourceCanceled = function (event) {
    if (event) Dom.cancelEvent(event);
    this._removeDragImage();

    if (this.onDragCanceled) this.onDragCanceled(DragAndDropManager.draggable, DragAndDropManager.draggedData);
};

DragAndDropManager.DROP_PREV_SIBLING = "prevSibling";
DragAndDropManager.DROP_APPEND = "append";

DragAndDropManager.prototype.close = function () {
    if (DragAndDropManager.dragSource) DragAndDropManager.dragSource.handleDragSourceCanceled();
    for (var i = 0; i < DragAndDropManager.managers.length; i ++) {
        DragAndDropManager.managers[i].handleDragFinished(false);
    }
    DragAndDropManager.cleanup();
};

DragAndDropManager.prototype.handleDestinationMouseUp = function (event) {
    if (this.autoScrollTimer) {
        window.clearTimeout(this.autoScrollTimer);
        this.autoScrollTimer = null;
    }
    if (this.dropAimedTimer) {
        window.clearTimeout(this.dropAimedTimer);
        this.dropAimedTimer = null;
    }
    if (!DragAndDropManager.hasOngoingDrag()) {
        this._removeDropHint();
        return;
    }

    var rect = this.destContainer.getBoundingClientRect();
    if (event.clientX < rect.left || event.clientX > (rect.left + rect.width)
        || event.clientY < rect.top || event.clientY > (rect.top + rect.height)) {
            this._removeDropHint();
            return;
    }

    var target = this.currentDropTarget;
    this._removeDropHint();
    if (target) {
        if (this.onDrop) this.onDrop(DragAndDropManager.draggable, DragAndDropManager.draggedData, target);
        DragAndDropManager.draggableDataAccepted = true;
    }
};
DragAndDropManager.prototype._removeDropHint = function () {
    if (this.currentDropHintNode) {
        if (this.currentDropHintNode.parentNode) this.currentDropHintNode.parentNode.removeChild(this.currentDropHintNode);
    }

    this.currentDropHintNode = null;
    this.currentDropTarget = null;
};
DragAndDropManager.prototype._removeDragImage = function () {
    if (this.dragImage) {
        if (this.dragImage.parentNode) this.dragImage.parentNode.removeChild(this.dragImage);
    }
    this.dragImage = null;
};
DragAndDropManager.prototype.processDestinationScroll = function (event) {
    var scrollPane = Dom.findUpward(this.destContainer, function (n) {
        return n.scrollHeight > n.offsetHeight;
    });

    if (!scrollPane) return;

    var rect = scrollPane.getBoundingClientRect();
    var delta = 2 * Util.em();
    var shouldScroll = false;
    if (rect.top < event.clientY && rect.top + delta > event.clientY) {
        this.autoScrollDelta = 0 - Math.round(Util.em() * 2);
        shouldScroll = true;
    } else if (rect.top + rect.height > event.clientY && rect.top + rect.height - delta < event.clientY) {
        this.autoScrollDelta = Math.round(Util.em() * 2);
        shouldScroll = true;
    }

    var thiz = this;
    if (shouldScroll) {
        if (!this.autoScrollTimer) {
            this.autoScrollTimer = window.setTimeout(function () {
                thiz.autoScroll();
            }, 100);
        }
    } else {
        window.clearTimeout(this.autoScrollTimer);
        this.autoScrollTimer = null;
    }
};
DragAndDropManager.prototype.autoScroll = function () {
    var scrollPane = Dom.findUpward(this.destContainer, function (n) {
        return n.scrollHeight > n.offsetHeight;
    });

    if (!scrollPane) {
        this.autoScrollTimer = null;
    } else {
        var thiz = this;
        scrollPane.scrollTop += this.autoScrollDelta;
        this.autoScrollTimer = window.setTimeout(function () {
            thiz.autoScroll();
        }, 50);
    }
};

DragAndDropManager.prototype._handleDestinationMouseMove = function (event) {
    if (!DragAndDropManager.hasOngoingDrag()) {
        this._removeDropHint();
        return;
    }

    if (this.checkAccept && !this.checkAccept(DragAndDropManager.draggedData)) {
        this._removeDropHint();
        return;
    }

    var rect = this.destContainer.getBoundingClientRect();
    if (event.clientX < rect.left || event.clientX > (rect.left + rect.width)
        || event.clientY < rect.top || event.clientY > (rect.top + rect.height)) {
            this._removeDropHint();
            return;
    }

    this.processDestinationScroll(event);

    var dropTarget = this._findDropTarget(event);
    if (!dropTarget) {
        this._removeDropHint();
        this.currentDropTarget = null;
        return;
    }

    if (this.onAimed && dropTarget.nearest) {
        if (this.dropAimedTimer) {
            window.clearTimeout(this.dropAimedTimer);
            this.dropAimedTimer = null;
        }

        var thiz = this;
        this.dropAimedTimer = window.setTimeout(function () {
            thiz.onAimed(dropTarget.nearest);
            thiz.dropAimedTimer = null;
        }, 500);
    }


    if (this.currentDropTarget != null) {
        if (this.currentDropTarget.element == dropTarget.element
                && this.currentDropTarget.mode == dropTarget.mode) {
            return;
        }
    }

    var node = this.currentDropHintNode;
    if (node) {
        if (node.parentNode) node.parentNode.removeChild(node);
    } else {
        node = this.createDropHintNode();
        node._isDropHint = true;
        this.currentDropHintNode = node;
    }

    if (dropTarget.mode == DragAndDropManager.DROP_PREV_SIBLING) {
        dropTarget.element.parentNode.insertBefore(node, dropTarget.element);
    } else {
        dropTarget.element.appendChild(node);
    }

    this.currentDropTarget = dropTarget;
};
DragAndDropManager.prototype.createDragImageNode = function () {
    return DragAndDropManager.draggable.cloneNode(true);
};
DragAndDropManager.prototype.createDropHintNode = function () {
    var node = DragAndDropManager.draggable.cloneNode(true);
    return node;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/color.js";

function Color() {
    this.r = 0;
    this.g = 0;
    this.b = 0;
    this.a = 1.0;
}
Color.REG_EX = /^#([0-9A-F]{2,2})([0-9A-F]{2,2})([0-9A-F]{2,2})([0-9A-F]{2,2})$/i;
Color.REG_EX_NO_ALPHA = /^#([0-9A-F]{2,2})([0-9A-F]{2,2})([0-9A-F]{2,2})$/i;
Color.REG_EX_RGB = /^rgb\(([0-9]+)\,[ ]*([0-9]+)\,[ ]*([0-9]+)\)$/i;
Color.REG_EX_RGBA = /^rgba\(([0-9]+)\,[ ]*([0-9]+)\,[ ]*([0-9]+)\,[ ]*([0-9\.]+)\)$/i;
Color.hexdig = '0123456789ABCDEF';

Color.fromString = function (literal) {
    var color = new Color();
    if (!literal) literal = "#ffffffff";

    if (literal.match(Color.REG_EX)) {
        color.r = parseInt(RegExp.$1, 16);
        color.g = parseInt(RegExp.$2, 16);
        color.b = parseInt(RegExp.$3, 16);
        color.a = parseInt(RegExp.$4, 16) / 255;
    } else if (literal.match(Color.REG_EX_NO_ALPHA)) {
        color.r = parseInt(RegExp.$1, 16);
        color.g = parseInt(RegExp.$2, 16);
        color.b = parseInt(RegExp.$3, 16);
        color.a = 1;
    } else if (literal.match(Color.REG_EX_RGBA)) {
        //debug("found rgba()");
        color.r = parseInt(RegExp.$1, 10);
        color.g = parseInt(RegExp.$2, 10);
        color.b = parseInt(RegExp.$3, 10);
        color.a = parseFloat(RegExp.$4, 10);;
        //debug("found rgba(): " + color);
    } else if (literal.match(Color.REG_EX_RGB)) {
        //debug("found rgb()");
        color.r = parseInt(RegExp.$1, 10);
        color.g = parseInt(RegExp.$2, 10);
        color.b = parseInt(RegExp.$3, 10);
        color.a = 1;
        //debug("found rgb(): " + color);
    } if (literal == "transparent") {
        color.r = 0;
        color.g = 0;
        color.b = 0;
        color.a = 0;
        //debug("transparent");
    }

    return color;
};
Color.fromHSV = function (h, s, v) {
    return Color.fromHSVA(h, s, v, 1);
};
Color.fromHSVA = function (h, s, v, a) {
    var rgb = Color.HSV2RGB({hue: h, saturation: s, value: v});
    var color = new Color();

    color.r = rgb.r;
    color.g = rgb.g;
    color.b = rgb.b;
    color.a = a;

    return color;
};
Color.Dec2Hex = function(d) {
    return Color.hexdig.charAt((d-(d%16))/16)+Color.hexdig.charAt(d%16);
}
Color.Hex2Dec = function(h) {
    return parseInt(h, 16);
}

Color.RGB2Hex = function(r,g,b) {
    return Color.Dec2Hex(r) + Color.Dec2Hex(g) + Color.Dec2Hex(b);
}

// RGB2HSV and HSV2RGB are based on Color Match Remix [http://color.twysted.net/]
// which is based on or copied from ColorMatch 5K [http://colormatch.dk/]
Color.HSV2RGB = function(hsv) {
    var rgb = new Object();
    if (hsv.saturation == 0) {
        rgb.r = rgb.g = rgb.b = Math.round(hsv.value * 2.55);
    } else {
        hsv.hue /= 60;
        hsv.saturation /= 100;
        hsv.value /= 100;
        var i = Math.floor(hsv.hue);
        var f = hsv.hue - i;
        var p = hsv.value * (1 - hsv.saturation);
        var q = hsv.value * (1 - hsv.saturation * f);
        var t = hsv.value * (1 - hsv.saturation * (1 - f));
        switch(i) {
        case 0: rgb.r=hsv.value; rgb.g=t; rgb.b=p; break;
        case 1: rgb.r=q; rgb.g=hsv.value; rgb.b=p; break;
        case 2: rgb.r=p; rgb.g=hsv.value; rgb.b=t; break;
        case 3: rgb.r=p; rgb.g=q; rgb.b=hsv.value; break;
        case 4: rgb.r=t; rgb.g=p; rgb.b=hsv.value; break;
        default: rgb.r=hsv.value; rgb.g=p; rgb.b=q;
        }
        rgb.r=Math.round(rgb.r*255);
        rgb.g=Math.round(rgb.g*255);
        rgb.b=Math.round(rgb.b*255);
    }
    return rgb;
}

Color.min3 = function(a,b,c) { return (a<b)?((a<c)?a:c):((b<c)?b:c); }
Color.max3 = function(a,b,c) { return (a>b)?((a>c)?a:c):((b>c)?b:c); }

Color.RGB2HSV = function(rgb) {
    var hsv = new Object();
    var max=Color.max3(rgb.r,rgb.g,rgb.b);
    var dif=max-Color.min3(rgb.r,rgb.g,rgb.b);
    hsv.saturation=(max==0.0)?0:(100*dif/max);
    if (hsv.saturation==0) hsv.hue=0;
    else if (rgb.r==max) hsv.hue=60.0*(rgb.g-rgb.b)/dif;
    else if (rgb.g==max) hsv.hue=120.0+60.0*(rgb.b-rgb.r)/dif;
    else if (rgb.b==max) hsv.hue=240.0+60.0*(rgb.r-rgb.g)/dif;
    if (hsv.hue<0.0) hsv.hue+=360.0;
    hsv.value=Math.round(max*100/255);
    hsv.hue=Math.round(hsv.hue);
    hsv.saturation=Math.round(hsv.saturation);
    return hsv;
}
Color.prototype.toString = function () {
    return this.toRGBString() + Color.Dec2Hex(Math.min(255, Math.round(this.a * 255)));
};
Color.prototype.toRGBString = function () {
    return "#" + Color.Dec2Hex(this.r) + Color.Dec2Hex(this.g) + Color.Dec2Hex(this.b);
};
Color.prototype.toRGBAString = function () {
    return "rgba(" + this.r + ", " + this.g + ", " + this.b + ", " + (Math.round(this.a * 100) / 100) + ")";
};
Color.prototype.shaded = function (percent) {
    var hsv = Color.RGB2HSV(this);
    hsv.value = Math.max(Math.min(hsv.value * (1 - percent), 100), 0);


    var rgb = Color.HSV2RGB(hsv);

    var color = new Color();
    color.r = rgb.r;
    color.g = rgb.g;
    color.b = rgb.b;

    color.a = this.a;
    return color;
};
Color.prototype.hollowed = function (percent) {
    var color = new Color();
    color.r = this.r;
    color.g = this.g;
    color.b = this.b;

    color.a = Math.max(Math.min(this.a * (1 - percent), 1), 0);
    return color;
};
Color.prototype.inverse = function () {
    var color = new Color();

    color.r = 255 - this.r;
    color.g = 255 - this.g;
    color.b = 255 - this.b;
    color.a = this.a;

    return color;
};
Color.prototype.getHSV = function () {
    return Color.RGB2HSV(this); //h: 0..359, s: 0..100, v: 0..100
};
Color.prototype.transparent = function () {
    var color = new Color();
    color.r = this.r;
    color.g = this.g;
    color.b = this.b;

    color.a = 0;
    return color;
};

Color.prototype.generateTransformTo = function (other) {
    if (!other) return null;
    var hsv0 = Color.RGB2HSV(this);
    var hsv1 = Color.RGB2HSV(other);

    const ALLOWED_DELTA = 5;
    if (Math.abs(hsv0.hue - hsv1.hue) < ALLOWED_DELTA && Math.abs(hsv0.saturation - hsv1.saturation) < ALLOWED_DELTA) {
        var transform = "";

        if (Math.abs(hsv0.value - hsv1.value) >= ALLOWED_DELTA / 3) {
            if (hsv0.value == 0) return null;
            transform += ".shaded(" + (1 - (hsv1.value / hsv0.value)) + ")";
        }

        if (Math.abs(this.a - other.a) >= 0.05) {
            if (this.a == 0) return null;
            transform += ".hollowed(" + (1 - (other.a / this.a)) + ")";
        }

        return transform;
    }

    return null;
}
Color.prototype.getDiff = function (other) {
    if (!other) return 1;
    var hsv0 = Color.RGB2HSV(this);
    var hsv1 = Color.RGB2HSV(other);

    return (Math.abs(hsv0.hue - hsv1.hue) / (255 * 4))
            + (Math.abs(hsv0.saturation - hsv1.saturation) / (255 * 4))
            + (Math.abs(hsv0.value - hsv1.value) / (100 * 4))
            + (Math.abs(this.a - other.a) / 4);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/stacktrace.js";

// Domain Public by Eric Wendelin http://www.eriwen.com/ (2008)
//                  Luke Smith http://lucassmith.name/ (2008)
//                  Loic Dachary <loic@dachary.org> (2008)
//                  Johan Euphrosine <proppy@aminche.com> (2008)
//                  Oyvind Sean Kinsey http://kinsey.no/blog (2010)
//                  Victor Homyakov <victor-homyakov@users.sourceforge.net> (2010)
/*global module, exports, define, ActiveXObject*/
(function(global, factory) {
    if (typeof exports === 'object') {
        // Node
        module.exports = factory();
    } else if (typeof define === 'function' && define.amd) {
        // AMD
        define(factory);
    } else {
        // Browser globals
        global.printStackTrace = factory();
    }
}(this, function() {
    /**
     * Main function giving a function stack trace with a forced or passed in Error
     *
     * @cfg {Error} e The error to create a stacktrace from (optional)
     * @cfg {Boolean} guess If we should try to resolve the names of anonymous functions
     * @return {Array} of Strings with functions, lines, files, and arguments where possible
     */
    function printStackTrace(options) {
        options = options || {guess: true};
        var ex = options.e || null, guess = !!options.guess;
        var p = new printStackTrace.implementation(), result = p.run(ex);
        return (guess) ? p.guessAnonymousFunctions(result) : result;
    }

    printStackTrace.implementation = function() {
    };

    printStackTrace.implementation.prototype = {
        /**
         * @param {Error} [ex] The error to create a stacktrace from (optional)
         * @param {String} [mode] Forced mode (optional, mostly for unit tests)
         */
        run: function(ex, mode) {
            ex = ex || this.createException();
            mode = mode || this.mode(ex);
            if (mode === 'other') {
                return this.other(arguments.callee);
            } else {
                return this[mode](ex);
            }
        },

        createException: function() {
            try {
                this.undef();
            } catch (e) {
                return e;
            }
        },

        /**
         * Mode could differ for different exception, e.g.
         * exceptions in Chrome may or may not have arguments or stack.
         *
         * @return {String} mode of operation for the exception
         */
        mode: function(e) {
            if (e['arguments'] && e.stack) {
                return 'chrome';
            }

            if (e.stack && e.sourceURL) {
                return 'safari';
            }

            if (e.stack && e.number) {
                return 'ie';
            }

            if (e.stack && e.fileName) {
                return 'firefox';
            }

            if (e.message && e['opera#sourceloc']) {
                // e.message.indexOf("Backtrace:") > -1 -> opera9
                // 'opera#sourceloc' in e -> opera9, opera10a
                // !e.stacktrace -> opera9
                if (!e.stacktrace) {
                    return 'opera9'; // use e.message
                }
                if (e.message.indexOf('\n') > -1 && e.message.split('\n').length > e.stacktrace.split('\n').length) {
                    // e.message may have more stack entries than e.stacktrace
                    return 'opera9'; // use e.message
                }
                return 'opera10a'; // use e.stacktrace
            }

            if (e.message && e.stack && e.stacktrace) {
                // e.stacktrace && e.stack -> opera10b
                if (e.stacktrace.indexOf("called from line") < 0) {
                    return 'opera10b'; // use e.stacktrace, format differs from 'opera10a'
                }
                // e.stacktrace && e.stack -> opera11
                return 'opera11'; // use e.stacktrace, format differs from 'opera10a', 'opera10b'
            }

            if (e.stack && !e.fileName) {
                // Chrome 27 does not have e.arguments as earlier versions,
                // but still does not have e.fileName as Firefox
                return 'chrome';
            }

            return 'other';
        },

        /**
         * Given a context, function name, and callback function, overwrite it so that it calls
         * printStackTrace() first with a callback and then runs the rest of the body.
         *
         * @param {Object} context of execution (e.g. window)
         * @param {String} functionName to instrument
         * @param {Function} callback function to call with a stack trace on invocation
         */
        instrumentFunction: function(context, functionName, callback) {
            context = context || window;
            var original = context[functionName];
            context[functionName] = function instrumented() {
                callback.call(this, printStackTrace().slice(4));
                return context[functionName]._instrumented.apply(this, arguments);
            };
            context[functionName]._instrumented = original;
        },

        /**
         * Given a context and function name of a function that has been
         * instrumented, revert the function to it's original (non-instrumented)
         * state.
         *
         * @param {Object} context of execution (e.g. window)
         * @param {String} functionName to de-instrument
         */
        deinstrumentFunction: function(context, functionName) {
            if (context[functionName].constructor === Function &&
                context[functionName]._instrumented &&
                context[functionName]._instrumented.constructor === Function) {
                context[functionName] = context[functionName]._instrumented;
            }
        },

        /**
         * Given an Error object, return a formatted Array based on Chrome's stack string.
         *
         * @param e - Error object to inspect
         * @return Array<String> of function calls, files and line numbers
         */
        chrome: function(e) {
            return (e.stack + '\n')
                .replace(/^[\s\S]+?\s+at\s+/, ' at ') // remove message
                .replace(/^\s+(at eval )?at\s+/gm, '') // remove 'at' and indentation
                .replace(/^([^\(]+?)([\n$])/gm, '{anonymous}() ($1)$2')
                .replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm, '{anonymous}() ($1)')
                .replace(/^(.+) \((.+)\)$/gm, '$1@$2')
                .split('\n')
                .slice(0, -1);
        },

        /**
         * Given an Error object, return a formatted Array based on Safari's stack string.
         *
         * @param e - Error object to inspect
         * @return Array<String> of function calls, files and line numbers
         */
        safari: function(e) {
            return e.stack.replace(/\[native code\]\n/m, '')
                .replace(/^(?=\w+Error\:).*$\n/m, '')
                .replace(/^@/gm, '{anonymous}()@')
                .split('\n');
        },

        /**
         * Given an Error object, return a formatted Array based on IE's stack string.
         *
         * @param e - Error object to inspect
         * @return Array<String> of function calls, files and line numbers
         */
        ie: function(e) {
            return e.stack
                .replace(/^\s*at\s+(.*)$/gm, '$1')
                .replace(/^Anonymous function\s+/gm, '{anonymous}() ')
                .replace(/^(.+)\s+\((.+)\)$/gm, '$1@$2')
                .split('\n')
                .slice(1);
        },

        /**
         * Given an Error object, return a formatted Array based on Firefox's stack string.
         *
         * @param e - Error object to inspect
         * @return Array<String> of function calls, files and line numbers
         */
        firefox: function(e) {
            return e.stack.replace(/(?:\n@:0)?\s+$/m, '')
                .replace(/^(?:\((\S*)\))?@/gm, '{anonymous}($1)@')
                .split('\n');
        },

        opera11: function(e) {
            var ANON = '{anonymous}', lineRE = /^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;
            var lines = e.stacktrace.split('\n'), result = [];

            for (var i = 0, len = lines.length; i < len; i += 2) {
                var match = lineRE.exec(lines[i]);
                if (match) {
                    var location = match[4] + ':' + match[1] + ':' + match[2];
                    var fnName = match[3] || "global code";
                    fnName = fnName.replace(/<anonymous function: (\S+)>/, "$1").replace(/<anonymous function>/, ANON);
                    result.push(fnName + '@' + location + ' -- ' + lines[i + 1].replace(/^\s+/, ''));
                }
            }

            return result;
        },

        opera10b: function(e) {
            // "<anonymous function: run>([arguments not available])@file://localhost/G:/js/stacktrace.js:27\n" +
            // "printStackTrace([arguments not available])@file://localhost/G:/js/stacktrace.js:18\n" +
            // "@file://localhost/G:/js/test/functional/testcase1.html:15"
            var lineRE = /^(.*)@(.+):(\d+)$/;
            var lines = e.stacktrace.split('\n'), result = [];

            for (var i = 0, len = lines.length; i < len; i++) {
                var match = lineRE.exec(lines[i]);
                if (match) {
                    var fnName = match[1] ? (match[1] + '()') : "global code";
                    result.push(fnName + '@' + match[2] + ':' + match[3]);
                }
            }

            return result;
        },

        /**
         * Given an Error object, return a formatted Array based on Opera 10's stacktrace string.
         *
         * @param e - Error object to inspect
         * @return Array<String> of function calls, files and line numbers
         */
        opera10a: function(e) {
            // "  Line 27 of linked script file://localhost/G:/js/stacktrace.js\n"
            // "  Line 11 of inline#1 script in file://localhost/G:/js/test/functional/testcase1.html: In function foo\n"
            var ANON = '{anonymous}', lineRE = /Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;
            var lines = e.stacktrace.split('\n'), result = [];

            for (var i = 0, len = lines.length; i < len; i += 2) {
                var match = lineRE.exec(lines[i]);
                if (match) {
                    var fnName = match[3] || ANON;
                    result.push(fnName + '()@' + match[2] + ':' + match[1] + ' -- ' + lines[i + 1].replace(/^\s+/, ''));
                }
            }

            return result;
        },

        // Opera 7.x-9.2x only!
        opera9: function(e) {
            // "  Line 43 of linked script file://localhost/G:/js/stacktrace.js\n"
            // "  Line 7 of inline#1 script in file://localhost/G:/js/test/functional/testcase1.html\n"
            var ANON = '{anonymous}', lineRE = /Line (\d+).*script (?:in )?(\S+)/i;
            var lines = e.message.split('\n'), result = [];

            for (var i = 2, len = lines.length; i < len; i += 2) {
                var match = lineRE.exec(lines[i]);
                if (match) {
                    result.push(ANON + '()@' + match[2] + ':' + match[1] + ' -- ' + lines[i + 1].replace(/^\s+/, ''));
                }
            }

            return result;
        },

        // Safari 5-, IE 9-, and others
        other: function(curr) {
            var ANON = '{anonymous}', fnRE = /function(?:\s+([\w$]+))?\s*\(/, stack = [], fn, args, maxStackSize = 10;
            var slice = Array.prototype.slice;
            while (curr && stack.length < maxStackSize) {
                fn = fnRE.test(curr.toString()) ? RegExp.$1 || ANON : ANON;
                try {
                    args = slice.call(curr['arguments'] || []);
                } catch (e) {
                    args = ['Cannot access arguments: ' + e];
                }
                stack[stack.length] = fn + '(' + this.stringifyArguments(args) + ')';
                try {
                    curr = curr.caller;
                } catch (e) {
                    stack[stack.length] = 'Cannot access caller: ' + e;
                    break;
                }
            }
            return stack;
        },

        /**
         * Given arguments array as a String, substituting type names for non-string types.
         *
         * @param {Arguments,Array} args
         * @return {String} stringified arguments
         */
        stringifyArguments: function(args) {
            var result = [];
            var slice = Array.prototype.slice;
            for (var i = 0; i < args.length; ++i) {
                var arg = args[i];
                if (arg === undefined) {
                    result[i] = 'undefined';
                } else if (arg === null) {
                    result[i] = 'null';
                } else if (arg.constructor) {
                    // TODO constructor comparison does not work for iframes
                    if (arg.constructor === Array) {
                        if (arg.length < 3) {
                            result[i] = '[' + this.stringifyArguments(arg) + ']';
                        } else {
                            result[i] = '[' + this.stringifyArguments(slice.call(arg, 0, 1)) + '...' + this.stringifyArguments(slice.call(arg, -1)) + ']';
                        }
                    } else if (arg.constructor === Object) {
                        result[i] = '#object';
                    } else if (arg.constructor === Function) {
                        result[i] = '#function';
                    } else if (arg.constructor === String) {
                        result[i] = '"' + arg + '"';
                    } else if (arg.constructor === Number) {
                        result[i] = arg;
                    } else {
                        result[i] = '?';
                    }
                }
            }
            return result.join(',');
        },

        sourceCache: {},

        /**
         * @return {String} the text from a given URL
         */
        ajax: function(url) {
            var req = this.createXMLHTTPObject();
            if (req) {
                try {
                    req.open('GET', url, false);
                    //req.overrideMimeType('text/plain');
                    //req.overrideMimeType('text/javascript');
                    req.send(null);
                    //return req.status == 200 ? req.responseText : '';
                    return req.responseText;
                } catch (e) {
                }
            }
            return '';
        },

        /**
         * Try XHR methods in order and store XHR factory.
         *
         * @return {XMLHttpRequest} XHR function or equivalent
         */
        createXMLHTTPObject: function() {
            var xmlhttp, XMLHttpFactories = [
                function() {
                    return new XMLHttpRequest();
                }, function() {
                    return new ActiveXObject('Msxml2.XMLHTTP');
                }, function() {
                    return new ActiveXObject('Msxml3.XMLHTTP');
                }, function() {
                    return new ActiveXObject('Microsoft.XMLHTTP');
                }
            ];
            for (var i = 0; i < XMLHttpFactories.length; i++) {
                try {
                    xmlhttp = XMLHttpFactories[i]();
                    // Use memoization to cache the factory
                    this.createXMLHTTPObject = XMLHttpFactories[i];
                    return xmlhttp;
                } catch (e) {
                }
            }
        },

        /**
         * Given a URL, check if it is in the same domain (so we can get the source
         * via Ajax).
         *
         * @param url {String} source url
         * @return {Boolean} False if we need a cross-domain request
         */
        isSameDomain: function(url) {
            return typeof location !== "undefined" && url.indexOf(location.hostname) !== -1; // location may not be defined, e.g. when running from nodejs.
        },

        /**
         * Get source code from given URL if in the same domain.
         *
         * @param url {String} JS source URL
         * @return {Array} Array of source code lines
         */
        getSource: function(url) {
            // TODO reuse source from script tags?
            if (!(url in this.sourceCache)) {
                this.sourceCache[url] = this.ajax(url).split('\n');
            }
            return this.sourceCache[url];
        },

        guessAnonymousFunctions: function(stack) {
            for (var i = 0; i < stack.length; ++i) {
                var reStack = /\{anonymous\}\(.*\)@(.*)/,
                    reRef = /^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,
                    frame = stack[i], ref = reStack.exec(frame);

                if (ref) {
                    var m = reRef.exec(ref[1]);
                    if (m) { // If falsey, we did not get any file/line information
                        var file = m[1], lineno = m[2], charno = m[3] || 0;
                        if (file && this.isSameDomain(file) && lineno) {
                            var functionName = this.guessAnonymousFunction(file, lineno, charno);
                            stack[i] = frame.replace('{anonymous}', functionName);
                        }
                    }
                }
            }
            return stack;
        },

        guessAnonymousFunction: function(url, lineNo, charNo) {
            var ret;
            try {
                ret = this.findFunctionName(this.getSource(url), lineNo);
            } catch (e) {
                ret = 'getSource failed with url: ' + url + ', exception: ' + e.toString();
            }
            return ret;
        },

        findFunctionName: function(source, lineNo) {
            // FIXME findFunctionName fails for compressed source
            // (more than one function on the same line)
            // function {name}({args}) m[1]=name m[2]=args
            var reFunctionDeclaration = /function\s+([^(]*?)\s*\(([^)]*)\)/;
            // {name} = function ({args}) TODO args capture
            // /['"]?([0-9A-Za-z_]+)['"]?\s*[:=]\s*function(?:[^(]*)/
            var reFunctionExpression = /['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/;
            // {name} = eval()
            var reFunctionEvaluation = /['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/;
            // Walk backwards in the source lines until we find
            // the line which matches one of the patterns above
            var code = "", line, maxLines = Math.min(lineNo, 20), m, commentPos;
            for (var i = 0; i < maxLines; ++i) {
                // lineNo is 1-based, source[] is 0-based
                line = source[lineNo - i - 1];
                commentPos = line.indexOf('//');
                if (commentPos >= 0) {
                    line = line.substr(0, commentPos);
                }
                // TODO check other types of comments? Commented code may lead to false positive
                if (line) {
                    code = line + code;
                    m = reFunctionExpression.exec(code);
                    if (m && m[1]) {
                        return m[1];
                    }
                    m = reFunctionDeclaration.exec(code);
                    if (m && m[1]) {
                        //return m[1] + "(" + (m[2] || "") + ")";
                        return m[1];
                    }
                    m = reFunctionEvaluation.exec(code);
                    if (m && m[1]) {
                        return m[1];
                    }
                }
            }
            return '(?)';
        }
    };

    return printStackTrace;
}));


if (window) window.__currentScriptPath = "/framework/common/json2.js";

/*
    json2.js
    2012-10-08

    Public Domain.

    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.

    See http://www.JSON.org/js.html


    This code should be minified before deployment.
    See http://javascript.crockford.com/jsmin.html

    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO
    NOT CONTROL.


    This file creates a global JSON object containing two methods: stringify
    and parse.

        JSON.stringify(value, replacer, space)
            value       any JavaScript value, usually an object or array.

            replacer    an optional parameter that determines how object
                        values are stringified for objects. It can be a
                        function or an array of strings.

            space       an optional parameter that specifies the indentation
                        of nested structures. If it is omitted, the text will
                        be packed without extra whitespace. If it is a number,
                        it will specify the number of spaces to indent at each
                        level. If it is a string (such as '\t' or '&nbsp;'),
                        it contains the characters used to indent at each level.

            This method produces a JSON text from a JavaScript value.

            When an object value is found, if the object contains a toJSON
            method, its toJSON method will be called and the result will be
            stringified. A toJSON method does not serialize: it returns the
            value represented by the name/value pair that should be serialized,
            or undefined if nothing should be serialized. The toJSON method
            will be passed the key associated with the value, and this will be
            bound to the value

            For example, this would serialize Dates as ISO strings.

                Date.prototype.toJSON = function (key) {
                    function f(n) {
                        // Format integers to have at least two digits.
                        return n < 10 ? '0' + n : n;
                    }

                    return this.getUTCFullYear()   + '-' +
                         f(this.getUTCMonth() + 1) + '-' +
                         f(this.getUTCDate())      + 'T' +
                         f(this.getUTCHours())     + ':' +
                         f(this.getUTCMinutes())   + ':' +
                         f(this.getUTCSeconds())   + 'Z';
                };

            You can provide an optional replacer method. It will be passed the
            key and value of each member, with this bound to the containing
            object. The value that is returned from your method will be
            serialized. If your method returns undefined, then the member will
            be excluded from the serialization.

            If the replacer parameter is an array of strings, then it will be
            used to select the members to be serialized. It filters the results
            such that only members with keys listed in the replacer array are
            stringified.

            Values that do not have JSON representations, such as undefined or
            functions, will not be serialized. Such values in objects will be
            dropped; in arrays they will be replaced with null. You can use
            a replacer function to replace those with JSON values.
            JSON.stringify(undefined) returns undefined.

            The optional space parameter produces a stringification of the
            value that is filled with line breaks and indentation to make it
            easier to read.

            If the space parameter is a non-empty string, then that string will
            be used for indentation. If the space parameter is a number, then
            the indentation will be that many spaces.

            Example:

            text = JSON.stringify(['e', {pluribus: 'unum'}]);
            // text is '["e",{"pluribus":"unum"}]'


            text = JSON.stringify(['e', {pluribus: 'unum'}], null, '\t');
            // text is '[\n\t"e",\n\t{\n\t\t"pluribus": "unum"\n\t}\n]'

            text = JSON.stringify([new Date()], function (key, value) {
                return this[key] instanceof Date ?
                    'Date(' + this[key] + ')' : value;
            });
            // text is '["Date(---current time---)"]'


        JSON.parse(text, reviver)
            This method parses a JSON text to produce an object or array.
            It can throw a SyntaxError exception.

            The optional reviver parameter is a function that can filter and
            transform the results. It receives each of the keys and values,
            and its return value is used instead of the original value.
            If it returns what it received, then the structure is not modified.
            If it returns undefined then the member is deleted.

            Example:

            // Parse the text. Values that look like ISO date strings will
            // be converted to Date objects.

            myData = JSON.parse(text, function (key, value) {
                var a;
                if (typeof value === 'string') {
                    a =
/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);
                    if (a) {
                        return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4],
                            +a[5], +a[6]));
                    }
                }
                return value;
            });

            myData = JSON.parse('["Date(09/09/2001)"]', function (key, value) {
                var d;
                if (typeof value === 'string' &&
                        value.slice(0, 5) === 'Date(' &&
                        value.slice(-1) === ')') {
                    d = new Date(value.slice(5, -1));
                    if (d) {
                        return d;
                    }
                }
                return value;
            });


    This is a reference implementation. You are free to copy, modify, or
    redistribute.
*/

/*jslint evil: true, regexp: true */

/*members "", "\b", "\t", "\n", "\f", "\r", "\"", JSON, "\\", apply,
    call, charCodeAt, getUTCDate, getUTCFullYear, getUTCHours,
    getUTCMinutes, getUTCMonth, getUTCSeconds, hasOwnProperty, join,
    lastIndex, length, parse, prototype, push, replace, slice, stringify,
    test, toJSON, toString, valueOf
*/


// Create a JSON object only if one does not already exist. We create the
// methods in a closure to avoid creating global variables.

if (typeof JSON !== 'object') {
    JSON = {};
}

(function () {
    'use strict';

    function f(n) {
        // Format integers to have at least two digits.
        return n < 10 ? '0' + n : n;
    }

    if (typeof Date.prototype.toJSON !== 'function') {

        Date.prototype.toJSON = function (key) {

            return isFinite(this.valueOf())
                ? this.getUTCFullYear()     + '-' +
                    f(this.getUTCMonth() + 1) + '-' +
                    f(this.getUTCDate())      + 'T' +
                    f(this.getUTCHours())     + ':' +
                    f(this.getUTCMinutes())   + ':' +
                    f(this.getUTCSeconds())   + 'Z'
                : null;
        };

        String.prototype.toJSON      =
            Number.prototype.toJSON  =
            Boolean.prototype.toJSON = function (key) {
                return this.valueOf();
            };
    }

    var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        escapable = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
        gap,
        indent,
        meta = {    // table of character substitutions
            '\b': '\\b',
            '\t': '\\t',
            '\n': '\\n',
            '\f': '\\f',
            '\r': '\\r',
            '"' : '\\"',
            '\\': '\\\\'
        },
        rep;


    function quote(string) {

// If the string contains no control characters, no quote characters, and no
// backslash characters, then we can safely slap some quotes around it.
// Otherwise we must also replace the offending characters with safe escape
// sequences.

        escapable.lastIndex = 0;
        return escapable.test(string) ? '"' + string.replace(escapable, function (a) {
            var c = meta[a];
            return typeof c === 'string'
                ? c
                : '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
        }) + '"' : '"' + string + '"';
    }


    function str(key, holder) {

// Produce a string from holder[key].

        var i,          // The loop counter.
            k,          // The member key.
            v,          // The member value.
            length,
            mind = gap,
            partial,
            value = holder[key];

// If the value has a toJSON method, call it to obtain a replacement value.

        if (value && typeof value === 'object' &&
                typeof value.toJSON === 'function') {
            value = value.toJSON(key);
        }

// If we were called with a replacer function, then call the replacer to
// obtain a replacement value.

        if (typeof rep === 'function') {
            value = rep.call(holder, key, value);
        }

// What happens next depends on the value's type.

        switch (typeof value) {
        case 'string':
            return quote(value);

        case 'number':

// JSON numbers must be finite. Encode non-finite numbers as null.

            return isFinite(value) ? String(value) : 'null';

        case 'boolean':
        case 'null':

// If the value is a boolean or null, convert it to a string. Note:
// typeof null does not produce 'null'. The case is included here in
// the remote chance that this gets fixed someday.

            return String(value);

// If the type is 'object', we might be dealing with an object or an array or
// null.

        case 'object':

// Due to a specification blunder in ECMAScript, typeof null is 'object',
// so watch out for that case.

            if (!value) {
                return 'null';
            }

// Make an array to hold the partial results of stringifying this object value.

            gap += indent;
            partial = [];

// Is the value an array?

            if (Object.prototype.toString.apply(value) === '[object Array]') {

// The value is an array. Stringify every element. Use null as a placeholder
// for non-JSON values.

                length = value.length;
                for (i = 0; i < length; i += 1) {
                    partial[i] = str(i, value) || 'null';
                }

// Join all of the elements together, separated with commas, and wrap them in
// brackets.

                v = partial.length === 0
                    ? '[]'
                    : gap
                    ? '[\n' + gap + partial.join(',\n' + gap) + '\n' + mind + ']'
                    : '[' + partial.join(',') + ']';
                gap = mind;
                return v;
            }

// If the replacer is an array, use it to select the members to be stringified.

            if (rep && typeof rep === 'object') {
                length = rep.length;
                for (i = 0; i < length; i += 1) {
                    if (typeof rep[i] === 'string') {
                        k = rep[i];
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            } else {

// Otherwise, iterate through all of the keys in the object.

                for (k in value) {
                    if (Object.prototype.hasOwnProperty.call(value, k)) {
                        v = str(k, value);
                        if (v) {
                            partial.push(quote(k) + (gap ? ': ' : ':') + v);
                        }
                    }
                }
            }

// Join all of the member texts together, separated with commas,
// and wrap them in braces.

            v = partial.length === 0
                ? '{}'
                : gap
                ? '{\n' + gap + partial.join(',\n' + gap) + '\n' + mind + '}'
                : '{' + partial.join(',') + '}';
            gap = mind;
            return v;
        }
    }

// If the JSON object does not yet have a stringify method, give it one.

    if (typeof JSON.stringify !== 'function') {
        JSON.stringify = function (value, replacer, space) {

// The stringify method takes a value and an optional replacer, and an optional
// space parameter, and returns a JSON text. The replacer can be a function
// that can replace values, or an array of strings that will select the keys.
// A default replacer method can be provided. Use of the space parameter can
// produce text that is more easily readable.

            var i;
            gap = '';
            indent = '';

// If the space parameter is a number, make an indent string containing that
// many spaces.

            if (typeof space === 'number') {
                for (i = 0; i < space; i += 1) {
                    indent += ' ';
                }

// If the space parameter is a string, it will be used as the indent string.

            } else if (typeof space === 'string') {
                indent = space;
            }

// If there is a replacer, it must be a function or an array.
// Otherwise, throw an error.

            rep = replacer;
            if (replacer && typeof replacer !== 'function' &&
                    (typeof replacer !== 'object' ||
                    typeof replacer.length !== 'number')) {
                throw new Error('JSON.stringify');
            }

// Make a fake root object containing our value under the key of ''.
// Return the result of stringifying the value.

            return str('', {'': value});
        };
    }


// If the JSON object does not yet have a parse method, give it one.

    if (typeof JSON.parse !== 'function') {
        JSON.parse = function (text, reviver) {

// The parse method takes a text and an optional reviver function, and returns
// a JavaScript value if the text is a valid JSON text.

            var j;

            function walk(holder, key) {

// The walk method is used to recursively walk the resulting structure so
// that modifications can be made.

                var k, v, value = holder[key];
                if (value && typeof value === 'object') {
                    for (k in value) {
                        if (Object.prototype.hasOwnProperty.call(value, k)) {
                            v = walk(value, k);
                            if (v !== undefined) {
                                value[k] = v;
                            } else {
                                delete value[k];
                            }
                        }
                    }
                }
                return reviver.call(holder, key, value);
            }


// Parsing happens in four stages. In the first stage, we replace certain
// Unicode characters with escape sequences. JavaScript handles many characters
// incorrectly, either silently deleting them, or treating them as line endings.

            text = String(text);
            cx.lastIndex = 0;
            if (cx.test(text)) {
                text = text.replace(cx, function (a) {
                    return '\\u' +
                        ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
                });
            }

// In the second stage, we run the text against regular expressions that look
// for non-JSON patterns. We are especially concerned with '()' and 'new'
// because they can cause invocation, and '=' because it can cause mutation.
// But just to be safe, we want to reject all unexpected forms.

// We split the second stage into 4 regexp operations in order to work around
// crippling inefficiencies in IE's and Safari's regexp engines. First we
// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we
// replace all simple value tokens with ']' characters. Third, we delete all
// open brackets that follow a colon or comma or that begin the text. Finally,
// we look to see that the remaining characters are only whitespace or ']' or
// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.

            if (/^[\],:{}\s]*$/
                    .test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@')
                        .replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']')
                        .replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {

// In the third stage we use the eval function to compile the text into a
// JavaScript structure. The '{' operator is subject to a syntactic ambiguity
// in JavaScript: it can begin a block or an object literal. We wrap the text
// in parens to eliminate the ambiguity.

                j = eval('(' + text + ')');

// In the optional fourth stage, we recursively walk the new structure, passing
// each name/value pair to a reviver function for possible transformation.

                return typeof reviver === 'function'
                    ? walk({'': j}, '')
                    : j;
            }

// If the text is not JSON parseable, then a SyntaxError is thrown.

            throw new SyntaxError('JSON.parse');
        };
    }
}());


if (window) window.__currentScriptPath = "/framework/common/d3/d3.min.js";

// https://d3js.org v5.16.0 Copyright 2020 Mike Bostock
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).d3=t.d3||{})}(this,function(t){"use strict";function n(t,n){return t<n?-1:t>n?1:t>=n?0:NaN}function e(t){var e;return 1===t.length&&(e=t,t=function(t,r){return n(e(t),r)}),{left:function(n,e,r,i){for(null==r&&(r=0),null==i&&(i=n.length);r<i;){var o=r+i>>>1;t(n[o],e)<0?r=o+1:i=o}return r},right:function(n,e,r,i){for(null==r&&(r=0),null==i&&(i=n.length);r<i;){var o=r+i>>>1;t(n[o],e)>0?i=o:r=o+1}return r}}}var r=e(n),i=r.right,o=r.left;function a(t,n){return[t,n]}function u(t){return null===t?NaN:+t}function c(t,n){var e,r,i=t.length,o=0,a=-1,c=0,f=0;if(null==n)for(;++a<i;)isNaN(e=u(t[a]))||(f+=(r=e-c)*(e-(c+=r/++o)));else for(;++a<i;)isNaN(e=u(n(t[a],a,t)))||(f+=(r=e-c)*(e-(c+=r/++o)));if(o>1)return f/(o-1)}function f(t,n){var e=c(t,n);return e?Math.sqrt(e):e}function s(t,n){var e,r,i,o=t.length,a=-1;if(null==n){for(;++a<o;)if(null!=(e=t[a])&&e>=e)for(r=i=e;++a<o;)null!=(e=t[a])&&(r>e&&(r=e),i<e&&(i=e))}else for(;++a<o;)if(null!=(e=n(t[a],a,t))&&e>=e)for(r=i=e;++a<o;)null!=(e=n(t[a],a,t))&&(r>e&&(r=e),i<e&&(i=e));return[r,i]}var l=Array.prototype,h=l.slice,d=l.map;function p(t){return function(){return t}}function v(t){return t}function g(t,n,e){t=+t,n=+n,e=(i=arguments.length)<2?(n=t,t=0,1):i<3?1:+e;for(var r=-1,i=0|Math.max(0,Math.ceil((n-t)/e)),o=new Array(i);++r<i;)o[r]=t+r*e;return o}var y=Math.sqrt(50),_=Math.sqrt(10),b=Math.sqrt(2);function m(t,n,e){var r,i,o,a,u=-1;if(e=+e,(t=+t)===(n=+n)&&e>0)return[t];if((r=n<t)&&(i=t,t=n,n=i),0===(a=x(t,n,e))||!isFinite(a))return[];if(a>0)for(t=Math.ceil(t/a),n=Math.floor(n/a),o=new Array(i=Math.ceil(n-t+1));++u<i;)o[u]=(t+u)*a;else for(t=Math.floor(t*a),n=Math.ceil(n*a),o=new Array(i=Math.ceil(t-n+1));++u<i;)o[u]=(t-u)/a;return r&&o.reverse(),o}function x(t,n,e){var r=(n-t)/Math.max(0,e),i=Math.floor(Math.log(r)/Math.LN10),o=r/Math.pow(10,i);return i>=0?(o>=y?10:o>=_?5:o>=b?2:1)*Math.pow(10,i):-Math.pow(10,-i)/(o>=y?10:o>=_?5:o>=b?2:1)}function w(t,n,e){var r=Math.abs(n-t)/Math.max(0,e),i=Math.pow(10,Math.floor(Math.log(r)/Math.LN10)),o=r/i;return o>=y?i*=10:o>=_?i*=5:o>=b&&(i*=2),n<t?-i:i}function M(t){return Math.ceil(Math.log(t.length)/Math.LN2)+1}function N(t,n,e){if(null==e&&(e=u),r=t.length){if((n=+n)<=0||r<2)return+e(t[0],0,t);if(n>=1)return+e(t[r-1],r-1,t);var r,i=(r-1)*n,o=Math.floor(i),a=+e(t[o],o,t);return a+(+e(t[o+1],o+1,t)-a)*(i-o)}}function T(t,n){var e,r,i=t.length,o=-1;if(null==n){for(;++o<i;)if(null!=(e=t[o])&&e>=e)for(r=e;++o<i;)null!=(e=t[o])&&e>r&&(r=e)}else for(;++o<i;)if(null!=(e=n(t[o],o,t))&&e>=e)for(r=e;++o<i;)null!=(e=n(t[o],o,t))&&e>r&&(r=e);return r}function A(t){for(var n,e,r,i=t.length,o=-1,a=0;++o<i;)a+=t[o].length;for(e=new Array(a);--i>=0;)for(n=(r=t[i]).length;--n>=0;)e[--a]=r[n];return e}function S(t,n){var e,r,i=t.length,o=-1;if(null==n){for(;++o<i;)if(null!=(e=t[o])&&e>=e)for(r=e;++o<i;)null!=(e=t[o])&&r>e&&(r=e)}else for(;++o<i;)if(null!=(e=n(t[o],o,t))&&e>=e)for(r=e;++o<i;)null!=(e=n(t[o],o,t))&&r>e&&(r=e);return r}function k(t){if(!(i=t.length))return[];for(var n=-1,e=S(t,E),r=new Array(e);++n<e;)for(var i,o=-1,a=r[n]=new Array(i);++o<i;)a[o]=t[o][n];return r}function E(t){return t.length}var C=Array.prototype.slice;function P(t){return t}var z=1,R=2,D=3,q=4,L=1e-6;function U(t){return"translate("+(t+.5)+",0)"}function O(t){return"translate(0,"+(t+.5)+")"}function B(){return!this.__axis}function F(t,n){var e=[],r=null,i=null,o=6,a=6,u=3,c=t===z||t===q?-1:1,f=t===q||t===R?"x":"y",s=t===z||t===D?U:O;function l(l){var h=null==r?n.ticks?n.ticks.apply(n,e):n.domain():r,d=null==i?n.tickFormat?n.tickFormat.apply(n,e):P:i,p=Math.max(o,0)+u,v=n.range(),g=+v[0]+.5,y=+v[v.length-1]+.5,_=(n.bandwidth?function(t){var n=Math.max(0,t.bandwidth()-1)/2;return t.round()&&(n=Math.round(n)),function(e){return+t(e)+n}}:function(t){return function(n){return+t(n)}})(n.copy()),b=l.selection?l.selection():l,m=b.selectAll(".domain").data([null]),x=b.selectAll(".tick").data(h,n).order(),w=x.exit(),M=x.enter().append("g").attr("class","tick"),N=x.select("line"),T=x.select("text");m=m.merge(m.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),x=x.merge(M),N=N.merge(M.append("line").attr("stroke","currentColor").attr(f+"2",c*o)),T=T.merge(M.append("text").attr("fill","currentColor").attr(f,c*p).attr("dy",t===z?"0em":t===D?"0.71em":"0.32em")),l!==b&&(m=m.transition(l),x=x.transition(l),N=N.transition(l),T=T.transition(l),w=w.transition(l).attr("opacity",L).attr("transform",function(t){return isFinite(t=_(t))?s(t):this.getAttribute("transform")}),M.attr("opacity",L).attr("transform",function(t){var n=this.parentNode.__axis;return s(n&&isFinite(n=n(t))?n:_(t))})),w.remove(),m.attr("d",t===q||t==R?a?"M"+c*a+","+g+"H0.5V"+y+"H"+c*a:"M0.5,"+g+"V"+y:a?"M"+g+","+c*a+"V0.5H"+y+"V"+c*a:"M"+g+",0.5H"+y),x.attr("opacity",1).attr("transform",function(t){return s(_(t))}),N.attr(f+"2",c*o),T.attr(f,c*p).text(d),b.filter(B).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",t===R?"start":t===q?"end":"middle"),b.each(function(){this.__axis=_})}return l.scale=function(t){return arguments.length?(n=t,l):n},l.ticks=function(){return e=C.call(arguments),l},l.tickArguments=function(t){return arguments.length?(e=null==t?[]:C.call(t),l):e.slice()},l.tickValues=function(t){return arguments.length?(r=null==t?null:C.call(t),l):r&&r.slice()},l.tickFormat=function(t){return arguments.length?(i=t,l):i},l.tickSize=function(t){return arguments.length?(o=a=+t,l):o},l.tickSizeInner=function(t){return arguments.length?(o=+t,l):o},l.tickSizeOuter=function(t){return arguments.length?(a=+t,l):a},l.tickPadding=function(t){return arguments.length?(u=+t,l):u},l}var Y={value:function(){}};function I(){for(var t,n=0,e=arguments.length,r={};n<e;++n){if(!(t=arguments[n]+"")||t in r||/[\s.]/.test(t))throw new Error("illegal type: "+t);r[t]=[]}return new H(r)}function H(t){this._=t}function j(t,n){return t.trim().split(/^|\s+/).map(function(t){var e="",r=t.indexOf(".");if(r>=0&&(e=t.slice(r+1),t=t.slice(0,r)),t&&!n.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})}function X(t,n){for(var e,r=0,i=t.length;r<i;++r)if((e=t[r]).name===n)return e.value}function V(t,n,e){for(var r=0,i=t.length;r<i;++r)if(t[r].name===n){t[r]=Y,t=t.slice(0,r).concat(t.slice(r+1));break}return null!=e&&t.push({name:n,value:e}),t}H.prototype=I.prototype={constructor:H,on:function(t,n){var e,r=this._,i=j(t+"",r),o=-1,a=i.length;if(!(arguments.length<2)){if(null!=n&&"function"!=typeof n)throw new Error("invalid callback: "+n);for(;++o<a;)if(e=(t=i[o]).type)r[e]=V(r[e],t.name,n);else if(null==n)for(e in r)r[e]=V(r[e],t.name,null);return this}for(;++o<a;)if((e=(t=i[o]).type)&&(e=X(r[e],t.name)))return e},copy:function(){var t={},n=this._;for(var e in n)t[e]=n[e].slice();return new H(t)},call:function(t,n){if((e=arguments.length-2)>0)for(var e,r,i=new Array(e),o=0;o<e;++o)i[o]=arguments[o+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=0,e=(r=this._[t]).length;o<e;++o)r[o].value.apply(n,i)},apply:function(t,n,e){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var r=this._[t],i=0,o=r.length;i<o;++i)r[i].value.apply(n,e)}};var G="http://www.w3.org/1999/xhtml",$={svg:"http://www.w3.org/2000/svg",xhtml:G,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function W(t){var n=t+="",e=n.indexOf(":");return e>=0&&"xmlns"!==(n=t.slice(0,e))&&(t=t.slice(e+1)),$.hasOwnProperty(n)?{space:$[n],local:t}:t}function Z(t){var n=W(t);return(n.local?function(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}:function(t){return function(){var n=this.ownerDocument,e=this.namespaceURI;return e===G&&n.documentElement.namespaceURI===G?n.createElement(t):n.createElementNS(e,t)}})(n)}function Q(){}function K(t){return null==t?Q:function(){return this.querySelector(t)}}function J(){return[]}function tt(t){return null==t?J:function(){return this.querySelectorAll(t)}}function nt(t){return function(){return this.matches(t)}}function et(t){return new Array(t.length)}function rt(t,n){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=n}rt.prototype={constructor:rt,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,n){return this._parent.insertBefore(t,n)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}};var it="$";function ot(t,n,e,r,i,o){for(var a,u=0,c=n.length,f=o.length;u<f;++u)(a=n[u])?(a.__data__=o[u],r[u]=a):e[u]=new rt(t,o[u]);for(;u<c;++u)(a=n[u])&&(i[u]=a)}function at(t,n,e,r,i,o,a){var u,c,f,s={},l=n.length,h=o.length,d=new Array(l);for(u=0;u<l;++u)(c=n[u])&&(d[u]=f=it+a.call(c,c.__data__,u,n),f in s?i[u]=c:s[f]=c);for(u=0;u<h;++u)(c=s[f=it+a.call(t,o[u],u,o)])?(r[u]=c,c.__data__=o[u],s[f]=null):e[u]=new rt(t,o[u]);for(u=0;u<l;++u)(c=n[u])&&s[d[u]]===c&&(i[u]=c)}function ut(t,n){return t<n?-1:t>n?1:t>=n?0:NaN}function ct(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function ft(t,n){return t.style.getPropertyValue(n)||ct(t).getComputedStyle(t,null).getPropertyValue(n)}function st(t){return t.trim().split(/^|\s+/)}function lt(t){return t.classList||new ht(t)}function ht(t){this._node=t,this._names=st(t.getAttribute("class")||"")}function dt(t,n){for(var e=lt(t),r=-1,i=n.length;++r<i;)e.add(n[r])}function pt(t,n){for(var e=lt(t),r=-1,i=n.length;++r<i;)e.remove(n[r])}function vt(){this.textContent=""}function gt(){this.innerHTML=""}function yt(){this.nextSibling&&this.parentNode.appendChild(this)}function _t(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function bt(){return null}function mt(){var t=this.parentNode;t&&t.removeChild(this)}function xt(){var t=this.cloneNode(!1),n=this.parentNode;return n?n.insertBefore(t,this.nextSibling):t}function wt(){var t=this.cloneNode(!0),n=this.parentNode;return n?n.insertBefore(t,this.nextSibling):t}ht.prototype={add:function(t){this._names.indexOf(t)<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var n=this._names.indexOf(t);n>=0&&(this._names.splice(n,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};var Mt={};(t.event=null,"undefined"!=typeof document)&&("onmouseenter"in document.documentElement||(Mt={mouseenter:"mouseover",mouseleave:"mouseout"}));function Nt(t,n,e){return t=Tt(t,n,e),function(n){var e=n.relatedTarget;e&&(e===this||8&e.compareDocumentPosition(this))||t.call(this,n)}}function Tt(n,e,r){return function(i){var o=t.event;t.event=i;try{n.call(this,this.__data__,e,r)}finally{t.event=o}}}function At(t){return function(){var n=this.__on;if(n){for(var e,r=0,i=-1,o=n.length;r<o;++r)e=n[r],t.type&&e.type!==t.type||e.name!==t.name?n[++i]=e:this.removeEventListener(e.type,e.listener,e.capture);++i?n.length=i:delete this.__on}}}function St(t,n,e){var r=Mt.hasOwnProperty(t.type)?Nt:Tt;return function(i,o,a){var u,c=this.__on,f=r(n,o,a);if(c)for(var s=0,l=c.length;s<l;++s)if((u=c[s]).type===t.type&&u.name===t.name)return this.removeEventListener(u.type,u.listener,u.capture),this.addEventListener(u.type,u.listener=f,u.capture=e),void(u.value=n);this.addEventListener(t.type,f,e),u={type:t.type,name:t.name,value:n,listener:f,capture:e},c?c.push(u):this.__on=[u]}}function kt(n,e,r,i){var o=t.event;n.sourceEvent=t.event,t.event=n;try{return e.apply(r,i)}finally{t.event=o}}function Et(t,n,e){var r=ct(t),i=r.CustomEvent;"function"==typeof i?i=new i(n,e):(i=r.document.createEvent("Event"),e?(i.initEvent(n,e.bubbles,e.cancelable),i.detail=e.detail):i.initEvent(n,!1,!1)),t.dispatchEvent(i)}var Ct=[null];function Pt(t,n){this._groups=t,this._parents=n}function zt(){return new Pt([[document.documentElement]],Ct)}function Rt(t){return"string"==typeof t?new Pt([[document.querySelector(t)]],[document.documentElement]):new Pt([[t]],Ct)}Pt.prototype=zt.prototype={constructor:Pt,select:function(t){"function"!=typeof t&&(t=K(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,a,u=n[i],c=u.length,f=r[i]=new Array(c),s=0;s<c;++s)(o=u[s])&&(a=t.call(o,o.__data__,s,u))&&("__data__"in o&&(a.__data__=o.__data__),f[s]=a);return new Pt(r,this._parents)},selectAll:function(t){"function"!=typeof t&&(t=tt(t));for(var n=this._groups,e=n.length,r=[],i=[],o=0;o<e;++o)for(var a,u=n[o],c=u.length,f=0;f<c;++f)(a=u[f])&&(r.push(t.call(a,a.__data__,f,u)),i.push(a));return new Pt(r,i)},filter:function(t){"function"!=typeof t&&(t=nt(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,a=n[i],u=a.length,c=r[i]=[],f=0;f<u;++f)(o=a[f])&&t.call(o,o.__data__,f,a)&&c.push(o);return new Pt(r,this._parents)},data:function(t,n){if(!t)return d=new Array(this.size()),f=-1,this.each(function(t){d[++f]=t}),d;var e=n?at:ot,r=this._parents,i=this._groups;"function"!=typeof t&&(t=function(t){return function(){return t}}(t));for(var o=i.length,a=new Array(o),u=new Array(o),c=new Array(o),f=0;f<o;++f){var s=r[f],l=i[f],h=l.length,d=t.call(s,s&&s.__data__,f,r),p=d.length,v=u[f]=new Array(p),g=a[f]=new Array(p);e(s,l,v,g,c[f]=new Array(h),d,n);for(var y,_,b=0,m=0;b<p;++b)if(y=v[b]){for(b>=m&&(m=b+1);!(_=g[m])&&++m<p;);y._next=_||null}}return(a=new Pt(a,r))._enter=u,a._exit=c,a},enter:function(){return new Pt(this._enter||this._groups.map(et),this._parents)},exit:function(){return new Pt(this._exit||this._groups.map(et),this._parents)},join:function(t,n,e){var r=this.enter(),i=this,o=this.exit();return r="function"==typeof t?t(r):r.append(t+""),null!=n&&(i=n(i)),null==e?o.remove():e(o),r&&i?r.merge(i).order():i},merge:function(t){for(var n=this._groups,e=t._groups,r=n.length,i=e.length,o=Math.min(r,i),a=new Array(r),u=0;u<o;++u)for(var c,f=n[u],s=e[u],l=f.length,h=a[u]=new Array(l),d=0;d<l;++d)(c=f[d]||s[d])&&(h[d]=c);for(;u<r;++u)a[u]=n[u];return new Pt(a,this._parents)},order:function(){for(var t=this._groups,n=-1,e=t.length;++n<e;)for(var r,i=t[n],o=i.length-1,a=i[o];--o>=0;)(r=i[o])&&(a&&4^r.compareDocumentPosition(a)&&a.parentNode.insertBefore(r,a),a=r);return this},sort:function(t){function n(n,e){return n&&e?t(n.__data__,e.__data__):!n-!e}t||(t=ut);for(var e=this._groups,r=e.length,i=new Array(r),o=0;o<r;++o){for(var a,u=e[o],c=u.length,f=i[o]=new Array(c),s=0;s<c;++s)(a=u[s])&&(f[s]=a);f.sort(n)}return new Pt(i,this._parents).order()},call:function(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this},nodes:function(){var t=new Array(this.size()),n=-1;return this.each(function(){t[++n]=this}),t},node:function(){for(var t=this._groups,n=0,e=t.length;n<e;++n)for(var r=t[n],i=0,o=r.length;i<o;++i){var a=r[i];if(a)return a}return null},size:function(){var t=0;return this.each(function(){++t}),t},empty:function(){return!this.node()},each:function(t){for(var n=this._groups,e=0,r=n.length;e<r;++e)for(var i,o=n[e],a=0,u=o.length;a<u;++a)(i=o[a])&&t.call(i,i.__data__,a,o);return this},attr:function(t,n){var e=W(t);if(arguments.length<2){var r=this.node();return e.local?r.getAttributeNS(e.space,e.local):r.getAttribute(e)}return this.each((null==n?e.local?function(t){return function(){this.removeAttributeNS(t.space,t.local)}}:function(t){return function(){this.removeAttribute(t)}}:"function"==typeof n?e.local?function(t,n){return function(){var e=n.apply(this,arguments);null==e?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,e)}}:function(t,n){return function(){var e=n.apply(this,arguments);null==e?this.removeAttribute(t):this.setAttribute(t,e)}}:e.local?function(t,n){return function(){this.setAttributeNS(t.space,t.local,n)}}:function(t,n){return function(){this.setAttribute(t,n)}})(e,n))},style:function(t,n,e){return arguments.length>1?this.each((null==n?function(t){return function(){this.style.removeProperty(t)}}:"function"==typeof n?function(t,n,e){return function(){var r=n.apply(this,arguments);null==r?this.style.removeProperty(t):this.style.setProperty(t,r,e)}}:function(t,n,e){return function(){this.style.setProperty(t,n,e)}})(t,n,null==e?"":e)):ft(this.node(),t)},property:function(t,n){return arguments.length>1?this.each((null==n?function(t){return function(){delete this[t]}}:"function"==typeof n?function(t,n){return function(){var e=n.apply(this,arguments);null==e?delete this[t]:this[t]=e}}:function(t,n){return function(){this[t]=n}})(t,n)):this.node()[t]},classed:function(t,n){var e=st(t+"");if(arguments.length<2){for(var r=lt(this.node()),i=-1,o=e.length;++i<o;)if(!r.contains(e[i]))return!1;return!0}return this.each(("function"==typeof n?function(t,n){return function(){(n.apply(this,arguments)?dt:pt)(this,t)}}:n?function(t){return function(){dt(this,t)}}:function(t){return function(){pt(this,t)}})(e,n))},text:function(t){return arguments.length?this.each(null==t?vt:("function"==typeof t?function(t){return function(){var n=t.apply(this,arguments);this.textContent=null==n?"":n}}:function(t){return function(){this.textContent=t}})(t)):this.node().textContent},html:function(t){return arguments.length?this.each(null==t?gt:("function"==typeof t?function(t){return function(){var n=t.apply(this,arguments);this.innerHTML=null==n?"":n}}:function(t){return function(){this.innerHTML=t}})(t)):this.node().innerHTML},raise:function(){return this.each(yt)},lower:function(){return this.each(_t)},append:function(t){var n="function"==typeof t?t:Z(t);return this.select(function(){return this.appendChild(n.apply(this,arguments))})},insert:function(t,n){var e="function"==typeof t?t:Z(t),r=null==n?bt:"function"==typeof n?n:K(n);return this.select(function(){return this.insertBefore(e.apply(this,arguments),r.apply(this,arguments)||null)})},remove:function(){return this.each(mt)},clone:function(t){return this.select(t?wt:xt)},datum:function(t){return arguments.length?this.property("__data__",t):this.node().__data__},on:function(t,n,e){var r,i,o=function(t){return t.trim().split(/^|\s+/).map(function(t){var n="",e=t.indexOf(".");return e>=0&&(n=t.slice(e+1),t=t.slice(0,e)),{type:t,name:n}})}(t+""),a=o.length;if(!(arguments.length<2)){for(u=n?St:At,null==e&&(e=!1),r=0;r<a;++r)this.each(u(o[r],n,e));return this}var u=this.node().__on;if(u)for(var c,f=0,s=u.length;f<s;++f)for(r=0,c=u[f];r<a;++r)if((i=o[r]).type===c.type&&i.name===c.name)return c.value},dispatch:function(t,n){return this.each(("function"==typeof n?function(t,n){return function(){return Et(this,t,n.apply(this,arguments))}}:function(t,n){return function(){return Et(this,t,n)}})(t,n))}};var Dt=0;function qt(){return new Lt}function Lt(){this._="@"+(++Dt).toString(36)}function Ut(){for(var n,e=t.event;n=e.sourceEvent;)e=n;return e}function Ot(t,n){var e=t.ownerSVGElement||t;if(e.createSVGPoint){var r=e.createSVGPoint();return r.x=n.clientX,r.y=n.clientY,[(r=r.matrixTransform(t.getScreenCTM().inverse())).x,r.y]}var i=t.getBoundingClientRect();return[n.clientX-i.left-t.clientLeft,n.clientY-i.top-t.clientTop]}function Bt(t){var n=Ut();return n.changedTouches&&(n=n.changedTouches[0]),Ot(t,n)}function Ft(t,n,e){arguments.length<3&&(e=n,n=Ut().changedTouches);for(var r,i=0,o=n?n.length:0;i<o;++i)if((r=n[i]).identifier===e)return Ot(t,r);return null}function Yt(){t.event.stopImmediatePropagation()}function It(){t.event.preventDefault(),t.event.stopImmediatePropagation()}function Ht(t){var n=t.document.documentElement,e=Rt(t).on("dragstart.drag",It,!0);"onselectstart"in n?e.on("selectstart.drag",It,!0):(n.__noselect=n.style.MozUserSelect,n.style.MozUserSelect="none")}function jt(t,n){var e=t.document.documentElement,r=Rt(t).on("dragstart.drag",null);n&&(r.on("click.drag",It,!0),setTimeout(function(){r.on("click.drag",null)},0)),"onselectstart"in e?r.on("selectstart.drag",null):(e.style.MozUserSelect=e.__noselect,delete e.__noselect)}function Xt(t){return function(){return t}}function Vt(t,n,e,r,i,o,a,u,c,f){this.target=t,this.type=n,this.subject=e,this.identifier=r,this.active=i,this.x=o,this.y=a,this.dx=u,this.dy=c,this._=f}function Gt(){return!t.event.ctrlKey&&!t.event.button}function $t(){return this.parentNode}function Wt(n){return null==n?{x:t.event.x,y:t.event.y}:n}function Zt(){return navigator.maxTouchPoints||"ontouchstart"in this}function Qt(t,n,e){t.prototype=n.prototype=e,e.constructor=t}function Kt(t,n){var e=Object.create(t.prototype);for(var r in n)e[r]=n[r];return e}function Jt(){}Lt.prototype=qt.prototype={constructor:Lt,get:function(t){for(var n=this._;!(n in t);)if(!(t=t.parentNode))return;return t[n]},set:function(t,n){return t[this._]=n},remove:function(t){return this._ in t&&delete t[this._]},toString:function(){return this._}},Vt.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};var tn="\\s*([+-]?\\d+)\\s*",nn="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\s*",en="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)%\\s*",rn=/^#([0-9a-f]{3,8})$/,on=new RegExp("^rgb\\("+[tn,tn,tn]+"\\)$"),an=new RegExp("^rgb\\("+[en,en,en]+"\\)$"),un=new RegExp("^rgba\\("+[tn,tn,tn,nn]+"\\)$"),cn=new RegExp("^rgba\\("+[en,en,en,nn]+"\\)$"),fn=new RegExp("^hsl\\("+[nn,en,en]+"\\)$"),sn=new RegExp("^hsla\\("+[nn,en,en,nn]+"\\)$"),ln={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function hn(){return this.rgb().formatHex()}function dn(){return this.rgb().formatRgb()}function pn(t){var n,e;return t=(t+"").trim().toLowerCase(),(n=rn.exec(t))?(e=n[1].length,n=parseInt(n[1],16),6===e?vn(n):3===e?new bn(n>>8&15|n>>4&240,n>>4&15|240&n,(15&n)<<4|15&n,1):8===e?gn(n>>24&255,n>>16&255,n>>8&255,(255&n)/255):4===e?gn(n>>12&15|n>>8&240,n>>8&15|n>>4&240,n>>4&15|240&n,((15&n)<<4|15&n)/255):null):(n=on.exec(t))?new bn(n[1],n[2],n[3],1):(n=an.exec(t))?new bn(255*n[1]/100,255*n[2]/100,255*n[3]/100,1):(n=un.exec(t))?gn(n[1],n[2],n[3],n[4]):(n=cn.exec(t))?gn(255*n[1]/100,255*n[2]/100,255*n[3]/100,n[4]):(n=fn.exec(t))?Mn(n[1],n[2]/100,n[3]/100,1):(n=sn.exec(t))?Mn(n[1],n[2]/100,n[3]/100,n[4]):ln.hasOwnProperty(t)?vn(ln[t]):"transparent"===t?new bn(NaN,NaN,NaN,0):null}function vn(t){return new bn(t>>16&255,t>>8&255,255&t,1)}function gn(t,n,e,r){return r<=0&&(t=n=e=NaN),new bn(t,n,e,r)}function yn(t){return t instanceof Jt||(t=pn(t)),t?new bn((t=t.rgb()).r,t.g,t.b,t.opacity):new bn}function _n(t,n,e,r){return 1===arguments.length?yn(t):new bn(t,n,e,null==r?1:r)}function bn(t,n,e,r){this.r=+t,this.g=+n,this.b=+e,this.opacity=+r}function mn(){return"#"+wn(this.r)+wn(this.g)+wn(this.b)}function xn(){var t=this.opacity;return(1===(t=isNaN(t)?1:Math.max(0,Math.min(1,t)))?"rgb(":"rgba(")+Math.max(0,Math.min(255,Math.round(this.r)||0))+", "+Math.max(0,Math.min(255,Math.round(this.g)||0))+", "+Math.max(0,Math.min(255,Math.round(this.b)||0))+(1===t?")":", "+t+")")}function wn(t){return((t=Math.max(0,Math.min(255,Math.round(t)||0)))<16?"0":"")+t.toString(16)}function Mn(t,n,e,r){return r<=0?t=n=e=NaN:e<=0||e>=1?t=n=NaN:n<=0&&(t=NaN),new An(t,n,e,r)}function Nn(t){if(t instanceof An)return new An(t.h,t.s,t.l,t.opacity);if(t instanceof Jt||(t=pn(t)),!t)return new An;if(t instanceof An)return t;var n=(t=t.rgb()).r/255,e=t.g/255,r=t.b/255,i=Math.min(n,e,r),o=Math.max(n,e,r),a=NaN,u=o-i,c=(o+i)/2;return u?(a=n===o?(e-r)/u+6*(e<r):e===o?(r-n)/u+2:(n-e)/u+4,u/=c<.5?o+i:2-o-i,a*=60):u=c>0&&c<1?0:a,new An(a,u,c,t.opacity)}function Tn(t,n,e,r){return 1===arguments.length?Nn(t):new An(t,n,e,null==r?1:r)}function An(t,n,e,r){this.h=+t,this.s=+n,this.l=+e,this.opacity=+r}function Sn(t,n,e){return 255*(t<60?n+(e-n)*t/60:t<180?e:t<240?n+(e-n)*(240-t)/60:n)}Qt(Jt,pn,{copy:function(t){return Object.assign(new this.constructor,this,t)},displayable:function(){return this.rgb().displayable()},hex:hn,formatHex:hn,formatHsl:function(){return Nn(this).formatHsl()},formatRgb:dn,toString:dn}),Qt(bn,_n,Kt(Jt,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new bn(this.r*t,this.g*t,this.b*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new bn(this.r*t,this.g*t,this.b*t,this.opacity)},rgb:function(){return this},displayable:function(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:mn,formatHex:mn,formatRgb:xn,toString:xn})),Qt(An,Tn,Kt(Jt,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new An(this.h,this.s,this.l*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new An(this.h,this.s,this.l*t,this.opacity)},rgb:function(){var t=this.h%360+360*(this.h<0),n=isNaN(t)||isNaN(this.s)?0:this.s,e=this.l,r=e+(e<.5?e:1-e)*n,i=2*e-r;return new bn(Sn(t>=240?t-240:t+120,i,r),Sn(t,i,r),Sn(t<120?t+240:t-120,i,r),this.opacity)},displayable:function(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl:function(){var t=this.opacity;return(1===(t=isNaN(t)?1:Math.max(0,Math.min(1,t)))?"hsl(":"hsla(")+(this.h||0)+", "+100*(this.s||0)+"%, "+100*(this.l||0)+"%"+(1===t?")":", "+t+")")}}));var kn=Math.PI/180,En=180/Math.PI,Cn=.96422,Pn=1,zn=.82521,Rn=4/29,Dn=6/29,qn=3*Dn*Dn,Ln=Dn*Dn*Dn;function Un(t){if(t instanceof Bn)return new Bn(t.l,t.a,t.b,t.opacity);if(t instanceof Vn)return Gn(t);t instanceof bn||(t=yn(t));var n,e,r=Hn(t.r),i=Hn(t.g),o=Hn(t.b),a=Fn((.2225045*r+.7168786*i+.0606169*o)/Pn);return r===i&&i===o?n=e=a:(n=Fn((.4360747*r+.3850649*i+.1430804*o)/Cn),e=Fn((.0139322*r+.0971045*i+.7141733*o)/zn)),new Bn(116*a-16,500*(n-a),200*(a-e),t.opacity)}function On(t,n,e,r){return 1===arguments.length?Un(t):new Bn(t,n,e,null==r?1:r)}function Bn(t,n,e,r){this.l=+t,this.a=+n,this.b=+e,this.opacity=+r}function Fn(t){return t>Ln?Math.pow(t,1/3):t/qn+Rn}function Yn(t){return t>Dn?t*t*t:qn*(t-Rn)}function In(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Hn(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function jn(t){if(t instanceof Vn)return new Vn(t.h,t.c,t.l,t.opacity);if(t instanceof Bn||(t=Un(t)),0===t.a&&0===t.b)return new Vn(NaN,0<t.l&&t.l<100?0:NaN,t.l,t.opacity);var n=Math.atan2(t.b,t.a)*En;return new Vn(n<0?n+360:n,Math.sqrt(t.a*t.a+t.b*t.b),t.l,t.opacity)}function Xn(t,n,e,r){return 1===arguments.length?jn(t):new Vn(t,n,e,null==r?1:r)}function Vn(t,n,e,r){this.h=+t,this.c=+n,this.l=+e,this.opacity=+r}function Gn(t){if(isNaN(t.h))return new Bn(t.l,0,0,t.opacity);var n=t.h*kn;return new Bn(t.l,Math.cos(n)*t.c,Math.sin(n)*t.c,t.opacity)}Qt(Bn,On,Kt(Jt,{brighter:function(t){return new Bn(this.l+18*(null==t?1:t),this.a,this.b,this.opacity)},darker:function(t){return new Bn(this.l-18*(null==t?1:t),this.a,this.b,this.opacity)},rgb:function(){var t=(this.l+16)/116,n=isNaN(this.a)?t:t+this.a/500,e=isNaN(this.b)?t:t-this.b/200;return new bn(In(3.1338561*(n=Cn*Yn(n))-1.6168667*(t=Pn*Yn(t))-.4906146*(e=zn*Yn(e))),In(-.9787684*n+1.9161415*t+.033454*e),In(.0719453*n-.2289914*t+1.4052427*e),this.opacity)}})),Qt(Vn,Xn,Kt(Jt,{brighter:function(t){return new Vn(this.h,this.c,this.l+18*(null==t?1:t),this.opacity)},darker:function(t){return new Vn(this.h,this.c,this.l-18*(null==t?1:t),this.opacity)},rgb:function(){return Gn(this).rgb()}}));var $n=-.14861,Wn=1.78277,Zn=-.29227,Qn=-.90649,Kn=1.97294,Jn=Kn*Qn,te=Kn*Wn,ne=Wn*Zn-Qn*$n;function ee(t,n,e,r){return 1===arguments.length?function(t){if(t instanceof re)return new re(t.h,t.s,t.l,t.opacity);t instanceof bn||(t=yn(t));var n=t.r/255,e=t.g/255,r=t.b/255,i=(ne*r+Jn*n-te*e)/(ne+Jn-te),o=r-i,a=(Kn*(e-i)-Zn*o)/Qn,u=Math.sqrt(a*a+o*o)/(Kn*i*(1-i)),c=u?Math.atan2(a,o)*En-120:NaN;return new re(c<0?c+360:c,u,i,t.opacity)}(t):new re(t,n,e,null==r?1:r)}function re(t,n,e,r){this.h=+t,this.s=+n,this.l=+e,this.opacity=+r}function ie(t,n,e,r,i){var o=t*t,a=o*t;return((1-3*t+3*o-a)*n+(4-6*o+3*a)*e+(1+3*t+3*o-3*a)*r+a*i)/6}function oe(t){var n=t.length-1;return function(e){var r=e<=0?e=0:e>=1?(e=1,n-1):Math.floor(e*n),i=t[r],o=t[r+1],a=r>0?t[r-1]:2*i-o,u=r<n-1?t[r+2]:2*o-i;return ie((e-r/n)*n,a,i,o,u)}}function ae(t){var n=t.length;return function(e){var r=Math.floor(((e%=1)<0?++e:e)*n),i=t[(r+n-1)%n],o=t[r%n],a=t[(r+1)%n],u=t[(r+2)%n];return ie((e-r/n)*n,i,o,a,u)}}function ue(t){return function(){return t}}function ce(t,n){return function(e){return t+e*n}}function fe(t,n){var e=n-t;return e?ce(t,e>180||e<-180?e-360*Math.round(e/360):e):ue(isNaN(t)?n:t)}function se(t){return 1==(t=+t)?le:function(n,e){return e-n?function(t,n,e){return t=Math.pow(t,e),n=Math.pow(n,e)-t,e=1/e,function(r){return Math.pow(t+r*n,e)}}(n,e,t):ue(isNaN(n)?e:n)}}function le(t,n){var e=n-t;return e?ce(t,e):ue(isNaN(t)?n:t)}Qt(re,ee,Kt(Jt,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new re(this.h,this.s,this.l*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new re(this.h,this.s,this.l*t,this.opacity)},rgb:function(){var t=isNaN(this.h)?0:(this.h+120)*kn,n=+this.l,e=isNaN(this.s)?0:this.s*n*(1-n),r=Math.cos(t),i=Math.sin(t);return new bn(255*(n+e*($n*r+Wn*i)),255*(n+e*(Zn*r+Qn*i)),255*(n+e*(Kn*r)),this.opacity)}}));var he=function t(n){var e=se(n);function r(t,n){var r=e((t=_n(t)).r,(n=_n(n)).r),i=e(t.g,n.g),o=e(t.b,n.b),a=le(t.opacity,n.opacity);return function(n){return t.r=r(n),t.g=i(n),t.b=o(n),t.opacity=a(n),t+""}}return r.gamma=t,r}(1);function de(t){return function(n){var e,r,i=n.length,o=new Array(i),a=new Array(i),u=new Array(i);for(e=0;e<i;++e)r=_n(n[e]),o[e]=r.r||0,a[e]=r.g||0,u[e]=r.b||0;return o=t(o),a=t(a),u=t(u),r.opacity=1,function(t){return r.r=o(t),r.g=a(t),r.b=u(t),r+""}}}var pe=de(oe),ve=de(ae);function ge(t,n){n||(n=[]);var e,r=t?Math.min(n.length,t.length):0,i=n.slice();return function(o){for(e=0;e<r;++e)i[e]=t[e]*(1-o)+n[e]*o;return i}}function ye(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function _e(t,n){var e,r=n?n.length:0,i=t?Math.min(r,t.length):0,o=new Array(i),a=new Array(r);for(e=0;e<i;++e)o[e]=Te(t[e],n[e]);for(;e<r;++e)a[e]=n[e];return function(t){for(e=0;e<i;++e)a[e]=o[e](t);return a}}function be(t,n){var e=new Date;return t=+t,n=+n,function(r){return e.setTime(t*(1-r)+n*r),e}}function me(t,n){return t=+t,n=+n,function(e){return t*(1-e)+n*e}}function xe(t,n){var e,r={},i={};for(e in null!==t&&"object"==typeof t||(t={}),null!==n&&"object"==typeof n||(n={}),n)e in t?r[e]=Te(t[e],n[e]):i[e]=n[e];return function(t){for(e in r)i[e]=r[e](t);return i}}var we=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Me=new RegExp(we.source,"g");function Ne(t,n){var e,r,i,o=we.lastIndex=Me.lastIndex=0,a=-1,u=[],c=[];for(t+="",n+="";(e=we.exec(t))&&(r=Me.exec(n));)(i=r.index)>o&&(i=n.slice(o,i),u[a]?u[a]+=i:u[++a]=i),(e=e[0])===(r=r[0])?u[a]?u[a]+=r:u[++a]=r:(u[++a]=null,c.push({i:a,x:me(e,r)})),o=Me.lastIndex;return o<n.length&&(i=n.slice(o),u[a]?u[a]+=i:u[++a]=i),u.length<2?c[0]?function(t){return function(n){return t(n)+""}}(c[0].x):function(t){return function(){return t}}(n):(n=c.length,function(t){for(var e,r=0;r<n;++r)u[(e=c[r]).i]=e.x(t);return u.join("")})}function Te(t,n){var e,r=typeof n;return null==n||"boolean"===r?ue(n):("number"===r?me:"string"===r?(e=pn(n))?(n=e,he):Ne:n instanceof pn?he:n instanceof Date?be:ye(n)?ge:Array.isArray(n)?_e:"function"!=typeof n.valueOf&&"function"!=typeof n.toString||isNaN(n)?xe:me)(t,n)}function Ae(t,n){return t=+t,n=+n,function(e){return Math.round(t*(1-e)+n*e)}}var Se,ke,Ee,Ce,Pe=180/Math.PI,ze={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function Re(t,n,e,r,i,o){var a,u,c;return(a=Math.sqrt(t*t+n*n))&&(t/=a,n/=a),(c=t*e+n*r)&&(e-=t*c,r-=n*c),(u=Math.sqrt(e*e+r*r))&&(e/=u,r/=u,c/=u),t*r<n*e&&(t=-t,n=-n,c=-c,a=-a),{translateX:i,translateY:o,rotate:Math.atan2(n,t)*Pe,skewX:Math.atan(c)*Pe,scaleX:a,scaleY:u}}function De(t,n,e,r){function i(t){return t.length?t.pop()+" ":""}return function(o,a){var u=[],c=[];return o=t(o),a=t(a),function(t,r,i,o,a,u){if(t!==i||r!==o){var c=a.push("translate(",null,n,null,e);u.push({i:c-4,x:me(t,i)},{i:c-2,x:me(r,o)})}else(i||o)&&a.push("translate("+i+n+o+e)}(o.translateX,o.translateY,a.translateX,a.translateY,u,c),function(t,n,e,o){t!==n?(t-n>180?n+=360:n-t>180&&(t+=360),o.push({i:e.push(i(e)+"rotate(",null,r)-2,x:me(t,n)})):n&&e.push(i(e)+"rotate("+n+r)}(o.rotate,a.rotate,u,c),function(t,n,e,o){t!==n?o.push({i:e.push(i(e)+"skewX(",null,r)-2,x:me(t,n)}):n&&e.push(i(e)+"skewX("+n+r)}(o.skewX,a.skewX,u,c),function(t,n,e,r,o,a){if(t!==e||n!==r){var u=o.push(i(o)+"scale(",null,",",null,")");a.push({i:u-4,x:me(t,e)},{i:u-2,x:me(n,r)})}else 1===e&&1===r||o.push(i(o)+"scale("+e+","+r+")")}(o.scaleX,o.scaleY,a.scaleX,a.scaleY,u,c),o=a=null,function(t){for(var n,e=-1,r=c.length;++e<r;)u[(n=c[e]).i]=n.x(t);return u.join("")}}}var qe=De(function(t){return"none"===t?ze:(Se||(Se=document.createElement("DIV"),ke=document.documentElement,Ee=document.defaultView),Se.style.transform=t,t=Ee.getComputedStyle(ke.appendChild(Se),null).getPropertyValue("transform"),ke.removeChild(Se),Re(+(t=t.slice(7,-1).split(","))[0],+t[1],+t[2],+t[3],+t[4],+t[5]))},"px, ","px)","deg)"),Le=De(function(t){return null==t?ze:(Ce||(Ce=document.createElementNS("http://www.w3.org/2000/svg","g")),Ce.setAttribute("transform",t),(t=Ce.transform.baseVal.consolidate())?Re((t=t.matrix).a,t.b,t.c,t.d,t.e,t.f):ze)},", ",")",")"),Ue=Math.SQRT2,Oe=2,Be=4,Fe=1e-12;function Ye(t){return((t=Math.exp(t))+1/t)/2}function Ie(t,n){var e,r,i=t[0],o=t[1],a=t[2],u=n[0],c=n[1],f=n[2],s=u-i,l=c-o,h=s*s+l*l;if(h<Fe)r=Math.log(f/a)/Ue,e=function(t){return[i+t*s,o+t*l,a*Math.exp(Ue*t*r)]};else{var d=Math.sqrt(h),p=(f*f-a*a+Be*h)/(2*a*Oe*d),v=(f*f-a*a-Be*h)/(2*f*Oe*d),g=Math.log(Math.sqrt(p*p+1)-p),y=Math.log(Math.sqrt(v*v+1)-v);r=(y-g)/Ue,e=function(t){var n=t*r,e=Ye(g),u=a/(Oe*d)*(e*function(t){return((t=Math.exp(2*t))-1)/(t+1)}(Ue*n+g)-function(t){return((t=Math.exp(t))-1/t)/2}(g));return[i+u*s,o+u*l,a*e/Ye(Ue*n+g)]}}return e.duration=1e3*r,e}function He(t){return function(n,e){var r=t((n=Tn(n)).h,(e=Tn(e)).h),i=le(n.s,e.s),o=le(n.l,e.l),a=le(n.opacity,e.opacity);return function(t){return n.h=r(t),n.s=i(t),n.l=o(t),n.opacity=a(t),n+""}}}var je=He(fe),Xe=He(le);function Ve(t){return function(n,e){var r=t((n=Xn(n)).h,(e=Xn(e)).h),i=le(n.c,e.c),o=le(n.l,e.l),a=le(n.opacity,e.opacity);return function(t){return n.h=r(t),n.c=i(t),n.l=o(t),n.opacity=a(t),n+""}}}var Ge=Ve(fe),$e=Ve(le);function We(t){return function n(e){function r(n,r){var i=t((n=ee(n)).h,(r=ee(r)).h),o=le(n.s,r.s),a=le(n.l,r.l),u=le(n.opacity,r.opacity);return function(t){return n.h=i(t),n.s=o(t),n.l=a(Math.pow(t,e)),n.opacity=u(t),n+""}}return e=+e,r.gamma=n,r}(1)}var Ze=We(fe),Qe=We(le);var Ke,Je,tr=0,nr=0,er=0,rr=1e3,ir=0,or=0,ar=0,ur="object"==typeof performance&&performance.now?performance:Date,cr="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function fr(){return or||(cr(sr),or=ur.now()+ar)}function sr(){or=0}function lr(){this._call=this._time=this._next=null}function hr(t,n,e){var r=new lr;return r.restart(t,n,e),r}function dr(){fr(),++tr;for(var t,n=Ke;n;)(t=or-n._time)>=0&&n._call.call(null,t),n=n._next;--tr}function pr(){or=(ir=ur.now())+ar,tr=nr=0;try{dr()}finally{tr=0,function(){var t,n,e=Ke,r=1/0;for(;e;)e._call?(r>e._time&&(r=e._time),t=e,e=e._next):(n=e._next,e._next=null,e=t?t._next=n:Ke=n);Je=t,gr(r)}(),or=0}}function vr(){var t=ur.now(),n=t-ir;n>rr&&(ar-=n,ir=t)}function gr(t){tr||(nr&&(nr=clearTimeout(nr)),t-or>24?(t<1/0&&(nr=setTimeout(pr,t-ur.now()-ar)),er&&(er=clearInterval(er))):(er||(ir=ur.now(),er=setInterval(vr,rr)),tr=1,cr(pr)))}function yr(t,n,e){var r=new lr;return n=null==n?0:+n,r.restart(function(e){r.stop(),t(e+n)},n,e),r}lr.prototype=hr.prototype={constructor:lr,restart:function(t,n,e){if("function"!=typeof t)throw new TypeError("callback is not a function");e=(null==e?fr():+e)+(null==n?0:+n),this._next||Je===this||(Je?Je._next=this:Ke=this,Je=this),this._call=t,this._time=e,gr()},stop:function(){this._call&&(this._call=null,this._time=1/0,gr())}};var _r=I("start","end","cancel","interrupt"),br=[],mr=0,xr=1,wr=2,Mr=3,Nr=4,Tr=5,Ar=6;function Sr(t,n,e,r,i,o){var a=t.__transition;if(a){if(e in a)return}else t.__transition={};!function(t,n,e){var r,i=t.__transition;function o(c){var f,s,l,h;if(e.state!==xr)return u();for(f in i)if((h=i[f]).name===e.name){if(h.state===Mr)return yr(o);h.state===Nr?(h.state=Ar,h.timer.stop(),h.on.call("interrupt",t,t.__data__,h.index,h.group),delete i[f]):+f<n&&(h.state=Ar,h.timer.stop(),h.on.call("cancel",t,t.__data__,h.index,h.group),delete i[f])}if(yr(function(){e.state===Mr&&(e.state=Nr,e.timer.restart(a,e.delay,e.time),a(c))}),e.state=wr,e.on.call("start",t,t.__data__,e.index,e.group),e.state===wr){for(e.state=Mr,r=new Array(l=e.tween.length),f=0,s=-1;f<l;++f)(h=e.tween[f].value.call(t,t.__data__,e.index,e.group))&&(r[++s]=h);r.length=s+1}}function a(n){for(var i=n<e.duration?e.ease.call(null,n/e.duration):(e.timer.restart(u),e.state=Tr,1),o=-1,a=r.length;++o<a;)r[o].call(t,i);e.state===Tr&&(e.on.call("end",t,t.__data__,e.index,e.group),u())}function u(){for(var r in e.state=Ar,e.timer.stop(),delete i[n],i)return;delete t.__transition}i[n]=e,e.timer=hr(function(t){e.state=xr,e.timer.restart(o,e.delay,e.time),e.delay<=t&&o(t-e.delay)},0,e.time)}(t,e,{name:n,index:r,group:i,on:_r,tween:br,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:mr})}function kr(t,n){var e=Cr(t,n);if(e.state>mr)throw new Error("too late; already scheduled");return e}function Er(t,n){var e=Cr(t,n);if(e.state>Mr)throw new Error("too late; already running");return e}function Cr(t,n){var e=t.__transition;if(!e||!(e=e[n]))throw new Error("transition not found");return e}function Pr(t,n){var e,r,i,o=t.__transition,a=!0;if(o){for(i in n=null==n?null:n+"",o)(e=o[i]).name===n?(r=e.state>wr&&e.state<Tr,e.state=Ar,e.timer.stop(),e.on.call(r?"interrupt":"cancel",t,t.__data__,e.index,e.group),delete o[i]):a=!1;a&&delete t.__transition}}function zr(t,n,e){var r=t._id;return t.each(function(){var t=Er(this,r);(t.value||(t.value={}))[n]=e.apply(this,arguments)}),function(t){return Cr(t,r).value[n]}}function Rr(t,n){var e;return("number"==typeof n?me:n instanceof pn?he:(e=pn(n))?(n=e,he):Ne)(t,n)}var Dr=zt.prototype.constructor;function qr(t){return function(){this.style.removeProperty(t)}}var Lr=0;function Ur(t,n,e,r){this._groups=t,this._parents=n,this._name=e,this._id=r}function Or(t){return zt().transition(t)}function Br(){return++Lr}var Fr=zt.prototype;function Yr(t){return((t*=2)<=1?t*t:--t*(2-t)+1)/2}function Ir(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}Ur.prototype=Or.prototype={constructor:Ur,select:function(t){var n=this._name,e=this._id;"function"!=typeof t&&(t=K(t));for(var r=this._groups,i=r.length,o=new Array(i),a=0;a<i;++a)for(var u,c,f=r[a],s=f.length,l=o[a]=new Array(s),h=0;h<s;++h)(u=f[h])&&(c=t.call(u,u.__data__,h,f))&&("__data__"in u&&(c.__data__=u.__data__),l[h]=c,Sr(l[h],n,e,h,l,Cr(u,e)));return new Ur(o,this._parents,n,e)},selectAll:function(t){var n=this._name,e=this._id;"function"!=typeof t&&(t=tt(t));for(var r=this._groups,i=r.length,o=[],a=[],u=0;u<i;++u)for(var c,f=r[u],s=f.length,l=0;l<s;++l)if(c=f[l]){for(var h,d=t.call(c,c.__data__,l,f),p=Cr(c,e),v=0,g=d.length;v<g;++v)(h=d[v])&&Sr(h,n,e,v,d,p);o.push(d),a.push(c)}return new Ur(o,a,n,e)},filter:function(t){"function"!=typeof t&&(t=nt(t));for(var n=this._groups,e=n.length,r=new Array(e),i=0;i<e;++i)for(var o,a=n[i],u=a.length,c=r[i]=[],f=0;f<u;++f)(o=a[f])&&t.call(o,o.__data__,f,a)&&c.push(o);return new Ur(r,this._parents,this._name,this._id)},merge:function(t){if(t._id!==this._id)throw new Error;for(var n=this._groups,e=t._groups,r=n.length,i=e.length,o=Math.min(r,i),a=new Array(r),u=0;u<o;++u)for(var c,f=n[u],s=e[u],l=f.length,h=a[u]=new Array(l),d=0;d<l;++d)(c=f[d]||s[d])&&(h[d]=c);for(;u<r;++u)a[u]=n[u];return new Ur(a,this._parents,this._name,this._id)},selection:function(){return new Dr(this._groups,this._parents)},transition:function(){for(var t=this._name,n=this._id,e=Br(),r=this._groups,i=r.length,o=0;o<i;++o)for(var a,u=r[o],c=u.length,f=0;f<c;++f)if(a=u[f]){var s=Cr(a,n);Sr(a,t,e,f,u,{time:s.time+s.delay+s.duration,delay:0,duration:s.duration,ease:s.ease})}return new Ur(r,this._parents,t,e)},call:Fr.call,nodes:Fr.nodes,node:Fr.node,size:Fr.size,empty:Fr.empty,each:Fr.each,on:function(t,n){var e=this._id;return arguments.length<2?Cr(this.node(),e).on.on(t):this.each(function(t,n,e){var r,i,o=function(t){return(t+"").trim().split(/^|\s+/).every(function(t){var n=t.indexOf(".");return n>=0&&(t=t.slice(0,n)),!t||"start"===t})}(n)?kr:Er;return function(){var a=o(this,t),u=a.on;u!==r&&(i=(r=u).copy()).on(n,e),a.on=i}}(e,t,n))},attr:function(t,n){var e=W(t),r="transform"===e?Le:Rr;return this.attrTween(t,"function"==typeof n?(e.local?function(t,n,e){var r,i,o;return function(){var a,u,c=e(this);if(null!=c)return(a=this.getAttributeNS(t.space,t.local))===(u=c+"")?null:a===r&&u===i?o:(i=u,o=n(r=a,c));this.removeAttributeNS(t.space,t.local)}}:function(t,n,e){var r,i,o;return function(){var a,u,c=e(this);if(null!=c)return(a=this.getAttribute(t))===(u=c+"")?null:a===r&&u===i?o:(i=u,o=n(r=a,c));this.removeAttribute(t)}})(e,r,zr(this,"attr."+t,n)):null==n?(e.local?function(t){return function(){this.removeAttributeNS(t.space,t.local)}}:function(t){return function(){this.removeAttribute(t)}})(e):(e.local?function(t,n,e){var r,i,o=e+"";return function(){var a=this.getAttributeNS(t.space,t.local);return a===o?null:a===r?i:i=n(r=a,e)}}:function(t,n,e){var r,i,o=e+"";return function(){var a=this.getAttribute(t);return a===o?null:a===r?i:i=n(r=a,e)}})(e,r,n))},attrTween:function(t,n){var e="attr."+t;if(arguments.length<2)return(e=this.tween(e))&&e._value;if(null==n)return this.tween(e,null);if("function"!=typeof n)throw new Error;var r=W(t);return this.tween(e,(r.local?function(t,n){var e,r;function i(){var i=n.apply(this,arguments);return i!==r&&(e=(r=i)&&function(t,n){return function(e){this.setAttributeNS(t.space,t.local,n.call(this,e))}}(t,i)),e}return i._value=n,i}:function(t,n){var e,r;function i(){var i=n.apply(this,arguments);return i!==r&&(e=(r=i)&&function(t,n){return function(e){this.setAttribute(t,n.call(this,e))}}(t,i)),e}return i._value=n,i})(r,n))},style:function(t,n,e){var r="transform"==(t+="")?qe:Rr;return null==n?this.styleTween(t,function(t,n){var e,r,i;return function(){var o=ft(this,t),a=(this.style.removeProperty(t),ft(this,t));return o===a?null:o===e&&a===r?i:i=n(e=o,r=a)}}(t,r)).on("end.style."+t,qr(t)):"function"==typeof n?this.styleTween(t,function(t,n,e){var r,i,o;return function(){var a=ft(this,t),u=e(this),c=u+"";return null==u&&(this.style.removeProperty(t),c=u=ft(this,t)),a===c?null:a===r&&c===i?o:(i=c,o=n(r=a,u))}}(t,r,zr(this,"style."+t,n))).each(function(t,n){var e,r,i,o,a="style."+n,u="end."+a;return function(){var c=Er(this,t),f=c.on,s=null==c.value[a]?o||(o=qr(n)):void 0;f===e&&i===s||(r=(e=f).copy()).on(u,i=s),c.on=r}}(this._id,t)):this.styleTween(t,function(t,n,e){var r,i,o=e+"";return function(){var a=ft(this,t);return a===o?null:a===r?i:i=n(r=a,e)}}(t,r,n),e).on("end.style."+t,null)},styleTween:function(t,n,e){var r="style."+(t+="");if(arguments.length<2)return(r=this.tween(r))&&r._value;if(null==n)return this.tween(r,null);if("function"!=typeof n)throw new Error;return this.tween(r,function(t,n,e){var r,i;function o(){var o=n.apply(this,arguments);return o!==i&&(r=(i=o)&&function(t,n,e){return function(r){this.style.setProperty(t,n.call(this,r),e)}}(t,o,e)),r}return o._value=n,o}(t,n,null==e?"":e))},text:function(t){return this.tween("text","function"==typeof t?function(t){return function(){var n=t(this);this.textContent=null==n?"":n}}(zr(this,"text",t)):function(t){return function(){this.textContent=t}}(null==t?"":t+""))},textTween:function(t){var n="text";if(arguments.length<1)return(n=this.tween(n))&&n._value;if(null==t)return this.tween(n,null);if("function"!=typeof t)throw new Error;return this.tween(n,function(t){var n,e;function r(){var r=t.apply(this,arguments);return r!==e&&(n=(e=r)&&function(t){return function(n){this.textContent=t.call(this,n)}}(r)),n}return r._value=t,r}(t))},remove:function(){return this.on("end.remove",function(t){return function(){var n=this.parentNode;for(var e in this.__transition)if(+e!==t)return;n&&n.removeChild(this)}}(this._id))},tween:function(t,n){var e=this._id;if(t+="",arguments.length<2){for(var r,i=Cr(this.node(),e).tween,o=0,a=i.length;o<a;++o)if((r=i[o]).name===t)return r.value;return null}return this.each((null==n?function(t,n){var e,r;return function(){var i=Er(this,t),o=i.tween;if(o!==e)for(var a=0,u=(r=e=o).length;a<u;++a)if(r[a].name===n){(r=r.slice()).splice(a,1);break}i.tween=r}}:function(t,n,e){var r,i;if("function"!=typeof e)throw new Error;return function(){var o=Er(this,t),a=o.tween;if(a!==r){i=(r=a).slice();for(var u={name:n,value:e},c=0,f=i.length;c<f;++c)if(i[c].name===n){i[c]=u;break}c===f&&i.push(u)}o.tween=i}})(e,t,n))},delay:function(t){var n=this._id;return arguments.length?this.each(("function"==typeof t?function(t,n){return function(){kr(this,t).delay=+n.apply(this,arguments)}}:function(t,n){return n=+n,function(){kr(this,t).delay=n}})(n,t)):Cr(this.node(),n).delay},duration:function(t){var n=this._id;return arguments.length?this.each(("function"==typeof t?function(t,n){return function(){Er(this,t).duration=+n.apply(this,arguments)}}:function(t,n){return n=+n,function(){Er(this,t).duration=n}})(n,t)):Cr(this.node(),n).duration},ease:function(t){var n=this._id;return arguments.length?this.each(function(t,n){if("function"!=typeof n)throw new Error;return function(){Er(this,t).ease=n}}(n,t)):Cr(this.node(),n).ease},end:function(){var t,n,e=this,r=e._id,i=e.size();return new Promise(function(o,a){var u={value:a},c={value:function(){0==--i&&o()}};e.each(function(){var e=Er(this,r),i=e.on;i!==t&&((n=(t=i).copy())._.cancel.push(u),n._.interrupt.push(u),n._.end.push(c)),e.on=n})})}};var Hr=function t(n){function e(t){return Math.pow(t,n)}return n=+n,e.exponent=t,e}(3),jr=function t(n){function e(t){return 1-Math.pow(1-t,n)}return n=+n,e.exponent=t,e}(3),Xr=function t(n){function e(t){return((t*=2)<=1?Math.pow(t,n):2-Math.pow(2-t,n))/2}return n=+n,e.exponent=t,e}(3),Vr=Math.PI,Gr=Vr/2;function $r(t){return(1-Math.cos(Vr*t))/2}function Wr(t){return((t*=2)<=1?Math.pow(2,10*t-10):2-Math.pow(2,10-10*t))/2}function Zr(t){return((t*=2)<=1?1-Math.sqrt(1-t*t):Math.sqrt(1-(t-=2)*t)+1)/2}var Qr=4/11,Kr=6/11,Jr=8/11,ti=.75,ni=9/11,ei=10/11,ri=.9375,ii=21/22,oi=63/64,ai=1/Qr/Qr;function ui(t){return(t=+t)<Qr?ai*t*t:t<Jr?ai*(t-=Kr)*t+ti:t<ei?ai*(t-=ni)*t+ri:ai*(t-=ii)*t+oi}var ci=function t(n){function e(t){return t*t*((n+1)*t-n)}return n=+n,e.overshoot=t,e}(1.70158),fi=function t(n){function e(t){return--t*t*((n+1)*t+n)+1}return n=+n,e.overshoot=t,e}(1.70158),si=function t(n){function e(t){return((t*=2)<1?t*t*((n+1)*t-n):(t-=2)*t*((n+1)*t+n)+2)/2}return n=+n,e.overshoot=t,e}(1.70158),li=2*Math.PI,hi=function t(n,e){var r=Math.asin(1/(n=Math.max(1,n)))*(e/=li);function i(t){return n*Math.pow(2,10*--t)*Math.sin((r-t)/e)}return i.amplitude=function(n){return t(n,e*li)},i.period=function(e){return t(n,e)},i}(1,.3),di=function t(n,e){var r=Math.asin(1/(n=Math.max(1,n)))*(e/=li);function i(t){return 1-n*Math.pow(2,-10*(t=+t))*Math.sin((t+r)/e)}return i.amplitude=function(n){return t(n,e*li)},i.period=function(e){return t(n,e)},i}(1,.3),pi=function t(n,e){var r=Math.asin(1/(n=Math.max(1,n)))*(e/=li);function i(t){return((t=2*t-1)<0?n*Math.pow(2,10*t)*Math.sin((r-t)/e):2-n*Math.pow(2,-10*t)*Math.sin((r+t)/e))/2}return i.amplitude=function(n){return t(n,e*li)},i.period=function(e){return t(n,e)},i}(1,.3),vi={time:null,delay:0,duration:250,ease:Ir};function gi(t,n){for(var e;!(e=t.__transition)||!(e=e[n]);)if(!(t=t.parentNode))return vi.time=fr(),vi;return e}zt.prototype.interrupt=function(t){return this.each(function(){Pr(this,t)})},zt.prototype.transition=function(t){var n,e;t instanceof Ur?(n=t._id,t=t._name):(n=Br(),(e=vi).time=fr(),t=null==t?null:t+"");for(var r=this._groups,i=r.length,o=0;o<i;++o)for(var a,u=r[o],c=u.length,f=0;f<c;++f)(a=u[f])&&Sr(a,t,n,f,u,e||gi(a,n));return new Ur(r,this._parents,t,n)};var yi=[null];function _i(t){return function(){return t}}function bi(t,n,e){this.target=t,this.type=n,this.selection=e}function mi(){t.event.stopImmediatePropagation()}function xi(){t.event.preventDefault(),t.event.stopImmediatePropagation()}var wi={name:"drag"},Mi={name:"space"},Ni={name:"handle"},Ti={name:"center"};function Ai(t){return[+t[0],+t[1]]}function Si(t){return[Ai(t[0]),Ai(t[1])]}var ki={name:"x",handles:["w","e"].map(Li),input:function(t,n){return null==t?null:[[+t[0],n[0][1]],[+t[1],n[1][1]]]},output:function(t){return t&&[t[0][0],t[1][0]]}},Ei={name:"y",handles:["n","s"].map(Li),input:function(t,n){return null==t?null:[[n[0][0],+t[0]],[n[1][0],+t[1]]]},output:function(t){return t&&[t[0][1],t[1][1]]}},Ci={name:"xy",handles:["n","w","e","s","nw","ne","sw","se"].map(Li),input:function(t){return null==t?null:Si(t)},output:function(t){return t}},Pi={overlay:"crosshair",selection:"move",n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},zi={e:"w",w:"e",nw:"ne",ne:"nw",se:"sw",sw:"se"},Ri={n:"s",s:"n",nw:"sw",ne:"se",se:"ne",sw:"nw"},Di={overlay:1,selection:1,n:null,e:1,s:null,w:-1,nw:-1,ne:1,se:1,sw:-1},qi={overlay:1,selection:1,n:-1,e:null,s:1,w:null,nw:-1,ne:-1,se:1,sw:1};function Li(t){return{type:t}}function Ui(){return!t.event.ctrlKey&&!t.event.button}function Oi(){var t=this.ownerSVGElement||this;return t.hasAttribute("viewBox")?[[(t=t.viewBox.baseVal).x,t.y],[t.x+t.width,t.y+t.height]]:[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]}function Bi(){return navigator.maxTouchPoints||"ontouchstart"in this}function Fi(t){for(;!t.__brush;)if(!(t=t.parentNode))return;return t.__brush}function Yi(n){var e,r=Oi,i=Ui,o=Bi,a=!0,u=I("start","brush","end"),c=6;function f(t){var e=t.property("__brush",g).selectAll(".overlay").data([Li("overlay")]);e.enter().append("rect").attr("class","overlay").attr("pointer-events","all").attr("cursor",Pi.overlay).merge(e).each(function(){var t=Fi(this).extent;Rt(this).attr("x",t[0][0]).attr("y",t[0][1]).attr("width",t[1][0]-t[0][0]).attr("height",t[1][1]-t[0][1])}),t.selectAll(".selection").data([Li("selection")]).enter().append("rect").attr("class","selection").attr("cursor",Pi.selection).attr("fill","#777").attr("fill-opacity",.3).attr("stroke","#fff").attr("shape-rendering","crispEdges");var r=t.selectAll(".handle").data(n.handles,function(t){return t.type});r.exit().remove(),r.enter().append("rect").attr("class",function(t){return"handle handle--"+t.type}).attr("cursor",function(t){return Pi[t.type]}),t.each(s).attr("fill","none").attr("pointer-events","all").on("mousedown.brush",d).filter(o).on("touchstart.brush",d).on("touchmove.brush",p).on("touchend.brush touchcancel.brush",v).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function s(){var t=Rt(this),n=Fi(this).selection;n?(t.selectAll(".selection").style("display",null).attr("x",n[0][0]).attr("y",n[0][1]).attr("width",n[1][0]-n[0][0]).attr("height",n[1][1]-n[0][1]),t.selectAll(".handle").style("display",null).attr("x",function(t){return"e"===t.type[t.type.length-1]?n[1][0]-c/2:n[0][0]-c/2}).attr("y",function(t){return"s"===t.type[0]?n[1][1]-c/2:n[0][1]-c/2}).attr("width",function(t){return"n"===t.type||"s"===t.type?n[1][0]-n[0][0]+c:c}).attr("height",function(t){return"e"===t.type||"w"===t.type?n[1][1]-n[0][1]+c:c})):t.selectAll(".selection,.handle").style("display","none").attr("x",null).attr("y",null).attr("width",null).attr("height",null)}function l(t,n,e){return!e&&t.__brush.emitter||new h(t,n)}function h(t,n){this.that=t,this.args=n,this.state=t.__brush,this.active=0}function d(){if((!e||t.event.touches)&&i.apply(this,arguments)){var r,o,u,c,f,h,d,p,v,g,y,_,b=this,m=t.event.target.__data__.type,x="selection"===(a&&t.event.metaKey?m="overlay":m)?wi:a&&t.event.altKey?Ti:Ni,w=n===Ei?null:Di[m],M=n===ki?null:qi[m],N=Fi(b),T=N.extent,A=N.selection,S=T[0][0],k=T[0][1],E=T[1][0],C=T[1][1],P=0,z=0,R=w&&M&&a&&t.event.shiftKey,D=t.event.touches?(_=t.event.changedTouches[0].identifier,function(n){return Ft(n,t.event.touches,_)}):Bt,q=D(b),L=q,U=l(b,arguments,!0).beforestart();"overlay"===m?(A&&(v=!0),N.selection=A=[[r=n===Ei?S:q[0],u=n===ki?k:q[1]],[f=n===Ei?E:r,d=n===ki?C:u]]):(r=A[0][0],u=A[0][1],f=A[1][0],d=A[1][1]),o=r,c=u,h=f,p=d;var O=Rt(b).attr("pointer-events","none"),B=O.selectAll(".overlay").attr("cursor",Pi[m]);if(t.event.touches)U.moved=Y,U.ended=H;else{var F=Rt(t.event.view).on("mousemove.brush",Y,!0).on("mouseup.brush",H,!0);a&&F.on("keydown.brush",function(){switch(t.event.keyCode){case 16:R=w&&M;break;case 18:x===Ni&&(w&&(f=h-P*w,r=o+P*w),M&&(d=p-z*M,u=c+z*M),x=Ti,I());break;case 32:x!==Ni&&x!==Ti||(w<0?f=h-P:w>0&&(r=o-P),M<0?d=p-z:M>0&&(u=c-z),x=Mi,B.attr("cursor",Pi.selection),I());break;default:return}xi()},!0).on("keyup.brush",function(){switch(t.event.keyCode){case 16:R&&(g=y=R=!1,I());break;case 18:x===Ti&&(w<0?f=h:w>0&&(r=o),M<0?d=p:M>0&&(u=c),x=Ni,I());break;case 32:x===Mi&&(t.event.altKey?(w&&(f=h-P*w,r=o+P*w),M&&(d=p-z*M,u=c+z*M),x=Ti):(w<0?f=h:w>0&&(r=o),M<0?d=p:M>0&&(u=c),x=Ni),B.attr("cursor",Pi[m]),I());break;default:return}xi()},!0),Ht(t.event.view)}mi(),Pr(b),s.call(b),U.start()}function Y(){var t=D(b);!R||g||y||(Math.abs(t[0]-L[0])>Math.abs(t[1]-L[1])?y=!0:g=!0),L=t,v=!0,xi(),I()}function I(){var t;switch(P=L[0]-q[0],z=L[1]-q[1],x){case Mi:case wi:w&&(P=Math.max(S-r,Math.min(E-f,P)),o=r+P,h=f+P),M&&(z=Math.max(k-u,Math.min(C-d,z)),c=u+z,p=d+z);break;case Ni:w<0?(P=Math.max(S-r,Math.min(E-r,P)),o=r+P,h=f):w>0&&(P=Math.max(S-f,Math.min(E-f,P)),o=r,h=f+P),M<0?(z=Math.max(k-u,Math.min(C-u,z)),c=u+z,p=d):M>0&&(z=Math.max(k-d,Math.min(C-d,z)),c=u,p=d+z);break;case Ti:w&&(o=Math.max(S,Math.min(E,r-P*w)),h=Math.max(S,Math.min(E,f+P*w))),M&&(c=Math.max(k,Math.min(C,u-z*M)),p=Math.max(k,Math.min(C,d+z*M)))}h<o&&(w*=-1,t=r,r=f,f=t,t=o,o=h,h=t,m in zi&&B.attr("cursor",Pi[m=zi[m]])),p<c&&(M*=-1,t=u,u=d,d=t,t=c,c=p,p=t,m in Ri&&B.attr("cursor",Pi[m=Ri[m]])),N.selection&&(A=N.selection),g&&(o=A[0][0],h=A[1][0]),y&&(c=A[0][1],p=A[1][1]),A[0][0]===o&&A[0][1]===c&&A[1][0]===h&&A[1][1]===p||(N.selection=[[o,c],[h,p]],s.call(b),U.brush())}function H(){if(mi(),t.event.touches){if(t.event.touches.length)return;e&&clearTimeout(e),e=setTimeout(function(){e=null},500)}else jt(t.event.view,v),F.on("keydown.brush keyup.brush mousemove.brush mouseup.brush",null);O.attr("pointer-events","all"),B.attr("cursor",Pi.overlay),N.selection&&(A=N.selection),function(t){return t[0][0]===t[1][0]||t[0][1]===t[1][1]}(A)&&(N.selection=null,s.call(b)),U.end()}}function p(){l(this,arguments).moved()}function v(){l(this,arguments).ended()}function g(){var t=this.__brush||{selection:null};return t.extent=Si(r.apply(this,arguments)),t.dim=n,t}return f.move=function(t,e){t.selection?t.on("start.brush",function(){l(this,arguments).beforestart().start()}).on("interrupt.brush end.brush",function(){l(this,arguments).end()}).tween("brush",function(){var t=this,r=t.__brush,i=l(t,arguments),o=r.selection,a=n.input("function"==typeof e?e.apply(this,arguments):e,r.extent),u=Te(o,a);function c(n){r.selection=1===n&&null===a?null:u(n),s.call(t),i.brush()}return null!==o&&null!==a?c:c(1)}):t.each(function(){var t=this,r=arguments,i=t.__brush,o=n.input("function"==typeof e?e.apply(t,r):e,i.extent),a=l(t,r).beforestart();Pr(t),i.selection=null===o?null:o,s.call(t),a.start().brush().end()})},f.clear=function(t){f.move(t,null)},h.prototype={beforestart:function(){return 1==++this.active&&(this.state.emitter=this,this.starting=!0),this},start:function(){return this.starting?(this.starting=!1,this.emit("start")):this.emit("brush"),this},brush:function(){return this.emit("brush"),this},end:function(){return 0==--this.active&&(delete this.state.emitter,this.emit("end")),this},emit:function(t){kt(new bi(f,t,n.output(this.state.selection)),u.apply,u,[t,this.that,this.args])}},f.extent=function(t){return arguments.length?(r="function"==typeof t?t:_i(Si(t)),f):r},f.filter=function(t){return arguments.length?(i="function"==typeof t?t:_i(!!t),f):i},f.touchable=function(t){return arguments.length?(o="function"==typeof t?t:_i(!!t),f):o},f.handleSize=function(t){return arguments.length?(c=+t,f):c},f.keyModifiers=function(t){return arguments.length?(a=!!t,f):a},f.on=function(){var t=u.on.apply(u,arguments);return t===u?f:t},f}var Ii=Math.cos,Hi=Math.sin,ji=Math.PI,Xi=ji/2,Vi=2*ji,Gi=Math.max;function $i(t){return function(n,e){return t(n.source.value+n.target.value,e.source.value+e.target.value)}}var Wi=Array.prototype.slice;function Zi(t){return function(){return t}}var Qi=Math.PI,Ki=2*Qi,Ji=Ki-1e-6;function to(){this._x0=this._y0=this._x1=this._y1=null,this._=""}function no(){return new to}function eo(t){return t.source}function ro(t){return t.target}function io(t){return t.radius}function oo(t){return t.startAngle}function ao(t){return t.endAngle}to.prototype=no.prototype={constructor:to,moveTo:function(t,n){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+n)},closePath:function(){null!==this._x1&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")},lineTo:function(t,n){this._+="L"+(this._x1=+t)+","+(this._y1=+n)},quadraticCurveTo:function(t,n,e,r){this._+="Q"+ +t+","+ +n+","+(this._x1=+e)+","+(this._y1=+r)},bezierCurveTo:function(t,n,e,r,i,o){this._+="C"+ +t+","+ +n+","+ +e+","+ +r+","+(this._x1=+i)+","+(this._y1=+o)},arcTo:function(t,n,e,r,i){t=+t,n=+n,e=+e,r=+r,i=+i;var o=this._x1,a=this._y1,u=e-t,c=r-n,f=o-t,s=a-n,l=f*f+s*s;if(i<0)throw new Error("negative radius: "+i);if(null===this._x1)this._+="M"+(this._x1=t)+","+(this._y1=n);else if(l>1e-6)if(Math.abs(s*u-c*f)>1e-6&&i){var h=e-o,d=r-a,p=u*u+c*c,v=h*h+d*d,g=Math.sqrt(p),y=Math.sqrt(l),_=i*Math.tan((Qi-Math.acos((p+l-v)/(2*g*y)))/2),b=_/y,m=_/g;Math.abs(b-1)>1e-6&&(this._+="L"+(t+b*f)+","+(n+b*s)),this._+="A"+i+","+i+",0,0,"+ +(s*h>f*d)+","+(this._x1=t+m*u)+","+(this._y1=n+m*c)}else this._+="L"+(this._x1=t)+","+(this._y1=n);else;},arc:function(t,n,e,r,i,o){t=+t,n=+n,o=!!o;var a=(e=+e)*Math.cos(r),u=e*Math.sin(r),c=t+a,f=n+u,s=1^o,l=o?r-i:i-r;if(e<0)throw new Error("negative radius: "+e);null===this._x1?this._+="M"+c+","+f:(Math.abs(this._x1-c)>1e-6||Math.abs(this._y1-f)>1e-6)&&(this._+="L"+c+","+f),e&&(l<0&&(l=l%Ki+Ki),l>Ji?this._+="A"+e+","+e+",0,1,"+s+","+(t-a)+","+(n-u)+"A"+e+","+e+",0,1,"+s+","+(this._x1=c)+","+(this._y1=f):l>1e-6&&(this._+="A"+e+","+e+",0,"+ +(l>=Qi)+","+s+","+(this._x1=t+e*Math.cos(i))+","+(this._y1=n+e*Math.sin(i))))},rect:function(t,n,e,r){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+n)+"h"+ +e+"v"+ +r+"h"+-e+"Z"},toString:function(){return this._}};function uo(){}function co(t,n){var e=new uo;if(t instanceof uo)t.each(function(t,n){e.set(n,t)});else if(Array.isArray(t)){var r,i=-1,o=t.length;if(null==n)for(;++i<o;)e.set(i,t[i]);else for(;++i<o;)e.set(n(r=t[i],i,t),r)}else if(t)for(var a in t)e.set(a,t[a]);return e}function fo(){return{}}function so(t,n,e){t[n]=e}function lo(){return co()}function ho(t,n,e){t.set(n,e)}function po(){}uo.prototype=co.prototype={constructor:uo,has:function(t){return"$"+t in this},get:function(t){return this["$"+t]},set:function(t,n){return this["$"+t]=n,this},remove:function(t){var n="$"+t;return n in this&&delete this[n]},clear:function(){for(var t in this)"$"===t[0]&&delete this[t]},keys:function(){var t=[];for(var n in this)"$"===n[0]&&t.push(n.slice(1));return t},values:function(){var t=[];for(var n in this)"$"===n[0]&&t.push(this[n]);return t},entries:function(){var t=[];for(var n in this)"$"===n[0]&&t.push({key:n.slice(1),value:this[n]});return t},size:function(){var t=0;for(var n in this)"$"===n[0]&&++t;return t},empty:function(){for(var t in this)if("$"===t[0])return!1;return!0},each:function(t){for(var n in this)"$"===n[0]&&t(this[n],n.slice(1),this)}};var vo=co.prototype;function go(t,n){var e=new po;if(t instanceof po)t.each(function(t){e.add(t)});else if(t){var r=-1,i=t.length;if(null==n)for(;++r<i;)e.add(t[r]);else for(;++r<i;)e.add(n(t[r],r,t))}return e}po.prototype=go.prototype={constructor:po,has:vo.has,add:function(t){return this["$"+(t+="")]=t,this},remove:vo.remove,clear:vo.clear,values:vo.keys,size:vo.size,empty:vo.empty,each:vo.each};var yo=Array.prototype.slice;function _o(t,n){return t-n}function bo(t){return function(){return t}}function mo(t,n){for(var e,r=-1,i=n.length;++r<i;)if(e=xo(t,n[r]))return e;return 0}function xo(t,n){for(var e=n[0],r=n[1],i=-1,o=0,a=t.length,u=a-1;o<a;u=o++){var c=t[o],f=c[0],s=c[1],l=t[u],h=l[0],d=l[1];if(wo(c,l,n))return 0;s>r!=d>r&&e<(h-f)*(r-s)/(d-s)+f&&(i=-i)}return i}function wo(t,n,e){var r,i,o,a;return function(t,n,e){return(n[0]-t[0])*(e[1]-t[1])==(e[0]-t[0])*(n[1]-t[1])}(t,n,e)&&(i=t[r=+(t[0]===n[0])],o=e[r],a=n[r],i<=o&&o<=a||a<=o&&o<=i)}function Mo(){}var No=[[],[[[1,1.5],[.5,1]]],[[[1.5,1],[1,1.5]]],[[[1.5,1],[.5,1]]],[[[1,.5],[1.5,1]]],[[[1,1.5],[.5,1]],[[1,.5],[1.5,1]]],[[[1,.5],[1,1.5]]],[[[1,.5],[.5,1]]],[[[.5,1],[1,.5]]],[[[1,1.5],[1,.5]]],[[[.5,1],[1,.5]],[[1.5,1],[1,1.5]]],[[[1.5,1],[1,.5]]],[[[.5,1],[1.5,1]]],[[[1,1.5],[1.5,1]]],[[[.5,1],[1,1.5]]],[]];function To(){var t=1,n=1,e=M,r=u;function i(t){var n=e(t);if(Array.isArray(n))n=n.slice().sort(_o);else{var r=s(t),i=r[0],a=r[1];n=w(i,a,n),n=g(Math.floor(i/n)*n,Math.floor(a/n)*n,n)}return n.map(function(n){return o(t,n)})}function o(e,i){var o=[],u=[];return function(e,r,i){var o,u,c,f,s,l,h=new Array,d=new Array;o=u=-1,f=e[0]>=r,No[f<<1].forEach(p);for(;++o<t-1;)c=f,f=e[o+1]>=r,No[c|f<<1].forEach(p);No[f<<0].forEach(p);for(;++u<n-1;){for(o=-1,f=e[u*t+t]>=r,s=e[u*t]>=r,No[f<<1|s<<2].forEach(p);++o<t-1;)c=f,f=e[u*t+t+o+1]>=r,l=s,s=e[u*t+o+1]>=r,No[c|f<<1|s<<2|l<<3].forEach(p);No[f|s<<3].forEach(p)}o=-1,s=e[u*t]>=r,No[s<<2].forEach(p);for(;++o<t-1;)l=s,s=e[u*t+o+1]>=r,No[s<<2|l<<3].forEach(p);function p(t){var n,e,r=[t[0][0]+o,t[0][1]+u],c=[t[1][0]+o,t[1][1]+u],f=a(r),s=a(c);(n=d[f])?(e=h[s])?(delete d[n.end],delete h[e.start],n===e?(n.ring.push(c),i(n.ring)):h[n.start]=d[e.end]={start:n.start,end:e.end,ring:n.ring.concat(e.ring)}):(delete d[n.end],n.ring.push(c),d[n.end=s]=n):(n=h[s])?(e=d[f])?(delete h[n.start],delete d[e.end],n===e?(n.ring.push(c),i(n.ring)):h[e.start]=d[n.end]={start:e.start,end:n.end,ring:e.ring.concat(n.ring)}):(delete h[n.start],n.ring.unshift(r),h[n.start=f]=n):h[f]=d[s]={start:f,end:s,ring:[r,c]}}No[s<<3].forEach(p)}(e,i,function(t){r(t,e,i),function(t){for(var n=0,e=t.length,r=t[e-1][1]*t[0][0]-t[e-1][0]*t[0][1];++n<e;)r+=t[n-1][1]*t[n][0]-t[n-1][0]*t[n][1];return r}(t)>0?o.push([t]):u.push(t)}),u.forEach(function(t){for(var n,e=0,r=o.length;e<r;++e)if(-1!==mo((n=o[e])[0],t))return void n.push(t)}),{type:"MultiPolygon",value:i,coordinates:o}}function a(n){return 2*n[0]+n[1]*(t+1)*4}function u(e,r,i){e.forEach(function(e){var o,a=e[0],u=e[1],c=0|a,f=0|u,s=r[f*t+c];a>0&&a<t&&c===a&&(o=r[f*t+c-1],e[0]=a+(i-o)/(s-o)-.5),u>0&&u<n&&f===u&&(o=r[(f-1)*t+c],e[1]=u+(i-o)/(s-o)-.5)})}return i.contour=o,i.size=function(e){if(!arguments.length)return[t,n];var r=Math.ceil(e[0]),o=Math.ceil(e[1]);if(!(r>0&&o>0))throw new Error("invalid size");return t=r,n=o,i},i.thresholds=function(t){return arguments.length?(e="function"==typeof t?t:Array.isArray(t)?bo(yo.call(t)):bo(t),i):e},i.smooth=function(t){return arguments.length?(r=t?u:Mo,i):r===u},i}function Ao(t,n,e){for(var r=t.width,i=t.height,o=1+(e<<1),a=0;a<i;++a)for(var u=0,c=0;u<r+e;++u)u<r&&(c+=t.data[u+a*r]),u>=e&&(u>=o&&(c-=t.data[u-o+a*r]),n.data[u-e+a*r]=c/Math.min(u+1,r-1+o-u,o))}function So(t,n,e){for(var r=t.width,i=t.height,o=1+(e<<1),a=0;a<r;++a)for(var u=0,c=0;u<i+e;++u)u<i&&(c+=t.data[a+u*r]),u>=e&&(u>=o&&(c-=t.data[a+(u-o)*r]),n.data[a+(u-e)*r]=c/Math.min(u+1,i-1+o-u,o))}function ko(t){return t[0]}function Eo(t){return t[1]}function Co(){return 1}var Po={},zo={},Ro=34,Do=10,qo=13;function Lo(t){return new Function("d","return {"+t.map(function(t,n){return JSON.stringify(t)+": d["+n+'] || ""'}).join(",")+"}")}function Uo(t){var n=Object.create(null),e=[];return t.forEach(function(t){for(var r in t)r in n||e.push(n[r]=r)}),e}function Oo(t,n){var e=t+"",r=e.length;return r<n?new Array(n-r+1).join(0)+e:e}function Bo(t){var n=t.getUTCHours(),e=t.getUTCMinutes(),r=t.getUTCSeconds(),i=t.getUTCMilliseconds();return isNaN(t)?"Invalid Date":function(t){return t<0?"-"+Oo(-t,6):t>9999?"+"+Oo(t,6):Oo(t,4)}(t.getUTCFullYear())+"-"+Oo(t.getUTCMonth()+1,2)+"-"+Oo(t.getUTCDate(),2)+(i?"T"+Oo(n,2)+":"+Oo(e,2)+":"+Oo(r,2)+"."+Oo(i,3)+"Z":r?"T"+Oo(n,2)+":"+Oo(e,2)+":"+Oo(r,2)+"Z":e||n?"T"+Oo(n,2)+":"+Oo(e,2)+"Z":"")}function Fo(t){var n=new RegExp('["'+t+"\n\r]"),e=t.charCodeAt(0);function r(t,n){var r,i=[],o=t.length,a=0,u=0,c=o<=0,f=!1;function s(){if(c)return zo;if(f)return f=!1,Po;var n,r,i=a;if(t.charCodeAt(i)===Ro){for(;a++<o&&t.charCodeAt(a)!==Ro||t.charCodeAt(++a)===Ro;);return(n=a)>=o?c=!0:(r=t.charCodeAt(a++))===Do?f=!0:r===qo&&(f=!0,t.charCodeAt(a)===Do&&++a),t.slice(i+1,n-1).replace(/""/g,'"')}for(;a<o;){if((r=t.charCodeAt(n=a++))===Do)f=!0;else if(r===qo)f=!0,t.charCodeAt(a)===Do&&++a;else if(r!==e)continue;return t.slice(i,n)}return c=!0,t.slice(i,o)}for(t.charCodeAt(o-1)===Do&&--o,t.charCodeAt(o-1)===qo&&--o;(r=s())!==zo;){for(var l=[];r!==Po&&r!==zo;)l.push(r),r=s();n&&null==(l=n(l,u++))||i.push(l)}return i}function i(n,e){return n.map(function(n){return e.map(function(t){return a(n[t])}).join(t)})}function o(n){return n.map(a).join(t)}function a(t){return null==t?"":t instanceof Date?Bo(t):n.test(t+="")?'"'+t.replace(/"/g,'""')+'"':t}return{parse:function(t,n){var e,i,o=r(t,function(t,r){if(e)return e(t,r-1);i=t,e=n?function(t,n){var e=Lo(t);return function(r,i){return n(e(r),i,t)}}(t,n):Lo(t)});return o.columns=i||[],o},parseRows:r,format:function(n,e){return null==e&&(e=Uo(n)),[e.map(a).join(t)].concat(i(n,e)).join("\n")},formatBody:function(t,n){return null==n&&(n=Uo(t)),i(t,n).join("\n")},formatRows:function(t){return t.map(o).join("\n")},formatRow:o,formatValue:a}}var Yo=Fo(","),Io=Yo.parse,Ho=Yo.parseRows,jo=Yo.format,Xo=Yo.formatBody,Vo=Yo.formatRows,Go=Yo.formatRow,$o=Yo.formatValue,Wo=Fo("\t"),Zo=Wo.parse,Qo=Wo.parseRows,Ko=Wo.format,Jo=Wo.formatBody,ta=Wo.formatRows,na=Wo.formatRow,ea=Wo.formatValue;var ra=new Date("2019-01-01T00:00").getHours()||new Date("2019-07-01T00:00").getHours();function ia(t){if(!t.ok)throw new Error(t.status+" "+t.statusText);return t.blob()}function oa(t){if(!t.ok)throw new Error(t.status+" "+t.statusText);return t.arrayBuffer()}function aa(t){if(!t.ok)throw new Error(t.status+" "+t.statusText);return t.text()}function ua(t,n){return fetch(t,n).then(aa)}function ca(t){return function(n,e,r){return 2===arguments.length&&"function"==typeof e&&(r=e,e=void 0),ua(n,e).then(function(n){return t(n,r)})}}var fa=ca(Io),sa=ca(Zo);function la(t){if(!t.ok)throw new Error(t.status+" "+t.statusText);return t.json()}function ha(t){return function(n,e){return ua(n,e).then(function(n){return(new DOMParser).parseFromString(n,t)})}}var da=ha("application/xml"),pa=ha("text/html"),va=ha("image/svg+xml");function ga(t){return function(){return t}}function ya(){return 1e-6*(Math.random()-.5)}function _a(t,n,e,r){if(isNaN(n)||isNaN(e))return t;var i,o,a,u,c,f,s,l,h,d=t._root,p={data:r},v=t._x0,g=t._y0,y=t._x1,_=t._y1;if(!d)return t._root=p,t;for(;d.length;)if((f=n>=(o=(v+y)/2))?v=o:y=o,(s=e>=(a=(g+_)/2))?g=a:_=a,i=d,!(d=d[l=s<<1|f]))return i[l]=p,t;if(u=+t._x.call(null,d.data),c=+t._y.call(null,d.data),n===u&&e===c)return p.next=d,i?i[l]=p:t._root=p,t;do{i=i?i[l]=new Array(4):t._root=new Array(4),(f=n>=(o=(v+y)/2))?v=o:y=o,(s=e>=(a=(g+_)/2))?g=a:_=a}while((l=s<<1|f)==(h=(c>=a)<<1|u>=o));return i[h]=d,i[l]=p,t}function ba(t,n,e,r,i){this.node=t,this.x0=n,this.y0=e,this.x1=r,this.y1=i}function ma(t){return t[0]}function xa(t){return t[1]}function wa(t,n,e){var r=new Ma(null==n?ma:n,null==e?xa:e,NaN,NaN,NaN,NaN);return null==t?r:r.addAll(t)}function Ma(t,n,e,r,i,o){this._x=t,this._y=n,this._x0=e,this._y0=r,this._x1=i,this._y1=o,this._root=void 0}function Na(t){for(var n={data:t.data},e=n;t=t.next;)e=e.next={data:t.data};return n}var Ta=wa.prototype=Ma.prototype;function Aa(t){return t.x+t.vx}function Sa(t){return t.y+t.vy}function ka(t){return t.index}function Ea(t,n){var e=t.get(n);if(!e)throw new Error("missing: "+n);return e}function Ca(t){return t.x}function Pa(t){return t.y}Ta.copy=function(){var t,n,e=new Ma(this._x,this._y,this._x0,this._y0,this._x1,this._y1),r=this._root;if(!r)return e;if(!r.length)return e._root=Na(r),e;for(t=[{source:r,target:e._root=new Array(4)}];r=t.pop();)for(var i=0;i<4;++i)(n=r.source[i])&&(n.length?t.push({source:n,target:r.target[i]=new Array(4)}):r.target[i]=Na(n));return e},Ta.add=function(t){var n=+this._x.call(null,t),e=+this._y.call(null,t);return _a(this.cover(n,e),n,e,t)},Ta.addAll=function(t){var n,e,r,i,o=t.length,a=new Array(o),u=new Array(o),c=1/0,f=1/0,s=-1/0,l=-1/0;for(e=0;e<o;++e)isNaN(r=+this._x.call(null,n=t[e]))||isNaN(i=+this._y.call(null,n))||(a[e]=r,u[e]=i,r<c&&(c=r),r>s&&(s=r),i<f&&(f=i),i>l&&(l=i));if(c>s||f>l)return this;for(this.cover(c,f).cover(s,l),e=0;e<o;++e)_a(this,a[e],u[e],t[e]);return this},Ta.cover=function(t,n){if(isNaN(t=+t)||isNaN(n=+n))return this;var e=this._x0,r=this._y0,i=this._x1,o=this._y1;if(isNaN(e))i=(e=Math.floor(t))+1,o=(r=Math.floor(n))+1;else{for(var a,u,c=i-e,f=this._root;e>t||t>=i||r>n||n>=o;)switch(u=(n<r)<<1|t<e,(a=new Array(4))[u]=f,f=a,c*=2,u){case 0:i=e+c,o=r+c;break;case 1:e=i-c,o=r+c;break;case 2:i=e+c,r=o-c;break;case 3:e=i-c,r=o-c}this._root&&this._root.length&&(this._root=f)}return this._x0=e,this._y0=r,this._x1=i,this._y1=o,this},Ta.data=function(){var t=[];return this.visit(function(n){if(!n.length)do{t.push(n.data)}while(n=n.next)}),t},Ta.extent=function(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},Ta.find=function(t,n,e){var r,i,o,a,u,c,f,s=this._x0,l=this._y0,h=this._x1,d=this._y1,p=[],v=this._root;for(v&&p.push(new ba(v,s,l,h,d)),null==e?e=1/0:(s=t-e,l=n-e,h=t+e,d=n+e,e*=e);c=p.pop();)if(!(!(v=c.node)||(i=c.x0)>h||(o=c.y0)>d||(a=c.x1)<s||(u=c.y1)<l))if(v.length){var g=(i+a)/2,y=(o+u)/2;p.push(new ba(v[3],g,y,a,u),new ba(v[2],i,y,g,u),new ba(v[1],g,o,a,y),new ba(v[0],i,o,g,y)),(f=(n>=y)<<1|t>=g)&&(c=p[p.length-1],p[p.length-1]=p[p.length-1-f],p[p.length-1-f]=c)}else{var _=t-+this._x.call(null,v.data),b=n-+this._y.call(null,v.data),m=_*_+b*b;if(m<e){var x=Math.sqrt(e=m);s=t-x,l=n-x,h=t+x,d=n+x,r=v.data}}return r},Ta.remove=function(t){if(isNaN(o=+this._x.call(null,t))||isNaN(a=+this._y.call(null,t)))return this;var n,e,r,i,o,a,u,c,f,s,l,h,d=this._root,p=this._x0,v=this._y0,g=this._x1,y=this._y1;if(!d)return this;if(d.length)for(;;){if((f=o>=(u=(p+g)/2))?p=u:g=u,(s=a>=(c=(v+y)/2))?v=c:y=c,n=d,!(d=d[l=s<<1|f]))return this;if(!d.length)break;(n[l+1&3]||n[l+2&3]||n[l+3&3])&&(e=n,h=l)}for(;d.data!==t;)if(r=d,!(d=d.next))return this;return(i=d.next)&&delete d.next,r?(i?r.next=i:delete r.next,this):n?(i?n[l]=i:delete n[l],(d=n[0]||n[1]||n[2]||n[3])&&d===(n[3]||n[2]||n[1]||n[0])&&!d.length&&(e?e[h]=d:this._root=d),this):(this._root=i,this)},Ta.removeAll=function(t){for(var n=0,e=t.length;n<e;++n)this.remove(t[n]);return this},Ta.root=function(){return this._root},Ta.size=function(){var t=0;return this.visit(function(n){if(!n.length)do{++t}while(n=n.next)}),t},Ta.visit=function(t){var n,e,r,i,o,a,u=[],c=this._root;for(c&&u.push(new ba(c,this._x0,this._y0,this._x1,this._y1));n=u.pop();)if(!t(c=n.node,r=n.x0,i=n.y0,o=n.x1,a=n.y1)&&c.length){var f=(r+o)/2,s=(i+a)/2;(e=c[3])&&u.push(new ba(e,f,s,o,a)),(e=c[2])&&u.push(new ba(e,r,s,f,a)),(e=c[1])&&u.push(new ba(e,f,i,o,s)),(e=c[0])&&u.push(new ba(e,r,i,f,s))}return this},Ta.visitAfter=function(t){var n,e=[],r=[];for(this._root&&e.push(new ba(this._root,this._x0,this._y0,this._x1,this._y1));n=e.pop();){var i=n.node;if(i.length){var o,a=n.x0,u=n.y0,c=n.x1,f=n.y1,s=(a+c)/2,l=(u+f)/2;(o=i[0])&&e.push(new ba(o,a,u,s,l)),(o=i[1])&&e.push(new ba(o,s,u,c,l)),(o=i[2])&&e.push(new ba(o,a,l,s,f)),(o=i[3])&&e.push(new ba(o,s,l,c,f))}r.push(n)}for(;n=r.pop();)t(n.node,n.x0,n.y0,n.x1,n.y1);return this},Ta.x=function(t){return arguments.length?(this._x=t,this):this._x},Ta.y=function(t){return arguments.length?(this._y=t,this):this._y};var za=10,Ra=Math.PI*(3-Math.sqrt(5));function Da(t,n){if((e=(t=n?t.toExponential(n-1):t.toExponential()).indexOf("e"))<0)return null;var e,r=t.slice(0,e);return[r.length>1?r[0]+r.slice(2):r,+t.slice(e+1)]}function qa(t){return(t=Da(Math.abs(t)))?t[1]:NaN}var La,Ua=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Oa(t){if(!(n=Ua.exec(t)))throw new Error("invalid format: "+t);var n;return new Ba({fill:n[1],align:n[2],sign:n[3],symbol:n[4],zero:n[5],width:n[6],comma:n[7],precision:n[8]&&n[8].slice(1),trim:n[9],type:n[10]})}function Ba(t){this.fill=void 0===t.fill?" ":t.fill+"",this.align=void 0===t.align?">":t.align+"",this.sign=void 0===t.sign?"-":t.sign+"",this.symbol=void 0===t.symbol?"":t.symbol+"",this.zero=!!t.zero,this.width=void 0===t.width?void 0:+t.width,this.comma=!!t.comma,this.precision=void 0===t.precision?void 0:+t.precision,this.trim=!!t.trim,this.type=void 0===t.type?"":t.type+""}function Fa(t,n){var e=Da(t,n);if(!e)return t+"";var r=e[0],i=e[1];return i<0?"0."+new Array(-i).join("0")+r:r.length>i+1?r.slice(0,i+1)+"."+r.slice(i+1):r+new Array(i-r.length+2).join("0")}Oa.prototype=Ba.prototype,Ba.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(void 0===this.width?"":Math.max(1,0|this.width))+(this.comma?",":"")+(void 0===this.precision?"":"."+Math.max(0,0|this.precision))+(this.trim?"~":"")+this.type};var Ya={"%":function(t,n){return(100*t).toFixed(n)},b:function(t){return Math.round(t).toString(2)},c:function(t){return t+""},d:function(t){return Math.round(t).toString(10)},e:function(t,n){return t.toExponential(n)},f:function(t,n){return t.toFixed(n)},g:function(t,n){return t.toPrecision(n)},o:function(t){return Math.round(t).toString(8)},p:function(t,n){return Fa(100*t,n)},r:Fa,s:function(t,n){var e=Da(t,n);if(!e)return t+"";var r=e[0],i=e[1],o=i-(La=3*Math.max(-8,Math.min(8,Math.floor(i/3))))+1,a=r.length;return o===a?r:o>a?r+new Array(o-a+1).join("0"):o>0?r.slice(0,o)+"."+r.slice(o):"0."+new Array(1-o).join("0")+Da(t,Math.max(0,n+o-1))[0]},X:function(t){return Math.round(t).toString(16).toUpperCase()},x:function(t){return Math.round(t).toString(16)}};function Ia(t){return t}var Ha,ja=Array.prototype.map,Xa=["y","z","a","f","p","n","","m","","k","M","G","T","P","E","Z","Y"];function Va(t){var n,e,r=void 0===t.grouping||void 0===t.thousands?Ia:(n=ja.call(t.grouping,Number),e=t.thousands+"",function(t,r){for(var i=t.length,o=[],a=0,u=n[0],c=0;i>0&&u>0&&(c+u+1>r&&(u=Math.max(1,r-c)),o.push(t.substring(i-=u,i+u)),!((c+=u+1)>r));)u=n[a=(a+1)%n.length];return o.reverse().join(e)}),i=void 0===t.currency?"":t.currency[0]+"",o=void 0===t.currency?"":t.currency[1]+"",a=void 0===t.decimal?".":t.decimal+"",u=void 0===t.numerals?Ia:function(t){return function(n){return n.replace(/[0-9]/g,function(n){return t[+n]})}}(ja.call(t.numerals,String)),c=void 0===t.percent?"%":t.percent+"",f=void 0===t.minus?"-":t.minus+"",s=void 0===t.nan?"NaN":t.nan+"";function l(t){var n=(t=Oa(t)).fill,e=t.align,l=t.sign,h=t.symbol,d=t.zero,p=t.width,v=t.comma,g=t.precision,y=t.trim,_=t.type;"n"===_?(v=!0,_="g"):Ya[_]||(void 0===g&&(g=12),y=!0,_="g"),(d||"0"===n&&"="===e)&&(d=!0,n="0",e="=");var b="$"===h?i:"#"===h&&/[boxX]/.test(_)?"0"+_.toLowerCase():"",m="$"===h?o:/[%p]/.test(_)?c:"",x=Ya[_],w=/[defgprs%]/.test(_);function M(t){var i,o,c,h=b,M=m;if("c"===_)M=x(t)+M,t="";else{var N=(t=+t)<0||1/t<0;if(t=isNaN(t)?s:x(Math.abs(t),g),y&&(t=function(t){t:for(var n,e=t.length,r=1,i=-1;r<e;++r)switch(t[r]){case".":i=n=r;break;case"0":0===i&&(i=r),n=r;break;default:if(!+t[r])break t;i>0&&(i=0)}return i>0?t.slice(0,i)+t.slice(n+1):t}(t)),N&&0==+t&&"+"!==l&&(N=!1),h=(N?"("===l?l:f:"-"===l||"("===l?"":l)+h,M=("s"===_?Xa[8+La/3]:"")+M+(N&&"("===l?")":""),w)for(i=-1,o=t.length;++i<o;)if(48>(c=t.charCodeAt(i))||c>57){M=(46===c?a+t.slice(i+1):t.slice(i))+M,t=t.slice(0,i);break}}v&&!d&&(t=r(t,1/0));var T=h.length+t.length+M.length,A=T<p?new Array(p-T+1).join(n):"";switch(v&&d&&(t=r(A+t,A.length?p-M.length:1/0),A=""),e){case"<":t=h+t+M+A;break;case"=":t=h+A+t+M;break;case"^":t=A.slice(0,T=A.length>>1)+h+t+M+A.slice(T);break;default:t=A+h+t+M}return u(t)}return g=void 0===g?6:/[gprs]/.test(_)?Math.max(1,Math.min(21,g)):Math.max(0,Math.min(20,g)),M.toString=function(){return t+""},M}return{format:l,formatPrefix:function(t,n){var e=l(((t=Oa(t)).type="f",t)),r=3*Math.max(-8,Math.min(8,Math.floor(qa(n)/3))),i=Math.pow(10,-r),o=Xa[8+r/3];return function(t){return e(i*t)+o}}}}function Ga(n){return Ha=Va(n),t.format=Ha.format,t.formatPrefix=Ha.formatPrefix,Ha}function $a(t){return Math.max(0,-qa(Math.abs(t)))}function Wa(t,n){return Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(qa(n)/3)))-qa(Math.abs(t)))}function Za(t,n){return t=Math.abs(t),n=Math.abs(n)-t,Math.max(0,qa(n)-qa(t))+1}function Qa(){return new Ka}function Ka(){this.reset()}Ga({decimal:".",thousands:",",grouping:[3],currency:["$",""],minus:"-"}),Ka.prototype={constructor:Ka,reset:function(){this.s=this.t=0},add:function(t){tu(Ja,t,this.t),tu(this,Ja.s,this.s),this.s?this.t+=Ja.t:this.s=Ja.t},valueOf:function(){return this.s}};var Ja=new Ka;function tu(t,n,e){var r=t.s=n+e,i=r-n,o=r-i;t.t=n-o+(e-i)}var nu=1e-6,eu=1e-12,ru=Math.PI,iu=ru/2,ou=ru/4,au=2*ru,uu=180/ru,cu=ru/180,fu=Math.abs,su=Math.atan,lu=Math.atan2,hu=Math.cos,du=Math.ceil,pu=Math.exp,vu=Math.log,gu=Math.pow,yu=Math.sin,_u=Math.sign||function(t){return t>0?1:t<0?-1:0},bu=Math.sqrt,mu=Math.tan;function xu(t){return t>1?0:t<-1?ru:Math.acos(t)}function wu(t){return t>1?iu:t<-1?-iu:Math.asin(t)}function Mu(t){return(t=yu(t/2))*t}function Nu(){}function Tu(t,n){t&&Su.hasOwnProperty(t.type)&&Su[t.type](t,n)}var Au={Feature:function(t,n){Tu(t.geometry,n)},FeatureCollection:function(t,n){for(var e=t.features,r=-1,i=e.length;++r<i;)Tu(e[r].geometry,n)}},Su={Sphere:function(t,n){n.sphere()},Point:function(t,n){t=t.coordinates,n.point(t[0],t[1],t[2])},MultiPoint:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)t=e[r],n.point(t[0],t[1],t[2])},LineString:function(t,n){ku(t.coordinates,n,0)},MultiLineString:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)ku(e[r],n,0)},Polygon:function(t,n){Eu(t.coordinates,n)},MultiPolygon:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)Eu(e[r],n)},GeometryCollection:function(t,n){for(var e=t.geometries,r=-1,i=e.length;++r<i;)Tu(e[r],n)}};function ku(t,n,e){var r,i=-1,o=t.length-e;for(n.lineStart();++i<o;)r=t[i],n.point(r[0],r[1],r[2]);n.lineEnd()}function Eu(t,n){var e=-1,r=t.length;for(n.polygonStart();++e<r;)ku(t[e],n,1);n.polygonEnd()}function Cu(t,n){t&&Au.hasOwnProperty(t.type)?Au[t.type](t,n):Tu(t,n)}var Pu,zu,Ru,Du,qu,Lu=Qa(),Uu=Qa(),Ou={point:Nu,lineStart:Nu,lineEnd:Nu,polygonStart:function(){Lu.reset(),Ou.lineStart=Bu,Ou.lineEnd=Fu},polygonEnd:function(){var t=+Lu;Uu.add(t<0?au+t:t),this.lineStart=this.lineEnd=this.point=Nu},sphere:function(){Uu.add(au)}};function Bu(){Ou.point=Yu}function Fu(){Iu(Pu,zu)}function Yu(t,n){Ou.point=Iu,Pu=t,zu=n,Ru=t*=cu,Du=hu(n=(n*=cu)/2+ou),qu=yu(n)}function Iu(t,n){var e=(t*=cu)-Ru,r=e>=0?1:-1,i=r*e,o=hu(n=(n*=cu)/2+ou),a=yu(n),u=qu*a,c=Du*o+u*hu(i),f=u*r*yu(i);Lu.add(lu(f,c)),Ru=t,Du=o,qu=a}function Hu(t){return[lu(t[1],t[0]),wu(t[2])]}function ju(t){var n=t[0],e=t[1],r=hu(e);return[r*hu(n),r*yu(n),yu(e)]}function Xu(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function Vu(t,n){return[t[1]*n[2]-t[2]*n[1],t[2]*n[0]-t[0]*n[2],t[0]*n[1]-t[1]*n[0]]}function Gu(t,n){t[0]+=n[0],t[1]+=n[1],t[2]+=n[2]}function $u(t,n){return[t[0]*n,t[1]*n,t[2]*n]}function Wu(t){var n=bu(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=n,t[1]/=n,t[2]/=n}var Zu,Qu,Ku,Ju,tc,nc,ec,rc,ic,oc,ac,uc,cc,fc,sc,lc,hc,dc,pc,vc,gc,yc,_c,bc,mc,xc,wc=Qa(),Mc={point:Nc,lineStart:Ac,lineEnd:Sc,polygonStart:function(){Mc.point=kc,Mc.lineStart=Ec,Mc.lineEnd=Cc,wc.reset(),Ou.polygonStart()},polygonEnd:function(){Ou.polygonEnd(),Mc.point=Nc,Mc.lineStart=Ac,Mc.lineEnd=Sc,Lu<0?(Zu=-(Ku=180),Qu=-(Ju=90)):wc>nu?Ju=90:wc<-nu&&(Qu=-90),oc[0]=Zu,oc[1]=Ku},sphere:function(){Zu=-(Ku=180),Qu=-(Ju=90)}};function Nc(t,n){ic.push(oc=[Zu=t,Ku=t]),n<Qu&&(Qu=n),n>Ju&&(Ju=n)}function Tc(t,n){var e=ju([t*cu,n*cu]);if(rc){var r=Vu(rc,e),i=Vu([r[1],-r[0],0],r);Wu(i),i=Hu(i);var o,a=t-tc,u=a>0?1:-1,c=i[0]*uu*u,f=fu(a)>180;f^(u*tc<c&&c<u*t)?(o=i[1]*uu)>Ju&&(Ju=o):f^(u*tc<(c=(c+360)%360-180)&&c<u*t)?(o=-i[1]*uu)<Qu&&(Qu=o):(n<Qu&&(Qu=n),n>Ju&&(Ju=n)),f?t<tc?Pc(Zu,t)>Pc(Zu,Ku)&&(Ku=t):Pc(t,Ku)>Pc(Zu,Ku)&&(Zu=t):Ku>=Zu?(t<Zu&&(Zu=t),t>Ku&&(Ku=t)):t>tc?Pc(Zu,t)>Pc(Zu,Ku)&&(Ku=t):Pc(t,Ku)>Pc(Zu,Ku)&&(Zu=t)}else ic.push(oc=[Zu=t,Ku=t]);n<Qu&&(Qu=n),n>Ju&&(Ju=n),rc=e,tc=t}function Ac(){Mc.point=Tc}function Sc(){oc[0]=Zu,oc[1]=Ku,Mc.point=Nc,rc=null}function kc(t,n){if(rc){var e=t-tc;wc.add(fu(e)>180?e+(e>0?360:-360):e)}else nc=t,ec=n;Ou.point(t,n),Tc(t,n)}function Ec(){Ou.lineStart()}function Cc(){kc(nc,ec),Ou.lineEnd(),fu(wc)>nu&&(Zu=-(Ku=180)),oc[0]=Zu,oc[1]=Ku,rc=null}function Pc(t,n){return(n-=t)<0?n+360:n}function zc(t,n){return t[0]-n[0]}function Rc(t,n){return t[0]<=t[1]?t[0]<=n&&n<=t[1]:n<t[0]||t[1]<n}var Dc={sphere:Nu,point:qc,lineStart:Uc,lineEnd:Fc,polygonStart:function(){Dc.lineStart=Yc,Dc.lineEnd=Ic},polygonEnd:function(){Dc.lineStart=Uc,Dc.lineEnd=Fc}};function qc(t,n){t*=cu;var e=hu(n*=cu);Lc(e*hu(t),e*yu(t),yu(n))}function Lc(t,n,e){cc+=(t-cc)/++ac,fc+=(n-fc)/ac,sc+=(e-sc)/ac}function Uc(){Dc.point=Oc}function Oc(t,n){t*=cu;var e=hu(n*=cu);bc=e*hu(t),mc=e*yu(t),xc=yu(n),Dc.point=Bc,Lc(bc,mc,xc)}function Bc(t,n){t*=cu;var e=hu(n*=cu),r=e*hu(t),i=e*yu(t),o=yu(n),a=lu(bu((a=mc*o-xc*i)*a+(a=xc*r-bc*o)*a+(a=bc*i-mc*r)*a),bc*r+mc*i+xc*o);uc+=a,lc+=a*(bc+(bc=r)),hc+=a*(mc+(mc=i)),dc+=a*(xc+(xc=o)),Lc(bc,mc,xc)}function Fc(){Dc.point=qc}function Yc(){Dc.point=Hc}function Ic(){jc(yc,_c),Dc.point=qc}function Hc(t,n){yc=t,_c=n,t*=cu,n*=cu,Dc.point=jc;var e=hu(n);bc=e*hu(t),mc=e*yu(t),xc=yu(n),Lc(bc,mc,xc)}function jc(t,n){t*=cu;var e=hu(n*=cu),r=e*hu(t),i=e*yu(t),o=yu(n),a=mc*o-xc*i,u=xc*r-bc*o,c=bc*i-mc*r,f=bu(a*a+u*u+c*c),s=wu(f),l=f&&-s/f;pc+=l*a,vc+=l*u,gc+=l*c,uc+=s,lc+=s*(bc+(bc=r)),hc+=s*(mc+(mc=i)),dc+=s*(xc+(xc=o)),Lc(bc,mc,xc)}function Xc(t){return function(){return t}}function Vc(t,n){function e(e,r){return e=t(e,r),n(e[0],e[1])}return t.invert&&n.invert&&(e.invert=function(e,r){return(e=n.invert(e,r))&&t.invert(e[0],e[1])}),e}function Gc(t,n){return[fu(t)>ru?t+Math.round(-t/au)*au:t,n]}function $c(t,n,e){return(t%=au)?n||e?Vc(Zc(t),Qc(n,e)):Zc(t):n||e?Qc(n,e):Gc}function Wc(t){return function(n,e){return[(n+=t)>ru?n-au:n<-ru?n+au:n,e]}}function Zc(t){var n=Wc(t);return n.invert=Wc(-t),n}function Qc(t,n){var e=hu(t),r=yu(t),i=hu(n),o=yu(n);function a(t,n){var a=hu(n),u=hu(t)*a,c=yu(t)*a,f=yu(n),s=f*e+u*r;return[lu(c*i-s*o,u*e-f*r),wu(s*i+c*o)]}return a.invert=function(t,n){var a=hu(n),u=hu(t)*a,c=yu(t)*a,f=yu(n),s=f*i-c*o;return[lu(c*i+f*o,u*e+s*r),wu(s*e-u*r)]},a}function Kc(t){function n(n){return(n=t(n[0]*cu,n[1]*cu))[0]*=uu,n[1]*=uu,n}return t=$c(t[0]*cu,t[1]*cu,t.length>2?t[2]*cu:0),n.invert=function(n){return(n=t.invert(n[0]*cu,n[1]*cu))[0]*=uu,n[1]*=uu,n},n}function Jc(t,n,e,r,i,o){if(e){var a=hu(n),u=yu(n),c=r*e;null==i?(i=n+r*au,o=n-c/2):(i=tf(a,i),o=tf(a,o),(r>0?i<o:i>o)&&(i+=r*au));for(var f,s=i;r>0?s>o:s<o;s-=c)f=Hu([a,-u*hu(s),-u*yu(s)]),t.point(f[0],f[1])}}function tf(t,n){(n=ju(n))[0]-=t,Wu(n);var e=xu(-n[1]);return((-n[2]<0?-e:e)+au-nu)%au}function nf(){var t,n=[];return{point:function(n,e){t.push([n,e])},lineStart:function(){n.push(t=[])},lineEnd:Nu,rejoin:function(){n.length>1&&n.push(n.pop().concat(n.shift()))},result:function(){var e=n;return n=[],t=null,e}}}function ef(t,n){return fu(t[0]-n[0])<nu&&fu(t[1]-n[1])<nu}function rf(t,n,e,r){this.x=t,this.z=n,this.o=e,this.e=r,this.v=!1,this.n=this.p=null}function of(t,n,e,r,i){var o,a,u=[],c=[];if(t.forEach(function(t){if(!((n=t.length-1)<=0)){var n,e,r=t[0],a=t[n];if(ef(r,a)){for(i.lineStart(),o=0;o<n;++o)i.point((r=t[o])[0],r[1]);i.lineEnd()}else u.push(e=new rf(r,t,null,!0)),c.push(e.o=new rf(r,null,e,!1)),u.push(e=new rf(a,t,null,!1)),c.push(e.o=new rf(a,null,e,!0))}}),u.length){for(c.sort(n),af(u),af(c),o=0,a=c.length;o<a;++o)c[o].e=e=!e;for(var f,s,l=u[0];;){for(var h=l,d=!0;h.v;)if((h=h.n)===l)return;f=h.z,i.lineStart();do{if(h.v=h.o.v=!0,h.e){if(d)for(o=0,a=f.length;o<a;++o)i.point((s=f[o])[0],s[1]);else r(h.x,h.n.x,1,i);h=h.n}else{if(d)for(f=h.p.z,o=f.length-1;o>=0;--o)i.point((s=f[o])[0],s[1]);else r(h.x,h.p.x,-1,i);h=h.p}f=(h=h.o).z,d=!d}while(!h.v);i.lineEnd()}}}function af(t){if(n=t.length){for(var n,e,r=0,i=t[0];++r<n;)i.n=e=t[r],e.p=i,i=e;i.n=e=t[0],e.p=i}}Gc.invert=Gc;var uf=Qa();function cf(t){return fu(t[0])<=ru?t[0]:_u(t[0])*((fu(t[0])+ru)%au-ru)}function ff(t,n){var e=cf(n),r=n[1],i=yu(r),o=[yu(e),-hu(e),0],a=0,u=0;uf.reset(),1===i?r=iu+nu:-1===i&&(r=-iu-nu);for(var c=0,f=t.length;c<f;++c)if(l=(s=t[c]).length)for(var s,l,h=s[l-1],d=cf(h),p=h[1]/2+ou,v=yu(p),g=hu(p),y=0;y<l;++y,d=b,v=x,g=w,h=_){var _=s[y],b=cf(_),m=_[1]/2+ou,x=yu(m),w=hu(m),M=b-d,N=M>=0?1:-1,T=N*M,A=T>ru,S=v*x;if(uf.add(lu(S*N*yu(T),g*w+S*hu(T))),a+=A?M+N*au:M,A^d>=e^b>=e){var k=Vu(ju(h),ju(_));Wu(k);var E=Vu(o,k);Wu(E);var C=(A^M>=0?-1:1)*wu(E[2]);(r>C||r===C&&(k[0]||k[1]))&&(u+=A^M>=0?1:-1)}}return(a<-nu||a<nu&&uf<-nu)^1&u}function sf(t,n,e,r){return function(i){var o,a,u,c=n(i),f=nf(),s=n(f),l=!1,h={point:d,lineStart:v,lineEnd:g,polygonStart:function(){h.point=y,h.lineStart=_,h.lineEnd=b,a=[],o=[]},polygonEnd:function(){h.point=d,h.lineStart=v,h.lineEnd=g,a=A(a);var t=ff(o,r);a.length?(l||(i.polygonStart(),l=!0),of(a,hf,t,e,i)):t&&(l||(i.polygonStart(),l=!0),i.lineStart(),e(null,null,1,i),i.lineEnd()),l&&(i.polygonEnd(),l=!1),a=o=null},sphere:function(){i.polygonStart(),i.lineStart(),e(null,null,1,i),i.lineEnd(),i.polygonEnd()}};function d(n,e){t(n,e)&&i.point(n,e)}function p(t,n){c.point(t,n)}function v(){h.point=p,c.lineStart()}function g(){h.point=d,c.lineEnd()}function y(t,n){u.push([t,n]),s.point(t,n)}function _(){s.lineStart(),u=[]}function b(){y(u[0][0],u[0][1]),s.lineEnd();var t,n,e,r,c=s.clean(),h=f.result(),d=h.length;if(u.pop(),o.push(u),u=null,d)if(1&c){if((n=(e=h[0]).length-1)>0){for(l||(i.polygonStart(),l=!0),i.lineStart(),t=0;t<n;++t)i.point((r=e[t])[0],r[1]);i.lineEnd()}}else d>1&&2&c&&h.push(h.pop().concat(h.shift())),a.push(h.filter(lf))}return h}}function lf(t){return t.length>1}function hf(t,n){return((t=t.x)[0]<0?t[1]-iu-nu:iu-t[1])-((n=n.x)[0]<0?n[1]-iu-nu:iu-n[1])}var df=sf(function(){return!0},function(t){var n,e=NaN,r=NaN,i=NaN;return{lineStart:function(){t.lineStart(),n=1},point:function(o,a){var u=o>0?ru:-ru,c=fu(o-e);fu(c-ru)<nu?(t.point(e,r=(r+a)/2>0?iu:-iu),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(u,r),t.point(o,r),n=0):i!==u&&c>=ru&&(fu(e-i)<nu&&(e-=i*nu),fu(o-u)<nu&&(o-=u*nu),r=function(t,n,e,r){var i,o,a=yu(t-e);return fu(a)>nu?su((yu(n)*(o=hu(r))*yu(e)-yu(r)*(i=hu(n))*yu(t))/(i*o*a)):(n+r)/2}(e,r,o,a),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(u,r),n=0),t.point(e=o,r=a),i=u},lineEnd:function(){t.lineEnd(),e=r=NaN},clean:function(){return 2-n}}},function(t,n,e,r){var i;if(null==t)i=e*iu,r.point(-ru,i),r.point(0,i),r.point(ru,i),r.point(ru,0),r.point(ru,-i),r.point(0,-i),r.point(-ru,-i),r.point(-ru,0),r.point(-ru,i);else if(fu(t[0]-n[0])>nu){var o=t[0]<n[0]?ru:-ru;i=e*o/2,r.point(-o,i),r.point(0,i),r.point(o,i)}else r.point(n[0],n[1])},[-ru,-iu]);function pf(t){var n=hu(t),e=6*cu,r=n>0,i=fu(n)>nu;function o(t,e){return hu(t)*hu(e)>n}function a(t,e,r){var i=[1,0,0],o=Vu(ju(t),ju(e)),a=Xu(o,o),u=o[0],c=a-u*u;if(!c)return!r&&t;var f=n*a/c,s=-n*u/c,l=Vu(i,o),h=$u(i,f);Gu(h,$u(o,s));var d=l,p=Xu(h,d),v=Xu(d,d),g=p*p-v*(Xu(h,h)-1);if(!(g<0)){var y=bu(g),_=$u(d,(-p-y)/v);if(Gu(_,h),_=Hu(_),!r)return _;var b,m=t[0],x=e[0],w=t[1],M=e[1];x<m&&(b=m,m=x,x=b);var N=x-m,T=fu(N-ru)<nu;if(!T&&M<w&&(b=w,w=M,M=b),T||N<nu?T?w+M>0^_[1]<(fu(_[0]-m)<nu?w:M):w<=_[1]&&_[1]<=M:N>ru^(m<=_[0]&&_[0]<=x)){var A=$u(d,(-p+y)/v);return Gu(A,h),[_,Hu(A)]}}}function u(n,e){var i=r?t:ru-t,o=0;return n<-i?o|=1:n>i&&(o|=2),e<-i?o|=4:e>i&&(o|=8),o}return sf(o,function(t){var n,e,c,f,s;return{lineStart:function(){f=c=!1,s=1},point:function(l,h){var d,p=[l,h],v=o(l,h),g=r?v?0:u(l,h):v?u(l+(l<0?ru:-ru),h):0;if(!n&&(f=c=v)&&t.lineStart(),v!==c&&(!(d=a(n,p))||ef(n,d)||ef(p,d))&&(p[0]+=nu,p[1]+=nu,v=o(p[0],p[1])),v!==c)s=0,v?(t.lineStart(),d=a(p,n),t.point(d[0],d[1])):(d=a(n,p),t.point(d[0],d[1]),t.lineEnd()),n=d;else if(i&&n&&r^v){var y;g&e||!(y=a(p,n,!0))||(s=0,r?(t.lineStart(),t.point(y[0][0],y[0][1]),t.point(y[1][0],y[1][1]),t.lineEnd()):(t.point(y[1][0],y[1][1]),t.lineEnd(),t.lineStart(),t.point(y[0][0],y[0][1])))}!v||n&&ef(n,p)||t.point(p[0],p[1]),n=p,c=v,e=g},lineEnd:function(){c&&t.lineEnd(),n=null},clean:function(){return s|(f&&c)<<1}}},function(n,r,i,o){Jc(o,t,e,i,n,r)},r?[0,-t]:[-ru,t-ru])}var vf=1e9,gf=-vf;function yf(t,n,e,r){function i(i,o){return t<=i&&i<=e&&n<=o&&o<=r}function o(i,o,u,f){var s=0,l=0;if(null==i||(s=a(i,u))!==(l=a(o,u))||c(i,o)<0^u>0)do{f.point(0===s||3===s?t:e,s>1?r:n)}while((s=(s+u+4)%4)!==l);else f.point(o[0],o[1])}function a(r,i){return fu(r[0]-t)<nu?i>0?0:3:fu(r[0]-e)<nu?i>0?2:1:fu(r[1]-n)<nu?i>0?1:0:i>0?3:2}function u(t,n){return c(t.x,n.x)}function c(t,n){var e=a(t,1),r=a(n,1);return e!==r?e-r:0===e?n[1]-t[1]:1===e?t[0]-n[0]:2===e?t[1]-n[1]:n[0]-t[0]}return function(a){var c,f,s,l,h,d,p,v,g,y,_,b=a,m=nf(),x={point:w,lineStart:function(){x.point=M,f&&f.push(s=[]);y=!0,g=!1,p=v=NaN},lineEnd:function(){c&&(M(l,h),d&&g&&m.rejoin(),c.push(m.result()));x.point=w,g&&b.lineEnd()},polygonStart:function(){b=m,c=[],f=[],_=!0},polygonEnd:function(){var n=function(){for(var n=0,e=0,i=f.length;e<i;++e)for(var o,a,u=f[e],c=1,s=u.length,l=u[0],h=l[0],d=l[1];c<s;++c)o=h,a=d,l=u[c],h=l[0],d=l[1],a<=r?d>r&&(h-o)*(r-a)>(d-a)*(t-o)&&++n:d<=r&&(h-o)*(r-a)<(d-a)*(t-o)&&--n;return n}(),e=_&&n,i=(c=A(c)).length;(e||i)&&(a.polygonStart(),e&&(a.lineStart(),o(null,null,1,a),a.lineEnd()),i&&of(c,u,n,o,a),a.polygonEnd());b=a,c=f=s=null}};function w(t,n){i(t,n)&&b.point(t,n)}function M(o,a){var u=i(o,a);if(f&&s.push([o,a]),y)l=o,h=a,d=u,y=!1,u&&(b.lineStart(),b.point(o,a));else if(u&&g)b.point(o,a);else{var c=[p=Math.max(gf,Math.min(vf,p)),v=Math.max(gf,Math.min(vf,v))],m=[o=Math.max(gf,Math.min(vf,o)),a=Math.max(gf,Math.min(vf,a))];!function(t,n,e,r,i,o){var a,u=t[0],c=t[1],f=0,s=1,l=n[0]-u,h=n[1]-c;if(a=e-u,l||!(a>0)){if(a/=l,l<0){if(a<f)return;a<s&&(s=a)}else if(l>0){if(a>s)return;a>f&&(f=a)}if(a=i-u,l||!(a<0)){if(a/=l,l<0){if(a>s)return;a>f&&(f=a)}else if(l>0){if(a<f)return;a<s&&(s=a)}if(a=r-c,h||!(a>0)){if(a/=h,h<0){if(a<f)return;a<s&&(s=a)}else if(h>0){if(a>s)return;a>f&&(f=a)}if(a=o-c,h||!(a<0)){if(a/=h,h<0){if(a>s)return;a>f&&(f=a)}else if(h>0){if(a<f)return;a<s&&(s=a)}return f>0&&(t[0]=u+f*l,t[1]=c+f*h),s<1&&(n[0]=u+s*l,n[1]=c+s*h),!0}}}}}(c,m,t,n,e,r)?u&&(b.lineStart(),b.point(o,a),_=!1):(g||(b.lineStart(),b.point(c[0],c[1])),b.point(m[0],m[1]),u||b.lineEnd(),_=!1)}p=o,v=a,g=u}return x}}var _f,bf,mf,xf=Qa(),wf={sphere:Nu,point:Nu,lineStart:function(){wf.point=Nf,wf.lineEnd=Mf},lineEnd:Nu,polygonStart:Nu,polygonEnd:Nu};function Mf(){wf.point=wf.lineEnd=Nu}function Nf(t,n){_f=t*=cu,bf=yu(n*=cu),mf=hu(n),wf.point=Tf}function Tf(t,n){t*=cu;var e=yu(n*=cu),r=hu(n),i=fu(t-_f),o=hu(i),a=r*yu(i),u=mf*e-bf*r*o,c=bf*e+mf*r*o;xf.add(lu(bu(a*a+u*u),c)),_f=t,bf=e,mf=r}function Af(t){return xf.reset(),Cu(t,wf),+xf}var Sf=[null,null],kf={type:"LineString",coordinates:Sf};function Ef(t,n){return Sf[0]=t,Sf[1]=n,Af(kf)}var Cf={Feature:function(t,n){return zf(t.geometry,n)},FeatureCollection:function(t,n){for(var e=t.features,r=-1,i=e.length;++r<i;)if(zf(e[r].geometry,n))return!0;return!1}},Pf={Sphere:function(){return!0},Point:function(t,n){return Rf(t.coordinates,n)},MultiPoint:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)if(Rf(e[r],n))return!0;return!1},LineString:function(t,n){return Df(t.coordinates,n)},MultiLineString:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)if(Df(e[r],n))return!0;return!1},Polygon:function(t,n){return qf(t.coordinates,n)},MultiPolygon:function(t,n){for(var e=t.coordinates,r=-1,i=e.length;++r<i;)if(qf(e[r],n))return!0;return!1},GeometryCollection:function(t,n){for(var e=t.geometries,r=-1,i=e.length;++r<i;)if(zf(e[r],n))return!0;return!1}};function zf(t,n){return!(!t||!Pf.hasOwnProperty(t.type))&&Pf[t.type](t,n)}function Rf(t,n){return 0===Ef(t,n)}function Df(t,n){for(var e,r,i,o=0,a=t.length;o<a;o++){if(0===(r=Ef(t[o],n)))return!0;if(o>0&&(i=Ef(t[o],t[o-1]))>0&&e<=i&&r<=i&&(e+r-i)*(1-Math.pow((e-r)/i,2))<eu*i)return!0;e=r}return!1}function qf(t,n){return!!ff(t.map(Lf),Uf(n))}function Lf(t){return(t=t.map(Uf)).pop(),t}function Uf(t){return[t[0]*cu,t[1]*cu]}function Of(t,n,e){var r=g(t,n-nu,e).concat(n);return function(t){return r.map(function(n){return[t,n]})}}function Bf(t,n,e){var r=g(t,n-nu,e).concat(n);return function(t){return r.map(function(n){return[n,t]})}}function Ff(){var t,n,e,r,i,o,a,u,c,f,s,l,h=10,d=h,p=90,v=360,y=2.5;function _(){return{type:"MultiLineString",coordinates:b()}}function b(){return g(du(r/p)*p,e,p).map(s).concat(g(du(u/v)*v,a,v).map(l)).concat(g(du(n/h)*h,t,h).filter(function(t){return fu(t%p)>nu}).map(c)).concat(g(du(o/d)*d,i,d).filter(function(t){return fu(t%v)>nu}).map(f))}return _.lines=function(){return b().map(function(t){return{type:"LineString",coordinates:t}})},_.outline=function(){return{type:"Polygon",coordinates:[s(r).concat(l(a).slice(1),s(e).reverse().slice(1),l(u).reverse().slice(1))]}},_.extent=function(t){return arguments.length?_.extentMajor(t).extentMinor(t):_.extentMinor()},_.extentMajor=function(t){return arguments.length?(r=+t[0][0],e=+t[1][0],u=+t[0][1],a=+t[1][1],r>e&&(t=r,r=e,e=t),u>a&&(t=u,u=a,a=t),_.precision(y)):[[r,u],[e,a]]},_.extentMinor=function(e){return arguments.length?(n=+e[0][0],t=+e[1][0],o=+e[0][1],i=+e[1][1],n>t&&(e=n,n=t,t=e),o>i&&(e=o,o=i,i=e),_.precision(y)):[[n,o],[t,i]]},_.step=function(t){return arguments.length?_.stepMajor(t).stepMinor(t):_.stepMinor()},_.stepMajor=function(t){return arguments.length?(p=+t[0],v=+t[1],_):[p,v]},_.stepMinor=function(t){return arguments.length?(h=+t[0],d=+t[1],_):[h,d]},_.precision=function(h){return arguments.length?(y=+h,c=Of(o,i,90),f=Bf(n,t,y),s=Of(u,a,90),l=Bf(r,e,y),_):y},_.extentMajor([[-180,-90+nu],[180,90-nu]]).extentMinor([[-180,-80-nu],[180,80+nu]])}function Yf(t){return t}var If,Hf,jf,Xf,Vf=Qa(),Gf=Qa(),$f={point:Nu,lineStart:Nu,lineEnd:Nu,polygonStart:function(){$f.lineStart=Wf,$f.lineEnd=Kf},polygonEnd:function(){$f.lineStart=$f.lineEnd=$f.point=Nu,Vf.add(fu(Gf)),Gf.reset()},result:function(){var t=Vf/2;return Vf.reset(),t}};function Wf(){$f.point=Zf}function Zf(t,n){$f.point=Qf,If=jf=t,Hf=Xf=n}function Qf(t,n){Gf.add(Xf*t-jf*n),jf=t,Xf=n}function Kf(){Qf(If,Hf)}var Jf=1/0,ts=Jf,ns=-Jf,es=ns,rs={point:function(t,n){t<Jf&&(Jf=t);t>ns&&(ns=t);n<ts&&(ts=n);n>es&&(es=n)},lineStart:Nu,lineEnd:Nu,polygonStart:Nu,polygonEnd:Nu,result:function(){var t=[[Jf,ts],[ns,es]];return ns=es=-(ts=Jf=1/0),t}};var is,os,as,us,cs=0,fs=0,ss=0,ls=0,hs=0,ds=0,ps=0,vs=0,gs=0,ys={point:_s,lineStart:bs,lineEnd:ws,polygonStart:function(){ys.lineStart=Ms,ys.lineEnd=Ns},polygonEnd:function(){ys.point=_s,ys.lineStart=bs,ys.lineEnd=ws},result:function(){var t=gs?[ps/gs,vs/gs]:ds?[ls/ds,hs/ds]:ss?[cs/ss,fs/ss]:[NaN,NaN];return cs=fs=ss=ls=hs=ds=ps=vs=gs=0,t}};function _s(t,n){cs+=t,fs+=n,++ss}function bs(){ys.point=ms}function ms(t,n){ys.point=xs,_s(as=t,us=n)}function xs(t,n){var e=t-as,r=n-us,i=bu(e*e+r*r);ls+=i*(as+t)/2,hs+=i*(us+n)/2,ds+=i,_s(as=t,us=n)}function ws(){ys.point=_s}function Ms(){ys.point=Ts}function Ns(){As(is,os)}function Ts(t,n){ys.point=As,_s(is=as=t,os=us=n)}function As(t,n){var e=t-as,r=n-us,i=bu(e*e+r*r);ls+=i*(as+t)/2,hs+=i*(us+n)/2,ds+=i,ps+=(i=us*t-as*n)*(as+t),vs+=i*(us+n),gs+=3*i,_s(as=t,us=n)}function Ss(t){this._context=t}Ss.prototype={_radius:4.5,pointRadius:function(t){return this._radius=t,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._context.closePath(),this._point=NaN},point:function(t,n){switch(this._point){case 0:this._context.moveTo(t,n),this._point=1;break;case 1:this._context.lineTo(t,n);break;default:this._context.moveTo(t+this._radius,n),this._context.arc(t,n,this._radius,0,au)}},result:Nu};var ks,Es,Cs,Ps,zs,Rs=Qa(),Ds={point:Nu,lineStart:function(){Ds.point=qs},lineEnd:function(){ks&&Ls(Es,Cs),Ds.point=Nu},polygonStart:function(){ks=!0},polygonEnd:function(){ks=null},result:function(){var t=+Rs;return Rs.reset(),t}};function qs(t,n){Ds.point=Ls,Es=Ps=t,Cs=zs=n}function Ls(t,n){Ps-=t,zs-=n,Rs.add(bu(Ps*Ps+zs*zs)),Ps=t,zs=n}function Us(){this._string=[]}function Os(t){return"m0,"+t+"a"+t+","+t+" 0 1,1 0,"+-2*t+"a"+t+","+t+" 0 1,1 0,"+2*t+"z"}function Bs(t){return function(n){var e=new Fs;for(var r in t)e[r]=t[r];return e.stream=n,e}}function Fs(){}function Ys(t,n,e){var r=t.clipExtent&&t.clipExtent();return t.scale(150).translate([0,0]),null!=r&&t.clipExtent(null),Cu(e,t.stream(rs)),n(rs.result()),null!=r&&t.clipExtent(r),t}function Is(t,n,e){return Ys(t,function(e){var r=n[1][0]-n[0][0],i=n[1][1]-n[0][1],o=Math.min(r/(e[1][0]-e[0][0]),i/(e[1][1]-e[0][1])),a=+n[0][0]+(r-o*(e[1][0]+e[0][0]))/2,u=+n[0][1]+(i-o*(e[1][1]+e[0][1]))/2;t.scale(150*o).translate([a,u])},e)}function Hs(t,n,e){return Is(t,[[0,0],n],e)}function js(t,n,e){return Ys(t,function(e){var r=+n,i=r/(e[1][0]-e[0][0]),o=(r-i*(e[1][0]+e[0][0]))/2,a=-i*e[0][1];t.scale(150*i).translate([o,a])},e)}function Xs(t,n,e){return Ys(t,function(e){var r=+n,i=r/(e[1][1]-e[0][1]),o=-i*e[0][0],a=(r-i*(e[1][1]+e[0][1]))/2;t.scale(150*i).translate([o,a])},e)}Us.prototype={_radius:4.5,_circle:Os(4.5),pointRadius:function(t){return(t=+t)!==this._radius&&(this._radius=t,this._circle=null),this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._string.push("Z"),this._point=NaN},point:function(t,n){switch(this._point){case 0:this._string.push("M",t,",",n),this._point=1;break;case 1:this._string.push("L",t,",",n);break;default:null==this._circle&&(this._circle=Os(this._radius)),this._string.push("M",t,",",n,this._circle)}},result:function(){if(this._string.length){var t=this._string.join("");return this._string=[],t}return null}},Fs.prototype={constructor:Fs,point:function(t,n){this.stream.point(t,n)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};var Vs=16,Gs=hu(30*cu);function $s(t,n){return+n?function(t,n){function e(r,i,o,a,u,c,f,s,l,h,d,p,v,g){var y=f-r,_=s-i,b=y*y+_*_;if(b>4*n&&v--){var m=a+h,x=u+d,w=c+p,M=bu(m*m+x*x+w*w),N=wu(w/=M),T=fu(fu(w)-1)<nu||fu(o-l)<nu?(o+l)/2:lu(x,m),A=t(T,N),S=A[0],k=A[1],E=S-r,C=k-i,P=_*E-y*C;(P*P/b>n||fu((y*E+_*C)/b-.5)>.3||a*h+u*d+c*p<Gs)&&(e(r,i,o,a,u,c,S,k,T,m/=M,x/=M,w,v,g),g.point(S,k),e(S,k,T,m,x,w,f,s,l,h,d,p,v,g))}}return function(n){var r,i,o,a,u,c,f,s,l,h,d,p,v={point:g,lineStart:y,lineEnd:b,polygonStart:function(){n.polygonStart(),v.lineStart=m},polygonEnd:function(){n.polygonEnd(),v.lineStart=y}};function g(e,r){e=t(e,r),n.point(e[0],e[1])}function y(){s=NaN,v.point=_,n.lineStart()}function _(r,i){var o=ju([r,i]),a=t(r,i);e(s,l,f,h,d,p,s=a[0],l=a[1],f=r,h=o[0],d=o[1],p=o[2],Vs,n),n.point(s,l)}function b(){v.point=g,n.lineEnd()}function m(){y(),v.point=x,v.lineEnd=w}function x(t,n){_(r=t,n),i=s,o=l,a=h,u=d,c=p,v.point=_}function w(){e(s,l,f,h,d,p,i,o,r,a,u,c,Vs,n),v.lineEnd=b,b()}return v}}(t,n):function(t){return Bs({point:function(n,e){n=t(n,e),this.stream.point(n[0],n[1])}})}(t)}var Ws=Bs({point:function(t,n){this.stream.point(t*cu,n*cu)}});function Zs(t,n,e,r,i,o){var a=hu(o),u=yu(o),c=a*t,f=u*t,s=a/t,l=u/t,h=(u*e-a*n)/t,d=(u*n+a*e)/t;function p(t,o){return[c*(t*=r)-f*(o*=i)+n,e-f*t-c*o]}return p.invert=function(t,n){return[r*(s*t-l*n+h),i*(d-l*t-s*n)]},p}function Qs(t){return Ks(function(){return t})()}function Ks(t){var n,e,r,i,o,a,u,c,f,s,l=150,h=480,d=250,p=0,v=0,g=0,y=0,_=0,b=0,m=1,x=1,w=null,M=df,N=null,T=Yf,A=.5;function S(t){return c(t[0]*cu,t[1]*cu)}function k(t){return(t=c.invert(t[0],t[1]))&&[t[0]*uu,t[1]*uu]}function E(){var t=Zs(l,0,0,m,x,b).apply(null,n(p,v)),r=(b?Zs:function(t,n,e,r,i){function o(o,a){return[n+t*(o*=r),e-t*(a*=i)]}return o.invert=function(o,a){return[(o-n)/t*r,(e-a)/t*i]},o})(l,h-t[0],d-t[1],m,x,b);return e=$c(g,y,_),u=Vc(n,r),c=Vc(e,u),a=$s(u,A),C()}function C(){return f=s=null,S}return S.stream=function(t){return f&&s===t?f:f=Ws(function(t){return Bs({point:function(n,e){var r=t(n,e);return this.stream.point(r[0],r[1])}})}(e)(M(a(T(s=t)))))},S.preclip=function(t){return arguments.length?(M=t,w=void 0,C()):M},S.postclip=function(t){return arguments.length?(T=t,N=r=i=o=null,C()):T},S.clipAngle=function(t){return arguments.length?(M=+t?pf(w=t*cu):(w=null,df),C()):w*uu},S.clipExtent=function(t){return arguments.length?(T=null==t?(N=r=i=o=null,Yf):yf(N=+t[0][0],r=+t[0][1],i=+t[1][0],o=+t[1][1]),C()):null==N?null:[[N,r],[i,o]]},S.scale=function(t){return arguments.length?(l=+t,E()):l},S.translate=function(t){return arguments.length?(h=+t[0],d=+t[1],E()):[h,d]},S.center=function(t){return arguments.length?(p=t[0]%360*cu,v=t[1]%360*cu,E()):[p*uu,v*uu]},S.rotate=function(t){return arguments.length?(g=t[0]%360*cu,y=t[1]%360*cu,_=t.length>2?t[2]%360*cu:0,E()):[g*uu,y*uu,_*uu]},S.angle=function(t){return arguments.length?(b=t%360*cu,E()):b*uu},S.reflectX=function(t){return arguments.length?(m=t?-1:1,E()):m<0},S.reflectY=function(t){return arguments.length?(x=t?-1:1,E()):x<0},S.precision=function(t){return arguments.length?(a=$s(u,A=t*t),C()):bu(A)},S.fitExtent=function(t,n){return Is(S,t,n)},S.fitSize=function(t,n){return Hs(S,t,n)},S.fitWidth=function(t,n){return js(S,t,n)},S.fitHeight=function(t,n){return Xs(S,t,n)},function(){return n=t.apply(this,arguments),S.invert=n.invert&&k,E()}}function Js(t){var n=0,e=ru/3,r=Ks(t),i=r(n,e);return i.parallels=function(t){return arguments.length?r(n=t[0]*cu,e=t[1]*cu):[n*uu,e*uu]},i}function tl(t,n){var e=yu(t),r=(e+yu(n))/2;if(fu(r)<nu)return function(t){var n=hu(t);function e(t,e){return[t*n,yu(e)/n]}return e.invert=function(t,e){return[t/n,wu(e*n)]},e}(t);var i=1+e*(2*r-e),o=bu(i)/r;function a(t,n){var e=bu(i-2*r*yu(n))/r;return[e*yu(t*=r),o-e*hu(t)]}return a.invert=function(t,n){var e=o-n,a=lu(t,fu(e))*_u(e);return e*r<0&&(a-=ru*_u(t)*_u(e)),[a/r,wu((i-(t*t+e*e)*r*r)/(2*r))]},a}function nl(){return Js(tl).scale(155.424).center([0,33.6442])}function el(){return nl().parallels([29.5,45.5]).scale(1070).translate([480,250]).rotate([96,0]).center([-.6,38.7])}function rl(t){return function(n,e){var r=hu(n),i=hu(e),o=t(r*i);return[o*i*yu(n),o*yu(e)]}}function il(t){return function(n,e){var r=bu(n*n+e*e),i=t(r),o=yu(i),a=hu(i);return[lu(n*o,r*a),wu(r&&e*o/r)]}}var ol=rl(function(t){return bu(2/(1+t))});ol.invert=il(function(t){return 2*wu(t/2)});var al=rl(function(t){return(t=xu(t))&&t/yu(t)});function ul(t,n){return[t,vu(mu((iu+n)/2))]}function cl(t){var n,e,r,i=Qs(t),o=i.center,a=i.scale,u=i.translate,c=i.clipExtent,f=null;function s(){var o=ru*a(),u=i(Kc(i.rotate()).invert([0,0]));return c(null==f?[[u[0]-o,u[1]-o],[u[0]+o,u[1]+o]]:t===ul?[[Math.max(u[0]-o,f),n],[Math.min(u[0]+o,e),r]]:[[f,Math.max(u[1]-o,n)],[e,Math.min(u[1]+o,r)]])}return i.scale=function(t){return arguments.length?(a(t),s()):a()},i.translate=function(t){return arguments.length?(u(t),s()):u()},i.center=function(t){return arguments.length?(o(t),s()):o()},i.clipExtent=function(t){return arguments.length?(null==t?f=n=e=r=null:(f=+t[0][0],n=+t[0][1],e=+t[1][0],r=+t[1][1]),s()):null==f?null:[[f,n],[e,r]]},s()}function fl(t){return mu((iu+t)/2)}function sl(t,n){var e=hu(t),r=t===n?yu(t):vu(e/hu(n))/vu(fl(n)/fl(t)),i=e*gu(fl(t),r)/r;if(!r)return ul;function o(t,n){i>0?n<-iu+nu&&(n=-iu+nu):n>iu-nu&&(n=iu-nu);var e=i/gu(fl(n),r);return[e*yu(r*t),i-e*hu(r*t)]}return o.invert=function(t,n){var e=i-n,o=_u(r)*bu(t*t+e*e),a=lu(t,fu(e))*_u(e);return e*r<0&&(a-=ru*_u(t)*_u(e)),[a/r,2*su(gu(i/o,1/r))-iu]},o}function ll(t,n){return[t,n]}function hl(t,n){var e=hu(t),r=t===n?yu(t):(e-hu(n))/(n-t),i=e/r+t;if(fu(r)<nu)return ll;function o(t,n){var e=i-n,o=r*t;return[e*yu(o),i-e*hu(o)]}return o.invert=function(t,n){var e=i-n,o=lu(t,fu(e))*_u(e);return e*r<0&&(o-=ru*_u(t)*_u(e)),[o/r,i-_u(r)*bu(t*t+e*e)]},o}al.invert=il(function(t){return t}),ul.invert=function(t,n){return[t,2*su(pu(n))-iu]},ll.invert=ll;var dl=1.340264,pl=-.081106,vl=893e-6,gl=.003796,yl=bu(3)/2;function _l(t,n){var e=wu(yl*yu(n)),r=e*e,i=r*r*r;return[t*hu(e)/(yl*(dl+3*pl*r+i*(7*vl+9*gl*r))),e*(dl+pl*r+i*(vl+gl*r))]}function bl(t,n){var e=hu(n),r=hu(t)*e;return[e*yu(t)/r,yu(n)/r]}function ml(t,n){var e=n*n,r=e*e;return[t*(.8707-.131979*e+r*(r*(.003971*e-.001529*r)-.013791)),n*(1.007226+e*(.015085+r*(.028874*e-.044475-.005916*r)))]}function xl(t,n){return[hu(n)*yu(t),yu(n)]}function wl(t,n){var e=hu(n),r=1+hu(t)*e;return[e*yu(t)/r,yu(n)/r]}function Ml(t,n){return[vu(mu((iu+n)/2)),-t]}function Nl(t,n){return t.parent===n.parent?1:2}function Tl(t,n){return t+n.x}function Al(t,n){return Math.max(t,n.y)}function Sl(t){var n=0,e=t.children,r=e&&e.length;if(r)for(;--r>=0;)n+=e[r].value;else n=1;t.value=n}function kl(t,n){var e,r,i,o,a,u=new zl(t),c=+t.value&&(u.value=t.value),f=[u];for(null==n&&(n=El);e=f.pop();)if(c&&(e.value=+e.data.value),(i=n(e.data))&&(a=i.length))for(e.children=new Array(a),o=a-1;o>=0;--o)f.push(r=e.children[o]=new zl(i[o])),r.parent=e,r.depth=e.depth+1;return u.eachBefore(Pl)}function El(t){return t.children}function Cl(t){t.data=t.data.data}function Pl(t){var n=0;do{t.height=n}while((t=t.parent)&&t.height<++n)}function zl(t){this.data=t,this.depth=this.height=0,this.parent=null}_l.invert=function(t,n){for(var e,r=n,i=r*r,o=i*i*i,a=0;a<12&&(o=(i=(r-=e=(r*(dl+pl*i+o*(vl+gl*i))-n)/(dl+3*pl*i+o*(7*vl+9*gl*i)))*r)*i*i,!(fu(e)<eu));++a);return[yl*t*(dl+3*pl*i+o*(7*vl+9*gl*i))/hu(r),wu(yu(r)/yl)]},bl.invert=il(su),ml.invert=function(t,n){var e,r=n,i=25;do{var o=r*r,a=o*o;r-=e=(r*(1.007226+o*(.015085+a*(.028874*o-.044475-.005916*a)))-n)/(1.007226+o*(.045255+a*(.259866*o-.311325-.005916*11*a)))}while(fu(e)>nu&&--i>0);return[t/(.8707+(o=r*r)*(o*(o*o*o*(.003971-.001529*o)-.013791)-.131979)),r]},xl.invert=il(wu),wl.invert=il(function(t){return 2*su(t)}),Ml.invert=function(t,n){return[-n,2*su(pu(t))-iu]},zl.prototype=kl.prototype={constructor:zl,count:function(){return this.eachAfter(Sl)},each:function(t){var n,e,r,i,o=this,a=[o];do{for(n=a.reverse(),a=[];o=n.pop();)if(t(o),e=o.children)for(r=0,i=e.length;r<i;++r)a.push(e[r])}while(a.length);return this},eachAfter:function(t){for(var n,e,r,i=this,o=[i],a=[];i=o.pop();)if(a.push(i),n=i.children)for(e=0,r=n.length;e<r;++e)o.push(n[e]);for(;i=a.pop();)t(i);return this},eachBefore:function(t){for(var n,e,r=this,i=[r];r=i.pop();)if(t(r),n=r.children)for(e=n.length-1;e>=0;--e)i.push(n[e]);return this},sum:function(t){return this.eachAfter(function(n){for(var e=+t(n.data)||0,r=n.children,i=r&&r.length;--i>=0;)e+=r[i].value;n.value=e})},sort:function(t){return this.eachBefore(function(n){n.children&&n.children.sort(t)})},path:function(t){for(var n=this,e=function(t,n){if(t===n)return t;var e=t.ancestors(),r=n.ancestors(),i=null;for(t=e.pop(),n=r.pop();t===n;)i=t,t=e.pop(),n=r.pop();return i}(n,t),r=[n];n!==e;)n=n.parent,r.push(n);for(var i=r.length;t!==e;)r.splice(i,0,t),t=t.parent;return r},ancestors:function(){for(var t=this,n=[t];t=t.parent;)n.push(t);return n},descendants:function(){var t=[];return this.each(function(n){t.push(n)}),t},leaves:function(){var t=[];return this.eachBefore(function(n){n.children||t.push(n)}),t},links:function(){var t=this,n=[];return t.each(function(e){e!==t&&n.push({source:e.parent,target:e})}),n},copy:function(){return kl(this).eachBefore(Cl)}};var Rl=Array.prototype.slice;function Dl(t){for(var n,e,r=0,i=(t=function(t){for(var n,e,r=t.length;r;)e=Math.random()*r--|0,n=t[r],t[r]=t[e],t[e]=n;return t}(Rl.call(t))).length,o=[];r<i;)n=t[r],e&&Ul(e,n)?++r:(e=Bl(o=ql(o,n)),r=0);return e}function ql(t,n){var e,r;if(Ol(n,t))return[n];for(e=0;e<t.length;++e)if(Ll(n,t[e])&&Ol(Fl(t[e],n),t))return[t[e],n];for(e=0;e<t.length-1;++e)for(r=e+1;r<t.length;++r)if(Ll(Fl(t[e],t[r]),n)&&Ll(Fl(t[e],n),t[r])&&Ll(Fl(t[r],n),t[e])&&Ol(Yl(t[e],t[r],n),t))return[t[e],t[r],n];throw new Error}function Ll(t,n){var e=t.r-n.r,r=n.x-t.x,i=n.y-t.y;return e<0||e*e<r*r+i*i}function Ul(t,n){var e=t.r-n.r+1e-6,r=n.x-t.x,i=n.y-t.y;return e>0&&e*e>r*r+i*i}function Ol(t,n){for(var e=0;e<n.length;++e)if(!Ul(t,n[e]))return!1;return!0}function Bl(t){switch(t.length){case 1:return function(t){return{x:t.x,y:t.y,r:t.r}}(t[0]);case 2:return Fl(t[0],t[1]);case 3:return Yl(t[0],t[1],t[2])}}function Fl(t,n){var e=t.x,r=t.y,i=t.r,o=n.x,a=n.y,u=n.r,c=o-e,f=a-r,s=u-i,l=Math.sqrt(c*c+f*f);return{x:(e+o+c/l*s)/2,y:(r+a+f/l*s)/2,r:(l+i+u)/2}}function Yl(t,n,e){var r=t.x,i=t.y,o=t.r,a=n.x,u=n.y,c=n.r,f=e.x,s=e.y,l=e.r,h=r-a,d=r-f,p=i-u,v=i-s,g=c-o,y=l-o,_=r*r+i*i-o*o,b=_-a*a-u*u+c*c,m=_-f*f-s*s+l*l,x=d*p-h*v,w=(p*m-v*b)/(2*x)-r,M=(v*g-p*y)/x,N=(d*b-h*m)/(2*x)-i,T=(h*y-d*g)/x,A=M*M+T*T-1,S=2*(o+w*M+N*T),k=w*w+N*N-o*o,E=-(A?(S+Math.sqrt(S*S-4*A*k))/(2*A):k/S);return{x:r+w+M*E,y:i+N+T*E,r:E}}function Il(t,n,e){var r,i,o,a,u=t.x-n.x,c=t.y-n.y,f=u*u+c*c;f?(i=n.r+e.r,i*=i,a=t.r+e.r,i>(a*=a)?(r=(f+a-i)/(2*f),o=Math.sqrt(Math.max(0,a/f-r*r)),e.x=t.x-r*u-o*c,e.y=t.y-r*c+o*u):(r=(f+i-a)/(2*f),o=Math.sqrt(Math.max(0,i/f-r*r)),e.x=n.x+r*u-o*c,e.y=n.y+r*c+o*u)):(e.x=n.x+e.r,e.y=n.y)}function Hl(t,n){var e=t.r+n.r-1e-6,r=n.x-t.x,i=n.y-t.y;return e>0&&e*e>r*r+i*i}function jl(t){var n=t._,e=t.next._,r=n.r+e.r,i=(n.x*e.r+e.x*n.r)/r,o=(n.y*e.r+e.y*n.r)/r;return i*i+o*o}function Xl(t){this._=t,this.next=null,this.previous=null}function Vl(t){if(!(i=t.length))return 0;var n,e,r,i,o,a,u,c,f,s,l;if((n=t[0]).x=0,n.y=0,!(i>1))return n.r;if(e=t[1],n.x=-e.r,e.x=n.r,e.y=0,!(i>2))return n.r+e.r;Il(e,n,r=t[2]),n=new Xl(n),e=new Xl(e),r=new Xl(r),n.next=r.previous=e,e.next=n.previous=r,r.next=e.previous=n;t:for(u=3;u<i;++u){Il(n._,e._,r=t[u]),r=new Xl(r),c=e.next,f=n.previous,s=e._.r,l=n._.r;do{if(s<=l){if(Hl(c._,r._)){e=c,n.next=e,e.previous=n,--u;continue t}s+=c._.r,c=c.next}else{if(Hl(f._,r._)){(n=f).next=e,e.previous=n,--u;continue t}l+=f._.r,f=f.previous}}while(c!==f.next);for(r.previous=n,r.next=e,n.next=e.previous=e=r,o=jl(n);(r=r.next)!==e;)(a=jl(r))<o&&(n=r,o=a);e=n.next}for(n=[e._],r=e;(r=r.next)!==e;)n.push(r._);for(r=Dl(n),u=0;u<i;++u)(n=t[u]).x-=r.x,n.y-=r.y;return r.r}function Gl(t){return null==t?null:$l(t)}function $l(t){if("function"!=typeof t)throw new Error;return t}function Wl(){return 0}function Zl(t){return function(){return t}}function Ql(t){return Math.sqrt(t.value)}function Kl(t){return function(n){n.children||(n.r=Math.max(0,+t(n)||0))}}function Jl(t,n){return function(e){if(r=e.children){var r,i,o,a=r.length,u=t(e)*n||0;if(u)for(i=0;i<a;++i)r[i].r+=u;if(o=Vl(r),u)for(i=0;i<a;++i)r[i].r-=u;e.r=o+u}}}function th(t){return function(n){var e=n.parent;n.r*=t,e&&(n.x=e.x+t*n.x,n.y=e.y+t*n.y)}}function nh(t){t.x0=Math.round(t.x0),t.y0=Math.round(t.y0),t.x1=Math.round(t.x1),t.y1=Math.round(t.y1)}function eh(t,n,e,r,i){for(var o,a=t.children,u=-1,c=a.length,f=t.value&&(r-n)/t.value;++u<c;)(o=a[u]).y0=e,o.y1=i,o.x0=n,o.x1=n+=o.value*f}var rh="$",ih={depth:-1},oh={};function ah(t){return t.id}function uh(t){return t.parentId}function ch(t,n){return t.parent===n.parent?1:2}function fh(t){var n=t.children;return n?n[0]:t.t}function sh(t){var n=t.children;return n?n[n.length-1]:t.t}function lh(t,n,e){var r=e/(n.i-t.i);n.c-=r,n.s+=e,t.c+=r,n.z+=e,n.m+=e}function hh(t,n,e){return t.a.parent===n.parent?t.a:e}function dh(t,n){this._=t,this.parent=null,this.children=null,this.A=null,this.a=this,this.z=0,this.m=0,this.c=0,this.s=0,this.t=null,this.i=n}function ph(t,n,e,r,i){for(var o,a=t.children,u=-1,c=a.length,f=t.value&&(i-e)/t.value;++u<c;)(o=a[u]).x0=n,o.x1=r,o.y0=e,o.y1=e+=o.value*f}dh.prototype=Object.create(zl.prototype);var vh=(1+Math.sqrt(5))/2;function gh(t,n,e,r,i,o){for(var a,u,c,f,s,l,h,d,p,v,g,y=[],_=n.children,b=0,m=0,x=_.length,w=n.value;b<x;){c=i-e,f=o-r;do{s=_[m++].value}while(!s&&m<x);for(l=h=s,g=s*s*(v=Math.max(f/c,c/f)/(w*t)),p=Math.max(h/g,g/l);m<x;++m){if(s+=u=_[m].value,u<l&&(l=u),u>h&&(h=u),g=s*s*v,(d=Math.max(h/g,g/l))>p){s-=u;break}p=d}y.push(a={value:s,dice:c<f,children:_.slice(b,m)}),a.dice?eh(a,e,r,i,w?r+=f*s/w:o):ph(a,e,r,w?e+=c*s/w:i,o),w-=s,b=m}return y}var yh=function t(n){function e(t,e,r,i,o){gh(n,t,e,r,i,o)}return e.ratio=function(n){return t((n=+n)>1?n:1)},e}(vh);var _h=function t(n){function e(t,e,r,i,o){if((a=t._squarify)&&a.ratio===n)for(var a,u,c,f,s,l=-1,h=a.length,d=t.value;++l<h;){for(c=(u=a[l]).children,f=u.value=0,s=c.length;f<s;++f)u.value+=c[f].value;u.dice?eh(u,e,r,i,r+=(o-r)*u.value/d):ph(u,e,r,e+=(i-e)*u.value/d,o),d-=u.value}else t._squarify=a=gh(n,t,e,r,i,o),a.ratio=n}return e.ratio=function(n){return t((n=+n)>1?n:1)},e}(vh);function bh(t,n,e){return(n[0]-t[0])*(e[1]-t[1])-(n[1]-t[1])*(e[0]-t[0])}function mh(t,n){return t[0]-n[0]||t[1]-n[1]}function xh(t){for(var n=t.length,e=[0,1],r=2,i=2;i<n;++i){for(;r>1&&bh(t[e[r-2]],t[e[r-1]],t[i])<=0;)--r;e[r++]=i}return e.slice(0,r)}function wh(){return Math.random()}var Mh=function t(n){function e(t,e){return t=null==t?0:+t,e=null==e?1:+e,1===arguments.length?(e=t,t=0):e-=t,function(){return n()*e+t}}return e.source=t,e}(wh),Nh=function t(n){function e(t,e){var r,i;return t=null==t?0:+t,e=null==e?1:+e,function(){var o;if(null!=r)o=r,r=null;else do{r=2*n()-1,o=2*n()-1,i=r*r+o*o}while(!i||i>1);return t+e*o*Math.sqrt(-2*Math.log(i)/i)}}return e.source=t,e}(wh),Th=function t(n){function e(){var t=Nh.source(n).apply(this,arguments);return function(){return Math.exp(t())}}return e.source=t,e}(wh),Ah=function t(n){function e(t){return function(){for(var e=0,r=0;r<t;++r)e+=n();return e}}return e.source=t,e}(wh),Sh=function t(n){function e(t){var e=Ah.source(n)(t);return function(){return e()/t}}return e.source=t,e}(wh),kh=function t(n){function e(t){return function(){return-Math.log(1-n())/t}}return e.source=t,e}(wh);function Eh(t,n){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(n).domain(t)}return this}function Ch(t,n){switch(arguments.length){case 0:break;case 1:this.interpolator(t);break;default:this.interpolator(n).domain(t)}return this}var Ph=Array.prototype,zh=Ph.map,Rh=Ph.slice,Dh={name:"implicit"};function qh(){var t=co(),n=[],e=[],r=Dh;function i(i){var o=i+"",a=t.get(o);if(!a){if(r!==Dh)return r;t.set(o,a=n.push(i))}return e[(a-1)%e.length]}return i.domain=function(e){if(!arguments.length)return n.slice();n=[],t=co();for(var r,o,a=-1,u=e.length;++a<u;)t.has(o=(r=e[a])+"")||t.set(o,n.push(r));return i},i.range=function(t){return arguments.length?(e=Rh.call(t),i):e.slice()},i.unknown=function(t){return arguments.length?(r=t,i):r},i.copy=function(){return qh(n,e).unknown(r)},Eh.apply(i,arguments),i}function Lh(){var t,n,e=qh().unknown(void 0),r=e.domain,i=e.range,o=[0,1],a=!1,u=0,c=0,f=.5;function s(){var e=r().length,s=o[1]<o[0],l=o[s-0],h=o[1-s];t=(h-l)/Math.max(1,e-u+2*c),a&&(t=Math.floor(t)),l+=(h-l-t*(e-u))*f,n=t*(1-u),a&&(l=Math.round(l),n=Math.round(n));var d=g(e).map(function(n){return l+t*n});return i(s?d.reverse():d)}return delete e.unknown,e.domain=function(t){return arguments.length?(r(t),s()):r()},e.range=function(t){return arguments.length?(o=[+t[0],+t[1]],s()):o.slice()},e.rangeRound=function(t){return o=[+t[0],+t[1]],a=!0,s()},e.bandwidth=function(){return n},e.step=function(){return t},e.round=function(t){return arguments.length?(a=!!t,s()):a},e.padding=function(t){return arguments.length?(u=Math.min(1,c=+t),s()):u},e.paddingInner=function(t){return arguments.length?(u=Math.min(1,t),s()):u},e.paddingOuter=function(t){return arguments.length?(c=+t,s()):c},e.align=function(t){return arguments.length?(f=Math.max(0,Math.min(1,t)),s()):f},e.copy=function(){return Lh(r(),o).round(a).paddingInner(u).paddingOuter(c).align(f)},Eh.apply(s(),arguments)}function Uh(t){return+t}var Oh=[0,1];function Bh(t){return t}function Fh(t,n){return(n-=t=+t)?function(e){return(e-t)/n}:function(t){return function(){return t}}(isNaN(n)?NaN:.5)}function Yh(t){var n,e=t[0],r=t[t.length-1];return e>r&&(n=e,e=r,r=n),function(t){return Math.max(e,Math.min(r,t))}}function Ih(t,n,e){var r=t[0],i=t[1],o=n[0],a=n[1];return i<r?(r=Fh(i,r),o=e(a,o)):(r=Fh(r,i),o=e(o,a)),function(t){return o(r(t))}}function Hh(t,n,e){var r=Math.min(t.length,n.length)-1,o=new Array(r),a=new Array(r),u=-1;for(t[r]<t[0]&&(t=t.slice().reverse(),n=n.slice().reverse());++u<r;)o[u]=Fh(t[u],t[u+1]),a[u]=e(n[u],n[u+1]);return function(n){var e=i(t,n,1,r)-1;return a[e](o[e](n))}}function jh(t,n){return n.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp()).unknown(t.unknown())}function Xh(){var t,n,e,r,i,o,a=Oh,u=Oh,c=Te,f=Bh;function s(){return r=Math.min(a.length,u.length)>2?Hh:Ih,i=o=null,l}function l(n){return isNaN(n=+n)?e:(i||(i=r(a.map(t),u,c)))(t(f(n)))}return l.invert=function(e){return f(n((o||(o=r(u,a.map(t),me)))(e)))},l.domain=function(t){return arguments.length?(a=zh.call(t,Uh),f===Bh||(f=Yh(a)),s()):a.slice()},l.range=function(t){return arguments.length?(u=Rh.call(t),s()):u.slice()},l.rangeRound=function(t){return u=Rh.call(t),c=Ae,s()},l.clamp=function(t){return arguments.length?(f=t?Yh(a):Bh,l):f!==Bh},l.interpolate=function(t){return arguments.length?(c=t,s()):c},l.unknown=function(t){return arguments.length?(e=t,l):e},function(e,r){return t=e,n=r,s()}}function Vh(t,n){return Xh()(t,n)}function Gh(n,e,r,i){var o,a=w(n,e,r);switch((i=Oa(null==i?",f":i)).type){case"s":var u=Math.max(Math.abs(n),Math.abs(e));return null!=i.precision||isNaN(o=Wa(a,u))||(i.precision=o),t.formatPrefix(i,u);case"":case"e":case"g":case"p":case"r":null!=i.precision||isNaN(o=Za(a,Math.max(Math.abs(n),Math.abs(e))))||(i.precision=o-("e"===i.type));break;case"f":case"%":null!=i.precision||isNaN(o=$a(a))||(i.precision=o-2*("%"===i.type))}return t.format(i)}function $h(t){var n=t.domain;return t.ticks=function(t){var e=n();return m(e[0],e[e.length-1],null==t?10:t)},t.tickFormat=function(t,e){var r=n();return Gh(r[0],r[r.length-1],null==t?10:t,e)},t.nice=function(e){null==e&&(e=10);var r,i=n(),o=0,a=i.length-1,u=i[o],c=i[a];return c<u&&(r=u,u=c,c=r,r=o,o=a,a=r),(r=x(u,c,e))>0?r=x(u=Math.floor(u/r)*r,c=Math.ceil(c/r)*r,e):r<0&&(r=x(u=Math.ceil(u*r)/r,c=Math.floor(c*r)/r,e)),r>0?(i[o]=Math.floor(u/r)*r,i[a]=Math.ceil(c/r)*r,n(i)):r<0&&(i[o]=Math.ceil(u*r)/r,i[a]=Math.floor(c*r)/r,n(i)),t},t}function Wh(t,n){var e,r=0,i=(t=t.slice()).length-1,o=t[r],a=t[i];return a<o&&(e=r,r=i,i=e,e=o,o=a,a=e),t[r]=n.floor(o),t[i]=n.ceil(a),t}function Zh(t){return Math.log(t)}function Qh(t){return Math.exp(t)}function Kh(t){return-Math.log(-t)}function Jh(t){return-Math.exp(-t)}function td(t){return isFinite(t)?+("1e"+t):t<0?0:t}function nd(t){return function(n){return-t(-n)}}function ed(n){var e,r,i=n(Zh,Qh),o=i.domain,a=10;function u(){return e=function(t){return t===Math.E?Math.log:10===t&&Math.log10||2===t&&Math.log2||(t=Math.log(t),function(n){return Math.log(n)/t})}(a),r=function(t){return 10===t?td:t===Math.E?Math.exp:function(n){return Math.pow(t,n)}}(a),o()[0]<0?(e=nd(e),r=nd(r),n(Kh,Jh)):n(Zh,Qh),i}return i.base=function(t){return arguments.length?(a=+t,u()):a},i.domain=function(t){return arguments.length?(o(t),u()):o()},i.ticks=function(t){var n,i=o(),u=i[0],c=i[i.length-1];(n=c<u)&&(h=u,u=c,c=h);var f,s,l,h=e(u),d=e(c),p=null==t?10:+t,v=[];if(!(a%1)&&d-h<p){if(h=Math.round(h)-1,d=Math.round(d)+1,u>0){for(;h<d;++h)for(s=1,f=r(h);s<a;++s)if(!((l=f*s)<u)){if(l>c)break;v.push(l)}}else for(;h<d;++h)for(s=a-1,f=r(h);s>=1;--s)if(!((l=f*s)<u)){if(l>c)break;v.push(l)}}else v=m(h,d,Math.min(d-h,p)).map(r);return n?v.reverse():v},i.tickFormat=function(n,o){if(null==o&&(o=10===a?".0e":","),"function"!=typeof o&&(o=t.format(o)),n===1/0)return o;null==n&&(n=10);var u=Math.max(1,a*n/i.ticks().length);return function(t){var n=t/r(Math.round(e(t)));return n*a<a-.5&&(n*=a),n<=u?o(t):""}},i.nice=function(){return o(Wh(o(),{floor:function(t){return r(Math.floor(e(t)))},ceil:function(t){return r(Math.ceil(e(t)))}}))},i}function rd(t){return function(n){return Math.sign(n)*Math.log1p(Math.abs(n/t))}}function id(t){return function(n){return Math.sign(n)*Math.expm1(Math.abs(n))*t}}function od(t){var n=1,e=t(rd(n),id(n));return e.constant=function(e){return arguments.length?t(rd(n=+e),id(n)):n},$h(e)}function ad(t){return function(n){return n<0?-Math.pow(-n,t):Math.pow(n,t)}}function ud(t){return t<0?-Math.sqrt(-t):Math.sqrt(t)}function cd(t){return t<0?-t*t:t*t}function fd(t){var n=t(Bh,Bh),e=1;function r(){return 1===e?t(Bh,Bh):.5===e?t(ud,cd):t(ad(e),ad(1/e))}return n.exponent=function(t){return arguments.length?(e=+t,r()):e},$h(n)}function sd(){var t=fd(Xh());return t.copy=function(){return jh(t,sd()).exponent(t.exponent())},Eh.apply(t,arguments),t}var ld=new Date,hd=new Date;function dd(t,n,e,r){function i(n){return t(n=0===arguments.length?new Date:new Date(+n)),n}return i.floor=function(n){return t(n=new Date(+n)),n},i.ceil=function(e){return t(e=new Date(e-1)),n(e,1),t(e),e},i.round=function(t){var n=i(t),e=i.ceil(t);return t-n<e-t?n:e},i.offset=function(t,e){return n(t=new Date(+t),null==e?1:Math.floor(e)),t},i.range=function(e,r,o){var a,u=[];if(e=i.ceil(e),o=null==o?1:Math.floor(o),!(e<r&&o>0))return u;do{u.push(a=new Date(+e)),n(e,o),t(e)}while(a<e&&e<r);return u},i.filter=function(e){return dd(function(n){if(n>=n)for(;t(n),!e(n);)n.setTime(n-1)},function(t,r){if(t>=t)if(r<0)for(;++r<=0;)for(;n(t,-1),!e(t););else for(;--r>=0;)for(;n(t,1),!e(t););})},e&&(i.count=function(n,r){return ld.setTime(+n),hd.setTime(+r),t(ld),t(hd),Math.floor(e(ld,hd))},i.every=function(t){return t=Math.floor(t),isFinite(t)&&t>0?t>1?i.filter(r?function(n){return r(n)%t==0}:function(n){return i.count(0,n)%t==0}):i:null}),i}var pd=dd(function(){},function(t,n){t.setTime(+t+n)},function(t,n){return n-t});pd.every=function(t){return t=Math.floor(t),isFinite(t)&&t>0?t>1?dd(function(n){n.setTime(Math.floor(n/t)*t)},function(n,e){n.setTime(+n+e*t)},function(n,e){return(e-n)/t}):pd:null};var vd=pd.range,gd=6e4,yd=6048e5,_d=dd(function(t){t.setTime(t-t.getMilliseconds())},function(t,n){t.setTime(+t+1e3*n)},function(t,n){return(n-t)/1e3},function(t){return t.getUTCSeconds()}),bd=_d.range,md=dd(function(t){t.setTime(t-t.getMilliseconds()-1e3*t.getSeconds())},function(t,n){t.setTime(+t+n*gd)},function(t,n){return(n-t)/gd},function(t){return t.getMinutes()}),xd=md.range,wd=dd(function(t){t.setTime(t-t.getMilliseconds()-1e3*t.getSeconds()-t.getMinutes()*gd)},function(t,n){t.setTime(+t+36e5*n)},function(t,n){return(n-t)/36e5},function(t){return t.getHours()}),Md=wd.range,Nd=dd(function(t){t.setHours(0,0,0,0)},function(t,n){t.setDate(t.getDate()+n)},function(t,n){return(n-t-(n.getTimezoneOffset()-t.getTimezoneOffset())*gd)/864e5},function(t){return t.getDate()-1}),Td=Nd.range;function Ad(t){return dd(function(n){n.setDate(n.getDate()-(n.getDay()+7-t)%7),n.setHours(0,0,0,0)},function(t,n){t.setDate(t.getDate()+7*n)},function(t,n){return(n-t-(n.getTimezoneOffset()-t.getTimezoneOffset())*gd)/yd})}var Sd=Ad(0),kd=Ad(1),Ed=Ad(2),Cd=Ad(3),Pd=Ad(4),zd=Ad(5),Rd=Ad(6),Dd=Sd.range,qd=kd.range,Ld=Ed.range,Ud=Cd.range,Od=Pd.range,Bd=zd.range,Fd=Rd.range,Yd=dd(function(t){t.setDate(1),t.setHours(0,0,0,0)},function(t,n){t.setMonth(t.getMonth()+n)},function(t,n){return n.getMonth()-t.getMonth()+12*(n.getFullYear()-t.getFullYear())},function(t){return t.getMonth()}),Id=Yd.range,Hd=dd(function(t){t.setMonth(0,1),t.setHours(0,0,0,0)},function(t,n){t.setFullYear(t.getFullYear()+n)},function(t,n){return n.getFullYear()-t.getFullYear()},function(t){return t.getFullYear()});Hd.every=function(t){return isFinite(t=Math.floor(t))&&t>0?dd(function(n){n.setFullYear(Math.floor(n.getFullYear()/t)*t),n.setMonth(0,1),n.setHours(0,0,0,0)},function(n,e){n.setFullYear(n.getFullYear()+e*t)}):null};var jd=Hd.range,Xd=dd(function(t){t.setUTCSeconds(0,0)},function(t,n){t.setTime(+t+n*gd)},function(t,n){return(n-t)/gd},function(t){return t.getUTCMinutes()}),Vd=Xd.range,Gd=dd(function(t){t.setUTCMinutes(0,0,0)},function(t,n){t.setTime(+t+36e5*n)},function(t,n){return(n-t)/36e5},function(t){return t.getUTCHours()}),$d=Gd.range,Wd=dd(function(t){t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCDate(t.getUTCDate()+n)},function(t,n){return(n-t)/864e5},function(t){return t.getUTCDate()-1}),Zd=Wd.range;function Qd(t){return dd(function(n){n.setUTCDate(n.getUTCDate()-(n.getUTCDay()+7-t)%7),n.setUTCHours(0,0,0,0)},function(t,n){t.setUTCDate(t.getUTCDate()+7*n)},function(t,n){return(n-t)/yd})}var Kd=Qd(0),Jd=Qd(1),tp=Qd(2),np=Qd(3),ep=Qd(4),rp=Qd(5),ip=Qd(6),op=Kd.range,ap=Jd.range,up=tp.range,cp=np.range,fp=ep.range,sp=rp.range,lp=ip.range,hp=dd(function(t){t.setUTCDate(1),t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCMonth(t.getUTCMonth()+n)},function(t,n){return n.getUTCMonth()-t.getUTCMonth()+12*(n.getUTCFullYear()-t.getUTCFullYear())},function(t){return t.getUTCMonth()}),dp=hp.range,pp=dd(function(t){t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCFullYear(t.getUTCFullYear()+n)},function(t,n){return n.getUTCFullYear()-t.getUTCFullYear()},function(t){return t.getUTCFullYear()});pp.every=function(t){return isFinite(t=Math.floor(t))&&t>0?dd(function(n){n.setUTCFullYear(Math.floor(n.getUTCFullYear()/t)*t),n.setUTCMonth(0,1),n.setUTCHours(0,0,0,0)},function(n,e){n.setUTCFullYear(n.getUTCFullYear()+e*t)}):null};var vp=pp.range;function gp(t){if(0<=t.y&&t.y<100){var n=new Date(-1,t.m,t.d,t.H,t.M,t.S,t.L);return n.setFullYear(t.y),n}return new Date(t.y,t.m,t.d,t.H,t.M,t.S,t.L)}function yp(t){if(0<=t.y&&t.y<100){var n=new Date(Date.UTC(-1,t.m,t.d,t.H,t.M,t.S,t.L));return n.setUTCFullYear(t.y),n}return new Date(Date.UTC(t.y,t.m,t.d,t.H,t.M,t.S,t.L))}function _p(t,n,e){return{y:t,m:n,d:e,H:0,M:0,S:0,L:0}}function bp(t){var n=t.dateTime,e=t.date,r=t.time,i=t.periods,o=t.days,a=t.shortDays,u=t.months,c=t.shortMonths,f=Sp(i),s=kp(i),l=Sp(o),h=kp(o),d=Sp(a),p=kp(a),v=Sp(u),g=kp(u),y=Sp(c),_=kp(c),b={a:function(t){return a[t.getDay()]},A:function(t){return o[t.getDay()]},b:function(t){return c[t.getMonth()]},B:function(t){return u[t.getMonth()]},c:null,d:Wp,e:Wp,f:tv,H:Zp,I:Qp,j:Kp,L:Jp,m:nv,M:ev,p:function(t){return i[+(t.getHours()>=12)]},q:function(t){return 1+~~(t.getMonth()/3)},Q:Cv,s:Pv,S:rv,u:iv,U:ov,V:av,w:uv,W:cv,x:null,X:null,y:fv,Y:sv,Z:lv,"%":Ev},m={a:function(t){return a[t.getUTCDay()]},A:function(t){return o[t.getUTCDay()]},b:function(t){return c[t.getUTCMonth()]},B:function(t){return u[t.getUTCMonth()]},c:null,d:hv,e:hv,f:yv,H:dv,I:pv,j:vv,L:gv,m:_v,M:bv,p:function(t){return i[+(t.getUTCHours()>=12)]},q:function(t){return 1+~~(t.getUTCMonth()/3)},Q:Cv,s:Pv,S:mv,u:xv,U:wv,V:Mv,w:Nv,W:Tv,x:null,X:null,y:Av,Y:Sv,Z:kv,"%":Ev},x={a:function(t,n,e){var r=d.exec(n.slice(e));return r?(t.w=p[r[0].toLowerCase()],e+r[0].length):-1},A:function(t,n,e){var r=l.exec(n.slice(e));return r?(t.w=h[r[0].toLowerCase()],e+r[0].length):-1},b:function(t,n,e){var r=y.exec(n.slice(e));return r?(t.m=_[r[0].toLowerCase()],e+r[0].length):-1},B:function(t,n,e){var r=v.exec(n.slice(e));return r?(t.m=g[r[0].toLowerCase()],e+r[0].length):-1},c:function(t,e,r){return N(t,n,e,r)},d:Bp,e:Bp,f:Xp,H:Yp,I:Yp,j:Fp,L:jp,m:Op,M:Ip,p:function(t,n,e){var r=f.exec(n.slice(e));return r?(t.p=s[r[0].toLowerCase()],e+r[0].length):-1},q:Up,Q:Gp,s:$p,S:Hp,u:Cp,U:Pp,V:zp,w:Ep,W:Rp,x:function(t,n,r){return N(t,e,n,r)},X:function(t,n,e){return N(t,r,n,e)},y:qp,Y:Dp,Z:Lp,"%":Vp};function w(t,n){return function(e){var r,i,o,a=[],u=-1,c=0,f=t.length;for(e instanceof Date||(e=new Date(+e));++u<f;)37===t.charCodeAt(u)&&(a.push(t.slice(c,u)),null!=(i=xp[r=t.charAt(++u)])?r=t.charAt(++u):i="e"===r?" ":"0",(o=n[r])&&(r=o(e,i)),a.push(r),c=u+1);return a.push(t.slice(c,u)),a.join("")}}function M(t,n){return function(e){var r,i,o=_p(1900,void 0,1);if(N(o,t,e+="",0)!=e.length)return null;if("Q"in o)return new Date(o.Q);if("s"in o)return new Date(1e3*o.s+("L"in o?o.L:0));if(!n||"Z"in o||(o.Z=0),"p"in o&&(o.H=o.H%12+12*o.p),void 0===o.m&&(o.m="q"in o?o.q:0),"V"in o){if(o.V<1||o.V>53)return null;"w"in o||(o.w=1),"Z"in o?(i=(r=yp(_p(o.y,0,1))).getUTCDay(),r=i>4||0===i?Jd.ceil(r):Jd(r),r=Wd.offset(r,7*(o.V-1)),o.y=r.getUTCFullYear(),o.m=r.getUTCMonth(),o.d=r.getUTCDate()+(o.w+6)%7):(i=(r=gp(_p(o.y,0,1))).getDay(),r=i>4||0===i?kd.ceil(r):kd(r),r=Nd.offset(r,7*(o.V-1)),o.y=r.getFullYear(),o.m=r.getMonth(),o.d=r.getDate()+(o.w+6)%7)}else("W"in o||"U"in o)&&("w"in o||(o.w="u"in o?o.u%7:"W"in o?1:0),i="Z"in o?yp(_p(o.y,0,1)).getUTCDay():gp(_p(o.y,0,1)).getDay(),o.m=0,o.d="W"in o?(o.w+6)%7+7*o.W-(i+5)%7:o.w+7*o.U-(i+6)%7);return"Z"in o?(o.H+=o.Z/100|0,o.M+=o.Z%100,yp(o)):gp(o)}}function N(t,n,e,r){for(var i,o,a=0,u=n.length,c=e.length;a<u;){if(r>=c)return-1;if(37===(i=n.charCodeAt(a++))){if(i=n.charAt(a++),!(o=x[i in xp?n.charAt(a++):i])||(r=o(t,e,r))<0)return-1}else if(i!=e.charCodeAt(r++))return-1}return r}return b.x=w(e,b),b.X=w(r,b),b.c=w(n,b),m.x=w(e,m),m.X=w(r,m),m.c=w(n,m),{format:function(t){var n=w(t+="",b);return n.toString=function(){return t},n},parse:function(t){var n=M(t+="",!1);return n.toString=function(){return t},n},utcFormat:function(t){var n=w(t+="",m);return n.toString=function(){return t},n},utcParse:function(t){var n=M(t+="",!0);return n.toString=function(){return t},n}}}var mp,xp={"-":"",_:" ",0:"0"},wp=/^\s*\d+/,Mp=/^%/,Np=/[\\^$*+?|[\]().{}]/g;function Tp(t,n,e){var r=t<0?"-":"",i=(r?-t:t)+"",o=i.length;return r+(o<e?new Array(e-o+1).join(n)+i:i)}function Ap(t){return t.replace(Np,"\\$&")}function Sp(t){return new RegExp("^(?:"+t.map(Ap).join("|")+")","i")}function kp(t){for(var n={},e=-1,r=t.length;++e<r;)n[t[e].toLowerCase()]=e;return n}function Ep(t,n,e){var r=wp.exec(n.slice(e,e+1));return r?(t.w=+r[0],e+r[0].length):-1}function Cp(t,n,e){var r=wp.exec(n.slice(e,e+1));return r?(t.u=+r[0],e+r[0].length):-1}function Pp(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.U=+r[0],e+r[0].length):-1}function zp(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.V=+r[0],e+r[0].length):-1}function Rp(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.W=+r[0],e+r[0].length):-1}function Dp(t,n,e){var r=wp.exec(n.slice(e,e+4));return r?(t.y=+r[0],e+r[0].length):-1}function qp(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.y=+r[0]+(+r[0]>68?1900:2e3),e+r[0].length):-1}function Lp(t,n,e){var r=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(n.slice(e,e+6));return r?(t.Z=r[1]?0:-(r[2]+(r[3]||"00")),e+r[0].length):-1}function Up(t,n,e){var r=wp.exec(n.slice(e,e+1));return r?(t.q=3*r[0]-3,e+r[0].length):-1}function Op(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.m=r[0]-1,e+r[0].length):-1}function Bp(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.d=+r[0],e+r[0].length):-1}function Fp(t,n,e){var r=wp.exec(n.slice(e,e+3));return r?(t.m=0,t.d=+r[0],e+r[0].length):-1}function Yp(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.H=+r[0],e+r[0].length):-1}function Ip(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.M=+r[0],e+r[0].length):-1}function Hp(t,n,e){var r=wp.exec(n.slice(e,e+2));return r?(t.S=+r[0],e+r[0].length):-1}function jp(t,n,e){var r=wp.exec(n.slice(e,e+3));return r?(t.L=+r[0],e+r[0].length):-1}function Xp(t,n,e){var r=wp.exec(n.slice(e,e+6));return r?(t.L=Math.floor(r[0]/1e3),e+r[0].length):-1}function Vp(t,n,e){var r=Mp.exec(n.slice(e,e+1));return r?e+r[0].length:-1}function Gp(t,n,e){var r=wp.exec(n.slice(e));return r?(t.Q=+r[0],e+r[0].length):-1}function $p(t,n,e){var r=wp.exec(n.slice(e));return r?(t.s=+r[0],e+r[0].length):-1}function Wp(t,n){return Tp(t.getDate(),n,2)}function Zp(t,n){return Tp(t.getHours(),n,2)}function Qp(t,n){return Tp(t.getHours()%12||12,n,2)}function Kp(t,n){return Tp(1+Nd.count(Hd(t),t),n,3)}function Jp(t,n){return Tp(t.getMilliseconds(),n,3)}function tv(t,n){return Jp(t,n)+"000"}function nv(t,n){return Tp(t.getMonth()+1,n,2)}function ev(t,n){return Tp(t.getMinutes(),n,2)}function rv(t,n){return Tp(t.getSeconds(),n,2)}function iv(t){var n=t.getDay();return 0===n?7:n}function ov(t,n){return Tp(Sd.count(Hd(t)-1,t),n,2)}function av(t,n){var e=t.getDay();return t=e>=4||0===e?Pd(t):Pd.ceil(t),Tp(Pd.count(Hd(t),t)+(4===Hd(t).getDay()),n,2)}function uv(t){return t.getDay()}function cv(t,n){return Tp(kd.count(Hd(t)-1,t),n,2)}function fv(t,n){return Tp(t.getFullYear()%100,n,2)}function sv(t,n){return Tp(t.getFullYear()%1e4,n,4)}function lv(t){var n=t.getTimezoneOffset();return(n>0?"-":(n*=-1,"+"))+Tp(n/60|0,"0",2)+Tp(n%60,"0",2)}function hv(t,n){return Tp(t.getUTCDate(),n,2)}function dv(t,n){return Tp(t.getUTCHours(),n,2)}function pv(t,n){return Tp(t.getUTCHours()%12||12,n,2)}function vv(t,n){return Tp(1+Wd.count(pp(t),t),n,3)}function gv(t,n){return Tp(t.getUTCMilliseconds(),n,3)}function yv(t,n){return gv(t,n)+"000"}function _v(t,n){return Tp(t.getUTCMonth()+1,n,2)}function bv(t,n){return Tp(t.getUTCMinutes(),n,2)}function mv(t,n){return Tp(t.getUTCSeconds(),n,2)}function xv(t){var n=t.getUTCDay();return 0===n?7:n}function wv(t,n){return Tp(Kd.count(pp(t)-1,t),n,2)}function Mv(t,n){var e=t.getUTCDay();return t=e>=4||0===e?ep(t):ep.ceil(t),Tp(ep.count(pp(t),t)+(4===pp(t).getUTCDay()),n,2)}function Nv(t){return t.getUTCDay()}function Tv(t,n){return Tp(Jd.count(pp(t)-1,t),n,2)}function Av(t,n){return Tp(t.getUTCFullYear()%100,n,2)}function Sv(t,n){return Tp(t.getUTCFullYear()%1e4,n,4)}function kv(){return"+0000"}function Ev(){return"%"}function Cv(t){return+t}function Pv(t){return Math.floor(+t/1e3)}function zv(n){return mp=bp(n),t.timeFormat=mp.format,t.timeParse=mp.parse,t.utcFormat=mp.utcFormat,t.utcParse=mp.utcParse,mp}zv({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});var Rv=Date.prototype.toISOString?function(t){return t.toISOString()}:t.utcFormat("%Y-%m-%dT%H:%M:%S.%LZ");var Dv=+new Date("2000-01-01T00:00:00.000Z")?function(t){var n=new Date(t);return isNaN(n)?null:n}:t.utcParse("%Y-%m-%dT%H:%M:%S.%LZ"),qv=1e3,Lv=60*qv,Uv=60*Lv,Ov=24*Uv,Bv=7*Ov,Fv=30*Ov,Yv=365*Ov;function Iv(t){return new Date(t)}function Hv(t){return t instanceof Date?+t:+new Date(+t)}function jv(t,n,r,i,o,a,u,c,f){var s=Vh(Bh,Bh),l=s.invert,h=s.domain,d=f(".%L"),p=f(":%S"),v=f("%I:%M"),g=f("%I %p"),y=f("%a %d"),_=f("%b %d"),b=f("%B"),m=f("%Y"),x=[[u,1,qv],[u,5,5*qv],[u,15,15*qv],[u,30,30*qv],[a,1,Lv],[a,5,5*Lv],[a,15,15*Lv],[a,30,30*Lv],[o,1,Uv],[o,3,3*Uv],[o,6,6*Uv],[o,12,12*Uv],[i,1,Ov],[i,2,2*Ov],[r,1,Bv],[n,1,Fv],[n,3,3*Fv],[t,1,Yv]];function M(e){return(u(e)<e?d:a(e)<e?p:o(e)<e?v:i(e)<e?g:n(e)<e?r(e)<e?y:_:t(e)<e?b:m)(e)}function N(n,r,i,o){if(null==n&&(n=10),"number"==typeof n){var a=Math.abs(i-r)/n,u=e(function(t){return t[2]}).right(x,a);u===x.length?(o=w(r/Yv,i/Yv,n),n=t):u?(o=(u=x[a/x[u-1][2]<x[u][2]/a?u-1:u])[1],n=u[0]):(o=Math.max(w(r,i,n),1),n=c)}return null==o?n:n.every(o)}return s.invert=function(t){return new Date(l(t))},s.domain=function(t){return arguments.length?h(zh.call(t,Hv)):h().map(Iv)},s.ticks=function(t,n){var e,r=h(),i=r[0],o=r[r.length-1],a=o<i;return a&&(e=i,i=o,o=e),e=(e=N(t,i,o,n))?e.range(i,o+1):[],a?e.reverse():e},s.tickFormat=function(t,n){return null==n?M:f(n)},s.nice=function(t,n){var e=h();return(t=N(t,e[0],e[e.length-1],n))?h(Wh(e,t)):s},s.copy=function(){return jh(s,jv(t,n,r,i,o,a,u,c,f))},s}function Xv(){var t,n,e,r,i,o=0,a=1,u=Bh,c=!1;function f(n){return isNaN(n=+n)?i:u(0===e?.5:(n=(r(n)-t)*e,c?Math.max(0,Math.min(1,n)):n))}return f.domain=function(i){return arguments.length?(t=r(o=+i[0]),n=r(a=+i[1]),e=t===n?0:1/(n-t),f):[o,a]},f.clamp=function(t){return arguments.length?(c=!!t,f):c},f.interpolator=function(t){return arguments.length?(u=t,f):u},f.unknown=function(t){return arguments.length?(i=t,f):i},function(i){return r=i,t=i(o),n=i(a),e=t===n?0:1/(n-t),f}}function Vv(t,n){return n.domain(t.domain()).interpolator(t.interpolator()).clamp(t.clamp()).unknown(t.unknown())}function Gv(){var t=fd(Xv());return t.copy=function(){return Vv(t,Gv()).exponent(t.exponent())},Ch.apply(t,arguments)}function $v(){var t,n,e,r,i,o,a,u=0,c=.5,f=1,s=Bh,l=!1;function h(t){return isNaN(t=+t)?a:(t=.5+((t=+o(t))-n)*(t<n?r:i),s(l?Math.max(0,Math.min(1,t)):t))}return h.domain=function(a){return arguments.length?(t=o(u=+a[0]),n=o(c=+a[1]),e=o(f=+a[2]),r=t===n?0:.5/(n-t),i=n===e?0:.5/(e-n),h):[u,c,f]},h.clamp=function(t){return arguments.length?(l=!!t,h):l},h.interpolator=function(t){return arguments.length?(s=t,h):s},h.unknown=function(t){return arguments.length?(a=t,h):a},function(a){return o=a,t=a(u),n=a(c),e=a(f),r=t===n?0:.5/(n-t),i=n===e?0:.5/(e-n),h}}function Wv(){var t=fd($v());return t.copy=function(){return Vv(t,Wv()).exponent(t.exponent())},Ch.apply(t,arguments)}function Zv(t){for(var n=t.length/6|0,e=new Array(n),r=0;r<n;)e[r]="#"+t.slice(6*r,6*++r);return e}var Qv=Zv("1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf"),Kv=Zv("7fc97fbeaed4fdc086ffff99386cb0f0027fbf5b17666666"),Jv=Zv("1b9e77d95f027570b3e7298a66a61ee6ab02a6761d666666"),tg=Zv("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928"),ng=Zv("fbb4aeb3cde3ccebc5decbe4fed9a6ffffcce5d8bdfddaecf2f2f2"),eg=Zv("b3e2cdfdcdaccbd5e8f4cae4e6f5c9fff2aef1e2cccccccc"),rg=Zv("e41a1c377eb84daf4a984ea3ff7f00ffff33a65628f781bf999999"),ig=Zv("66c2a5fc8d628da0cbe78ac3a6d854ffd92fe5c494b3b3b3"),og=Zv("8dd3c7ffffb3bebadafb807280b1d3fdb462b3de69fccde5d9d9d9bc80bdccebc5ffed6f"),ag=Zv("4e79a7f28e2ce1575976b7b259a14fedc949af7aa1ff9da79c755fbab0ab");function ug(t){return pe(t[t.length-1])}var cg=new Array(3).concat("d8b365f5f5f55ab4ac","a6611adfc27d80cdc1018571","a6611adfc27df5f5f580cdc1018571","8c510ad8b365f6e8c3c7eae55ab4ac01665e","8c510ad8b365f6e8c3f5f5f5c7eae55ab4ac01665e","8c510abf812ddfc27df6e8c3c7eae580cdc135978f01665e","8c510abf812ddfc27df6e8c3f5f5f5c7eae580cdc135978f01665e","5430058c510abf812ddfc27df6e8c3c7eae580cdc135978f01665e003c30","5430058c510abf812ddfc27df6e8c3f5f5f5c7eae580cdc135978f01665e003c30").map(Zv),fg=ug(cg),sg=new Array(3).concat("af8dc3f7f7f77fbf7b","7b3294c2a5cfa6dba0008837","7b3294c2a5cff7f7f7a6dba0008837","762a83af8dc3e7d4e8d9f0d37fbf7b1b7837","762a83af8dc3e7d4e8f7f7f7d9f0d37fbf7b1b7837","762a839970abc2a5cfe7d4e8d9f0d3a6dba05aae611b7837","762a839970abc2a5cfe7d4e8f7f7f7d9f0d3a6dba05aae611b7837","40004b762a839970abc2a5cfe7d4e8d9f0d3a6dba05aae611b783700441b","40004b762a839970abc2a5cfe7d4e8f7f7f7d9f0d3a6dba05aae611b783700441b").map(Zv),lg=ug(sg),hg=new Array(3).concat("e9a3c9f7f7f7a1d76a","d01c8bf1b6dab8e1864dac26","d01c8bf1b6daf7f7f7b8e1864dac26","c51b7de9a3c9fde0efe6f5d0a1d76a4d9221","c51b7de9a3c9fde0eff7f7f7e6f5d0a1d76a4d9221","c51b7dde77aef1b6dafde0efe6f5d0b8e1867fbc414d9221","c51b7dde77aef1b6dafde0eff7f7f7e6f5d0b8e1867fbc414d9221","8e0152c51b7dde77aef1b6dafde0efe6f5d0b8e1867fbc414d9221276419","8e0152c51b7dde77aef1b6dafde0eff7f7f7e6f5d0b8e1867fbc414d9221276419").map(Zv),dg=ug(hg),pg=new Array(3).concat("998ec3f7f7f7f1a340","5e3c99b2abd2fdb863e66101","5e3c99b2abd2f7f7f7fdb863e66101","542788998ec3d8daebfee0b6f1a340b35806","542788998ec3d8daebf7f7f7fee0b6f1a340b35806","5427888073acb2abd2d8daebfee0b6fdb863e08214b35806","5427888073acb2abd2d8daebf7f7f7fee0b6fdb863e08214b35806","2d004b5427888073acb2abd2d8daebfee0b6fdb863e08214b358067f3b08","2d004b5427888073acb2abd2d8daebf7f7f7fee0b6fdb863e08214b358067f3b08").map(Zv),vg=ug(pg),gg=new Array(3).concat("ef8a62f7f7f767a9cf","ca0020f4a58292c5de0571b0","ca0020f4a582f7f7f792c5de0571b0","b2182bef8a62fddbc7d1e5f067a9cf2166ac","b2182bef8a62fddbc7f7f7f7d1e5f067a9cf2166ac","b2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac","b2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac","67001fb2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac053061","67001fb2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac053061").map(Zv),yg=ug(gg),_g=new Array(3).concat("ef8a62ffffff999999","ca0020f4a582bababa404040","ca0020f4a582ffffffbababa404040","b2182bef8a62fddbc7e0e0e09999994d4d4d","b2182bef8a62fddbc7ffffffe0e0e09999994d4d4d","b2182bd6604df4a582fddbc7e0e0e0bababa8787874d4d4d","b2182bd6604df4a582fddbc7ffffffe0e0e0bababa8787874d4d4d","67001fb2182bd6604df4a582fddbc7e0e0e0bababa8787874d4d4d1a1a1a","67001fb2182bd6604df4a582fddbc7ffffffe0e0e0bababa8787874d4d4d1a1a1a").map(Zv),bg=ug(_g),mg=new Array(3).concat("fc8d59ffffbf91bfdb","d7191cfdae61abd9e92c7bb6","d7191cfdae61ffffbfabd9e92c7bb6","d73027fc8d59fee090e0f3f891bfdb4575b4","d73027fc8d59fee090ffffbfe0f3f891bfdb4575b4","d73027f46d43fdae61fee090e0f3f8abd9e974add14575b4","d73027f46d43fdae61fee090ffffbfe0f3f8abd9e974add14575b4","a50026d73027f46d43fdae61fee090e0f3f8abd9e974add14575b4313695","a50026d73027f46d43fdae61fee090ffffbfe0f3f8abd9e974add14575b4313695").map(Zv),xg=ug(mg),wg=new Array(3).concat("fc8d59ffffbf91cf60","d7191cfdae61a6d96a1a9641","d7191cfdae61ffffbfa6d96a1a9641","d73027fc8d59fee08bd9ef8b91cf601a9850","d73027fc8d59fee08bffffbfd9ef8b91cf601a9850","d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850","d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850","a50026d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850006837","a50026d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850006837").map(Zv),Mg=ug(wg),Ng=new Array(3).concat("fc8d59ffffbf99d594","d7191cfdae61abdda42b83ba","d7191cfdae61ffffbfabdda42b83ba","d53e4ffc8d59fee08be6f59899d5943288bd","d53e4ffc8d59fee08bffffbfe6f59899d5943288bd","d53e4ff46d43fdae61fee08be6f598abdda466c2a53288bd","d53e4ff46d43fdae61fee08bffffbfe6f598abdda466c2a53288bd","9e0142d53e4ff46d43fdae61fee08be6f598abdda466c2a53288bd5e4fa2","9e0142d53e4ff46d43fdae61fee08bffffbfe6f598abdda466c2a53288bd5e4fa2").map(Zv),Tg=ug(Ng),Ag=new Array(3).concat("e5f5f999d8c92ca25f","edf8fbb2e2e266c2a4238b45","edf8fbb2e2e266c2a42ca25f006d2c","edf8fbccece699d8c966c2a42ca25f006d2c","edf8fbccece699d8c966c2a441ae76238b45005824","f7fcfde5f5f9ccece699d8c966c2a441ae76238b45005824","f7fcfde5f5f9ccece699d8c966c2a441ae76238b45006d2c00441b").map(Zv),Sg=ug(Ag),kg=new Array(3).concat("e0ecf49ebcda8856a7","edf8fbb3cde38c96c688419d","edf8fbb3cde38c96c68856a7810f7c","edf8fbbfd3e69ebcda8c96c68856a7810f7c","edf8fbbfd3e69ebcda8c96c68c6bb188419d6e016b","f7fcfde0ecf4bfd3e69ebcda8c96c68c6bb188419d6e016b","f7fcfde0ecf4bfd3e69ebcda8c96c68c6bb188419d810f7c4d004b").map(Zv),Eg=ug(kg),Cg=new Array(3).concat("e0f3dba8ddb543a2ca","f0f9e8bae4bc7bccc42b8cbe","f0f9e8bae4bc7bccc443a2ca0868ac","f0f9e8ccebc5a8ddb57bccc443a2ca0868ac","f0f9e8ccebc5a8ddb57bccc44eb3d32b8cbe08589e","f7fcf0e0f3dbccebc5a8ddb57bccc44eb3d32b8cbe08589e","f7fcf0e0f3dbccebc5a8ddb57bccc44eb3d32b8cbe0868ac084081").map(Zv),Pg=ug(Cg),zg=new Array(3).concat("fee8c8fdbb84e34a33","fef0d9fdcc8afc8d59d7301f","fef0d9fdcc8afc8d59e34a33b30000","fef0d9fdd49efdbb84fc8d59e34a33b30000","fef0d9fdd49efdbb84fc8d59ef6548d7301f990000","fff7ecfee8c8fdd49efdbb84fc8d59ef6548d7301f990000","fff7ecfee8c8fdd49efdbb84fc8d59ef6548d7301fb300007f0000").map(Zv),Rg=ug(zg),Dg=new Array(3).concat("ece2f0a6bddb1c9099","f6eff7bdc9e167a9cf02818a","f6eff7bdc9e167a9cf1c9099016c59","f6eff7d0d1e6a6bddb67a9cf1c9099016c59","f6eff7d0d1e6a6bddb67a9cf3690c002818a016450","fff7fbece2f0d0d1e6a6bddb67a9cf3690c002818a016450","fff7fbece2f0d0d1e6a6bddb67a9cf3690c002818a016c59014636").map(Zv),qg=ug(Dg),Lg=new Array(3).concat("ece7f2a6bddb2b8cbe","f1eef6bdc9e174a9cf0570b0","f1eef6bdc9e174a9cf2b8cbe045a8d","f1eef6d0d1e6a6bddb74a9cf2b8cbe045a8d","f1eef6d0d1e6a6bddb74a9cf3690c00570b0034e7b","fff7fbece7f2d0d1e6a6bddb74a9cf3690c00570b0034e7b","fff7fbece7f2d0d1e6a6bddb74a9cf3690c00570b0045a8d023858").map(Zv),Ug=ug(Lg),Og=new Array(3).concat("e7e1efc994c7dd1c77","f1eef6d7b5d8df65b0ce1256","f1eef6d7b5d8df65b0dd1c77980043","f1eef6d4b9dac994c7df65b0dd1c77980043","f1eef6d4b9dac994c7df65b0e7298ace125691003f","f7f4f9e7e1efd4b9dac994c7df65b0e7298ace125691003f","f7f4f9e7e1efd4b9dac994c7df65b0e7298ace125698004367001f").map(Zv),Bg=ug(Og),Fg=new Array(3).concat("fde0ddfa9fb5c51b8a","feebe2fbb4b9f768a1ae017e","feebe2fbb4b9f768a1c51b8a7a0177","feebe2fcc5c0fa9fb5f768a1c51b8a7a0177","feebe2fcc5c0fa9fb5f768a1dd3497ae017e7a0177","fff7f3fde0ddfcc5c0fa9fb5f768a1dd3497ae017e7a0177","fff7f3fde0ddfcc5c0fa9fb5f768a1dd3497ae017e7a017749006a").map(Zv),Yg=ug(Fg),Ig=new Array(3).concat("edf8b17fcdbb2c7fb8","ffffcca1dab441b6c4225ea8","ffffcca1dab441b6c42c7fb8253494","ffffccc7e9b47fcdbb41b6c42c7fb8253494","ffffccc7e9b47fcdbb41b6c41d91c0225ea80c2c84","ffffd9edf8b1c7e9b47fcdbb41b6c41d91c0225ea80c2c84","ffffd9edf8b1c7e9b47fcdbb41b6c41d91c0225ea8253494081d58").map(Zv),Hg=ug(Ig),jg=new Array(3).concat("f7fcb9addd8e31a354","ffffccc2e69978c679238443","ffffccc2e69978c67931a354006837","ffffccd9f0a3addd8e78c67931a354006837","ffffccd9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443006837004529").map(Zv),Xg=ug(jg),Vg=new Array(3).concat("fff7bcfec44fd95f0e","ffffd4fed98efe9929cc4c02","ffffd4fed98efe9929d95f0e993404","ffffd4fee391fec44ffe9929d95f0e993404","ffffd4fee391fec44ffe9929ec7014cc4c028c2d04","ffffe5fff7bcfee391fec44ffe9929ec7014cc4c028c2d04","ffffe5fff7bcfee391fec44ffe9929ec7014cc4c02993404662506").map(Zv),Gg=ug(Vg),$g=new Array(3).concat("ffeda0feb24cf03b20","ffffb2fecc5cfd8d3ce31a1c","ffffb2fecc5cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cbd0026800026").map(Zv),Wg=ug($g),Zg=new Array(3).concat("deebf79ecae13182bd","eff3ffbdd7e76baed62171b5","eff3ffbdd7e76baed63182bd08519c","eff3ffc6dbef9ecae16baed63182bd08519c","eff3ffc6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b508519c08306b").map(Zv),Qg=ug(Zg),Kg=new Array(3).concat("e5f5e0a1d99b31a354","edf8e9bae4b374c476238b45","edf8e9bae4b374c47631a354006d2c","edf8e9c7e9c0a1d99b74c47631a354006d2c","edf8e9c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45006d2c00441b").map(Zv),Jg=ug(Kg),ty=new Array(3).concat("f0f0f0bdbdbd636363","f7f7f7cccccc969696525252","f7f7f7cccccc969696636363252525","f7f7f7d9d9d9bdbdbd969696636363252525","f7f7f7d9d9d9bdbdbd969696737373525252252525","fffffff0f0f0d9d9d9bdbdbd969696737373525252252525","fffffff0f0f0d9d9d9bdbdbd969696737373525252252525000000").map(Zv),ny=ug(ty),ey=new Array(3).concat("efedf5bcbddc756bb1","f2f0f7cbc9e29e9ac86a51a3","f2f0f7cbc9e29e9ac8756bb154278f","f2f0f7dadaebbcbddc9e9ac8756bb154278f","f2f0f7dadaebbcbddc9e9ac8807dba6a51a34a1486","fcfbfdefedf5dadaebbcbddc9e9ac8807dba6a51a34a1486","fcfbfdefedf5dadaebbcbddc9e9ac8807dba6a51a354278f3f007d").map(Zv),ry=ug(ey),iy=new Array(3).concat("fee0d2fc9272de2d26","fee5d9fcae91fb6a4acb181d","fee5d9fcae91fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181da50f1567000d").map(Zv),oy=ug(iy),ay=new Array(3).concat("fee6cefdae6be6550d","feeddefdbe85fd8d3cd94701","feeddefdbe85fd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d94801a636037f2704").map(Zv),uy=ug(ay);var cy=Qe(ee(300,.5,0),ee(-240,.5,1)),fy=Qe(ee(-100,.75,.35),ee(80,1.5,.8)),sy=Qe(ee(260,.75,.35),ee(80,1.5,.8)),ly=ee();var hy=_n(),dy=Math.PI/3,py=2*Math.PI/3;function vy(t){var n=t.length;return function(e){return t[Math.max(0,Math.min(n-1,Math.floor(e*n)))]}}var gy=vy(Zv("44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725")),yy=vy(Zv("00000401000501010601010802010902020b02020d03030f03031204041405041606051806051a07061c08071e0907200a08220b09240c09260d0a290e0b2b100b2d110c2f120d31130d34140e36150e38160f3b180f3d19103f1a10421c10441d11471e114920114b21114e22115024125325125527125829115a2a115c2c115f2d11612f116331116533106734106936106b38106c390f6e3b0f703d0f713f0f72400f74420f75440f764510774710784910784a10794c117a4e117b4f127b51127c52137c54137d56147d57157e59157e5a167e5c167f5d177f5f187f601880621980641a80651a80671b80681c816a1c816b1d816d1d816e1e81701f81721f817320817521817621817822817922827b23827c23827e24828025828125818326818426818627818827818928818b29818c29818e2a81902a81912b81932b80942c80962c80982d80992d809b2e7f9c2e7f9e2f7fa02f7fa1307ea3307ea5317ea6317da8327daa337dab337cad347cae347bb0357bb2357bb3367ab5367ab73779b83779ba3878bc3978bd3977bf3a77c03a76c23b75c43c75c53c74c73d73c83e73ca3e72cc3f71cd4071cf4070d0416fd2426fd3436ed5446dd6456cd8456cd9466bdb476adc4869de4968df4a68e04c67e24d66e34e65e44f64e55064e75263e85362e95462ea5661eb5760ec5860ed5a5fee5b5eef5d5ef05f5ef1605df2625df2645cf3655cf4675cf4695cf56b5cf66c5cf66e5cf7705cf7725cf8745cf8765cf9785df9795df97b5dfa7d5efa7f5efa815ffb835ffb8560fb8761fc8961fc8a62fc8c63fc8e64fc9065fd9266fd9467fd9668fd9869fd9a6afd9b6bfe9d6cfe9f6dfea16efea36ffea571fea772fea973feaa74feac76feae77feb078feb27afeb47bfeb67cfeb77efeb97ffebb81febd82febf84fec185fec287fec488fec68afec88cfeca8dfecc8ffecd90fecf92fed194fed395fed597fed799fed89afdda9cfddc9efddea0fde0a1fde2a3fde3a5fde5a7fde7a9fde9aafdebacfcecaefceeb0fcf0b2fcf2b4fcf4b6fcf6b8fcf7b9fcf9bbfcfbbdfcfdbf")),_y=vy(Zv("00000401000501010601010802010a02020c02020e03021004031204031405041706041907051b08051d09061f0a07220b07240c08260d08290e092b10092d110a30120a32140b34150b37160b39180c3c190c3e1b0c411c0c431e0c451f0c48210c4a230c4c240c4f260c51280b53290b552b0b572d0b592f0a5b310a5c320a5e340a5f3609613809623909633b09643d09653e0966400a67420a68440a68450a69470b6a490b6a4a0c6b4c0c6b4d0d6c4f0d6c510e6c520e6d540f6d550f6d57106e59106e5a116e5c126e5d126e5f136e61136e62146e64156e65156e67166e69166e6a176e6c186e6d186e6f196e71196e721a6e741a6e751b6e771c6d781c6d7a1d6d7c1d6d7d1e6d7f1e6c801f6c82206c84206b85216b87216b88226a8a226a8c23698d23698f24699025689225689326679526679727669827669a28659b29649d29649f2a63a02a63a22b62a32c61a52c60a62d60a82e5fa92e5eab2f5ead305dae305cb0315bb1325ab3325ab43359b63458b73557b93556ba3655bc3754bd3853bf3952c03a51c13a50c33b4fc43c4ec63d4dc73e4cc83f4bca404acb4149cc4248ce4347cf4446d04545d24644d34743d44842d54a41d74b3fd84c3ed94d3dda4e3cdb503bdd513ade5238df5337e05536e15635e25734e35933e45a31e55c30e65d2fe75e2ee8602de9612bea632aeb6429eb6628ec6726ed6925ee6a24ef6c23ef6e21f06f20f1711ff1731df2741cf3761bf37819f47918f57b17f57d15f67e14f68013f78212f78410f8850ff8870ef8890cf98b0bf98c0af98e09fa9008fa9207fa9407fb9606fb9706fb9906fb9b06fb9d07fc9f07fca108fca309fca50afca60cfca80dfcaa0ffcac11fcae12fcb014fcb216fcb418fbb61afbb81dfbba1ffbbc21fbbe23fac026fac228fac42afac62df9c72ff9c932f9cb35f8cd37f8cf3af7d13df7d340f6d543f6d746f5d949f5db4cf4dd4ff4df53f4e156f3e35af3e55df2e661f2e865f2ea69f1ec6df1ed71f1ef75f1f179f2f27df2f482f3f586f3f68af4f88ef5f992f6fa96f8fb9af9fc9dfafda1fcffa4")),by=vy(Zv("0d088710078813078916078a19068c1b068d1d068e20068f2206902406912605912805922a05932c05942e05952f059631059733059735049837049938049a3a049a3c049b3e049c3f049c41049d43039e44039e46039f48039f4903a04b03a14c02a14e02a25002a25102a35302a35502a45601a45801a45901a55b01a55c01a65e01a66001a66100a76300a76400a76600a76700a86900a86a00a86c00a86e00a86f00a87100a87201a87401a87501a87701a87801a87a02a87b02a87d03a87e03a88004a88104a78305a78405a78606a68707a68808a68a09a58b0aa58d0ba58e0ca48f0da4910ea3920fa39410a29511a19613a19814a099159f9a169f9c179e9d189d9e199da01a9ca11b9ba21d9aa31e9aa51f99a62098a72197a82296aa2395ab2494ac2694ad2793ae2892b02991b12a90b22b8fb32c8eb42e8db52f8cb6308bb7318ab83289ba3388bb3488bc3587bd3786be3885bf3984c03a83c13b82c23c81c33d80c43e7fc5407ec6417dc7427cc8437bc9447aca457acb4679cc4778cc4977cd4a76ce4b75cf4c74d04d73d14e72d24f71d35171d45270d5536fd5546ed6556dd7566cd8576bd9586ada5a6ada5b69db5c68dc5d67dd5e66de5f65de6164df6263e06363e16462e26561e26660e3685fe4695ee56a5de56b5de66c5ce76e5be76f5ae87059e97158e97257ea7457eb7556eb7655ec7754ed7953ed7a52ee7b51ef7c51ef7e50f07f4ff0804ef1814df1834cf2844bf3854bf3874af48849f48948f58b47f58c46f68d45f68f44f79044f79143f79342f89441f89540f9973ff9983ef99a3efa9b3dfa9c3cfa9e3bfb9f3afba139fba238fca338fca537fca636fca835fca934fdab33fdac33fdae32fdaf31fdb130fdb22ffdb42ffdb52efeb72dfeb82cfeba2cfebb2bfebd2afebe2afec029fdc229fdc328fdc527fdc627fdc827fdca26fdcb26fccd25fcce25fcd025fcd225fbd324fbd524fbd724fad824fada24f9dc24f9dd25f8df25f8e125f7e225f7e425f6e626f6e826f5e926f5eb27f4ed27f3ee27f3f027f2f227f1f426f1f525f0f724f0f921"));function my(t){return function(){return t}}var xy=Math.abs,wy=Math.atan2,My=Math.cos,Ny=Math.max,Ty=Math.min,Ay=Math.sin,Sy=Math.sqrt,ky=1e-12,Ey=Math.PI,Cy=Ey/2,Py=2*Ey;function zy(t){return t>=1?Cy:t<=-1?-Cy:Math.asin(t)}function Ry(t){return t.innerRadius}function Dy(t){return t.outerRadius}function qy(t){return t.startAngle}function Ly(t){return t.endAngle}function Uy(t){return t&&t.padAngle}function Oy(t,n,e,r,i,o,a){var u=t-e,c=n-r,f=(a?o:-o)/Sy(u*u+c*c),s=f*c,l=-f*u,h=t+s,d=n+l,p=e+s,v=r+l,g=(h+p)/2,y=(d+v)/2,_=p-h,b=v-d,m=_*_+b*b,x=i-o,w=h*v-p*d,M=(b<0?-1:1)*Sy(Ny(0,x*x*m-w*w)),N=(w*b-_*M)/m,T=(-w*_-b*M)/m,A=(w*b+_*M)/m,S=(-w*_+b*M)/m,k=N-g,E=T-y,C=A-g,P=S-y;return k*k+E*E>C*C+P*P&&(N=A,T=S),{cx:N,cy:T,x01:-s,y01:-l,x11:N*(i/x-1),y11:T*(i/x-1)}}function By(t){this._context=t}function Fy(t){return new By(t)}function Yy(t){return t[0]}function Iy(t){return t[1]}function Hy(){var t=Yy,n=Iy,e=my(!0),r=null,i=Fy,o=null;function a(a){var u,c,f,s=a.length,l=!1;for(null==r&&(o=i(f=no())),u=0;u<=s;++u)!(u<s&&e(c=a[u],u,a))===l&&((l=!l)?o.lineStart():o.lineEnd()),l&&o.point(+t(c,u,a),+n(c,u,a));if(f)return o=null,f+""||null}return a.x=function(n){return arguments.length?(t="function"==typeof n?n:my(+n),a):t},a.y=function(t){return arguments.length?(n="function"==typeof t?t:my(+t),a):n},a.defined=function(t){return arguments.length?(e="function"==typeof t?t:my(!!t),a):e},a.curve=function(t){return arguments.length?(i=t,null!=r&&(o=i(r)),a):i},a.context=function(t){return arguments.length?(null==t?r=o=null:o=i(r=t),a):r},a}function jy(){var t=Yy,n=null,e=my(0),r=Iy,i=my(!0),o=null,a=Fy,u=null;function c(c){var f,s,l,h,d,p=c.length,v=!1,g=new Array(p),y=new Array(p);for(null==o&&(u=a(d=no())),f=0;f<=p;++f){if(!(f<p&&i(h=c[f],f,c))===v)if(v=!v)s=f,u.areaStart(),u.lineStart();else{for(u.lineEnd(),u.lineStart(),l=f-1;l>=s;--l)u.point(g[l],y[l]);u.lineEnd(),u.areaEnd()}v&&(g[f]=+t(h,f,c),y[f]=+e(h,f,c),u.point(n?+n(h,f,c):g[f],r?+r(h,f,c):y[f]))}if(d)return u=null,d+""||null}function f(){return Hy().defined(i).curve(a).context(o)}return c.x=function(e){return arguments.length?(t="function"==typeof e?e:my(+e),n=null,c):t},c.x0=function(n){return arguments.length?(t="function"==typeof n?n:my(+n),c):t},c.x1=function(t){return arguments.length?(n=null==t?null:"function"==typeof t?t:my(+t),c):n},c.y=function(t){return arguments.length?(e="function"==typeof t?t:my(+t),r=null,c):e},c.y0=function(t){return arguments.length?(e="function"==typeof t?t:my(+t),c):e},c.y1=function(t){return arguments.length?(r=null==t?null:"function"==typeof t?t:my(+t),c):r},c.lineX0=c.lineY0=function(){return f().x(t).y(e)},c.lineY1=function(){return f().x(t).y(r)},c.lineX1=function(){return f().x(n).y(e)},c.defined=function(t){return arguments.length?(i="function"==typeof t?t:my(!!t),c):i},c.curve=function(t){return arguments.length?(a=t,null!=o&&(u=a(o)),c):a},c.context=function(t){return arguments.length?(null==t?o=u=null:u=a(o=t),c):o},c}function Xy(t,n){return n<t?-1:n>t?1:n>=t?0:NaN}function Vy(t){return t}By.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;default:this._context.lineTo(t,n)}}};var Gy=Wy(Fy);function $y(t){this._curve=t}function Wy(t){function n(n){return new $y(t(n))}return n._curve=t,n}function Zy(t){var n=t.curve;return t.angle=t.x,delete t.x,t.radius=t.y,delete t.y,t.curve=function(t){return arguments.length?n(Wy(t)):n()._curve},t}function Qy(){return Zy(Hy().curve(Gy))}function Ky(){var t=jy().curve(Gy),n=t.curve,e=t.lineX0,r=t.lineX1,i=t.lineY0,o=t.lineY1;return t.angle=t.x,delete t.x,t.startAngle=t.x0,delete t.x0,t.endAngle=t.x1,delete t.x1,t.radius=t.y,delete t.y,t.innerRadius=t.y0,delete t.y0,t.outerRadius=t.y1,delete t.y1,t.lineStartAngle=function(){return Zy(e())},delete t.lineX0,t.lineEndAngle=function(){return Zy(r())},delete t.lineX1,t.lineInnerRadius=function(){return Zy(i())},delete t.lineY0,t.lineOuterRadius=function(){return Zy(o())},delete t.lineY1,t.curve=function(t){return arguments.length?n(Wy(t)):n()._curve},t}function Jy(t,n){return[(n=+n)*Math.cos(t-=Math.PI/2),n*Math.sin(t)]}$y.prototype={areaStart:function(){this._curve.areaStart()},areaEnd:function(){this._curve.areaEnd()},lineStart:function(){this._curve.lineStart()},lineEnd:function(){this._curve.lineEnd()},point:function(t,n){this._curve.point(n*Math.sin(t),n*-Math.cos(t))}};var t_=Array.prototype.slice;function n_(t){return t.source}function e_(t){return t.target}function r_(t){var n=n_,e=e_,r=Yy,i=Iy,o=null;function a(){var a,u=t_.call(arguments),c=n.apply(this,u),f=e.apply(this,u);if(o||(o=a=no()),t(o,+r.apply(this,(u[0]=c,u)),+i.apply(this,u),+r.apply(this,(u[0]=f,u)),+i.apply(this,u)),a)return o=null,a+""||null}return a.source=function(t){return arguments.length?(n=t,a):n},a.target=function(t){return arguments.length?(e=t,a):e},a.x=function(t){return arguments.length?(r="function"==typeof t?t:my(+t),a):r},a.y=function(t){return arguments.length?(i="function"==typeof t?t:my(+t),a):i},a.context=function(t){return arguments.length?(o=null==t?null:t,a):o},a}function i_(t,n,e,r,i){t.moveTo(n,e),t.bezierCurveTo(n=(n+r)/2,e,n,i,r,i)}function o_(t,n,e,r,i){t.moveTo(n,e),t.bezierCurveTo(n,e=(e+i)/2,r,e,r,i)}function a_(t,n,e,r,i){var o=Jy(n,e),a=Jy(n,e=(e+i)/2),u=Jy(r,e),c=Jy(r,i);t.moveTo(o[0],o[1]),t.bezierCurveTo(a[0],a[1],u[0],u[1],c[0],c[1])}var u_={draw:function(t,n){var e=Math.sqrt(n/Ey);t.moveTo(e,0),t.arc(0,0,e,0,Py)}},c_={draw:function(t,n){var e=Math.sqrt(n/5)/2;t.moveTo(-3*e,-e),t.lineTo(-e,-e),t.lineTo(-e,-3*e),t.lineTo(e,-3*e),t.lineTo(e,-e),t.lineTo(3*e,-e),t.lineTo(3*e,e),t.lineTo(e,e),t.lineTo(e,3*e),t.lineTo(-e,3*e),t.lineTo(-e,e),t.lineTo(-3*e,e),t.closePath()}},f_=Math.sqrt(1/3),s_=2*f_,l_={draw:function(t,n){var e=Math.sqrt(n/s_),r=e*f_;t.moveTo(0,-e),t.lineTo(r,0),t.lineTo(0,e),t.lineTo(-r,0),t.closePath()}},h_=Math.sin(Ey/10)/Math.sin(7*Ey/10),d_=Math.sin(Py/10)*h_,p_=-Math.cos(Py/10)*h_,v_={draw:function(t,n){var e=Math.sqrt(.8908130915292852*n),r=d_*e,i=p_*e;t.moveTo(0,-e),t.lineTo(r,i);for(var o=1;o<5;++o){var a=Py*o/5,u=Math.cos(a),c=Math.sin(a);t.lineTo(c*e,-u*e),t.lineTo(u*r-c*i,c*r+u*i)}t.closePath()}},g_={draw:function(t,n){var e=Math.sqrt(n),r=-e/2;t.rect(r,r,e,e)}},y_=Math.sqrt(3),__={draw:function(t,n){var e=-Math.sqrt(n/(3*y_));t.moveTo(0,2*e),t.lineTo(-y_*e,-e),t.lineTo(y_*e,-e),t.closePath()}},b_=Math.sqrt(3)/2,m_=1/Math.sqrt(12),x_=3*(m_/2+1),w_={draw:function(t,n){var e=Math.sqrt(n/x_),r=e/2,i=e*m_,o=r,a=e*m_+e,u=-o,c=a;t.moveTo(r,i),t.lineTo(o,a),t.lineTo(u,c),t.lineTo(-.5*r-b_*i,b_*r+-.5*i),t.lineTo(-.5*o-b_*a,b_*o+-.5*a),t.lineTo(-.5*u-b_*c,b_*u+-.5*c),t.lineTo(-.5*r+b_*i,-.5*i-b_*r),t.lineTo(-.5*o+b_*a,-.5*a-b_*o),t.lineTo(-.5*u+b_*c,-.5*c-b_*u),t.closePath()}},M_=[u_,c_,l_,g_,v_,__,w_];function N_(){}function T_(t,n,e){t._context.bezierCurveTo((2*t._x0+t._x1)/3,(2*t._y0+t._y1)/3,(t._x0+2*t._x1)/3,(t._y0+2*t._y1)/3,(t._x0+4*t._x1+n)/6,(t._y0+4*t._y1+e)/6)}function A_(t){this._context=t}function S_(t){this._context=t}function k_(t){this._context=t}function E_(t,n){this._basis=new A_(t),this._beta=n}A_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){switch(this._point){case 3:T_(this,this._x1,this._y1);case 2:this._context.lineTo(this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;break;case 2:this._point=3,this._context.lineTo((5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6);default:T_(this,t,n)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n}},S_.prototype={areaStart:N_,areaEnd:N_,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._y0=this._y1=this._y2=this._y3=this._y4=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x2,this._y2),this._context.closePath();break;case 2:this._context.moveTo((this._x2+2*this._x3)/3,(this._y2+2*this._y3)/3),this._context.lineTo((this._x3+2*this._x2)/3,(this._y3+2*this._y2)/3),this._context.closePath();break;case 3:this.point(this._x2,this._y2),this.point(this._x3,this._y3),this.point(this._x4,this._y4)}},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._x2=t,this._y2=n;break;case 1:this._point=2,this._x3=t,this._y3=n;break;case 2:this._point=3,this._x4=t,this._y4=n,this._context.moveTo((this._x0+4*this._x1+t)/6,(this._y0+4*this._y1+n)/6);break;default:T_(this,t,n)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n}},k_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3;var e=(this._x0+4*this._x1+t)/6,r=(this._y0+4*this._y1+n)/6;this._line?this._context.lineTo(e,r):this._context.moveTo(e,r);break;case 3:this._point=4;default:T_(this,t,n)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n}},E_.prototype={lineStart:function(){this._x=[],this._y=[],this._basis.lineStart()},lineEnd:function(){var t=this._x,n=this._y,e=t.length-1;if(e>0)for(var r,i=t[0],o=n[0],a=t[e]-i,u=n[e]-o,c=-1;++c<=e;)r=c/e,this._basis.point(this._beta*t[c]+(1-this._beta)*(i+r*a),this._beta*n[c]+(1-this._beta)*(o+r*u));this._x=this._y=null,this._basis.lineEnd()},point:function(t,n){this._x.push(+t),this._y.push(+n)}};var C_=function t(n){function e(t){return 1===n?new A_(t):new E_(t,n)}return e.beta=function(n){return t(+n)},e}(.85);function P_(t,n,e){t._context.bezierCurveTo(t._x1+t._k*(t._x2-t._x0),t._y1+t._k*(t._y2-t._y0),t._x2+t._k*(t._x1-n),t._y2+t._k*(t._y1-e),t._x2,t._y2)}function z_(t,n){this._context=t,this._k=(1-n)/6}z_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:P_(this,this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2,this._x1=t,this._y1=n;break;case 2:this._point=3;default:P_(this,t,n)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var R_=function t(n){function e(t){return new z_(t,n)}return e.tension=function(n){return t(+n)},e}(0);function D_(t,n){this._context=t,this._k=(1-n)/6}D_.prototype={areaStart:N_,areaEnd:N_,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x3,this._y3),this._context.closePath();break;case 2:this._context.lineTo(this._x3,this._y3),this._context.closePath();break;case 3:this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5)}},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._x3=t,this._y3=n;break;case 1:this._point=2,this._context.moveTo(this._x4=t,this._y4=n);break;case 2:this._point=3,this._x5=t,this._y5=n;break;default:P_(this,t,n)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var q_=function t(n){function e(t){return new D_(t,n)}return e.tension=function(n){return t(+n)},e}(0);function L_(t,n){this._context=t,this._k=(1-n)/6}L_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:P_(this,t,n)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var U_=function t(n){function e(t){return new L_(t,n)}return e.tension=function(n){return t(+n)},e}(0);function O_(t,n,e){var r=t._x1,i=t._y1,o=t._x2,a=t._y2;if(t._l01_a>ky){var u=2*t._l01_2a+3*t._l01_a*t._l12_a+t._l12_2a,c=3*t._l01_a*(t._l01_a+t._l12_a);r=(r*u-t._x0*t._l12_2a+t._x2*t._l01_2a)/c,i=(i*u-t._y0*t._l12_2a+t._y2*t._l01_2a)/c}if(t._l23_a>ky){var f=2*t._l23_2a+3*t._l23_a*t._l12_a+t._l12_2a,s=3*t._l23_a*(t._l23_a+t._l12_a);o=(o*f+t._x1*t._l23_2a-n*t._l12_2a)/s,a=(a*f+t._y1*t._l23_2a-e*t._l12_2a)/s}t._context.bezierCurveTo(r,i,o,a,t._x2,t._y2)}function B_(t,n){this._context=t,this._alpha=n}B_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:this.point(this._x2,this._y2)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){if(t=+t,n=+n,this._point){var e=this._x2-t,r=this._y2-n;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(e*e+r*r,this._alpha))}switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;break;case 2:this._point=3;default:O_(this,t,n)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var F_=function t(n){function e(t){return n?new B_(t,n):new z_(t,0)}return e.alpha=function(n){return t(+n)},e}(.5);function Y_(t,n){this._context=t,this._alpha=n}Y_.prototype={areaStart:N_,areaEnd:N_,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x3,this._y3),this._context.closePath();break;case 2:this._context.lineTo(this._x3,this._y3),this._context.closePath();break;case 3:this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5)}},point:function(t,n){if(t=+t,n=+n,this._point){var e=this._x2-t,r=this._y2-n;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(e*e+r*r,this._alpha))}switch(this._point){case 0:this._point=1,this._x3=t,this._y3=n;break;case 1:this._point=2,this._context.moveTo(this._x4=t,this._y4=n);break;case 2:this._point=3,this._x5=t,this._y5=n;break;default:O_(this,t,n)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var I_=function t(n){function e(t){return n?new Y_(t,n):new D_(t,0)}return e.alpha=function(n){return t(+n)},e}(.5);function H_(t,n){this._context=t,this._alpha=n}H_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){if(t=+t,n=+n,this._point){var e=this._x2-t,r=this._y2-n;this._l23_a=Math.sqrt(this._l23_2a=Math.pow(e*e+r*r,this._alpha))}switch(this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:O_(this,t,n)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=n}};var j_=function t(n){function e(t){return n?new H_(t,n):new L_(t,0)}return e.alpha=function(n){return t(+n)},e}(.5);function X_(t){this._context=t}function V_(t){return t<0?-1:1}function G_(t,n,e){var r=t._x1-t._x0,i=n-t._x1,o=(t._y1-t._y0)/(r||i<0&&-0),a=(e-t._y1)/(i||r<0&&-0),u=(o*i+a*r)/(r+i);return(V_(o)+V_(a))*Math.min(Math.abs(o),Math.abs(a),.5*Math.abs(u))||0}function $_(t,n){var e=t._x1-t._x0;return e?(3*(t._y1-t._y0)/e-n)/2:n}function W_(t,n,e){var r=t._x0,i=t._y0,o=t._x1,a=t._y1,u=(o-r)/3;t._context.bezierCurveTo(r+u,i+u*n,o-u,a-u*e,o,a)}function Z_(t){this._context=t}function Q_(t){this._context=new K_(t)}function K_(t){this._context=t}function J_(t){this._context=t}function tb(t){var n,e,r=t.length-1,i=new Array(r),o=new Array(r),a=new Array(r);for(i[0]=0,o[0]=2,a[0]=t[0]+2*t[1],n=1;n<r-1;++n)i[n]=1,o[n]=4,a[n]=4*t[n]+2*t[n+1];for(i[r-1]=2,o[r-1]=7,a[r-1]=8*t[r-1]+t[r],n=1;n<r;++n)e=i[n]/o[n-1],o[n]-=e,a[n]-=e*a[n-1];for(i[r-1]=a[r-1]/o[r-1],n=r-2;n>=0;--n)i[n]=(a[n]-i[n+1])/o[n];for(o[r-1]=(t[r]+i[r-1])/2,n=0;n<r-1;++n)o[n]=2*t[n+1]-i[n+1];return[i,o]}function nb(t,n){this._context=t,this._t=n}function eb(t,n){if((i=t.length)>1)for(var e,r,i,o=1,a=t[n[0]],u=a.length;o<i;++o)for(r=a,a=t[n[o]],e=0;e<u;++e)a[e][1]+=a[e][0]=isNaN(r[e][1])?r[e][0]:r[e][1]}function rb(t){for(var n=t.length,e=new Array(n);--n>=0;)e[n]=n;return e}function ib(t,n){return t[n]}function ob(t){var n=t.map(ab);return rb(t).sort(function(t,e){return n[t]-n[e]})}function ab(t){for(var n,e=-1,r=0,i=t.length,o=-1/0;++e<i;)(n=+t[e][1])>o&&(o=n,r=e);return r}function ub(t){var n=t.map(cb);return rb(t).sort(function(t,e){return n[t]-n[e]})}function cb(t){for(var n,e=0,r=-1,i=t.length;++r<i;)(n=+t[r][1])&&(e+=n);return e}function fb(t){return function(){return t}}function sb(t){return t[0]}function lb(t){return t[1]}function hb(){this._=null}function db(t){t.U=t.C=t.L=t.R=t.P=t.N=null}function pb(t,n){var e=n,r=n.R,i=e.U;i?i.L===e?i.L=r:i.R=r:t._=r,r.U=i,e.U=r,e.R=r.L,e.R&&(e.R.U=e),r.L=e}function vb(t,n){var e=n,r=n.L,i=e.U;i?i.L===e?i.L=r:i.R=r:t._=r,r.U=i,e.U=r,e.L=r.R,e.L&&(e.L.U=e),r.R=e}function gb(t){for(;t.L;)t=t.L;return t}function yb(t,n,e,r){var i=[null,null],o=Yb.push(i)-1;return i.left=t,i.right=n,e&&bb(i,t,n,e),r&&bb(i,n,t,r),Bb[t.index].halfedges.push(o),Bb[n.index].halfedges.push(o),i}function _b(t,n,e){var r=[n,e];return r.left=t,r}function bb(t,n,e,r){t[0]||t[1]?t.left===e?t[1]=r:t[0]=r:(t[0]=r,t.left=n,t.right=e)}function mb(t,n,e,r,i){var o,a=t[0],u=t[1],c=a[0],f=a[1],s=0,l=1,h=u[0]-c,d=u[1]-f;if(o=n-c,h||!(o>0)){if(o/=h,h<0){if(o<s)return;o<l&&(l=o)}else if(h>0){if(o>l)return;o>s&&(s=o)}if(o=r-c,h||!(o<0)){if(o/=h,h<0){if(o>l)return;o>s&&(s=o)}else if(h>0){if(o<s)return;o<l&&(l=o)}if(o=e-f,d||!(o>0)){if(o/=d,d<0){if(o<s)return;o<l&&(l=o)}else if(d>0){if(o>l)return;o>s&&(s=o)}if(o=i-f,d||!(o<0)){if(o/=d,d<0){if(o>l)return;o>s&&(s=o)}else if(d>0){if(o<s)return;o<l&&(l=o)}return!(s>0||l<1)||(s>0&&(t[0]=[c+s*h,f+s*d]),l<1&&(t[1]=[c+l*h,f+l*d]),!0)}}}}}function xb(t,n,e,r,i){var o=t[1];if(o)return!0;var a,u,c=t[0],f=t.left,s=t.right,l=f[0],h=f[1],d=s[0],p=s[1],v=(l+d)/2,g=(h+p)/2;if(p===h){if(v<n||v>=r)return;if(l>d){if(c){if(c[1]>=i)return}else c=[v,e];o=[v,i]}else{if(c){if(c[1]<e)return}else c=[v,i];o=[v,e]}}else if(u=g-(a=(l-d)/(p-h))*v,a<-1||a>1)if(l>d){if(c){if(c[1]>=i)return}else c=[(e-u)/a,e];o=[(i-u)/a,i]}else{if(c){if(c[1]<e)return}else c=[(i-u)/a,i];o=[(e-u)/a,e]}else if(h<p){if(c){if(c[0]>=r)return}else c=[n,a*n+u];o=[r,a*r+u]}else{if(c){if(c[0]<n)return}else c=[r,a*r+u];o=[n,a*n+u]}return t[0]=c,t[1]=o,!0}function wb(t,n){var e=t.site,r=n.left,i=n.right;return e===i&&(i=r,r=e),i?Math.atan2(i[1]-r[1],i[0]-r[0]):(e===r?(r=n[1],i=n[0]):(r=n[0],i=n[1]),Math.atan2(r[0]-i[0],i[1]-r[1]))}function Mb(t,n){return n[+(n.left!==t.site)]}function Nb(t,n){return n[+(n.left===t.site)]}X_.prototype={areaStart:N_,areaEnd:N_,lineStart:function(){this._point=0},lineEnd:function(){this._point&&this._context.closePath()},point:function(t,n){t=+t,n=+n,this._point?this._context.lineTo(t,n):(this._point=1,this._context.moveTo(t,n))}},Z_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:W_(this,this._t0,$_(this,this._t0))}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,n){var e=NaN;if(n=+n,(t=+t)!==this._x1||n!==this._y1){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;break;case 2:this._point=3,W_(this,$_(this,e=G_(this,t,n)),e);break;default:W_(this,this._t0,e=G_(this,t,n))}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=n,this._t0=e}}},(Q_.prototype=Object.create(Z_.prototype)).point=function(t,n){Z_.prototype.point.call(this,n,t)},K_.prototype={moveTo:function(t,n){this._context.moveTo(n,t)},closePath:function(){this._context.closePath()},lineTo:function(t,n){this._context.lineTo(n,t)},bezierCurveTo:function(t,n,e,r,i,o){this._context.bezierCurveTo(n,t,r,e,o,i)}},J_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=[],this._y=[]},lineEnd:function(){var t=this._x,n=this._y,e=t.length;if(e)if(this._line?this._context.lineTo(t[0],n[0]):this._context.moveTo(t[0],n[0]),2===e)this._context.lineTo(t[1],n[1]);else for(var r=tb(t),i=tb(n),o=0,a=1;a<e;++o,++a)this._context.bezierCurveTo(r[0][o],i[0][o],r[1][o],i[1][o],t[a],n[a]);(this._line||0!==this._line&&1===e)&&this._context.closePath(),this._line=1-this._line,this._x=this._y=null},point:function(t,n){this._x.push(+t),this._y.push(+n)}},nb.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=this._y=NaN,this._point=0},lineEnd:function(){0<this._t&&this._t<1&&2===this._point&&this._context.lineTo(this._x,this._y),(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line>=0&&(this._t=1-this._t,this._line=1-this._line)},point:function(t,n){switch(t=+t,n=+n,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,n):this._context.moveTo(t,n);break;case 1:this._point=2;default:if(this._t<=0)this._context.lineTo(this._x,n),this._context.lineTo(t,n);else{var e=this._x*(1-this._t)+t*this._t;this._context.lineTo(e,this._y),this._context.lineTo(e,n)}}this._x=t,this._y=n}},hb.prototype={constructor:hb,insert:function(t,n){var e,r,i;if(t){if(n.P=t,n.N=t.N,t.N&&(t.N.P=n),t.N=n,t.R){for(t=t.R;t.L;)t=t.L;t.L=n}else t.R=n;e=t}else this._?(t=gb(this._),n.P=null,n.N=t,t.P=t.L=n,e=t):(n.P=n.N=null,this._=n,e=null);for(n.L=n.R=null,n.U=e,n.C=!0,t=n;e&&e.C;)e===(r=e.U).L?(i=r.R)&&i.C?(e.C=i.C=!1,r.C=!0,t=r):(t===e.R&&(pb(this,e),e=(t=e).U),e.C=!1,r.C=!0,vb(this,r)):(i=r.L)&&i.C?(e.C=i.C=!1,r.C=!0,t=r):(t===e.L&&(vb(this,e),e=(t=e).U),e.C=!1,r.C=!0,pb(this,r)),e=t.U;this._.C=!1},remove:function(t){t.N&&(t.N.P=t.P),t.P&&(t.P.N=t.N),t.N=t.P=null;var n,e,r,i=t.U,o=t.L,a=t.R;if(e=o?a?gb(a):o:a,i?i.L===t?i.L=e:i.R=e:this._=e,o&&a?(r=e.C,e.C=t.C,e.L=o,o.U=e,e!==a?(i=e.U,e.U=t.U,t=e.R,i.L=t,e.R=a,a.U=e):(e.U=i,i=e,t=e.R)):(r=t.C,t=e),t&&(t.U=i),!r)if(t&&t.C)t.C=!1;else{do{if(t===this._)break;if(t===i.L){if((n=i.R).C&&(n.C=!1,i.C=!0,pb(this,i),n=i.R),n.L&&n.L.C||n.R&&n.R.C){n.R&&n.R.C||(n.L.C=!1,n.C=!0,vb(this,n),n=i.R),n.C=i.C,i.C=n.R.C=!1,pb(this,i),t=this._;break}}else if((n=i.L).C&&(n.C=!1,i.C=!0,vb(this,i),n=i.L),n.L&&n.L.C||n.R&&n.R.C){n.L&&n.L.C||(n.R.C=!1,n.C=!0,pb(this,n),n=i.L),n.C=i.C,i.C=n.L.C=!1,vb(this,i),t=this._;break}n.C=!0,t=i,i=i.U}while(!t.C);t&&(t.C=!1)}}};var Tb,Ab=[];function Sb(){db(this),this.x=this.y=this.arc=this.site=this.cy=null}function kb(t){var n=t.P,e=t.N;if(n&&e){var r=n.site,i=t.site,o=e.site;if(r!==o){var a=i[0],u=i[1],c=r[0]-a,f=r[1]-u,s=o[0]-a,l=o[1]-u,h=2*(c*l-f*s);if(!(h>=-Hb)){var d=c*c+f*f,p=s*s+l*l,v=(l*d-f*p)/h,g=(c*p-s*d)/h,y=Ab.pop()||new Sb;y.arc=t,y.site=i,y.x=v+a,y.y=(y.cy=g+u)+Math.sqrt(v*v+g*g),t.circle=y;for(var _=null,b=Fb._;b;)if(y.y<b.y||y.y===b.y&&y.x<=b.x){if(!b.L){_=b.P;break}b=b.L}else{if(!b.R){_=b;break}b=b.R}Fb.insert(_,y),_||(Tb=y)}}}}function Eb(t){var n=t.circle;n&&(n.P||(Tb=n.N),Fb.remove(n),Ab.push(n),db(n),t.circle=null)}var Cb=[];function Pb(){db(this),this.edge=this.site=this.circle=null}function zb(t){var n=Cb.pop()||new Pb;return n.site=t,n}function Rb(t){Eb(t),Ob.remove(t),Cb.push(t),db(t)}function Db(t){var n=t.circle,e=n.x,r=n.cy,i=[e,r],o=t.P,a=t.N,u=[t];Rb(t);for(var c=o;c.circle&&Math.abs(e-c.circle.x)<Ib&&Math.abs(r-c.circle.cy)<Ib;)o=c.P,u.unshift(c),Rb(c),c=o;u.unshift(c),Eb(c);for(var f=a;f.circle&&Math.abs(e-f.circle.x)<Ib&&Math.abs(r-f.circle.cy)<Ib;)a=f.N,u.push(f),Rb(f),f=a;u.push(f),Eb(f);var s,l=u.length;for(s=1;s<l;++s)f=u[s],c=u[s-1],bb(f.edge,c.site,f.site,i);c=u[0],(f=u[l-1]).edge=yb(c.site,f.site,null,i),kb(c),kb(f)}function qb(t){for(var n,e,r,i,o=t[0],a=t[1],u=Ob._;u;)if((r=Lb(u,a)-o)>Ib)u=u.L;else{if(!((i=o-Ub(u,a))>Ib)){r>-Ib?(n=u.P,e=u):i>-Ib?(n=u,e=u.N):n=e=u;break}if(!u.R){n=u;break}u=u.R}!function(t){Bb[t.index]={site:t,halfedges:[]}}(t);var c=zb(t);if(Ob.insert(n,c),n||e){if(n===e)return Eb(n),e=zb(n.site),Ob.insert(c,e),c.edge=e.edge=yb(n.site,c.site),kb(n),void kb(e);if(e){Eb(n),Eb(e);var f=n.site,s=f[0],l=f[1],h=t[0]-s,d=t[1]-l,p=e.site,v=p[0]-s,g=p[1]-l,y=2*(h*g-d*v),_=h*h+d*d,b=v*v+g*g,m=[(g*_-d*b)/y+s,(h*b-v*_)/y+l];bb(e.edge,f,p,m),c.edge=yb(f,t,null,m),e.edge=yb(t,p,null,m),kb(n),kb(e)}else c.edge=yb(n.site,c.site)}}function Lb(t,n){var e=t.site,r=e[0],i=e[1],o=i-n;if(!o)return r;var a=t.P;if(!a)return-1/0;var u=(e=a.site)[0],c=e[1],f=c-n;if(!f)return u;var s=u-r,l=1/o-1/f,h=s/f;return l?(-h+Math.sqrt(h*h-2*l*(s*s/(-2*f)-c+f/2+i-o/2)))/l+r:(r+u)/2}function Ub(t,n){var e=t.N;if(e)return Lb(e,n);var r=t.site;return r[1]===n?r[0]:1/0}var Ob,Bb,Fb,Yb,Ib=1e-6,Hb=1e-12;function jb(t,n,e){return(t[0]-e[0])*(n[1]-t[1])-(t[0]-n[0])*(e[1]-t[1])}function Xb(t,n){return n[1]-t[1]||n[0]-t[0]}function Vb(t,n){var e,r,i,o=t.sort(Xb).pop();for(Yb=[],Bb=new Array(t.length),Ob=new hb,Fb=new hb;;)if(i=Tb,o&&(!i||o[1]<i.y||o[1]===i.y&&o[0]<i.x))o[0]===e&&o[1]===r||(qb(o),e=o[0],r=o[1]),o=t.pop();else{if(!i)break;Db(i.arc)}if(function(){for(var t,n,e,r,i=0,o=Bb.length;i<o;++i)if((t=Bb[i])&&(r=(n=t.halfedges).length)){var a=new Array(r),u=new Array(r);for(e=0;e<r;++e)a[e]=e,u[e]=wb(t,Yb[n[e]]);for(a.sort(function(t,n){return u[n]-u[t]}),e=0;e<r;++e)u[e]=n[a[e]];for(e=0;e<r;++e)n[e]=u[e]}}(),n){var a=+n[0][0],u=+n[0][1],c=+n[1][0],f=+n[1][1];!function(t,n,e,r){for(var i,o=Yb.length;o--;)xb(i=Yb[o],t,n,e,r)&&mb(i,t,n,e,r)&&(Math.abs(i[0][0]-i[1][0])>Ib||Math.abs(i[0][1]-i[1][1])>Ib)||delete Yb[o]}(a,u,c,f),function(t,n,e,r){var i,o,a,u,c,f,s,l,h,d,p,v,g=Bb.length,y=!0;for(i=0;i<g;++i)if(o=Bb[i]){for(a=o.site,u=(c=o.halfedges).length;u--;)Yb[c[u]]||c.splice(u,1);for(u=0,f=c.length;u<f;)p=(d=Nb(o,Yb[c[u]]))[0],v=d[1],l=(s=Mb(o,Yb[c[++u%f]]))[0],h=s[1],(Math.abs(p-l)>Ib||Math.abs(v-h)>Ib)&&(c.splice(u,0,Yb.push(_b(a,d,Math.abs(p-t)<Ib&&r-v>Ib?[t,Math.abs(l-t)<Ib?h:r]:Math.abs(v-r)<Ib&&e-p>Ib?[Math.abs(h-r)<Ib?l:e,r]:Math.abs(p-e)<Ib&&v-n>Ib?[e,Math.abs(l-e)<Ib?h:n]:Math.abs(v-n)<Ib&&p-t>Ib?[Math.abs(h-n)<Ib?l:t,n]:null))-1),++f);f&&(y=!1)}if(y){var _,b,m,x=1/0;for(i=0,y=null;i<g;++i)(o=Bb[i])&&(m=(_=(a=o.site)[0]-t)*_+(b=a[1]-n)*b)<x&&(x=m,y=o);if(y){var w=[t,n],M=[t,r],N=[e,r],T=[e,n];y.halfedges.push(Yb.push(_b(a=y.site,w,M))-1,Yb.push(_b(a,M,N))-1,Yb.push(_b(a,N,T))-1,Yb.push(_b(a,T,w))-1)}}for(i=0;i<g;++i)(o=Bb[i])&&(o.halfedges.length||delete Bb[i])}(a,u,c,f)}this.edges=Yb,this.cells=Bb,Ob=Fb=Yb=Bb=null}function Gb(t){return function(){return t}}function $b(t,n,e){this.target=t,this.type=n,this.transform=e}function Wb(t,n,e){this.k=t,this.x=n,this.y=e}Vb.prototype={constructor:Vb,polygons:function(){var t=this.edges;return this.cells.map(function(n){var e=n.halfedges.map(function(e){return Mb(n,t[e])});return e.data=n.site.data,e})},triangles:function(){var t=[],n=this.edges;return this.cells.forEach(function(e,r){if(o=(i=e.halfedges).length)for(var i,o,a,u=e.site,c=-1,f=n[i[o-1]],s=f.left===u?f.right:f.left;++c<o;)a=s,s=(f=n[i[c]]).left===u?f.right:f.left,a&&s&&r<a.index&&r<s.index&&jb(u,a,s)<0&&t.push([u.data,a.data,s.data])}),t},links:function(){return this.edges.filter(function(t){return t.right}).map(function(t){return{source:t.left.data,target:t.right.data}})},find:function(t,n,e){for(var r,i,o=this,a=o._found||0,u=o.cells.length;!(i=o.cells[a]);)if(++a>=u)return null;var c=t-i.site[0],f=n-i.site[1],s=c*c+f*f;do{i=o.cells[r=a],a=null,i.halfedges.forEach(function(e){var r=o.edges[e],u=r.left;if(u!==i.site&&u||(u=r.right)){var c=t-u[0],f=n-u[1],l=c*c+f*f;l<s&&(s=l,a=u.index)}})}while(null!==a);return o._found=r,null==e||s<=e*e?i.site:null}},Wb.prototype={constructor:Wb,scale:function(t){return 1===t?this:new Wb(this.k*t,this.x,this.y)},translate:function(t,n){return 0===t&0===n?this:new Wb(this.k,this.x+this.k*t,this.y+this.k*n)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var Zb=new Wb(1,0,0);function Qb(t){for(;!t.__zoom;)if(!(t=t.parentNode))return Zb;return t.__zoom}function Kb(){t.event.stopImmediatePropagation()}function Jb(){t.event.preventDefault(),t.event.stopImmediatePropagation()}function tm(){return!t.event.ctrlKey&&!t.event.button}function nm(){var t=this;return t instanceof SVGElement?(t=t.ownerSVGElement||t).hasAttribute("viewBox")?[[(t=t.viewBox.baseVal).x,t.y],[t.x+t.width,t.y+t.height]]:[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]:[[0,0],[t.clientWidth,t.clientHeight]]}function em(){return this.__zoom||Zb}function rm(){return-t.event.deltaY*(1===t.event.deltaMode?.05:t.event.deltaMode?1:.002)}function im(){return navigator.maxTouchPoints||"ontouchstart"in this}function om(t,n,e){var r=t.invertX(n[0][0])-e[0][0],i=t.invertX(n[1][0])-e[1][0],o=t.invertY(n[0][1])-e[0][1],a=t.invertY(n[1][1])-e[1][1];return t.translate(i>r?(r+i)/2:Math.min(0,r)||Math.max(0,i),a>o?(o+a)/2:Math.min(0,o)||Math.max(0,a))}Qb.prototype=Wb.prototype,t.FormatSpecifier=Ba,t.active=function(t,n){var e,r,i=t.__transition;if(i)for(r in n=null==n?null:n+"",i)if((e=i[r]).state>xr&&e.name===n)return new Ur([[t]],yi,n,+r);return null},t.arc=function(){var t=Ry,n=Dy,e=my(0),r=null,i=qy,o=Ly,a=Uy,u=null;function c(){var c,f,s=+t.apply(this,arguments),l=+n.apply(this,arguments),h=i.apply(this,arguments)-Cy,d=o.apply(this,arguments)-Cy,p=xy(d-h),v=d>h;if(u||(u=c=no()),l<s&&(f=l,l=s,s=f),l>ky)if(p>Py-ky)u.moveTo(l*My(h),l*Ay(h)),u.arc(0,0,l,h,d,!v),s>ky&&(u.moveTo(s*My(d),s*Ay(d)),u.arc(0,0,s,d,h,v));else{var g,y,_=h,b=d,m=h,x=d,w=p,M=p,N=a.apply(this,arguments)/2,T=N>ky&&(r?+r.apply(this,arguments):Sy(s*s+l*l)),A=Ty(xy(l-s)/2,+e.apply(this,arguments)),S=A,k=A;if(T>ky){var E=zy(T/s*Ay(N)),C=zy(T/l*Ay(N));(w-=2*E)>ky?(m+=E*=v?1:-1,x-=E):(w=0,m=x=(h+d)/2),(M-=2*C)>ky?(_+=C*=v?1:-1,b-=C):(M=0,_=b=(h+d)/2)}var P=l*My(_),z=l*Ay(_),R=s*My(x),D=s*Ay(x);if(A>ky){var q,L=l*My(b),U=l*Ay(b),O=s*My(m),B=s*Ay(m);if(p<Ey&&(q=function(t,n,e,r,i,o,a,u){var c=e-t,f=r-n,s=a-i,l=u-o,h=l*c-s*f;if(!(h*h<ky))return[t+(h=(s*(n-o)-l*(t-i))/h)*c,n+h*f]}(P,z,O,B,L,U,R,D))){var F=P-q[0],Y=z-q[1],I=L-q[0],H=U-q[1],j=1/Ay(function(t){return t>1?0:t<-1?Ey:Math.acos(t)}((F*I+Y*H)/(Sy(F*F+Y*Y)*Sy(I*I+H*H)))/2),X=Sy(q[0]*q[0]+q[1]*q[1]);S=Ty(A,(s-X)/(j-1)),k=Ty(A,(l-X)/(j+1))}}M>ky?k>ky?(g=Oy(O,B,P,z,l,k,v),y=Oy(L,U,R,D,l,k,v),u.moveTo(g.cx+g.x01,g.cy+g.y01),k<A?u.arc(g.cx,g.cy,k,wy(g.y01,g.x01),wy(y.y01,y.x01),!v):(u.arc(g.cx,g.cy,k,wy(g.y01,g.x01),wy(g.y11,g.x11),!v),u.arc(0,0,l,wy(g.cy+g.y11,g.cx+g.x11),wy(y.cy+y.y11,y.cx+y.x11),!v),u.arc(y.cx,y.cy,k,wy(y.y11,y.x11),wy(y.y01,y.x01),!v))):(u.moveTo(P,z),u.arc(0,0,l,_,b,!v)):u.moveTo(P,z),s>ky&&w>ky?S>ky?(g=Oy(R,D,L,U,s,-S,v),y=Oy(P,z,O,B,s,-S,v),u.lineTo(g.cx+g.x01,g.cy+g.y01),S<A?u.arc(g.cx,g.cy,S,wy(g.y01,g.x01),wy(y.y01,y.x01),!v):(u.arc(g.cx,g.cy,S,wy(g.y01,g.x01),wy(g.y11,g.x11),!v),u.arc(0,0,s,wy(g.cy+g.y11,g.cx+g.x11),wy(y.cy+y.y11,y.cx+y.x11),v),u.arc(y.cx,y.cy,S,wy(y.y11,y.x11),wy(y.y01,y.x01),!v))):u.arc(0,0,s,x,m,v):u.lineTo(R,D)}else u.moveTo(0,0);if(u.closePath(),c)return u=null,c+""||null}return c.centroid=function(){var e=(+t.apply(this,arguments)+ +n.apply(this,arguments))/2,r=(+i.apply(this,arguments)+ +o.apply(this,arguments))/2-Ey/2;return[My(r)*e,Ay(r)*e]},c.innerRadius=function(n){return arguments.length?(t="function"==typeof n?n:my(+n),c):t},c.outerRadius=function(t){return arguments.length?(n="function"==typeof t?t:my(+t),c):n},c.cornerRadius=function(t){return arguments.length?(e="function"==typeof t?t:my(+t),c):e},c.padRadius=function(t){return arguments.length?(r=null==t?null:"function"==typeof t?t:my(+t),c):r},c.startAngle=function(t){return arguments.length?(i="function"==typeof t?t:my(+t),c):i},c.endAngle=function(t){return arguments.length?(o="function"==typeof t?t:my(+t),c):o},c.padAngle=function(t){return arguments.length?(a="function"==typeof t?t:my(+t),c):a},c.context=function(t){return arguments.length?(u=null==t?null:t,c):u},c},t.area=jy,t.areaRadial=Ky,t.ascending=n,t.autoType=function(t){for(var n in t){var e,r,i=t[n].trim();if(i)if("true"===i)i=!0;else if("false"===i)i=!1;else if("NaN"===i)i=NaN;else if(isNaN(e=+i)){if(!(r=i.match(/^([-+]\d{2})?\d{4}(-\d{2}(-\d{2})?)?(T\d{2}:\d{2}(:\d{2}(\.\d{3})?)?(Z|[-+]\d{2}:\d{2})?)?$/)))continue;ra&&r[4]&&!r[7]&&(i=i.replace(/-/g,"/").replace(/T/," ")),i=new Date(i)}else i=e;else i=null;t[n]=i}return t},t.axisBottom=function(t){return F(D,t)},t.axisLeft=function(t){return F(q,t)},t.axisRight=function(t){return F(R,t)},t.axisTop=function(t){return F(z,t)},t.bisect=i,t.bisectLeft=o,t.bisectRight=i,t.bisector=e,t.blob=function(t,n){return fetch(t,n).then(ia)},t.brush=function(){return Yi(Ci)},t.brushSelection=function(t){var n=t.__brush;return n?n.dim.output(n.selection):null},t.brushX=function(){return Yi(ki)},t.brushY=function(){return Yi(Ei)},t.buffer=function(t,n){return fetch(t,n).then(oa)},t.chord=function(){var t=0,n=null,e=null,r=null;function i(i){var o,a,u,c,f,s,l=i.length,h=[],d=g(l),p=[],v=[],y=v.groups=new Array(l),_=new Array(l*l);for(o=0,f=-1;++f<l;){for(a=0,s=-1;++s<l;)a+=i[f][s];h.push(a),p.push(g(l)),o+=a}for(n&&d.sort(function(t,e){return n(h[t],h[e])}),e&&p.forEach(function(t,n){t.sort(function(t,r){return e(i[n][t],i[n][r])})}),c=(o=Gi(0,Vi-t*l)/o)?t:Vi/l,a=0,f=-1;++f<l;){for(u=a,s=-1;++s<l;){var b=d[f],m=p[b][s],x=i[b][m],w=a,M=a+=x*o;_[m*l+b]={index:b,subindex:m,startAngle:w,endAngle:M,value:x}}y[b]={index:b,startAngle:u,endAngle:a,value:h[b]},a+=c}for(f=-1;++f<l;)for(s=f-1;++s<l;){var N=_[s*l+f],T=_[f*l+s];(N.value||T.value)&&v.push(N.value<T.value?{source:T,target:N}:{source:N,target:T})}return r?v.sort(r):v}return i.padAngle=function(n){return arguments.length?(t=Gi(0,n),i):t},i.sortGroups=function(t){return arguments.length?(n=t,i):n},i.sortSubgroups=function(t){return arguments.length?(e=t,i):e},i.sortChords=function(t){return arguments.length?(null==t?r=null:(r=$i(t))._=t,i):r&&r._},i},t.clientPoint=Ot,t.cluster=function(){var t=Nl,n=1,e=1,r=!1;function i(i){var o,a=0;i.eachAfter(function(n){var e=n.children;e?(n.x=function(t){return t.reduce(Tl,0)/t.length}(e),n.y=function(t){return 1+t.reduce(Al,0)}(e)):(n.x=o?a+=t(n,o):0,n.y=0,o=n)});var u=function(t){for(var n;n=t.children;)t=n[0];return t}(i),c=function(t){for(var n;n=t.children;)t=n[n.length-1];return t}(i),f=u.x-t(u,c)/2,s=c.x+t(c,u)/2;return i.eachAfter(r?function(t){t.x=(t.x-i.x)*n,t.y=(i.y-t.y)*e}:function(t){t.x=(t.x-f)/(s-f)*n,t.y=(1-(i.y?t.y/i.y:1))*e})}return i.separation=function(n){return arguments.length?(t=n,i):t},i.size=function(t){return arguments.length?(r=!1,n=+t[0],e=+t[1],i):r?null:[n,e]},i.nodeSize=function(t){return arguments.length?(r=!0,n=+t[0],e=+t[1],i):r?[n,e]:null},i},t.color=pn,t.contourDensity=function(){var t=ko,n=Eo,e=Co,r=960,i=500,o=20,a=2,u=3*o,c=r+2*u>>a,f=i+2*u>>a,s=bo(20);function l(r){var i=new Float32Array(c*f),l=new Float32Array(c*f);r.forEach(function(r,o,s){var l=+t(r,o,s)+u>>a,h=+n(r,o,s)+u>>a,d=+e(r,o,s);l>=0&&l<c&&h>=0&&h<f&&(i[l+h*c]+=d)}),Ao({width:c,height:f,data:i},{width:c,height:f,data:l},o>>a),So({width:c,height:f,data:l},{width:c,height:f,data:i},o>>a),Ao({width:c,height:f,data:i},{width:c,height:f,data:l},o>>a),So({width:c,height:f,data:l},{width:c,height:f,data:i},o>>a),Ao({width:c,height:f,data:i},{width:c,height:f,data:l},o>>a),So({width:c,height:f,data:l},{width:c,height:f,data:i},o>>a);var d=s(i);if(!Array.isArray(d)){var p=T(i);d=w(0,p,d),(d=g(0,Math.floor(p/d)*d,d)).shift()}return To().thresholds(d).size([c,f])(i).map(h)}function h(t){return t.value*=Math.pow(2,-2*a),t.coordinates.forEach(d),t}function d(t){t.forEach(p)}function p(t){t.forEach(v)}function v(t){t[0]=t[0]*Math.pow(2,a)-u,t[1]=t[1]*Math.pow(2,a)-u}function y(){return c=r+2*(u=3*o)>>a,f=i+2*u>>a,l}return l.x=function(n){return arguments.length?(t="function"==typeof n?n:bo(+n),l):t},l.y=function(t){return arguments.length?(n="function"==typeof t?t:bo(+t),l):n},l.weight=function(t){return arguments.length?(e="function"==typeof t?t:bo(+t),l):e},l.size=function(t){if(!arguments.length)return[r,i];var n=Math.ceil(t[0]),e=Math.ceil(t[1]);if(!(n>=0||n>=0))throw new Error("invalid size");return r=n,i=e,y()},l.cellSize=function(t){if(!arguments.length)return 1<<a;if(!((t=+t)>=1))throw new Error("invalid cell size");return a=Math.floor(Math.log(t)/Math.LN2),y()},l.thresholds=function(t){return arguments.length?(s="function"==typeof t?t:Array.isArray(t)?bo(yo.call(t)):bo(t),l):s},l.bandwidth=function(t){if(!arguments.length)return Math.sqrt(o*(o+1));if(!((t=+t)>=0))throw new Error("invalid bandwidth");return o=Math.round((Math.sqrt(4*t*t+1)-1)/2),y()},l},t.contours=To,t.create=function(t){return Rt(Z(t).call(document.documentElement))},t.creator=Z,t.cross=function(t,n,e){var r,i,o,u,c=t.length,f=n.length,s=new Array(c*f);for(null==e&&(e=a),r=o=0;r<c;++r)for(u=t[r],i=0;i<f;++i,++o)s[o]=e(u,n[i]);return s},t.csv=fa,t.csvFormat=jo,t.csvFormatBody=Xo,t.csvFormatRow=Go,t.csvFormatRows=Vo,t.csvFormatValue=$o,t.csvParse=Io,t.csvParseRows=Ho,t.cubehelix=ee,t.curveBasis=function(t){return new A_(t)},t.curveBasisClosed=function(t){return new S_(t)},t.curveBasisOpen=function(t){return new k_(t)},t.curveBundle=C_,t.curveCardinal=R_,t.curveCardinalClosed=q_,t.curveCardinalOpen=U_,t.curveCatmullRom=F_,t.curveCatmullRomClosed=I_,t.curveCatmullRomOpen=j_,t.curveLinear=Fy,t.curveLinearClosed=function(t){return new X_(t)},t.curveMonotoneX=function(t){return new Z_(t)},t.curveMonotoneY=function(t){return new Q_(t)},t.curveNatural=function(t){return new J_(t)},t.curveStep=function(t){return new nb(t,.5)},t.curveStepAfter=function(t){return new nb(t,1)},t.curveStepBefore=function(t){return new nb(t,0)},t.customEvent=kt,t.descending=function(t,n){return n<t?-1:n>t?1:n>=t?0:NaN},t.deviation=f,t.dispatch=I,t.drag=function(){var n,e,r,i,o=Gt,a=$t,u=Wt,c=Zt,f={},s=I("start","drag","end"),l=0,h=0;function d(t){t.on("mousedown.drag",p).filter(c).on("touchstart.drag",y).on("touchmove.drag",_).on("touchend.drag touchcancel.drag",b).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function p(){if(!i&&o.apply(this,arguments)){var u=m("mouse",a.apply(this,arguments),Bt,this,arguments);u&&(Rt(t.event.view).on("mousemove.drag",v,!0).on("mouseup.drag",g,!0),Ht(t.event.view),Yt(),r=!1,n=t.event.clientX,e=t.event.clientY,u("start"))}}function v(){if(It(),!r){var i=t.event.clientX-n,o=t.event.clientY-e;r=i*i+o*o>h}f.mouse("drag")}function g(){Rt(t.event.view).on("mousemove.drag mouseup.drag",null),jt(t.event.view,r),It(),f.mouse("end")}function y(){if(o.apply(this,arguments)){var n,e,r=t.event.changedTouches,i=a.apply(this,arguments),u=r.length;for(n=0;n<u;++n)(e=m(r[n].identifier,i,Ft,this,arguments))&&(Yt(),e("start"))}}function _(){var n,e,r=t.event.changedTouches,i=r.length;for(n=0;n<i;++n)(e=f[r[n].identifier])&&(It(),e("drag"))}function b(){var n,e,r=t.event.changedTouches,o=r.length;for(i&&clearTimeout(i),i=setTimeout(function(){i=null},500),n=0;n<o;++n)(e=f[r[n].identifier])&&(Yt(),e("end"))}function m(n,e,r,i,o){var a,c,h,p=r(e,n),v=s.copy();if(kt(new Vt(d,"beforestart",a,n,l,p[0],p[1],0,0,v),function(){return null!=(t.event.subject=a=u.apply(i,o))&&(c=a.x-p[0]||0,h=a.y-p[1]||0,!0)}))return function t(u){var s,g=p;switch(u){case"start":f[n]=t,s=l++;break;case"end":delete f[n],--l;case"drag":p=r(e,n),s=l}kt(new Vt(d,u,a,n,s,p[0]+c,p[1]+h,p[0]-g[0],p[1]-g[1],v),v.apply,v,[u,i,o])}}return d.filter=function(t){return arguments.length?(o="function"==typeof t?t:Xt(!!t),d):o},d.container=function(t){return arguments.length?(a="function"==typeof t?t:Xt(t),d):a},d.subject=function(t){return arguments.length?(u="function"==typeof t?t:Xt(t),d):u},d.touchable=function(t){return arguments.length?(c="function"==typeof t?t:Xt(!!t),d):c},d.on=function(){var t=s.on.apply(s,arguments);return t===s?d:t},d.clickDistance=function(t){return arguments.length?(h=(t=+t)*t,d):Math.sqrt(h)},d},t.dragDisable=Ht,t.dragEnable=jt,t.dsv=function(t,n,e,r){3===arguments.length&&"function"==typeof e&&(r=e,e=void 0);var i=Fo(t);return ua(n,e).then(function(t){return i.parse(t,r)})},t.dsvFormat=Fo,t.easeBack=si,t.easeBackIn=ci,t.easeBackInOut=si,t.easeBackOut=fi,t.easeBounce=ui,t.easeBounceIn=function(t){return 1-ui(1-t)},t.easeBounceInOut=function(t){return((t*=2)<=1?1-ui(1-t):ui(t-1)+1)/2},t.easeBounceOut=ui,t.easeCircle=Zr,t.easeCircleIn=function(t){return 1-Math.sqrt(1-t*t)},t.easeCircleInOut=Zr,t.easeCircleOut=function(t){return Math.sqrt(1- --t*t)},t.easeCubic=Ir,t.easeCubicIn=function(t){return t*t*t},t.easeCubicInOut=Ir,t.easeCubicOut=function(t){return--t*t*t+1},t.easeElastic=di,t.easeElasticIn=hi,t.easeElasticInOut=pi,t.easeElasticOut=di,t.easeExp=Wr,t.easeExpIn=function(t){return Math.pow(2,10*t-10)},t.easeExpInOut=Wr,t.easeExpOut=function(t){return 1-Math.pow(2,-10*t)},t.easeLinear=function(t){return+t},t.easePoly=Xr,t.easePolyIn=Hr,t.easePolyInOut=Xr,t.easePolyOut=jr,t.easeQuad=Yr,t.easeQuadIn=function(t){return t*t},t.easeQuadInOut=Yr,t.easeQuadOut=function(t){return t*(2-t)},t.easeSin=$r,t.easeSinIn=function(t){return 1-Math.cos(t*Gr)},t.easeSinInOut=$r,t.easeSinOut=function(t){return Math.sin(t*Gr)},t.entries=function(t){var n=[];for(var e in t)n.push({key:e,value:t[e]});return n},t.extent=s,t.forceCenter=function(t,n){var e;function r(){var r,i,o=e.length,a=0,u=0;for(r=0;r<o;++r)a+=(i=e[r]).x,u+=i.y;for(a=a/o-t,u=u/o-n,r=0;r<o;++r)(i=e[r]).x-=a,i.y-=u}return null==t&&(t=0),null==n&&(n=0),r.initialize=function(t){e=t},r.x=function(n){return arguments.length?(t=+n,r):t},r.y=function(t){return arguments.length?(n=+t,r):n},r},t.forceCollide=function(t){var n,e,r=1,i=1;function o(){for(var t,o,u,c,f,s,l,h=n.length,d=0;d<i;++d)for(o=wa(n,Aa,Sa).visitAfter(a),t=0;t<h;++t)u=n[t],s=e[u.index],l=s*s,c=u.x+u.vx,f=u.y+u.vy,o.visit(p);function p(t,n,e,i,o){var a=t.data,h=t.r,d=s+h;if(!a)return n>c+d||i<c-d||e>f+d||o<f-d;if(a.index>u.index){var p=c-a.x-a.vx,v=f-a.y-a.vy,g=p*p+v*v;g<d*d&&(0===p&&(g+=(p=ya())*p),0===v&&(g+=(v=ya())*v),g=(d-(g=Math.sqrt(g)))/g*r,u.vx+=(p*=g)*(d=(h*=h)/(l+h)),u.vy+=(v*=g)*d,a.vx-=p*(d=1-d),a.vy-=v*d)}}}function a(t){if(t.data)return t.r=e[t.data.index];for(var n=t.r=0;n<4;++n)t[n]&&t[n].r>t.r&&(t.r=t[n].r)}function u(){if(n){var r,i,o=n.length;for(e=new Array(o),r=0;r<o;++r)i=n[r],e[i.index]=+t(i,r,n)}}return"function"!=typeof t&&(t=ga(null==t?1:+t)),o.initialize=function(t){n=t,u()},o.iterations=function(t){return arguments.length?(i=+t,o):i},o.strength=function(t){return arguments.length?(r=+t,o):r},o.radius=function(n){return arguments.length?(t="function"==typeof n?n:ga(+n),u(),o):t},o},t.forceLink=function(t){var n,e,r,i,o,a=ka,u=function(t){return 1/Math.min(i[t.source.index],i[t.target.index])},c=ga(30),f=1;function s(r){for(var i=0,a=t.length;i<f;++i)for(var u,c,s,l,h,d,p,v=0;v<a;++v)c=(u=t[v]).source,l=(s=u.target).x+s.vx-c.x-c.vx||ya(),h=s.y+s.vy-c.y-c.vy||ya(),l*=d=((d=Math.sqrt(l*l+h*h))-e[v])/d*r*n[v],h*=d,s.vx-=l*(p=o[v]),s.vy-=h*p,c.vx+=l*(p=1-p),c.vy+=h*p}function l(){if(r){var u,c,f=r.length,s=t.length,l=co(r,a);for(u=0,i=new Array(f);u<s;++u)(c=t[u]).index=u,"object"!=typeof c.source&&(c.source=Ea(l,c.source)),"object"!=typeof c.target&&(c.target=Ea(l,c.target)),i[c.source.index]=(i[c.source.index]||0)+1,i[c.target.index]=(i[c.target.index]||0)+1;for(u=0,o=new Array(s);u<s;++u)c=t[u],o[u]=i[c.source.index]/(i[c.source.index]+i[c.target.index]);n=new Array(s),h(),e=new Array(s),d()}}function h(){if(r)for(var e=0,i=t.length;e<i;++e)n[e]=+u(t[e],e,t)}function d(){if(r)for(var n=0,i=t.length;n<i;++n)e[n]=+c(t[n],n,t)}return null==t&&(t=[]),s.initialize=function(t){r=t,l()},s.links=function(n){return arguments.length?(t=n,l(),s):t},s.id=function(t){return arguments.length?(a=t,s):a},s.iterations=function(t){return arguments.length?(f=+t,s):f},s.strength=function(t){return arguments.length?(u="function"==typeof t?t:ga(+t),h(),s):u},s.distance=function(t){return arguments.length?(c="function"==typeof t?t:ga(+t),d(),s):c},s},t.forceManyBody=function(){var t,n,e,r,i=ga(-30),o=1,a=1/0,u=.81;function c(r){var i,o=t.length,a=wa(t,Ca,Pa).visitAfter(s);for(e=r,i=0;i<o;++i)n=t[i],a.visit(l)}function f(){if(t){var n,e,o=t.length;for(r=new Array(o),n=0;n<o;++n)e=t[n],r[e.index]=+i(e,n,t)}}function s(t){var n,e,i,o,a,u=0,c=0;if(t.length){for(i=o=a=0;a<4;++a)(n=t[a])&&(e=Math.abs(n.value))&&(u+=n.value,c+=e,i+=e*n.x,o+=e*n.y);t.x=i/c,t.y=o/c}else{(n=t).x=n.data.x,n.y=n.data.y;do{u+=r[n.data.index]}while(n=n.next)}t.value=u}function l(t,i,c,f){if(!t.value)return!0;var s=t.x-n.x,l=t.y-n.y,h=f-i,d=s*s+l*l;if(h*h/u<d)return d<a&&(0===s&&(d+=(s=ya())*s),0===l&&(d+=(l=ya())*l),d<o&&(d=Math.sqrt(o*d)),n.vx+=s*t.value*e/d,n.vy+=l*t.value*e/d),!0;if(!(t.length||d>=a)){(t.data!==n||t.next)&&(0===s&&(d+=(s=ya())*s),0===l&&(d+=(l=ya())*l),d<o&&(d=Math.sqrt(o*d)));do{t.data!==n&&(h=r[t.data.index]*e/d,n.vx+=s*h,n.vy+=l*h)}while(t=t.next)}}return c.initialize=function(n){t=n,f()},c.strength=function(t){return arguments.length?(i="function"==typeof t?t:ga(+t),f(),c):i},c.distanceMin=function(t){return arguments.length?(o=t*t,c):Math.sqrt(o)},c.distanceMax=function(t){return arguments.length?(a=t*t,c):Math.sqrt(a)},c.theta=function(t){return arguments.length?(u=t*t,c):Math.sqrt(u)},c},t.forceRadial=function(t,n,e){var r,i,o,a=ga(.1);function u(t){for(var a=0,u=r.length;a<u;++a){var c=r[a],f=c.x-n||1e-6,s=c.y-e||1e-6,l=Math.sqrt(f*f+s*s),h=(o[a]-l)*i[a]*t/l;c.vx+=f*h,c.vy+=s*h}}function c(){if(r){var n,e=r.length;for(i=new Array(e),o=new Array(e),n=0;n<e;++n)o[n]=+t(r[n],n,r),i[n]=isNaN(o[n])?0:+a(r[n],n,r)}}return"function"!=typeof t&&(t=ga(+t)),null==n&&(n=0),null==e&&(e=0),u.initialize=function(t){r=t,c()},u.strength=function(t){return arguments.length?(a="function"==typeof t?t:ga(+t),c(),u):a},u.radius=function(n){return arguments.length?(t="function"==typeof n?n:ga(+n),c(),u):t},u.x=function(t){return arguments.length?(n=+t,u):n},u.y=function(t){return arguments.length?(e=+t,u):e},u},t.forceSimulation=function(t){var n,e=1,r=.001,i=1-Math.pow(r,1/300),o=0,a=.6,u=co(),c=hr(s),f=I("tick","end");function s(){l(),f.call("tick",n),e<r&&(c.stop(),f.call("end",n))}function l(r){var c,f,s=t.length;void 0===r&&(r=1);for(var l=0;l<r;++l)for(e+=(o-e)*i,u.each(function(t){t(e)}),c=0;c<s;++c)null==(f=t[c]).fx?f.x+=f.vx*=a:(f.x=f.fx,f.vx=0),null==f.fy?f.y+=f.vy*=a:(f.y=f.fy,f.vy=0);return n}function h(){for(var n,e=0,r=t.length;e<r;++e){if((n=t[e]).index=e,null!=n.fx&&(n.x=n.fx),null!=n.fy&&(n.y=n.fy),isNaN(n.x)||isNaN(n.y)){var i=za*Math.sqrt(e),o=e*Ra;n.x=i*Math.cos(o),n.y=i*Math.sin(o)}(isNaN(n.vx)||isNaN(n.vy))&&(n.vx=n.vy=0)}}function d(n){return n.initialize&&n.initialize(t),n}return null==t&&(t=[]),h(),n={tick:l,restart:function(){return c.restart(s),n},stop:function(){return c.stop(),n},nodes:function(e){return arguments.length?(t=e,h(),u.each(d),n):t},alpha:function(t){return arguments.length?(e=+t,n):e},alphaMin:function(t){return arguments.length?(r=+t,n):r},alphaDecay:function(t){return arguments.length?(i=+t,n):+i},alphaTarget:function(t){return arguments.length?(o=+t,n):o},velocityDecay:function(t){return arguments.length?(a=1-t,n):1-a},force:function(t,e){return arguments.length>1?(null==e?u.remove(t):u.set(t,d(e)),n):u.get(t)},find:function(n,e,r){var i,o,a,u,c,f=0,s=t.length;for(null==r?r=1/0:r*=r,f=0;f<s;++f)(a=(i=n-(u=t[f]).x)*i+(o=e-u.y)*o)<r&&(c=u,r=a);return c},on:function(t,e){return arguments.length>1?(f.on(t,e),n):f.on(t)}}},t.forceX=function(t){var n,e,r,i=ga(.1);function o(t){for(var i,o=0,a=n.length;o<a;++o)(i=n[o]).vx+=(r[o]-i.x)*e[o]*t}function a(){if(n){var o,a=n.length;for(e=new Array(a),r=new Array(a),o=0;o<a;++o)e[o]=isNaN(r[o]=+t(n[o],o,n))?0:+i(n[o],o,n)}}return"function"!=typeof t&&(t=ga(null==t?0:+t)),o.initialize=function(t){n=t,a()},o.strength=function(t){return arguments.length?(i="function"==typeof t?t:ga(+t),a(),o):i},o.x=function(n){return arguments.length?(t="function"==typeof n?n:ga(+n),a(),o):t},o},t.forceY=function(t){var n,e,r,i=ga(.1);function o(t){for(var i,o=0,a=n.length;o<a;++o)(i=n[o]).vy+=(r[o]-i.y)*e[o]*t}function a(){if(n){var o,a=n.length;for(e=new Array(a),r=new Array(a),o=0;o<a;++o)e[o]=isNaN(r[o]=+t(n[o],o,n))?0:+i(n[o],o,n)}}return"function"!=typeof t&&(t=ga(null==t?0:+t)),o.initialize=function(t){n=t,a()},o.strength=function(t){return arguments.length?(i="function"==typeof t?t:ga(+t),a(),o):i},o.y=function(n){return arguments.length?(t="function"==typeof n?n:ga(+n),a(),o):t},o},t.formatDefaultLocale=Ga,t.formatLocale=Va,t.formatSpecifier=Oa,t.geoAlbers=el,t.geoAlbersUsa=function(){var t,n,e,r,i,o,a=el(),u=nl().rotate([154,0]).center([-2,58.5]).parallels([55,65]),c=nl().rotate([157,0]).center([-3,19.9]).parallels([8,18]),f={point:function(t,n){o=[t,n]}};function s(t){var n=t[0],a=t[1];return o=null,e.point(n,a),o||(r.point(n,a),o)||(i.point(n,a),o)}function l(){return t=n=null,s}return s.invert=function(t){var n=a.scale(),e=a.translate(),r=(t[0]-e[0])/n,i=(t[1]-e[1])/n;return(i>=.12&&i<.234&&r>=-.425&&r<-.214?u:i>=.166&&i<.234&&r>=-.214&&r<-.115?c:a).invert(t)},s.stream=function(e){return t&&n===e?t:(r=[a.stream(n=e),u.stream(e),c.stream(e)],i=r.length,t={point:function(t,n){for(var e=-1;++e<i;)r[e].point(t,n)},sphere:function(){for(var t=-1;++t<i;)r[t].sphere()},lineStart:function(){for(var t=-1;++t<i;)r[t].lineStart()},lineEnd:function(){for(var t=-1;++t<i;)r[t].lineEnd()},polygonStart:function(){for(var t=-1;++t<i;)r[t].polygonStart()},polygonEnd:function(){for(var t=-1;++t<i;)r[t].polygonEnd()}});var r,i},s.precision=function(t){return arguments.length?(a.precision(t),u.precision(t),c.precision(t),l()):a.precision()},s.scale=function(t){return arguments.length?(a.scale(t),u.scale(.35*t),c.scale(t),s.translate(a.translate())):a.scale()},s.translate=function(t){if(!arguments.length)return a.translate();var n=a.scale(),o=+t[0],s=+t[1];return e=a.translate(t).clipExtent([[o-.455*n,s-.238*n],[o+.455*n,s+.238*n]]).stream(f),r=u.translate([o-.307*n,s+.201*n]).clipExtent([[o-.425*n+nu,s+.12*n+nu],[o-.214*n-nu,s+.234*n-nu]]).stream(f),i=c.translate([o-.205*n,s+.212*n]).clipExtent([[o-.214*n+nu,s+.166*n+nu],[o-.115*n-nu,s+.234*n-nu]]).stream(f),l()},s.fitExtent=function(t,n){return Is(s,t,n)},s.fitSize=function(t,n){return Hs(s,t,n)},s.fitWidth=function(t,n){return js(s,t,n)},s.fitHeight=function(t,n){return Xs(s,t,n)},s.scale(1070)},t.geoArea=function(t){return Uu.reset(),Cu(t,Ou),2*Uu},t.geoAzimuthalEqualArea=function(){return Qs(ol).scale(124.75).clipAngle(179.999)},t.geoAzimuthalEqualAreaRaw=ol,t.geoAzimuthalEquidistant=function(){return Qs(al).scale(79.4188).clipAngle(179.999)},t.geoAzimuthalEquidistantRaw=al,t.geoBounds=function(t){var n,e,r,i,o,a,u;if(Ju=Ku=-(Zu=Qu=1/0),ic=[],Cu(t,Mc),e=ic.length){for(ic.sort(zc),n=1,o=[r=ic[0]];n<e;++n)Rc(r,(i=ic[n])[0])||Rc(r,i[1])?(Pc(r[0],i[1])>Pc(r[0],r[1])&&(r[1]=i[1]),Pc(i[0],r[1])>Pc(r[0],r[1])&&(r[0]=i[0])):o.push(r=i);for(a=-1/0,n=0,r=o[e=o.length-1];n<=e;r=i,++n)i=o[n],(u=Pc(r[1],i[0]))>a&&(a=u,Zu=i[0],Ku=r[1])}return ic=oc=null,Zu===1/0||Qu===1/0?[[NaN,NaN],[NaN,NaN]]:[[Zu,Qu],[Ku,Ju]]},t.geoCentroid=function(t){ac=uc=cc=fc=sc=lc=hc=dc=pc=vc=gc=0,Cu(t,Dc);var n=pc,e=vc,r=gc,i=n*n+e*e+r*r;return i<eu&&(n=lc,e=hc,r=dc,uc<nu&&(n=cc,e=fc,r=sc),(i=n*n+e*e+r*r)<eu)?[NaN,NaN]:[lu(e,n)*uu,wu(r/bu(i))*uu]},t.geoCircle=function(){var t,n,e=Xc([0,0]),r=Xc(90),i=Xc(6),o={point:function(e,r){t.push(e=n(e,r)),e[0]*=uu,e[1]*=uu}};function a(){var a=e.apply(this,arguments),u=r.apply(this,arguments)*cu,c=i.apply(this,arguments)*cu;return t=[],n=$c(-a[0]*cu,-a[1]*cu,0).invert,Jc(o,u,c,1),a={type:"Polygon",coordinates:[t]},t=n=null,a}return a.center=function(t){return arguments.length?(e="function"==typeof t?t:Xc([+t[0],+t[1]]),a):e},a.radius=function(t){return arguments.length?(r="function"==typeof t?t:Xc(+t),a):r},a.precision=function(t){return arguments.length?(i="function"==typeof t?t:Xc(+t),a):i},a},t.geoClipAntimeridian=df,t.geoClipCircle=pf,t.geoClipExtent=function(){var t,n,e,r=0,i=0,o=960,a=500;return e={stream:function(e){return t&&n===e?t:t=yf(r,i,o,a)(n=e)},extent:function(u){return arguments.length?(r=+u[0][0],i=+u[0][1],o=+u[1][0],a=+u[1][1],t=n=null,e):[[r,i],[o,a]]}}},t.geoClipRectangle=yf,t.geoConicConformal=function(){return Js(sl).scale(109.5).parallels([30,30])},t.geoConicConformalRaw=sl,t.geoConicEqualArea=nl,t.geoConicEqualAreaRaw=tl,t.geoConicEquidistant=function(){return Js(hl).scale(131.154).center([0,13.9389])},t.geoConicEquidistantRaw=hl,t.geoContains=function(t,n){return(t&&Cf.hasOwnProperty(t.type)?Cf[t.type]:zf)(t,n)},t.geoDistance=Ef,t.geoEqualEarth=function(){return Qs(_l).scale(177.158)},t.geoEqualEarthRaw=_l,t.geoEquirectangular=function(){return Qs(ll).scale(152.63)},t.geoEquirectangularRaw=ll,t.geoGnomonic=function(){return Qs(bl).scale(144.049).clipAngle(60)},t.geoGnomonicRaw=bl,t.geoGraticule=Ff,t.geoGraticule10=function(){return Ff()()},t.geoIdentity=function(){var t,n,e,r,i,o,a,u=1,c=0,f=0,s=1,l=1,h=0,d=null,p=1,v=1,g=Bs({point:function(t,n){var e=b([t,n]);this.stream.point(e[0],e[1])}}),y=Yf;function _(){return p=u*s,v=u*l,o=a=null,b}function b(e){var r=e[0]*p,i=e[1]*v;if(h){var o=i*t-r*n;r=r*t+i*n,i=o}return[r+c,i+f]}return b.invert=function(e){var r=e[0]-c,i=e[1]-f;if(h){var o=i*t+r*n;r=r*t-i*n,i=o}return[r/p,i/v]},b.stream=function(t){return o&&a===t?o:o=g(y(a=t))},b.postclip=function(t){return arguments.length?(y=t,d=e=r=i=null,_()):y},b.clipExtent=function(t){return arguments.length?(y=null==t?(d=e=r=i=null,Yf):yf(d=+t[0][0],e=+t[0][1],r=+t[1][0],i=+t[1][1]),_()):null==d?null:[[d,e],[r,i]]},b.scale=function(t){return arguments.length?(u=+t,_()):u},b.translate=function(t){return arguments.length?(c=+t[0],f=+t[1],_()):[c,f]},b.angle=function(e){return arguments.length?(n=yu(h=e%360*cu),t=hu(h),_()):h*uu},b.reflectX=function(t){return arguments.length?(s=t?-1:1,_()):s<0},b.reflectY=function(t){return arguments.length?(l=t?-1:1,_()):l<0},b.fitExtent=function(t,n){return Is(b,t,n)},b.fitSize=function(t,n){return Hs(b,t,n)},b.fitWidth=function(t,n){return js(b,t,n)},b.fitHeight=function(t,n){return Xs(b,t,n)},b},t.geoInterpolate=function(t,n){var e=t[0]*cu,r=t[1]*cu,i=n[0]*cu,o=n[1]*cu,a=hu(r),u=yu(r),c=hu(o),f=yu(o),s=a*hu(e),l=a*yu(e),h=c*hu(i),d=c*yu(i),p=2*wu(bu(Mu(o-r)+a*c*Mu(i-e))),v=yu(p),g=p?function(t){var n=yu(t*=p)/v,e=yu(p-t)/v,r=e*s+n*h,i=e*l+n*d,o=e*u+n*f;return[lu(i,r)*uu,lu(o,bu(r*r+i*i))*uu]}:function(){return[e*uu,r*uu]};return g.distance=p,g},t.geoLength=Af,t.geoMercator=function(){return cl(ul).scale(961/au)},t.geoMercatorRaw=ul,t.geoNaturalEarth1=function(){return Qs(ml).scale(175.295)},t.geoNaturalEarth1Raw=ml,t.geoOrthographic=function(){return Qs(xl).scale(249.5).clipAngle(90+nu)},t.geoOrthographicRaw=xl,t.geoPath=function(t,n){var e,r,i=4.5;function o(t){return t&&("function"==typeof i&&r.pointRadius(+i.apply(this,arguments)),Cu(t,e(r))),r.result()}return o.area=function(t){return Cu(t,e($f)),$f.result()},o.measure=function(t){return Cu(t,e(Ds)),Ds.result()},o.bounds=function(t){return Cu(t,e(rs)),rs.result()},o.centroid=function(t){return Cu(t,e(ys)),ys.result()},o.projection=function(n){return arguments.length?(e=null==n?(t=null,Yf):(t=n).stream,o):t},o.context=function(t){return arguments.length?(r=null==t?(n=null,new Us):new Ss(n=t),"function"!=typeof i&&r.pointRadius(i),o):n},o.pointRadius=function(t){return arguments.length?(i="function"==typeof t?t:(r.pointRadius(+t),+t),o):i},o.projection(t).context(n)},t.geoProjection=Qs,t.geoProjectionMutator=Ks,t.geoRotation=Kc,t.geoStereographic=function(){return Qs(wl).scale(250).clipAngle(142)},t.geoStereographicRaw=wl,t.geoStream=Cu,t.geoTransform=function(t){return{stream:Bs(t)}},t.geoTransverseMercator=function(){var t=cl(Ml),n=t.center,e=t.rotate;return t.center=function(t){return arguments.length?n([-t[1],t[0]]):[(t=n())[1],-t[0]]},t.rotate=function(t){return arguments.length?e([t[0],t[1],t.length>2?t[2]+90:90]):[(t=e())[0],t[1],t[2]-90]},e([0,0,90]).scale(159.155)},t.geoTransverseMercatorRaw=Ml,t.gray=function(t,n){return new Bn(t,0,0,null==n?1:n)},t.hcl=Xn,t.hierarchy=kl,t.histogram=function(){var t=v,n=s,e=M;function r(r){var o,a,u=r.length,c=new Array(u);for(o=0;o<u;++o)c[o]=t(r[o],o,r);var f=n(c),s=f[0],l=f[1],h=e(c,s,l);Array.isArray(h)||(h=w(s,l,h),h=g(Math.ceil(s/h)*h,l,h));for(var d=h.length;h[0]<=s;)h.shift(),--d;for(;h[d-1]>l;)h.pop(),--d;var p,v=new Array(d+1);for(o=0;o<=d;++o)(p=v[o]=[]).x0=o>0?h[o-1]:s,p.x1=o<d?h[o]:l;for(o=0;o<u;++o)s<=(a=c[o])&&a<=l&&v[i(h,a,0,d)].push(r[o]);return v}return r.value=function(n){return arguments.length?(t="function"==typeof n?n:p(n),r):t},r.domain=function(t){return arguments.length?(n="function"==typeof t?t:p([t[0],t[1]]),r):n},r.thresholds=function(t){return arguments.length?(e="function"==typeof t?t:Array.isArray(t)?p(h.call(t)):p(t),r):e},r},t.hsl=Tn,t.html=pa,t.image=function(t,n){return new Promise(function(e,r){var i=new Image;for(var o in n)i[o]=n[o];i.onerror=r,i.onload=function(){e(i)},i.src=t})},t.interpolate=Te,t.interpolateArray=function(t,n){return(ye(n)?ge:_e)(t,n)},t.interpolateBasis=oe,t.interpolateBasisClosed=ae,t.interpolateBlues=Qg,t.interpolateBrBG=fg,t.interpolateBuGn=Sg,t.interpolateBuPu=Eg,t.interpolateCividis=function(t){return t=Math.max(0,Math.min(1,t)),"rgb("+Math.max(0,Math.min(255,Math.round(-4.54-t*(35.34-t*(2381.73-t*(6402.7-t*(7024.72-2710.57*t)))))))+", "+Math.max(0,Math.min(255,Math.round(32.49+t*(170.73+t*(52.82-t*(131.46-t*(176.58-67.37*t)))))))+", "+Math.max(0,Math.min(255,Math.round(81.24+t*(442.36-t*(2482.43-t*(6167.24-t*(6614.94-2475.67*t)))))))+")"},t.interpolateCool=sy,t.interpolateCubehelix=Ze,t.interpolateCubehelixDefault=cy,t.interpolateCubehelixLong=Qe,t.interpolateDate=be,t.interpolateDiscrete=function(t){var n=t.length;return function(e){return t[Math.max(0,Math.min(n-1,Math.floor(e*n)))]}},t.interpolateGnBu=Pg,t.interpolateGreens=Jg,t.interpolateGreys=ny,t.interpolateHcl=Ge,t.interpolateHclLong=$e,t.interpolateHsl=je,t.interpolateHslLong=Xe,t.interpolateHue=function(t,n){var e=fe(+t,+n);return function(t){var n=e(t);return n-360*Math.floor(n/360)}},t.interpolateInferno=_y,t.interpolateLab=function(t,n){var e=le((t=On(t)).l,(n=On(n)).l),r=le(t.a,n.a),i=le(t.b,n.b),o=le(t.opacity,n.opacity);return function(n){return t.l=e(n),t.a=r(n),t.b=i(n),t.opacity=o(n),t+""}},t.interpolateMagma=yy,t.interpolateNumber=me,t.interpolateNumberArray=ge,t.interpolateObject=xe,t.interpolateOrRd=Rg,t.interpolateOranges=uy,t.interpolatePRGn=lg,t.interpolatePiYG=dg,t.interpolatePlasma=by,t.interpolatePuBu=Ug,t.interpolatePuBuGn=qg,t.interpolatePuOr=vg,t.interpolatePuRd=Bg,t.interpolatePurples=ry,t.interpolateRainbow=function(t){(t<0||t>1)&&(t-=Math.floor(t));var n=Math.abs(t-.5);return ly.h=360*t-100,ly.s=1.5-1.5*n,ly.l=.8-.9*n,ly+""},t.interpolateRdBu=yg,t.interpolateRdGy=bg,t.interpolateRdPu=Yg,t.interpolateRdYlBu=xg,t.interpolateRdYlGn=Mg,t.interpolateReds=oy,t.interpolateRgb=he,t.interpolateRgbBasis=pe,t.interpolateRgbBasisClosed=ve,t.interpolateRound=Ae,t.interpolateSinebow=function(t){var n;return t=(.5-t)*Math.PI,hy.r=255*(n=Math.sin(t))*n,hy.g=255*(n=Math.sin(t+dy))*n,hy.b=255*(n=Math.sin(t+py))*n,hy+""},t.interpolateSpectral=Tg,t.interpolateString=Ne,t.interpolateTransformCss=qe,t.interpolateTransformSvg=Le,t.interpolateTurbo=function(t){return t=Math.max(0,Math.min(1,t)),"rgb("+Math.max(0,Math.min(255,Math.round(34.61+t*(1172.33-t*(10793.56-t*(33300.12-t*(38394.49-14825.05*t)))))))+", "+Math.max(0,Math.min(255,Math.round(23.31+t*(557.33+t*(1225.33-t*(3574.96-t*(1073.77+707.56*t)))))))+", "+Math.max(0,Math.min(255,Math.round(27.2+t*(3211.1-t*(15327.97-t*(27814-t*(22569.18-6838.66*t)))))))+")"},t.interpolateViridis=gy,t.interpolateWarm=fy,t.interpolateYlGn=Xg,t.interpolateYlGnBu=Hg,t.interpolateYlOrBr=Gg,t.interpolateYlOrRd=Wg,t.interpolateZoom=Ie,t.interrupt=Pr,t.interval=function(t,n,e){var r=new lr,i=n;return null==n?(r.restart(t,n,e),r):(n=+n,e=null==e?fr():+e,r.restart(function o(a){a+=i,r.restart(o,i+=n,e),t(a)},n,e),r)},t.isoFormat=Rv,t.isoParse=Dv,t.json=function(t,n){return fetch(t,n).then(la)},t.keys=function(t){var n=[];for(var e in t)n.push(e);return n},t.lab=On,t.lch=function(t,n,e,r){return 1===arguments.length?jn(t):new Vn(e,n,t,null==r?1:r)},t.line=Hy,t.lineRadial=Qy,t.linkHorizontal=function(){return r_(i_)},t.linkRadial=function(){var t=r_(a_);return t.angle=t.x,delete t.x,t.radius=t.y,delete t.y,t},t.linkVertical=function(){return r_(o_)},t.local=qt,t.map=co,t.matcher=nt,t.max=T,t.mean=function(t,n){var e,r=t.length,i=r,o=-1,a=0;if(null==n)for(;++o<r;)isNaN(e=u(t[o]))?--i:a+=e;else for(;++o<r;)isNaN(e=u(n(t[o],o,t)))?--i:a+=e;if(i)return a/i},t.median=function(t,e){var r,i=t.length,o=-1,a=[];if(null==e)for(;++o<i;)isNaN(r=u(t[o]))||a.push(r);else for(;++o<i;)isNaN(r=u(e(t[o],o,t)))||a.push(r);return N(a.sort(n),.5)},t.merge=A,t.min=S,t.mouse=Bt,t.namespace=W,t.namespaces=$,t.nest=function(){var t,n,e,r=[],i=[];function o(e,i,a,u){if(i>=r.length)return null!=t&&e.sort(t),null!=n?n(e):e;for(var c,f,s,l=-1,h=e.length,d=r[i++],p=co(),v=a();++l<h;)(s=p.get(c=d(f=e[l])+""))?s.push(f):p.set(c,[f]);return p.each(function(t,n){u(v,n,o(t,i,a,u))}),v}return e={object:function(t){return o(t,0,fo,so)},map:function(t){return o(t,0,lo,ho)},entries:function(t){return function t(e,o){if(++o>r.length)return e;var a,u=i[o-1];return null!=n&&o>=r.length?a=e.entries():(a=[],e.each(function(n,e){a.push({key:e,values:t(n,o)})})),null!=u?a.sort(function(t,n){return u(t.key,n.key)}):a}(o(t,0,lo,ho),0)},key:function(t){return r.push(t),e},sortKeys:function(t){return i[r.length-1]=t,e},sortValues:function(n){return t=n,e},rollup:function(t){return n=t,e}}},t.now=fr,t.pack=function(){var t=null,n=1,e=1,r=Wl;function i(i){return i.x=n/2,i.y=e/2,t?i.eachBefore(Kl(t)).eachAfter(Jl(r,.5)).eachBefore(th(1)):i.eachBefore(Kl(Ql)).eachAfter(Jl(Wl,1)).eachAfter(Jl(r,i.r/Math.min(n,e))).eachBefore(th(Math.min(n,e)/(2*i.r))),i}return i.radius=function(n){return arguments.length?(t=Gl(n),i):t},i.size=function(t){return arguments.length?(n=+t[0],e=+t[1],i):[n,e]},i.padding=function(t){return arguments.length?(r="function"==typeof t?t:Zl(+t),i):r},i},t.packEnclose=Dl,t.packSiblings=function(t){return Vl(t),t},t.pairs=function(t,n){null==n&&(n=a);for(var e=0,r=t.length-1,i=t[0],o=new Array(r<0?0:r);e<r;)o[e]=n(i,i=t[++e]);return o},t.partition=function(){var t=1,n=1,e=0,r=!1;function i(i){var o=i.height+1;return i.x0=i.y0=e,i.x1=t,i.y1=n/o,i.eachBefore(function(t,n){return function(r){r.children&&eh(r,r.x0,t*(r.depth+1)/n,r.x1,t*(r.depth+2)/n);var i=r.x0,o=r.y0,a=r.x1-e,u=r.y1-e;a<i&&(i=a=(i+a)/2),u<o&&(o=u=(o+u)/2),r.x0=i,r.y0=o,r.x1=a,r.y1=u}}(n,o)),r&&i.eachBefore(nh),i}return i.round=function(t){return arguments.length?(r=!!t,i):r},i.size=function(e){return arguments.length?(t=+e[0],n=+e[1],i):[t,n]},i.padding=function(t){return arguments.length?(e=+t,i):e},i},t.path=no,t.permute=function(t,n){for(var e=n.length,r=new Array(e);e--;)r[e]=t[n[e]];return r},t.pie=function(){var t=Vy,n=Xy,e=null,r=my(0),i=my(Py),o=my(0);function a(a){var u,c,f,s,l,h=a.length,d=0,p=new Array(h),v=new Array(h),g=+r.apply(this,arguments),y=Math.min(Py,Math.max(-Py,i.apply(this,arguments)-g)),_=Math.min(Math.abs(y)/h,o.apply(this,arguments)),b=_*(y<0?-1:1);for(u=0;u<h;++u)(l=v[p[u]=u]=+t(a[u],u,a))>0&&(d+=l);for(null!=n?p.sort(function(t,e){return n(v[t],v[e])}):null!=e&&p.sort(function(t,n){return e(a[t],a[n])}),u=0,f=d?(y-h*b)/d:0;u<h;++u,g=s)c=p[u],s=g+((l=v[c])>0?l*f:0)+b,v[c]={data:a[c],index:u,value:l,startAngle:g,endAngle:s,padAngle:_};return v}return a.value=function(n){return arguments.length?(t="function"==typeof n?n:my(+n),a):t},a.sortValues=function(t){return arguments.length?(n=t,e=null,a):n},a.sort=function(t){return arguments.length?(e=t,n=null,a):e},a.startAngle=function(t){return arguments.length?(r="function"==typeof t?t:my(+t),a):r},a.endAngle=function(t){return arguments.length?(i="function"==typeof t?t:my(+t),a):i},a.padAngle=function(t){return arguments.length?(o="function"==typeof t?t:my(+t),a):o},a},t.piecewise=function(t,n){for(var e=0,r=n.length-1,i=n[0],o=new Array(r<0?0:r);e<r;)o[e]=t(i,i=n[++e]);return function(t){var n=Math.max(0,Math.min(r-1,Math.floor(t*=r)));return o[n](t-n)}},t.pointRadial=Jy,t.polygonArea=function(t){for(var n,e=-1,r=t.length,i=t[r-1],o=0;++e<r;)n=i,i=t[e],o+=n[1]*i[0]-n[0]*i[1];return o/2},t.polygonCentroid=function(t){for(var n,e,r=-1,i=t.length,o=0,a=0,u=t[i-1],c=0;++r<i;)n=u,u=t[r],c+=e=n[0]*u[1]-u[0]*n[1],o+=(n[0]+u[0])*e,a+=(n[1]+u[1])*e;return[o/(c*=3),a/c]},t.polygonContains=function(t,n){for(var e,r,i=t.length,o=t[i-1],a=n[0],u=n[1],c=o[0],f=o[1],s=!1,l=0;l<i;++l)e=(o=t[l])[0],(r=o[1])>u!=f>u&&a<(c-e)*(u-r)/(f-r)+e&&(s=!s),c=e,f=r;return s},t.polygonHull=function(t){if((e=t.length)<3)return null;var n,e,r=new Array(e),i=new Array(e);for(n=0;n<e;++n)r[n]=[+t[n][0],+t[n][1],n];for(r.sort(mh),n=0;n<e;++n)i[n]=[r[n][0],-r[n][1]];var o=xh(r),a=xh(i),u=a[0]===o[0],c=a[a.length-1]===o[o.length-1],f=[];for(n=o.length-1;n>=0;--n)f.push(t[r[o[n]][2]]);for(n=+u;n<a.length-c;++n)f.push(t[r[a[n]][2]]);return f},t.polygonLength=function(t){for(var n,e,r=-1,i=t.length,o=t[i-1],a=o[0],u=o[1],c=0;++r<i;)n=a,e=u,n-=a=(o=t[r])[0],e-=u=o[1],c+=Math.sqrt(n*n+e*e);return c},t.precisionFixed=$a,t.precisionPrefix=Wa,t.precisionRound=Za,t.quadtree=wa,t.quantile=N,t.quantize=function(t,n){for(var e=new Array(n),r=0;r<n;++r)e[r]=t(r/(n-1));return e},t.radialArea=Ky,t.radialLine=Qy,t.randomBates=Sh,t.randomExponential=kh,t.randomIrwinHall=Ah,t.randomLogNormal=Th,t.randomNormal=Nh,t.randomUniform=Mh,t.range=g,t.rgb=_n,t.ribbon=function(){var t=eo,n=ro,e=io,r=oo,i=ao,o=null;function a(){var a,u=Wi.call(arguments),c=t.apply(this,u),f=n.apply(this,u),s=+e.apply(this,(u[0]=c,u)),l=r.apply(this,u)-Xi,h=i.apply(this,u)-Xi,d=s*Ii(l),p=s*Hi(l),v=+e.apply(this,(u[0]=f,u)),g=r.apply(this,u)-Xi,y=i.apply(this,u)-Xi;if(o||(o=a=no()),o.moveTo(d,p),o.arc(0,0,s,l,h),l===g&&h===y||(o.quadraticCurveTo(0,0,v*Ii(g),v*Hi(g)),o.arc(0,0,v,g,y)),o.quadraticCurveTo(0,0,d,p),o.closePath(),a)return o=null,a+""||null}return a.radius=function(t){return arguments.length?(e="function"==typeof t?t:Zi(+t),a):e},a.startAngle=function(t){return arguments.length?(r="function"==typeof t?t:Zi(+t),a):r},a.endAngle=function(t){return arguments.length?(i="function"==typeof t?t:Zi(+t),a):i},a.source=function(n){return arguments.length?(t=n,a):t},a.target=function(t){return arguments.length?(n=t,a):n},a.context=function(t){return arguments.length?(o=null==t?null:t,a):o},a},t.scaleBand=Lh,t.scaleDiverging=function t(){var n=$h($v()(Bh));return n.copy=function(){return Vv(n,t())},Ch.apply(n,arguments)},t.scaleDivergingLog=function t(){var n=ed($v()).domain([.1,1,10]);return n.copy=function(){return Vv(n,t()).base(n.base())},Ch.apply(n,arguments)},t.scaleDivergingPow=Wv,t.scaleDivergingSqrt=function(){return Wv.apply(null,arguments).exponent(.5)},t.scaleDivergingSymlog=function t(){var n=od($v());return n.copy=function(){return Vv(n,t()).constant(n.constant())},Ch.apply(n,arguments)},t.scaleIdentity=function t(n){var e;function r(t){return isNaN(t=+t)?e:t}return r.invert=r,r.domain=r.range=function(t){return arguments.length?(n=zh.call(t,Uh),r):n.slice()},r.unknown=function(t){return arguments.length?(e=t,r):e},r.copy=function(){return t(n).unknown(e)},n=arguments.length?zh.call(n,Uh):[0,1],$h(r)},t.scaleImplicit=Dh,t.scaleLinear=function t(){var n=Vh(Bh,Bh);return n.copy=function(){return jh(n,t())},Eh.apply(n,arguments),$h(n)},t.scaleLog=function t(){var n=ed(Xh()).domain([1,10]);return n.copy=function(){return jh(n,t()).base(n.base())},Eh.apply(n,arguments),n},t.scaleOrdinal=qh,t.scalePoint=function(){return function t(n){var e=n.copy;return n.padding=n.paddingOuter,delete n.paddingInner,delete n.paddingOuter,n.copy=function(){return t(e())},n}(Lh.apply(null,arguments).paddingInner(1))},t.scalePow=sd,t.scaleQuantile=function t(){var e,r=[],o=[],a=[];function u(){var t=0,n=Math.max(1,o.length);for(a=new Array(n-1);++t<n;)a[t-1]=N(r,t/n);return c}function c(t){return isNaN(t=+t)?e:o[i(a,t)]}return c.invertExtent=function(t){var n=o.indexOf(t);return n<0?[NaN,NaN]:[n>0?a[n-1]:r[0],n<a.length?a[n]:r[r.length-1]]},c.domain=function(t){if(!arguments.length)return r.slice();r=[];for(var e,i=0,o=t.length;i<o;++i)null==(e=t[i])||isNaN(e=+e)||r.push(e);return r.sort(n),u()},c.range=function(t){return arguments.length?(o=Rh.call(t),u()):o.slice()},c.unknown=function(t){return arguments.length?(e=t,c):e},c.quantiles=function(){return a.slice()},c.copy=function(){return t().domain(r).range(o).unknown(e)},Eh.apply(c,arguments)},t.scaleQuantize=function t(){var n,e=0,r=1,o=1,a=[.5],u=[0,1];function c(t){return t<=t?u[i(a,t,0,o)]:n}function f(){var t=-1;for(a=new Array(o);++t<o;)a[t]=((t+1)*r-(t-o)*e)/(o+1);return c}return c.domain=function(t){return arguments.length?(e=+t[0],r=+t[1],f()):[e,r]},c.range=function(t){return arguments.length?(o=(u=Rh.call(t)).length-1,f()):u.slice()},c.invertExtent=function(t){var n=u.indexOf(t);return n<0?[NaN,NaN]:n<1?[e,a[0]]:n>=o?[a[o-1],r]:[a[n-1],a[n]]},c.unknown=function(t){return arguments.length?(n=t,c):c},c.thresholds=function(){return a.slice()},c.copy=function(){return t().domain([e,r]).range(u).unknown(n)},Eh.apply($h(c),arguments)},t.scaleSequential=function t(){var n=$h(Xv()(Bh));return n.copy=function(){return Vv(n,t())},Ch.apply(n,arguments)},t.scaleSequentialLog=function t(){var n=ed(Xv()).domain([1,10]);return n.copy=function(){return Vv(n,t()).base(n.base())},Ch.apply(n,arguments)},t.scaleSequentialPow=Gv,t.scaleSequentialQuantile=function t(){var e=[],r=Bh;function o(t){if(!isNaN(t=+t))return r((i(e,t)-1)/(e.length-1))}return o.domain=function(t){if(!arguments.length)return e.slice();e=[];for(var r,i=0,a=t.length;i<a;++i)null==(r=t[i])||isNaN(r=+r)||e.push(r);return e.sort(n),o},o.interpolator=function(t){return arguments.length?(r=t,o):r},o.copy=function(){return t(r).domain(e)},Ch.apply(o,arguments)},t.scaleSequentialSqrt=function(){return Gv.apply(null,arguments).exponent(.5)},t.scaleSequentialSymlog=function t(){var n=od(Xv());return n.copy=function(){return Vv(n,t()).constant(n.constant())},Ch.apply(n,arguments)},t.scaleSqrt=function(){return sd.apply(null,arguments).exponent(.5)},t.scaleSymlog=function t(){var n=od(Xh());return n.copy=function(){return jh(n,t()).constant(n.constant())},Eh.apply(n,arguments)},t.scaleThreshold=function t(){var n,e=[.5],r=[0,1],o=1;function a(t){return t<=t?r[i(e,t,0,o)]:n}return a.domain=function(t){return arguments.length?(e=Rh.call(t),o=Math.min(e.length,r.length-1),a):e.slice()},a.range=function(t){return arguments.length?(r=Rh.call(t),o=Math.min(e.length,r.length-1),a):r.slice()},a.invertExtent=function(t){var n=r.indexOf(t);return[e[n-1],e[n]]},a.unknown=function(t){return arguments.length?(n=t,a):n},a.copy=function(){return t().domain(e).range(r).unknown(n)},Eh.apply(a,arguments)},t.scaleTime=function(){return Eh.apply(jv(Hd,Yd,Sd,Nd,wd,md,_d,pd,t.timeFormat).domain([new Date(2e3,0,1),new Date(2e3,0,2)]),arguments)},t.scaleUtc=function(){return Eh.apply(jv(pp,hp,Kd,Wd,Gd,Xd,_d,pd,t.utcFormat).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)]),arguments)},t.scan=function(t,e){if(r=t.length){var r,i,o=0,a=0,u=t[a];for(null==e&&(e=n);++o<r;)(e(i=t[o],u)<0||0!==e(u,u))&&(u=i,a=o);return 0===e(u,u)?a:void 0}},t.schemeAccent=Kv,t.schemeBlues=Zg,t.schemeBrBG=cg,t.schemeBuGn=Ag,t.schemeBuPu=kg,t.schemeCategory10=Qv,t.schemeDark2=Jv,t.schemeGnBu=Cg,t.schemeGreens=Kg,t.schemeGreys=ty,t.schemeOrRd=zg,t.schemeOranges=ay,t.schemePRGn=sg,t.schemePaired=tg,t.schemePastel1=ng,t.schemePastel2=eg,t.schemePiYG=hg,t.schemePuBu=Lg,t.schemePuBuGn=Dg,t.schemePuOr=pg,t.schemePuRd=Og,t.schemePurples=ey,t.schemeRdBu=gg,t.schemeRdGy=_g,t.schemeRdPu=Fg,t.schemeRdYlBu=mg,t.schemeRdYlGn=wg,t.schemeReds=iy,t.schemeSet1=rg,t.schemeSet2=ig,t.schemeSet3=og,t.schemeSpectral=Ng,t.schemeTableau10=ag,t.schemeYlGn=jg,t.schemeYlGnBu=Ig,t.schemeYlOrBr=Vg,t.schemeYlOrRd=$g,t.select=Rt,t.selectAll=function(t){return"string"==typeof t?new Pt([document.querySelectorAll(t)],[document.documentElement]):new Pt([null==t?[]:t],Ct)},t.selection=zt,t.selector=K,t.selectorAll=tt,t.set=go,t.shuffle=function(t,n,e){for(var r,i,o=(null==e?t.length:e)-(n=null==n?0:+n);o;)i=Math.random()*o--|0,r=t[o+n],t[o+n]=t[i+n],t[i+n]=r;return t},t.stack=function(){var t=my([]),n=rb,e=eb,r=ib;function i(i){var o,a,u=t.apply(this,arguments),c=i.length,f=u.length,s=new Array(f);for(o=0;o<f;++o){for(var l,h=u[o],d=s[o]=new Array(c),p=0;p<c;++p)d[p]=l=[0,+r(i[p],h,p,i)],l.data=i[p];d.key=h}for(o=0,a=n(s);o<f;++o)s[a[o]].index=o;return e(s,a),s}return i.keys=function(n){return arguments.length?(t="function"==typeof n?n:my(t_.call(n)),i):t},i.value=function(t){return arguments.length?(r="function"==typeof t?t:my(+t),i):r},i.order=function(t){return arguments.length?(n=null==t?rb:"function"==typeof t?t:my(t_.call(t)),i):n},i.offset=function(t){return arguments.length?(e=null==t?eb:t,i):e},i},t.stackOffsetDiverging=function(t,n){if((u=t.length)>0)for(var e,r,i,o,a,u,c=0,f=t[n[0]].length;c<f;++c)for(o=a=0,e=0;e<u;++e)(i=(r=t[n[e]][c])[1]-r[0])>0?(r[0]=o,r[1]=o+=i):i<0?(r[1]=a,r[0]=a+=i):(r[0]=0,r[1]=i)},t.stackOffsetExpand=function(t,n){if((r=t.length)>0){for(var e,r,i,o=0,a=t[0].length;o<a;++o){for(i=e=0;e<r;++e)i+=t[e][o][1]||0;if(i)for(e=0;e<r;++e)t[e][o][1]/=i}eb(t,n)}},t.stackOffsetNone=eb,t.stackOffsetSilhouette=function(t,n){if((e=t.length)>0){for(var e,r=0,i=t[n[0]],o=i.length;r<o;++r){for(var a=0,u=0;a<e;++a)u+=t[a][r][1]||0;i[r][1]+=i[r][0]=-u/2}eb(t,n)}},t.stackOffsetWiggle=function(t,n){if((i=t.length)>0&&(r=(e=t[n[0]]).length)>0){for(var e,r,i,o=0,a=1;a<r;++a){for(var u=0,c=0,f=0;u<i;++u){for(var s=t[n[u]],l=s[a][1]||0,h=(l-(s[a-1][1]||0))/2,d=0;d<u;++d){var p=t[n[d]];h+=(p[a][1]||0)-(p[a-1][1]||0)}c+=l,f+=h*l}e[a-1][1]+=e[a-1][0]=o,c&&(o-=f/c)}e[a-1][1]+=e[a-1][0]=o,eb(t,n)}},t.stackOrderAppearance=ob,t.stackOrderAscending=ub,t.stackOrderDescending=function(t){return ub(t).reverse()},t.stackOrderInsideOut=function(t){var n,e,r=t.length,i=t.map(cb),o=ob(t),a=0,u=0,c=[],f=[];for(n=0;n<r;++n)e=o[n],a<u?(a+=i[e],c.push(e)):(u+=i[e],f.push(e));return f.reverse().concat(c)},t.stackOrderNone=rb,t.stackOrderReverse=function(t){return rb(t).reverse()},t.stratify=function(){var t=ah,n=uh;function e(e){var r,i,o,a,u,c,f,s=e.length,l=new Array(s),h={};for(i=0;i<s;++i)r=e[i],u=l[i]=new zl(r),null!=(c=t(r,i,e))&&(c+="")&&(h[f=rh+(u.id=c)]=f in h?oh:u);for(i=0;i<s;++i)if(u=l[i],null!=(c=n(e[i],i,e))&&(c+="")){if(!(a=h[rh+c]))throw new Error("missing: "+c);if(a===oh)throw new Error("ambiguous: "+c);a.children?a.children.push(u):a.children=[u],u.parent=a}else{if(o)throw new Error("multiple roots");o=u}if(!o)throw new Error("no root");if(o.parent=ih,o.eachBefore(function(t){t.depth=t.parent.depth+1,--s}).eachBefore(Pl),o.parent=null,s>0)throw new Error("cycle");return o}return e.id=function(n){return arguments.length?(t=$l(n),e):t},e.parentId=function(t){return arguments.length?(n=$l(t),e):n},e},t.style=ft,t.sum=function(t,n){var e,r=t.length,i=-1,o=0;if(null==n)for(;++i<r;)(e=+t[i])&&(o+=e);else for(;++i<r;)(e=+n(t[i],i,t))&&(o+=e);return o},t.svg=va,t.symbol=function(){var t=my(u_),n=my(64),e=null;function r(){var r;if(e||(e=r=no()),t.apply(this,arguments).draw(e,+n.apply(this,arguments)),r)return e=null,r+""||null}return r.type=function(n){return arguments.length?(t="function"==typeof n?n:my(n),r):t},r.size=function(t){return arguments.length?(n="function"==typeof t?t:my(+t),r):n},r.context=function(t){return arguments.length?(e=null==t?null:t,r):e},r},t.symbolCircle=u_,t.symbolCross=c_,t.symbolDiamond=l_,t.symbolSquare=g_,t.symbolStar=v_,t.symbolTriangle=__,t.symbolWye=w_,t.symbols=M_,t.text=ua,t.thresholdFreedmanDiaconis=function(t,e,r){return t=d.call(t,u).sort(n),Math.ceil((r-e)/(2*(N(t,.75)-N(t,.25))*Math.pow(t.length,-1/3)))},t.thresholdScott=function(t,n,e){return Math.ceil((e-n)/(3.5*f(t)*Math.pow(t.length,-1/3)))},t.thresholdSturges=M,t.tickFormat=Gh,t.tickIncrement=x,t.tickStep=w,t.ticks=m,t.timeDay=Nd,t.timeDays=Td,t.timeFormatDefaultLocale=zv,t.timeFormatLocale=bp,t.timeFriday=zd,t.timeFridays=Bd,t.timeHour=wd,t.timeHours=Md,t.timeInterval=dd,t.timeMillisecond=pd,t.timeMilliseconds=vd,t.timeMinute=md,t.timeMinutes=xd,t.timeMonday=kd,t.timeMondays=qd,t.timeMonth=Yd,t.timeMonths=Id,t.timeSaturday=Rd,t.timeSaturdays=Fd,t.timeSecond=_d,t.timeSeconds=bd,t.timeSunday=Sd,t.timeSundays=Dd,t.timeThursday=Pd,t.timeThursdays=Od,t.timeTuesday=Ed,t.timeTuesdays=Ld,t.timeWednesday=Cd,t.timeWednesdays=Ud,t.timeWeek=Sd,t.timeWeeks=Dd,t.timeYear=Hd,t.timeYears=jd,t.timeout=yr,t.timer=hr,t.timerFlush=dr,t.touch=Ft,t.touches=function(t,n){null==n&&(n=Ut().touches);for(var e=0,r=n?n.length:0,i=new Array(r);e<r;++e)i[e]=Ot(t,n[e]);return i},t.transition=Or,t.transpose=k,t.tree=function(){var t=ch,n=1,e=1,r=null;function i(i){var c=function(t){for(var n,e,r,i,o,a=new dh(t,0),u=[a];n=u.pop();)if(r=n._.children)for(n.children=new Array(o=r.length),i=o-1;i>=0;--i)u.push(e=n.children[i]=new dh(r[i],i)),e.parent=n;return(a.parent=new dh(null,0)).children=[a],a}(i);if(c.eachAfter(o),c.parent.m=-c.z,c.eachBefore(a),r)i.eachBefore(u);else{var f=i,s=i,l=i;i.eachBefore(function(t){t.x<f.x&&(f=t),t.x>s.x&&(s=t),t.depth>l.depth&&(l=t)});var h=f===s?1:t(f,s)/2,d=h-f.x,p=n/(s.x+h+d),v=e/(l.depth||1);i.eachBefore(function(t){t.x=(t.x+d)*p,t.y=t.depth*v})}return i}function o(n){var e=n.children,r=n.parent.children,i=n.i?r[n.i-1]:null;if(e){!function(t){for(var n,e=0,r=0,i=t.children,o=i.length;--o>=0;)(n=i[o]).z+=e,n.m+=e,e+=n.s+(r+=n.c)}(n);var o=(e[0].z+e[e.length-1].z)/2;i?(n.z=i.z+t(n._,i._),n.m=n.z-o):n.z=o}else i&&(n.z=i.z+t(n._,i._));n.parent.A=function(n,e,r){if(e){for(var i,o=n,a=n,u=e,c=o.parent.children[0],f=o.m,s=a.m,l=u.m,h=c.m;u=sh(u),o=fh(o),u&&o;)c=fh(c),(a=sh(a)).a=n,(i=u.z+l-o.z-f+t(u._,o._))>0&&(lh(hh(u,n,r),n,i),f+=i,s+=i),l+=u.m,f+=o.m,h+=c.m,s+=a.m;u&&!sh(a)&&(a.t=u,a.m+=l-s),o&&!fh(c)&&(c.t=o,c.m+=f-h,r=n)}return r}(n,i,n.parent.A||r[0])}function a(t){t._.x=t.z+t.parent.m,t.m+=t.parent.m}function u(t){t.x*=n,t.y=t.depth*e}return i.separation=function(n){return arguments.length?(t=n,i):t},i.size=function(t){return arguments.length?(r=!1,n=+t[0],e=+t[1],i):r?null:[n,e]},i.nodeSize=function(t){return arguments.length?(r=!0,n=+t[0],e=+t[1],i):r?[n,e]:null},i},t.treemap=function(){var t=yh,n=!1,e=1,r=1,i=[0],o=Wl,a=Wl,u=Wl,c=Wl,f=Wl;function s(t){return t.x0=t.y0=0,t.x1=e,t.y1=r,t.eachBefore(l),i=[0],n&&t.eachBefore(nh),t}function l(n){var e=i[n.depth],r=n.x0+e,s=n.y0+e,l=n.x1-e,h=n.y1-e;l<r&&(r=l=(r+l)/2),h<s&&(s=h=(s+h)/2),n.x0=r,n.y0=s,n.x1=l,n.y1=h,n.children&&(e=i[n.depth+1]=o(n)/2,r+=f(n)-e,s+=a(n)-e,(l-=u(n)-e)<r&&(r=l=(r+l)/2),(h-=c(n)-e)<s&&(s=h=(s+h)/2),t(n,r,s,l,h))}return s.round=function(t){return arguments.length?(n=!!t,s):n},s.size=function(t){return arguments.length?(e=+t[0],r=+t[1],s):[e,r]},s.tile=function(n){return arguments.length?(t=$l(n),s):t},s.padding=function(t){return arguments.length?s.paddingInner(t).paddingOuter(t):s.paddingInner()},s.paddingInner=function(t){return arguments.length?(o="function"==typeof t?t:Zl(+t),s):o},s.paddingOuter=function(t){return arguments.length?s.paddingTop(t).paddingRight(t).paddingBottom(t).paddingLeft(t):s.paddingTop()},s.paddingTop=function(t){return arguments.length?(a="function"==typeof t?t:Zl(+t),s):a},s.paddingRight=function(t){return arguments.length?(u="function"==typeof t?t:Zl(+t),s):u},s.paddingBottom=function(t){return arguments.length?(c="function"==typeof t?t:Zl(+t),s):c},s.paddingLeft=function(t){return arguments.length?(f="function"==typeof t?t:Zl(+t),s):f},s},t.treemapBinary=function(t,n,e,r,i){var o,a,u=t.children,c=u.length,f=new Array(c+1);for(f[0]=a=o=0;o<c;++o)f[o+1]=a+=u[o].value;!function t(n,e,r,i,o,a,c){if(n>=e-1){var s=u[n];return s.x0=i,s.y0=o,s.x1=a,void(s.y1=c)}for(var l=f[n],h=r/2+l,d=n+1,p=e-1;d<p;){var v=d+p>>>1;f[v]<h?d=v+1:p=v}h-f[d-1]<f[d]-h&&n+1<d&&--d;var g=f[d]-l,y=r-g;if(a-i>c-o){var _=(i*y+a*g)/r;t(n,d,g,i,o,_,c),t(d,e,y,_,o,a,c)}else{var b=(o*y+c*g)/r;t(n,d,g,i,o,a,b),t(d,e,y,i,b,a,c)}}(0,c,t.value,n,e,r,i)},t.treemapDice=eh,t.treemapResquarify=_h,t.treemapSlice=ph,t.treemapSliceDice=function(t,n,e,r,i){(1&t.depth?ph:eh)(t,n,e,r,i)},t.treemapSquarify=yh,t.tsv=sa,t.tsvFormat=Ko,t.tsvFormatBody=Jo,t.tsvFormatRow=na,t.tsvFormatRows=ta,t.tsvFormatValue=ea,t.tsvParse=Zo,t.tsvParseRows=Qo,t.utcDay=Wd,t.utcDays=Zd,t.utcFriday=rp,t.utcFridays=sp,t.utcHour=Gd,t.utcHours=$d,t.utcMillisecond=pd,t.utcMilliseconds=vd,t.utcMinute=Xd,t.utcMinutes=Vd,t.utcMonday=Jd,t.utcMondays=ap,t.utcMonth=hp,t.utcMonths=dp,t.utcSaturday=ip,t.utcSaturdays=lp,t.utcSecond=_d,t.utcSeconds=bd,t.utcSunday=Kd,t.utcSundays=op,t.utcThursday=ep,t.utcThursdays=fp,t.utcTuesday=tp,t.utcTuesdays=up,t.utcWednesday=np,t.utcWednesdays=cp,t.utcWeek=Kd,t.utcWeeks=op,t.utcYear=pp,t.utcYears=vp,t.values=function(t){var n=[];for(var e in t)n.push(t[e]);return n},t.variance=c,t.version="5.16.0",t.voronoi=function(){var t=sb,n=lb,e=null;function r(r){return new Vb(r.map(function(e,i){var o=[Math.round(t(e,i,r)/Ib)*Ib,Math.round(n(e,i,r)/Ib)*Ib];return o.index=i,o.data=e,o}),e)}return r.polygons=function(t){return r(t).polygons()},r.links=function(t){return r(t).links()},r.triangles=function(t){return r(t).triangles()},r.x=function(n){return arguments.length?(t="function"==typeof n?n:fb(+n),r):t},r.y=function(t){return arguments.length?(n="function"==typeof t?t:fb(+t),r):n},r.extent=function(t){return arguments.length?(e=null==t?null:[[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]],r):e&&[[e[0][0],e[0][1]],[e[1][0],e[1][1]]]},r.size=function(t){return arguments.length?(e=null==t?null:[[0,0],[+t[0],+t[1]]],r):e&&[e[1][0]-e[0][0],e[1][1]-e[0][1]]},r},t.window=ct,t.xml=da,t.zip=function(){return k(arguments)},t.zoom=function(){var n,e,r=tm,i=nm,o=om,a=rm,u=im,c=[0,1/0],f=[[-1/0,-1/0],[1/0,1/0]],s=250,l=Ie,h=I("start","zoom","end"),d=500,p=150,v=0;function g(t){t.property("__zoom",em).on("wheel.zoom",M).on("mousedown.zoom",N).on("dblclick.zoom",T).filter(u).on("touchstart.zoom",A).on("touchmove.zoom",S).on("touchend.zoom touchcancel.zoom",k).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function y(t,n){return(n=Math.max(c[0],Math.min(c[1],n)))===t.k?t:new Wb(n,t.x,t.y)}function _(t,n,e){var r=n[0]-e[0]*t.k,i=n[1]-e[1]*t.k;return r===t.x&&i===t.y?t:new Wb(t.k,r,i)}function b(t){return[(+t[0][0]+ +t[1][0])/2,(+t[0][1]+ +t[1][1])/2]}function m(t,n,e){t.on("start.zoom",function(){x(this,arguments).start()}).on("interrupt.zoom end.zoom",function(){x(this,arguments).end()}).tween("zoom",function(){var t=this,r=arguments,o=x(t,r),a=i.apply(t,r),u=null==e?b(a):"function"==typeof e?e.apply(t,r):e,c=Math.max(a[1][0]-a[0][0],a[1][1]-a[0][1]),f=t.__zoom,s="function"==typeof n?n.apply(t,r):n,h=l(f.invert(u).concat(c/f.k),s.invert(u).concat(c/s.k));return function(t){if(1===t)t=s;else{var n=h(t),e=c/n[2];t=new Wb(e,u[0]-n[0]*e,u[1]-n[1]*e)}o.zoom(null,t)}})}function x(t,n,e){return!e&&t.__zooming||new w(t,n)}function w(t,n){this.that=t,this.args=n,this.active=0,this.extent=i.apply(t,n),this.taps=0}function M(){if(r.apply(this,arguments)){var t=x(this,arguments),n=this.__zoom,e=Math.max(c[0],Math.min(c[1],n.k*Math.pow(2,a.apply(this,arguments)))),i=Bt(this);if(t.wheel)t.mouse[0][0]===i[0]&&t.mouse[0][1]===i[1]||(t.mouse[1]=n.invert(t.mouse[0]=i)),clearTimeout(t.wheel);else{if(n.k===e)return;t.mouse=[i,n.invert(i)],Pr(this),t.start()}Jb(),t.wheel=setTimeout(function(){t.wheel=null,t.end()},p),t.zoom("mouse",o(_(y(n,e),t.mouse[0],t.mouse[1]),t.extent,f))}}function N(){if(!e&&r.apply(this,arguments)){var n=x(this,arguments,!0),i=Rt(t.event.view).on("mousemove.zoom",function(){if(Jb(),!n.moved){var e=t.event.clientX-u,r=t.event.clientY-c;n.moved=e*e+r*r>v}n.zoom("mouse",o(_(n.that.__zoom,n.mouse[0]=Bt(n.that),n.mouse[1]),n.extent,f))},!0).on("mouseup.zoom",function(){i.on("mousemove.zoom mouseup.zoom",null),jt(t.event.view,n.moved),Jb(),n.end()},!0),a=Bt(this),u=t.event.clientX,c=t.event.clientY;Ht(t.event.view),Kb(),n.mouse=[a,this.__zoom.invert(a)],Pr(this),n.start()}}function T(){if(r.apply(this,arguments)){var n=this.__zoom,e=Bt(this),a=n.invert(e),u=n.k*(t.event.shiftKey?.5:2),c=o(_(y(n,u),e,a),i.apply(this,arguments),f);Jb(),s>0?Rt(this).transition().duration(s).call(m,c,e):Rt(this).call(g.transform,c)}}function A(){if(r.apply(this,arguments)){var e,i,o,a,u=t.event.touches,c=u.length,f=x(this,arguments,t.event.changedTouches.length===c);for(Kb(),i=0;i<c;++i)a=[a=Ft(this,u,(o=u[i]).identifier),this.__zoom.invert(a),o.identifier],f.touch0?f.touch1||f.touch0[2]===a[2]||(f.touch1=a,f.taps=0):(f.touch0=a,e=!0,f.taps=1+!!n);n&&(n=clearTimeout(n)),e&&(f.taps<2&&(n=setTimeout(function(){n=null},d)),Pr(this),f.start())}}function S(){if(this.__zooming){var e,r,i,a,u=x(this,arguments),c=t.event.changedTouches,s=c.length;for(Jb(),n&&(n=clearTimeout(n)),u.taps=0,e=0;e<s;++e)i=Ft(this,c,(r=c[e]).identifier),u.touch0&&u.touch0[2]===r.identifier?u.touch0[0]=i:u.touch1&&u.touch1[2]===r.identifier&&(u.touch1[0]=i);if(r=u.that.__zoom,u.touch1){var l=u.touch0[0],h=u.touch0[1],d=u.touch1[0],p=u.touch1[1],v=(v=d[0]-l[0])*v+(v=d[1]-l[1])*v,g=(g=p[0]-h[0])*g+(g=p[1]-h[1])*g;r=y(r,Math.sqrt(v/g)),i=[(l[0]+d[0])/2,(l[1]+d[1])/2],a=[(h[0]+p[0])/2,(h[1]+p[1])/2]}else{if(!u.touch0)return;i=u.touch0[0],a=u.touch0[1]}u.zoom("touch",o(_(r,i,a),u.extent,f))}}function k(){if(this.__zooming){var n,r,i=x(this,arguments),o=t.event.changedTouches,a=o.length;for(Kb(),e&&clearTimeout(e),e=setTimeout(function(){e=null},d),n=0;n<a;++n)r=o[n],i.touch0&&i.touch0[2]===r.identifier?delete i.touch0:i.touch1&&i.touch1[2]===r.identifier&&delete i.touch1;if(i.touch1&&!i.touch0&&(i.touch0=i.touch1,delete i.touch1),i.touch0)i.touch0[1]=this.__zoom.invert(i.touch0[0]);else if(i.end(),2===i.taps){var u=Rt(this).on("dblclick.zoom");u&&u.apply(this,arguments)}}}return g.transform=function(t,n,e){var r=t.selection?t.selection():t;r.property("__zoom",em),t!==r?m(t,n,e):r.interrupt().each(function(){x(this,arguments).start().zoom(null,"function"==typeof n?n.apply(this,arguments):n).end()})},g.scaleBy=function(t,n,e){g.scaleTo(t,function(){var t=this.__zoom.k,e="function"==typeof n?n.apply(this,arguments):n;return t*e},e)},g.scaleTo=function(t,n,e){g.transform(t,function(){var t=i.apply(this,arguments),r=this.__zoom,a=null==e?b(t):"function"==typeof e?e.apply(this,arguments):e,u=r.invert(a),c="function"==typeof n?n.apply(this,arguments):n;return o(_(y(r,c),a,u),t,f)},e)},g.translateBy=function(t,n,e){g.transform(t,function(){return o(this.__zoom.translate("function"==typeof n?n.apply(this,arguments):n,"function"==typeof e?e.apply(this,arguments):e),i.apply(this,arguments),f)})},g.translateTo=function(t,n,e,r){g.transform(t,function(){var t=i.apply(this,arguments),a=this.__zoom,u=null==r?b(t):"function"==typeof r?r.apply(this,arguments):r;return o(Zb.translate(u[0],u[1]).scale(a.k).translate("function"==typeof n?-n.apply(this,arguments):-n,"function"==typeof e?-e.apply(this,arguments):-e),t,f)},r)},w.prototype={start:function(){return 1==++this.active&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(t,n){return this.mouse&&"mouse"!==t&&(this.mouse[1]=n.invert(this.mouse[0])),this.touch0&&"touch"!==t&&(this.touch0[1]=n.invert(this.touch0[0])),this.touch1&&"touch"!==t&&(this.touch1[1]=n.invert(this.touch1[0])),this.that.__zoom=n,this.emit("zoom"),this},end:function(){return 0==--this.active&&(delete this.that.__zooming,this.emit("end")),this},emit:function(t){kt(new $b(g,t,this.that.__zoom),h.apply,h,[t,this.that,this.args])}},g.wheelDelta=function(t){return arguments.length?(a="function"==typeof t?t:Gb(+t),g):a},g.filter=function(t){return arguments.length?(r="function"==typeof t?t:Gb(!!t),g):r},g.touchable=function(t){return arguments.length?(u="function"==typeof t?t:Gb(!!t),g):u},g.extent=function(t){return arguments.length?(i="function"==typeof t?t:Gb([[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]]),g):i},g.scaleExtent=function(t){return arguments.length?(c[0]=+t[0],c[1]=+t[1],g):[c[0],c[1]]},g.translateExtent=function(t){return arguments.length?(f[0][0]=+t[0][0],f[1][0]=+t[1][0],f[0][1]=+t[0][1],f[1][1]=+t[1][1],g):[[f[0][0],f[0][1]],[f[1][0],f[1][1]]]},g.constrain=function(t){return arguments.length?(o=t,g):o},g.duration=function(t){return arguments.length?(s=+t,g):s},g.interpolate=function(t){return arguments.length?(l=t,g):l},g.on=function(){var t=h.on.apply(h,arguments);return t===h?g:t},g.clickDistance=function(t){return arguments.length?(v=(t=+t)*t,g):Math.sqrt(v)},g},t.zoomIdentity=Zb,t.zoomTransform=Qb,Object.defineProperty(t,"__esModule",{value:!0})});


if (window) window.__currentScriptPath = "/framework/common/timezone-providers.js";

var TimezoneProviders = (function () {
    var localTimezoneProvider = {
        registerListener: function (listener) {},
        available: function () {
            return true;
        },
        getTimezoneId: function () {
            if (typeof(moment) == "undefined") return "UTC";
            return moment && moment.tz ? moment.tz.guess() : "UTC";
        },
        getName: function () {
            return "Local timezone";
        },
        isImplicit: function () {
            return true;
        }
    };

    var teamTimezoneProvider = {
        registerListener: function (listener) {},
        available: function () {
            return TIMEZONES && TIMEZONES.team;
        },
        getTimezoneId: function () {
            return TIMEZONES.team;
        },
        getName: function () {
            return SERVER_FLAVOR && SERVER_FLAVOR != "SO" ? "Org timezone" : "Team timezone";
        }
    };

    var serverTimezoneProvider = {
        registerListener: function (listener) {},
        available: function () {
            return TIMEZONES && TIMEZONES.server;
        },
        getTimezoneId: function () {
            return TIMEZONES.server;
        },
        getName: function () {
            return "Server timezone";
        }
    };

    var AUTO_TZ_ORDERS = ["team", "local", "server"];
    var autoTimezoneProvider = {
        _find: function () {
            for (var i = 0; i < AUTO_TZ_ORDERS.length; i ++) {
                var provider = TimezoneProviders[AUTO_TZ_ORDERS[i]];
                if (provider.available()) return provider;
            }

            return null;
        },
        registerListener: function (listener) {
            this._find().registerListener(listener);
        },
        available: function () {
            return true;
        },
        getTimezoneId: function () {
            return this._find().getTimezoneId();
        },
        getName: function () {
            return this._find().getName();
        }
    };

    function findWidgetBasedTimezoneProvider(node) {
        if (!node) return null;
        var container = node.parentNode;
        while (container) {
            var widget = container.querySelector(".widget_TimezonePicker");
            if (widget && widget.__widget && widget.__widget._getTimezoneProvider) {
                return widget.__widget._getTimezoneProvider();
            }

            container = (container == document.body) ? null : container.parentNode;
        }

        return null;
    }

    if (typeof(window) != "undefined") {
        window.addEventListener("load", function () {
            document.cookie = "X_Rio_Client_TimeZone=" + encodeURIComponent(localTimezoneProvider.getTimezoneId()) + ";path=/";
        });
    }

    return {
        local: localTimezoneProvider,
        team: teamTimezoneProvider,
        server: serverTimezoneProvider,
        auto: autoTimezoneProvider,
        findWidgetBasedTimezoneProvider: findWidgetBasedTimezoneProvider
    };
})();


if (window) window.__currentScriptPath = "/framework/common/TeamLocalizer.js";

var TeamLocalizer = (function(context) {

    function loadTeamLocaleData() { }

    function getString(key, defaultValue) {
        if (!context.LOCALE_RAW_DATA) return defaultValue || key;
        return context.LOCALE_RAW_DATA[key] || defaultValue || key;
    }
    
    return {
        reload: loadTeamLocaleData,
        getString: getString
    };
}) (typeof(window) != "undefined" ? window : (typeof(_workerGlobal) != "undefined" ? _workerGlobal : {}));

var FormatUtil = (function (context) {
    function javaToMomentFormat(javaFormat) {
        var momentFormat = javaFormat.replace(/([^ :\/\,\-T]+)/g, function (zero, term) {
            if (term == "dd") return "DD";
            if (term == "d") return "D";
            if (term == "y") return "Y";
            if (term == "yy") return "YY";
            if (term == "yyyy") return "YYYY";
            if (term == "h") return "hh";
            if (term == "EEE") return "ddd";
            if (term == "EEEE") return "dddd";
            return term;
        });
        return momentFormat;
    }
    
    function formatDate(date, formatName, timezoneProviderName) {
        if (!date) return "";
        var format = context.DATE_FORMATS[formatName].format;
        var tzId = TimezoneProviders[timezoneProviderName].getTimezoneId();
        
        return moment.tz(date, tzId).format(javaToMomentFormat(format));
    }
    
    function formatDateWithTZID(date, formatName, tzId) {
        var format = context.DATE_FORMATS[formatName].format;
        return moment.tz(date, tzId).format(javaToMomentFormat(format));
    }
    function getFormatDescription(formatName) {
        return DATE_FORMATS[formatName].description;
    }
    
    function isDateInputValid(input, formatName) {
        var format = context.DATE_FORMATS[formatName].format;
        return moment(input, javaToMomentFormat(format), true).isValid();
    }
    
    function testDateFormat() {
        var date = new Date();
        var s = "<table border=\"1\" cellspacing=\"0\" cellpadding=\"2\"><thead><tr><th>Name</th><th>JAVA</th><th>Moment</th><th>Server</th><th>Team</th><th>Local</th></tr></thead>\n<tbody>";
        for (var name in DATE_FORMATS) {
            var javaFormat = DATE_FORMATS[name].format;
            var momentFormat = javaToMomentFormat(javaFormat);
            
            s += "<tr>";
            s += "<td>" + name + "</td>";
            s += "<td>" + javaFormat + "</td>";
            s += "<td>" + momentFormat + "</td>";
            s += "<td>" + formatDate(date, name, "server") + "</td>";
            s += "<td>" + formatDate(date, name, "team") + "</td>";
            s += "<td>" + formatDate(date, name, "local") + "</td>";
            s += "</tr>\n";
        }
        
        s += "</tbody>\n</table>\n";
        
        var div = document.createElement("div");
        div.style.position = "absolute";
        div.style.top = "0px";
        div.style.left = "0px";
        div.style.backgroundColor = "#FFF";
        div.style.padding = "1em";
        
        div.innerHTML = s;
        
        document.body.appendChild(div);
    }
    
    function term(t) {
        if (typeof(TERMINOLOGY_DATA) == "undefined") return t;
        return TERMINOLOGY_DATA[t] || t;
    }
    
    // window.addEventListener("load", testDateFormat, false);
    
    return {
        formatDate: formatDate,
        javaToMomentFormat: javaToMomentFormat,
        formatDateWithTZID: formatDateWithTZID,
        getFormatDescription: getFormatDescription,
        isDateInputValid: isDateInputValid,
        testDateFormat: testDateFormat,
        term: term
    };
})(typeof(window) != "undefined" ? window : (typeof(_workerGlobal) != "undefined" ? _workerGlobal : {}));

if (window) window.__currentScriptPath = "/framework/common/StateFinder.js";

var StateFinder = (function(context) {

    function findStateByPostalCode(postalCode) {
        // Ensure param is a string to prevent unpredictable parsing results
        if (typeof postalCode !== 'string') {
            console.log('Must pass the postal code as a string.');
            return null;
        }

        // Ensure we have exactly 5 characters to parse
        if (postalCode.length !== 5) {
            console.log('Must pass a 5-digit postal code.');
            return null;
        }

        // Ensure we don't parse strings starting with 0 as octal values
        var postalNumber = parseInt(postalCode, 10);

        var abbr = null;
        var state = null;

        // Code blocks alphabetized by state
        if (postalNumber >= 35000 && postalNumber <= 36999) {
            abbr = 'AL';
            state = 'Alabama';
        }
        else if (postalNumber >= 99500 && postalNumber <= 99999) {
            abbr = 'AK';
            state = 'Alaska';
        }
        else if (postalNumber >= 85000 && postalNumber <= 86999) {
            abbr = 'AZ';
            state = 'Arizona';
        }
        else if (postalNumber >= 71600 && postalNumber <= 72999) {
            abbr = 'AR';
            state = 'Arkansas';
        }
        else if (postalNumber >= 90000 && postalNumber <= 96699) {
            abbr = 'CA';
            state = 'California';
        }
        else if (postalNumber >= 80000 && postalNumber <= 81999) {
            abbr = 'CO';
            state = 'Colorado';
        }
        else if (postalNumber >= 6000 && postalNumber <= 6999) {
            abbr = 'CT';
            state = 'Connecticut';
        }
        else if (postalNumber >= 19700 && postalNumber <= 19999) {
            abbr = 'DE';
            state = 'Delaware';
        }
        else if (postalNumber >= 32000 && postalNumber <= 34999) {
            abbr = 'FL';
            state = 'Florida';
        }
        else if (postalNumber >= 30000 && postalNumber <= 31999) {
            abbr = 'GA';
            state = 'Georgia';
        }
        else if (postalNumber >= 96700 && postalNumber <= 96999) {
            abbr = 'HI';
            state = 'Hawaii';
        }
        else if (postalNumber >= 83200 && postalNumber <= 83999) {
            abbr = 'ID';
            state = 'Idaho';
        }
        else if (postalNumber >= 60000 && postalNumber <= 62999) {
            abbr = 'IL';
            state = 'Illinois';
        }
        else if (postalNumber >= 46000 && postalNumber <= 47999) {
            abbr = 'IN';
            state = 'Indiana';
        }
        else if (postalNumber >= 50000 && postalNumber <= 52999) {
            abbr = 'IA';
            state = 'Iowa';
        }
        else if (postalNumber >= 66000 && postalNumber <= 67999) {
            abbr = 'KS';
            state = 'Kansas';
        }
        else if (postalNumber >= 40000 && postalNumber <= 42999) {
            abbr = 'KY';
            state = 'Kentucky';
        }
        else if (postalNumber >= 70000 && postalNumber <= 71599) {
            abbr = 'LA';
            state = 'Louisiana';
        }
        else if (postalNumber >= 3900 && postalNumber <= 4999) {
            abbr = 'ME';
            state = 'Maine';
        }
        else if (postalNumber >= 20600 && postalNumber <= 21999) {
            abbr = 'MD';
            state = 'Maryland';
        }
        else if (postalNumber >= 1000 && postalNumber <= 2799) {
            abbr = 'MA';
            state = 'Massachusetts';
        }
        else if (postalNumber >= 48000 && postalNumber <= 49999) {
            abbr = 'MI';
            state = 'Michigan';
        }
        else if (postalNumber >= 55000 && postalNumber <= 56999) {
            abbr = 'MN';
            state = 'Minnesota';
        }
        else if (postalNumber >= 38600 && postalNumber <= 39999) {
            abbr = 'MS';
            state = 'Mississippi';
        }
        else if (postalNumber >= 63000 && postalNumber <= 65999) {
            abbr = 'MO';
            state = 'Missouri';
        }
        else if (postalNumber >= 59000 && postalNumber <= 59999) {
            abbr = 'MT';
            state = 'Montana';
        }
        else if (postalNumber >= 27000 && postalNumber <= 28999) {
            abbr = 'NC';
            state = 'North Carolina';
        }
        else if (postalNumber >= 58000 && postalNumber <= 58999) {
            abbr = 'ND';
            state = 'North Dakota';
        }
        else if (postalNumber >= 68000 && postalNumber <= 69999) {
            abbr = 'NE';
            state = 'Nebraska';
        }
        else if (postalNumber >= 88900 && postalNumber <= 89999) {
            abbr = 'NV';
            state = 'Nevada';
        }
        else if (postalNumber >= 3000 && postalNumber <= 3899) {
            abbr = 'NH';
            state = 'New Hampshire';
        }
        else if (postalNumber >= 7000 && postalNumber <= 8999) {
            abbr = 'NJ';
            state = 'New Jersey';
        }
        else if (postalNumber >= 87000 && postalNumber <= 88499) {
            abbr = 'NM';
            state = 'New Mexico';
        }
        else if (postalNumber >= 10000 && postalNumber <= 14999) {
            abbr = 'NY';
            state = 'New York';
        }
        else if (postalNumber >= 43000 && postalNumber <= 45999) {
            abbr = 'OH';
            state = 'Ohio';
        }
        else if (postalNumber >= 73000 && postalNumber <= 74999) {
            abbr = 'OK';
            state = 'Oklahoma';
        }
        else if (postalNumber >= 97000 && postalNumber <= 97999) {
            abbr = 'OR';
            state = 'Oregon';
        }
        else if (postalNumber >= 15000 && postalNumber <= 19699) {
            abbr = 'PA';
            state = 'Pennsylvania';
        }
        else if (postalNumber >= 300 && postalNumber <= 999) {
            abbr = 'PR';
            state = 'Puerto Rico';
        }
        else if (postalNumber >= 2800 && postalNumber <= 2999) {
            abbr = 'RI';
            state = 'Rhode Island';
        }
        else if (postalNumber >= 29000 && postalNumber <= 29999) {
            abbr = 'SC';
            state = 'South Carolina';
        }
        else if (postalNumber >= 57000 && postalNumber <= 57999) {
            abbr = 'SD';
            state = 'South Dakota';
        }
        else if (postalNumber >= 37000 && postalNumber <= 38599) {
            abbr = 'TN';
            state = 'Tennessee';
        }
        else if ( (postalNumber >= 75000 && postalNumber <= 79999) || (postalNumber >= 88500 && postalNumber <= 88599) ) {
            abbr = 'TX';
            state = 'Texas';
        }
        else if (postalNumber >= 84000 && postalNumber <= 84999) {
            abbr = 'UT';
            state = 'Utah';
        }
        else if (postalNumber >= 5000 && postalNumber <= 5999) {
            abbr = 'VT';
            state = 'Vermont';
        }
        else if (postalNumber >= 22000 && postalNumber <= 24699) {
            abbr = 'VA';
            state = 'Virgina';
        }
        else if (postalNumber >= 20000 && postalNumber <= 20599) {
            abbr = 'DC';
            state = 'Washington DC';
        }
        else if (postalNumber >= 98000 && postalNumber <= 99499) {
            abbr = 'WA';
            state = 'Washington';
        }
        else if (postalNumber >= 24700 && postalNumber <= 26999) {
            abbr = 'WV';
            state = 'West Virginia';
        }
        else if (postalNumber >= 53000 && postalNumber <= 54999) {
            abbr = 'WI';
            state = 'Wisconsin';
        }
        else if (postalNumber >= 82000 && postalNumber <= 83199) {
            abbr = 'WY';
            state = 'Wyoming';
        }

        if (!abbr || !state) return null;
        return {
            postalCode: postalCode,
            stateName: state,
            stateAbbr: abbr
        };
    }

    return {
        findStateByPostalCode: findStateByPostalCode
    };
}) (typeof(window) != "undefined" ? window : (typeof(_workerGlobal) != "undefined" ? _workerGlobal : {}));


if (window) window.__currentScriptPath = "/framework/common/permission-utils.js";

var PermissionUtils = (function () {
    
    function getCheckedAccountInfo(accountInfo) {
        if (accountInfo) return accountInfo;
        return getCurrentLoginAccountInfo();
    }
    
    function getCurrentLoginAccountInfo() {
        // try to check and use userSession from AdminConsole.instance first
        var adminConsole = window["AdminConsole"];
        if (adminConsole && adminConsole.instance && adminConsole.instance.userSession) return adminConsole.instance.userSession;
        
        console.warn("PermissionUtils: use ACCOUNT_INFO");
        return window["ACCOUNT_INFO"];
    }
    
    function getPermissionKeysFromArguments(funcArguments, startIndex) {
        startIndex = startIndex || 0;
        if (funcArguments.length <= 0 || funcArguments.length < (startIndex + 1)) return null;
        return Array.isArray(funcArguments[startIndex]) ? funcArguments[startIndex] : Array.prototype.slice.call(funcArguments, startIndex);
    }
    
    function hasAllPermissionsImpl(accountInfo, permissionKeys) {
        if (!permissionKeys || !permissionKeys.length) return true;
        
        if (!accountInfo || !accountInfo.permissionKeys || !accountInfo.permissionKeys.length) return false;
        
        for (let i = 0; i < permissionKeys.length; i++) {
            var permissionKey = permissionKeys[i];
            if (accountInfo.permissionKeys.indexOf(permissionKey) < 0) return false;
        }
        
        return true;
    }
    function hasAllPermissions() { // permissionKeys or ...permissionKeys
        if (arguments.length <= 0) return true;
        return hasAllPermissionsImpl(getCheckedAccountInfo(), getPermissionKeysFromArguments(arguments));
    }
    
    function isAccountWithAllPermissions() { // accountInfo, permissionKeys or ...permissionKeys
        if (arguments.length <= 0) return false;
        var accountInfo = arguments[0];
        return hasAllPermissionsImpl(getCheckedAccountInfo(accountInfo), getPermissionKeysFromArguments(arguments, 1));
    }
    
    function hasAnyPermission() { // permissionKeys or ...permissionKeys
        return isAccountWithAnyPermissionImpl(getCheckedAccountInfo(), getPermissionKeysFromArguments(arguments));
    }
    function isAccountWithAnyPermission() { // accountInfo, permissionKeys or ...permissionKeys
        if (arguments.length <= 0) return false;
        var accountInfo = arguments[0];
        return isAccountWithAnyPermissionImpl(getCheckedAccountInfo(accountInfo), getPermissionKeysFromArguments(arguments, 1));
    }
    function isAccountWithAnyPermissionImpl(accountInfo, permissionKeys) {
        if (!permissionKeys || !permissionKeys.length) return true;
        
        if (!accountInfo || !accountInfo.permissionKeys || !accountInfo.permissionKeys.length) return false;
        
        for (let i = 0; i < permissionKeys.length; i++) {
            var permissionKey = permissionKeys[i];
            if (accountInfo.permissionKeys.indexOf(permissionKey) >= 0) return true;
        }
        
        return false;
    }
    
    function getPermissionDisplayName(key) {
        var description = PERMISSION_DESCRIPTION[key];
        return !description ? key : description.displayName;
    }
    
    function getPermissionRequirementFromString(permissionString, allPermissionKeyMap) {
        if (!permissionString) return {};
        var permissionString = permissionString.trim();
        var permissionKeys = [];
        var requireAllPermissions = true;
        if (permissionString) {
            if (permissionString.indexOf("||") >= 0) {
                permissionKeys = permissionString.split("||");
                requireAllPermissions = false;
            } else {
                permissionKeys = permissionString.split("&&");
            }
        }
        
        if (!allPermissionKeyMap) allPermissionKeyMap = PERMISSION_KEY;
        if (!allPermissionKeyMap || !Object.keys(allPermissionKeyMap).length) {
            console.error("No system permission keys are provided");
            return null;
        }
        
        permissionKeys = permissionKeys.map((key) => { 
            key = key.trim();
            var permissionKey = allPermissionKeyMap[key];
            if (!permissionKey) {
                console.error("Invalid permission key: " + key);
                return key;
            }
            return permissionKey;
        });
        
        return {
            keys: permissionKeys,
            requireAll: requireAllPermissions
        }
    }

    return {
        hasAllPermissions: hasAllPermissions,
        isAccountWithAllPermissions: isAccountWithAllPermissions,
        hasAnyPermission: hasAnyPermission,
        isAccountWithAnyPermission: isAccountWithAnyPermission,
        getPermissionDisplayName: getPermissionDisplayName,
        getPermissionRequirementFromString: getPermissionRequirementFromString,
        getCurrentLoginAccountInfo: getCurrentLoginAccountInfo,
        getCheckedAccountInfo: getCheckedAccountInfo
    }
    
})();


if (window) window.__currentScriptPath = "/framework/common/permission-set-utils.js";

var PermissionSetUtils = (function () {
    
    function _getPermissionKeyCheckFunc(isAllCheck) {
        return isAllCheck ? PermissionUtils.isAccountWithAllPermissions : PermissionUtils.isAccountWithAnyPermission;
    }
    
    function isSatisfiedImpl(key, accountInfo) {
        if (!key) return true;
        var permissionSet = PERMISSION_SET[key];
        if (!permissionSet
            || (!permissionSet.permissionKeys || !permissionSet.permissionKeys.length) && (!permissionSet.permissionSetKeys || !permissionSet.permissionSetKeys.length)) return true;
        if (!accountInfo || !accountInfo.permissionKeys || !accountInfo.permissionKeys.length) return false;
        
        var satisfied = true;
        var setType = permissionSet.type;
        var isAllCheck = permissionSet.type == "ALL";
        if (permissionSet.permissionKeys && permissionSet.permissionKeys.length) {
            var permissionKeyCheckFunc = _getPermissionKeyCheckFunc(isAllCheck);
            satisfied = permissionKeyCheckFunc(accountInfo, ...permissionSet.permissionKeys);
            
            if (isAllCheck && !satisfied) return false;
            if (!isAllCheck && satisfied) return true;
        }
        
        for (var childSetKey of permissionSet.permissionSetKeys) {
            var childSatisfied = isSatisfiedImpl(childSetKey, accountInfo);
            
            satisfied = isAllCheck ? satisfied && childSatisfied : satisfied || childSatisfied;
            
            if (isAllCheck && !satisfied) return false;
            if (!isAllCheck && satisfied) return true;
        }
        
        return satisfied;
    }
    

    function isSatisfied(key, accountInfo) {
        var checkedAccountInfo = PermissionUtils.getCheckedAccountInfo(accountInfo);
        return isSatisfiedImpl(key, checkedAccountInfo);
    }
    
    return {
        isSatisfied: isSatisfied
    }
    
})();


if (window) window.__currentScriptPath = "/framework/common/ReflectUtil.js";

ReflectUtil = (function (context) {
    function setProperty(object, propertyKey, propertyValue, unmodified) {
        Reflect.deleteProperty(object, propertyKey);
        object[propertyKey] = propertyValue;
        if (unmodified) freezeProperty(object, propertyKey, propertyValue);
    }

    function freezeProperty(object, propertyKey, propertyValue) {
        propertyValue = typeof propertyValue !== "undefined" ? propertyValue : object[propertyKey];
        Reflect.defineProperty(object, propertyKey, {
            configurable: true,
            writable: false,
            value: propertyValue,
        });
    }

    function wrapFunction(fn, shouldCall) {
        if (!fn) return fn;
        var original = fn;
        var checkers = [];

        if (fn._isWrapper) {
            original = fn._orginal;
            checkers = fn._checkers;
        }

        if (typeof shouldCall == "function" && checkers.indexOf(shouldCall) < 0) {
            checkers.push(shouldCall);
        }
        var wrapper = function () {
            var args = Array.from(arguments);
            if (checkers.length) {
                if (checkers.every((checker) => checker(args))) {
                    return Reflect.apply(original, this, args);
                }
            } else {
                return Reflect.apply(original, this, args);
            }
        };
        wrapper._isWrapper = true;
        wrapper._orginal = original;
        wrapper._checkers = checkers;
        return wrapper;
    };

    function getFunction(fn) {
        return fn._isWrapper ? fn._orginal : fn;
    };

    function wrapFunctionWith(fn, before, skipIfBeforeFails, after) {
        if (!fn) return fn;

        var wrapper = function () {
            var args = Array.from(arguments);
            try {
                if (before && typeof before == "function") {
                    var beforeResult = before.apply(this, args);
                    if (!skipIfBeforeFails && !beforeResult) return;
                }
            } catch (error) {
                console.error("Error in before function:", error);
            }

            var result = Reflect.apply(fn, this, args);

            try {
                if (after && typeof after == "function") {
                    return after.call(this, result);
                }
            } catch (error) {
                console.error("Error in after function:", error);
            }

            return result;
        };
        wrapper._isWrapper = true;
        wrapper._orginal = fn;
        return wrapper;
    };

    function deepFreeze(object) {
        var propKeys = Reflect.ownKeys(object);
        for (var key of propKeys) {
            var value = Reflect.get(object, key);
            if (typeof value === "object" && value !== null) {
                ReflectUtil.deepFreeze(value);
            }
            Reflect.defineProperty(object, key, {
                configurable: false,
                writable: false,
                value,
            });
        }
        return object;
    };

    return {
        setProperty: setProperty,
        freezeProperty: freezeProperty,
        wrapFunction: wrapFunction,
        wrapFunctionWith: wrapFunctionWith,
        getFunction: getFunction,
        deepFreeze: deepFreeze
    };
})(window);


if (window) window.__currentScriptPath = "/framework/common/ClientPropertyUtil.js";

var ClientPropertyUtil = (function (context) {
    var KEY_ATTRIBUTE = "client-property-code";
    var SELECTOR = `:scope *[${KEY_ATTRIBUTE}]`;
    function invalidateElements(container, specMap, callback) {
        var visitor = function (element, index, elements) {
            var onDone = function () {
                if (index === elements.length - 1) {
                    if (callback) callback();
                }
            };

            var key = element.getAttribute(KEY_ATTRIBUTE);
            var spec = specMap[key];
            if (!spec) {
                onDone();
                return;
            }

            invalidateElement(element, spec, onDone);
        };

        Dom.doOnSelector(container, SELECTOR, visitor);
    }

    function invalidateElement(element, spec, callback) {
        if (element.__invalidated) {
            if (callback) callback();
            return;
        }
        if (spec) {
            var handler = findHandler(element);
            if (handler) {
                handler = new handler(element, spec);
                handler.invalidate();
                element.__invalidated = true;
            }
        }
        if (callback) callback();
    }

    function findHandler(element) {
        var type = getType(element);
        return handlers[type];
    }

    function getType(element) {
        if (element.__widget) {
            var widgetNames = getAllWidgetNames(element);
            for (var i = 0; i < widgetNames.length; i++) {
                var widgetName = widgetNames[i];
                if (handlers[widgetName]) {
                    return widgetName;
                }
            }
        }

        var elementName = element.nodeName.toUpperCase();
        switch (elementName) {
            case "BUTTON":
                return ControlHandler.TYPE;
            case "INPUT":
            case "TEXTAREA":
                return InputHandler.TYPE;
            case "VBOX":
            case "HBOX":
            case "DIV":
                return ContainerHandler.TYPE;
            default:
                return undefined;
        }
    }

    function toggleVisibility(element, visible, unmodified) {
        ReflectUtil.setProperty(element.style, "display", visible ? "" : "none", unmodified);
    }

    function validateElements(container, specs) {
        var visitor = function (valid, element, index) {
            var key = element.getAttribute(KEY_ATTRIBUTE);
            var spec = specs[key];
            if (!spec) {
                return valid;
            }
            return validateElement(element, spec) && valid;
        };
        return Array.prototype.reduce.call(container.querySelectorAll(SELECTOR), visitor, true);
    }

    function validateElement(element, spec) {
        if (!spec) return true;
        var handler = findHandler(element);
        if (!handler) return true;
        handler = new handler(element, spec);
        return handler.validate();
    }

    function __ext() {
        var __base = arguments[0];
        var sub = arguments[1];

        sub.prototype = Object.create(__base.prototype);
        sub.prototype.constructor = sub;
        sub.__base = __base;

        return sub;
    }

    var handlers = {};
    function registerHandler(handler) {
        handlers[handler.TYPE] = handler;
    }

    function BaseHandler(element, spec) {
        this.element = element;
        this.spec = spec;
    }

    BaseHandler.prototype.invalidate = function () {
        this.invalidateVisibility();
        this.invalidateEnableStatus();
    };

    BaseHandler.prototype.validate = function () {
        if (this.spec.required && this.getValue) {
            var rule = new RuleSet()
                .live(true)
                .custom(new GenericRule(this.element, this.getValue.bind(this), this.getRequiredMessage()));
            return ValidationManager.run(rule);
        }
        return true;
    };

    BaseHandler.prototype.getRequiredMessage = function () {
        return "Please enter " + (this.spec.propertyName || "value");
    };

    BaseHandler.prototype.invalidateVisibility = function () {
        var spec = this.spec;
        toggleVisibility(this.element, spec.visible != false, spec.visible == false);
    };

    BaseHandler.prototype.invalidateEnableStatus = function () {};

    function ControlHandler(element, spec) {
        BaseHandler.call(this, element, spec);
    }
    __ext(BaseHandler, ControlHandler);

    ControlHandler.TYPE = "CONTROL";

    ControlHandler.prototype.invalidateEnableStatus = function () {
        var spec = this.spec;
        var disabled = spec.readOnly ? true : false;
        ReflectUtil.setProperty(this.element, "disabled", disabled, disabled);
        if (disabled) {
            this.element.removeAttribute = ReflectUtil.wrapFunction(this.element.removeAttribute, function (args) {
                if (args && args.length > 0 && args.indexOf("disabled") >= 0) return false;
                return true;
            });
        }
    };
    registerHandler(ControlHandler);

    function InputHandler(element, spec) {
        ControlHandler.call(this, element, spec);
    }
    __ext(ControlHandler, InputHandler);

    InputHandler.TYPE = "INPUT";
    InputHandler.prototype.getValue = function () {
        return this.element.value.trim();
    };

    registerHandler(InputHandler);

    function ContainerHandler(element, spec) {
        BaseHandler.call(this, element, spec);
        this.init();
    }
    __ext(BaseHandler, ContainerHandler);

    ContainerHandler.prototype.init = function () {
        var elements = [];
        this.handlers = [];
        var run = (element, spec) => {
            if (elements.indexOf(element) >= 0) return;
            elements.push(element);
            var handler = findHandler(element);
            if (handler && handler != ContainerHandler) {
                this.handlers.push(new handler(element, spec));
            } else {
                if (element.children.length) {
                    Array.prototype.forEach.call(element.children, function (child) {
                        run(child, spec);
                    });
                }
            }
        };
        run(this.element, this.spec);
    };

    ContainerHandler.TYPE = "CONTAINER";

    ContainerHandler.prototype.invalidateEnableStatus = function () {
        var unmodified = this.spec.readOnly ? true : false;
        ReflectUtil.setProperty(this.element.style, "pointerEvents", this.spec.readOnly ? "none" : "", unmodified);
        this.handlers.forEach(function (handler) {
            handler.invalidateEnableStatus();
        });
    };

    ContainerHandler.prototype.validate = function () {
        return this.handlers.reduce(function (valid, handler) {
            return handler.validate() && valid;
        }, true);
    };

    registerHandler(ContainerHandler);

    function BaseWidgetHandler(element, spec) {
        BaseHandler.call(this, element, spec);
        this.widget = element.__widget;
    }
    __ext(BaseHandler, BaseWidgetHandler);

    BaseWidgetHandler.prototype.invalidateEnableStatus = function () {
        if (this.spec.readOnly) {
            this.disableWidget();
        }
    };
    BaseWidgetHandler.prototype.disableWidget = function () {};

    BaseWidgetHandler.prototype.getValue = function () {
        var widget = this.widget;
        if (widget instanceof FileUploadView) {
            var path = widget.getCommaSeparatedStoragePaths();
            return path && path.length > 0 ? path : undefined;
        }

        return widget.getValue ? widget.getValue() : undefined;
    };

    function ComboHandler(element, spec) {
        BaseWidgetHandler.call(this, element, spec);
    }
    __ext(BaseWidgetHandler, ComboHandler);

    ComboHandler.TYPE = ComboManager.name;

    ComboHandler.prototype.disableWidget = function () {
        this.widget.setDisabled(true);
        toggleEnableFunction(this.widget, "setDisabled", false);
    };
    ComboHandler.prototype.getRequiredMessage = function () {
        return "Please select a valid value";
    };
    ComboHandler.prototype.getValue = function () {
        return this.widget.getSelectedItem();
    };

    registerHandler(ComboHandler);

    function DateTimeHandler(element, spec) {
        BaseWidgetHandler.call(this, element, spec);
    }
    __ext(BaseWidgetHandler, DateTimeHandler);

    DateTimeHandler.TYPE = DateTimePicker.name;

    DateTimeHandler.prototype.disableWidget = function () {
        this.widget.setEnabled(false);
        toggleEnableFunction(this.widget, "setEnabled", false);
    };

    DateTimeHandler.prototype.getValue = function () {
        return this.widget.getDate();
    };

    DateTimeHandler.prototype.getRequiredMessage = function () {
        return "Please select a valid date";
    };

    registerHandler(DateTimeHandler);

    function RichTextHandler(element, spec) {
        BaseWidgetHandler.call(this, element, spec);
    }
    __ext(BaseWidgetHandler, RichTextHandler);

    RichTextHandler.TYPE = RichTextEditor.name;

    RichTextHandler.prototype.disableWidget = function () {
        this.widget.setReadOnly(true);
        toggleEnableFunction(this.widget, "setReadOnly", false);
    };
    registerHandler(RichTextHandler);

    function BaseEditorHandler(element, spec) {
        BaseWidgetHandler.call(this, element, spec);
    }
    __ext(BaseWidgetHandler, BaseEditorHandler);

    BaseEditorHandler.TYPE = BaseEditor.name;

    BaseEditorHandler.prototype.disableWidget = function () {
        this.widget.setEnable(false);
        toggleEnableFunction(this.widget, "setEnable", false);
    };
    registerHandler(BaseEditorHandler);
    
    function getAllWidgetNames(element) {
        if (!element.__widget) return [];
        var widgetNames = [];
        var widget = element.__widget.constructor;
        while (widget) {
            widgetNames.push(widget.name);
            widget = widget.__base;
        }
        return widgetNames;
    };
    
    function toggleEnableFunction(widget, fnName, enabled, unmodified) {
        if (!widget instanceof BaseWidget) return;
        if (!fnName) return;

        var fn = widget[fnName];
        if (enabled) {
            fn = ReflectUtil.getFunction(fn);
        } else {
            fn = ReflectUtil.wrapFunction(widget[fnName], () => false);
        }
        ReflectUtil.setProperty(widget, fnName, fn, unmodified);
    }

    function CurrencyInputHandler(element, spec) {
        BaseWidgetHandler.call(this, element, spec);
    };
    __ext(BaseWidgetHandler, CurrencyInputHandler);

    CurrencyInputHandler.TYPE = CurrencyInput.name;

    CurrencyInputHandler.prototype.disableWidget = function (widget) {
        this.widget.setEnable(false);
        toggleEnableFunction(this.widget, "setEnable", false);
    };

    registerHandler(CurrencyInputHandler);

    function initializeWidget(widget, config) {
        if (!widget) return;
        if (!config || !config.propertySpec) return;

        var container = widget instanceof Dialog ? widget.dialogBody : widget.node();
        if (config.invalidation && config.invalidation.enabled) {
            var functionName = widget instanceof Dialog ? "invalidateElements" : "onAttached";

            ReflectUtil.setProperty(
                widget,
                functionName,
                ReflectUtil.wrapFunctionWith(
                    widget[functionName] || function () {},
                    function () {},
                    "skip",
                    function (result) {
                        invalidateElements(container, config.propertySpec);
                        return result;
                    }
                )
            );
        }

        if (config.validation && config.validation.enabled) {
            if (config.validation.functionNames && config.validation.functionNames.length) {
                var before = function () {
                    if (!validateElements(container, config.propertySpec)) {
                        return false;
                    }
                    return true;
                };
                var after = function (result) {
                    if (!validateElements(container, config.propertySpec)) {
                        return false;
                    }
                    return result;
                };
                var BEFORE_INDEX = 1;
                var AFTER_INDEX = 3;
                var run = function (fnName) {
                    var params = [widget[fnName], before, false, after];
                    if (config.validation.afterRun) {
                        params[BEFORE_INDEX] = null;
                        params[BEFORE_INDEX + 1] = null;
                    } else {
                        params[AFTER_INDEX] = null;
                    }
                    ReflectUtil.setProperty(widget, fnName, ReflectUtil.wrapFunctionWith.apply(null, params));
                };
                config.validation.functionNames.forEach(run);
                return;
            }
        }
    }

    var WIDGETS_CACHE = {};
    function preprocessWidget(wg) {
        if (!wg) return;
        if (wg.__getClientPropertyConfig) {
            var config = wg.__getClientPropertyConfig();
            ClientPropertyUtil.initializeWidget(wg, config);
            return;
        }

        if (!wg.__getNamespace) return;
        var ns = wg.__getNamespace();
        var nsHolder = widget.namespaces[ns];
        if (!nsHolder) return;
        var widgetName = `${ns}:${wg.constructor.name}`;

        if (!WIDGETS_CACHE.hasOwnProperty(widgetName)) {
            var template = __TEMPLATE_BUNDLE[wg.getTemplatePath()];
            var codes = findCodesInTemplate(template);
            var propertySpec = (nsHolder.ModuleData && nsHolder.ModuleData.__propertySpec) || {};
            WIDGETS_CACHE[widgetName] = Util.intersect(codes, Object.keys(propertySpec), (a, b) => a == b).length > 0;
        }

        if (!WIDGETS_CACHE[widgetName]) return;

        ClientPropertyUtil.initializeWidget(wg, {
            propertySpec: nsHolder.ModuleData.__propertySpec,
            invalidation: { enabled: true },
        });
    };

    function findCodesInTemplate(template) {
        if (!template || template.length == 0 ) return [];
        var codeRegex = /client-property-code=\"(\w+)\"/g;
        var matches = template.matchAll(codeRegex);
        var codes = [];
        for (const m of matches) {
            var code = m[1];
            if (code && codes.indexOf(code) < 0) {
                codes.push(code);
            }
        }
        return codes;
    };

    return {
        invalidateElements: invalidateElements,
        validateElements: validateElements,
        toggleVisibility: toggleVisibility,
        registerHandler: registerHandler,
        getAllWidgetNames: getAllWidgetNames,
        toggleEnableFunction: toggleEnableFunction,
        initializeWidget: initializeWidget,
        preprocessWidget: preprocessWidget,
    };
})(window);



if (window) window.__currentScriptPath = "/framework/common/ServiceFactory.js";

if (typeof(console) == "undefined") {
    window.console = {
            log: function () {},
            trace: function () {}
    }
}
var ServiceFactory = {};

ServiceFactory._serviceConfigs = {};
ServiceFactory._serviceMeta = {};
ServiceFactory._simulatedClientType = null;
ServiceFactory._simulatedClientFormFactor = null;
ServiceFactory.registerService = function(service, def, meta) {
    ServiceFactory._serviceConfigs[service] = def;
    ServiceFactory._serviceMeta[service] = meta || {};
    window["$" + service] = ServiceFactory.get(service);
};


var _isShowingError = false;
function _handleGenericError(e) {
    console.info("Error: ", e);
    if (_isShowingError) return;
    var message = "Error occured when performing action.";
    if (e && e.message) message = e.message;

    _isShowingError = true;
    Dialog.error("Error", message, function () {
        _isShowingError = false;
    });
}
function showProgress(visible, message) {
    if (message && message.busy && message.done) {
        if (visible) {
            message.busy();
        } else {
            message.done();
        }
    } else {
        if (visible) {
            defaultIndicator.busy(message);
        } else {
            defaultIndicator.done();
        }
    }
}

function pushProgressInfo(info) {

}
function popProgressInfo(info) {

}

var NO_PROGRESS_MESSAGE = "sys:NO_PROGRESS_MESSAGE";
var _GLOBAL_DATE_JSON_PATTERN = /^date\((\-?[0-9]+)\)$/;
function _globalJSONReviver(key, value) {
    if (value && (typeof value == "string") && value.match(_GLOBAL_DATE_JSON_PATTERN)) {
        var time = parseInt(RegExp.$1, 10);
        if (time == -1262304000000) return null; //NOTE: 1/1/1930 00:00:00 GMT is considered as NULL in TU
        return new Date(time);
    }
    return value;
};
function _invoke(service, entry, args, onCool, onFailed, message, options) {
    var invocationOptions = new InvocationOptions({
        service: service,
        entry: entry,
        onCool: onCool,
        onFailed: onFailed,
        message: message,
        options: options
    });
    var request = new XMLHttpRequest();
    request.onreadystatechange = function() {
        if (request.readyState == 4) {
            if (message) showProgress(false, message);
            var js = request.responseText;
            try {
                if (request.status != 200) {
                    if (request.status == 403) {
                        if (ServiceFactory.recoverer) {
                            var errorObject = {
                                code: "",
                                message: request.statusText || js
                            };
                            try {
                                errorObject = JSON.parse(js, _globalJSONReviver);
                            } catch (e) {}

                            ServiceFactory.recoverer(request.status, function (recovered) {
                                if (recovered) {
                                    _invoke(service, entry, args, onCool, onFailed, message);
                                } else {
                                    onFailed(errorObject);
                                }
                            }, errorObject);
                        } else {
                            Dom.emitEvent("p:AuthorizationFailed", document.body, {});
                        }
                        return;
                    }

                    var errorObject = null;
                    if (request.status == 400 && request.getResponseHeader("X-API-Error")) {
                        errorObject = JSON.parse(js, _globalJSONReviver);
                    } else {
                        errorObject = {
                            code: "",
                            message: request.statusText || js
                        }
                    }

                    if (onFailed) onFailed(errorObject);
                    return;
                }

                var response = (js == null || js.length == 0) ? null : JSON.parse(js, _globalJSONReviver);

                var eventContent = request.getResponseHeader("X-Event-Content");

                if (response == null || typeof (response) == "undefined") {
                    try {
                        onCool(null);
                        _fireEvents(eventContent);
                    } catch (er) {
                        console.log("ServiceFactory callback error", er);
                    }
                } else {
                    if (response.error) {
                        if (onFailed) onFailed(response.error);
                    } else {
                        if (options && options.interactive) {
                            var interactiveHeader = request.getResponseHeader("X-Rio-Interactive");
                            if (interactiveHeader == "true") {
                                _handleAsyncResponse(response, invocationOptions);
                                return;
                            }
                        }
                        try {
                            onCool(response, args);
                            _fireEvents(eventContent);
                        } catch (er) {
                            console.log("ServiceFactory callback error", er);
                        }
                    }
                }


            } catch (e) {
                var trace = printStackTrace({e: e});
                console.log('Error!\n' + 'Message: ' + e.message + '\nStack trace:\n' + trace.join('\n'));
                console.log("Error: message = " + e.message + ", fileName: " + e.fileName + ", lineNumber: " + e.lineNumber);
                if (onFailed) {
                    onFailed(e);
                } else {
                    console.log("request failed: " + service + "." + entry);
                    _handleGenericError(e);
                }
            }
        }
    };

    //TODO: refactor the multipart sniffing into using a strong indicator provided by server via API signature analysing
    var upload = false;
    if (args) {
        for (var n in args) if (n.match(/[Ff]ile(s?)$/)) upload = true;
    }

    var body = null;
    if (upload) {
        body = new FormData();
        for (var n in args) {
            if (n.match(/[Ff]ile$/)) { //single file entry
                if (args[n]) body.append(n, args[n], args[n].name);
            } else if (n.match(/[Ff]iles$/)) { //multi-file entry
                var files = args[n];
                if (files && files.forEach) {
                    files.forEach(function (f, index) {
                        body.append(n + "@" + index, f, f.name);
                    });
                }
            } else {
                body.append(n, JSON.stringify(args[n]))
            }
        }
    } else {
        body = "";
        if (args) {
           body = JSON.stringify(args);
        }
    }
    if (message) showProgress(true, message);

    if (request.upload) {
        var progressListener = onCool._uploadProgressed || (message ? message.progressed : null);
        if (progressListener) {
            request.upload.addEventListener("progress", function (e) {
                progressListener(e.loaded, e.total);
            });
        }
    }

    request.open("POST", API_TRANSPORT_URI + "/" + service + "/" + entry, true);
    if (!upload) request.setRequestHeader("Content-Type", "application/json");
    //request.setRequestHeader("Connection", "keep-alive");
    request.setRequestHeader("X-Rio-Client", "JS");
    request.setRequestHeader("X-Rio-Entry", service + "." + entry);
    if (options && options.interactive) {
        request.setRequestHeader("X-Rio-AsyncExpected", "true");
    }

    if (ServiceFactory._simulatedClientType) request.setRequestHeader("X-Client-Platform", ServiceFactory._simulatedClientType);
    if (ServiceFactory._simulatedClientFormFactor) request.setRequestHeader("X-Client-FormFactor", ServiceFactory._simulatedClientFormFactor);

    if (ServiceFactory.requestEnhancer) ServiceFactory.requestEnhancer(request);
    //console.log("xml:" + xml);
    request.send(body);

    return invocationOptions;
}

ServiceFactory.ASYNC_POLLING_INTERVAL = 2000;
function _handleAsyncResponse(workerState, invocationOptions) {

    if (invocationOptions.message) showProgress(true, invocationOptions.message);
    var uuid = workerState.uuid;
    var messageHandlers = invocationOptions.asyncHandler;

    (function checker() {
        //console.log("Checker running...");
        $asyncWorkerManager.getWorkerState(uuid, function (state) {
            //console.log("State", state);
            if (!state) {
                if (invocationOptions.message) showProgress(false, invocationOptions.message);
                return;
            }
            if (state.stateProgress !== undefined) {
                if (invocationOptions.message && invocationOptions.message.progress) invocationOptions.message.progress(state.stateProgress);
            }
            if (state.finished) {
                if (invocationOptions.message) showProgress(false, invocationOptions.message);
                if (state.resultType == "Object") {
                    invocationOptions.onCool(state.resultObject);
                } else if (state.resultType == "Error") {
                    invocationOptions.onFailed(state.errorObject);
                }
            } else {
                if (state.activeMessage) {
                    var f = messageHandlers[state.activeMessage.message.messageName];
                    var reply = function (result) {
                        if (invocationOptions.message) showProgress(true, invocationOptions.message);
                        $asyncWorkerManager.replyMessageRequest(state.uuid, state.activeMessage.uuid, result, function () {});
                        setTimeout(checker, ServiceFactory.ASYNC_POLLING_INTERVAL);
                    }

                    if (!f) {
                        //console.error("Unhandled message", state.activeMessage);
                        reply(null);
                    } else {
                        if (invocationOptions.message) showProgress(false, invocationOptions.message);
                        f(state.activeMessage, state, function (handlerResult) {
                            reply(handlerResult);
                        });
                    }
                } else {
                    setTimeout(checker, ServiceFactory.ASYNC_POLLING_INTERVAL);
                }
            }
        }, function (e) {
            //console.log("getWorkerState error", e);
            if (invocationOptions.message) showProgress(false, invocationOptions.message);
        });
    })();
}

function _fireEvents(eventContent) {
    try {
        if (eventContent == null || typeof(eventContent) == "undefined" || eventContent.length == 0) return;
        var events = JSON.parse(atob(eventContent), _globalJSONReviver);
        if (events) {
            events.forEach(function (event) {
                CommonEvent.fireEvent(event.m, event.n, event.d);
            });
        }
    } catch (er) {
    }
}

function Proxy(name) {
    this._name = name;
    this._meta = ServiceFactory._serviceMeta[name];
}

function InvocationOptions(context) {
    Object.assign(this, context);
}
InvocationOptions.prototype.withAsyncHandler = function (handler) {
    this.asyncHandler = handler;
    return this;
};

function getClazz(obj) {
    if (obj == null || typeof(obj) == "undefined") {
        return "";
    }

    if (obj.clazz) {
      return obj.clazz;
    }

    if (typeof(obj) == "number") {
        return "int"
    }
    if (typeof(obj) == "object" && obj.slice && obj.push) {
        return "list"
    }
    if (typeof(obj) == "object" && obj.getTime) {
        return "date"
    }
    return typeof(obj);
}


ServiceFactory._cache = {};
ServiceFactory._create = function (service) {
    var config = ServiceFactory._serviceConfigs[service];
    if (!config) throw "No service defined for " + service;

    var proxy = new Proxy(service);
    for (var entryName in config) {
        var paramNames = config[entryName];
        proxy[entryName] = ServiceFactory._createEntryFunction(entryName, paramNames);
    }

    return proxy;
}
ServiceFactory._createEntryFunction = function (entryName, paramNames) {
    return function () {
        var options = {
            interactive: this._meta.interactives.indexOf(entryName) >= 0
        };
        var args = {};
        var onFailed = null;
        var onCool = null;
        var message = null;

        var lastArgsPos = 0;

        var len = arguments.length;


        //case #1  (..., function onCool() {}, function onFailed() {}, "message");
        //case #1' (..., function onCool() {}, null,                   "message");
        //which means: all extra params are provided
        if (len >= 3
                && typeof(arguments[len - 3]) == "function"
                && (arguments[len - 2] == null || typeof(arguments[len - 2]) == "function")
                && (typeof(arguments[len - 1]) == "string" || (arguments[len - 1].busy && arguments[len - 1].done))) {
            onCool = arguments[len - 3];
            onFailed = arguments[len - 2];
            message = arguments[len - 1];
            lastArgsPos = len - 4;

        //case #2  (..., function onCool() {}, "message");
        //which means: no onFailed is provided
        } else if (len >= 2
                && (len == 2 || typeof(arguments[len - 3]) != "function")
                && typeof(arguments[len - 2]) == "function"
                && (typeof(arguments[len - 1]) == "string" || (arguments[len - 1].busy && arguments[len - 1].done))) {

            onCool = arguments[len - 2];
            message = arguments[len - 1];
            lastArgsPos = len - 3;

        //case #3  (..., function onCool() {}, function onFailed() {});
        //case #3' (..., function onCool() {}, null                  );
        //which means: no message is provided
        } else if (len >= 2
                && typeof(arguments[len - 2]) == "function"
                && (arguments[len - 1] == null || typeof(arguments[len - 1]) == "function")) {
            onCool = arguments[len - 2];
            onFailed = arguments[len - 1];
            lastArgsPos = len - 3;

        //case #4  (..., function onCool() {});
        //which means: no onFailed and message are provided
        } else if (len >= 1
                && (len == 1 || typeof(arguments[len - 2]) != "function")
                && typeof(arguments[len - 1]) == "function") {

            onCool = arguments[len - 1];
            lastArgsPos = len - 2;
        } else if (len == 0
                || (len > 0 && typeof(arguments[len - 1]) != "function")) {

            onCool = null;
            lastArgsPos = len - 1;
        } else {
            throw "Invalid invocation sigunature.";
        }

        if (lastArgsPos != paramNames.length - 1) throw "Invalid number of arguments.";
        for (var i = 0; i <= lastArgsPos; i ++) {
            args[paramNames[i]] = arguments[i];
        }
        if (!onFailed) {
            if (message && message.failed) {
                onFailed = message.failed;
            } else {
                onFailed = function (e) {
                    if (e && e.message) {
                        _handleGenericError(e);
                    }
                };
            }
        }

        return _invoke(this._name, entryName, args, onCool, onFailed, message, options);
    }
}

ServiceFactory.get = function (service) {
    if (!ServiceFactory._cache[service]) {
        ServiceFactory._cache[service] = ServiceFactory._create(service);
    }

    return ServiceFactory._cache[service];
}

var Services = {};

ServiceFactory.buildFriendlyServiceNames = function () {
    for (name in ServiceFactory._serviceConfigs) {
        Services[name] = ServiceFactory.get(name);

        var simpleName = name;
        var target = window;
        if (name.match(/^(.+)\.([^\.]+)$/)) {
            var path = RegExp.$1;
            simpleName = RegExp.$2;

            var parts = path.split(/\./);
            for (var i = 0; i < parts.length; i ++) {
                var part = parts[i];
                if (!target[part]) {
                    target[part] = {};
                }

                target = target[part];
            }
        }

        target[simpleName] = Services[name];
        window[simpleName] = Services[name];
    }
};

function cloneObject(obj) {
    if (obj == null) return null;
    return JSON.parse(JSON.stringify(obj));
}
var TYPE_HINTS = {
};

var Order = {
    asc: function (name) {
        return { name: name, asc: true };
    },
    desc: function (name) {
        return { name: name, asc: false };
    }
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/Common.js";

var DOM_VK_CANCEL = 3
var DOM_VK_HELP = 6
var DOM_VK_BACK_SPACE = 8
var DOM_VK_TAB = 9
var DOM_VK_CLEAR = 12
var DOM_VK_RETURN = 13
var DOM_VK_ENTER = 14
var DOM_VK_SHIFT = 16
var DOM_VK_CONTROL = 17
var DOM_VK_ALT = 18
var DOM_VK_PAUSE = 19
var DOM_VK_CAPS_LOCK = 20
var DOM_VK_ESCAPE = 27
var DOM_VK_SPACE = 32
var DOM_VK_PAGE_UP = 33
var DOM_VK_PAGE_DOWN = 34
var DOM_VK_END = 35
var DOM_VK_HOME = 36
var DOM_VK_LEFT = 37
var DOM_VK_UP = 38
var DOM_VK_RIGHT = 39
var DOM_VK_DOWN = 40
var DOM_VK_PRINTSCREEN = 44
var DOM_VK_INSERT = 45
var DOM_VK_DELETE = 46
var DOM_VK_0 = 48
var DOM_VK_1 = 49
var DOM_VK_2 = 50
var DOM_VK_3 = 51
var DOM_VK_4 = 52
var DOM_VK_5 = 53
var DOM_VK_6 = 54
var DOM_VK_7 = 55
var DOM_VK_8 = 56
var DOM_VK_9 = 57
var DOM_VK_SEMICOLON = 59
var DOM_VK_EQUALS = 61
var DOM_VK_A = 65
var DOM_VK_B = 66
var DOM_VK_C = 67
var DOM_VK_D = 68
var DOM_VK_E = 69
var DOM_VK_F = 70
var DOM_VK_G = 71
var DOM_VK_H = 72
var DOM_VK_I = 73
var DOM_VK_J = 74
var DOM_VK_K = 75
var DOM_VK_L = 76
var DOM_VK_M = 77
var DOM_VK_N = 78
var DOM_VK_O = 79
var DOM_VK_P = 80
var DOM_VK_Q = 81
var DOM_VK_R = 82
var DOM_VK_S = 83
var DOM_VK_T = 84
var DOM_VK_U = 85
var DOM_VK_V = 86
var DOM_VK_W = 87
var DOM_VK_X = 88
var DOM_VK_Y = 89
var DOM_VK_Z = 90
var DOM_VK_CONTEXT_MENU = 93
var DOM_VK_NUMPAD0 = 96
var DOM_VK_NUMPAD1 = 97
var DOM_VK_NUMPAD2 = 98
var DOM_VK_NUMPAD3 = 99
var DOM_VK_NUMPAD4 = 100
var DOM_VK_NUMPAD5 = 101
var DOM_VK_NUMPAD6 = 102
var DOM_VK_NUMPAD7 = 103
var DOM_VK_NUMPAD8 = 104
var DOM_VK_NUMPAD9 = 105
var DOM_VK_MULTIPLY = 106
var DOM_VK_ADD = 107
var DOM_VK_SEPARATOR = 108
var DOM_VK_SUBTRACT = 109
var DOM_VK_DECIMAL = 110
var DOM_VK_DIVIDE = 111
var DOM_VK_F1 = 112
var DOM_VK_F2 = 113
var DOM_VK_F3 = 114
var DOM_VK_F4 = 115
var DOM_VK_F5 = 116
var DOM_VK_F6 = 117
var DOM_VK_F7 = 118
var DOM_VK_F8 = 119
var DOM_VK_F9 = 120
var DOM_VK_F10 = 121
var DOM_VK_F11 = 122
var DOM_VK_F12 = 123
var DOM_VK_F13 = 124
var DOM_VK_F14 = 125
var DOM_VK_F15 = 126
var DOM_VK_F16 = 127
var DOM_VK_F17 = 128
var DOM_VK_F18 = 129
var DOM_VK_F19 = 130
var DOM_VK_F20 = 131
var DOM_VK_F21 = 132
var DOM_VK_F22 = 133
var DOM_VK_F23 = 134
var DOM_VK_F24 = 135
var DOM_VK_NUM_LOCK = 144
var DOM_VK_SCROLL_LOCK = 145
var DOM_VK_COMMA = 188
var DOM_VK_PERIOD = 190
var DOM_VK_SLASH = 191
var DOM_VK_BACK_QUOTE = 192
var DOM_VK_OPEN_BRACKET = 219
var DOM_VK_BACK_SLASH = 220
var DOM_VK_CLOSE_BRACKET = 221
var DOM_VK_QUOTE = 222
var DOM_VK_META = 224

function __extend() {
    var __base = arguments[0];
    var sub = arguments[1];

    sub.prototype = Object.create(__base.prototype);
    sub.prototype.constructor = sub;
    sub.__base = __base;

    for (var i = 2; i < arguments.length; i ++) {
        var f = arguments[i];
        sub.prototype[f.name] = f;
    }

    var guessedPathPrefix = __guessPrefix();
    sub.prototype.__pathPrefix = guessedPathPrefix;
    sub.__pathPrefix = guessedPathPrefix;

    return sub;
}

function __isSubClassOf(sub, base) {
    if (!sub.__base) return false;
    return sub.__base === base || __isSubClassOf(sub.__base, base);
}
function __isAssignableFrom(sub, base) {
    return sub === base || __isSubClassOf(sub, base);
}

function __base(object) {
    return object.constructor.__base.prototype;
}
function __getFrameworkPrefix() {
    return window.FRAMEWORK_PATH || "framework/";
};
function __getCurrentScriptPath() {
    if (window.__currentScriptPath) return window.__currentScriptPath;
    var scripts = document.getElementsByTagName("script");
    var src = scripts[scripts.length - 1].getAttribute("src");

    return src;
};
function __guessPrefix() {
    var src = __getCurrentScriptPath();
    return src.replace(/\/[^\/]+\.js$/, "/");
}

window.FRAMEWORK_PATH = __guessPrefix().replace(/js\/widget\/$/, "");

//support function.name in IE9+
if (!(function f() {}).name) {
    Object.defineProperty(Function.prototype, 'name', {
        get: function() {
            var name = this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1];
            // For better performance only parse once, and then cache the
            // result through a new accessor for repeated access.
            Object.defineProperty(this, 'name', { value: name });
            return name;
        }
    });
}

if (!String.prototype.endsWith) {
    String.prototype.endsWith = function(pattern) {
        var d = this.length - pattern.length;
        return d >= 0 && this.lastIndexOf(pattern) === d;
    };
}
if (!String.format) {
  String.format = function(format) {
    var args = Array.prototype.slice.call(arguments, 1);
    return format.replace(/{(\d+)}/g, function(match, number) {
      return typeof args[number] != 'undefined'
        ? args[number]
        : match
      ;
    });
  };
}

if (!String.prototype.toUpperCaseAt) {
    String.prototype.toUpperCaseAt = function(index) {
        if (this.length <= index) return this;
        return (index > 0 ? this.substring(0, index) : "") + this.charAt(index).toUpperCase() + this.substring(index + 1);
    };
};


if (!Array.prototype.forEach) {
    Array.prototype.forEach = function(f) {
        for (var i = 0, e = this.length; i < e; ++i) f(this[i]);
    };
}

if (!Array.prototype.find) {
    Object.defineProperty(Array.prototype, 'find', {
        value: function(predicate) {
            // 1. Let O be ? ToObject(this value).
            if (this == null) {
                throw new TypeError('"this" is null or not defined');
            }

            var o = Object(this);

            // 2. Let len be ? ToLength(? Get(O, "length")).
            var len = o.length >>> 0;

            // 3. If IsCallable(predicate) is false, throw a TypeError exception.
            if (typeof predicate !== 'function') {
                throw new TypeError('predicate must be a function');
            }

            // 4. If thisArg was supplied, let T be thisArg; else let T be undefined.
            var thisArg = arguments[1];

            // 5. Let k be 0.
            var k = 0;

            // 6. Repeat, while k < len
            while (k < len) {
                // a. Let Pk be ! ToString(k).
                // b. Let kValue be ? Get(O, Pk).
                // c. Let testResult be ToBoolean(? Call(predicate, T,  kValue, k, O )).
                // d. If testResult is true, return kValue.
                var kValue = o[k];
                if (predicate.call(thisArg, kValue, k, o)) {
                    return kValue;
                }
                // e. Increase k by 1.
                k++;
            }

            // 7. Return undefined.
            return undefined;
        },
        configurable: true,
        writable: true
    });
}

(function() {
    var throttle = function(type, name, obj) {
        obj = obj || window;
        var running = false;
        var func = function() {
            if (running) { return; }
            running = true;
             requestAnimationFrame(function() {
                //console.log(obj);
                if (obj && typeof(obj.dispatchEvent) == "function") {
                    try {
                        obj.dispatchEvent(new CustomEvent(name));
                    } catch(e) {
                        console.log(e);
                    }
                }
                running = false;
            });
        };
        obj.addEventListener(type, func);
    };

    /* init - you can init any event */
    throttle("resize", "optimizedResize");
})();

//window.$ = function () {
//    console.log("jQuery removed.");
//};


var widget = {};
widget.random = function() {
    return "" + new Date().getTime() + "_" + Math.round(10000 * Math.random());
};
widget.STATIC_BASE = "";
widget.LOADING = "Loading...";
widget.CACHE_RANDOM = widget.random();

widget.ALIAS_MAP = {};

widget.registerAliases = function (name, aliases) {
    aliases.forEach((a, i) => {
        widget.ALIAS_MAP[a] = name;
    });
};

widget.get = function(foo) {
    if (typeof (foo) == "string") return document.getElementById(foo);
    if (foo && foo.nodeType) return foo;
    return null;
};
widget.getId = function (node) {
    var id = node.getAttribute("id");
    if (!id) {
        id = "node_" + widget.random();
        node.setAttribute("id", id);
        try {
            node.id = id;
        } catch (e) {}
    }

    return id;
};

widget.evaluate = function(object, context) {
    if (typeof (object) == "function") {
        return object.apply(context);
    }
    return object;
};
widget.registerEvent = function (target, event, handlerName, capture) {
    Dom.registerEvent(target, event, function (e) {
        var t = Dom.getTarget(e);
        var node = Dom.findUpward(t, function (n) {
            return n._widget;
        });
        if (!node) return;
        var f = node._widget[handlerName];
        if (!f) return;
        f.apply(node._widget, [e]);
    }, capture);
};

function ie() {
    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('msie') != -1) {
        return parseInt(ua.split('msie')[1], 10);
    }
    if (ua.indexOf('trident') != -1) {
        return 11;
    }
    return false;
}

widget.namespaces = {
    ui: window
};

widget.getWidgetConstructor = function (ns, className) {
    var nsHolder = widget.namespaces[ns];
    if (!nsHolder) return undefined;

    return nsHolder[widget.ALIAS_MAP[className] || className];
};
widget.__export = function (ns, fnOrName, optionalValue) {
    var nsHolder = widget.__getNamespaceHolder(ns);

    if (typeof(fnOrName) == "function") {
        nsHolder[fnOrName.name] = fnOrName;
        if (ns) fnOrName.prototype.__getNamespace = function () { return ns; };
    } else if (typeof(fnOrName) == "string" && typeof(optionalValue) != "undefined") {
        nsHolder[fnOrName] = optionalValue;
    }

};
widget.__namespaceBinders = {};
widget.__namespaceDependOnRegistry = {};
widget.__namespaceDependOnRegistry = {
    "ama": ["util"],
    "promokit": ["posshopping"],
};
widget.__getNamespaceBinder = function (ns) {
    var binder = widget.__namespaceBinders[ns];
    if (!binder) {
        binder = function (fnOrName, optionalValue) {
            widget.__export(ns, fnOrName, optionalValue);
        };
        widget.__namespaceBinders[ns] = binder;
    }

    return binder;
};
widget.__getNamespaceHolder = function (ns) {
    var nsHolder = widget.namespaces[ns];
    if (!nsHolder) {
        nsHolder = {
            __namespace: ns,
            __export: widget.__getNamespaceBinder(ns),
        };
        widget.namespaces[ns] = nsHolder;
    }

    return nsHolder;
};
widget.__refershClientModuleData = function(namespace, callback) {
    var holder = widget.__getNamespaceHolder(namespace);
    if (!holder || !holder.__loaded) return;
    $coreService.loadClientModuleData(namespace, function(moduleData) {
        holder.ModuleData = moduleData;
        if (callback) callback(holder);
    });
}
widget.__ensureNamespacesLoaded = function (namespaces, callback) {
    var cbResults = {};
    var index = 0;
    function next() {
        var ns = index >= namespaces.length ? undefined : namespaces[index];
        if (!ns) {
            callback(cbResults);
            return;
        }
        var cb = function(namespaceHolder, name) {
            cbResults[name] = namespaceHolder;
            index ++;
            next();
        }
        widget.__ensureNamespaceLoaded(ns, cb);
    }
    next();
}
widget.__ensureNamespaceLoaded = function (ns, callback) {
    var dependOnNS = widget.__namespaceDependOnRegistry[ns];
    function ensureNamespaceLoaded() {
        widget.__ensureNamespaceLoadedImpl(ns, callback);
    }

    if (!dependOnNS) {
        ensureNamespaceLoaded();
    } else {
        widget.__ensureNamespacesLoaded(dependOnNS, function(cbResults){
            ensureNamespaceLoaded();
        });
    }
}
widget.__ensureNamespaceLoadedImpl = function (ns, callback) {
    var nsHolder = widget.__getNamespaceHolder(ns);

    if (!ns || ns == "ui" || nsHolder.__loaded) {
        callback(nsHolder, ns);
        return;
    }

    if (nsHolder.__callbackFunction) {
        nsHolder.__pendingCallbacks.push(callback);
    } else {
        nsHolder.__pendingCallbacks = [callback];
        nsHolder.__callbackFunction = function () {
            nsHolder.__loaded = true;
            if (nsHolder.__pendingCallbacks) {
                nsHolder.__pendingCallbacks.forEach(function (cb) {
                    try {
                        cb(nsHolder, ns);
                    } catch (e) {
                        console.error(e);
                    }
                });
            }
            nsHolder.__pendingCallbacks = null;
            nsHolder.__callbackFunction = null;
        };

        widget.__loadDynamicModule(ns, nsHolder.__callbackFunction);
    }
};

widget.__loadScript = function (url, callback, isModule) {
    var scriptTag = document.createElement("script");
    if (isModule) scriptTag.setAttribute("type", "module");
    scriptTag.src = url;
    scriptTag.onload = callback;
    document.getElementsByTagName("head")[0].appendChild(scriptTag);
};
widget.__loadStylesheet = function (url, callback) {
    var link = document.createElement("link");
    link.setAttribute("rel", "stylesheet");
    link.setAttribute("type", "text/css");
    link.setAttribute("href",url);
    link.onload = callback;
    document.getElementsByTagName("head")[0].appendChild(link);
};
widget.__loadDynamicModule = function (ns, callback) {
    (window.__loadModuleIndicator || window.defaultIndicator).busy("Loading...");
    var devTag = window.IS_DEV_MODE ? ("&token=" + new Date().getTime()) : "";
    var params = "?lang=" + ((LOCALE.language || "").replace("-", "_")) + "&b=" + BUILD_ID + devTag;
    widget.__loadScript("/" + ns + "-widgets-templates.pack.js" + params, function () {
        widget.__loadScript("/" + ns + "-widgets.pack.js" + params, function () {
            var holder = widget.__getNamespaceHolder(ns);
            var params = "";
            if (holder.USE_THEME_COLOR && window.CONTEXT && window.CONTEXT.cmsTemplateVariantColor) {
                params = "&p=" + btoa("pc:" + window.CONTEXT.cmsTemplateVariantColor).replace(/=+$/, "");
            }
            //cmsTemplateVariantColor
            widget.__loadStylesheet("/" + ns + "-widgets-templates.pack.css?b=" + BUILD_ID + devTag + params, function () {
                widget.__loadStylesheet("/" + ns + "-styles.pack.css?b=" + BUILD_ID + devTag + params + "&optional=true", function () {
                    //assuming that there is a server-side module with the same name and load the module data
                    if (typeof($coreService) == "undefined") ServiceFactory.registerService("coreService", { loadClientModuleData: ["moduleName"] });

                    $coreService.loadClientModuleData(ns, function (clientModuleData) {
                        holder.ModuleData = clientModuleData;
                        var globalData = clientModuleData ? clientModuleData["__global"] : undefined;
                        if (typeof(globalData) != "undefined") {
                            for (var name in globalData) {
                                var config = window[name];
                                if (typeof(config) != "undefined") console.log("Overwriting..." + name + " of window from: " + config + " to --> " + globalData[name]);
                                window[name] = globalData[name];
                            }
                        }

                        holder.__loaded = true;

                        var finalizer = function () {
                            (window.__loadModuleIndicator || window.defaultIndicator).done();
                            callback(holder);
                        };

                        if (holder.__onModuleLoaded) {
                            holder.__onModuleLoaded(finalizer);
                        } else {
                            finalizer();
                        }
                    });
                });
            });
        });
    });
};

widget.__loadedExternalResources = {};

widget.__ensureExternalResourceLoaded = function (url, type, callback) {
    if (widget.__loadedExternalResources[url]) {
        if (callback) callback();
        return;
    }

    var cb = function () {
        widget.__loadedExternalResources[url] = true;
        if (callback) callback();
    };

    if (type == "js" || type == "javascript") {
        widget.__loadScript(url, cb);
    } else if (type == "css" || type == "stylesheet") {
        widget.__loadStylesheet(url, cb);
    }
};

widget.createWidgetAsync = function (ns, clazz, option, callback) {
    widget.__ensureNamespaceLoaded(ns, function () {
        var impl = widget.namespaces[ns][clazz];
        var w = new impl(option || {});
        callback(w);
    });
};

var __pkg = widget.__getNamespaceHolder("ui");


widget.Util = function() {
    var TEMPLATE_CACHE = {};
    var processedCSS = {};
    var lessParserConfig = {
            paths: [__getFrameworkPrefix(), __getFrameworkPrefix() + "style/"]
    };
    var ColorUtilObject = (function () {
        function hexToRGB(H) {
            let ex = /^#([\da-f]{3}){1,2}$/i;
            if (!ex.test(H)) throw "Invalid color: " + H;

            // convert hex to RGB first
            let r = 0, g = 0, b = 0;
            if (H.length == 4) {
                r = H[1] + H[1];
                g = H[2] + H[2];
                b = "0x" + H[3] + H[3];
            } else if (H.length == 7) {
                r = H[1] + H[2];
                g = H[3] + H[4];
                b = H[5] + H[6];
            }
            // then to HSL

            r = parseInt(r, 16);
            g = parseInt(g, 16);
            b = parseInt(b, 16);

            return {
                r: r, g: g, b: b
            };
        }
        function hexToHSL(H) {
            let ex = /^#([\da-f]{3}){1,2}$/i;
            if (ex.test(H)) {
                // convert hex to RGB first
                let r = 0, g = 0, b = 0;
                if (H.length == 4) {
                    r = "0x" + H[1] + H[1];
                    g = "0x" + H[2] + H[2];
                    b = "0x" + H[3] + H[3];
                } else if (H.length == 7) {
                    r = "0x" + H[1] + H[2];
                    g = "0x" + H[3] + H[4];
                    b = "0x" + H[5] + H[6];
                }
                // then to HSL
                r /= 255;
                g /= 255;
                b /= 255;
                let cmin = Math.min(r,g,b),
                cmax = Math.max(r,g,b),
                delta = cmax - cmin,
                h = 0,
                s = 0,
                l = 0;

                if (delta == 0)
                h = 0;
                else if (cmax == r)
                h = ((g - b) / delta) % 6;
                else if (cmax == g)
                h = (b - r) / delta + 2;
                else
                h = (r - g) / delta + 4;

                h = Math.round(h * 60);

                if (h < 0)
                h += 360;

                l = (cmax + cmin) / 2;
                s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));ColorUtilObject
                // s = +(s * 100).toFixed(1);
                // l = +(l * 100).toFixed(1);

                return {
                    h: h, s: s, l: l
                };

                // return "hsl(" + h + "," + s + "%," + l + "%)";

            } else {
                throw "Invalid color: " + H;
            }
        }

        function hslToHEX(hsl) {
            let h = hsl.h,
            s = hsl.s,
            l = hsl.l;

            let c = (1 - Math.abs(2 * l - 1)) * s,
            x = c * (1 - Math.abs((h / 60) % 2 - 1)),
            m = l - c/2,
            r = 0,
            g = 0,
            b = 0;

            if (0 <= h && h < 60) {
                r = c; g = x; b = 0;
            } else if (60 <= h && h < 120) {
                r = x; g = c; b = 0;
            } else if (120 <= h && h < 180) {
                r = 0; g = c; b = x;
            } else if (180 <= h && h < 240) {
                r = 0; g = x; b = c;
            } else if (240 <= h && h < 300) {
                r = x; g = 0; b = c;
            } else if (300 <= h && h < 360) {
                r = c; g = 0; b = x;
            }
            // having obtained RGB, convert channels to hex
            r = Math.round((r + m) * 255).toString(16);
            g = Math.round((g + m) * 255).toString(16);
            b = Math.round((b + m) * 255).toString(16);

            // prepend 0s if necessary
            if (r.length == 1)
            r = "0" + r;
            if (g.length == 1)
            g = "0" + g;
            if (b.length == 1)
            b = "0" + b;

            return "#" + r + g + b;
        }

        var rc = 0.2126;
        var gc = 0.7152;
        var bc = 0.0722;
        var lowc = 1 / 12.92;
        function adjustGamma(x) {
            return Math.pow((x + 0.055) / 1.055, 2.4);
        }
        function lum(rgb) {
            var rsrgb = rgb.r / 255;
            var gsrgb = rgb.g / 255;
            var bsrgb = rgb.b / 255;

            var r = rsrgb <= 0.03928 ? rsrgb * lowc : adjustGamma(rsrgb);
            var g = gsrgb <= 0.03928 ? gsrgb * lowc : adjustGamma(gsrgb);
            var b = bsrgb <= 0.03928 ? bsrgb * lowc : adjustGamma(bsrgb);

            return r * rc + g * gc + b * bc;
        }

        function spin(hex, angle) {
            var hsl = hexToHSL(hex);
            hsl.h = (hsl.h + angle) % 360;
            if (hsl.h < 0) hsl.h += 360;

            return hslToHEX(hsl);
        }
        function contrast(hex) {
            var rgb = hexToRGB(hex);
            console.log(rgb);
            var l = lum(rgb);
            var l0 = lum({r: 0, g: 0, b: 0});
            var l1 = lum({r: 255, g: 255, b: 255});

            var x0 = (l + 0.05) / (l0 + 0.05);
            var x1 = (l1 + 0.05) / (l + 0.05);
            if (x1 > x0) return "#FFFFFF";
            return "#000000";
        }

        return {
            hexToHSL: hexToHSL,
            hslToHEX: hslToHEX,
            spin: spin,
            contrast: contrast
        }

    })();

    return {
        _processTemplateStyleSheet: function (html, prefix, templateName) {

            return html.replace(/(<style[^>]*>)([^<]+)(<\/style>)/g, function (zero, start, content, end) {

                if (processedCSS[templateName]) return "";

                var css = content.replace(/([\r\n ]+)([^\{\}\$;]+)\{/g, function (zero, leading, selectors) {
                    selectors = selectors.replace(/@this/gi, "body " + prefix);
                    selectors = selectors.replace(/(\.widget_[^\r\n\,]+ )@([a-z])/gi, "$1 .AnonId_$2");
                    if (!selectors.match(/^[ \t]*@media /)) {
                        selectors = selectors.replace(/@([a-z])/gi, ".AnonId_" + (templateName + "_") + "$1");
                    }
                    selectors = selectors.replace(/[ \r\n\t]\,[ \r\n\t]+/g, ",");
                    if (!selectors.match(/^[ \t]*body[ \.\[:]/)
                            && !selectors.match(/^[ \t]*@media /)
                            && !selectors.match(/^[ \t]*#sys-/)) {
                        selectors = prefix + " " + selectors.replace(/\,/g, ",\n" + prefix + " ");
                    }

                    var modified = leading + selectors + "{";

                    return modified;
                });
                css = css.replace(/\$([a-z0-9_]+)/g, "@$1");

                //appending less config
                var includes = "";
                includes += "@import \"" + __getFrameworkPrefix() + "style/layout-includes.less\";\n";

                if (window.APP_THEME_PATH) {
                    includes += "@import \"" + window.APP_THEME_PATH + "\";\n";
                }


                css = includes + css;
                if (less) {
                    less.render(css, lessParserConfig).then(function (output) {
                        widget.Util.insertGlobalStyleSheet(output.css, templateName);
                    }).catch(function (e) {
                        console.error(e);
                    });
                }

                processedCSS[templateName] = true;

                return "";

            });
        },
        insertGlobalStyleSheet: function (css, templateName) {
            var head = document.head || document.getElementsByTagName("head")[0];
            var style = document.createElement("style");
            style.type = "text/css";
            style.setAttribute("widget", templateName);

            if (style.styleSheet) {
                style.styleSheet.cssText = "";
            }

            head.appendChild(style);
            style.appendChild(document.createTextNode(css));
        },
        processLocalizationMacros: function (html) {
            if (!window.Messages) return html;
            return html.replace(/#\{([^\r\n\}]+)\}/g, function (all, one) {
                var s = Messages[one] || one;
                return Dom.htmlEncode(s);
            });
        },
        processTeamTermMacros: function (html) {
            return html.replace(/#TT\(([^\r\n\)]+)\)/g, function (all, one) {
                return Dom.htmlEncode(FormatUtil.term(one));
            });
        },
        performAutoBinding: function (container, namingContext, ownerTemplateName, forced) {
            Dom.doOnChildRecursively(container, {
                eval: function(n) {
                    return ((n.getAttribute && n.getAttribute("ui-type")) || n.localName == "ui" || (n.namespaceURI == "http://evolus.vn/Namespaces/WebUI/1.0")) && (n.getAttribute("autobinding") != "false" || forced);
                }
            }, function(n) {
                if (!namingContext.__childWidgets) namingContext.__childWidgets = [];

                var clazz = n.getAttribute("type");
                var ns = n.getAttribute("ns");
                if (!clazz) {
                    clazz = n.getAttribute("ui-type");
                    if (clazz) {
                        if (clazz.match(/([a-z0-9]+):([a-z0-9]+)/gi)) {
                            ns = RegExp.$1;
                            clazz = RegExp.$2;
                        } else {
                            ns = "ui";
                        }
                    }
                }

                if (!clazz) {
                    clazz = n.localName;
                    ns = "ui";
                }
                if (!clazz) return;

                var creator = function () {

                    var f = widget.getWidgetConstructor(ns, clazz);
                    if (!f) {
                        console.log("No implementation found for: " + ns + ":" + clazz);
                        return;
                    }
                    var wg = new f(n);

                    for (var i = 0; i < n.attributes.length; i ++) {
                        var name = n.attributes[i].name;
                        var value = n.attributes[i].value;

                        if (name == "anon-id") {
                            if (namingContext) {
                                namingContext[value] = wg;
                                Dom.addClass(wg.node(), "AnonId_" + value);
                                Dom.addClass(wg.node(), "AnonId_" + (ownerTemplateName ? (ownerTemplateName + "_") : "") + value);
                            }
                            wg._anonId = value;
                            wg.node()._anonId = value;
                        } else if (name == "style") {
                            var currentStyle = wg.node().getAttribute("style");
                            if (currentStyle) {
                                currentStyle += value;
                            } else {
                                currentStyle = value;
                            }
                            wg.node().setAttribute("style", currentStyle);
                        } else if (name == "flex") {
                            wg.node().setAttribute("flex", value);
                        } else if (name == "class") {
                            Dom.addClass(wg.node(), value);
                        } else {
                            wg[name] = value;
                            if (name != "type") {
                                wg.node().setAttribute(name, value);
                            }
                        }
                    }

                    var parentNode = n.parentNode;
                    if (!parentNode) return;
                    parentNode.replaceChild(wg.node(), n);
                    namingContext.__childWidgets.push(wg);

                    if (wg.setContentFragment && n.childNodes) {
                        var f = wg.node().ownerDocument.createDocumentFragment();

                        while (n.firstChild) {
                            var child = n.firstChild;
                            n.removeChild(child);
                            f.appendChild(child);
                        }

                        widget.Util.performAutoBinding(f, namingContext);
                        wg.setContentFragment(f);
                    }
                };

                if (ns && ns != "ui") {
                    widget.__ensureNamespaceLoaded(ns, creator);
                } else {
                    creator();
                }

                // if (parentNode.ownerDocument.body.contains(parentNode)) wg.signalOnAttached();
            });
        },
        _processTemplate: function(dolly, namingContext, templateName) {
            dolly.removeAttribute("id");
            //dolly.style.display = "block";

            var anonIdToIdMap = {};

            widget.Util.performAutoBinding(dolly, namingContext, templateName);

            Dom.doOnChildRecursively(dolly, {
                eval: function(n) {
                    return n.getAttribute && n.getAttribute("anon-id");
                }
            }, function(n) {
                var id = n.getAttribute("anon-id");

                if (namingContext) {
                    namingContext[id] = n;
                }
                n.removeAttribute("anon-id");

                var newId = id + widget.random();
                n.setAttribute("id", newId);
                n.id = newId;
                n._anonId = id;
                anonIdToIdMap[id] = newId;
                Dom.addClass(n, "AnonId_" + id);
                Dom.addClass(n, "AnonId_" + (templateName ? (templateName + "_") : "") + id);
            });
            Dom.doOnChildRecursively(dolly, {
                eval: function(n) {
                    return n.getAttribute;
                }
            }, function(n) {
                if (n.getAttribute) {
                    var href = n.getAttribute("href");
                    if (href && href.match(/^#(.+)$/)) {
                        var id = RegExp.$1;
                        if (anonIdToIdMap[id]) {
                            n.setAttribute("href", "#" + anonIdToIdMap[id]);
                        }
                    }

                    var ffor = n.getAttribute("for");
                    if (ffor && anonIdToIdMap[ffor]) {
                        n.setAttribute("for", anonIdToIdMap[ffor]);
                    }
                }
            });
        },
        buildDOMFromTemplate: function(template, namingContext) {
            template = widget.get(template);
            var dolly = template.cloneNode(true);

            widget.Util._processTemplate(dolly, namingContext);

            return dolly;
        },

        loadTemplate: function(path, callback) {
            if (!callback) return widget.Util.loadTemplateSync(path);

            if (typeof (TEMPLATE_CACHE[path]) != "undefined") {
                if (callback) {
                    callback(TEMPLATE_CACHE[path]);
                    return;
                } else {
                    return TEMPLATE_CACHE[path];
                }
            }

            var task = function(done) {
                var templateURL = widget.STATIC_BASE + path;

                var __process = function (html) {
                    done();
                    html = widget.Util.processLocalizationMacros(html);
                    TEMPLATE_CACHE[path] = html;
                    callback(html);
                }

                if (window.__TEMPLATE_BUNDLE && window.__TEMPLATE_BUNDLE[templateURL]) {
                    __process(window.__TEMPLATE_BUNDLE[templateURL]);
                } else {
                    var request = new XMLHttpRequest();
                    request.onreadystatechange = function() {
                        if (request.readyState == 4) {
                            __process(request.responseText);
                        }
                    };
                    request.open("GET", templateURL + "?t=" + widget.CACHE_RANDOM, true);
                    request.send(null);
                }
            };

            run(task);
        },
        loadTemplateSync: function(path) {
            if (typeof (TEMPLATE_CACHE[path]) != "undefined") {
                return TEMPLATE_CACHE[path];
            }

            var html = null;

            var templateURL = widget.STATIC_BASE + path;
            if (window.__TEMPLATE_BUNDLE) html = window.__TEMPLATE_BUNDLE[templateURL];

            if (!html) {
                var request = new XMLHttpRequest();
                request.open("GET", templateURL + "?t=" + widget.CACHE_RANDOM, false);
                request.send(null);
                html = request.responseText;
            }

            html = widget.Util.processLocalizationMacros(html);
            html = widget.Util.processTeamTermMacros(html);
            TEMPLATE_CACHE[path] = html;

            return html;
        },
        _templateNameFromPath: function (path) {
            return path.replace(/[^a-z0-9]+/gi, "_");
        },
        _generateClassNameForPath: function (path) {
            var templateName = widget.Util._templateNameFromPath(path);
            var className = "DynamicTemplate" + templateName;

            return className;
        },
        _toTemplateNode: function (path, html, namingContext, doc) {
            if (html) {
                html = html.replace(/<([a-z0-9]+):([^>]+)\/>/gi, function (all, ns, attr) {
                    return "<" + ns + ":" + attr + "></" + ns + ":Dummy>";
                }).replace(/<([a-z0-9]+):([a-zA-Z0-9]+)/gi, function (all, ns, name) {
                    return "<ui ns=\"" + ns + "\" type=\"" + name + "\"";
                }).replace(/<\/([a-z0-9]+):([a-zA-Z0-9]+)/gi, function (all, name) {
                    return "</ui";
                });
            }

            if (!doc) doc = document;

            var div = doc.createElement("div");
            var templateName = widget.Util._templateNameFromPath(path);
            var className = widget.Util._generateClassNameForPath(path);
            var processedHtml = widget.Util._processTemplateStyleSheet(html, "." + className, templateName);
            try {
                div.innerHTML = processedHtml;
            } catch (e) {
                console.log("Bad HTML: " + html);
                throw e;
            }
            var firstElement = null;
            for (var i = 0; i < div.childNodes.length; i ++) {
                var e = div.childNodes[i];
                if (e && e.nodeType == Node.ELEMENT_NODE) {
                    firstElement = e;
                    break;
                }
            }

            if (firstElement) {
                div = firstElement;
            }

            Dom.addClass(div, className);
            Dom.addClass(div, templateName);

            widget.Util._processTemplate(div, namingContext, templateName);

            return div;
        },
        loadTemplateAsNode: function(path, callback, namingContext) {
            widget.Util.loadTemplate(path, function (html) {
                callback(widget.Util._toTemplateNode(path, html, namingContext));
            });
        },
        loadTemplateAsNodeSync: function(path, namingContext, doc) {
            var html = widget.Util.loadTemplateSync(path);
            return widget.Util._toTemplateNode(path, html, namingContext, doc);

        },
        registerGlobalListener: function(listener) {
            if (!widget.globalListeners) widget.globalListeners = [];
            widget.globalListeners.push(listener);
        },
        fireGlobalEvent: function() {
            if (!widget.globalListeners) return;
            var name = arguments[0];
            var args = [];
            for ( var i = 1; i < arguments.length; i++) {
                args.push(arguments[i]);
            }

            for ( var i = 0; i < widget.globalListeners.length; i++) {
                var listener = widget.globalListeners[i];
                if (!listener[name]) continue;
                var f = listener[name];
                f.apply(listener, args);
            }
        },
        createOverlayCover: function (zIndex, opacity, color, onClose) {
            var cover = document.createElement("div");
            document.body.appendChild(cover);
            cover.style.position = "fixed";
            cover.style.top = "0px";
            cover.style.left = "0px";
            cover.style.bottom = "0px";
            cover.style.right = "0px";

            if (opacity) cover.style.opacity = "" + opacity;
            if (zIndex) cover.style.zIndex = "" + zIndex;
            if (color) cover.style.background = color;

            if (onClose) {
                Dom.registerEvent(cover, "click", function () {
                    cover.parentNode.removeChild(cover);
                    onClose();
                });
            }

            return cover;
        },
        createBlankCover: function (onClose) {
            return this.createOverlayCover(widget.Dialog.getTopZIndex(), 0, null, onClose);
        },
        createDarkCover: function (onClose) {
            return this.createOverlayCover(widget.Dialog.getTopZIndex(), 0.3, "#000", onClose);
        },
        popupStack: [],
        positionAsPopup: function (node, anchor, hAlign, vAlign, hPadding, vPadding) {
            if (!node.parentNode || node.parentNode != document.body) {
                if (node.parentNode) node.parentNode.removeChild(node);
                document.body.appendChild(node);

                node.style.visibility = "hidden";

                node.style.left = "0px";
                node.style.top = "0px";

                window.setTimeout(function () {
                    widget.Util.positionAsPopup(node, anchor, hAlign, vAlign, hPadding, vPadding);
                }, 10);

                return;
            }
            node.style.left = "0px";
            node.style.top = "0px";

            var display = node.style.display;

            node.style.display = "block";

            var w = node.offsetWidth;
            var h = node.offsetHeight;

            node.style.display = display;

            var rect = anchor.getBoundingClientRect();
            var aw = rect.width;
            var ah = rect.height;
            var ax = rect.left;
            var ay = rect.top;

            var p = hPadding || 0;

            var x = 0;
            if (hAlign == "left") x = ax - w - p;
            if (hAlign == "left-inside") x = ax + p;
            if (hAlign == "middle" || hAlign == "center") x = ax + aw / 2 - w / 2;
            if (hAlign == "right") x = ax + aw + p;
            if (hAlign == "right-inside") x = ax + aw - w - p;

            p = vPadding || p;

            var y = 0;
            if (vAlign == "top") y = ay - h - p;
            if (vAlign == "top-inside") y = ay + p;
            if (vAlign == "middle" || vAlign == "center") y = ay + ah / 2 - h / 2;
            if (vAlign == "bottom") y = ay + ah + p;
            if (vAlign == "bottom-inside") y = ay + ah - h - p;

            //invalidate into view
            var screenW = document.body.offsetWidth - 10;
            if (x + w > screenW) x = screenW - w;

            var screenH = document.body.offsetHeight - 10;
            if (y + h > screenH) y = ay - h - p;

            node.style.position = "absolute";
            node.style.left = x + "px";
            node.style.top = y + "px";
            node.style.zIndex = "9999";
            node.style.visibility = "visible";

            widget.Util.popupStack.push(node);
        },
        registerPopopCloseHandler: function () {
            document.body.addEventListener("mousedown", function (event) {
                if (widget.Util.popupStack.length == 0) return;
                var popup = widget.Util.popupStack[widget.Util.popupStack.length - 1];
                var node = Dom.findUpward(event.target, function (n) {
                    return n == popup;
                });
                if (node) return;
                popup.style.visibility = "hidden";
                widget.Util.popupStack.pop();
                event.preventDefault();
            }, false);
        },
        configureNumberInput: function (input, min, max) {
            input._min = min;
            input._max = max;
        },
        registerJustClickedHandler: function () {
            document.body.addEventListener("mousedown", function (event) {
                var start = event.target;
                while (start && start.nodeType != 1) start = start.parentNode;
                if (!start) return;
                var target = Dom.findUpward(start, function (node) {
                    var n = window.getComputedStyle(node).animationName;
                    return (n && n != "none") ? true : false;
                });
                if (!target) return;
                var animationName = window.getComputedStyle(target).animationName;
                var animationDuration = window.getComputedStyle(target).animationDuration;
                if (animationName) {
                    var attributeName = animationName + "-just-clicked";
                    if (target._lastJustClickedTimeout) window.clearTimeout(target._lastJustClickedTimeout);

                    var runnable = function () {
                        target.setAttribute(attributeName, "true");

                        var timeout = 0;
                        if (animationDuration && animationDuration.match(/([0-9\.]+)s/)) {
                            timeout = parseFloat(RegExp.$1) * 1000;
                        }
                        if (!timeout) timeout = 1000;

                        target._lastJustClickedTimeout = window.setTimeout(function () {
                            target.removeAttribute(attributeName);
                            target._lastJustClickedTimeout = null;
                        }, Math.round(timeout * 1.2));
                    };

                    if (target.hasAttribute(attributeName)) {
                        target.removeAttribute(attributeName);
                        window.setTimeout(runnable, 10);
                    } else {
                        runnable();
                    }
                }
            }, false);
        },
        Color: ColorUtilObject
    };
}();

var busyIndicator = null;
function initBusyIndicator() {
    if (busyIndicator) return;
    busyIndicator = {};

    busyIndicator.overlay = document.createElement("div");
    document.body.appendChild(busyIndicator.overlay);

    busyIndicator.overlay.setAttribute("style", "position: fixed; top: 0px; left: 0px; right: 0px; bottom: 0px; background: rgba(255, 255, 255, 0.3); z-index: 9999999");

    document.body.appendChild(busyIndicator.overlay);
    busyIndicator.overlay.style.display = "none";

    busyIndicator.messageContainer = document.createElement("div");
    document.body.appendChild(busyIndicator.messageContainer);
    busyIndicator.messageContainer.setAttribute("style", "display: flex; flex-direction: row; align-items: center; position: fixed; top: 50%; left: 50%; margin-top: -2em; background: rgba(255, 255, 255, 0.9); box-shadow: 0px 0px 0.2em 0.1em rgba(0, 0, 0, 0.1); padding: 1em; border: solid 1px #CCC; z-index: 9999999");

    busyIndicator.messageContainer.style.visibility = "hidden";


    Dom.addClass(busyIndicator.messageContainer, "BusyMessage");
    var spinner = document.createElement("icon");
    busyIndicator.messageContainer.appendChild(spinner);
    Dom.addClass(spinner, "image-filter-tilt-shift");
    spinner.setAttribute("style", "font-size: 1.3em; display: inline-block; animation-name: spin360; animation-duration: 1500ms; animation-iteration-count: infinite; animation-timing-function: linear;")

    busyIndicator.message = document.createElement("span");
    Dom.addClass(busyIndicator.message, "Text");
    busyIndicator.messageContainer.appendChild(busyIndicator.message);
    Dom.setInnerText(busyIndicator.message, widget.LOADING);
    busyIndicator.message.style.marginLeft = "1ex";

    var w = Dom.getOffsetWidth(busyIndicator.messageContainer);
    busyIndicator.messageContainer.style.marginLeft = "-" + (w / 2) + "px";
}

var defaultIndicator = {
    count: 0,
    busy: function(message) {
        initBusyIndicator();

        Dom.setInnerText(busyIndicator.message, message || widget.LOADING);
        var w = Dom.getOffsetWidth(busyIndicator.messageContainer);
        busyIndicator.messageContainer.style.marginLeft = "-" + (w / 2) + "px";

        busyIndicator.messageContainer.style.visibility = "visible";
        busyIndicator.overlay.style.display = "block";
        this.count++;
    },
    done: function() {
        this.count--;
        if (this.count <= 0) {
            busyIndicator.messageContainer.style.visibility = "hidden";
            busyIndicator.overlay.style.display = "none";
        }
    }
}
function NodeBusyIndicator(node) {
    this.node = node;
}
NodeBusyIndicator.prototype.busy = function (m) {
    Dom.addClass(this.node, "Busy");
};
NodeBusyIndicator.prototype.done = function (m) {
    Dom.removeClass(this.node, "Busy");
};

function run(task, message, indicator) {
    var i = indicator || defaultIndicator;
    var m = message || null;

    i.busy(m);
    task(function() {
        i.done();
    });
}

widget._handleDebugClick = function (event) {
    if (!window.IS_DEV_MODE) return;
    if (!event.shiftKey || !event.ctrlKey) return;

    Dom.cancelEvent(event);
    var node = event.target;

    var message = "";
    while (node && node != document.body) {
        var meta = [];

        var id = node._anonId;
        if (id) {
            meta.push({
                prefix: "@",
                value: id
            });
        }


        var clazz = node.__widget && node.__widget.constructor.name;
        if (clazz) clazz = (node.__widget.ns || "ui") + ":" + clazz;

        if (clazz) {
            meta.push({
                prefix: "class: ",
                value: clazz
            });
        }

        if (Dom.hasClass(node, "AnonId_dialogFrame") && node._dialog) {
            var dialog = (node._dialog.__getNamespace ? node._dialog.__getNamespace() : "ui") + ":" + node._dialog.constructor.name;
            meta.push({
                prefix: "dialog: ",
                value: dialog
            });
        }

        if (meta.length > 0) {
            var line = meta.map(function (m) {
                return "<span style=\"opacity: 0.5;\">" + m.prefix + "</span>" + m.value;
            }).join(" | ");

            message = line + "<div style=\"margin-left: 0.5em;\">" + message + "</div>";
        }

        node = node.parentNode;
    }

    console.log(message);

    Dialog.alertHtmlMessage("Trace:", "<strong>Element stack:</strong><pre style=\"font-size: 1em; font-family: 'Liberation Mono', monospace;\">" + message + "</pre>");
};


window.addEventListener(window.__widgetUseEarlyInitPhase ? "DOMContentLoaded" : "load", function () {
    if (window._frameworkInitEventFired) return;
    window._frameworkInitEventFired = true;

    BaseWidget.registerDOMMutationHandler();
    window.globalViews = {};
    widget.Util.performAutoBinding(document.body, window.globalViews);
    widget.Util.registerPopopCloseHandler();
    widget.Util.registerJustClickedHandler();

    window.addEventListener("optimizedResize", function() {
        BaseWidget.signalOnSizeChangedRecursively(document.body);
    });
    if (ie()) {
        Dom.addClass(document.body, "MSIE");
    }

    Dom.addClass(document.body, "OS_" + Util.osName);

    if (window.navigator.userAgent.indexOf("iPad") != -1 || window.navigator.userAgent.indexOf("iPhone") != -1) {
        if (window.navigator.userAgent.indexOf("Safari") != -1) {
            Dom.addClass(document.body, "Family_MobileSafari");
        }
    }

    if (window.IS_DEV_MODE) {
        document.body.addEventListener("mousedown", widget._handleDebugClick, true);
    }


}, false);


function BaseWidget(definitionNode) {
    this.uuid = Util.newUUID();
    var node = this.buildDOMNode(definitionNode);
    Dom.addClass(node, "widget_" + this.constructor.name);
    Dom.addClass(node, "sys_FrameworkWidget");
    if (this.__getNamespace) {
        Dom.addClass(node, "namespace_" + this.__getNamespace());
    }
    this.__node = node;
    node.__widget = this;

    var thiz = this;
    /**
     * @deprecated
     * Please aware that Mutation events will be removed from Chrome, it starting with Chrome version 127
     * Mutation events is the name for the following collection of events:
            DOMNodeInserted
            DOMNodeRemoved
            DOMSubtreeModified
            DOMCharacterDataModified
            DOMNodeInsertedIntoDocument
            DOMNodeRemovedFromDocument
     * More info here: https://developer.chrome.com/blog/mutation-events-deprecation
     */
    node.addEventListener("DOMNodeInsertedIntoDocument", function () {
        if (thiz.onFirstInsertedIntoDocument && !thiz._signalInserted) {
            thiz.onFirstInsertedIntoDocument();
            thiz._signalInserted = true;
        }

        if (thiz.onInsertedIntoDocument) thiz.onInsertedIntoDocument();
    }, false);

    this.__delegate("addEventListener", "hasAttribute", "getAttribute", "setAttribute", "setAttributeNS", "removeAttribute", "removeAttributeNS", "dispatchEvent");
}

BaseWidget.prototype.getOwnerDocument = function () {
    return document;
};
//@abstract BaseWidget.prototype.buildDOMNode = function () {};
BaseWidget.prototype.node = function () {
    return this.__node;
};
BaseWidget.prototype.__base = function () {
    return __base(this);
};
BaseWidget.prototype.e = function (member, target) {
    if (member instanceof Function) return member.apply(target || this);
    return member;
};
BaseWidget.signalOnAttachedRecursively = function (container) {
    if (container.__widget && container.__widget.onAttached) {
        var firstAttached = container.__widget.__attachedNotified ? false : true;
        container.__widget.onAttached(firstAttached);
        container.__widget.__attachedNotified = true;
    }
    for (var i = 0; i < container.childNodes.length; i++) {
        var child = container.childNodes[i];
        BaseWidget.signalOnAttachedRecursively(child);
    }
};
BaseWidget.signalOnDetachedRecursively = function (container) {
    if (container.__widget && container.__widget.onDetached) {
        container.__widget.onDetached();
    }
    for (var i = 0; i < container.childNodes.length; i++) {
        var child = container.childNodes[i];
        BaseWidget.signalOnDetachedRecursively(child);
    }
};


BaseWidget.RESPONSIVE_BREAKPOINTS = {
    sm: 576,
    md: 768,
    lg: 992,
    xl: 1200,
    xxl: 1400
};
BaseWidget.invalidateResponsiveBreakpointClasses = function (viewport) {
    var w = viewport.offsetWidth;
    for (var name in BaseWidget.RESPONSIVE_BREAKPOINTS) {
        Dom.toggleClass(viewport, name, w >= BaseWidget.RESPONSIVE_BREAKPOINTS[name]);
    }
};
BaseWidget.signalOnSizeChangedRecursively = function (container) {
    if (container.__widget && container.__widget.onSizeChanged) {
        container.__widget.onSizeChanged();
    }
    if (Dom.hasClass(container, "sys-viewport")) {
        BaseWidget.invalidateResponsiveBreakpointClasses(container);
    }
    for (var i = 0; i < container.childNodes.length; i++) {
        var child = container.childNodes[i];
        BaseWidget.signalOnSizeChangedRecursively(child);
    }
};
BaseWidget.prototype.bind = function (eventName, f, node) {
    var n = node || this.__node;
    var thiz = this;
    n.addEventListener(eventName, function (event) {
        f.apply(thiz, [event]);
    });
};

BaseWidget.prototype.onAttached = function () { };
Object.defineProperty(BaseWidget.prototype, "ownerDocument", {
    get: function () {
        return this.node().ownerDocument;
    }
});

BaseWidget.prototype.into = function (container, nextSiblingNode) {
    if (!nextSiblingNode) {
        container.appendChild(this.node());
    } else {
        container.insertBefore(this.node(), nextSiblingNode)
    }
    return this;
};
BaseWidget.prototype.__delegate = function () {
    for (var i = 0; i < arguments.length; i ++) {
        this.__delegateOne(arguments[i]);
    }
};
BaseWidget.prototype.__delegateOne = function (name) {
    var thiz = this;
    this[name] = function () {
        var f = thiz.__node[name];
        var args = [];
        for (var i = 0; i < arguments.length; i ++) {
            args.push(arguments[i]);
        }
        return f.apply(thiz.__node, args);
    };
};
BaseWidget.prototype.buildDOMNode = function () {
    var node = this.getOwnerDocument().createElement("div");
    return node;
};

BaseWidget.registerDOMMutationHandler = function () {
    var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type == "childList") {
                if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                    for (var i = 0; i < mutation.addedNodes.length; i ++) {
                        var container = mutation.addedNodes[i];
                        BaseWidget.signalOnAttachedRecursively(container);
                    }
                } else if (mutation.removedNodes && mutation.removedNodes.length > 0) {
                    for (var i = 0; i < mutation.removedNodes.length; i ++) {
                        var container = mutation.removedNodes[i];
                        BaseWidget.signalOnDetachedRecursively(container);
                    }
                }

            }
        });
    });
    observer.observe(document.body, { childList: true, subtree: true });
};

BaseWidget.closables = [];
BaseWidget._invalidateClosableForegroundStatus = function () {
    for (var i = 0; i < BaseWidget.closables.length; i ++) {
        var closable = BaseWidget.closables[i];
        if (closable && closable.setOnForeground) closable.setOnForeground(i == BaseWidget.closables.length - 1);
    }
    Dom.toggleClass(document.body, "HasClosables", BaseWidget.closables.length > 0);
};
BaseWidget.registerClosable = function (closable) {
    BaseWidget.tryRegisterCloseHandlers();

    BaseWidget.unregisterClosable(closable, "dontInvalidateForeground");
    BaseWidget.closables.push(closable);

    BaseWidget._invalidateClosableForegroundStatus();
};
BaseWidget.unregisterClosable = function (closable, dontInvalidateForeground) {
    var index = BaseWidget.closables.indexOf(closable);
    if (index >= 0) BaseWidget.closables.splice(index, 1);

    if (!dontInvalidateForeground) BaseWidget._invalidateClosableForegroundStatus();
};
BaseWidget.handleClosableEscapeKey = function (event) {
    if (BaseWidget.closables.length == 0) return;
    var closable = BaseWidget.closables[BaseWidget.closables.length - 1];
    var shouldClose = closable.canCloseNow ? closable.canCloseNow() : true;
    if (typeof(shouldClose) == "undefined") shouldClose = true;

    if (shouldClose) {
        closable.close();
        BaseWidget.unregisterClosable(closable);
        event.preventDefault();
        Dom.cancelEvent(event);
    }
};
BaseWidget.handleGlobalMouseDown = function (event) {
    if (BaseWidget.closables.length == 0) return;
    var closable = BaseWidget.closables[BaseWidget.closables.length - 1];
    var container = closable.getClosableContainer ? closable.getClosableContainer() : closable;
    var found = Dom.findUpward(event.target, function (node) {
        return node == container;
    });
    if (found) return;

    var shouldClose = closable.shouldCloseOnBlur ? closable.shouldCloseOnBlur(event) : false;
    if (!shouldClose) return;

    closable.close("onBlur");
    BaseWidget.unregisterClosable(closable);
    event.stopPropagation();
    event.preventDefault();
    Dom.cancelEvent(event);
};

BaseWidget.tryRegisterCloseHandlers = function () {
    if (BaseWidget.closeHandlersRegistered) return;

    window.addEventListener("keydown", function (event) {
        if (event.keyCode == DOM_VK_ESCAPE) {
            BaseWidget.__lastEscapeKeyDown = event.timeStamp;
        }
    }, false);
    window.addEventListener("keyup", function (event) {
        if (event.keyCode == DOM_VK_ESCAPE) {
            if (!BaseWidget.__lastEscapeKeyDown || (event.timeStamp - BaseWidget.__lastEscapeKeyDown > 1000)) return;
            BaseWidget.handleClosableEscapeKey(event);
        }
    }, false);


    document.body.addEventListener("mousedown", function (event) {
        BaseWidget.handleGlobalMouseDown(event);
    }, false);

    document.body.addEventListener("touchstart", function (event) {
        BaseWidget.handleGlobalMouseDown(event);
    }, false);

    BaseWidget.closeHandlersRegistered = true;
};
BaseWidget.findUpward = function (node, type) {
    var n = Dom.findUpward(node, function (x) {
        return x.__widget && x.__widget instanceof type;
    });

    return n ? n.__widget : null;
}
BaseWidget.collectChildWidgetsIn = function (node, type, transformer) {
    var items = [];
    for (var i = 0; i < node.childNodes.length; i ++) {
        var x = node.childNodes[i];
        if (x.__widget && x.__widget instanceof type) {
            var item = x.__widget;
            if (transformer) {
                item = transformer(item, items.length);
            }

            if (typeof(item) != "undefined") items.push(item);
        }
    }

    return items;
};
BaseWidget.prototype.findUpward = function (type) {
    return BaseWidget.findUpward(this.node(), type);
};

function BaseTemplatedWidget() {
    BaseWidget.call(this);
    try {
        ClientPropertyUtil.preprocessWidget(this);
    } catch (e) {
        console.error(e);
    }
}
__extend(BaseWidget, BaseTemplatedWidget);

BaseTemplatedWidget.prototype.buildDOMNode = function (providedContext) {
    var path = this.getTemplatePath();
    var node = widget.Util.loadTemplateAsNodeSync(path, providedContext || this, this.getOwnerDocument());

    if (node.localName && node.localName.toLowerCase() == "merge") {
        //load parent template and merge it
        var base = Object.create(__base(this));
        if (base && base.buildDOMNode) {
            var parentNode = base.buildDOMNode(this);

            for (var i = 0; i < node.childNodes.length; i ++) {
                var n = node.childNodes[i];
                if (!n.localName || !n.getAttribute) continue;

                var role = n.getAttribute("role");
                if (!role) continue;

                //find placeholder
                var container = parentNode.querySelector("*[container='" + role + "']");
                if (container) container.appendChild(n);
            }

            node = parentNode;
            Dom.addClass(node, widget.Util._generateClassNameForPath(path));
        }
    }

    return node;
};

BaseTemplatedWidget.getTemplatePrefix = function () {
    return __getFrameworkPrefix() + "js/widget/";
};
BaseTemplatedWidget.prototype.getTemplatePrefix = function () {
    if (this.__pathPrefix) return this.__pathPrefix;
    return BaseTemplatedWidget.getTemplatePrefix();
};
BaseTemplatedWidget.prototype.getTemplatePath = function () {
    return this.getTemplatePrefix() + this.constructor.name + ".xhtml";
};

function RadioGroup() {
    this.radios = [];
    this.valueMap = {};
    this.options = {};

    var thiz = this;
    var clickHandler = function (event) {
        thiz._handleClick(event);
    };
    for (var i = 0; i < arguments.length; i ++) {
        var arg = arguments[i];
        if (arg && arg.nodeName && arg.nodeName.toLowerCase() == "input" && arg.getAttribute("type") == "radio") {
            this.radios.push(arg);
            arg.addEventListener("click", clickHandler, false);
            this.valueMap[arg.value] = arg;
        } else if (arg && typeof(arg) == "object") {
            this.options = arg;
        }
    }
}
RadioGroup.prototype._handleClick = function (event) {
    var input = Dom.findParentByTagName(event.target, "input");
    if (!input) return;

    this.radios.forEach(function (radio) {
        if (radio != input) radio.checked = false;
    });

    if (this.options && this.options.onValueChanged) this.options.onValueChanged(this.getValue());
};
RadioGroup.prototype.setValue = function (value) {
    var selectedInput = this.valueMap["" + value];
    this.radios.forEach(function (radio) {
        radio.checked = (radio === selectedInput);
    });
};
RadioGroup.prototype.getValue = function () {
    var selectedInput = null;
    this.radios.forEach(function (radio) {
        if (radio.checked) selectedInput = radio;
    });

    return selectedInput && selectedInput.value;
};

//dynamic loading of widget modules via resource pack

var Util = (function () {
    function em() {
        if (Util._calculatedEM) return Util._calculatedEM;
        var div = document.createElement("div");
        var s = "mmmmmmmmmmmmmmmmmmmmmmmmmmm";
        div.innerHTML = s;
        document.body.appendChild(div);
        div.style.position = "absolute";
        div.style.top = "0px";
        div.style.opacity = "0";
        div.style.left = "0px";
        div.style.whiteSpace = "nowrap";

        Util._calculatedEM = div.offsetWidth / s.length;
        document.body.removeChild(div);
        return Util._calculatedEM;
    };
    function cropImage(image, centerCrop, notUpscale) {
        var w = image.naturalWidth;
        var h = image.naturalHeight;
        var W = image.parentNode.offsetWidth;
        var H = image.parentNode.offsetHeight;
        var r =  centerCrop === true ? Math.min(w / W, h / H) : Math.max(w / W, h / H);

        if (notUpscale && r < 1.0) r = 1;
        w = Math.round(w / r);
        h = Math.round(h / r);

        var dx = (W - w) / 2;
        var dy = (H - h) / 2;

        image.style.width = w + "px";
        image.style.height = h + "px";
        image.style.top = dy + "px";
        image.style.left = dx + "px";
        image.style.display = "inline-block";
        image.style.overflow = "hidden";
        image.setAttribute("data-crop", "" + centerCrop);
    }
    var SIZE = {
        t: {size: 300, name: "thumb"},
        s: {size: 700, name: "small"},
        m: {size: 1200, name: "med"},
        l: {size: 2000, name: "large"},
        h: {size: 3000, name: "huge"}
    };

    function getBestStorageUrlWithName(originalUrl, sizeName) {
        var sizeValue = null;
        for (var key in SIZE) {
            if (SIZE[key].name.toLowerCase() == sizeName.toLowerCase()) {
                sizeValue = SIZE[key].size;
                break;
            }
        }
        if (sizeValue) {
            return getBestStorageUrl(originalUrl, sizeValue, sizeValue);
        }
        return getBestStorageUrlWithInfo(originalUrl, null, null);
    };

    function getBestStorageUrl(originalUrl, w, h) {
        return getBestStorageUrlWithInfo(originalUrl, w, h).url;
    }
    function getBestStorageUrlWithInfo(originalUrl, w, h) {
        var re = /^(.+\-([tsmlh]+))(\-[a-z]+)\.(jpg|png)$/;
        if (!originalUrl || !originalUrl.match(re)) return {
            url: originalUrl,
            spec: null
        };
        var base = RegExp.$1;
        var ext = RegExp.$4;
        var codes = RegExp.$2;

        var best = null;
        var bestSize = 0;
        var max = null;
        var maxSize = 0;
        for (var i = 0; i < codes.length; i ++) {
            var code = codes[i];
            var spec = SIZE[code] || SIZE.h;
            if (spec.size >= w && spec.size >= h) {
                if (!best || bestSize > spec.size) {
                    best = spec;
                    bestSize = spec.size;
                }
            }
            if (!max || maxSize < spec.size) {
                max = spec;
                maxSize = spec.size;
            }
        }

        if (!best) best = max;
        return {
            url: base + "-" + best.name + "." + ext,
            spec: best
        };
    }
    function contains(list, item, comparer) {
        return findItemByComparer(list, item, comparer) >= 0;
    }

    function sameList(a, b, comparer) {
        return containsAll(a, b, comparer) && containsAll(b, a, comparer);
    };
    function containsAll(a, b, comparer) {
        var c = comparer || sameId;
        for (var i = 0; i < b.length; i ++) {
            if (!contains(a, b[i], c)) return false;
        }

        return true;
    };
    function intersect(a, b, comparer) {
        if (!a || !b) return [];
        var items = [];
        for (var i = 0; i < a.length; i ++) {
            if (contains(b, a[i], comparer)) {
                items.push(a[i]);
            }
        }

        return items;
    };
    function sameRelax(a, b) {
        return a == b;
    }

    function sameId(a, b) {
        return a && b && a.id == b.id;
    }

    function findItemByComparer(list, item, comparer) {
        for (var i = 0; i < list.length; i ++) {
            if (comparer(list[i], item)) return i;
        }

        return -1;
    }
    function removeItemByComparer(list, item, comparer) {
        var result = [];
        for (var i = 0; i < list.length; i ++) {
            if (!comparer(list[i], item)) {
                result.push(list[i]);
            }
        }

        return result;
    }
    function find(list, matcher) {
        for (var i = 0; i < list.length; i ++) {
            if (matcher(list[i])) return list[i];
        }

        return null;
    }
    function findById(list, id) {
        return find(list, function (u) { return u.id == id; });
    }

    var uuidGenerator = {
        generateUUID: function () {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = (window.crypto || window.msCrypto).getRandomValues(new Uint8Array(1))[0]%16|0, v = c == 'x' ? r : (r&0x3|0x8);
                return v.toString(16);
            });
        }
    };

    function newUUID () {
        var uuid = Util.uuidGenerator.generateUUID();
        return uuid.toString().replace(/[^0-9A-Z]+/gi, "");
    };

    var instanceToken = "" + (new Date()).getTime();
    function getInstanceToken () {
        return Util.instanceToken;
    };

    function enforceNumberInputHandler(e) {
        var event = Dom.getEvent(e);
        var input = Dom.getTarget(e);

        var delta = 0;
        if (event.keyCode == DOM_VK_UP) {
            delta = input._delta || 1;
        } else if (event.keyCode == DOM_VK_DOWN) {
            delta = -1 * (input._delta || 1);
        } else {
            return;
        }

        var x = input._integer ? parseInt(input.value, 10) : parseFloat(input.value);
        x += delta;
        if (input._min != null && typeof(input._min) != "undefined" && x < input._min) x = input._min;
        if (input._max != null && typeof(input._max) != "undefined" && x > input._max) x = input._max;

        var s = "" + x;
        if (input._paddingSize) {
            while (s.length < input._paddingSize) s = "0" + s;
        }

        input.value = s;
        input._lastGoodValue = input.value;
        Dom.emitEvent("p:Input", input, {});
    };


    function enforceNumberInputChangeHandler(e) {
        var input = Dom.getTarget(e);
        var x = null;
        try {
            if (input.value && input.value.match(input._integer ? /^[0-9]+$/ : /^[0-9\.]+$/)) {
                x = input._integer ? parseInt(input.value, 10) : parseFloat(input.value);
            }

            if (isNaN(x)) x = null;
        } catch (e) {}

        if ((x == null && input.value.length > 0)
                || (!isNaN(x) && input._min != null && typeof(input._min) != "undefined" && x < input._min)
                || (!isNaN(x) && input._max != null && typeof(input._max) != "undefined" && x > input._max)) {
            input.value = input._lastGoodValue;
        } else {
            // input.value = input.value;
            input._lastGoodValue = input.value;
        }
    };
    function enforceNumberInput(input, isInteger, min, max, padding) {
        if (isInteger) input._integer = true;
        input._min = min;
        input._max = max;
        input._paddingSize = padding;

        try {
            var x = input._integer ? parseInt(input.value, 10) : parseFloat(input.value);
            if (isNaN(x)) x = null;
        } catch (e) {}

        if (x != null) {
            input._lastGoodValue = input.value;
        } else {
            input._lastGoodValue = "";
        }

        Dom.registerEvent(input, "keydown", enforceNumberInputHandler, false);
        Dom.registerEvent(input, "input", enforceNumberInputChangeHandler, false);
    };
    function dataURIToBlob(dataURI) {
        var byteString;
        if (dataURI.split(',')[0].indexOf('base64') >= 0)
            byteString = atob(dataURI.split(',')[1]);
        else
            byteString = unescape(dataURI.split(',')[1]);

        // separate out the mime component
        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

        // write the bytes of the string to a typed array
        var ia = new Uint8Array(byteString.length);
        for (var i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
        }

        return new Blob([ia], {type:mimeString});
    }
    function idMapFunction(model) {
        return model.id;
    }

    function getProperty(data, name, defaultValue) {
        if (!data) return defaultValue;
        if (data.getAttribute) return data.getAttribute(name) || defaultValue;
        return data[name] || defaultValue;
    }

    function formatNumber(number, options) {
        if (isNaN(number)) return "";
        return new Intl.NumberFormat((window.LOCALE && window.LOCALE.language) || "en-US", options || {}).format(number);
    }

    var narrowSymbolSupported = true;
    try {
        toCurrency(0);
        narrowSymbolSupported = true;
        //console.log('Narrow Symbol support');
    } catch(e) {
        console.log(e);
        narrowSymbolSupported = false;
        console.log('Narrow Symbol NOT support');
    }

    function toCurrency(number, options) {
        if (isNaN(number)) return "";
        if(!narrowSymbolSupported) {
            var currencySign = (window.LOCALE && window.LOCALE.currencySign) || "$";
            if (options && options.noSymbol) currencySign = "";

            return currencySign + formatNumber(number, {minimumFractionDigits: 2});
        }
        if (!options) options = {};
        options.style = "currency";
        options.currencyDisplay = "narrowSymbol";
        if (!options.currency) options.currency = (window.LOCALE && window.LOCALE.currencyCode) || "USD";
        var result = formatNumber(number, options);
        return !options.noSymbol ? result : result.replace(/[^0-9\,\-\.\s]+/g, "").trim();
    }

    function getCurrencyCode() {
        var currencyCode = (window.LOCALE && window.LOCALE.currencyCode) || "USD";
        return (currencyCode == "GBP" || currencyCode == "EUR" ? currencyCode : "USD")
    }

    function doPeriodically(fn, interval, associatedNode) {
        var handler = function () {
            if (!document.body.contains(associatedNode)) return;

            fn(function () {
                window.setTimeout(handler, interval);
            });
        };

        handler();
    }

    function getEnumValues(enumType) {
        var vals = [];
        if (!enumType) return vals;
        for (var key in enumType) {
            if (enumType.hasOwnProperty(key) ) {
                vals.push(enumType[key]);
            }
        }
        return vals;
    }

    function clone (obj) {
        if (obj === null || typeof(obj) !== 'object' || '_cloning' in obj) return obj;

        var temp;
        if (obj instanceof Date) {
            return new Date(obj.getTime());
        } else if (obj instanceof Array) {
            temp = [];
            obj.forEach(function (x) {
                temp.push(clone(x));
            });

            return temp;
        }

        temp = {};

        for (var key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
                obj._cloning = null;
                temp[key] = clone(obj[key]);
                delete obj._cloning;
            }
        }

        return temp;
    }
    function getInputValueAsIntNumber(value, defaultValue) {
        if (typeof(value) == "string") value = value.replace(/\,/g, "")
        var number = isNaN(value) ? NaN : parseInt(value);
        return isNaN(number) ? (typeof(defaultValue) != "undefined" ? defaultValue : NaN) : number;
    }
    function getInputValueAsFloatNumber(value, defaultValue) {
        if (typeof(value) == "string") value = value.replace(/\,/g, "")
        var number = isNaN(value) ? NaN : parseFloat(value);
        return isNaN(number) ? (typeof(defaultValue) != "undefined" ? defaultValue : NaN) : number;
    }
    function setInnerHTMLWithScript(elm, html) {
        if (!elm) return;
        if (!html) html = "";
        var thiz = this;
        elm.innerHTML = html;
        var loadResources = [];
        var scripts = elm.getElementsByTagName("script");
        var scriptsClone = [];
        for (var i = 0; i < scripts.length; i++) {
            scriptsClone.push(scripts[i]);
        }
        for (var i = 0; i < scriptsClone.length; i++) {
            var currentScript = scriptsClone[i];
            var s = document.createElement("script");
            for (var j = 0; j < currentScript.attributes.length; j++) {
                var a = currentScript.attributes[j];
                s.setAttribute(a.name, a.value);
            }
            var beforeHtml = currentScript.innerHTML.trim().replace(/\/\*(.|[\r\n])*?\*\//g, '').replace(/\/\/.*/gm, '');
            var changeScript = beforeHtml && beforeHtml.length > 0;
            if (changeScript) {
                try {
                    s.appendChild(document.createTextNode(beforeHtml));
                    currentScript.parentNode.replaceChild(s, currentScript);
                    loadResources.push(s);
                } catch (e) {
                    console.log("Exception with: ", beforeHtml);
                }
            }
        }
        return loadResources;
    }

    function initiateDownload(url) {
        var link = document.createElement("a");
        link.download = url.substring(url.lastIndexOf('/') + 1);
        link.href = url;
        link.setAttribute("style", "display: inline-block; width: 1px; height: 1px; overflow: hidden; position: absolute; top: -20px;");

        document.body.appendChild(link);
        link.click();

        setTimeout(function () {
            document.body.removeChild(link);
        }, 1000);
    }
    function getPreferredBreakpointName(container) {
        var width = Dom.getOffsetWidth(container || document.body);
        var sizings = [];
        for (var name in BaseWidget.RESPONSIVE_BREAKPOINTS) {
            var size = BaseWidget.RESPONSIVE_BREAKPOINTS[name];
            if (width >= size) sizings.push(name);
        }
        if (sizings.length > 0) return sizings[sizings.length -1];
        return "";
    }

    function isMobileUI(container) {
        var s = getPreferredBreakpointName(container || document.body, "md");
        var isMobileUI = (!s || s.length <= 0 || "md" == s || "sm" == s);
        return isMobileUI;
    }
    function isUnderMdUI(container) {
        var s = getPreferredBreakpointName(container || document.body, "md");
        var isUnderMdUI = (!s || s.length <= 0 || "sm" == s);
        return isUnderMdUI;
    }
    function isTabletUI(container) {
        var s = getPreferredBreakpointName(container || document.body, "lg");
        var isTabletUI = "lg" == s;
        return isTabletUI;
    }
    function isUnderMdUI(container) {
        var s = getPreferredBreakpointName(container || document.body, "md");
        var isUnderMdUI = (!s || s.length <= 0 || "sm" == s);
        return isUnderMdUI;
    }

    var OSName = "Unknown";
    if (window.navigator.userAgent.indexOf("Windows")!= -1) OSName="Windows";
    if (window.navigator.userAgent.indexOf("Mac") != -1) OSName="Mac_iOS";
    if (window.navigator.userAgent.indexOf("X11") != -1) OSName="UNIX";
    if (window.navigator.userAgent.indexOf("Linux") != -1) OSName="Linux";


    return {
        em: em,
        cropImage: cropImage,
        contains: contains,
        sameList: sameList,
        containsAll: containsAll,
        intersect: intersect,
        findItemByComparer: findItemByComparer,
        removeItemByComparer: removeItemByComparer,
        find: find,
        findById: findById,
        uuidGenerator: uuidGenerator,
        newUUID: newUUID,
        instanceToken: instanceToken,
        getInstanceToken: getInstanceToken,
        sameId: sameId,
        sameRelax: sameRelax,
        enforceNumberInput: enforceNumberInput,
        dataURIToBlob: dataURIToBlob,
        idMapFunction: idMapFunction,
        getProperty: getProperty,
        linux: /Linux/.test(window.navigator.platform),
        getBestStorageUrlWithName: getBestStorageUrlWithName,
        getBestStorageUrl: getBestStorageUrl,
        getBestStorageUrlWithInfo: getBestStorageUrlWithInfo,
        doPeriodically: doPeriodically,
        formatNumber: formatNumber,
        toCurrency: toCurrency,
        getCurrencyCode: getCurrencyCode,
        getEnumValues: getEnumValues,
        clone: clone,
        getInputValueAsIntNumber: getInputValueAsIntNumber,
        getInputValueAsFloatNumber: getInputValueAsFloatNumber,
        setInnerHTMLWithScript: setInnerHTMLWithScript,
        initiateDownload: initiateDownload,
        osName: OSName,
        getPreferredBreakpointName: getPreferredBreakpointName,
        isMobileUI: isMobileUI,
        isTabletUI: isTabletUI,
        isUnderMdUI: isUnderMdUI
    }

} ());


widget.busyIndicator = (function () {
    var busyCount = 0;
    var currentBusyOverlay = null;

    function showBusyIndicator() {
        currentBusyOverlay = document.createElement("div");
        document.body.appendChild(currentBusyOverlay);
        currentBusyOverlay.style.cssText = "position: absolute; z-index:1000; top: 0px; left: 0px; right: 0px; bottom: 0px; cursor: wait;";
    }
    function hideBusyIndicator() {
        if (currentBusyOverlay) {
            if (currentBusyOverlay.parentNode) currentBusyOverlay.parentNode.removeChild(currentBusyOverlay);
            currentBusyOverlay = null;
        }
    }
    function busy() {
        busyCount ++;
        if (busyCount == 1) showBusyIndicator();
    }
    function unbusy() {
        if (busyCount > 0) busyCount --;
        if (busyCount == 0) hideBusyIndicator();
    }

    return {
        busy: busy,
        unbusy: unbusy
    }
})();

window.__busyIndicator = widget.busyIndicator;
window.APP_THEME_PATH = __getFrameworkPrefix() + "style/theme-default-includes.less";


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ImageView.js";

function ImageView(node) {
    BaseTemplatedWidget.call(this);
    this.url = node.getAttribute("url") || "";
    if (this.url.length && this.url.length > 0) this.pending = true;
    this.centerCrop = node.getAttribute("crop-center") || true;
    this.notUpscale = node.getAttribute("notUpscale") || true;

    this.bind("load", function () {
        this.imageSize = {
            w: this.image.naturalWidth,
            h: this.image.naturalHeight
        };
        this.image.style.display = "inline-block";
        Util.cropImage(this.image, this.centerCrop, this.notUpscale);
        Dom.emitEvent("p:ImageSizeAvailable", this.node(), {});
        if (this._indicator && this._indicator.done) {
            this._indicator.done();
        }
    }, this.image);

    this.bind("error", function () {
        if (this._indicator && this._indicator.done) {
            this._indicator.done();
        }
        this.imageSize = null;
        if (this.retried || !this.fallbackUrl) return;
        this.retried = true;
        this.image.src = this.fallbackUrl;

    }, this.image);
}
__extend(BaseTemplatedWidget, ImageView);

ImageView.prototype.setCenterCrop = function(centerCrop) {
    this.centerCrop = centerCrop;
};

ImageView.prototype.setIndicator = function(indicator) {
    this._indicator = indicator;
};

ImageView.prototype.setNotUpscale = function(notUpscale) {
    this.notUpscale = notUpscale;
};

ImageView.prototype.setUrl = function(url, fallbackUrl) {
    this.imageSize = null;
    this.url = url;
    this.fallbackUrl = fallbackUrl;
    if (this.fallbackUrl) this.retried = false;
    if (this.attached) {
        this.startLoading();
    } else {
        this.pending = true;
    }
};

ImageView.prototype.ensureSizing = function() {
    Util.cropImage(this.image, this.centerCrop, this.notUpscale);
}

ImageView.prototype.startLoading = function() {
    this.pending = false;
    this.image.style.display = "none";
    this.image.src = this.url;
    if (this._indicator && this._indicator.busy) this._indicator.busy();
};

ImageView.prototype.onAttached = function() {
    this.attached = true;
    if (this.pending) this.startLoading();
};
ImageView.prototype.getImageSize = function() {
    return this.imageSize;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/SimpleImageView.js";

function SimpleImageView(node) {
    BaseTemplatedWidget.call(this);
    var centerCropped = Dom.getAttributeAsBoolean(node, "center-cropped", false);
    this.setCenterCropped(centerCropped);
    
    var url = Dom.getAttributeAsString(node, "url", null);
    if (url) this.setUrl(url);
}
__extend(BaseTemplatedWidget, SimpleImageView);

SimpleImageView.prototype.setCenterCropped = function(centerCropped) {
    this._centerCropped = centerCropped;
    Dom.toggleClass(this.node(), "CenterCropped", centerCropped ? true : false);
};

SimpleImageView.prototype.setUrl = function(url) {
    this._url = url;
    this.image.src = url;
    this.node().style.backgroundImage = "url(" + url + ")";
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ProgressBar.js";

function ProgressBar() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, ProgressBar);

ProgressBar.prototype.setProgress = function (percent, message) {
    if (typeof(percent) == "undefined") {
        this.setMessage(message);
        return;
    }
    Dom.addClass(this.container, "ProgressOnly");
    this.progressBarInner.style.width =  percent + "%";
    this.statusLabel.innerHTML = Dom.htmlEncode(message || "Please wait...");
}
ProgressBar.prototype.setMessage = function(message) {
    this.statusLabel.innerHTML = Dom.htmlEncode(message || "Please wait...");
    Dom.removeClass(this.container, "ProgressOnly");
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/SplitView.js";

var SplitView = function () {
    var currentSplitView = null;
    function getSplitView(target) {
        var container = Dom.findParentWithProperty(target, "_splitView");
        if (!container) return null;
        return container._splitView;
    }
    function handleMouseDown(event) {
        Dom.cancelEvent(event);
        var target = Dom.getTarget(event);
        currentSplitView = getSplitView(target);

        if (!currentSplitView) return;
        currentSplitView.ox = event.pageX;
        currentSplitView.originalSplitViewX = currentSplitView.splitViewPos;
        currentSplitView.moved = false;
        Dom.addClass(currentSplitView.container, "SplitViewHeld");
    }

    function handleMouseMove(event) {
        var target = Dom.getTarget(event);
        if (!currentSplitView) return;
        Dom.cancelEvent(event);

        var x = event.pageX;
        var p = currentSplitView.originalSplitViewX + x - currentSplitView.ox;
        var W = Dom.getOffsetWidth(currentSplitView.container);

        var margin = Math.round(W / 10);
        p = Math.min(Math.max(p, margin), W - margin);
        currentSplitView.setSplitViewPosition(p);
        currentSplitView.moved = true;
    }

    function handleMouseUp(event) {
        Dom.cancelEvent(event);
        if (!currentSplitView) return;
        if (!currentSplitView.moved) return;
        currentSplitView.moved = false;
        var r = (currentSplitView.splitViewPos / Dom.getOffsetWidth(currentSplitView.container));
        currentSplitView.ratio = r;
        currentSplitView.updateView();
    	BaseWidget.signalOnSizeChangedRecursively(currentSplitView.node());

        Dom.removeClass(currentSplitView.container, "SplitViewHeld");
        currentSplitView = null;
    }

    function SplitView() {
        BaseWidget.call(this);
        this.container = this.node();
        this.container._splitView = this;
        Dom.addClass(this.container, "SplitView");
        
        this.container.style.position = "relative";
    }
    __extend(BaseWidget, SplitView);

    SplitView.MODE_LEFT = "LEFT";
    SplitView.MODE_RIGHT = "RIGHT";
    SplitView.MODE_BOTH = "BOTH";
    SplitView.HANDLE_WIDTH = 10;

    SplitView.prototype.setContentFragment = function (fragment) {
        for (var i = 0; i < fragment.childNodes.length; i ++) {
            var node = fragment.childNodes[i];
            if (!node.nodeName || !node.getAttribute) continue;
            if (!this.left) {
                this.left = node;
                this.node().appendChild(node);
                Dom.addClass(this.left, "sys-viewport");
            } else {
                if (!this.right) {
                    this.right = node;
                    this.node().appendChild(node);
                    Dom.addClass(this.right, "sys-viewport");
                }
            }
        }
        this.splitter = this.node().ownerDocument.createElement("div");
        this.splitter.setAttribute("role", "splitter");
        this.node().appendChild(this.splitter);
    };

    SplitView.prototype.setup = function (options) {
        if (this._setupCalled) return;
        this._setupCalled = true;

        this.options = options || {};

        if (!this.options.initialRatio) this.options.initialRatio = 0.5;
        this.ratio = this.options.initialRatio;

        if (!this.options.initialMode) this.options.initialMode = SplitView.MODE_BOTH;
        this.mode = this.options.initialMode;

        Dom.registerEvent(this.splitter, "mousedown", handleMouseDown);
        Dom.registerEvent(document, "mousemove", handleMouseMove);
        Dom.registerEvent(document, "mouseup", handleMouseUp);

        Dom.addClass(this.splitter, "SplitViewSplitter");
        this.splitter.innerHTML = this.options.keepSplitterVisible ? "<div class=\"Kept\"></div>" : "<div></div>";

        this.splitter.style.position = "absolute";
        this.splitter.style.top = "0px";
        this.splitter.style.bottom = "0px";
        this.splitter.style.overflow = "hidden";
        this.splitter.style.width = SplitView.HANDLE_WIDTH + "px";

        this.left.style.position = "absolute";
        this.left.style.left = "0px";
        this.left.style.top = "0px";
        this.left.style.bottom = "0px";

        this.right.style.position = "absolute";
        this.right.style.top = "0px";
        this.right.style.bottom = "0px";

        this.updateView();
    };

    SplitView.prototype.setMode = function (mode) {
        this.mode = mode;
        this.updateView();
    };
    SplitView.prototype.setRatio = function (ratio) {
        this.ratio = ratio;
        this.updateView();
    };
    SplitView.prototype.getRatioFromFixedSize = function (size) {
        var w = Dom.getOffsetWidth(this.container);
        return size / w;
    };

    SplitView.prototype.updateView = function () {
        Dom.addClass(this.container, "SplitView" + this.mode);
        var w = Dom.getOffsetWidth(this.container);
        if (this.mode == SplitView.MODE_LEFT) {
            this.left.style.left = "0px";
            this.left.style.right = "0px";
            this.left.style.width = w + "px";
            Dom.show(this.left);

            Dom.hide(this.splitter);
            this.right.style.display = "none";
            this.right.style.width = "0px";

        } else if (this.mode == SplitView.MODE_RIGHT) {

            this.right.style.left = "0px";
            this.right.style.right = "0px";
            this.right.style.width =  w + "px";
            this.right.style.display = "block";
            Dom.show(this.right);

            Dom.hide(this.splitter);
            this.left.style.display = "none";
            this.left.style.width = "0px";
        } else if (this.mode == SplitView.MODE_BOTH) {
            var lw = Math.round(w * this.ratio);
            var rw = w - lw;

            var margin = this.options.margin || 0;

            this.left.style.left = "0px";
            this.left.style.right = (rw + margin) + "px";
            this.left.style.width = (lw - margin) + "px";

            this.right.style.left = (lw + margin) + "px";
            this.right.style.right = "0px";
            this.right.style.width = (rw - margin) + "px";

            this.setSplitViewPosition(lw);

            Dom.show(this.left);
            Dom.show(this.splitter);
            Dom.show(this.right);
            if (this.listener) {
            	this.listener(lw, rw);
            }
        }

        if (this.left) BaseWidget.invalidateResponsiveBreakpointClasses(this.left);
        if (this.right) BaseWidget.invalidateResponsiveBreakpointClasses(this.right);
    };

    SplitView.prototype.onSizeChanged = function () {
        this.updateView();
    };


    SplitView.prototype.setSplitViewPosition = function (pos) {
        this.splitter.style.left = (pos - SplitView.HANDLE_WIDTH / 2) + "px";
        this.splitViewPos = pos;
    };

    SplitView.prototype.setOnResizeListener = function(listener) {
    	this.listener = listener;
    	return this;
    };

    SplitView.prototype.onAttached = function () {
        this.setup({
            initialRatio: 0.2,
            margin: 2,
            keepSplitterVisible: true
        });
    };

    return SplitView;
}();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/Dialog.js";

function Dialog() {
    BaseTemplatedWidget.call(this);

    this.bind("click", this.handleActionClick, this.dialogFooter);
    this.bind("click", this.handleCloseClick, this.dialogClose);
    this.bind("mousedown", this.handleHeaderMouseDown, this.dialogHeaderPane);
    this.bind("keypress", this.handleBodyKeyPress, this.dialogBody);

    Dialog.ensureGlobalHandlers();
}
__extend(BaseTemplatedWidget, Dialog);

Dialog.ACTION_CANCEL = { type: "cancel", title: "Cancel", run: function () { return true; } };
Dialog.ACTION_CLOSE = { type: "cancel", title: "Close", run: function () { return true; } };
Dialog.TOP_OFFSET = 0;

Dialog.ensureGlobalHandlers = function () {
    if (Dialog.globalHandlersRegistered) return;

    Dialog.getOwnerDocument().addEventListener("mousemove", Dialog.globalMouseMoveHandler, false);
    Dialog.getOwnerDocument().addEventListener("mouseup", function (event) {
        if (Dialog.heldInstance) Dialog.heldInstance._setupBuiltInTransition();
        Dialog.heldInstance = null;
    }, false);

    Dialog.globalHandlersRegistered = true;
};

Dialog.prototype.setOnForeground = function (foreground) {
    Dom.toggleClass(this.dialogFrame, "ClosableForeground", foreground);
};
Dialog.prototype.canCloseNow = function () {
    if (this._busyCount) return false;

    if (this.closeHandler) return this.closeHandler.apply(this);
    return false;
}
Dialog.prototype.isEmbedded = function () {
    return this._container ? true : false;
}
Dialog.prototype.getFrameTemplate = function () {
    return BaseTemplatedWidget.getTemplatePrefix() + "Dialog.xhtml";
};
Dialog.prototype.buildDOMNode = function () {
    var frameTemplate = this.getFrameTemplate();
    var node = widget.Util.loadTemplateAsNodeSync(frameTemplate, this);

    //load also the sub-class template into the dialog body
    //please note that the binding will be done for both templates
    var contentNode = this.buildContentNode();

    if (this.grabHeight && !this.dontStretchBody) contentNode.setAttribute("flex", "1");
    this.dialogBody.appendChild(contentNode);
    this.dialogContentNode = contentNode;

    Dom.addClass(this.dialogFrame, "DialogFrame_" + this.constructor.name);
    this.dialogFrame._dialog = this;
    if (this.__getNamespace) Dom.addClass(this.dialogContentNode, "namespace_" + this.__getNamespace());

    return node;
};
Dialog.prototype.buildContentNode = function () {
    return widget.Util.loadTemplateAsNodeSync(this.getTemplatePath(), this, Dialog.getOwnerDocument());
};
Dialog.prototype.open = function (options) {
    var postSetupAction = function () {
        this.invalidateElements();
        this.show();
    }.bind(this);

    if (this.setup) {
        this.setup(options);
        postSetupAction();
    } else if (this.asyncSetup) {
        this.asyncSetup(options, postSetupAction);
    } else {
        postSetupAction();
    }
};
Dialog.findContainerDialog = function (node) {
    return Dom.findUpwardForData(node, "_dialog");
}
var DIALOG_BUTTON_ORDER = {
    "accept": Util.linux ? 10 : 1,
    "cancel": Util.linux ? 1 : 10,
    "extra1": -10,
    "extra2": -9,
    "extra3": -8
};
Dialog.prototype.invalidateElements = function () {
    var actions = this.getDialogActions();

    var startActions = [];
    var endOptions = [];

    this.closeHandler = null;
    this.positiveHandler = null;
    this.primaryButton = null;

    actions.forEach(function (a) {
        if (a.isValid && !a.isValid()) return;
        a.order = a.order || DIALOG_BUTTON_ORDER[a.type];
        if (typeof(a.order) == "undefined") a.order = -99;

        if (a.type == "cancel") {
            this.closeHandler = a.run;
        } else if (a.type == "accept") {
            this.positiveHandler = a.run;
        }
    }, this);

    actions.sort(function (a1, a2) {
        return a1.order - a2.order;
    });

    Dom.empty(this.dialogFooterStartPane);
    Dom.empty(this.dialogFooterMiddlePane);
    Dom.empty(this.dialogFooterEndPane);

    var showUnapplicableButtons = this.shouldShowUnapplicableButtons && this.shouldShowUnapplicableButtons();
    
    actions.forEach(function (a) {
        var applicable = !a.isApplicable || a.isApplicable();

        if (!applicable && !showUnapplicableButtons) return;

        var button = this.createButton(a);

        if (!applicable) button.setAttribute("disabled", "true");

        if (a.order < 0) {
            this.dialogFooterStartPane.appendChild(button);
        } else if (a.order == 0) {
            this.dialogFooterMiddlePane.appendChild(button);
        } else {
            this.dialogFooterEndPane.appendChild(button);
        }

        if (a.type == "accept") this.primaryButton = button;
    }, this);


    Dom.empty(this.dialogTitle);
    this.dialogTitle.appendChild(Dialog.getOwnerDocument().createTextNode(this.e(this.title)));

    Dom.empty(this.dialogSubTitle);
    this.dialogSubTitle.appendChild(Dialog.getOwnerDocument().createTextNode(this.e(this.subTitle || "")));

    this.dialogClose.style.display = this.closeHandler ? "inline-block" : "none";

    if (this.onInvalidateElements) {
        this.onInvalidateElements();
    }
};

Dialog._handleMouseOverForExplanation = function (event) {
    var button = Dom.findUpwardForNodeWithData(event.target, "_explanation");
    if (!button) return;

    if (button._explanationHideTimer) {
        window.clearTimeout(button._explanationHideTimer);
        button._explanationHideTimer = null;
        return;
    }

    if (button._infoTip) {
        button._infoTip.hide();
        button._infoTip.kill();
    }

    button._infoTip = InfoTip.show(button._explanationIcon, button._explanation, false, null, "tooltip", "left-inside", -(Dom.getOffsetWidth(button._explanationIcon) / 2 + 12), -5);
};
Dialog._handleMouseOutForExplanation = function (event) {
    var button = Dom.findUpwardForNodeWithData(event.target, "_explanation");
    if (!button) return;

    button._explanationHideTimer = window.setTimeout(function () {
        if (button._infoTip) {
            button._infoTip.hide();
            button._infoTip.kill();
            button._infoTip = null;
        }
        button._explanationHideTimer = null;
    }, 100);
};
Dialog.prototype.createButton = function (action) {
    var button = null;
    if (action.builder) {
        button = action.builder.call(this, action);
    } else {
        button = Dialog.getOwnerDocument().createElement("button");
        var icon = this.e(action.icon);
        if (icon) {
            var i = Dialog.getOwnerDocument().createElement("icon");
            Dom.addClass(i, icon)
            button.appendChild(i);
        }

        var text = this.e(action.title);
        var titleNode = Dialog.getOwnerDocument().createTextNode(text);

        var explanation = action.explanation && this.e(action.explanation);
        if (explanation) {
            var span = Dialog.getOwnerDocument().createElement("span");
            Dom.addClass(span, "ButtonTitle")
            span.appendChild(titleNode);

            var i = Dialog.getOwnerDocument().createElement("icon");
            Dom.addClass(i, "alert");
            span.appendChild(i);
            titleNode = span;
            button._explanation = explanation;
            button._explanationIcon = i;

            span.addEventListener("mouseover", Dialog._handleMouseOverForExplanation, false);
            span.addEventListener("mouseout", Dialog._handleMouseOutForExplanation, false);
        }

        button.appendChild(titleNode);
    }
    button._action = action;
    
    if (action.type == "accept") button.setAttribute("role", "primary");
    if (action.isDangerous) {
        button.setAttribute("mode", "danger");
    } else {
        button.setAttribute("mode", action.type);
    }
    var disabled = action.isEnabled && !action.isEnabled();
    if (disabled) button.setAttribute("disabled", "true");

    return button;
};
Dialog.prototype.into = function(container, data) {
    this._container = container;
    this.callback(function(edited) {
    }).open(data);
    return this;
}
Dialog.prototype.getFrameOverflowStyle = function () {
    return "visible";
};
Dialog.prototype.show = function () {
    this._originalFocusedTarget = Dialog.lastFocusedTarget;
    this.dialogFrame.parentNode.removeChild(this.dialogFrame);

    var viewport = window;

    if (this.overlay) {
        if (this.overlay.parentNode) this.overlay.parentNode.removeChild(this.overlay);
    }
    if (this._container) {
        Dom.empty(this._container);
        this._container.appendChild(this.dialogFrame);
    } else {
        this.overlay = Dialog.getOwnerDocument().createElement("div");
        Dom.addClass(this.overlay, "Sys_DialogOverlay");
        Dom.addClass(this.overlay, "Sys_DialogOverlay_" + this.constructor.name);
        if (this.getDialogOverlayExtraClass) Dom.addClass(this.overlay, this.getDialogOverlayExtraClass());
        Dialog.getOwnerDocument().body.appendChild(this.overlay);
        Dialog.getOwnerDocument().body.appendChild(this.dialogFrame);
        this.overlay.addEventListener("DOMMouseScroll", function (e) {
            Dom.cancelEvent(e);
        }, false);
    }
    this.dialogFrame.style.transform = "scale(1)";
    this.dialogFrame.style.left = "0px";
    this.dialogFrame.style.top = "0px";
    this.dialogFrame.style.position = "fixed";
    this.dialogFrame.style.visibility = "hidden";
    this.dialogFrame.style.display = "flex";
    this.dialogFrame.style.height = "auto";
    this.dialogFrame.style.overflow = this.getFrameOverflowStyle();
    this.dialogFrame.style.opacity = "0";
    if (!this.noBuiltInTransition) this.dialogFrame.style.transition = "opacity 0.1s";
    this.dialogBody.style.height = null;

    if (this.onBeforeShow) this.onBeforeShow();

    var thiz = this;
    setTimeout(function () {

        if (thiz._container) {
            thiz.dialogFrame.style.right = "0px";
            thiz.dialogFrame.style.bottom = "0px";
            thiz.dialogFrame.style.height = "100%";
            thiz.dialogFrame.style.width = "100%";
        } else {
            var offset = thiz.getInnerOffset();
            var maxW = viewport.innerWidth - offset.w;
            var maxH = viewport.innerHeight - offset.h - Dialog.TOP_OFFSET;

            if (Util.isMobileUI()) {
                maxH -= 5 * Util.em();
            }

            thiz.dialogFrame.style.width = "auto";

            var rect = thiz.dialogFrame.getBoundingClientRect();

            var w = rect.width;
            var h = rect.height;

            var height = Math.ceil(thiz.grabHeight ? maxH : Math.min(maxH, h)) + 1;
            if (height < h) {
                w += Dom.calculateSystemScrollbarSize().w + 1;
            }
            var width = Math.ceil(thiz.grabWidth ? maxW : Math.min(maxW, w)) + 1;

            thiz.dialogFrame.style.width = width + "px";
            thiz.dialogFrame.style.height = height + "px";
            thiz.dialogBody.style.height = Math.ceil(thiz.dialogBody.offsetHeight) + "px";
            thiz.dialogBody.style.boxSizing = "border-box";
        }

        thiz.dialogFrame.style.transform = "scale(0.9)";

        thiz.dialogFrame.style.visibility = "visible";

        thiz.dialogFrame.focus();
        if (thiz.onShown) thiz.onShown();

        if (thiz.onAfterShow) {
            window.setTimeout(function () {
                thiz.onAfterShow();
            }, 100);
        }

        if (!thiz._container) {
            thiz.alignToCenterWindow();
        }

        window.setTimeout(function () {
            thiz._shown = true;
            thiz._setupBuiltInTransition();
            thiz.dialogFrame.style.opacity = "1";
            thiz.dialogFrame.style.transform = "scale(1)";
            window.setTimeout(function () {
                thiz.dialogFrame.style.transform = "none";
            }, 300);
        }, 10);
    }, 100);

    BaseWidget.registerClosable(this);
};
Dialog.prototype._setupBuiltInTransition = function () {
    if (!this.noBuiltInTransition && this.dialogFrame.parentNode == document.body) {
        var transition = "opacity 0.2s, transform 0.1s cubic-bezier(0.68, -0.5, 0.265, 1.55)";
        if (this._useSmoothReszing) transition = "top 0.2s, left 0.2s, width 0.2s, height 0.2s, " + transition;
        this.dialogFrame.style.transition = transition;
    }
};

Dialog.DEFAULT_INNER_OFFSET = {w: 110, h: 30};
Dialog.DEFAULT_INNER_MOBILE_OFFSET = {w: 30, h: 70};
Dialog.DEFAULT_INNER_TABLET_OFFSET = {w: 70, h: 50};

Dialog.prototype.getInnerOffset = function () {
    if (Util.isMobileUI()) return Dialog.DEFAULT_INNER_MOBILE_OFFSET;
    if (Util.isTabletUI()) return Dialog.DEFAULT_INNER_TABLET_OFFSET;
    return Dialog.DEFAULT_INNER_OFFSET;
};
Dialog.prototype.invalidateSizing = function () {
    if (this._container) return;
    var viewport = Dialog.getOwnerWindow();

    var offset = this.getInnerOffset();
    var maxW = viewport.innerWidth - offset.w;
    var maxH = viewport.innerHeight - offset.h - Dialog.TOP_OFFSET;
    if (Util.isMobileUI()) {
        maxH -= 5 * Util.em();
    }

    var ow = this.dialogFrame.offsetWidth;
    var oh = this.dialogFrame.offsetHeight;

    this.dialogFrame.style.height = "auto";
    this.dialogFrame.style.width = "auto";
    this.dialogBody.style.height = null;

    var w = this.dialogFrame.offsetWidth;
    var h = this.dialogFrame.offsetHeight;

    var height = Math.ceil(this.grabHeight ? maxH : Math.min(maxH, h)) + 1;
    if (height < h) {
        w += Dom.calculateSystemScrollbarSize().w + 1;
    }
    var width = Math.ceil(this.grabWidth ? maxW : Math.min(maxW, w)) + 1;

    var runnable = function () {
        this.dialogFrame.style.width = width + "px";
        this.dialogFrame.style.height = height + "px";
        this.dialogBody.style.height = Math.ceil(this.dialogBody.offsetHeight) + "px";
        this.dialogBody.style.boxSizing = "border-box";

        this.alignToCenterWindow(width, height);

    }.bind(this);

    if (this._shown && this._useSmoothReszing) {
        Dom.addClass(this.dialogFrame, "Resizing");
        this.dialogFrame.style.width = ow + "px";
        this.dialogFrame.style.height = oh + "px";
        var thiz = this;

        window.setTimeout(runnable, 1);
        window.setTimeout(function () {
            Dom.addClass(thiz.dialogFrame, "Resizing");
        }, 202);
    } else {
        runnable();
    }

};
Dialog.prototype.alignToCenterWindow = function (providedWidth, providedHeight) {
    if (this._container) return;
    var viewport = Dialog.getOwnerWindow();

    var screenW = viewport.innerWidth;
    var screenH = viewport.innerHeight - Dialog.TOP_OFFSET;

    var w = providedWidth || this.dialogFrame.offsetWidth;
    var h = providedHeight || this.dialogFrame.offsetHeight;

    var offset = this.getFrameOffset ? this.getFrameOffset() : {x: 0, y: 0};

    var x = (screenW - w) / 2 + offset.x;
    var y = (screenH - h) / 3 + Dialog.TOP_OFFSET + offset.y; //NOTE: not actually centered. Having the dialog pulled up a little bit is better
    if (Util.isMobileUI()) {
        y -= 3 * Util.em();
    }


    this.moveTo(x, y);
};
Dialog.prototype.moveTo = function (x, y) {
    this.dialogFrame.style.left = x + "px";
    this.dialogFrame.style.top = Math.max(y, 0) + "px";
    this.dialogX = x;
    this.dialogY = y;

    Dom.emitEvent("p:DialogMoved", this.node(), {});
};
Dialog.prototype.moveBy = function (dx, dy) {
    this.moveTo(this.dialogX + dx, this.dialogY + dy);
};
Dialog.prototype.close = function () {
    if (this._container) return;

    if (this.overlay && this.overlay.parentNode) this.overlay.parentNode.removeChild(this.overlay);
    if (!this.noBuiltInTransition) this.dialogFrame.style.transition = "opacity 0.1s";
    this.dialogFrame.style.opacity = "0";

    var args = [];
    if (arguments.length > 0 && this.callbackFunction) {
        for (var i = 0; i < arguments.length; i ++) {
            args.push(arguments[i]);
        }
    }

    window.setTimeout(function () {
        if (this.dialogFrame.parentNode) this.dialogFrame.parentNode.removeChild(this.dialogFrame);
        this.dialogFrame.style.display = "none";
        if (this.overlay) this.overlay.style.display = "none";

        BaseWidget.unregisterClosable(this);

        if (this.callbackFunction) {
            this.callbackFunction.apply(window, args);
        }
        this.onHide();
        if (this._navigationModule) {
            try {
                CommonNavigation.onNavigationModuleClosed(this._navigationModule);
            } catch (e) {
                console.error(e);
            }
        }

        if (this._originalFocusedTarget) {
            try {
                this._originalFocusedTarget.focus({preventScroll: true});
            } catch (e) {
            }
        }
    }.bind(this), 100);
};
Dialog.prototype.onHide = function () {
};
Dialog.prototype.callback = function (callback) {
    this.callbackFunction = callback;
    return this;
};

Dialog.prototype.handleActionClick = function (event) {
    var action = Dom.findUpwardForData(event.target, "_action");
    if (!action) return;

    var disabled = action.isEnabled && !action.isEnabled();
    if (disabled) return;

    var applicable = !action.isApplicable || action.isApplicable();
    if (!applicable) return;

    var returnValue = action.run.call(this, action);
    if (returnValue) this.close();
};
Dialog.globalMouseMoveHandler = function (event) {
    if (!Dialog.heldInstance) return;

    Dom.cancelEvent(event);

    //if (Dialog.heldInstance.grabHeight && Dialog.heldInstance.grabWidth) return;

    var dx = event.screenX - Dialog._lastScreenX;
    var dy = event.screenY - Dialog._lastScreenY;

    Dialog._lastScreenX = event.screenX;
    Dialog._lastScreenY = event.screenY;

    Dialog.heldInstance.moveBy(dx, dy);
};
Dialog.globalFocusHandler = function (event) {
    Dialog.lastFocusedTarget = event.target;

    var ck = Dom.findParentWithClass("cke_dialog_body");
    if (ck) return;

    if (!BaseWidget.closables || BaseWidget.closables.length <= 0) return;
    var closable = BaseWidget.closables[BaseWidget.closables.length - 1];
    if (!__isSubClassOf(closable.constructor, Dialog)) return;

    var frame = Dom.findUpward(event.target, function (node) {
        return node == closable.dialogFrame;
    });

    if (frame) return;
    closable.dialogFrame.focus();
};
window.addEventListener("load", function () {
    Dialog.getOwnerDocument().addEventListener("focus", Dialog.globalFocusHandler, true);
}, false);

Dialog.getOwnerWindow = function () {
    return window;
};

Dialog.getOwnerDocument = function() {
    return Dialog.getOwnerWindow().document;
}

Dialog.prototype.handleCloseClick = function () {
    if (!this.closeHandler) return;
    var returnValue = this.closeHandler.apply(this);
    if (returnValue) this.close();
};
Dialog.prototype.handleHeaderMouseDown = function (event) {
    Dom.cancelEvent(event);
    Dialog.heldInstance = this;
    Dialog._lastScreenX = event.screenX;
    Dialog._lastScreenY = event.screenY;
    this.dialogFrame.style.transition = "none";
};
Dialog.prototype.handleBodyKeyPress = function (event) {
    if (event.keyCode != DOM_VK_RETURN) return;
    if (!this.primaryButton) return;

    var input = Dom.findUpward(event.target, function (node) {
        return node.localName == "input" || node.localName == "select";
    })

    if (!input) return;
    this.primaryButton.click();
};

// ServiceFactory busy-indicator interface implementation
Dialog.prototype.busy = function (message) {
    if (!this._busyCount) this._busyCount = 0;
    this._busyCount ++;

    Dom.addClass(this.dialogFrame, "Busy");
    if (this.progressWidget) {
        this.progressWidget.setMessage(message || "Please wait...");
    }
};
Dialog.prototype.done = function () {
    if (typeof this._busyCount == "number" && this._busyCount > 0) this._busyCount --;

    if (this._busyCount == 0) {
        Dom.removeClass(this.dialogFrame, "Busy");
        if (this.progressWidget) {
            this.progressWidget.setMessage("");
        }
    }
};
Dialog.prototype.failed = function (e) {
    _handleGenericError(e);
};
Dialog.prototype.progressed = function (loaded, total, message) {
    var p = undefined ;
    if (typeof(loaded) != "undefined" && typeof(total) != "undefined"
        && total > 0) {
        p = Math.round(100 * loaded / total);
    }
    if (this.progressWidget) {
        this.progressWidget.setProgress(p, message);
    }
};
Dialog.prototype.asCustomIndicator = function (message) {
    var thiz = this;
    return {
        busy: function () {
            thiz.busy(message);
        },
        done: function () {
            thiz.done();
        },
        failed: function (e) {
            thiz.failed(e);
        },
        progressed: function (loaded, total) {
            thiz.progressed(loaded, total);
        }
    }
};


function BuilderBasedDialog(builder) {
    this.builder = builder;
    this.builder._dialog = this;
    Dialog.call(this);

    this.title = typeof(builder.title) == "function" ? builder.title.bind(this.builder) : builder.title;
};

__extend(Dialog, BuilderBasedDialog);

var DIALOG_SIZE_SPECS = {
        tiny: 120,
        mini: 200,
        smaller: 280,
        small: 350,
        normal: 450,
        large: 600,
        "slightly-larger": 700,
        larger: 800,
        huge: 1010,
        xhuge: 1210,
        xxhuge: 1400
};

BuilderBasedDialog.prototype.buildContentNode = function () {
    var div = Dialog.getOwnerDocument().createElement("div");
    Dom.addClass(div, "DialogContentWrapper");
    if (this.builder.size) {
        var size = (DIALOG_SIZE_SPECS[this.builder.size] / 12) * Util.em();
        div.style.width = size + "px";
    }
    this.builder.buildContent.call(this.builder, div);

    this.contentDiv = div;

    return div;
}
BuilderBasedDialog.prototype._newLegacyAction = function (action) {
    return {
        title: typeof(action.title) == "function" ? action.title.bind(this.builder) : action.title,
        type: action.isCloseHandler ? "cancel" : (action.primary ? "accept" : "extra1"),
        isDangerous: action.isDangerous,
        isApplicable: action.isApplicable ? action.isApplicable.bind(this.builder) : null,
        run: action.run.bind(this.builder)
    };
};
BuilderBasedDialog.prototype.onShown = function () {
    var target = this.contentDiv.querySelector(".Focusable");
    if (target && target.focus) target.focus();
    if (target && target.select) target.select();
};
BuilderBasedDialog.prototype.getDialogActions = function () {
    var thiz = this;
    return this.builder.actions.map(function (action) { return thiz._newLegacyAction(action); });
}
BuilderBasedDialog.prototype.quit = function () {
    this.close();
};

Dialog.hasOpenDialog = function () {
    for (var i = 0; i < BaseWidget.closables.length; i ++) {
        var closable = BaseWidget.closables[i];
        if (__isSubClassOf(closable.constructor, Dialog)) return true;
    }

    return false;
};

Dialog.alert = function (message, extra, onClose) {
    var builder = {
        title: message || "Information",
        size: message.size || "small",
        buildContent: function (container) {
            var html = "";
            if (extra) {
                html = [];
                extra.split("\n").forEach(function (line) {
                    html.push(Dom.htmlEncode(line.replace(/\t/g, "    ")).replace(/  /g, "&#160; "));
                });

                html = html.join("<br/>");
            }
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Info",
                _children: [
                    { _name: "icon", "class": "information" },
                    {
                        _name: "vbox", flex: 1, "class": "Messages",
                        _children: [
                            { _name: "div", _html: html || ""}
                        ]
                    }
                ]
            }));
        },
        actions: [{
            title: "OK",
            primary: true,
            isCloseHandler: true,
            run: function () {
                this._dialog.quit();
                if (onClose) onClose();
                return true;
            }
        }]
    };
    new BuilderBasedDialog(builder).open();
}
Dialog.warning = function (message, extra, onClose) {
    var builder = {
        title: message || "Warning",
        size: message.size || "small",
        buildContent: function (container) {
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Warning",
                _children: [
                    { _name: "icon", "class": "alert" },
                    {
                        _name: "vbox", flex: 1, "class": "Messages",
                        _children: [
                            { _name: "div", _text: extra || ""}
                        ]
                    }
                ]
            }));
        },
        actions: [{
            title: "OK",
            primary: true,
            isCloseHandler: true,
            run: function () {
                this._dialog.quit();
                if (onClose) onClose();
                return true;
            }
        }]
    };
    new BuilderBasedDialog(builder).open();
};
Dialog.getPreferredDialogSize = function(maxSpec, container) {
    var name = Util.getPreferredBreakpointName(container);
    var value = name ? BaseWidget.RESPONSIVE_BREAKPOINTS[name] : (0.9 * Dom.getOffsetWidth(container || document.body));
    var largeSpec = "";
    for (var spec in DIALOG_SIZE_SPECS) {
        var size = DIALOG_SIZE_SPECS[spec];
        if (size <= value) {
            largeSpec = spec;
        }
        if (spec == maxSpec && largeSpec.length > 0) {
            break;
        }
    }
    return largeSpec || maxSpec || "small";
}
Dialog.alertHtmlMessage = function (title, html, onClose) {
    var builder = {
        title: title || "Information",
        size:  Dialog.getPreferredDialogSize(Util.isMobileUI() ? "smaller" : "large"),
        buildContent: function (container) {
            var wrapperNodeSpec = { _name: "div", "class": "HtmlWrapper"};
            if (typeof(html) == "object") {
                wrapperNodeSpec._children = html.slice ? html : [html];
            } else {
                wrapperNodeSpec._html = html || "";
            }

            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Info",
                _children: [
                    {
                        _name: "vbox", flex: 1, "class": "HtmlMessages",
                        _children: [
                            wrapperNodeSpec
                        ]
                    }
                ]
            }));
        },
        actions: [{
            title: "Close",
            primary: true,
            isCloseHandler: true,
            run: function () {
                this._dialog.quit();
                if (onClose) onClose();
                return true;
            }
        }]
    };
    new BuilderBasedDialog(builder).open();
}
Dialog.error = function (message, extra, onClose) {
    var builder = {
        title: "Error",
        size: "small",
        buildContent: function (container) {
            var html = "";
            if (extra) {
                html = [];
                extra.split("\n").forEach(function (line) {
                    html.push(Dom.htmlEncode(line.replace(/\t/g, "    ")).replace(/  /g, "&#160; "));
                });

                html = html.join("<br/>");
            }
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Error",
                _children: [
                    { _name: "icon", "class": "close-box" },
                    {
                        _name: "vbox", flex: 1, "class": "Messages",
                        _children: [
                            { _name: "strong", _text: message },
                            { _name: "p", _html: html || ""}
                        ]
                    }
                ]
            }));
        },
        actions: [{
            title: "Close",
            primary: true,
            isCloseHandler: true,
            run: function () {
                this._dialog.quit();
                if (onClose) {
                    window.setTimeout(onClose, 200);
                }
                return true;
            }
        }]
    };
    new BuilderBasedDialog(builder).open();
}
Dialog.prompt = function (message, initialValue, acceptMessage, onInput, cancelMessage, onCancel) {
    var builder = {
        title: "Prompt",
        size: "small",
        buildContent: function (container) {
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Prompt",
                _children: [
                    { _name: "icon", "class": "help-circle" },
                    {
                        _name: "vbox", flex: 1, "class": "Messages",
                        _children: [
                            { _name: "p", _text: message || ""},
                            {
                                _name: "input",
                                type: "text",
                                style: "width: calc(100% - 10px); padding: 5px;",
                                "class": "Focusable",
                                _id: "input"
                            }
                        ]
                    }
                ]
            }, document, this));

            this.input.value = initialValue || "";
        },
        actions: [
                  {
                      title: acceptMessage ? acceptMessage : "OK",
                      primary: true,
                      run: function () {
                          this._dialog.quit();
                          if (onInput) onInput(this.input.value);
                          return true;
                      }
                  },
                  {
                      title: cancelMessage ? cancelMessage : "Cancel",
                      isCloseHandler: true,
                      run: function () {
                          this._dialog.quit();
                          if (onCancel) onCancel();
                          return true;
                      }
                  }
              ]
    };
    new BuilderBasedDialog(builder).open();
}
Dialog.confirmDangerousAction = function (question, extra, positiveActionTitle, onPositiveAnswer, negativeActionTitle, onNegativeAnswer, extraActionTitle, onExtraActionAnswer) {
    Dialog._confirmImpl(question, extra, positiveActionTitle, onPositiveAnswer, negativeActionTitle, onNegativeAnswer, extraActionTitle, onExtraActionAnswer, true);
};
Dialog.confirm = function (question, extra, positiveActionTitle, onPositiveAnswer, negativeActionTitle, onNegativeAnswer, extraActionTitle, onExtraActionAnswer) {
    Dialog._confirmImpl(question, extra, positiveActionTitle, onPositiveAnswer, negativeActionTitle, onNegativeAnswer, extraActionTitle, onExtraActionAnswer, false);
};
Dialog._confirmImpl = function (question, extra, positiveActionTitle, onPositiveAnswer, negativeActionTitle, onNegativeAnswer, extraActionTitle, onExtraActionAnswer, danger) {
    var builder = {
        title: "Confirm",
        size: Dialog.getPreferredDialogSize(Util.isMobileUI() ? "smaller" : "normal"),
        buildContent: function (container) {
            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Confirm",
                _children: [
                    { _name: "icon", "class": "help-circle" },
                    {
                        _name: "vbox", flex: 1, "class": "Messages",
                        _children: [
                            { _name: "strong", _text: question },
                            { _name: "p", _text: extra || ""}
                        ]
                    }
                ]
            }));
        },
        actions: [
            {
                title: positiveActionTitle ? positiveActionTitle : "Yes",
                primary: true,
                isDangerous: danger,
                run: function () {
                    this._dialog.quit();
                    if (onPositiveAnswer) onPositiveAnswer();
                    return true;
                }
            },
            {
                title: negativeActionTitle ? negativeActionTitle : "No",
                isCloseHandler: true,
                run: function () {
                    this._dialog.quit();
                    if (onNegativeAnswer) onNegativeAnswer();
                    return true;
                }
            },
            {
                title: extraActionTitle ? extraActionTitle : "Extra",
                isApplicable: function () {
                    return extraActionTitle;
                },
                run: function () {
                    this._dialog.quit();
                    if (onExtraActionAnswer) onExtraActionAnswer();
                    return true;
                }
            }
        ]
    };
    console.log(builder);
    new BuilderBasedDialog(builder).open();
};
Dialog.confirmHtmlMessage = function (htmlQuestion, htmlExtra, positiveActionTitle, onPositiveAnswer, negativeActionTitle, onNegativeAnswer, extraActionTitle, onExtraActionAnswer, danger) {
    var builder = {
        title: "Confirm",
        size: Dialog.getPreferredDialogSize(Util.isMobileUI() ? "smaller" : "normal"),
        buildContent: function (container) {
            var wrapperQuestionNodeSpec = { _name: "div", "class": "HtmlWrapper Question"};
            if (typeof(html) == "object") {
                wrapperQuestionNodeSpec._children = htmlQuestion.slice ? htmlQuestion : [htmlQuestion];
            } else {
                wrapperQuestionNodeSpec._html = htmlQuestion || "";
            }
            
            var wrapperExtraNodeSpec = { _name: "div", "class": "HtmlWrapper Extra"};
            if (typeof(html) == "object") {
                wrapperExtraNodeSpec._children = htmlExtra.slice ? htmlExtra : [htmlExtra];
            } else {
                wrapperExtraNodeSpec._html = htmlExtra || "";
            }

            container.appendChild(Dom.newDOMElement({
                _name: "hbox", "class": "MessageDialog Confirm",
                _children: [
                    { _name: "icon", "class": "help-circle" },
                    {
                        _name: "vbox", flex: 1, "class": "Messages HtmlMessages",
                        _children: [
                            wrapperQuestionNodeSpec,
                            wrapperExtraNodeSpec
                        ]
                    }
                ]
            }));
        },
        actions: [
            {
                title: positiveActionTitle ? positiveActionTitle : "Yes",
                primary: true,
                isDangerous: danger,
                run: function () {
                    this._dialog.quit();
                    if (onPositiveAnswer) onPositiveAnswer();
                    return true;
                }
            },
            {
                title: negativeActionTitle ? negativeActionTitle : "No",
                isCloseHandler: true,
                run: function () {
                    this._dialog.quit();
                    if (onNegativeAnswer) onNegativeAnswer();
                    return true;
                }
            },
            {
                title: extraActionTitle ? extraActionTitle : "Extra",
                isApplicable: function () {
                    return extraActionTitle;
                },
                run: function () {
                    this._dialog.quit();
                    if (onExtraActionAnswer) onExtraActionAnswer();
                    return true;
                }
            }
        ]
    };
    console.log(builder);
    new BuilderBasedDialog(builder).open();
};
Dialog.select = function (items, callback, selectedItems, options, cancelCallback) {
    if (!options) options = {};
    if (!selectedItems) selectedItems = [];
    var same = options.same || Util.sameRelax;
    var formatter = options.formatter || function (x) {return "" + x};
    var columns = options.columns || 1;
    var builder = {
        title: options.title || "Select",
        size: options.size || "normal",
        buildContent: function (container) {
            if (options.message) {
                var messageBox = Dialog.getOwnerDocument().createElement("hbox");
                container.appendChild(messageBox);

                messageBox.setAttribute("style", "align-items: flex-start; margin-bottom: 2em;")

                var i = Dialog.getOwnerDocument().createElement("icon");
                Dom.addClass(i, "help-circle");
                i.setAttribute("style", "font-size: 2em; color: #428BCA;");
                messageBox.appendChild(i);

                var p = Dialog.getOwnerDocument().createElement("p");
                messageBox.appendChild(p);
                p.appendChild(Dialog.getOwnerDocument().createTextNode(options.message));
                p.setAttribute("style", "margin: 0px; margin-left: 1em; min-height: 2em;");
                p.setAttribute("flex", "1");
            }

            var vbox = Dialog.getOwnerDocument().createElement("vbox");
            Dom.addClass(vbox, "SelectDialog");

            if (options.message) {
                Dom.addClass(vbox, "HasMessage");
            }

            this.inputs = [];
            for (var i = 0; i < items.length; i ++) {
                var id = "cb_" + widget.random();
                var holder = {};
                var span = Dom.newDOMElement({
                    _name: "hbox",
                    flex: 1,
                    "class": "SelectItem",
                    _children: [
                                {_name: "input", name: "ItemSelection", type: (options.exclusive ? "radio" : "checkbox"), _id: "checkbox", id: id, style: "vertical-align: middle;"},
                                {_name: "label", flex: "1", "for": id, _html: Dom.htmlEncode(formatter(items[i])), style: "padding-left: 1ex; vertical-align: middle; text-align:left"},
                                ]
                }, Dialog.getOwnerDocument(), holder);

                this.inputs.push(holder.checkbox);
                holder.checkbox._item = items[i];
                holder.checkbox.checked = Util.contains(selectedItems, items[i], same);
                vbox.appendChild(span);
                if (options.columnWidth) span.style.width = options.columnWidth;

                if (columns > 1 && (i + 1) % columns == 0) {
                    vbox.appendChild(Dialog.getOwnerDocument().createElement("br"));
                }
                if (i % columns > 0) {
                    span.style.marginLeft = "2em";
                }
            }
            container.appendChild(vbox);
        },
        actions: [
            {
                title: options.selectActionTitle || "Select",
                primary: true,
                run: function () {
                    var selected = [];
                    for (var i = 0; i < this.inputs.length; i ++) {
                        if (this.inputs[i].checked) selected.push(this.inputs[i]._item);
                    }

                    if (options.requireSelection && !selected.length) {
                        Dialog.error("Please select at least one item.");
                        return false;
                    }

                    callback(selected);
                    return true;
                }
            },
            {
                title: "Cancel",
                isCloseHandler: true,
                run: function () {
                    if (cancelCallback) cancelCallback();
                    return true;
                }
            }
        ]
    };
    new BuilderBasedDialog(builder).open();
};
Dialog.prototype.getAsUnnavigatableModule = function () {
    if (!this._navigationModule) {
        var thiz = this;
        this._navigationModule = {
            navigate: function (name, callback) {
                callback(null);
            },
            close: function () {
                thiz.close();
            }
        };
    }
    return this._navigationModule;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/Spinner.js";

function Spinner(message) {
    BuilderBasedDialog.call(this, {
        title: "",
        actions: [],
        buildContent: function() {}
    });

    this._message = message || "";
}
__extend(BuilderBasedDialog, Spinner);

Spinner.prototype.invalidateElements = function() {
    this.dialogHeaderPane.style.display = "none";
    this.dialogFooter.style.display = "none";
    this.dialogBody.style.borderTop = "none";
    this.dialogFrame.style.boxShadow = "none";
    this.dialogFrame.style.background = "none";
};

Spinner.prototype.busy = function () {
    this.open();
    Dialog.prototype.busy.call(this, this._message);
}

Spinner.prototype.done = function() {
    Dialog.prototype.done.call(this);
    this.close();
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ProgressIndicatorOverlay.js";

function ProgressIndicatorOverlay(message) {
    Dialog.call(this);

    this.message = message || "Please wait...";
    this.progressBar.setProgress(0, this.message);
}
__extend(Dialog, ProgressIndicatorOverlay);

ProgressIndicatorOverlay.prototype.invalidateElements = function() {
};
ProgressIndicatorOverlay.prototype.getDialogActions = function () {
    return [];
};
ProgressIndicatorOverlay.prototype.busy = function () {
    this.open();
};

ProgressIndicatorOverlay.prototype.done = function() {
    this.close();
};

ProgressIndicatorOverlay.prototype.progress = function (percent, message) {
    this.progressBar.setProgress(percent || 0, message || this.message);
};
ProgressIndicatorOverlay.prototype.waitForJob = function(jobId, message, callback) {
    this.message = message;
    this.progressBar.setProgress(0, message);
    this.busy();
    var thiz = this;
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        thiz.progress(100, "Done.");
                        thiz.done();
                        callback(job.data);
                    } else if (job.status == "Running") {
                        thiz.progress(Math.round(100 * job.processed / job.total), job.progressMessage || thiz.message);
                        checker();
                    } else {
                        thiz.done();
                        console.log(job);
                        callback(null, {message: (job && job.errorMessage) || "Job execution error"});
                    }
                } else {
                    thiz.done();
                    callback(null, {message: "Job not found."});
                }
            }, function (error) {
                thiz.done();
                callback(null, error);
            });
        }, thiz.requestTime || 500);
    })();
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/LoadingIndicatorOverlay.js";

function LoadingIndicatorOverlay(message) {
    this.message = message || "Please wait...";
}
__extend(Dialog, LoadingIndicatorOverlay);

LoadingIndicatorOverlay.prototype.busy = function () {
    if (!this.busyIndicator) this.busyIndicator = new Spinner(this.message);
    this.busyIndicator.busy();
};

LoadingIndicatorOverlay.prototype.done = function() {
    this.busyIndicator && this.busyIndicator.done();
};

LoadingIndicatorOverlay.prototype.waitForJob = function(jobId, message, callback) {
    if (!jobId) {
        callback(null, {message: "Invalid jobId"});
        return;
    }
    this.message = message;
    this.busy();
    var thiz = this;
    this._onJobExecuted(jobId, function (data) {
        thiz.done();
        callback(data);
    }, function (error) {
        thiz.done();
        callback(null, {message: (error && error.errorMessage) || "Job execution error"});
    });
};
LoadingIndicatorOverlay.prototype._onJobExecuted = function(jobId, onSuccess, onError) {
    var thiz = this;
    var firstTime = true;

    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                firstTime = false;
                if (job) {
                    if (job.status == "Done") {
                        onSuccess(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        onError({message: job.errorMessage});
                    }
                } else {
                    onError({message: "Job not found."});
                }
            }, function (error) {
                onError(error);
            });
        }, firstTime ? 150 : (thiz.requestTime || 500));
    })();
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ModificationWatchDialog.js";

function ModificationWatchDialog() {
    Dialog.call(this);

    this.modified = false;
    this._snapshotInputValues = null;

    var checkModifiedEvent = function(event) {
        if (!this.unsavedChangeListenerRegistered) return;

        if (typeof(event.fromUser) != "undefined") {
            if (!event.fromUser) return;
        }

        if (this._snapshotInputValues === null) {
            this.showUnsavedNotify();
            return;
        }
        if (this.hasInputValuesChanged()) {
            this.showUnsavedNotify();
        } else {
            this.clearUnsavedNotify();
        }
    };

    var names = this.getChangeEventNames();
    var modifiedEventTarget = this.getModifiedEventTarget();
    for (var i = 0; i < names.length; i ++) {
        this.bind(names[i], checkModifiedEvent, modifiedEventTarget);
    }
    this.unsavedChangeListenerRegistered = true;
}
__extend(Dialog, ModificationWatchDialog);

ModificationWatchDialog.prototype.getDialogActions = function () {
    if (!this.modified) {
        if (this.isEmbedded()) return [];
        return [{
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }];
    }

    var thiz = this;
    return [
        {
            type: "accept", title: "Save",
            run: function () { this.save(function (data) {
                thiz.close(data);
            }); return false; }
        },
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { this.performCancel(); return false; }
        }
    ]
};

ModificationWatchDialog.prototype.onInvalidateElements = function () {
    if (this.modified) {
        this.dialogFooterMiddlePane.appendChild(Dom.newDOMElement({
            _name: "span",
            "class": "ModifiedIndicator",
            _text: "Unsaved changes"
        }));
    }
};
ModificationWatchDialog.prototype.performCancel = function (data) {
    if (!this.modified) {
        this.close(data);
    } else {
        var thiz = this;
        Dialog.confirm("", "Are you sure you want to discard the unsaved changes?", "Discard changes", function () {
            thiz.close(data);
        }, "Cancel");
    }
};
ModificationWatchDialog.prototype.emitChangeEvent = function () {
    Dom.emitEvent(ModificationWatchDialog.DEFAULT_CHANGE_EVENT_NAME, this.dialogBody);
};
ModificationWatchDialog.DEFAULT_CHANGE_EVENT_NAME = "p:Modified";
ModificationWatchDialog.ALL_CHANGE_EVENT_NAMES = [ModificationWatchDialog.DEFAULT_CHANGE_EVENT_NAME, "input", "change", "p:ItemSelected", "p:ValueChanged", "p:SelectionChanged"];
ModificationWatchDialog.prototype.getChangeEventNames = function () {
    return [ModificationWatchDialog.DEFAULT_CHANGE_EVENT_NAME];
};

ModificationWatchDialog.prototype.registerUnsavedChanges = function(ablebility) {
    this.unsavedChangeListenerRegistered = (ablebility == void 0) ? true : ablebility;
};
ModificationWatchDialog.prototype.showUnsavedNotify = function () {
    if (this.modified === true) return;
    this.modified = true;
    this.invalidateElements();
};
ModificationWatchDialog.prototype.clearUnsavedNotify = function () {
    if (!this.modified) return;
    this.modified = false;
    this.invalidateElements();
};
ModificationWatchDialog.prototype.toggleUnsavedNotify = function (inputKey, originalValue, value) {
    if (typeof (this._changedInputMap) == "undefined") this._changedInputMap = {};
    var v1 = originalValue && typeof(originalValue) == "object" ? JSON.stringify(originalValue) : originalValue;
    var v2 = value && typeof(value) == "object" ? JSON.stringify(value) : value;
    if (v1 != v2) {
        this._changedInputMap[inputKey] = 1;
    } else {
        delete this._changedInputMap[inputKey];
    }
    var hasChanged = false;
    for (var k in this._changedInputMap) {
        hasChanged = true;
        break;
    }

    if (hasChanged) {
        this.showUnsavedNotify();
    } else {
        this.clearUnsavedNotify();
    }

    return hasChanged;
}
ModificationWatchDialog.prototype.setSnapshotInputValues = function(values) {
    if(values && typeof (values) == "object") {
        this._snapshotInputValues = JSON.parse(JSON.stringify(values));
    } else {
        this._snapshotInputValues = values;
    }
};
ModificationWatchDialog.prototype.getCurrentInputValues = function() {
    console.log("ModificationWatchDialog > getCurrentInputValues");
    return {};
};
ModificationWatchDialog.prototype.hasInputValuesChanged = function(values) {
    var curValues = values || this.getCurrentInputValues() || {};
    var snapshotValues = this._snapshotInputValues || {};
    return JSON.stringify(snapshotValues) !== JSON.stringify(curValues);
};

ModificationWatchDialog.prototype.getModifiedEventTarget = function () {
    return this.dialogBody;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ActionBar.js";

var ActionBar = function () {
    function actionBarClickHandler(event) {
        var target = Dom.getTarget(event);
        var button = Dom.findUpward(target, {
            eval: function (n) {
                return n._action;
            }
        });

        if (!button) return;
        if (button.disabled) return;

        Dom.cancelEvent(event);

        var action = button._action;

        action.run(event);

    }

    function ActionBar() {
        BaseWidget.call(this);

        this.container = this.node();
        this.actions = [];
        this.groups = {};

        // this.buttonGroupBox = document.createElement("div");
        // Dom.addClass(this.buttonGroupBox, "btn-group nav-pills");
        // this.container.appendChild(this.buttonGroupBox);

        Dom.registerEvent(this.container, "click", actionBarClickHandler, false);
    }
    __extend(BaseWidget, ActionBar);

    ActionBar.prototype.buildDOMNode = function () {
        var node = document.createElement("hbox");
        return node;
    };

    ActionBar.prototype.register = function (action) {
        this.actions.push(action);

        var actionGroup = action.getGroup ? action.getGroup() : "No group";
        if (!this.groups[actionGroup]) {
            this.groups[actionGroup] = [];
        }
        this.groups[actionGroup].push(action);

        this.invalidate();
    };
    ActionBar.prototype.invalidate = function () {
        this.container.innerHTML = "";
        for (var groupName in this.groups) {
            var actions = this.groups[groupName];

            if (!actions || actions.length < 0) continue;

            var buttonGroupBox = document.createElement("hbox");

            for (var i = 0; i < actions.length; i ++) {
                var action = actions[i];

                if (typeof action.isVisible != "undefined") {
                    if (!action.isVisible || (typeof action.isVisible == "function" && !action.isVisible())) continue;
                }

                var disabled = false;
                if (typeof action.isApplicable != "undefined") {
                    disabled = !action.isApplicable || (typeof action.isApplicable == "function" && !action.isApplicable());
                }

                // if (action.isVisible && !action.isVisible()) continue;
                // var disabled = action.isApplicable && !action.isApplicable();

                var button = document.createElement("button");
                button.setAttribute("type", "button");

                var html = "";
                if (action.getIcon && action.getIcon()) html += "<icon class=\"" + action.getIcon() + "\"></icon>";
                if (action.getTitle && action.getTitle()) html += "<span>" + (this.simple ? "" : Dom.htmlEncode(action.getTitle())) + "</span>";

                button.innerHTML = html;
                if (this.simple && action.getTitle) {
                    button.setAttribute("title", action.getTitle());
                }

                buttonGroupBox.appendChild(button);
                if (disabled) {
                    Dom.addClass(button, "disabled");
                    button.setAttribute("disabled", "true");
                }
                button._action = action;
                
                if (action.id) Dom.addClass(button, "Action_" + action.id);
            }

            this.container.appendChild(buttonGroupBox);
        }
    };

    ActionBar.prototype.invalidateActionStatus = function () {
        Dom.doOnAllChildren(this.container, function (groupNode) {
            Dom.doOnAllChildren(groupNode, function (button) {
                var action = button._action;
                var disabled = action && action.isApplicable && !action.isApplicable();
                if (disabled) {
                    Dom.addClass(button, "disabled");
                    button.setAttribute("disabled", "true");
                } else {
                    Dom.removeClass(button, "disabled");
                    button.removeAttribute("disabled");
                }
            });
        });
    };

    return ActionBar;
}();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ActionMenu.js";

function ActionMenu(node) {
    BaseWidget.call(this);

    var icon = Util.getProperty(node, "icon", "");
    if (icon) {
        this.icon.setAttribute("class", icon);
    } else {
        this.icon.style.display = "none";
    }

    var label = Util.getProperty(node, "label", "");
    Dom.setInnerText(this.label, label);
    
    this._mode = Util.getProperty(node, "mode", "dropdown");

    this.popup.setPopupClass("ActionMenuPopup");
    this.actions = [];
    this.groups = {};

    this.bind("click", this.handleMenuItemClick, this.container);

    this.bind("click", function () {
        this.invalidate();
        this.popup.show(this.node(), "left-inside", "bottom", 0, 5);
    });
    
    this._actionHandlers = {};
    this._applicableCheckers = {};
}
__extend(BaseTemplatedWidget, ActionMenu);

ActionMenu.prototype.onDetached = function() {
    if (this.popup) {
        this.popup.kill();
    }
};

ActionMenu.prototype.setContentFragment = function(fragment) {
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node.nodeName || !node.getAttribute || node.nodeName.toLowerCase() != "action") continue;
        
        
        var action = this._generateActionForNode(node);
        this.register(action);
    }
};
ActionMenu.prototype.onAction = function (actionId, handler) {
    this._actionHandlers[actionId] = handler;
};
ActionMenu.prototype.setApplicableChecker = function (actionId, checker) {
    this._applicableCheckers[actionId] = checker;
};
ActionMenu.prototype._generateActionForNode = function (node) {
    var id = node.getAttribute("action-id");
    var thiz = this;
    var action = {
        icon: node.getAttribute("icon"),
        title: node.getAttribute("title"),
        applicable: function () {
            if (!thiz._applicableCheckers[id]) return true;
            return thiz._applicableCheckers[id]();
        },
        run: function () {
            thiz._actionHandlers[id]();
        }
    };
    
    return action;
};
ActionMenu.prototype.handleMenuItemClick = function (event) {
    var target = Dom.getTarget(event);
    var item = Dom.findUpward(target, {
        eval: function (n) {
            return n._action;
        }
    });

    if (!item) return;
    var action = item._action;
    var disabled = false;
    if (typeof action.applicable != "undefined") {
        disabled = !action.applicable || (typeof action.applicable == "function" && !action.applicable());
    }

    if (disabled) return;

    Dom.cancelEvent(event);
    this.popup.close();

    action.run(event);
}

ActionMenu.prototype.setTitle = function (title) {
    if (!title || (!title.label && !title.icon)) return;
    var icon = title.icon;
    if (icon) {
        this.icon.setAttribute("class", icon);
    } else {
        this.icon.style.display = "none";
    }

    var label = title.label;
    Dom.setInnerText(this.label, label);
}

ActionMenu.prototype.register = function (action) {
    this.actions.push(action);

    var actionGroup = (typeof action.group == "function" ? action.group() : action.group) || "No group";
    if (!this.groups[actionGroup]) {
        this.groups[actionGroup] = [];
    }
    this.groups[actionGroup].push(action);

    this.invalidate();
};
ActionMenu.prototype.invalidate = function () {
    this.container.innerHTML = "";
    var allDisabled = true;
    for (var groupName in this.groups) {
        var actions = this.groups[groupName];

        if (!actions || actions.length < 0) continue;

        var groupBox = document.createElement("vbox");
        Dom.addClass(groupBox, "Group "  + ((groupName + "").replace(/ /g, "")));

        for (var i = 0; i < actions.length; i ++) {
            var action = actions[i];
            if (typeof action.visible != "undefined") {
                if (!action.visible || (typeof action.visible == "function" && !action.visible())) continue;
            }

            var disabled = false;
            if (typeof action.applicable != "undefined") {
                disabled = !action.applicable || (typeof action.applicable == "function" && !action.applicable());
            }

            var hbox = document.createElement("hbox");

            var html = "";
            if (action.icon) {
                var actionClass = (typeof action.icon == "function" ? action.icon() : action.icon);
                if(actionClass == "currency-usd") {
                    actionClass = "currency-" + Util.getCurrencyCode().toLowerCase();
                }
                html += "<icon class=\"" + actionClass + "\"></icon>";
            }
            if (action.title) html += "<span>" + (typeof action.title == "function" ? action.title() : action.title) + "</span>";

            hbox.innerHTML = html;

            groupBox.appendChild(hbox);
            if (disabled) {
                Dom.addClass(hbox, "Disabled");
            } else {
                allDisabled = false;
            }
            hbox._action = action;
        }

        this.container.appendChild(groupBox);
    }

    this.node().disabled = allDisabled;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataTableOrderingColumnSettingDialog.js";

function DataTableOrderingColumnSettingDialog() {
    Dialog.call(this);
    this.title = "Customize" + " Columns";

    this.bind("click", function (event) {
        var node = Dom.getTarget(event);
        var actionNode = Dom.findUpward(node, function (n) {
            return n.getAttribute && n.getAttribute("action-type");
        });

        if (!actionNode) return;

        var actionType = actionNode.getAttribute("action-type");
        if (actionType == "None") return;

        var row = Dom.findUpwardForNodeWithData(node, "_column");
        if (!row) return;

        if (actionType == "Add") {
            this.availableColumnContainer.removeChild(row);
            this.createSelectedColumnElement(row._column);
            return;
        }

        if (actionType == "Remove") {
            this.selectedColumnContainer.removeChild(row);
            this.createAvailableColumnElement(row._column);
            this.sortAvailableColumns();
            return;
        }

    }, this.columnSelectorContainer);
}

__extend(Dialog, DataTableOrderingColumnSettingDialog);
DataTableOrderingColumnSettingDialog.prototype.sortAvailableColumns = function(){
    if (!this.availableColumnContainer.childNodes || this.availableColumnContainer.childNodes.length == 0) return;
    var info = {};
    var columns = [];
    Dom.doOnSelector(this.availableColumnContainer, ":scope hbox.AvailableColumn", function(node) {
        var row = Dom.findUpwardForNodeWithData(node, "_column");
        if (row) {
            var col = row._column;
            info[col.id] = node;
            columns.push(col);
        }
    });
    columns.sort(function(a, b) {
        var t1 = a.title || "";
        var t2 = b.title || "";
        return t1.localeCompare(t2);
    });
    for (var i = 0; i < columns.length; i++) {
        var col = columns[i];
        var nodeInfo = info[col.id];
        if (!nodeInfo || !nodeInfo.parentNode) continue;
        this.availableColumnContainer.appendChild(nodeInfo);
    }
}
DataTableOrderingColumnSettingDialog.prototype.setup = function (options) {
    this.table = options.table;
    var isColumnApplicableFunc = options.isColumnApplicable;
    this.isColumnUnremovable = options.isColumnUnremovable || function (column) { return column.unremovable; };
    
    this.availableColumnContainer.innerHTML = "";
    this.selectedColumnContainer.innerHTML = "";
    for (var i = 0; i < this.table.columns.length; i ++) {
        var column = this.table.columns[i];
        if (isColumnApplicableFunc && !isColumnApplicableFunc(column)) continue;
        
        var unremovable = this.isColumnUnremovable(column);
        var visible = this.table.isColumnVisible(column);

        if (unremovable || visible) {
            this.createSelectedColumnElement(column);
        } else {
            this.createAvailableColumnElement(column);
        }
    }
    this.sortAvailableColumns();
    window.setTimeout(this.validateContentSizing.bind(this), 200);
};

DataTableOrderingColumnSettingDialog.prototype.onShown = function () {
    this.setupReordering();
};

DataTableOrderingColumnSettingDialog.prototype.createSelectedColumnElement = function (column) {
    var id = "s" + widget.random();
    var unremovable = this.isColumnUnremovable(column);
    var row = Dom.newDOMElement({
        _name: "hbox",
        "class": "SelectedColumn",
        _children: [{
            _name: "icon",
            "class": "menu DragButton",
            "_dragable": true
        },{
            _name: "label",
            "flex": "1",
            "for": id,
            _html: column.getTitleContentHtml(),
            "class": "ColumnTitle",
            title: column.getTitleContentHtml()
        }, {
            _name: "span",
            "class": "Action",
            "action-type": unremovable ? "None" : "Remove",
            _html: unremovable ? "" : "<icon class='minus-circle'></icon><span>Remove</span>"
        }]
    }, document);
    this.selectedColumnContainer.appendChild(row);
    row._column = column;
};

DataTableOrderingColumnSettingDialog.prototype.createAvailableColumnElement = function (column) {
    var id = "c" + widget.random();
    var row = Dom.newDOMElement({
        _name: "hbox",
        "class": "AvailableColumn",
        _children: [{
            _name: "label",
            "flex": "1",
            "for": id,
            _html: column.getTitleContentHtml(),
            "class": "ColumnTitle",
            title: column.getTitleContentHtml()
        }, {
            _name: "span",
            "class": "Action",
            "action-type": "Add",
            _html: "<icon class='plus-circle'></icon><span>Add</span>"
        }]
    }, document);
    this.availableColumnContainer.appendChild(row);
    row._column = column;
};

DataTableOrderingColumnSettingDialog.prototype.setupReordering = function () {
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
    .source(this.selectedColumnContainer)
    .anchor(function (node) {
        return Dom.hasClass(node, "DragButton");
    })
    .itemInfo(function (anchor) {
        var item = Dom.findParentWithClass(anchor, "SelectedColumn");
        if (!item) return null;
        return {
            element: item,
            data: item._column
        };
    })
    .destination(this.selectedColumnContainer)
    .canDrop(function (data) {
        return true;
    }
    .bind(this))
    .dropAt(dropTargetFinderFunction)
    .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "ColumnDrag"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        Dom.addClass(draggable, "JustDropped");

        window.setTimeout(function () {
            Dom.removeClass(draggable, "JustDropped");
        }, 100);

        // this.emitChangeEvent();
    }.bind(this);
};

DataTableOrderingColumnSettingDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Apply",
            run: function () {
                var columnIds = [];
                for (var i = 0; i < this.selectedColumnContainer.childNodes.length; i++) {
                    var node = this.selectedColumnContainer.childNodes[i];
                    columnIds.push(node._column.id);
                }

                if (columnIds.length <= 0) {
                    Dialog.error("Please select at least one visible column.");
                    return false;
                }

                this.close(columnIds);

                return false;
            }
        }
    ]
};

DataTableOrderingColumnSettingDialog.prototype.validateContentSizing = function() {
    var h = this.dialogBody.offsetHeight;
    var s = this.dialogBody.scrollHeight;
    var d = s - h;
    if (d <= 0) return;
    var m = Math.max(this.availableColumnContainer.offsetHeight, this.selectedColumnContainer.offsetHeight);
    this.selectedColumnContainer.style.maxHeight = m - d - 1 + "px";
    this.availableColumnContainer.style.maxHeight = m - d - 1 + "px";
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataTable.js";

var DataTable = function () {
    // Dom.registerEvent(window, "load", function () {
    //     var f = function (event) {
    //         var target = Dom.getTarget(event);
    //         Dom.doOnChildRecursively(target, {
    //             eval: function (node) {
    //                 return Dom.hasClass(node, "DataTable") && node._dt && node._dt.invalidateSizing;
    //             }
    //         }, function (node) {
    //             node._dt.invalidateSizing();
    //         });
    //     };
    //     Dom.registerEvent(document.body, "overflow", f, false);
    //     Dom.registerEvent(document.body, "underflow", f, false);
    // });

    function clickHandler(event) {
        var target = Dom.getTarget(event);
        var link = Dom.findUpward(target, new DomTagNameEvaluator("a"));
        if (link) return;
        var selectionPane = Dom.findUpward(target, {
            eval: function (n) {
                var hasClass = Dom.hasClass(n, "ActionInfoPane");
                return hasClass;
            },
        });
        if (selectionPane) return;

        //alert("start checking from: " + event.type);
        var checkbox = Dom.findUpward(target, {
            eval: function (n) {
                var hasClass = Dom.hasClass(n, "DataTableCheck");
                return hasClass;
            },
        });

        var infoSelection = Dom.findUpward(target, {
            eval: function (n) {
                var hasClass = Dom.hasClass(n, "DataTableCheckInfo");
                return hasClass;
            },
        });

        var dataTable = DataTable.findInstance(event);
        if (!dataTable) return;

        if (infoSelection && dataTable.showSelectionInfo) {
            dataTable.setSelectionInfoVisible(true);
            return;
        }

        if (checkbox) {
            checkBoxClickHandler(target, checkbox, event);
            return;
        }

        var th = Dom.findUpward(target, new DomTagNameEvaluator("th"));
        if (th) return;

        var actionNode = Dom.findUpward(target, {
            eval: function (n) {
                return n.getAttribute && n.getAttribute("action-id");
            }
        });



        //check for primary clickable item
        var td = Dom.findUpward(target, new DomTagNameEvaluator("td"), function (node) {
            return node == dataTable.container;
        });
        if (td) {
            var primary = null;
            Dom.doOnChildRecursively(td, {
                eval: function (n) {
                    return n.getAttribute && n.getAttribute("primary") == "true";
                }
            }, function (n) {
                primary = n;
            });

            if (primary && primary.click && primary != target) {
                primary.click();
                return;
            }
        }

        //find data row instance
        var row = Dom.findUpward(target, {
            eval: function (n) {
                return n.getAttribute && n.getAttribute("data-index");
            }
        });

        if (!row) return;

        var index = parseInt(row.getAttribute("data-index"), 10);
        var data = dataTable.items[index];
        if (event.shiftKey) {
            //var json = JSON.stringify(data, null, 2);
            //alert(json);
        }

        if (actionNode) {
            actionClickHandler(target, actionNode, row, data, dataTable, event, index);
            return;
        }

        var button = Dom.findParentWithClass(event.target, "ActionButton");
        if (button) {
            var uuid = button.getAttribute("data-action-uuid");
            if (uuid) return;
        }

        if (dataTable.defaultSelectionHandler) {
            dataTable.defaultSelectionHandler.run(data, event);
        }
    }
    function actionClickHandler(target, actionNode, row, data, dataTable, event, index) {
        var id = actionNode.getAttribute("action-id");
        //find action instance
        var action = null;
        for (var i = 0; i < dataTable.actualColumns.length; i ++) {
            var column = dataTable.actualColumns[i];
            if (!column.actions) continue;
            for (var j = 0; j < column.actions.length; j ++) {
                if (column.actions[j].id == id) {
                    action = column.actions[j];
                    break;
                }
            }

            if (action) break;
        }

        if (!action) return;
        if (!row) return;

        if (action.isApplicable && !action.isApplicable(data)) return;

        //invoke the action
        action.handler(data, actionNode, function (modifiedData) {
            if (!modifiedData) return;
            dataTable.items[index] = modifiedData;
            dataTable._invalidateRow(row, index, modifiedData);
        });
    }

    function checkBoxClickHandler(target, checkbox, event) {
        var dataTable = DataTable.findInstance(event);
        if (!dataTable) return;

        var all = Dom.hasClass(checkbox, "All");
        var rowData = null;

        var selectAllCheckbox = dataTable.container.querySelector("input.DataTableCheck.All");

        if (all) {
            if (dataTable.noSelectAll) return;

            if (checkbox.checked) {
                if (checkbox.checked) {
                    dataTable.selectAll("noEvent");
                } else {
                    dataTable.selectNone();
                }
            } else {
                dataTable.selectNone();
            }

            dataTable.fireAllCheckBoxChangedEvent(checkbox.checked);
        } else {
            var allChecked = true;
            rowData = DataTable.getRowData(checkbox);

            Dom.doOnChildRecursively(dataTable.table, {
                eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "Item")}
            }, function (c) {
                if (!c.checked) allChecked = false;
            })

            Dom.doOnChildRecursively(dataTable.table, {
                eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "All")}
            }, function (c) {
                c.checked = allChecked && !dataTable.multiPages;
            })

            dataTable._updateCheckedRowIndicator();

            var index = parseInt(checkbox.getAttribute("data-index"), 10);
            dataTable.fireCheckBoxChangedEvent(index, checkbox.checked);

            if (dataTable.disabledWhenCheckAll === false && dataTable.isSelectAll()) {
                if (rowData && rowData.id) {
                    if (!dataTable._unselectedIds) dataTable._unselectedIds = [];
                    var index = dataTable._unselectedIds.indexOf(rowData.id);
                    if (checkbox.checked) {
                        if (index >= 0) dataTable._unselectedIds.splice(index, 1);
                    } else {
                        if (index < 0) dataTable._unselectedIds.push(rowData.id);
                    }
                }
            }
        }

        dataTable.fireSelectionChangedEvent(true, {item: rowData, checked: checkbox.checked});
    }

    function columnHeaderClickHandler(event) {
        var dataTable = DataTable.findInstance(event);
        if (!dataTable) return;

        var target = Dom.getTarget(event);
        var th = Dom.findUpward(target, {
            eval: function (n) {
                return Dom.hasClass(n, "Sortable") && n.id;
            }
        });

        if (!th) return;
        var id = th.id;
        for (var i = 0; i < dataTable.actualColumns.length; i ++) {
            var column = dataTable.actualColumns[i];
            if (!column.propertyName) continue;

            if (column.columnId == id) {
                var asc = Dom.hasClass(th, "AscSort");
                var order = {
                        propertyName: column.propertyName,
                        asc: !asc
                    };
                for (var k = 0; k < dataTable.orderRequestListeners.length; k ++) {
                    dataTable.orderRequestListeners[k].changeOrder(order);
                }
                dataTable.currentOrder = order;
                return;
            }
        }
    }

    function SelectorColumn(exclusive, selectable, checked, noSelectAll) {
        this.exclusive = exclusive;
        this.noSelectAll = noSelectAll;
        this.headerClass = "DTCheckbox DTCheckboxAll" + (this.noSelectAll ? " NoSelectAll" : "");
        this.selectable = selectable || function () { return true; };
        this.checked = checked || function () { return false; };
        this.name = "name" + widget.random();
        this.unremovable = true;
        this.sizingPolicy = "1em";
    }

    SelectorColumn.prototype.getCellContentHtml = function (data, row, col) {
        return "<input primary=\"true\" type=\"" + (this.exclusive ? "radio" : "checkbox") + "\"" + (this.selectable(data) ? "" : " disabled=\"true\"") + (this.selectable(data) ? "" : " _isSelectable=\"false\"") + (this.checked(data) ? " checked=\"true\"" : "") + " class=\"DataTableCheck Item\" data-index=\"" + row + "\" name=\"" + this.name + "\" />";
    };
    SelectorColumn.prototype.getTitleInfo = function () {
        return "Select all";
    };
    SelectorColumn.prototype.getTitleContentHtml = function () {
        return this.exclusive ? "" : "<input type=\"checkbox\" class=\"DataTableCheck All\" /><span class=\"DataTableCheckInfo\" title=\"View selection details\"><i ui-icon=\"information\"></i></span>";
    };
    SelectorColumn.prototype.getBodyClass = function () {
        return "DTCheckBoxBody";
    };
    SelectorColumn.prototype.getExtraWrapperClass = function () {
        return "DTCheckBox";
    };

    function ActionColumn(actions, title) {
        this.actions = actions || [];
        this.headerClass = "Actions";
        this.title = title || "Actions";

    }
    ActionColumn.prototype.getTitleContentHtml = function () {
        return this.title;
    };
    ActionColumn.prototype.getCellContentHtml = function (data, row, col) {
        var html = "";
        for (var i = 0; i < this.actions.length; i ++) {
            var action = this.actions[i];
            //if (action.isApplicable && !action.isApplicable(data)) continue;

            html += "<span action-id=\"" + action.id + "\" class=\"" + action.type + " Action"  + action.id +  " " + (action.isApplicable && !action.isApplicable(data) ? "Disabled" : "")  + "\" title=\"" + Dom.htmlEncode(action.title) + "\"><icon class=\"" + action.type +"\"></icon></span>"
        }
        return html;
    };
    ActionColumn.prototype.getBodyClass = function () {
        return "Actions";
    };
    ActionColumn.prototype.getTitleInfo = function () {
        return "Actions";
    };
    ActionColumn.prototype.width = function (w) {
        this.preferredWidth = "" + w;
        return this;
    };
    ActionColumn.prototype.add = function (title, type, handler, applicable) {
        this.actions.push(new DataTable.Action(title, type, handler, applicable));
        return this;
    };

    function DataTable(contextNode) {
        BaseWidget.call(this);

        this.debug = Dom.getAttributeAsBoolean(contextNode, "debug", false);
        this.shrinkingAllowed = Dom.getAttributeAsBoolean(contextNode, "shrinkable", false);

        this.container = this.node();
        this.columns = [];
        this.actions = [];
        this.withSelector = false;
        this.showSelectionInfo = true;
        this.temp = document.createElement("div");
        this.orderRequestListeners = [];
        this.listeners = [];
        this.columnSettingListeners = [];
        this.multiPages = false;
        this.id = "";
        this.exclusive = false;
        this.hiddenColumnIds = [];
        this.visibleColumnIds = [];
        this.preferredHeight = 400;
        this.heightControl = true;
        this.defaultColWidth = "1*";
        this.itemsChangedListener = null;
        this.headerHeight = 0;
        this.hiddenHeader = false;

        var thiz = this;

        Dom.registerEvent(this.container, "click", clickHandler, false);

        Dom.registerEvent(this.container, "mouseover", function (e) {
            thiz.handleMouseOver(e);
        }, false);

        if (true) {
            //detect container size change
            var thiz = this;
            function detector() {
                try {
                    if (typeof (thiz.lastContainerWidth) != "undefined") {
                        var w = thiz._calculateContainerWidth();
                        if (w != thiz.lastContainerWidth) {
                            thiz.invalidateSizing();
                        }
                    }
                } finally {
                    if (!thiz.container || !Dom.isElementExistedInDocument(thiz.container)) {
                        if (thiz._appended) {
                            thiz._appended = false;
                            return;
                        }
                    } else {
                        thiz._appended = true;
                    }
                    window.setTimeout(detector, 1000);
                }
            }

            detector();

        }
        /*
        <hbox anon-id="busyIndicator">
            <hbox><icon class="image-filter-tilt-shift" /><span anon-id="loadingMessage">Loading...</span></hbox>
        </hbox>
        */


        thiz.added = false;
        var checker = function () {
            if (!document.documentElement.contains(thiz.node())) {
                if (thiz.added) return;
            }

            try {
                if (document.documentElement.contains(thiz.node())) {
                    thiz.added = true;
                    if (thiz.useFloatingHeader) {
                        thiz._reinstallScrollHandler();
                    }
                }
            } finally {
                window.setTimeout(checker, 2000);
            }
        }

        checker();

        this.node().addEventListener("scroll", this._innerScrollListener.bind(this), false);
    }
    __extend(BaseTemplatedWidget, DataTable);

    DataTable.prototype._clearHoveredCells = function () {
        if (!this._lastHoveredCells) return;
        this._lastHoveredCells.forEach(function (td) {
            Dom.removeClass(td, "DTHover");
        });
        this._lastHoveredCells = [];
    };
    DataTable.prototype.handleMouseOver = function (e) {
        var td = Dom.findParentByTagName(e.target, "td");
        if (!td) {
            this._clearHoveredCells();
            return;
        }

        var idsValue = td.getAttribute("data-ids");
        if (!idsValue) {
            this._clearHoveredCells();
            return;
        }

        if (idsValue == this._lastHoveredDataIds) return;

        var ids = idsValue.split(",");
        var tr = td.parentNode;
        var matchingTds = [];
        for (var i = 0; i < ids.length; i ++) {
            Array.prototype.forEach.call(tr.childNodes, function (childTd) {
                if (!childTd.getAttribute) return;
                var childIdsValue = childTd.getAttribute("data-ids");
                if (!childIdsValue) return;
                var childIds = childIdsValue.split(",");
                if (childIds.length == 0) return;
                var ok = true;
                for (var k = 0; k < childIds.length; k ++) {
                    if (ids.indexOf(childIds[k]) < 0) {
                        ok = false;
                        break;
                    }
                }

                if (ok) matchingTds.push(childTd);
            });

            tr = tr.nextElementSibling;
            if (!tr) break;
        }

        this._clearHoveredCells();

        matchingTds.forEach(function (mtd) {
            Dom.addClass(mtd, "DTHover");
        });

        this._lastHoveredCells = matchingTds;
        this._lastHoveredDataIds = idsValue;
    };
    DataTable.prototype.withOverflowIndicators = function(indicatorContainer) {
        var thiz = this;
        var left = document.createElement("div");
        Dom.addClass(left, "DTOverflowIndicator DTOverflowIndicatorLeft");
        indicatorContainer.appendChild(left);
        this.leftOverflowIndicator = left;

        var right = document.createElement("div");
        Dom.addClass(right, "DTOverflowIndicator DTOverflowIndicatorRight");
        indicatorContainer.appendChild(right);
        this.rightOverflowIndicator = right;

        Dom.registerEvent(this.container, "scroll", function () {
            thiz.invalidateOverflowIndicators();
        }, false);

        return this;
    };
    DataTable.prototype.invalidateSelectionInfo = function(paginator) {
        // if (!this._selectionPane || !this._selectionPane._dt) return;
        // var thiz = this;
        // this._selectionPane._pg = paginator;
        // paginator.getSelectedItems(function(items) {
        //     thiz._selectionPane._dt.setItems(items);
        //     Dom.toggleClass(thiz.container, "HasSelectionInfo", items && items.length > 0);
        // });
    }
    DataTable.prototype.addSelectionInfoPane = function() {
        var thiz = this;
        var infoPane = document.createElement("div");
        Dom.addClass(infoPane, "SelectionInfoPane");

        var ab = new ActionBar();
        var footerPane = ab.node();

        infoPane.appendChild(footerPane);
        Dom.addClass(footerPane, "ActionInfoPane FooterBar");

        ab.register({
            getIcon: function () { return "trash" },
            getTitle: function () {
               return "Remove All";
            },
            isApplicable: function () {
                return thiz._selectionPane && thiz._selectionPane._dt && thiz._selectionPane._dt.getItems() && thiz._selectionPane._dt.getItems().length > 0;
            },
            run: function () {
                thiz.reset();
                thiz.fireSelectNoneActionEvent();
                thiz.fireSelectionChangedEvent(true);
                thiz.setSelectionInfoVisible(false);
            }
        });
        ab.register({
            getIcon: function () { return "close" },
            getTitle: function () {
               return "Close";
            },
            isApplicable: function () {
                return true;
            },
            run: function () {
                thiz.setSelectionInfoVisible(false);
            }
        });
        var selectionItemDataTable = new DataTable();
        var bodyPane = selectionItemDataTable.node();
        Dom.addClass(bodyPane, "SelectionBodyPane");
        infoPane.appendChild(bodyPane);

        selectionItemDataTable.column(new DataTable.PlainTextColumn("#", function(data, row, col){
            return (row +1);
        }).width("4em"));
        selectionItemDataTable.column(new DataTable.PlainTextColumn("Item", function(data){
            return thiz.sumarizerSelectionItem(data);
        }).width("1*"));
        var removeAction = {
                id: "removeItem", type: "cog", title: "Remove",
                isApplicable: function(tag) {
                    return true;
                },
                handler: function (item) {
                    //console.log("Remove ", item);
                    var foundIndex = -1;
                    var cb = function(selectedsInPaginator, thiz) {
                        for (var index = 0; index < selectedsInPaginator.length; index++) {
                            if (thiz.comparer(selectedsInPaginator[index], item)) {
                               foundIndex = index;
                               break;
                            }
                        }
                        if (foundIndex != -1) {
                            selectedsInPaginator.splice(foundIndex, 1);
                        }
                        if (thiz.isSelectAll()) {
                            Dom.removeClass(thiz.container, "SelectAll");
                            Dom.doOnChildRecursively(thiz.table, {
                                eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "All")}
                            }, function (c) {
                                c.checked = false;
                            })
                        }
                        if  (thiz._selectionPane._pg) {
                            thiz._selectionPane._pg.selectedItems = selectedsInPaginator;
                        }
                        thiz.selectItems(selectedsInPaginator, true);
                        thiz._selectionPane._dt.setItems(selectedsInPaginator);
                        thiz.fireSelectionChangedEvent(true);
                        thiz._selectionPane._actionBar.invalidate();

                    };
                    if (thiz._selectionPane._pg) {
                        thiz._selectionPane._pg.getSelectedItems(function(items) {
                            cb(items, thiz);
                        });
                    } else {
                        cb(thiz.getSelectedItems(), thiz);
                    }
                }
        };
        var actions = [];
        actions.push(removeAction);
        selectionItemDataTable.column(new DataTable.ActionColumn(actions).width("6em"));

        //selectionItemDataTable.setup();

        this.container.appendChild(infoPane);
        this._selectionPane = infoPane;
        this._selectionPane._actionBar = ab;
        this._selectionPane._dt = selectionItemDataTable;
        this.setSelectionInfoVisible(false);
        this._selectionPane._dt.setup(function() {

        });

        return this;
    }
    DataTable.prototype.sumarizerSelectionItem = function(data) {
        return Dom.htmlEncode(data);
    }
    DataTable.prototype.setSelectionInfoVisible = function (visible) {
        if (!this._selectionPane) return;
        this._selectionPane.style.display = visible ? "block" : "none";
        if (visible) {
            this._selectionPane._dt.invalidateSizing();
            this._selectionPane._actionBar.invalidate();
        }
    };
    DataTable.prototype.setShowSelectionInfo = function(show) {
        this.showSelectionInfo = show;
    }
    DataTable.prototype.disabledCheckBoxWhenCheckAll = function(disabled) {
        this.disabledWhenCheckAll = disabled;
    }
    DataTable.prototype.invalidateOverflowIndicators = function () {
        if (!this.leftOverflowIndicator) return;

        var overflowLeft = (this.container.scrollLeft != 0);
        var overflowRight = (this.container.offsetWidth + this.container.scrollLeft != this.container.scrollWidth);

        var indicatorContainer = this.leftOverflowIndicator.parentNode;
        if (overflowLeft) {
            Dom.addClass(indicatorContainer, "DTOverflowLeft");
        } else {
            Dom.removeClass(indicatorContainer, "DTOverflowLeft");
        }
        if (overflowRight) {
            Dom.addClass(indicatorContainer, "DTOverflowRight");
        } else {
            Dom.removeClass(indicatorContainer, "DTOverflowRight");
        }
    };
    DataTable.prototype.setHeight = function(height) {
    };

    DataTable.prototype.setMinHeight = function(height) {
    };

    DataTable.prototype.setHiddenHeader = function(isHidden) {
        this.hiddenHeader = isHidden;
    };
    DataTable.prototype._fireListenerEvent = function (eventName, data, fromUserAction) {
        for (var i = 0; i < this.listeners.length; i ++) {
            var f = this.listeners[i]["on" + eventName];
            if (f) f(this, data, fromUserAction);
        }
    };
    DataTable.prototype.fireSelectionChangedEvent = function (fromUserAction, data) {
        for (var i = 0; i < this.listeners.length; i ++) {
            if (this.listeners[i].onSelectionChanged) this.listeners[i].onSelectionChanged(this, fromUserAction, data);
        }
        if (this._selectionPane && this._selectionPane._dt && !this._selectionPane._pg) {
            this._selectionPane._dt.setItems(this.getSelectedItems());
        }
    };
    DataTable.prototype.fireCheckBoxChangedEvent = function (index, isChecked) {
        for (var i = 0; i < this.listeners.length; i ++) {
            if (this.listeners[i].onCheckBoxChanged) this.listeners[i].onCheckBoxChanged(index, isChecked);
        }
    };
    DataTable.prototype.fireAllCheckBoxChangedEvent = function (isChecked) {
        for (var i = 0; i < this.listeners.length; i ++) {
            if (this.listeners[i].onAllCheckBoxChanged) this.listeners[i].onAllCheckBoxChanged(isChecked);
        }
    };
    DataTable.prototype.fireSelectNoneActionEvent = function () {
        for (var i = 0; i < this.listeners.length; i ++) {
            if (this.listeners[i].onSelectNoneAction) this.listeners[i].onSelectNoneAction();
        }
    };
    DataTable.prototype.fireScrollLocationEvent = function () {
        var dy = this._getRemainingScrollBottom();
        for (var i = 0; i < this.listeners.length; i ++) {
            if (this.listeners[i].onVerticalScrolled) this.listeners[i].onVerticalScrolled(dy);
        }
    };

    DataTable.prototype.selectAll = function (noEvent) {
        Dom.addClass(this.container, "SelectAll");
        var selectAllCheckbox = this.container.querySelector("input.DataTableCheck.All");
        if (selectAllCheckbox) selectAllCheckbox.checked = true;
        
        this.selectCurrentPageItems(true, 0);
        this._unselectedIds = [];

        if (!noEvent) this.fireSelectionChangedEvent(true);
    };
    DataTable.prototype.selectCurrentPageItems = function (selected, startIndex) {
        var all = this.isSelectAll();
        var thiz = this;
        Dom.doOnChildRecursively(this.table, {
            eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "Item")}
        }, function (c) {
            var dataIndex = c.getAttribute("data-index");
            if (!dataIndex || parseInt(dataIndex, 10) < startIndex) return;

            if (c.getAttribute("_isSelectable") == false || c.getAttribute("_isSelectable") == "false") {
                c.disabled = true;
            } else {
                c.checked = selected;
                c.disabled = typeof(thiz.disabledWhenCheckAll) == "undefined" ? all : thiz.disabledWhenCheckAll;
            }

        });

        //this.fireSelectionChangedEvent();
    };

    DataTable.prototype.selectItems = function (items, fromUserActions) {
        var thiz = this;
        var allChecked = true;
        var checkAllElement = null;

        Dom.doOnChildRecursively(this.table, {
            eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "Item")}
        }, function (c) {
            var index = parseInt(c.getAttribute("data-index"), 10);
            var item = thiz.items[index]
            var itemChecked = Util.contains(items, item, thiz.comparer);
            c.checked =  itemChecked;

            if (!itemChecked) {
                allChecked = false;
            } else {
                //remove from unselected
                index = thiz._unselectedIds.indexOf(item.id);
                if (index >= 0) thiz._unselectedIds.splice(index, 1);
            }
        });

        Dom.doOnChildRecursively(this.table, {
            eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "All")}
        }, function (c) {
            if (!thiz.items || thiz.items.length == 0) {
                allChecked = false;
                c.disabled = true;
            } else {
                c.disabled = false;
            }

            c.checked = allChecked;
        });

        Dom.doOnChildRecursively(this.table, {
            eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "Item")}
        }, function (c) {
            if (c.getAttribute("_isSelectable") == false || c.getAttribute("_isSelectable") == "false") {
                c.disabled = true;
            } else if (allChecked && thiz.disabledWhenCheckAll) {
                c.disabled = true;
            } else {
                c.disabled = false;
            }
        });

        this._updateCheckedRowIndicator();

        this.fireSelectionChangedEvent(fromUserActions);
    };
    DataTable.prototype._updateCheckedRowIndicator = function () {
        Dom.doOnChildRecursively(this.table, {
            eval: function (n) {
                return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "Item");
            }
        }, function (c) {
            var tr = Dom.findParentByTagName(c, "tr");
            if (tr) {
                Dom.toggleClass(tr, "DTCheckedItemRow",  c.checked);
            }
        })

    };
    DataTable.prototype.highlightItems = function (items, styleClass) {
        var thiz = this;

        Dom.doOnAllChildren(this.body, function (tr) {
            var dataIndex = tr.getAttribute("data-index");
            if (!dataIndex) return;

            var index = parseInt(dataIndex, 10);
            var item = thiz.items[index]
            if (!item) return;

            if (Util.contains(items, item, thiz.comparer)) {
                Dom.addClass(tr, styleClass ? styleClass : "Highlighted");
            } else {
                Dom.removeClass(tr, styleClass ? styleClass : "Highlighted");
            }
        })
    };
    DataTable.prototype.removeHighlightItems = function (items, styleClass) {
        var thiz = this;

        Dom.doOnAllChildren(this.body, function (tr) {
            var dataIndex = tr.getAttribute("data-index");
            if (!dataIndex) return;

            var index = parseInt(dataIndex, 10);
            var item = thiz.items[index]
            if (!item) return;

            if (Util.contains(items, item, thiz.comparer)) {
                Dom.removeClass(tr, styleClass ? styleClass : "Highlighted");
            }
        })
    };
    DataTable.prototype.selectNone = function () {
        Dom.removeClass(this.container, "SelectAll");
        var selectAllCheckbox = this.container.querySelector("input.DataTableCheck.All");
        if (selectAllCheckbox) selectAllCheckbox.checked = false;
        this.selectCurrentPageItems(false, 0);
        this.fireSelectionChangedEvent();
        this.fireSelectNoneActionEvent();
        this._unselectedIds = [];
    };
    DataTable.prototype.isSelectAll = function () {
        return Dom.hasClass(this.container, "SelectAll");
    };
    DataTable.prototype.reset = function () {
        this.selectNone();
        Dom.doOnChildRecursively(this.table, {
            eval: function (n) { return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "All")}
        }, function (c) {
            c.checked = false;
        })
    };

    DataTable.prototype.getSelectionCount = function () {
        if (this.isSelectAll()) return Math.max(0, this.totalItems - this._getExcludedItemCounts());
        return this.getSelectedItems().length;
    };

    DataTable.prototype._getExcludedItemCounts = function () {
        return this._unselectedIds ? this._unselectedIds.length : 0;
    };
    DataTable.prototype.isItemUnselected = function (item) {
        return  this._unselectedIds && item && item.id && (this._unselectedIds.indexOf(item.id) >= 0);
    };
    DataTable.prototype.isIdUnselected = function (id) {
        return  this._unselectedIds && id && (this._unselectedIds.indexOf(id) >= 0);
    };

    DataTable.prototype.column = function (c) {
        this.columns.push(c);
        this.visibleColumnIds.push(c.id);
        if (c.getGroupKey) Dom.addClass(this.node(), "WithMergedCells");
        return this;
    };
    DataTable.prototype.withItemComparer = function (comparer) {
        this.comparer = comparer;
        return this;
    };
    DataTable.prototype.action = function (a, asSelectionHander) {
        this.actions.push(a);
        if (asSelectionHander) {
            this.setDefaultSelectionHandler(handler);
        }
        return this;
    };
    DataTable.prototype.selector = function (s, ex, noSelectAll) {
        this.withSelector = s;
        this.exclusive = ex || false;
        this.noSelectAll = noSelectAll;
        return this;
    };
    DataTable.prototype.disabledSelectAll = function (disabled) {
        var selectAllCheckbox = this.container.querySelector("input.DataTableCheck.All");
        if (selectAllCheckbox) selectAllCheckbox.disabled = disabled;
    };
    DataTable.prototype.setDefaultSelectionHandler = function (handler) {
        this.defaultSelectionHandler = handler;
        Dom.addClass(this.table, "WithSelectionHandler");
    };

    DataTable.prototype.withColumnBuilder = function (builder) {
        this.columnBuilder = builder;
        return this;
    };
    DataTable.prototype.createColumnDefinitions = function () {
        this.actualColumns = [];

        //add a selector column if required
        if (this.withSelector) {
            var selectorColumn = new SelectorColumn(this.exclusive, this.selectable, this.checked, this.noSelectAll);
            selectorColumn.sizingPolicy = this.selectorColumnWidth || "3em";
            this.actualColumns.push(selectorColumn);
        }

        if (this.columnBuilder) {
            this.columns = this.columnBuilder.build();
        }

        for (var i = 0; i < this.columns.length; i ++) {
            var column = this.columns[i];
            column.sizingPolicy = column.preferredWidth || this.defaultColWidth || "1*";
            this.actualColumns.push(column);

            if (column.defaultHidden && !column._defaultHidden && this.isColumnVisible(column.id)) {
                column._defaultHidden = true;
                this.hiddenColumnIds.push(column.id);
            }
        }

        //add an action column at the end, if requested
        if (this.actions && this.actions.length > 0) {
            var actionColum = new ActionColumn(this.actions);
            actionColum.sizingPolicy = actionColum.preferredWidth || this.defaultColWidth || "1*";
            this.actualColumns.push(actionColum);
        }

    };
    DataTable.prototype.setup = function (callback) {
        this.actualColumns = [];

        this.createColumnDefinitions();

        this._init();
        if (callback) callback();

        return this;
    };

    DataTable.prototype.systemId = function (id) {
        this.systemId = id;
        return this;
    };
    DataTable.prototype.configurable = function () {
        this.isConfigurable = true;
        return this;
    };
    DataTable.prototype.withHeightControl = function (control) {
        this.heightControl = control;
        return this;
    };

    DataTable.prototype._checkHorizontalScrolling = function () {
        this.overflowX = (this.container.offsetWidth < this.table.offsetWidth);

        Dom.toggleClass(this.container, "OverflowX", this.overflowX);
        this.fakeScrollerContainer.style.width = this.container.clientWidth + "px";
        var right = Math.round(window.innerWidth - this.container.getBoundingClientRect().right);
        this.fakeScrollerContainer.style.right = right + "px";

        this.fakeScrollerContent.style.width = this.table.offsetWidth + "px";
    };
    DataTable.prototype.invalidateSizing = function(callback) {
        if (!this.actualColumns) {
            if (callback) callback();
            return;
        }

        var thiz = this;

        thiz._updateHeaderSize();
        window.setTimeout(function () {
            thiz._checkHorizontalScrolling();
            thiz._invalidateOverflowIndicators();
        }, 100);

        var realTableWidth = this._calculateTableAndColumnWidths();

        for (var i = 0; i < this.actualColumns.length; i ++) {
            var col = this.actualColumns[i];
            var width = col._width;

            if (!this.isColumnVisible(col)) width = 0;

            var innerWidth = Math.max(width - DataTable.COLUMN_SIZE_MARGIN, 0);

            var th = document.getElementById(col.columnId);
            if (!th) {
                continue;
            }

            th.setAttribute("width", "" + width);
            var cssWidth = width + "px";
            th.style.width = cssWidth;

            var child = th.firstChild;
            while (child && child.nodeType == Node.ELEMENT_NODE && (child.nodeName.toLowerCase() != "input")) {
                child.style.width = cssWidth;
                child = child.firstChild;
            }

            var th = document.getElementById(col._bodyColumnId);
            if (th) {
                th.setAttribute("width", "" + width);
                var cssWidth = width + "px";
                th.style.width = cssWidth;
            }
        }

        this.table.style.width = realTableWidth + "px";
        this.headerTable.style.width = realTableWidth + "px";
        this.headerTable.parentNode.style.width = (this._headerFloating ? this.container.clientWidth : realTableWidth) + "px";
        this.loadingIndicator.style.width = this.container.clientWidth + "px";

        if (this._headerFloating) {
            var scrollPane = this._lastScrollPane || this._findScrollPane();
            var r2 = this._getScrollPaneRect(scrollPane);
            this._fireListenerEvent("HeaderFloatingUpdated", {
                rect: r2
            });
        }
        
        if (callback) callback();
    }
    DataTable.prototype.supportZebraColor = function() {
        return true;
    };
    DataTable.prototype.onSizeChanged = function () {
        var thiz = this;
        this.invalidateSizing(function () {
            for (var i = 0; i < thiz.listeners.length; i ++) {
                if (thiz.listeners[i].onSizeChanged) thiz.listeners[i].onSizeChanged(thiz);
            }
        });
    };
    DataTable.prototype._updateHeaderSize = function() {
        if (!this.table.offsetParent) {
            return; // dont calculate if the table is hidden
        }

        this.headerWrapperInners.forEach(function (node) {
            var wrapper = node.parentNode;
            var th = wrapper.parentNode;
            wrapper.style.height = node.style.height = "auto";
            wrapper.style.height = node.style.height = (th.clientHeight) + "px";
        });
    };
    DataTable.prototype._invalidateOverflowIndicators = function () {
        if (!Dom.hasClass(this.container.parentNode, "DataTableWrapper")) return;
        var left = this.container.scrollLeft > 0;
        var right = this.container.getBoundingClientRect().right < this.table.getBoundingClientRect().right - 1;

        Dom.toggleClass(this.container.parentNode, "WithLeftOverflow", left);
        Dom.toggleClass(this.container.parentNode, "WithRightOverflow", right);
    };
    DataTable.prototype._innerScrollListener = function() {
        if (this.fakeScrollerContainer) this.fakeScrollerContainer.scrollLeft = this.container.scrollLeft;
        if (this._headerFloating) this.headerTable.parentNode.scrollLeft = this.container.scrollLeft;
        this.loadingIndicator.style.left = this.container.scrollLeft + "px";

        if (this.columnSettingButton) {
            var dx = this.node().scrollLeft;
            var right = (1 - parseFloat(dx)) + "px";
            this.columnSettingButton.style.right = right;
        }

        this._invalidateOverflowIndicators();
    };
    DataTable.prototype._findScrollPane = function () {
        var scrollPane = Dom.findUpward(this.node().parentNode, function (n) {
            var overflowY = window.getComputedStyle(n, null).getPropertyValue("overflow-y");
            return (n.scrollHeight > n.clientHeight) && (overflowY == "auto" || overflowY == "scroll");
        });
        if (!scrollPane || scrollPane == window) {
            scrollPane = window.document.body;
        }
        return scrollPane;
    };
    DataTable.prototype._getScrollPaneRect = function (scrollPane) {
        return scrollPane.getBoundingClientRect ? scrollPane.getBoundingClientRect() : {
            left: 0,
            top: 0,
            right: window.innerWidth,
            width: window.innerWidth,
            bottom: window.innerHeight,
            height: window.innerHeight
        };
    };



    DataTable.prototype._updateFakeHorizontalScroll = function (event) {
        if (!this.useFloatingHeader || !this.fakeScrollerContainer) return;

        var needScroll = false;
        var scrollPane = this._lastScrollPane || this._findScrollPane();

        if (scrollPane) {
            var r1 = this.node().getBoundingClientRect();
            var r2 = this._getScrollPaneRect(scrollPane);

            needScroll = r2.bottom < r1.bottom;

            var delta = Math.max(0, window.innerHeight - r2.bottom);
            this.fakeScrollerContainer.style.bottom = Math.round(delta) + "px";

        }

        Dom.toggleClass(this.node(), "WithHorizontalScroll", needScroll && this.overflowX);
    };
    DataTable.prototype._updateHeaderForScrolling = function (event) {
        // if (!event) {
        //     this._updateHeaderForScrollingImpl();
        //     return;
        // }
        // if (this.scrollingUpdateTimeout) {
        //     window.clearTimeout(this.scrollingUpdateTimeout);
        // } else {
        //     Dom.addClass(this.node(), "Scrolling");
        // }
        //
        // this.scrollingUpdateTimeout = window.setTimeout(this._updateHeaderForScrollingImpl.bind(this), 200);
        this._updateHeaderForScrollingImpl();
    };
    DataTable.prototype.invalidateFloatingHeader = function (forced) {
        var scrollPane = this._lastScrollPane;
        if (!scrollPane) return;

        var dy = 0;
        var dx = 0;
        var r2 = null;

        if (scrollPane) {
            var r1 = this.node().getBoundingClientRect();
            r2 = this._getScrollPaneRect(scrollPane);

            dy = r2.top - r1.top;
            dx = r2.left - r1.left;

            if (r1.top + r1.height < r2.top + 60) dy = 0;
        }

        if (dy > 0 && this._headerFloating) {
            this.headerTable.parentNode.style.top = r2.top + "px";
            this.headerTable.parentNode.style.width = this.container.clientWidth + "px";
            this.headerTable.parentNode.scrollLeft = this.container.scrollLeft;
            
            if (forced) {
                var right = Math.round(window.innerWidth - this.table.parentNode.getBoundingClientRect().right);
                this.headerTable.parentNode.style.right = (right + 1) + "px";
            }
            
            if (r2) {
                this._fireListenerEvent("HeaderFloatingUpdated", {
                    rect: r2
                });
            }
        }
    };
    DataTable.prototype._updateHeaderForScrollingImpl = function (event) {
        this.scrollingUpdateTimeout = null;
        var scrollPane = this._lastScrollPane;
        if (!scrollPane) return;

        var dy = 0;
        var dx = 0;
        
        if (scrollPane) {
            var r1 = this.node().getBoundingClientRect();
            var r2 = this._getScrollPaneRect(scrollPane);
            
            dy = r2.top - r1.top;
            dx = r2.left - r1.left;

            if (r1.top + r1.height < r2.top + 60) dy = 0;
        }
        
        if (dy > 0) {

            if (!this._headerFloating) {
                var topPadding = this._getFloatingHeaderTopPadding ? this._getFloatingHeaderTopPadding() : 0;
                this.node().style.paddingTop = this.headerTable.offsetHeight + "px";
                Dom.addClass(this.node(), "HeaderFloated");
                this.headerTable.parentNode.style.top = (r2.top + topPadding) + "px";
                var left = Math.round(this.table.parentNode.getBoundingClientRect().left);
                try {
                    left = Math.round(this.table.parentNode.getBoundingClientRect().left + (this.table.parentNode.getBoundingClientRect().width - this.table.parentNode.clientWidth) / 2);
                } catch (e) {}
                // this.headerTable.parentNode.style.left = left + "px";
                var right = Math.round(window.innerWidth - this.table.parentNode.getBoundingClientRect().right);
                this.headerTable.parentNode.style.right = (right + 1) + "px";

                this._headerFloating = true;
                this.headerTable.parentNode.style.width = this.container.clientWidth + "px";
                this.headerTable.parentNode.scrollLeft = this.container.scrollLeft;
                
                var d = Math.round((this.headerTable.offsetHeight - this.scrollBackButton.offsetHeight) / 2);
                this.scrollBackButton.style.top = (r2.top + d + topPadding) + "px";
                this.scrollBackButton.style.right = (right + d) + "px";
                
                this._fireListenerEvent("HeaderFloatingStarted", {
                    rect: r2
                });
            }

            if (this.columnSettingButton) this.columnSettingButton.style.top = "" + dy + "px";
        } else {
            if (this._headerFloating) {
                Dom.removeClass(this.node(), "HeaderFloated");
                this._headerFloating = false;
                this.headerTable.parentNode.style.width = this.table.offsetWidth + "px";
                this.headerTable.parentNode.scrollLeft = 0;
                this.node().style.paddingTop = "0px";
                
                this._fireListenerEvent("HeaderFloatingEnded", {});
            }

            if (this.columnSettingButton) this.columnSettingButton.style.top = "0px";
        }

        // if (event && (typeof(this._lastScrollDy) == "undefined" || this._lastScrollDy != dy)) {
        //     if (!this._headerScrollDoneHandler) {
        //         var thiz = this;
        //         this._headerScrollDoneHandler = function () {
        //             Dom.removeClass(thiz.node(), "Scrolling");
        //             thiz._headerScrollDoneTimeout = null;
        //         };
        //     }
        //
        //     if (this._headerScrollDoneTimeout) {
        //         window.clearTimeout(this._headerScrollDoneTimeout);
        //     } else {
        //         Dom.addClass(this.node(), "Scrolling");
        //     }
        //
        //     this._headerScrollDoneTimeout = window.setTimeout(this._headerScrollDoneHandler, 200);
        // }

        Dom.removeClass(this.node(), "Scrolling");

        this._lastScrollDy = dy;

    };
    DataTable.prototype._getRemainingScrollBottom = function () {
        var scrollPane = this._lastScrollPane || this._findScrollPane();
        if (!scrollPane) return 0;

        var r1 = this.node().getBoundingClientRect();
        var r2 = this._getScrollPaneRect(scrollPane);

        return Math.max(0, r1.bottom - r2.bottom);
    };
    DataTable.prototype.isNearEnd = function () {
        if (!this.node().offsetParent) return false;
        var scrollPane = this._lastScrollPane || this._findScrollPane();
        if (!scrollPane) return true;

        var r1 = this.node().getBoundingClientRect();
        var r2 = this._getScrollPaneRect(scrollPane);

        return Math.max(0, r1.bottom - r2.bottom) < r2.height / 2;
    };
    DataTable.prototype._reinstallScrollHandler = function() {
        // find nearest scroll box
        var scrollPane = this._findScrollPane();
	if (!scrollPane || scrollPane != this._lastScrollPane) {
            if (this._scrollListener && this._lastScrollPane) {
                this._lastScrollPane.removeEventListener("scroll", this._scrollListener, false);
                this._lastScrollPane = null;
            }

            if (!scrollPane) {
                Dom.removeClass(this.node(), "HeaderFloated");
                return;
            }
        }

        var thiz = this;

        this._scrollListener = function (event) {
            if (event.target != thiz._lastScrollPane) {
                return;
            }
            thiz._updateHeaderForScrolling(event);
            thiz._updateFakeHorizontalScroll();
            thiz.fireScrollLocationEvent();
        };

        if (scrollPane != this._lastScrollPane) {
            this._lastScrollPane = scrollPane;
            this._lastScrollPane.removeEventListener("scroll", this._scrollListener, false);
            this._lastScrollPane.addEventListener("scroll", this._scrollListener, false);
        }
        
        if (!this._dialogMoveInstalled) {
            this._dialogMoveInstalled = true;
            var dialog = Dialog.findContainerDialog(this.node());
            if (dialog) {
                dialog.addEventListener("p:DialogMoved", function () {
                    thiz.invalidateFloatingHeader("forced");
                }, false);
            }
        }

        this._updateHeaderForScrolling();
        this._updateFakeHorizontalScroll();
    };
    DataTable.prototype._calculateContainerWidth = function() {
        var refContainer = this.shrinkingAllowed ? this.node() : this.container;
        var w = refContainer.clientWidth || (Dom.getOffsetWidth(refContainer) - 1);
        //if (this._detectedShrinkDelta) w -= this._detectedShrinkDelta;
        return w;
    };
    DataTable.prototype._calculateTableAndColumnWidths = function () {
        var calculatedContainerWidth = this._calculateContainerWidth();
        this.lastContainerWidth = calculatedContainerWidth;
        
        var totalWidth = this.lastContainerWidth;
        var remainingWidth = totalWidth;

        var totalWeight = 0;
        //console.log("Actual cols size ", this.actualColumns.length);
        for (var i = 0; i < this.actualColumns.length; i ++) {
            var col = this.actualColumns[i];
            var wText = this.isColumnVisible(this.actualColumns[i]) ? col.sizingPolicy : "0px";
            var w = 0;
            if (wText.endsWith("px")) {
                w = parseInt(wText.substring(0, wText.length-2));
                col._width = w;
                remainingWidth -= w;
            } else if (wText.endsWith("em")) {
                var v = wText.substring(0, wText.length-2);
                w = Math.floor(v * Util.em());
                col._width = w;
                remainingWidth -= w;
            } else if (wText.endsWith("*")) {
                w = parseInt(wText.substring(0, wText.length - 1));
                totalWeight += w;
            } else {
                w = parseInt(wText);
                col._width = w;
                remainingWidth -= w;
            }

            if (col.minWidth) {
                if (col.minWidth.endsWith("px")) {
                    w = parseInt(col.minWidth.substring(0, col.minWidth.length - 2));
                    col.minPixelWidth = w;
                } else if (col.minWidth.endsWith("em")) {
                    var v = col.minWidth.substring(0, col.minWidth.length - 2);
                    w = Math.floor(v * Util.em());
                    col.minPixelWidth = w;
                } else {
                    w = parseInt(col.minWidth);
                    col.minPixelWidth = w;
                }
            }
        }

        var MIN_FLEX_WIDTH = this.minColWidth();
        var totalDisplayWidth = totalWidth - remainingWidth;
        if (remainingWidth < 0) remainingWidth = 0;
        
        var remainingFlexWidth = remainingWidth;

        for (var i = 0; i < this.actualColumns.length; i ++) {
            var col = this.actualColumns[i];
            var wText = this.isColumnVisible(this.actualColumns[i]) ? col.sizingPolicy : "0px";
            if (wText.endsWith("*")) {
                w = parseInt(wText.substring(0, wText.length - 1));
                var width = Math.floor((remainingWidth * w) / totalWeight);
                width = Math.max(width, MIN_FLEX_WIDTH * w);

                if (col.minPixelWidth && width < col.minPixelWidth) width = col.minPixelWidth;
                if (this.shrinkingAllowed) {
                    width = Math.min(width, remainingFlexWidth);
                }
                
                col._width = width;
                totalDisplayWidth += col._width;
                remainingFlexWidth -= width;
            }
        }

        var realTableWidth = Math.max(totalWidth, totalDisplayWidth);

        return realTableWidth;
    };
    DataTable.prototype._generateTableHTML = function(tableId, realTableWidth, tableClass, headerId, bodyId, random) {
        var html =
                "<table style=\"width: " + realTableWidth + "px;\" id=\"" + tableId + "\" class=\"" + tableClass
                + (this.supportZebraColor() ? " TableStriped": "") + " TableBordered\">\n" +
                "    <thead class=\"" + (this.hiddenHeader ? "Hidden" : "") + "\">\n" +
                "        <tr id=\"" + (headerId || Util.newUUID()) + "\">\n";

        for (var i = 0; i < this.actualColumns.length; i ++) {
            if (!this.isColumnVisible(this.actualColumns[i])) continue;
            var id = "col" + random + "_" + i + (headerId ? "" : "_body")
            var col = this.actualColumns[i];
            if (headerId) {
                col.columnId = id;
            } else {
                col._bodyColumnId = id;
            }
            var clazz = "";
            if (col.headerClass) {
                clazz += col.headerClass;
            }

            if (col.propertyName) {
                clazz += " Sortable";
            }

            clazz += " ColHead_" + col.id;

            var extra = "";
            if (col.getExtraWrapperClass) {
                extra = " class=\"" + col.getExtraWrapperClass() + "\"";
            }

            var style = "";
            style += "width: " + col._width + "px;";
            var margin = DataTable.COLUMN_SIZE_MARGIN;
            html +=
                "<th title=\"" + Dom.htmlEncode(col.getTitleInfo()) + "\" width=\"" + col._width + "\" data-type=\"" + col.dataType + "\" id=\"" + id + "\" class=\"" + clazz + "\" style=\"" + style +"\"><div style=\"width: " + (col._width - margin) + "px;\" class=\"Wrapper\"><div style=\"width: " + (col._width - margin) + "px;\" class=\"WrapperInner\"><div" + extra + " style=\"width: " + (col._width - margin) + "px;\">" + col.getTitleContentHtml() + "</div></div></div></th>";
        }

        html += "        </tr>\n" +
                "    </thead>\n";

        if (bodyId)  html += "    <tbody id=\"" + this.bodyId + "\"></tbody>\n";

        html += "</table>";

        return html;
    };
    DataTable.COLUMN_SIZE_MARGIN = 0;
    DataTable.prototype._init = function() {
        var thiz = this;

        var random = widget.random();
        this.tableId = "table" + random;
        this.headerTableId = this.tableId + "HeaderTable";
        this.headerTableWrapperId = this.headerTableId + "Wrapper";
        this.scrolBackButtonId = this.tableId + "ScrollBackButton";
        this.headerId = "header" + random;
        this.bodyId = "body" + random;
        this.container.innerHTML = "";
        // this.container.style.overflow = "hidden";

        this.createColumnDefinitions();
        var realTableWidth = this._calculateTableAndColumnWidths();

        var headerTableHTML = this._generateTableHTML(this.headerTableId, realTableWidth, "DataTable DataTableHeaderTable", this.headerId, null, random);
        var contentTableHTML = this._generateTableHTML(this.tableId, realTableWidth, "DataTable", null, this.bodyId, random);
        var scrollBackButtonHTML = `<button id="${this.scrolBackButtonId}" class="ScrollBackButton" title="Scroll back to top"><icon class="format-vertical-align-top"></icon></button>`;

        var html = "<div id=\"" + this.headerTableWrapperId + "\" class=\"HeaderTableWrapper\" style=\"width: " + realTableWidth + "px;\">" + headerTableHTML + "</div>\n" + scrollBackButtonHTML;
        html += contentTableHTML;
        this.container.innerHTML = html;

        this.table = document.getElementById(this.tableId);
        this.headerTable = document.getElementById(this.headerTableId);
        this.header = document.getElementById(this.headerId);
        this.headerHeight = Dom.getOffsetHeight(this.header);
        this.body = document.getElementById(this.bodyId);
        this.scrollBackButton = document.getElementById(this.scrolBackButtonId);
        
        this.scrollBackButton.addEventListener("click", function () {
            if (!thiz._lastScrollPane) return;
            thiz._lastScrollPane.scrollTop = 0;
        }, false);

        //store list of header inners
        var inners = this.header.querySelectorAll("th .Wrapper > .WrapperInner");
        this.headerWrapperInners = [];
        for (var i = 0; i < inners.length; i ++) this.headerWrapperInners.push(inners[i]);

        if (this.defaultSelectionHandler) {
            Dom.addClass(this.table, "WithSelectionHandler");
        }

        Dom.removeClass(this.node(), "HeaderFloated");
        Dom.toggleClass(this.node(), "NoHeightControl", !this.heightControl ? true : false);

        window.setTimeout(function () {
            thiz._updateHeaderSize();
        }, 10);

        this.table._dt = this;
        this.header._dt = this;

        this.overlay = document.createElement("div");
        Dom.addClass(this.overlay, "BusyOverlay");
        this.container.appendChild(this.overlay);

        Dom.addClass(this.container, "DataTableContainer");

        if (this.isConfigurable) {
            if (this.columnSettingButton) {
                try {
                    this.columnSettingButton.parentNode.removeChild(this.columnSettingButton);
                } catch (e) {}
            }
            this.columnSettingButton = document.createElement("div");
            if (this.columnSettingButtonContainer) {
                this.columnSettingButtonContainer.appendChild(this.columnSettingButton);
                Dom.addClass(this.columnSettingButtonContainer, "DataTableColumSettingContainer");
            } else {
                this.container.appendChild(this.columnSettingButton);
                Dom.addClass(this.container, "DataTableColumSettingContainer");
            }
            Dom.addClass(this.columnSettingButton, "ColumnSetting");
            this.columnSettingButton.innerHTML = "<span><i ui-icon=\"cog\"></i></span>";
            this.columnSettingButton.setAttribute("title", "Column Settings");
            Dom.registerEvent(this.columnSettingButton, "click", function () {
                if (thiz.columnBuilder) {
                    thiz.columnBuilder.setup(function () {
                        thiz._init();
                        if (thiz.items) thiz.setItems(thiz.items);
                    });
                } else {
                    //console.log("Show col setting..");
                    thiz.showColumnSettingDialog();
                }
            }, false);
        }
        if (this.withSelector) {
            this.addSelectionInfoPane();
        }
        if (this.currentOrder) {
           this.setOrder(this.currentOrder);
        }
        Dom.registerEvent(this.header, "click", columnHeaderClickHandler, false);

        this.loadingIndicator = Dom.newDOMElement({
            _name: "hbox",
            "class": "BusyIndicator",
            _children: [
                {
                    _name: "hbox",
                    _children: [
                        {
                            _name: "icon", "class": "image-filter-tilt-shift"
                        },
                        {
                            _name: "span", _text: "Loading..."
                        }
                    ]
                }
            ]
        }, this.container.ownerDocument, this);

        this.container.appendChild(this.loadingIndicator);

        this.fakeScrollerContainer = Dom.newDOMElement({
            _name: "div",
            "class": "ScrollerContainer",
            _children: [
                {
                    _name: "div",
                    "class": "Content",
                    _id: "fakeScrollerContent"
                }
            ]
        }, this.container.ownerDocument, this);
        this.container.appendChild(this.fakeScrollerContainer);

        this.fakeScrollerContainer.addEventListener("scroll", function (e) {
            thiz.container.scrollLeft = thiz.fakeScrollerContainer.scrollLeft;
            if (thiz._headerFloating) thiz.headerTable.parentNode.scrollLeft = thiz.fakeScrollerContainer.scrollLeft;
            thiz.loadingIndicator.style.left = thiz.fakeScrollerContainer.scrollLeft + "px";

            if (thiz.columnSettingButton) {
                var dx = thiz.node().scrollLeft;
                var right = (1 - parseFloat(dx)) + "px";
                thiz.columnSettingButton.style.right = right;
            }


            thiz._invalidateOverflowIndicators();
        }, false);

        window.setTimeout(function () {
            thiz._checkHorizontalScrolling();
        }, 10);
    };

    DataTable.prototype.invalidateColumnTitles = function () {
        for (var i = 0; i < this.actualColumns.length; i ++) {
            var col = this.actualColumns[i];
            if (!this.isColumnVisible(col) || !col.columnId) continue;

            var container = this.container.ownerDocument.getElementById(col.columnId);

            if (!container) continue;

            container.setAttribute("title", col.getTitleInfo());

            var wrapperInner = container.querySelector(":scope > .Wrapper > .WrapperInner > div");
            if (!wrapperInner) {
                if (container.firstChild && container.firstChild.getAttribute) container = container.firstChild;
            } else {
                container = wrapperInner;
            }

            container.innerHTML = col.getTitleContentHtml();
        }
    };

    DataTable.prototype.isColumnVisible = function (column) {
        if (this.columnBuilder) return true;
        if (!this.hiddenColumnIds) return true;
        if (column.unremovable) return true;

        for (var i = 0; i < this.hiddenColumnIds.length; i ++) {
            if (this.hiddenColumnIds[i] == column.id) return false;
        }

        return true;
    };
    DataTable.prototype.defaultColWidth = function(w) {
        this.defaultColWidth = w;
        return this;
    }
    DataTable.prototype.minColWidth = function() {
      return 30;
    };
    DataTable.prototype.getVisibleColumnIds = function () {
        var columnIds = [];
        this.columns.forEach(function (column) {
            if (this.isColumnVisible(column)) columnIds.push(column.id);
        }.bind(this));
        return columnIds;
    };

    DataTable.prototype.getVisibleColumns = function () {
        var columns = [];
        this.columns.forEach(function (column) {
            if (this.isColumnVisible(column)) columns.push(column);
        }.bind(this));
        return columns;
    };

    DataTable.prototype.setVisibleColumnIds = function (columnIds) {
        if (columnIds.length <= 0) {
            Dialog.error("Please select at least one visible column.");
            return;
        }
        this._detectedShrinkDelta = undefined;
        var lastIndex = this.columns.length + 1;
        this.columns.sort(function (a, b) {
            var aIndex = columnIds.indexOf(a.id) < 0 ? lastIndex : columnIds.indexOf(a.id);
            var bIndex = columnIds.indexOf(b.id) < 0 ? lastIndex : columnIds.indexOf(b.id);
            return aIndex - bIndex;
        });

        var hiddenIds = [];
        this.columns.forEach(function (column) {
            if (column.unremovable) return;
            if (columnIds.indexOf(column.id) < 0) hiddenIds.push(column.id);
        })

        this.setHiddenColumnIds(hiddenIds, columnIds);

        var thiz = this;
        if (!Dom.isElementExistedInDocument(this.container)) {
            return;
        }
        var selected = this.getSelectedItems();

        this.container.innerHTML = "";

        window.setTimeout(function () {
            thiz.setup(function () {
                thiz._setItems(thiz.getItems(), false);
                thiz.selectItems(selected);
            });
        }, 1);
    };
    DataTable.prototype.setHiddenColumnIds = function (ids, visibleIds) {
        var paramValue = "";
        for (var i = 0; i < ids.length; i ++) {
            if (paramValue) paramValue += ",";
            paramValue += ids[i];
        }
        this.hiddenColumnIds = ids;
        if (!paramValue) paramValue = "-";
        var thiz = this;

        for(var k = 0; k < this.columnSettingListeners.length; k++) {
            this.columnSettingListeners[k].changeColumnSetting(visibleIds);
        }

    };

    DataTable.prototype.setColumnSettingDialog = function (dialog) {
        this.columnSettingDialog = dialog;
    };
    DataTable.prototype.setColumnSettingHandler = function (handler) {
        this.columnSettingHandler = handler;
    };
    DataTable.prototype.showColumnSettingDialog = function () {
        if (this.columnSettingHandler) {
            this.columnSettingHandler(this);
            return;
        }

        if (this.columnSettingDialog) {
            var f = this.columnSettingDialog;
            var dialog = new f();
            dialog.callback(function (columnIds) {
                if (!columnIds || columnIds.length <= 0) return;

                this.setVisibleColumnIds(columnIds);

            }.bind(this)).open({table: this});
            return;
        }

        var thiz = this;
        var builder = {
            title: "Column Settings",
            size: "mini",
            buildContent: function (container) {
                container.innerHTML = "<strong>Visible columns:</strong>";
                var div = document.createElement("div");
                Dom.addClass(div, "ColumnSelectorContainer");
                container.appendChild(div);
                this.checkboxContainer = div;
                for (var i = 0; i < thiz.columns.length; i ++) {
                    var id = "c" + widget.random();
                    var row = Dom.newDOMElement({
                        _name: "div",
                        _children: [{
                            _name: "input",
                            "type": "checkbox",
                            id: id
                        }, {
                            _name: "label",
                            "for": id,
                            _html: thiz.columns[i].getTitleContentHtml()
                        }]
                    }, document);
                    div.appendChild(row);
                    var unremovable = thiz.columns[i].unremovable;
                    // console.log("unremovable:", unremovable);
                    row.firstChild.checked = unremovable || thiz.isColumnVisible(thiz.columns[i]);
                    if (unremovable) row.firstChild.disabled = true;
                    row._column = thiz.columns[i];
                }
            },
            actions: [
                {
                    title: "Save",
                    primary: true,
                    run: function () {
                        var hiddenIds = [];
                        var visibleIds = [];
                        for (var i = 0; i < this.checkboxContainer.childNodes.length; i ++) {
                            var row = this.checkboxContainer.childNodes[i];
                            if (row.firstChild.checked) {
                                visibleIds.push(row._column.id);
                            } else {
                                hiddenIds.push(row._column.id);
                            }
                        }

                        if (visibleIds.length <= 0) {
                            Dialog.error("Please select at least one visible column.");
                            return false;
                        }

                        thiz.setHiddenColumnIds(hiddenIds, visibleIds);
                        thiz.invalidateSizing();
                        return true;
                    }
                },
                {
                    title: "Cancel",
                    isCloseHandler: true,
                    run: function () {
                        return true;
                    }
                }
            ]
        };
        new BuilderBasedDialog(builder).open();
    };

    DataTable.prototype.getCalculatedHeight = function () {
        var headerHeight = this.table.getElementsByTagName("th")[0].offsetHeight;
        var bodyHeight = this.table.offsetHeight - headerHeight;
        var rowHeight = bodyHeight / (this.items ? this.items.length : 1);


        var dialog = Dom.findParentWithClass(this.table, "DialogContainer");
        if (dialog) {
            //find scrollable container
            var container = Dom.findParentWithClass(this.table, "MainContainer");
            var expectedBodyHeight = container.offsetHeight - headerHeight;
            return Math.floor(expectedBodyHeight);
        } else {
            var outerContainer = widget.get("outerContainer");
            var contentHeight = outerContainer ? outerContainer.offsetHeight : document.body.offsetHeight;
            //console.log([contentHeight, this.table.offsetHeight, window.innerHeight]);
            var d = contentHeight - this.table.offsetHeight;
            var expectedBodyHeight = window.innerHeight - d - headerHeight;
            var n = Math.floor(expectedBodyHeight);
            var h = window.innerHeight - this.getHeightElement(this.table).y - 30;
            return h;
        }
    };

    DataTable.prototype.getHeightElement = function(element) {
        var xPosition = 0;
        var yPosition = 0;
        while (element) {
            xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
            yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
            element = element.offsetParent;
        }
        return {
            x : xPosition,
            y : yPosition
        };
    };

    DataTable.prototype.getDefaultRowHeight = function() {
        var headerHeight = this.table.getElementsByTagName("th")[0].offsetHeight;
        var bodyHeight = this.table.offsetHeight - headerHeight;
        var rowHeight = 0;
        if (this.items.length == 0) {
            rowHeight = 1.5 * Util.em();
        } else {
            rowHeight = bodyHeight / this.items.length;
        }

        return rowHeight;
    };
    DataTable.prototype.calculatePreferredPageSize = function (sampleItems, callback) {
        //console.log("calculatePreferredPageSize is called");
        Dom.addClass(this.node(), "PageSizeCalculating");
        var thiz = this;

        this.setItems([]);

        var calculateHeightStep = function () {
            var height = thiz.node().offsetHeight;
            thiz.node().style.height = height + "px";
            thiz.node().style.overflow = "hidden";
            thiz.node().style.boxSizing = "border-box";

            window.setTimeout(calculateRowSizeStep, 50);
        };
        var calculateRowSizeStep = function () {
            thiz.setItems(sampleItems);
            var tries = 10;
            var f = function () {
                try {
                    var pageSize = thiz.getPreferredPageSize();
                    thiz.setItems([]);
                    Dom.removeClass(thiz.node(), "PageSizeCalculating");
                    callback(pageSize);
                } catch (e) {
                    if (tries --> 0) {
                        window.setTimeout(f, 100);
                    } else {
                        thiz.setItems([]);
                        Dom.removeClass(thiz.node(), "PageSizeCalculating");
                        callback(1);
                    }
                }
            };

            window.setTimeout(f, 100);
        };

        window.setTimeout(calculateHeightStep, 100);
    }
    DataTable.prototype.getPreferredPageSize = function (busy) {
        this.table.style.height = "auto";
        var headerHeight = Dom.getOffsetHeight(this.table.getElementsByTagName("th")[0]);
        if (headerHeight <= 0) throw new Error("headerHeight <= 0");

        var bodyHeight = Dom.getOffsetHeight(this.table) - headerHeight;
        if (bodyHeight <= 0) throw new Error("bodyHeight <= 0");

        var rowHeight = bodyHeight / (this.items ? this.items.length : 1);

        var maxBodyHeight = this.container.clientHeight - headerHeight;
        var rows = Math.floor(maxBodyHeight / rowHeight);
        if (rows <= 0) rows = 1;
        this.lastCalculatedPageSize = rows;

        // console.log("getPreferredPageSize: ", {
        //     headerHeight: headerHeight,
        //     bodyHeight: bodyHeight,
        //     rowHeight: rowHeight,
        //     maxBodyHeight: maxBodyHeight,
        //     rows: rows
        // });

        return rows;
    };

    DataTable.prototype.getItemHeight = function () {
        var rowHeight = this.getDefaultRowHeight();
        return rowHeight;
    };

    DataTable.prototype.showBusy = function (busy) {
        if (busy) {
            //Dom.addClass(this.container, "Busy");
            //Dom.addClass(this.container, "DataTableContainerBusy");
            defaultIndicator.busy(widget.LOADING);
        } else {
            //Dom.removeClass(this.container, "Busy");
            //Dom.removeClass(this.container, "DataTableContainerBusy");
            defaultIndicator.done();
        }
    };

    DataTable.prototype.getItems = function() {
        return this.items;
    };
    DataTable.prototype.getOrderingItems = function () {
        var items = [];
        var thiz = this;
        Dom.doOnAllChildren(this.body, function (c) {
            var index = Dom.getAttributeAsInt(c, "data-index", undefined);
            if (index != undefined) items.push(thiz.items[index]);
        });
        return items;
    }
    DataTable.prototype.updateItemsOrder = function() {
        var thiz = this;
        var items = [];
        var i = 0;
        Dom.doOnAllChildren(this.body, function (c) {
            var index = Dom.getAttributeAsInt(c, "data-index", undefined);
            if (index != undefined) items.push(thiz.items[index]);
            c.setAttribute("data-index", i++);
        });
        this.items = items;
    }

    DataTable.prototype.addItems = function(items) {
        var html = "";
        for (var i = 0; i < items.length; i ++) {
            var item = items[i];
            html += "<tr data-index=\"" + i + "\">";
            for (var j = 0; j < this.actualColumns.length; j ++) {
                if (!this.isColumnVisible(this.actualColumns[j])) continue;
                var column = this.actualColumns[j];
                html += "<td data-title=\"" + Dom.htmlEncode(column.title) + "\"";
                if (column.getBodyClass || column.id) {
                    var c = column.getBodyClass ? column.getBodyClass(item, i, j) : ("Col_" + column.id);
                    if (c) {
                        html += " class=\"" + c + "\"";
                    }
                }
                if (column._width) {
                    html += " style=\"width: " + column._width + ";\"";
                }
                if (column.dataType) {
                    html += " data-type=\"" + column.dataType + "\"";
                }

                var cellHtml = column.getCellContentHtml(item, i, j);
                if (column.getContentTitle) {
                     var text = column.getContentTitle(item, i, j);
                     if (text && text.length > 0) {
                         html += " title=\"" + text  +"\"";
                     }
                }
                html += "><div class=\"CellContentWrapper\" style=\"width: 100%; box-sizing: border-box;\">";
                html += cellHtml;
                html += "</div></td>";
            }

            html += "</tr>";
            this.items.push(items[i]);
        }

        if (navigator.userAgent.match(/MSIE/i)) {
            this.temp.innerHTML = "<table><tbody>" + html + "</tbody></table>";
            var newBody = this.temp.firstChild.firstChild;
            newBody.parentNode.removeChild(newBody);
            this.table.replaceChild(newBody, this.body);
            this.body.innerHTML += newBody;
        } else {
            this.body.innerHTML += html;
        }


        this.fireSelectionChangedEvent(false);
    }
    
    DataTable.prototype.appendItems = function(items) {
        this._setItems(items, true, "append");
    };
    DataTable.prototype.markAppending = function(appending) {
    };

    DataTable.prototype.getClassOfRow = function(item) {
        return "";
    };

    DataTable.prototype.markedAsPaginated = function (paginated) {
        this.paginated = paginated;
        if (paginated) {
            Dom.addClass(this.container, "DataTableContainerPaginated");
        } else {
            Dom.removeClass(this.container, "DataTableContainerPaginated");
        }
    };
    DataTable.prototype.invalidateRowOfNode = function(contextNode, newData) {
        var nodeContext = DataTable._getNodeContext(node);
        if (!nodeContext) return null;

        if (this != nodeContext.instance) return;

        var data = nodeContext.data;
        if (typeof(newData) != "undefined") {
            data = newData;
            this.items[nodeContext.index] = newData;
        }

        this._invalidateRow(nodeContext.row, nodeContext.index, data);
    };
    DataTable.prototype.deleteRow = function(contextNode) {
        var nodeContext = DataTable._getNodeContext(contextNode);
        if (!nodeContext) return null;

        if (this != nodeContext.instance) return;
        var next = nodeContext.row.nextElementSibling;
        while (next) {
            if (next.hasAttribute("data-index")) {
                var index = parseInt(next.getAttribute("data-index"), 10);
                next.setAttribute("data-index", index - 1);

                var input = Dom.findChild(next, {
                    eval: function (node) {
                        var inputEvaluator = new DomTagNameEvaluator("input");
                        var isCheckbox = Dom.getAttributeAsString(node, "type", "").toLowerCase() === "checkbox";
                        return inputEvaluator.eval(node) && isCheckbox && Dom.hasClass(node, "DataTableCheck") && node.hasAttribute("data-index");
                    }
                }, true);
                if (input) input.setAttribute("data-index", index - 1);
            }

            next = next.nextElementSibling;
        }
        this.items.splice(nodeContext.index, 1);
        nodeContext.row.parentNode.removeChild(nodeContext.row);
    };

    DataTable.prototype._invalidateRow = function(row, rowIndex, data) {
        var cells = row.querySelectorAll(":scope > td");
        for (var i = 0; i < cells.length; i ++) {
            var td = cells[i];
            var column = this.actualColumns[i];
            if (column.canInvalidate && !column.canInvalidate()) continue;

            var wrapper = td.querySelector(":scope > .CellContentWrapper");
            if (!wrapper) continue;

            var cellHtml = column.getCellContentHtml(data, rowIndex, i);
            if (column.getContentTitle) {
                 var text = column.getContentTitle(data, rowIndex, i);
                 wrapper.setAttribute("title", text);
            }

            wrapper.innerHTML = cellHtml;

            if (column.postProcess && column.id) {
                column.postProcess(td, data, rowIndex, i);
            }
        }
    };
    DataTable.prototype.getItemUniqueId = function (item) {
        return item.id;
    };
    DataTable.prototype._setItems = function(items, notify, append) {
        var html = "";
        if (!items) items = [];
        var startIndex = 0;
        if (append) {
            if (this.items) startIndex = this.items.length;
            this.items = (this.items || []).concat(items);
            if (this.items.length == 0) this._sectionCount = 0;
        } else {
            this.items = [].concat(items);
            for (var j = 0; j < this.actualColumns.length; j ++) {
                var column = this.actualColumns[j];

                column._rowSpanCount = 0;
                column._lastGroupKey = null;
                column._lastDOMId = null;
            }

            this._unselectedIds = [];
            this._lastSectionId = null;

            this._sectionCount = 0;
        }

        var postProcessingMap = null;
        var thiz = this;
        for (var i = 0; i < items.length; i ++) {
            var k = startIndex + i;
            var item = items[i];
            var classOfRow = this.getClassOfRow(item);
            var hasLeadingSpan = false;

            var sectionId = this.getSectionId ? this.getSectionId(item) : null;
            var newSection = sectionId != this._lastSectionId;
            this._lastSectionId = sectionId;
            if (newSection) this._sectionCount ++;

            html += "<tr data-index=\"" + k + "\" class=\"" + (k == 0 ? "FirstRow" : (k == items.length - 1 ? "LastRow" : "TableRow")) + (classOfRow.length > 0 ? (" " + classOfRow) : "") + (newSection ? " DTSectionStart" : "") + (this._sectionCount % 2 == 1 ? " DTOddSection" : " DTEvenSection") + "\">";
            for (var j = 0; j < this.actualColumns.length; j ++) {
                if (!this.isColumnVisible(this.actualColumns[j])) continue;
                var column = this.actualColumns[j];

                var groupKey = null;
                var columnRowSpanToken = null;
                var rowspanGenerator = function (row, key, newIds) {
                    return " __rowspan_prefix_" + column.id + "_" + key + "=\"0\" rowspan=\"" + row + "\" data-ids=\"" + newIds + "\"";
                }

                if (column.getGroupKey) {
                    groupKey = column.getGroupKey(item, k, j);
                    if (groupKey == column._lastGroupKey) {
                        if (!column._rowSpanCount) column._rowSpanCount = 1;
                        column._rowSpanCount ++;


                        html = html.replace(new RegExp(" __rowspan_prefix_" + column.id + "_" + groupKey + "=\"0\" rowspan=\"[0-9]+\" data-ids=\"([A-Za-z0-9\\,]+)\"", "g"), function () {
                            var ids = RegExp.$1.split(",");
                            ids.push(thiz.getItemUniqueId(item));
                            return rowspanGenerator(column._rowSpanCount, groupKey, ids.join(","));
                        });

                        //todo replace using dom
                        if (column._lastDOMId) {
                            var td = document.getElementById(column._lastDOMId);
                            if (td) {
                                var dataIdsAttr = td.getAttribute("data-ids");
                                var ids = dataIdsAttr ? dataIdsAttr.split(",") : [];
                                ids.push(thiz.getItemUniqueId(item));
                                td.setAttribute("rowspan", "" + column._rowSpanCount);
                                td.setAttribute("data-ids", ids.join(","));
                            }
                        }

                        hasLeadingSpan = true;

                        continue;
                    }

                    html = html.replace(new RegExp(" __rowspan_prefix_" + column.id + "_" + column._lastGroupKey + "=\0\"", "g"), "");

                    column._rowSpanCount = 1;
                    column._lastGroupKey = groupKey;
                }


                html += "<td data-title=\"" + Dom.htmlEncode(column.title) + "\"";

                if (groupKey) {
                    html += rowspanGenerator(1, groupKey, "" + thiz.getItemUniqueId(item));
                } else {
                    html += " data-ids=\"" + thiz.getItemUniqueId(item) + "\"";
                }

                if (column.getBodyClass || column.id) {
                    var c = column.getBodyClass ? column.getBodyClass(item, k, j) : ("Col_" + column.id);

                    if (hasLeadingSpan) c = (c || "") + " HasLeadingSpan";

                    if (c) {
                        html += " class=\"" + c + "\"";
                    }
                }

                hasLeadingSpan = false;

                if (column._width) {
                    html += " style=\"overflow: hidden;\"";
                }
                if (column.dataType) {
                    html += " data-type=\"" + column.dataType + "\"";
                }

                html += " column-id=\"" + column.id + "\"";
                var cellHtml = column.getCellContentHtml(item, k, j);
                if (column.getContentTitle) {
                     var text = column.getContentTitle(item, k, j);
                     if (text && text.length > 0) {
                         html += " title=\"" + text  +"\"";
                     }
                }

                var uuid = "c" + Util.newUUID();
                html += " id=\"" + uuid + "\"";
                
                if (column.postProcess && column.id) {
                    if (!postProcessingMap) postProcessingMap = {};

                    var columnPostProcessingData = postProcessingMap[column.id];
                    if (!columnPostProcessingData) {
                        columnPostProcessingData = {
                            column: column,
                            cellMap: {}
                        };
                        postProcessingMap[column.id] = columnPostProcessingData;
                    }

                    columnPostProcessingData.cellMap[uuid] = {
                        data: item,
                        row: k,
                        col: j
                    };
                }

                column._lastDOMId = uuid;

                // html += "><div class=\"CellContentWrapper\" style=\"width: " + (column._width - 1) + "px;\">";
                html += "><div class=\"CellContentWrapper\" style=\"width: 100%; box-sizing: border-box;\">";
                html += cellHtml;
                html += "</div></td>"
            }

            html += "</tr>";
        }

        if (navigator.userAgent.match(/MSIE/i)) {
            this.temp.innerHTML = "<table><tbody>" + html + "</tbody></table>";
            var newBody = this.temp.firstChild.firstChild;
            newBody.parentNode.removeChild(newBody);
            this.table.replaceChild(newBody, this.body);
            this.body = newBody;
        } else {
            if (!append) {
                this.body.innerHTML = html;
            } else {
                this.body.insertAdjacentHTML("beforeend", html);
            }
        }

        if (postProcessingMap) {
            for (var columnId in postProcessingMap) {
                var columnPostProcessingData = postProcessingMap[columnId];
                for (var uuid in columnPostProcessingData.cellMap) {
                    var td = document.getElementById(uuid);
                    if (!td) continue;
                    var cellMapData = columnPostProcessingData.cellMap[uuid];
                    columnPostProcessingData.column.postProcess(td, cellMapData.data, cellMapData.row, cellMapData.col);
                }
            }

            postProcessingMap = null;
        }

        this.selectCurrentPageItems(this.isSelectAll(), startIndex);

        if (this.leftOverflowIndicator) {
            this.leftOverflowIndicator.style.height = this.table.offsetHeight + "px";
        }
        if (this.rightOverflowIndicator) {
            this.rightOverflowIndicator.style.height = this.table.offsetHeight + "px";
        }
        
        var scrollPane = this._findScrollPane();
        
        if (scrollPane && scrollPane.offsetHeight < this.node().offsetHeight) {
            this.invalidateSizing();
        }

        if (this._detectedShrinkDelta == undefined) {
            var thiz = this;
            window.setTimeout(function () {
                var width = thiz._calculateContainerWidth();
                if (width < thiz.lastContainerWidth) {
                    thiz._detectedShrinkDelta = thiz.lastContainerWidth - width;
                }
            }, 100);
        }

        //this.table.style.height = "auto";
        this.invalidateOverflowIndicators();
        // if (this.lastCalculatedPageSize && this.items.length == this.lastCalculatedPageSize) {
        //     var padding = 0;
        //     if (Dom.getOffsetWidth(this.table) > Dom.getOffsetWidth(this.container)) {
        //         padding = Dom.calculateSystemScrollbarSize().h;
        //     }
        //     this.table.style.height = (Dom.getOffsetHeight(this.container) - padding) + "px";
        // } else {
        //     this.table.style.height = "auto";
        // }
        //this.invalidateOverflowIndicators();

        this.fireSelectionChangedEvent(false);
        window.setTimeout(function () {
            thiz._updateFakeHorizontalScroll();
        }, 200);

        if (this.onItemsChanged && notify) {
            this.onItemsChanged(this.items);
        }
    }
    DataTable.prototype.setItems = function (items, dontNotify) {
        this._setItems(items, dontNotify ? false : true);
    };
    DataTable.prototype.getItems = function () {
        return this.items;
    };
    DataTable.prototype.onItemsChanged = function(items) {
        if (this.itemsChangedListener) {
            this.itemsChangedListener(items);
            //console.log("Notify", items);
        }
    }
    DataTable.prototype.setItemsChangedListener = function(listener) {
        this.itemsChangedListener = listener;
        return this;
    }
    DataTable.prototype.getSelectedItems = function () {
        var selectedItems = [];
        var thiz = this;
        Dom.doOnChildRecursively(this.table, {
            eval: function (n) {
                return Dom.hasClass(n, "DataTableCheck") && Dom.hasClass(n, "Item") && n.checked;
            }
        }, function (c) {
            var index = parseInt(c.getAttribute("data-index"), 10);
            selectedItems.push(thiz.items[index]);
        })

        return selectedItems;
    }

    ///// IOrderDisplay interface
    DataTable.prototype.setOrder = function (order) {
        for (var i = 0; i < this.actualColumns.length; i ++) {
            var column = this.actualColumns[i];
            var th = document.getElementById(column.columnId);
            if (!th) continue;
            Dom.removeClass(th, "DescSort");
            Dom.removeClass(th, "AscSort");
            Dom.removeClass(th, "BothSort");

            if (order && order.propertyName == column.propertyName) {
                Dom.addClass(th, order.asc ? "AscSort" : "DescSort");
            }
        }
        this.currentOrder = order;
    };
    DataTable.prototype.getOrder = function () {
        return this.currentOrder;
    };

    DataTable.prototype.addOrderRequestListener = function (listener) {
        this.orderRequestListeners.push(listener);
    };
    DataTable.prototype.addColumnSettingListener = function (listener) {
        this.columnSettingListeners.push(listener);
    };
    DataTable.prototype.addListener = function (listener) {
        this.listeners.push(listener);
    };

    // ServiceFactory busy-indicator interface implementation
    DataTable.prototype.busy = function (message) {
        if (!this._busyCount) this._busyCount = 0;
        this._busyCount ++;

        Dom.addClass(this.node(), "Busy");
        // Dom.setInnerText(this.loadingMessage, message || "Please wait...");
    };
    DataTable.prototype.done = function () {
        if (typeof this._busyCount == "number" && this._busyCount > 0) this._busyCount --;

        if (this._busyCount == 0) {
            Dom.removeClass(this.node(), "Busy");
            // Dom.setInnerText(this.loadingMessage, "");
        }
    };

    DataTable.findInstance = function (event) {
        var target = Dom.getTarget(event);
        return DataTable.findInstanceFromNode(target);
    }
    DataTable.findInstanceFromNode = function (target) {
        var table = Dom.findUpward(target, {
            eval: function (n) {
                return n._dt;
            }
        });

        if (!table) return null;

        return table._dt;
    };
    DataTable.getRowData = function (node) {
        var nodeContext = DataTable._getNodeContext(node);
        if (!nodeContext) return null;

        return nodeContext.data;
    }
    DataTable._getNodeContext = function (node) {
        var dataTable = DataTable.findInstanceFromNode(node);
        if (!dataTable) return null;

        var row = Dom.findUpward(node, {
            eval: function (n) {
                return n.getAttribute && n.getAttribute("data-index");
            }
        });

        if (!row) return null;

        var index = parseInt(row.getAttribute("data-index"), 10);
        var data = dataTable.items[index];

        return {
            instance: dataTable,
            index: index,
            row: row,
            data: data
        };
    };

    DataTable.prototype.createActionColumnHandler = function () {
        var thiz = this;

        if (!this._rowActionMap) this._rowActionMap = {};
        if (!this._rowActionEventHandler) {
            this._rowActionEventHandler = function (e) {
                var button = Dom.findParentWithAttribute(e.target, "data-action-uuid");
                if (!button) return;

                var uuid = button.getAttribute("data-action-uuid");
                if (!uuid) return;
                var action = thiz._rowActionMap[uuid];
                if (!action) return;

                var data = DataTable.getRowData(e.target);
                if (!data) return;

                if (action.applicable && !action.applicable(data)) return;
                action.run(data, function (newData, modified) {

                }, e);
            };

            this.node().addEventListener("click", this._rowActionEventHandler, false);
        }
        var actions = [];
        for (var i = 0; i < arguments.length; i ++ ) {
            var arg = arguments[i];
            if (typeof(arg.run) == "function") {
                arg.uuid = Util.newUUID();
                this._rowActionMap[arg.uuid] = arg;
                actions.push(arg);
            }
        }

        return function ActionColumnHandler(data, value) {
            return {
                _name: "hbox",
                "class": "DataViewActionContainer",
                _children: actions.map(function (action) {
                    var spec = null;
                    if (typeof(action.spec) == "function") {
                        spec = action.spec(data, value);
                    } else {
                        spec = {
                            _name: "button",
                            autocomplete: "off",
                            title: action.title || action.label || "",
                            "class": "ActionButton" + (action.icon && !action.label ? " IconOnly" : ""),
                            "action-role": action.role || "normal",
                            _children: [
                                (action.icon ? {_name: "icon", "class": action.icon} : undefined),
                                (action.label ? {_name: "span", _text: action.label} : undefined)
                            ]
                        };

                        if (action.applicable && !action.applicable(data)) {
                            spec.disabled = "true";
                        }
                    }

                    spec["data-action-uuid"] = action.uuid;
                    return spec;
                })
            }
        };
    };


    DataTable.SelectorColumn = SelectorColumn;
    DataTable.ActionColumn = ActionColumn;

    function BaseColumn() {
        this.dataType = "text";
    }
    BaseColumn.prototype.sortable = function (propertyName) {
        this.propertyName = propertyName;
        return this;
    };
    BaseColumn.prototype.hiddenByDefault = function () {
        this.defaultHidden = true;
        return this;
    };
    BaseColumn.prototype.getContentTitle = function (data, row, col) {
        return "";
    };
    BaseColumn.prototype.width = function (w, minWidth) {
        this.preferredWidth = "" + w;
        if (minWidth) this.minWidth = minWidth;
        return this;
    };
    BaseColumn.prototype.setSizing = function (sizing) {
        this.sizingPolicy = sizing;
        return this;
    };
    BaseColumn.prototype.generateId = function (text) {
        this.id = text.replace(/[^a-z0-9]+/gi, "_").toLowerCase();
    };
    BaseColumn.prototype.getTitleInfo = function () {
        return this.title ? this.title : "";
    };
    BaseColumn.prototype.type = function (type) {
        this.dataType = type;
        return this;
    };
    BaseColumn.prototype.isUnremovable = function () {
        this.unremovable = true;
        return this;
    };
    BaseColumn.prototype.withPDFRenderer = function (pdfRenderer) {
        this.pdfRenderer = pdfRenderer;
        return this;
    };

    DataTable.BaseColumn = BaseColumn;

    DataTable.PlainTextColumn = function (title, getter, clazz) {
        this.title = title;
        this.headerClass = clazz;
        this.getter = getter;
        this.generateId(title);
    };
    DataTable.PlainTextColumn.prototype = new BaseColumn();
    DataTable.PlainTextColumn.prototype.getTitleContentHtml = function () {
        return !this.useHtmlTitle() ? Dom.htmlEncode(this.title) : this.title;
    };
    DataTable.PlainTextColumn.prototype.useHtmlTitle = function() {
        return false;
    }
    DataTable.PlainTextColumn.prototype.getContentTitle = function (data, row, col) {
        return Dom.attrEncode(this.getter(data, row, col));
    };
    DataTable.PlainTextColumn.prototype.getCellContentHtml = function (data, row, col) {
        return Dom.htmlEncode(this.getter(data, row, col));
    };

    DataTable.GenericColumn = function (title, renderer, clazz) {
        this.title = title;
        this.headerClass = clazz;
        this.renderer = renderer;
        this.generateId(title);
    };
    DataTable.GenericColumn.prototype = new BaseColumn();
    DataTable.GenericColumn.prototype.useHtmlTitle = function() {
        return false;
    }
    DataTable.GenericColumn.prototype.getTitleContentHtml = function () {
        return !this.useHtmlTitle() ? Dom.htmlEncode(this.title) : this.title;
    };
    DataTable.GenericColumn.prototype.getContentTitle = function (data, row, col) {
        return Dom.htmlEncode(this.renderer(data, row, col));
    };
    DataTable.GenericColumn.prototype.getCellContentHtml = function (data, row, col) {
        return this.renderer(data, row, col);
    };

    DataTable.GenericDomColumn = function (title, renderer, clazz) {
        this.title = title;
        this.headerClass = clazz;
        this.renderer = renderer;
        this.generateId(title);
    };
    DataTable.GenericDomColumn.prototype = new DataTable.GenericColumn("");
    DataTable.GenericDomColumn.prototype.getContentTitle = function (data, row, col) {
        return "";
    };
    DataTable.GenericDomColumn.prototype.getCellContentHtml = function (data, row, col) {
        var html = this._renderDom(data, row, col);
        return html;
    };
    DataTable.GenericDomColumn.prototype._renderDom = function (data, row, col) {
        var spec = this.renderer(data, row, col);
        if (!spec) return "";

        if (typeof(spec) == "string") return spec;

        var node = null;
        if (spec.getAttribute && spec.nodeType == Node.ELEMENT_NODE) {
            node = spec;
        } else {
            if (typeof(spec) == "array") {
                node = Dom.newDOMFragment(spec);
            } else if (typeof(spec) == "object") {
                node = Dom.newDOMElement(spec);
            }
        }

        if (!this._div) this._div = document.createElement("div");
        this._div.innerHTML = "";
        this._div.appendChild(node);

        return this._div.innerHTML;
    };

    DataTable.DomNodeColumn = function (title, renderer, clazz) {
        this.title = title;
        this.headerClass = clazz;
        this.renderer = renderer;
        this.generateId(title);
    };
    DataTable.DomNodeColumn.prototype = new DataTable.GenericColumn("");
    DataTable.DomNodeColumn.prototype.getContentTitle = function (data, row, col) {
        return "";
    };
    DataTable.DomNodeColumn.CLASS_NAME = "DomNodeColumn_Container";
    DataTable.DomNodeColumn.prototype.getCellContentHtml = function (data, row, col) {
        var html = "<div class=\"" + DataTable.DomNodeColumn.CLASS_NAME + "\"></div>";
        return html;
    };
    DataTable.DomNodeColumn.prototype._renderDom = function (data, row, col, container) {
        var spec = this.renderer(data, row, col, container);
        if (!spec) return null;

        if (spec.getAttribute && spec.nodeType == Node.ELEMENT_NODE) {
            return spec;
        } else {
            if (typeof(spec) == "object") {
                if (typeof(spec.slice) == "function") {
                    return Dom.newDOMFragment(spec);
                } else {
                    return Dom.newDOMElement(spec);
                }
            }
        }

        throw new Error("Invalid DOM: " + spec);
    };

    DataTable.DomNodeColumn.prototype.postProcess = function (cell, data, row, col) {
        var container = cell.querySelector("." + DataTable.DomNodeColumn.CLASS_NAME);
        container.innerHTML = "";
        container.appendChild(this._renderDom(data, row, col, cell));
    };


    DataTable.LinkColumn = function (title, linkContentBuilder, linkHrefBuider, clazz) {
        this.title = title;
        this.headerClass = clazz;
        this.linkContentBuilder = linkContentBuilder;
        this.linkHrefBuider = linkHrefBuider;
        this.generateId(title);
    };
    DataTable.LinkColumn.prototype = new BaseColumn();
    DataTable.LinkColumn.prototype.getTitleContentHtml = function () {
        return Dom.htmlEncode(this.title);
    };
    DataTable.LinkColumn.prototype.getCellContentHtml = function (data, row, col) {
        var href = this.linkHrefBuider(data, row, col);
        var content = Dom.htmlEncode(this.linkContentBuilder(data, row, col));
        return "<a href=\"" + href + "\" target=\"_blank\">" + content + "</a>";
    };
    DataTable.LinkColumn.prototype.getContentTitle = function (data, row, col) {
       var content = Dom.htmlEncode(this.linkContentBuilder(data, row, col));
       return content;
    };

    DataTable.Action = function (title, type, handler, applicable) {
        this.title = title;
        this.type = type;
        this.handler = handler;
        this.isApplicable = applicable;
        this.id = widget.random();
    };



    return DataTable;
}();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/Paginator.js";

var Paginator = function () {
    function paginatorClickHandler(event) {
        var target = Dom.getTarget(event);
        var node = Dom.findUpward(target, {
            eval: function (n) {
                return n.getAttribute && n.getAttribute("role") != null;
            }
        });

        if (!node) return;
        var role = node.getAttribute("role");

        var list = Dom.findUpward(target, {
            eval: function (n) {
                return n._p;
            }
        });

        if (!list) return;
        var paginator = list._p;

        Dom.cancelEvent(event);

        if (role == "prev" && paginator.currentPage > 0) {
            paginator.gotoPage(paginator.currentPage - 1);
        } else if (role == "next" && paginator.currentPage < paginator.totalPages - 1) {
            paginator.gotoPage(paginator.currentPage + 1);
        } else {
            try {
                var n = parseInt(role, 10);
                if (!isNaN(n) && n >= 0 && n < paginator.totalPages) {
                    paginator.gotoPage(n);
                }
            } catch (e) {}
        }
    }

    function Paginator() {
        BaseWidget.call(this);
        this.container = this.node();
        this.renderer = null;
        this.source = null;
        this.pageSize = 40;
        this.currentPage = 0;
        this.totalPages = 0;
        this.firstRender = true;

        this.selectedItems = [];
        this.lastPageSizeCalculationAt = 0;
    }
    __extend(BaseWidget, Paginator);

    Paginator.prototype.setup = function (options) {
        this.options = options ? options : null;
        this.comparer = (options && options.comparer) ? options.comparer : function (a, b) {
            return a.id == b.id;
        };
    };
    Paginator.prototype.control = function (renderer) {
        this.renderer = renderer;
        this.renderer.withItemComparer(this.comparer);

        if (this.renderer.addOrderRequestListener) {
            this.renderer.addOrderRequestListener(this);
        }

        var thiz = this;

        if (this.renderer.addListener) {
            this.renderer.addListener({
                onSelectionChanged: function (table, fromUserAction) {
                    thiz.onRendererSelectionChanged(table, fromUserAction);
                    thiz.renderer.invalidateSelectionInfo(thiz);
                },
                onSelectNoneAction: function () {
                    thiz.clearSelection();
                },
                onSizeChanged: function () {
                    thiz.onRendererSizeChanged();
                }
            });
        }

        var showPaginator = this.options != null && this.options.showPaginator ? true : false;

        if (showPaginator) {
            if (this.renderer.markedAsPaginated) this.renderer.markedAsPaginated(true);
            return;
        }
        //console.log("add load more event " + showPaginator);
        Dom.registerEvent(this.renderer.container, "scroll", function(e){
            var position = this.scrollTop + this.offsetHeight;
            var percent = position / this.scrollHeight * 100;
            //console.log(percent);
            if (percent >= 75) {
                thiz.loadMore();
            }
        });
    };
    Paginator.prototype.clearSelection = function () {
        this.selectedItems = [];
        this.renderer.invalidateSelectionInfo(this);
        this.fireSelectionChangedEvent();
    };

    Paginator.prototype.loadMore = function() {
    	//console.log("load");
    	var thiz = this;
    	this.currentPage++;
    	this.source.loadPage(this.currentPage, this.pageSize, function (results, totalItems) {
    		if (thiz.pageSize < results.length) {
                thiz.renderer.addItems(results.slice(0, thiz.pageSize));
            } else {
                thiz.renderer.addItems(results);
            }
    	});
    };

    Paginator.prototype.onRendererSelectionChanged = function (table, fromUserAction) {
        if (!fromUserAction) return;

        if (this.renderer.isSelectAll()) {
            this.selectedItems = [];
        } else {
            var items = this.renderer.getSelectedItems();
            var all = this.renderer.items;

            if (!all) return;

            var newSelectedItems = [];
            for (var i = 0; i < this.selectedItems.length; i ++) {
                var item = this.selectedItems[i];
                if (!Util.contains(all, item, this.comparer) || Util.contains(items, item, this.comparer)) {
                    newSelectedItems.push(item);
                }
            }
            for (var i = 0; i < items.length; i ++) {
                var item = items[i];
                if (!Util.contains(this.selectedItems, item, this.comparer)) {
                    newSelectedItems.push(item);
                }
            }

            this.selectedItems = newSelectedItems;
        }

        this.fireSelectionChangedEvent();
    };

    Paginator.prototype.fireSelectionChangedEvent = function (fromUserAction) {
        if (this.onSelectionChanged) this.onSelectionChanged(this, fromUserAction);
    };

    Paginator.prototype.changeOrder = function (order) {
        if (!this.source || !this.source.setOrder) return;
        this.source.setOrder(order);
        this.gotoPage(this.currentPage);
    };
    Paginator.prototype.onRendererSizeChanged = function () {
        if (this.options && this.options.avoidPageSizeRecalculation) return;
        if (this.firstRender) return;

        var now = new Date().getTime();

        if (now - this.lastPageSizeCalculationAt < 1000) return;

        var thiz = this;
        var calculatePageSize = this.renderer.calculatePreferredPageSize && this.renderer.getItems;
        if (!calculatePageSize) return;
        var items = this.renderer.getItems();

        var currentIndex = this.currentPage * this.pageSize;
        thiz.lastPageSizeCalculationAt = now;
        thiz.renderer.calculatePreferredPageSize(items, function (preferredPageSize) {
            if (!isNaN(preferredPageSize) && preferredPageSize > 0 && preferredPageSize != thiz.pageSize) {
                var newPageIndex = Math.floor(currentIndex / preferredPageSize);
                thiz.pageSize = preferredPageSize;
                thiz.gotoPage(newPageIndex);
            } else {
                thiz.renderer.setItems(items);
            }
        });

    };

    Paginator.prototype.gotoPage = function (pageIndex, silent) {
        var thiz = this;
        //this.renderer.setItems([], true);
        if (this.renderer.showBusy && !silent) this.renderer.showBusy(true);
        var lastUsedPageSize = this.pageSize;
        if (thiz.options && thiz.options.onPageStartLoading) {
            thiz.options.onPageStartLoading(pageIndex);
        }
        this.source.loadPage(pageIndex, this.pageSize, function (results, totalItems) {
            var showPaginator = thiz.options != null && thiz.options.showPaginator;
            var calculatePageSize = thiz.needCalculatePageSize() && showPaginator && pageIndex == 0 && totalItems > 0 && thiz.firstRender && thiz.renderer.calculatePreferredPageSize;

            if (thiz.selectedItems && thiz.selectedItems.length > 0 && results && results.length > 0) {
                var updatedItems = [];
                for (var i = 0; i < thiz.selectedItems.length; i ++) {
                    var item = thiz.selectedItems[i];
                    var other = find(results, function (a) {
                        return thiz.comparer(a, item);
                    });

                    updatedItems.push(other ? other : item);
                }

                thiz.selectedItems = updatedItems;
            }

            var count = results.length;

            var postRenderRunnable = function () {
                if (!thiz.renderer.isSelectAll()) {
                    thiz.renderer.selectItems(thiz.selectedItems);
                }

                if (thiz.source.getOrder && thiz.renderer.setOrder) {
                    thiz.renderer.setOrder(thiz.source.getOrder());
                }

                //calculate pages
                thiz.totalPages = Math.ceil(totalItems / thiz.pageSize);
                thiz.currentPage = pageIndex;
                thiz.totalItems = totalItems;

                if (thiz.options && thiz.options.onPageLoaded) {
                    thiz.options.onPageLoaded(thiz, count);
                }

                if (showPaginator) {
                	thiz._updateUI();
                } else {
                	thiz.container.innerHTML = "";
                	thiz.invalidateRendererHeight();
                }

                thiz.renderer.multiPages = thiz.totalPages > 1;
                thiz.renderer.totalItems = thiz.totalItems;
                if (thiz.renderer.showBusy && !silent) thiz.renderer.showBusy(false);

            }

            thiz.firstRender = false;

            if (calculatePageSize) { //perform calculation
                thiz.lastPageSizeCalculationAt = new Date().getTime();
                thiz.renderer.calculatePreferredPageSize(results, function (preferredPageSize) {
                    if (!isNaN(preferredPageSize) && preferredPageSize > 0) thiz.pageSize = preferredPageSize;

                    if (thiz.pageSize > lastUsedPageSize) {
                        if (thiz.renderer.showBusy && !silent) thiz.renderer.showBusy(false);
                        thiz.gotoPage(0, silent);
                        return;
                    }

                    var subList = results.slice(0, thiz.pageSize);
                    thiz.renderer.setItems(subList);
                    count = subList.length;

                    postRenderRunnable();
                });
            } else {
                thiz.renderer.setItems(results);
                postRenderRunnable();
            }
        }, function (error) {
            if (thiz.renderer.showBusy && !silent) thiz.renderer.showBusy(false);
            if (thiz.options && thiz.options.onPageLoadFailed) {
                thiz.options.onPageLoadFailed(pageIndex);
            }
        });
    };

    Paginator.prototype.invalidateRendererHeight = function() {
    	if (this.renderer == null) return;

    	var calculatedHeight = this.renderer.getCalculatedHeight();

    	this.renderer.setHeight(calculatedHeight);
    }
    Paginator.prototype.needCalculatePageSize = function() {
        return true;
    }
    Paginator.prototype.setSource = function (source) {
        this.source = source;
        this._allItems = null;
        this.selectedItems = [];
        this.firstRender = true;
        if (this.renderer) {
            if (this.renderer.reset) this.renderer.reset();
            this.gotoPage(0);
        }
    };

    Paginator.prototype.refresh = function (withIndicator) {
        if (!this.source) return;
        this._allItems = null;
        this.gotoPage(this.currentPage, withIndicator ? null : "silent");
    };

    Paginator.prototype.reInit = function () {
        if (this.firstRender) {
        	this.invalidateRendererHeight();
        	this.renderer.invalidateSizing();
        	return;
        }

    	this.firstRender = true;
        //this.renderer.setItems([]);

        this.gotoPage(0, "silent");
    };

    Paginator.THRESHOLD = 2;
    Paginator.PADDING = 2;
    Paginator.prototype._generateLIs = function (from, to, enableDot) {
        var count = to - from + 1;
        if (enableDot && count - 2 * Paginator.PADDING > Paginator.THRESHOLD) {
            var html = this._generateLIs(from, from + Paginator.PADDING, false);
            html += "<li><a>...</a></li>"; //dot
            html += this._generateLIs(to - Paginator.PADDING, to, false);
            return html;
        } else {
            var html = "";
            for (var i = Math.max(0, from); i < Math.min(to, this.totalPages); i ++) {
                html += "<li";
                if (i == this.currentPage) {
                    html += " class=\"active\"";
                }
                html += "><a href=\"#\" role=\"" + i + "\">" + (i + 1) + "</a></li>";
            }

            return html;
        }
    };
    Paginator.prototype._generateButtons = function (from, to, enableDot) {
        var count = to - from + 1;
        if (enableDot && count - 2 * Paginator.PADDING > Paginator.THRESHOLD) {
            var html = this._generateButtons(from, from + Paginator.PADDING, false);
            html += "<button type=\"button\"><span>...</span></button>"; //dot
            html += this._generateButtons(to - Paginator.PADDING, to, false);
            return html;
        } else {
            var html = "";
            for (var i = Math.max(0, from); i < Math.min(to, this.totalPages); i ++) {
                html += "<button type=\"button\" role=\"" + i + "\"";
                if (i == this.currentPage) {
                    html += " class=\"active\"";
                }
                html += "><span>" + (i + 1) + "</span></button>";
            }

            return html;
        }
    };
    Paginator.prototype._updateUI = function () {
        if (this.options.useButtons) {
            this._updateButtonUI();
            return;
        }
        var id = widget.random();
        var html = "";

        if (this.options && this.options.withoutStatus) {
            html = "<div class=\"ResultInfo\">" +
            "<div>" +
            "<ul class=\"pagination\" id=\"" + id + "\">";
        } else {
            html = "<div class=\"ResultInfo row\"><div><p class=\"Status\">" + (this.options && this.options.getTotalItemText ? this.options.getTotalItemText(this.totalItems) : "") + "</p></div>" +
            "<div>" +
            "<ul class=\"pagination\" id=\"" + id + "\">";
        }

        html += "<li";
        if (this.currentPage == 0) {
            html += " class=\"disabled\"";
        }

        html += "><a href=\"#\" role=\"prev\">&laquo;</a></li>";

        html += this._generateLIs(0, this.currentPage, true);
        html += this._generateLIs(this.currentPage, this.totalPages, true);

        html += "<li";
        if (this.currentPage == this.totalPages - 1) {
            html += " class=\"disabled\"";
        }

        html += "><a href=\"#\" role=\"next\">&raquo;</a></li>";
        html += "</ul></div></div>";
        this.container.innerHTML = html;
        this.list = document.getElementById(id);
        this.list._p = this;
        Dom.registerEvent(this.list, "click", paginatorClickHandler, false);
    };
    Paginator.prototype._updateButtonUI = function () {
        var id = widget.random();
        var html = "";

        html += "<div class=\"pagination\" id=\"" + id + "\"><div class=\"ButtonGroup\">";

        html += "<button type=\"button\" role=\"prev\"";
        if (this.currentPage == 0) {
            html += " disabled=\"true\"";
        }

        html += "><span>&#171;</span></button>";

        html += this._generateButtons(0, this.currentPage, true);
        html += this._generateButtons(this.currentPage, this.totalPages, true);

        html += "<button type=\"button\" role=\"next\"";
        if (this.currentPage == this.totalPages - 1) {
            html += " disabled=\"true\"";
        }

        html += "><span role=\"next\">&#187;</span></button>";
        html += "</div></div>";

        this.container.innerHTML = html;
        this.list = document.getElementById(id);
        this.list._p = this;
        Dom.registerEvent(this.list, "click", paginatorClickHandler, false);
    };
    Paginator.prototype.getSelectionCount = function () {
        if (!this.renderer) return 0;
        if (!this.renderer.isSelectAll()) {
            return this.selectedItems.length;
        } else {
            return this.totalItems;
        }
    };
    Paginator.prototype.getSelectedItems = function (callback, forceSelectAll) {
    	if (!callback) {
    		return this.selectedItems;
    	}
        if ((typeof(forceSelectAll) == "undefined" || forceSelectAll == null) && !this.renderer.isSelectAll()) {
            callback(this.selectedItems);
        } else {
            if (this.source == null) {
                callback([]);
                return;
            }
            if (this._allItems && !this.renderer._getExcludedItemCounts) {

                callback(this._allItems);
                return;
            }
            var total = this.totalItems;
            var chunk = 100;
            var items = [];
            var thiz = this;
            var index = 0;
            var next = function () {
                thiz.source.loadPage(index, chunk, function (results, totalItems) {
                    var excludedCount = 0;
                    for (var i = 0; i < results.length; i ++) {
                        if (thiz.renderer._getExcludedItemCounts && thiz.renderer._getExcludedItemCounts() > 0) {
                            if (thiz.renderer.isIdUnselected(results[i].id)) {
                                excludedCount ++;
                                continue;
                            }
                        }
                        
                        items.push(results[i]);
                    }
                    total = totalItems - excludedCount;
                    index ++;
                    if (items.length < total && results.length > 0) {
                        next();
                    } else {
                        items = items.filter(function (data) {
                            return !thiz.renderer.selectable || thiz.renderer.selectable(data);
                        });
                        defaultIndicator.done();
                        //console.log("Done loading " + items.length + " items.");
                        thiz._allItems = items;
                        callback(items);
                    }
                }, function (error) {
                    console.error(error);
                    defaultIndicator.done();
                });
            };
            defaultIndicator.busy("Fetching data list...");
            next();
        }
    };


    return Paginator;
}();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/InfiniteScrollPaginator.js";

var InfiniteScrollPaginator = function () {
    function InfiniteScrollPaginator() {
        this.renderer = null;
        this.source = null;
        this.pageSize = 40;
        this.lastLoadedIndex = -1;
        this.totalPages = 0;
        this.firstRender = true;

        this.selectedItems = [];
    }

    InfiniteScrollPaginator.prototype.setup = function (options) {
        this.options = options ? options : null;
        this.comparer = (options && options.comparer) ? options.comparer : function (a, b) {
            return a.id == b.id;
        };
    };
    InfiniteScrollPaginator.prototype.control = function (renderer) {
        if (!renderer.appendItems || !renderer.addListener) throw new Error("Renderer must support .appendItems() and .addListener()");
        this.renderer = renderer;
        this.renderer.withItemComparer(this.comparer);

        if (this.renderer.addOrderRequestListener) {
            this.renderer.addOrderRequestListener(this);
        }

        var thiz = this;

        var listener = {
            onSelectionChanged: function (table, fromUserAction) {
                thiz.onRendererSelectionChanged(table, fromUserAction);
                thiz.renderer.invalidateSelectionInfo(thiz);
            },
            onSelectNoneAction: function () {
                thiz.clearSelection();
            },
            onSizeChanged: function () {
                thiz.onRendererSizeChanged();
            },
            onVerticalScrolled: function (dy) {
                thiz.handleRendererInfiniteScrollDown(dy);
            }
        };

        this.renderer.addListener(listener);

        // var showInfiniteScrollPaginator = this.options != null && this.options.showInfiniteScrollPaginator ? true : false;
        //
        // if (showInfiniteScrollPaginator) {
        //     if (this.renderer.markedAsPaginated) this.renderer.markedAsPaginated(true);
        //     return;
        // }
        //console.log("add load more event " + showInfiniteScrollPaginator);
        // Dom.registerEvent(this.renderer.container, "scroll", function(e){
        //     var position = this.scrollTop + this.offsetHeight;
        //     var percent = position / this.scrollHeight * 100;
        //     //console.log(percent);
        //     if (percent >= 75) {
        //         thiz.loadMore();
        //     }
        // });
    };
    InfiniteScrollPaginator.prototype.clearSelection = function () {
        this.selectedItems = [];
        this.renderer.invalidateSelectionInfo(this);
        this.fireSelectionChangedEvent();
    };

    // InfiniteScrollPaginator.prototype.loadMore = function() {
    //     //console.log("load");
    //     var thiz = this;
    //     this.currentPage++;
    //     this.source.loadPage(this.currentPage, this.pageSize, function (results, totalItems) {
    //         if (thiz.pageSize < results.length) {
    //             thiz.renderer.addItems(results.slice(0, thiz.pageSize));
    //         } else {
    //             thiz.renderer.addItems(results);
    //         }
    //     });
    // };

    InfiniteScrollPaginator.prototype.onRendererSelectionChanged = function (table, fromUserAction) {
        if (!fromUserAction) return;

        if (this.renderer.isSelectAll()) {
            this.selectedItems = [];
        } else {
            var items = this.renderer.getSelectedItems();
            var all = this.renderer.items;

            if (!all) return;

            var newSelectedItems = [];
            for (var i = 0; i < this.selectedItems.length; i ++) {
                var item = this.selectedItems[i];
                if (!Util.contains(all, item, this.comparer) || Util.contains(items, item, this.comparer)) {
                    newSelectedItems.push(item);
                }
            }
            for (var i = 0; i < items.length; i ++) {
                var item = items[i];
                if (!Util.contains(this.selectedItems, item, this.comparer)) {
                    newSelectedItems.push(item);
                }
            }

            this.selectedItems = newSelectedItems;
        }

        this.fireSelectionChangedEvent();
    };

    InfiniteScrollPaginator.prototype.fireSelectionChangedEvent = function (fromUserAction) {
        if (this.onSelectionChanged) this.onSelectionChanged(this, fromUserAction);
    };

    InfiniteScrollPaginator.prototype.changeOrder = function (order) {
        if (!this.source || !this.source.setOrder) return;
        this.source.setOrder(order);
        this._reloadFromStart();
    };
    InfiniteScrollPaginator.prototype.onRendererSizeChanged = function () {
    };

    InfiniteScrollPaginator.prototype._loadMore = function () {
        if (this.loadingInprogress) return;
        var thiz = this;
        this.loadingInprogress = true;
        this.renderer.markAppending(true);


        var count = 4;
        var load = function () {
            thiz._loadNextPage(function (successful) {
                if (!thiz._shouldLoadMore() || !thiz._isMoreItemsAvailable() || --count <= 0) {
                    thiz.loadingInprogress = false;
                    thiz.renderer.markAppending(false);
                    return;
                }

                load();
            });
        };

        load();
    };
    InfiniteScrollPaginator.prototype._createResultHandler = function (index, callback) {
        var thiz = this;
        return {
            onSuccess: function (results, totalItems) {
                if (this._destroyed) return;
                try {
                    thiz.renderer.appendItems(results);
                } finally {
                    thiz.total = totalItems;
                    thiz.totalItems = totalItems;
                    thiz.lastLoadedIndex = index;
                    thiz.currentPage = index;
                }

                try {
                    if (thiz.options && thiz.options.onPageLoaded) {
                        thiz.options.onPageLoaded(thiz, results.length);
                    }
                } catch (e) {
                    console.error(e);
                }

                if (thiz.source.getOrder && thiz.renderer.setOrder) {
                    thiz.renderer.setOrder(thiz.source.getOrder());
                }

                callback(true);
            },
            onFailure: function () {
                if (this._destroyed) return;
                try {
                    if (thiz.options && thiz.options.onPageLoadFailed) {
                        thiz.options.onPageLoadFailed(index);
                    }
                } catch (e) {
                    console.error(e);
                }

                callback(false);
            },
            destroy: function () {
                this._destroyed = true;
            }
        };
    };

    InfiniteScrollPaginator.prototype._loadNextPage = function (callback) {
        var index = this.lastLoadedIndex + 1;
        var thiz = this;

        if (thiz.options && thiz.options.onPageStartLoading) {
            thiz.options.onPageStartLoading(index);
        }

        if (this._resultHandler) {
            this._resultHandler.destroy();
        }

        this._resultHandler = this._createResultHandler(index, callback);

        this.source.loadPage(index, this.pageSize, this._resultHandler.onSuccess, this._resultHandler.onFailure);
    };

    InfiniteScrollPaginator.prototype._shouldLoadMore = function () {
        if (!this.source) return false;

        var now = new Date().getTime();
        if (this.renderer.isNearEnd()) {
            if (!this._isMoreItemsAvailable()) {
                if (!this.forceReloadIfAged) return false;

                var lastCheck = this.lastLoadMoreCheck || 0;
                if (now - lastCheck < 10000) return false;

                this.lastLoadMoreCheck = now;
            } else {
                this.lastLoadMoreCheck = 0;
            }

            return true;
        }
        return false;
    };
    InfiniteScrollPaginator.prototype._isMoreItemsAvailable = function () {
        return this.lastLoadedIndex < 0 || ((this.lastLoadedIndex + 1) * this.pageSize < this.total);
    };

    InfiniteScrollPaginator.prototype._reloadFromStart = function () {
        this.lastLoadedIndex = -1;
        this.firstRender = true;
        if (this.renderer) {
            if (this.renderer.reset) this.renderer.reset();
            this.renderer.setItems([], true);
            this._loadMore();
        }
    };

    InfiniteScrollPaginator.prototype.setSource = function (source) {
        this.source = source;
        this._allItems = null;
        this.selectedItems = [];
        this._reloadFromStart();
    };

    InfiniteScrollPaginator.prototype.refresh = function (withIndicator) {
        if (!this.source) return;
        this._allItems = null;
        this._reloadFromStart();
    };

    InfiniteScrollPaginator.prototype.reInit = function () {
        if (this.firstRender) {
            this.invalidateRendererHeight();
            this.renderer.invalidateSizing();
            return;
        }

        this._reloadFromStart();
    };
    InfiniteScrollPaginator.prototype.getSelectedItemsChunkSize = function() {
        return 100;
    }
    InfiniteScrollPaginator.prototype.getSelectionCount = function () {
        if (!this.renderer) return 0;
        if (!this.renderer.isSelectAll()) {
            return this.selectedItems.length;
        } else {
            return this.totalItems - (this.renderer._getExcludedItemCounts ? this.renderer._getExcludedItemCounts() : 0);
        }
    };
    InfiniteScrollPaginator.prototype.getSelectedItems = function (callback, forceSelectAll) {
        if (!callback) {
            return this.selectedItems;
        }
        if ((typeof(forceSelectAll) == "undefined" || forceSelectAll == null) && !this.renderer.isSelectAll()) {
            callback(this.selectedItems);
        } else {
            if (this.source == null) {
                callback([]);
                return;
            }

            var total = this.totalItems;
            var chunk = this.getSelectedItemsChunkSize();
            var items = [];
            var thiz = this;
            var index = 0;
            var next = function () {
                thiz.source.loadPage(index, chunk, function (results, totalItems) {
                    var excludedCount = 0;
                    for (var i = 0; i < results.length; i ++) {
                        if (thiz.renderer._getExcludedItemCounts && thiz.renderer._getExcludedItemCounts() > 0) {
                            if (thiz.renderer.isIdUnselected(results[i].id)) {
                                excludedCount ++;
                                continue;
                            }
                        }

                        items.push(results[i]);
                    }

                    total = totalItems - excludedCount;
                    index ++;
                    if (items.length < total && results.length > 0) {
                        next();
                    } else {
                        items = items.filter(function (data) {
                            return !thiz.renderer.selectable || thiz.renderer.selectable(data);
                        });
                        defaultIndicator.done();
                        //console.log("Done loading " + items.length + " items.");
                        thiz._allItems = items;
                        callback(items);
                    }
                }, function (error) {
                    console.error(error);
                    defaultIndicator.done();
                });
            };
            defaultIndicator.busy("Fetching data list...");
            next();
        }
    };

    InfiniteScrollPaginator.prototype.getSelectedItemIds = function (callback) {
        if (!callback) {
            return this.selectedItems.map(function (i) { return i.id; });
        }
        if (!this.renderer.isSelectAll()) {
            callback(this.selectedItems ? (this.selectedItems.map(function (i) { return i.id; })) : []);
        } else {
            if (this.source == null) {
                callback([]);
                return;
            }
            if (this._allItems) {

                callback(this._allItems.map(function (i) { return i.id; }));
                return;
            }

            if (!this.source.loadAllIds) throw "Source does not support loadAllIds";
            var thiz = this;
            this.source.loadAllIds(function (ids) {
                var filterIds = ids;
                if (thiz.renderer._getExcludedItemCounts && thiz.renderer._getExcludedItemCounts() > 0) {
                    filterIds = ids.filter(function (id) {
                        return !thiz.renderer.isIdUnselected(id);
                    });
                }
                callback(filterIds);
            });
        }
    };


    InfiniteScrollPaginator.prototype.handleRendererInfiniteScrollDown = function (dy) {
        if (this._shouldLoadMore()) this._loadMore();
    };


    return InfiniteScrollPaginator;
}();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/TabPane.js";

function TabPane(node) {
    BaseTemplatedWidget.call(this);
    this.headers = [];
    this.activeTabHeader = null;

    this.keepSamePaneSize = node ? (node.getAttribute("same-pane-size") != "false") : true;
    this.pluginKey = Dom.getAttributeAsString(node, "plugin-key", "");
    this.supportPluginCustomization = Dom.getAttributeAsBoolean(node, "support-plugin-customization", false);

    this.bind("click", this.handleHeaderClick, this.header);
    this.bind("e:SizeChange", this.ensureSizing, this.content);

    if (this.keepSamePaneSize) Dom.addClass(this.node(), "SamePaneSize");

    this._headerScrollLeft = 0;
    this.bind("click", this._handleHeaderPrev, this.prevButton);
    this.bind("click", this._handleHeaderNext, this.nextButton);
}

__extend(BaseTemplatedWidget, TabPane);

TabPane.prototype.setContentFragment = function (fragment) {
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node.nodeName || !node.getAttribute) continue;

        var title = node.getAttribute("tab-title");
        this.addTab(title, node);
    }

    window.setTimeout(function () {
        this._activateDefaultTab();
    }.bind(this), 10);

    if (this.isPluginSupported() && !this.supportPluginCustomization) {
        this._attachPlugins();
    }
};
TabPane.prototype.getTabs = function () {
    var tabs = [];
    for (var i = 0; i < this.headers.length; i ++) {
        var header = this.headers[i];
        var contentNode = header._contentNode;
        if (contentNode) {
            tabs.push({
                title: header._title,
                contentNode: contentNode,
                header: header
            });
        }
    }

    return tabs;
};
TabPane.prototype._activateDefaultTab = function () {
    if (!this.activeTabHeader && this.headers.length > 0) {
        this.activateTab(this.definedActiveTab || this.headers[0]);

    }
};
TabPane.prototype.addTab = function (title, contentNode) {
    var children = [];
    var icon = contentNode.getAttribute("tab-icon");
    var tabName = contentNode.getAttribute("tab-name");
    if (icon) {
        children.push({_name: "icon", "class": icon});
    }

    children.push({_name: "span", _text: title});

    if (this.withCloseButton) {
        children.push({_name: "icon", "class": "close"});
    }

    var header = Dom.newDOMElement({
        _name: "hbox",
        "class": "TabHeader",
        _children: children,
        "tab-key": tabName ? tabName : (typeof(title) != "string" ? "" : title.replace(/ /g, "_"))
    });
    header._title = title;

    this.addCustomTab(header, contentNode);
};

TabPane.prototype.addCustomTab = function (headerNode, contentNode) {
    var tabOrder = contentNode.getAttribute("tab-order");
    if (typeof(tabOrder) != "undefined") headerNode._order = tabOrder;

    this.header.appendChild(headerNode);
    this.content.appendChild(contentNode);

    headerNode._contentNode = contentNode;
    Dom.addClass(contentNode, "TabBody");

    this.headers.push(headerNode);

    if (contentNode.getAttribute("active") == "true") this.definedActiveTab = headerNode;
};

TabPane.prototype.setHeaderOrder = function(tabKey, order) {
    if (!this.headers) return;
    this.headers.forEach(function(header){
        var key = Dom.getAttributeAsString(header, "tab-key", "");
        if (key == tabKey) {
            header._order = order;
        }
    });
};

TabPane.prototype.invalidateHeaders = function () {
    if (!this.header) return;
    var orderHeaders = this.headers.filter(function (h) {return h._order != undefined});
    var headers = this.headers.filter(function (h) {return h._order == undefined});
    var mainHeaders = new Array(orderHeaders.length + headers.length);

    for (var i = 0; i < orderHeaders.length; i++) {
        var header = orderHeaders[i];
        var idx = header._order;

        while (mainHeaders[idx]) idx++;

        if (idx > mainHeaders.length - 1) {
            headers.push(header);
            continue;
        }

        mainHeaders[idx] = header;
    }
    for (var i = 0; i < mainHeaders.length; i++) {
        if (!mainHeaders[i]) {
            mainHeaders[i] = headers.shift();
        }
    }

    Dom.doOnSelector(this.header, ".TabHeader", function(header) {
        this.header.removeChild(header);
    }.bind(this));
    // Dom.doOnSelector(this.content, ".TabBody", function(header) {
    //     this.content.removeChild(header);
    // }.bind(this));
    this.headers = mainHeaders;
    this.headers.forEach(function(header){
        this.header.appendChild(header);
        // this.content.appendChild(header._contentNode);
    }.bind(this));
}

TabPane.prototype.activateTab = function (header) {
    for (var i = 0; i < this.headers.length; i ++) {
        var h = this.headers[i];
        if (h == header) {
            Dom.addClass(h, "ActiveTab");
            Dom.addClass(h._contentNode, "ActiveTab");
            this.activeTabHeader = header;
        } else {
            Dom.removeClass(h, "ActiveTab");
            Dom.removeClass(h._contentNode, "ActiveTab");
        }
    }

    var activeTab = this.activeTabHeader && this.activeTabHeader._contentNode;
    if (activeTab && activeTab._isPluginTab) {
        if (activeTab._pluginWidget) {
            if (activeTab._pluginWidget.updateView) activeTab._pluginWidget.updateView();
        } else {
            this._initPluginWidget(activeTab);
        }
    }

    Dom.emitEvent("e:TabChange", this.node());

    BaseWidget.signalOnSizeChangedRecursively(this.node());
};
TabPane.prototype._removeTabByHeader = function (header) {
    var prev = header.previousElementSibling;
    var next = header.nextElementSibling;
    var focusSibling = (header == this.activeTabHeader);
    header.parentNode.removeChild(header);
    header._contentNode.parentNode.removeChild(header._contentNode);

    var i = this.headers.indexOf(header);
    if (i >= 0) {
        this.headers.splice(i, 1);
    }

    if (focusSibling && (prev || next)) {
        this.activateTab(prev || next);
    }
};
TabPane.prototype.handleHeaderClick = function (event) {
    var header = Dom.findUpwardForNodeWithData(event.target, "_contentNode");
    if (!header) return;
    var thiz = this;

    if (this.onBeforeTabChanged && typeof(this.onBeforeTabChanged) == "function") {
        this.onBeforeTabChanged(event, function () {
            thiz.onHeaderClicked(header);
        });
    } else {
        this.onHeaderClicked(header);
    }
};

TabPane.prototype.onHeaderClicked = function (header) {
    var thiz = this;
    if (this.withCloseButton) {
        var close = Dom.findParentWithClass(event.target, "close");
        if (close) {
            if (this.canCloseTab) {
                this.canCloseTab(header._contentNode, function (closable) {
                    if (closable) thiz._removeTabByHeader(header);
                })
            } else {
                this._removeTabByHeader(header);
            }
            return;
        }
    }

    this.activateTab(header);
};

TabPane.prototype.getActiveTabPane = function () {
    if (!this.activeTabHeader) return null;
    return this.activeTabHeader._contentNode;
};
TabPane.prototype.setActiveTabPane = function (pane) {
    for (var i = 0; i < this.headers.length; i ++) {
        var h = this.headers[i];
        if (h._contentNode == pane) {
            this.activateTab(h);
            return;
        }
    }
};
TabPane.prototype.onSizeChanged = function () {
	this.ensureSizing();
};
TabPane.prototype.ensureSizing = function () {
    this._invalidateHeaderScroll();
    if (!this.keepSamePaneSize) return;

    var resize = true;
    if (this.node().getAttribute("flex") && this.node().parentNode && this.node().parentNode.nodeName == "vbox") {
        resize = false;
    }

    var w = Dom.getOffsetWidth(this.node()) - 2;
    var h = 0;

    for (var i = 0; i < this.headers.length; i ++) {
        var contentNode = this.headers[i]._contentNode;
        Dom.removeClass(contentNode, "Measured");
        var cw = Dom.getOffsetWidth(contentNode);
        var ch = Dom.getOffsetHeight(contentNode);

        h = Math.max(h, ch);
    }

    this.content.style.width = w + "px";

    if (resize) {
        this.content.style.height = h + "px";
    }

    for (var i = 0; i < this.headers.length; i ++) {
        var contentNode = this.headers[i]._contentNode;
        Dom.addClass(contentNode, "Measured");
    }
};
TabPane.prototype.onAttached = function () {
    if (this.isPluginSupported()) {
        this._attachPlugins();
    }

    if (this.headers.length < 1) return;

    var thiz = this;
    window.setTimeout(function () {
        thiz.ensureSizing();
    	BaseWidget.signalOnSizeChangedRecursively(thiz.node());
    }, 100);

};
TabPane.prototype._setupNavigationModule = function () {
    var thiz = this;
    this._navigationModule = {
        navigate: function (name, callback) {
            var tab = null;
            for (var i = 0; i < thiz.headers.length; i ++) {
                var h = thiz.headers[i];
                if (h._contentNode && thiz._getTabName(h._contentNode) == name) {
                    tab = h._contentNode;
                    break;
                }
            }

            if (!tab) {
                callback(null);
                return;
            }

            thiz.setActiveTabPane(tab);

            if (tab.getNavigationModuleAsync) {
                tab.getNavigationModuleAsync(callback);
            } else {
                callback(thiz._getTabNavigationModule(tab));
            }

        },
        close: function () {}
    };

    this.addEventListener("e:TabChange", function (e) {
        if (e.target != thiz.node()) return;
        var tab = thiz.getActiveTabPane();
        if (!tab) return;
        var name = thiz._getTabName(tab);
        if (!name) return;
        if (tab.getNavigationModuleAsync) {
            tab.getNavigationModuleAsync(function (m) {
                CommonNavigation.onNavigateToChildModule(thiz._navigationModule, name, m);
            });
        } else {
            CommonNavigation.onNavigateToChildModule(thiz._navigationModule, name, thiz._getTabNavigationModule(tab));
        }
    }, false);

    if (this.isPluginSupported()) {
        var navigate = this._navigationModule.navigate;
        this._navigationModule.navigate = function (name, callback) {
            var remainingTimes = 50;
            (function check() {
                if (!remainingTimes || thiz._pluginsAttached) {
                    navigate(name, callback);
                    return;
                }
                remainingTimes--;
                setTimeout(check, 100);
            })();
        }
    }
};
TabPane.prototype._getTabName = function (tab) {
    return tab.getAttribute("tab-name");
};

TabPane.KEY_NAVIGATION_MODULE = "_tabPane:navigationModule";

TabPane.prototype._getTabNavigationModule = function (tab) {
    if (!tab[TabPane.KEY_NAVIGATION_MODULE]) {
        var module = null;
        if (tab.__widget && tab.__widget.getNavigationModule) {
            module = tab.__widget.getNavigationModule();
        }

        if (tab.getNavigationModule) {
            module = tab.getNavigationModule();
        }

        if (!module) module = CommonNavigation.newUnnavigatableModule();
        tab[TabPane.KEY_NAVIGATION_MODULE] = module;
    }

    return tab[TabPane.KEY_NAVIGATION_MODULE];
};

TabPane.prototype.getNavigationModule = function () {
    if (!this._navigationModule) this._setupNavigationModule();
    return this._navigationModule;
};
TabPane.prototype._handleHeaderPrev = function () {
    if (this._headerScrollLeft <= 0) return;

    var delta = Math.min(Math.round(10 * Util.em()), this._headerScrollLeft);
    this._headerScrollLeft -= delta;
    this._invalidateHeaderScroll();
};
TabPane.prototype._handleHeaderNext= function () {
    var remaining = (this.header.scrollWidth + this._lastUsedHeaderScrollLeft) - this.header.offsetWidth - this._headerScrollLeft;
    if (remaining <= 0) return;

    var delta = Math.min(Math.round(10 * Util.em()), remaining);
    this._headerScrollLeft += delta;
    this._invalidateHeaderScroll();
};
TabPane.prototype._invalidateHeaderScroll = function () {
    var width = this.header.offsetWidth;
    var contentWidth = this.header.scrollWidth + (this._lastUsedHeaderScrollLeft || 0);

    this._headerScrollLeft = Math.min(this._headerScrollLeft, contentWidth - width);

    var leftOverlow = this._headerScrollLeft > 0;
    var rightOverflow = (contentWidth > width + this._headerScrollLeft);

    Dom.toggleClass(this.node(), "HeaderOverflowLeft", leftOverlow);
    Dom.toggleClass(this.node(), "HeaderOverflowRight", rightOverflow);

    this.headers[0].style.marginLeft = "-" + this._headerScrollLeft + "px";
    this._lastUsedHeaderScrollLeft = this._headerScrollLeft;
    // this.prevButton.style.left = this._headerScrollLeft + "px";
    // this.nextButton.style.right = "-" + this._headerScrollLeft + "px";
};
TabPane.prototype.removeTabByContentNode = function (contentNode) {
    var selectedHeaderIndex = null;
    for (var i = 0; i < this.headers.length; i ++) {
        var header = this.headers[i];
        if (header._contentNode === contentNode) {
            selectedHeaderIndex = i;
            break;
        }
    }

    if (selectedHeaderIndex == null) throw new Error("Tab not found for ", contentNode);

    var shouldChangeToFirstTab = (contentNode == this.getActiveTabPane());

    var header = this.headers[selectedHeaderIndex];
    this.headers.splice(selectedHeaderIndex, 1);

    header.parentNode.removeChild(header);
    contentNode.parentNode.removeChild(contentNode);

    if (shouldChangeToFirstTab && this.headers.length > 0) this.activateTab(this.headers[0]);
};
TabPane.prototype.findTabByName = function (name) {
    for (var i = 0; i < this.headers.length; i ++) {
        var h = this.headers[i];
        if (h._contentNode && this._getTabName(h._contentNode) == name) {
            return h._contentNode;
        }
    }

    return null;
}
TabPane.prototype.findHeaderByName = function (name) {
    for (var i = 0; i < this.headers.length; i ++) {
        var h = this.headers[i];
        if (h._contentNode && this._getTabName(h._contentNode) == name) {
            return h;
        }
    }
    return null;
}
TabPane.prototype.setTabTitleByName = function (name, newTitle, icon, useHtml) {
    var header = null;
    for (var i = 0; i < this.headers.length; i ++) {
        var h = this.headers[i];
        if (h._contentNode && this._getTabName(h._contentNode) == name) {
            header = h;
            break;
        }
    }

    if (!header) throw "Tab not found: " + name;

    var span = header.querySelector("span");
    if (useHtml) {
        span.innerHTML = newTitle;
    } else {
        Dom.setInnerText(span, newTitle);
    }

    if (typeof(icon) != "undefined") {
        var iconNode = header.querySelector("icon:first-child");
        if (iconNode) iconNode.setAttribute("class", icon);
    }
};

TabPane.prototype.isPluginSupported = function () {
    return this.pluginKey && this.pluginKey.length > 0;
};

TabPane.prototype._attachPlugins = function () {
    if (this._pluginsAttached || this._pluginsAttaching) return;
    this._pluginsAttaching = true;

    $clientService.getPluginViewRegistry(
        this.pluginKey,
        (this.getPluginOptions && this.getPluginOptions()) || {},
        function (registry) {
            if (registry && registry["Standalone"]) {
                registry["Standalone"]
                .filter(this.checkValidPluginData.bind(this))
                .sort(function (p1, p2) { return p1.priority - p2.priority})
                .forEach(this.renderPluginTab.bind(this));
            }
            this._pluginsAttached = true;
            delete this._pluginsAttaching;
            this.invalidateHeaders();
            if (this.onPluginsAttatched) this.onPluginsAttatched();
        }.bind(this),
        function (err) {
            console.log(err);
        }
    );
};

TabPane.prototype.checkValidPluginData = function (pluginData) {
    if (!pluginData) return false;
    var permissionKeys = pluginData.permissionKeys;
    if (!permissionKeys || !permissionKeys.length) return true;
    return pluginData.requireAllPermissions ? PermissionUtils.hasAllPermissions(permissionKeys) : PermissionUtils.hasAnyPermission(permissionKeys);
};

TabPane.prototype.renderPluginTab = function (pluginData) {
    var id = pluginData.id;
    var title = pluginData.displayName;
    var contentNode = Dom.newDOMElement(
        {
            _name: "vbox",
            _id: pluginData.id,
            "tab-name": pluginData.uriFragment || id,
            "tab-title": title,
            "tab-order": pluginData.priority,
            class: "PluginTab",
            _children: [
                {
                    _name: "vbox",
                    class: "ContainerWrapper",
                },
            ],
        },
        undefined,
        this
    );

    contentNode.getNavigationModuleAsync = function (callback) {
        var remainingWait = 20;
        (function check() {
            if (remainingWait == 0) {
                callback(CommonNavigation.newUnnavigatableModule());
                return;
            }

            if (contentNode._pluginWidget) {
                if (contentNode._pluginWidget.getNavigationModuleAsync) {
                    contentNode._pluginWidget.getNavigationModuleAsync(callback);
                } else if (contentNode._pluginWidget.getNavigationModule) {
                    callback(contentNode._pluginWidget.getNavigationModule());
                } else {
                    callback(CommonNavigation.newUnnavigatableModule());
                }
                return;
            } else {
                remainingWait--;
                setTimeout(check, 200);
            }
        })();
    };
    contentNode._pluginData = pluginData;
    contentNode._isPluginTab = true;

    if (pluginData.overridenFeatureId) {
        var tabIndex = this.headers.findIndex(function(header) {
            return header._contentNode && Dom.getAttributeAsString(header, "tab-key", "") == pluginData.overridenFeatureId;
        });

        if (tabIndex >= 0) {
            contentNode.setAttribute("tab-order", tabIndex);
            this._removeTabByHeader(this.headers[tabIndex]);
        }
    }

    this.addTab(title, contentNode);

    if (pluginData.lazyInitWidget) return;
    this._initPluginWidget(contentNode);
};

TabPane.prototype._initPluginWidget = function (pluginTab) {
    if (pluginTab._initialized || pluginTab._pluginWidget) return;
    pluginTab._initialized = true;
    var pluginData = pluginTab._pluginData;
    var container = pluginTab.firstElementChild;

    var widgetContructor = __pkg[pluginData.widgetClass];
    if (widgetContructor) {
        Dom.empty(container);
        pluginTab._pluginWidget = new widgetContructor(pluginData.dataMap || {}).into(container);
        return;
    }

    if (!pluginData.widgetClass.match(/^([^:]+):(.+)$/)) return;
    var ns = RegExp.$1;
    var name = RegExp.$2;

    widget.__ensureNamespaceLoaded(ns, function (pkg) {
        if (!pkg.hasOwnProperty(name)) return;
        Dom.empty(container);
        var widgetContructor = pkg[name];
        pluginTab._pluginWidget = new widgetContructor(pluginData.dataMap || {}).into(container);
    });
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/Popup.js";

function Popup(node) {
    BaseTemplatedWidget.call(this);

    this.forceInside = true;
    this.useZIndex = true;
    this.visible = false;
    this.minWidth = null;
    
    Popup._ensureGlobalListeners();

    var popupClass = Dom.getAttributeAsString(node, "popup-class", "");
    if (popupClass) this.setPopupClass(popupClass);
}
__extend(BaseTemplatedWidget, Popup);
Popup.Z_INDEX = 9001;

Popup._ensureGlobalListeners = function () {
    if (Popup._globalListenersInstalled) return;
    Popup._globalListenersInstalled = true;
    
    document.body.addEventListener("wheel", function (event) {
        if (BaseWidget.closables.length == 0) return;
        var closable = BaseWidget.closables[BaseWidget.closables.length - 1];
        if (!(closable instanceof Popup)) return;
        
        var popup = Dom.findParentWithClass(event.target, "AnonId_popupContainer");
        if (!popup || popup.parentNode != document.body) {
            Dom.cancelEvent(event);
        }
    }, true);
};

Popup.prototype.onAttached = function () {
    if (this.popupContainer) {
        this.reparent();
        this.popupContainer.style.position = "absolute";
        this.popupContainer.style.left = "0px";
        this.popupContainer.style.top = "0px";
        this.hide();
    }
};
Popup.prototype.kill = function(forceKill) {
    try {
        this.hide();
    } catch (e) {}
    if (this.popupContainer &&
        this.popupContainer.parentNode && (forceKill || this.popupContainer.parentNode == this.node().ownerDocument.body)) {
        this.popupContainer.parentNode.removeChild(this.popupContainer);
    }
    if (this.node().parentNode) {
        this.node().parentNode.removeChild(this.node());
    }
}
Popup.prototype.setPopupClass = function (clazz) {
    Dom.addClass(this.popupContainer, clazz);
};
Popup.prototype.setMinWidth = function (minWidth) {
    //console.log("setMinWidth", minWidth);
    this.minWidth = minWidth;
};
Popup.prototype.closeUpward = function (event) {
    var thiz = this;
    var node = !event ? null : Dom.findUpward(event.target, function (n) {
        return n == thiz.popupContainer;
    });

    if (node) return;
    if (this.dontCloseUpward && this.dontCloseUpward(event)) return;
    this.hide();
    if (event) Dom.cancelEvent(event);

    if (this._parent) this._parent.closeUpward(event);
};
Popup.prototype.shouldCloseOnBlur = function () {
    return true;
};
Popup.prototype.checkToCloseParent = function (element) {
    var thiz = this;
    var handler = function (popup) {
        if (!popup._parent) return;

        var node = Dom.findUpward(element, function (n) {
            return n == popup._parent.popupContainer;
        });

        if (node) {
            popup._parent._keepShowing = true;
        } else {
            popup._parent._keepShowing = false;
        }

        handler(popup._parent);
    };

    handler(this);
};
Popup.prototype.setContentFragment = function (fragment) {
    this.popupContainer.appendChild(fragment);
};
Popup.prototype.reparent = function () {
    if (this.popupContainer.parentNode && this.popupContainer.parentNode != this.node().ownerDocument.body) {
        this.popupContainer.parentNode.removeChild(this.popupContainer);
        this.node().ownerDocument.body.appendChild(this.popupContainer);
    }
};
Popup.prototype.toggle = function (anchor, hAlign, vAlign, hPadding, vPadding, autoFlip) {
    if (this.isVisible()) {
        this.hide();
    } else {
        this.show(anchor, hAlign, vAlign, hPadding, vPadding, autoFlip);
    }
};
Popup.prototype.show = function (anchor, hAlign, vAlign, hPadding, vPadding, autoFlip) {
    this.reparent();

    if (this.mode) {
        this.popupContainer.setAttribute("mode", this.mode);
    }

    this.popupContainer.style.position = "absolute";
    this.popupContainer.style.left = "0px";
    this.popupContainer.style.top = "0px";
    this.popupContainer.style.width = "auto";
    this.popupContainer.style.height = "auto";

    this.popupContainer.style.visibility = "hidden";
    this.popupContainer.style.display = "block";
    this.popupContainer.style.height = "auto";
    this.popupContainer.style.overflow = "visible";

    var thiz = this;
    window.setTimeout(function () {
        thiz._showImpl(anchor, hAlign, vAlign, hPadding, vPadding, autoFlip);
    }, 10);
};
Popup.prototype.isVisible = function () {
    return this.visible;
};
Popup.prototype.showAt = function (x, y, skipEvent) {
    this.reparent();

    if (this.mode) {
        this.popupContainer.setAttribute("mode", this.mode);
    }

    this.popupContainer.style.position = "absolute";
    this.popupContainer.style.visibility = "hidden";
    this.popupContainer.style.display = "block";

    var w = this.popupContainer.offsetWidth;
    var h = this.popupContainer.offsetHeight;

    var screenW = document.body.offsetWidth - 10;
    var screenH = window.innerHeight - 10;

    if (y + h > screenH) {
        y = screenH - h;
    }

    if (x + w > screenW) {
        x = x - w;
    }

    this.popupContainer.style.position = "absolute";
    this.popupContainer.style.left = x + "px";
    this.popupContainer.style.top = y + "px";
    //if (this.useZIndex) this.popupContainer.style.zIndex = Popup.Z_INDEX;
    this.popupContainer.style.visibility = "inherit";
    this.popupContainer.style.opacity = this.popupOpacity || 1;
    this.visible = true;
    if (!skipEvent) Dom.emitEvent("p:PopupShown", this.node());
    if (!this.skipStack) {
        BaseWidget.registerClosable(this);
    }
};
Popup.prototype._calculatePosition = function (anchor, hAlign, vAlign, hPadding, vPadding) {
    var w = this.popupContainer.offsetWidth;
    var h = this.popupContainer.offsetHeight;

    // find whether the anchor is in a fixed position container
    var n = anchor.parentNode;
    var useFixedPosition = false;
    while (n && n != document.documentElement) {
        var position = window.getComputedStyle(n).position;
        if (position == "fixed") {
            useFixedPosition = true;
            break;
        }

        n = n.parentNode;
    }

    var rect = anchor.getBoundingClientRect();
    var viewportRect = this.popupContainer.parentNode ? this.popupContainer.parentNode.getBoundingClientRect() : document.body.getBoundingClientRect();

    // var verticalScroll = "true" == Dom.getAttributeAsString(this.node(), "verticalScroll", "false");
    // if (verticalScroll && h > viewportRect.height * 0.5) {
    //     var nH = (h < (viewportRect.height * 0.75)) ? (h * 0.65) : (viewportRect.height * 0.45);
    //     h = nH;
    //     viewportRect.top = viewportRect.bottom - h;
    //     viewportRect.height = h;
    // }
    var aw = rect.width;
    var ah = rect.height;
    var ax = rect.left - (useFixedPosition ? 0 : viewportRect.left);
    var ay = rect.top - (useFixedPosition ? 0 : viewportRect.top);
    var p = hPadding || 0;

    var x = 0;
    if (hAlign == "left") x = ax - w - p;
    if (hAlign == "left-inside") x = ax + p;
    if (hAlign == "middle" || hAlign == "center") x = ax + aw / 2 - w / 2;
    if (hAlign == "right") x = ax + aw + p;
    if (hAlign == "right-inside") x = ax + aw - w - p;

    p = vPadding || p;

    var y = 0;

    if (vAlign == "top") y = ay - h - p;
    if (vAlign == "top-inside") y = ay + p;
    if (vAlign == "middle" || vAlign == "center") y = ay + ah / 2 - h / 2;
    if (vAlign == "bottom") y = ay + ah + p;
    if (vAlign == "bottom-inside") y = ay + ah - h - p;

    var info = {
        x: x, y: y,
        viewportWidth: viewportRect.width,
        viewportHeight: viewportRect.height,
        heightBelow: window.innerHeight - (rect.top + rect.height),
        heightAbove: rect.top,
        viewportTop: useFixedPosition ? 0 : viewportRect.top
    };

    info.useFixedPosition = useFixedPosition;


    return info;
};
Popup.prototype.invalidatePosition = function () {
    if (!this.lastShowOptions) return;
    this._showImpl(this.lastShowOptions.anchor,
        this.lastShowOptions.hAlign,
        this.lastShowOptions.vAlign,
        this.lastShowOptions.hPadding,
        this.lastShowOptions.vPadding,
        this.lastShowOptions.autoFlip,
        "skipEvent");
};
Popup.prototype._showImpl = function (anchor, hAlign, vAlign, hPadding, vPadding, autoFlip, skipEvent) {
    this.lastShowOptions = {
        anchor: anchor,
        hAlign: hAlign,
        vAlign: vAlign,
        hPadding: hPadding,
        vPadding: vPadding,
        autoFlip: autoFlip,
        skipEvent: skipEvent
    };
    var w = this.popupContainer.offsetWidth;
    var h = this.popupContainer.offsetHeight;

    if (this.minWidth && w < this.minWidth) {
        w = this.minWidth;
        this.popupContainer.style.width = this.minWidth + "px";
    }

    var p = this._calculatePosition(anchor, hAlign, vAlign, hPadding, vPadding);
    //h = Math.min(h, p.viewportHeight);

    var x = p.x;
    var y = p.y;

    //invalidate into view
    var screenW = p.viewportWidth - 10;
    if (x + w > screenW) {
        if (autoFlip && (hAlign == "right" || hAlign == "left-inside")) {
            hAlign = hAlign == "right" ? "left" : "right-inside";
            p = this._calculatePosition(anchor, hAlign, vAlign, hPadding, vPadding);
            x = p.x;
        } else {
            if (this.forceInside) x = screenW - w;
        }
    }
    var screenH = window.innerHeight - 10;

    if (y + p.viewportTop + h > screenH) {
        var fixedY = false;
        if (autoFlip && (vAlign == "bottom" || vAlign == "top-inside") && p.heightAbove > p.heightBelow) {
            vAlign = vAlign == "bottom" ? "top" : "bottom-inside";
            p = this._calculatePosition(anchor, hAlign, vAlign, hPadding, vPadding);
            y = p.y;
        } else {
            if (this.forceInside)  {
                this.popupContainer.style.height = (screenH - y) + "px";
                this.popupContainer.style.overflow = "auto";
            }
        }
    } else if (y + p.viewportTop < 0) {
        if (autoFlip && (vAlign == "top" || vAlign == "bottom-inside") && p.heightBelow > p.heightAbove) {
            vAlign = vAlign == "top" ? "bottom" : "top-inside";
            p = this._calculatePosition(anchor, hAlign, vAlign, hPadding, vPadding);
            y = p.y;
        }
    }

    var above = vAlign == "top" || vAlign == "bottom-inside";

    var displayHeight = h;
    if (above) {
        if (y + p.viewportTop < 0) {
            displayHeight -= (20 - p.viewportTop - y);
            y = 20 - p.viewportTop;
        }
    } else {
        if (y + p.viewportTop + h > screenH) {
            displayHeight = p.heightBelow - 20;
        }
    };

    if (this.onBeforeVisible) this.onBeforeVisible(x, y, hAlign, vAlign);
    this.popupContainer.style.position = p.useFixedPosition ? "fixed" : "absolute";
    this.popupContainer.style.left = Math.max(0, x) + "px";
    this.popupContainer.style.top = Math.max(0, y) + "px";
    //this.popupContainer.style.width = w + "px";
    var verticalScroll = "true" == Dom.getAttributeAsString(this.node(), "verticalScroll", "false");
    if (verticalScroll && displayHeight < h) {
        //console.log("p.viewportHeight: " + p.viewportHeight + ", h: " + h);
        this.popupContainer.style.height = displayHeight + "px";
        var skipControllingOverflowStyle = "true" == Dom.getAttributeAsString(this.node(), "skipControllingOverflowStyle", "false");
        if (!skipControllingOverflowStyle) this.popupContainer.style.overflow = "auto";
    }
    //if (this.useZIndex) this.popupContainer.style.zIndex = Popup.Z_INDEX;
    this.popupContainer.style.visibility = "inherit";
    this.popupContainer.style.display = verticalScroll ? "flex" : "block";
    this.popupContainer.style.opacity = this.popupOpacity || 1;

    this.visible = true;
    if (!skipEvent) Dom.emitEvent("p:PopupShown", this.node());

    if (!this.skipStack) {
        BaseWidget.registerClosable(this);
    }
};
Popup.prototype.close = function () {
    this.hide();
};
Popup.prototype.getClosableContainer = function () {
    return this.popupContainer;
};
Popup.prototype.hide = function (silent) {
    this.popupContainer.style.display = "none";
    this.popupContainer.style.opacity = 0;
    this.popupContainer.style.visibility = "hidden";
    this.visible = false;
    if (!silent) Dom.emitEvent("p:PopupHidden", this.node());
    if (this.onHide) this.onHide();

    BaseWidget.unregisterClosable(this);
    // if (this._parent) {
    //     if (!this._parent._keepShowing) {
    //        this._parent.hide();
    //    } else {
    //        this._parent._keepShowing = false;
    //    }
    // }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/Menu.js";

function Menu() {
    Popup.call(this);
    this.items = [];
    var thiz = this;
    this.popupContainer.addEventListener("click", function (event) {
        var itemNode = Dom.findUpwardForNodeWithData(event.target, "_item");
        if (!itemNode) return;
        var item = itemNode._item;
        
        if (item.expandable) {
            var expandingIcon = Dom.findParentWithClass(event.target, "ExpandingIcon");
            if (expandingIcon) {
                thiz._handleExpandingClick(itemNode, event);
                return;
            }
        }
        
        if (itemNode.getAttribute && itemNode.getAttribute("disabled") == "true") return;
        if (item.type == "Toggle" || item.type == "Selection") {
            var checkbox = itemNode._checkbox;
            if (event.target != checkbox) {
                checkbox.checked = !checkbox.checked;
            }
            if (item.handleAction) {
                console.log("checkbox.checked: " + checkbox.checked);
                item.handleAction(checkbox.checked);
            } else if (item.run) {
                item.run(checkbox.checked);
            }
            thiz.closeUpward();
        } else if (item.type == "SubMenu") {
            if (item.run) {
                var iconNode = Dom.findParentWithClass(event.target, "SubMenuIcon");
                if (iconNode) {
                    thiz.openSubMenu(itemNode);
                } else {
                    item.run();
                    if (thiz.currentSubMenu) {
                        thiz.currentSubMenu.closeUpward();
                        this.currentSubMenu = null;
                    }
                }
            } else {
                thiz.openSubMenu(itemNode);
            }
        } else {
            var handled = undefined;
            if (item.handleAction) {
                handled = item.handleAction();
            } else if (item.run) {
                handled = item.run();
            }
            if (typeof(handled) == "undefined" || "false" === handled) {
                thiz.closeUpward();
            }
        }
    }, false);
    this.checkOpenSub = false;
    this.bind("mouseover", this.handleMouseIn, this.popupContainer);
}
__extend(Popup, Menu);

Menu.prototype._handleExpandingClick = function (itemNode, event) {
    var thiz = this;
    console.log("_handleExpandingClick", itemNode._item);
    if (!itemNode._item) return;
    
    var f = itemNode._item.getSubItems ? function (item, callback) {
        callback(itemNode._item.getSubItems());
    } : itemNode._item.getSubItemsAsync;
    
    if (!f) return;
    
    if (itemNode._subItemsLoading) return;
    
    var toggle = function () {
        var container = Dom.findParentWithClass(itemNode, "MenuItemContainer");
        Dom.toggleClass(container, "Expanded");
    };
    
    if (itemNode._subItemsLoaded) {
        toggle();
        return;
    }
    
    itemNode._subItemsLoading = true;
    f(itemNode._item, function (subItems) {
        console.log("subItems", subItems);
        itemNode._subItemsLoading = false;
        itemNode._subItemsLoaded = true;
        
        // render children
        for (var i = 0; i < subItems.length; i++) {
            var box = thiz.renderItem(subItems[i], itemNode._childBox);
        }
        
        toggle();
        thiz.invalidatePosition();
    });
};
Menu.prototype.hideCurrentSubMenu = function () {
    if (this.currentItemNodeWithSubMenu) {
        Dom.removeClass(this.currentItemNodeWithSubMenu, "Active");
        this.currentItemNodeWithSubMenu._subMenu.hideMenu();
        this.currentItemNodeWithSubMenu = null;
    }
};
Menu.prototype.openSubMenu = function (itemNode) {
    if (itemNode == this.currentItemNodeWithSubMenu) return;

    this.hideCurrentSubMenu();

    var item = itemNode._item;

    var menu = new Menu();
    menu.forceInside = true;
    var subItems = item.subItems || item.getSubItems();
    for (var i in subItems) {
        menu.register(subItems[i]);
    }
    menu.showMenu(itemNode, "right", "top-inside", -5, 1, "auto-flip");
    menu._parent = this;
    itemNode._subMenu = menu;

    this.currentItemNodeWithSubMenu = itemNode;
    Dom.addClass(this.currentItemNodeWithSubMenu, "Active");
    this.currentSubMenu = menu;
};

Menu.prototype.handleMouseIn = function (event) {
    var thiz = this;

    if (this._parent && this._parent.currentHideMenuTimeout && this == this._parent.currentItemNodeWithSubMenu._subMenu) {
        window.clearTimeout(this._parent.currentHideMenuTimeout);
        this._parent.currentHideMenuTimeout = null;
        Dom.addClass(this._parent.currentItemNodeWithSubMenu, "Active");
    }

    var itemNode = Dom.findUpwardForNodeWithData(event.target, "_item");
    if (!itemNode) return;
    var item = itemNode._item;
    var disabled = itemNode.getAttribute && itemNode.getAttribute("disabled") == "true";

    if (this.currentItemNodeWithSubMenu && (itemNode != this.currentItemNodeWithSubMenu)) {
        //schedule close
        if (this.currentHideMenuTimeout ) {
            window.clearTimeout(this.currentHideMenuTimeout);
        }

        Dom.removeClass(this.currentItemNodeWithSubMenu, "Active");
        this.currentHideMenuTimeout = window.setTimeout(function () {
            thiz.hideCurrentSubMenu();
            thiz.currentHideMenuTimeout = null;
        }, 200);
    }
    if (this.currentShowMenuTimeout) {
        window.clearTimeout(this.currentShowMenuTimeout);
        this.currentShowMenuTimeout = null;
    }
    if (item.type == "SubMenu" && !disabled && itemNode != this.currentItemNodeWithSubMenu) {
        this.currentShowMenuTimeout = window.setTimeout(function () {
            thiz.openSubMenu(itemNode);
            thiz.currentShowMenuTimeout = null;
        }, 300);
    }

};
/*
    {icon: "icon-name", label: "My menu item", type: "Selection", isChecked: false}
*/
Menu.prototype.register = function (item) {
    if (!item) return;
    this.items.push(item);
};
Menu.SEPARATOR = {
};
Menu.prototype.separator = function () {
    this.register(Menu.SEPARATOR);
};
Menu.prototype.renderItem = function (item, providedContainer) {
    var container = providedContainer || this.popupContainer;
    if (item.isAvailable && !item.isAvailable() || item.disabled) return;

    if (item == Menu.SEPARATOR) {
        if (this.lastItemWasActualEntry) {
            this.lastItemWasActualEntry = false;

            var sep = Dom.newDOMElement({
                _name: "hr",
                "class": "MenuItem MenuSeparator",
                disabled: true
            });

            sep._item = item;
            container.appendChild(sep);

            return sep;
        }

        return;

    }

    var disabled = ((item.isEnabled && !item.isEnabled()) || (item.isValid && !item.isValid()) || item.disabled) ? true : false;
    var hbox = Dom.newDOMElement({
        _name: "hbox",
        "class": "MenuItem" + (item.id ? " MenuItem_" + item.id : "") + (item.class ? " " + item.class : ""),
        disabled: disabled
    });
    if (item.selected) Dom.addClass(hbox, "Selected");
    var style = "";
    if (item.style === "center") {
        style = "justify-content: center";
    }
    if (item.menuItemColor) {
        if (style.length > 0) {
            style += ";";
        }
        style += "background-color: " + item.menuItemColor;
    }
    if (style.length > 0) {
        hbox.style = style;
    }
    hbox._item = item;

    var checkboxId = null;
    if (item.type == "Toggle" || item.type == "Selection") {
        checkboxId = Util.newUUID();
        var checkbox = Dom.newDOMElement({
            _name: "input",
            type: item.type == "Toggle" ? "checkbox" : "radio",
            "class": "Checkbox",
            id: checkboxId
        });
        if ((item.isChecked && item.isChecked()) || item.checked) {
            checkbox.setAttribute("checked", "true");
        }

        if (disabled) checkbox.setAttribute("disabled", "true");
        hbox.appendChild(checkbox);
        hbox._checkbox = checkbox;
        hbox._prefixed = true;
    } else {
        if (item.icon) {
            var i = Dom.newDOMElement({
                _name: "icon",
                class: item.icon || "",
            });
            if (item.iconColor) {
                i.style = "color:" + item.iconColor;
            }
            hbox.appendChild(i);
            hbox._prefixed = item.icon ? true : false;
        }
        if (item.image) {
            var i = Dom.newDOMElement({
                _name: "img",
                src: item.image,
                class: "MenuIcon"
            });
            hbox.appendChild(i);
        }
    }
    
    if (item.expandable) {
        var i = Dom.newDOMElement({
            _name: "icon",
            class: "menu-right ExpandingIcon"
        });
        hbox.appendChild(i);
    }

    var label = Dom.newDOMElement({
        _name: "label",
        _text: item.label ? item.label : (item.getLabel && typeof(item.getLabel) == "function" ? item.getLabel() : ""),
        flex: item.style === "center" ? "" : "1",
        style: item.textColor ? "color:" + item.textColor : ""
    });
    // if (checkboxId) label.setAttribute("for", checkboxId);
    hbox.appendChild(label);

    if (item.shortcut) {
        if (!item.parsedShortcut) UICommandManager.parseShortcut(item);
        var shortcutSpan = Dom.newDOMElement({
            _name: "span",
            "class": "Shortcut",
            _text: item.parsedShortcut ? item.parsedShortcut.displayName : item.shortcut
        });
        hbox.appendChild(shortcutSpan);
    } else {
        if (item.type == "SubMenu") {
            hbox.appendChild(Dom.newDOMElement({
                _name: "i",
//                _text: "keyboard_arrow_right",
                "ui-icon": "chevron-right",
                "class": "SubMenuIcon"
            }));
        }
    }

    this.lastItemWasActualEntry = true;
    
    if (!item.expandable) {
        container.appendChild(hbox);
        return hbox;
    }
    var vbox = Dom.newDOMElement({
        _name: "vbox",
        "class": "MenuItemContainer"
    });
    vbox.appendChild(hbox);
    
    var childBox = Dom.newDOMElement({
        _name: "vbox",
        "class": "SubMenuItemContainer"
    });
    vbox.appendChild(childBox);
    hbox._childBox = childBox;
    
    container.appendChild(vbox);
    return vbox;
};
Menu.prototype.render = function () {
    Dom.empty(this.popupContainer);
    var actualItems = [];
    Array.prototype.forEach.call(this.items, function(item){
        if (item instanceof Function) {
            actualItems = actualItems.concat(item());
        } else {
            actualItems.push(item);
        }
    });
    var withPrefix = false;
    this.lastItemWasActualEntry = false;
    var last = null;
    for (var i = 0; i < actualItems.length; i++) {
        var box = this.renderItem(actualItems[i]);
        if (box && box._prefixed) withPrefix = true;
        if (box) last = box;
    }

    if (last && last._item == Menu.SEPARATOR) last.parentNode.removeChild(last);

    if (withPrefix) {
        Dom.removeClass(this.popupContainer, "NoPrefix");
    } else {
        Dom.addClass(this.popupContainer, "NoPrefix")
    }
};
Menu.prototype.showMenu = function (anchor, hAlign, vAlign, hPadding, vPadding, autoFlip) {
    this.render();
    this.show(anchor, hAlign, vAlign, hPadding, vPadding, autoFlip);
};
Menu.prototype.showMenuAt = function (x, y) {
    this.render();
    this.showAt(x, y, false, "autoFlip");
};
Menu.prototype.hideMenu = function () {
    this.hide();
    if (this.currentItemNodeWithSubMenu && this.currentItemNodeWithSubMenu._subMenu) {
        this.currentItemNodeWithSubMenu._subMenu.hideMenu();
    }
};
Menu.prototype.onHide = function () {
    if (this._parent) this._parent.currentItemNodeWithSubMenu = null;
    if (this.currentShowMenuTimeout) window.clearTimeout(this.currentShowMenuTimeout);
};
Menu.prototype.close = function (onBlur, event) {
    this.hide();
    if (onBlur && event && this._parent) BaseWidget.tryCloseClosableOnBlur(this._parent, event);
};
Menu.prototype.closeUpward = function (onBlur, event) {
    this.hide();
    if (this._parent) this._parent.closeUpward();
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ComboManager.js";

function ComboManager(node) {
    BaseTemplatedWidget.call(this);

    this._useLazyListInit = Dom.getAttributeAsBoolean(node, "lazy-list-init", false);

    // explicit class marker for subclass template merging
    Dom.addClass(this.node(), "widget_ComboManager");

    this.button = this.node();
    this.button.setAttribute("type", "button");

    this.popup.setPopupClass("ComboManagerPopup");
    this.useHtml = false;

    this.renderer = ComboManager.DEFAULT_RENDERER;
    this.comparer = Util.sameId;
    this.bind("click", function () {
        if (this.popup != null && this.popup.isVisible()) {
            this.popup.hide();
            return;
        }
        this.show();
    }, this.button);
    this.bind("click", this.onItemClick, this.list);
    this.bind("keypress", this._handleKeyPress.bind(this), this.button);
    this.bind("p:PopupShown", function () {
        this.button.setAttribute("active", true);
        this.invalidateSelectItem(true);
    }, this.popup);
    this.bind("p:PopupHidden", function () {
        this.button.removeAttribute("active");
    }, this.popup);

    //Only handle up & down so used keydown
    this.bind("keydown", this._handleKeyEvent.bind(this), this.focusControl());
    var thiz = this;
    this.popup.shouldCloseOnBlur = function(event) {
        var found = Dom.findUpward(event.target, function (node) {
            return node == thiz.button;
        });
        return !found;
    };

}
__extend(BaseTemplatedWidget, ComboManager);
ComboManager.EMPTY_ITEM_TEXT = "\u00A0\u00A0\u00A0\u00A0";
ComboManager.prototype.onDetached = function() {
    if (!this.popup) return;

    var thiz = this;
    window.setTimeout(function () {
        if (!document.body.contains(thiz.node())) {
            if (thiz.popup) thiz.popup.kill();
        }
    }, 400);

}
ComboManager.prototype.focusControl = function() {
    return this.button;
}
ComboManager.prototype.show = function() {
    if (!this._listInitialized && this._useLazyListInit) this._buildPopupContent();

    this.popup.setMinWidth(this.getMinimumWidth());
    this.popup.show(this.button, this.horizontalAlignment || "left-inside", "bottom", 0, 5, "autoFlip");
}
ComboManager.DEFAULT_RENDERER = function (item) {
    return "" + item;
};
ComboManager.prototype.getMinimumWidth = function() {
    return this.button.offsetWidth;
}
ComboManager.prototype.invalidateSelectItem = function(revealSelectedItem) {
    var thiz = this;
    var node = null;
    Dom.doOnChildRecursively(this.list, function (n) {
        return n && n._data;
    }, function (n) {
        var data = n._data;
        var s = thiz.getSelectedItem();
        var ok = s && thiz.comparer && thiz.comparer(s, data);
        if (ok) {
            Dom.addClass(n, "Selected");
            node = n;
        } else {
            Dom.removeClass(n, "Selected");
        }
    });
    if (node && revealSelectedItem) node.scrollIntoView({behavior: "auto", block: "nearest", inline: "nearest"});
}
ComboManager.prototype.onItemClick = function (event) {
    var item = Dom.findUpwardForData(event.target, "_data");
    if (typeof(item) == "undefined") return;
    if (!this.isSelectable(Dom.getTarget(event))) return;
    this.selectItem(item, true);
};

ComboManager.prototype.isSelectable = function(node) {
    var node = Dom.findParentWithClass(node, "Item");
    if (node && Dom.hasClass(node, "Disabled")) return false;
    return true;
}
ComboManager.prototype.getItemNode = function (item) {
    var node = undefined;
    var thiz = this;
    Dom.doOnChildRecursively(this.list, function (n) {
        return n && n._data && thiz.comparer && thiz.comparer(item, n._data);
    }, function (n) {
        node = n;
    });
    return node;
};
ComboManager.prototype.setItemEnabled = function(item, enabled) {
    var thiz = this;
    Dom.doOnChildRecursively(this.list, function (n) {
        return n && n._data && thiz.comparer && thiz.comparer(item, n._data);
    }, function (n) {
        Dom.removeClass(n, "Disabled");
        if (!enabled) {
            Dom.addClass(n, "Disabled");
        }
    });
}
ComboManager.prototype.setItems = function (items, noSelectFirst) {
    this.items = items;
    this.list.innerHTML = "";
    if (!this.items) return;

    var first = (items && items.length > 0) ? items[0] : undefined;

    if (this._useLazyListInit) {
        this._listInitialized = false;
    } else {
        this._buildPopupContent();
    }

    var selectFirst = typeof(noSelectFirst) === "undefined";
    if (selectFirst) {
        this.selectItem(first);
    }
};

ComboManager.prototype._buildPopupContent = function () {
    this.list.innerHTML = "";
    if (!this.items) return;
    for (var i = 0; i < this.items.length; i++) {
        var item = this.items[i];
        var element = this.renderer(item);
        var node = null;
        if (element.getAttribute) {
            node = Dom.newDOMElement({
                _name: "div",
                "class": "Item",
            });
            node.appendChild(element);
        } else {
            var spec = {
                _name: "div",
                "class": "Item",
                _text: element
            };

            spec[this.useHtml ? "_html" : "_text"] = element;
            node = Dom.newDOMElement(spec);
        }
        if (this.decorator) this.decorator(node, item);
        node._data = item;
        this.list.appendChild(node);
    }
    this._listInitialized = true;
};

ComboManager.prototype.invalidateTitle = function() {
    var item = this.getSelectedItem();
    var element = item ? this.getDisplayValue(item) : undefined;
    if (!element || ComboManager.EMPTY_ITEM_TEXT === element) {
        element = "";
    }
    this.button.setAttribute("title", element.getAttribute ? "" : (this.useHtml ? Dom.htmlStrip(element) : element));
}
ComboManager.prototype.selectItem = function (item, fromUserAction, noNeedChangeCurrentText) {
    // var element = this.renderer(item, "forCurrentItemDisplay");
    if (typeof(item) == "undefined") {
        this.selectedItem = undefined;
        this.invalidateSelectItem();
        this.invalidateTitle();
        this.fireSelectionEvent(fromUserAction);
        return;
    }

    var element = this.getDisplayValue(item);
    if (!element) return;

    if (typeof(noNeedChangeCurrentText) == "undefined") {
        if (element.getAttribute) {
            Dom.empty(this.buttonDisplay);
            this.buttonDisplay.appendChild(element);
        } else {
            this.buttonDisplay.innerHTML = this.useHtml ? element : Dom.htmlEncode(element);
        }
    }
    if (this.decorator != null) {
        this.decorator(this.buttonDisplay, item);
    }
    this.selectedItem = item;
    this.invalidateTitle();

    if (fromUserAction) {
        this.popup.hide();
    } else {
        this.invalidateSelectItem();
    }
    this.fireSelectionEvent(fromUserAction);
};
ComboManager.prototype.getDisplayValue = function(item) {
    return this.renderer(item, "forCurrentItemDisplay");
}
ComboManager.prototype.selectItemByKey = function (keyName, keyValue, fromUserAction) {
    for (var i = 0; i < this.items.length; i++) {
        if (this.items[i] && this.items[i][keyName] == keyValue) {
            this.selectItem(this.items[i], fromUserAction);
            return true;
        }
    }

    return false;
};
ComboManager.prototype.selectItemById = function (id) {
    return this.selectItemByKey("id", id);
};
ComboManager.prototype.getSelectedItem = function () {
    return this.selectedItem;
};
ComboManager.prototype.setDisabled = function (disabled) {
    if (disabled == true) {
        this.button.setAttribute("disabled", "true");
    } else {
        this.button.removeAttribute("disabled");
    }
};
ComboManager.prototype.selectItemIfContains = function (selectedItem) {
    var item = null;
    var found = false;
    for (var i = 0; i < this.items.length; i ++) {
        if (this.comparer && this.comparer(selectedItem, this.items[i])) {
            item = this.items[i];
            found = true;
            break;
        }
    }

    if (found) {
        this.selectItem(item);
        return true;
    }

    return false;
};
ComboManager.prototype.getCurrentItemDisplayText = function (item) {
    return this.useHtml ? Dom.htmlStrip(this.renderer(item, "forCurrentItemDisplay")) : this.renderer(item, "forCurrentItemDisplay");
};
ComboManager.prototype.fireSelectionEvent = function (fromUserAction) {
    Dom.emitEvent("p:ItemSelected", this.node(), {fromUser: fromUserAction ? true : false});

    if (this.options && this.options.onItemSelected) {
        this.options.onItemSelected(fromUserAction ? true : false);
    }
};
ComboManager.prototype.setEnable = function (enable) {
    this.setDisabled(!enable);
};
ComboManager.prototype._handleKeyPress = function (event) {
    var keyCode = event.charCode;
    if ((keyCode > 47 && keyCode < 58)
        || (keyCode > 64 && keyCode < 91)
        || (keyCode > 95 && keyCode < 122)) {
        var now = new Date().getTime();
        var delta = now - (this.lastKeyPressTime || 0);
        if (!this.prefix || delta > 1000) {
            this.prefix = String.fromCharCode(event.charCode);
        } else {
            this.prefix += String.fromCharCode(event.charCode);
        }
        this.lastKeyPressTime = now;
        var found = false;
        for (var i = 0; i < this.list.childNodes.length; i ++) {
            var node = this.list.childNodes[i];
            if (!found && node.textContent && node.textContent.trim().toLowerCase().indexOf(this.prefix.trim().toLowerCase()) == 0) {
                var item = Dom.findUpwardForData(node, "_data");

                if (typeof(item) == "undefined" || !this.isSelectable(node)) return;

                this.selectItem(item, !this.popup.isVisible());
                break;
            }
        }
        Dom.cancelEvent(event);
    }
};

ComboManager.prototype._handleKeyEvent = function(event) {
    if (typeof(event) == "undefined") return;

    switch (event.keyCode) {
        case DOM_VK_DOWN:
        var item = this.getSelectedItem();
        var nextItem = this.findNext(item);
        if (nextItem) {
            this.selectItem(nextItem, false);
        } else {
            var start = this.items && this.items.length > 0 ? this.items[0] : undefined;
            this.selectItem(start, false);
        }
        Dom.cancelEvent(event);
        break;

        case DOM_VK_UP:
        var item = this.getSelectedItem();
        var prevItem = this.findPrev(item);
        if (prevItem) {
            this.selectItem(prevItem, false);
        } else {
            var start = this.items && this.items.length > 0 ? this.items[0] : undefined;
            this.selectItem(start, false);
        }
        Dom.cancelEvent(event);
        break;

        case DOM_VK_ENTER:
        case DOM_VK_RETURN:

            if (!this.popup.isVisible()) {
                this.show();
            } else {
                var item = this.getSelectedItem();
                this.selectItem(item, true);
            }
            Dom.cancelEvent(event);
        break;

        default:
        break;
    }
}
ComboManager.prototype.findNext = function(current) {
    if (!this.items || this.items.length == 0) return undefined;
    var index = this.getIndex(current, this.items);
    if (index >= 0) {
        var next = index + 1 >= this.items.length ? 0 : index + 1;
        var nextItem = this.items[next];
        if (!this.isSelectable(this.getItemNode(nextItem))) {
            return this.findNext(index + 1);
        } else {
            return nextItem;
        }
    } else {
        return undefined;
    }
}

ComboManager.prototype.findPrev = function(current) {
    if (!this.items || this.items.length == 0) return undefined;
    var index = this.getIndex(current, this.items);
    if (index >= 0) {
        var prev = index - 1 < 0 ? this.items.length - 1  : index - 1;
        var prevItem =  this.items[prev];
        if (!this.isSelectable(this.getItemNode(prevItem))) {
            return this.findPrev(index - 1);
        } else {
            return prevItem;
        }

    } else {
        return undefined;
    }
}
ComboManager.prototype.getIndex = function(current, items) {
    var index = -1;
    if (current) {
        for (var i = 0; i < items.length; i ++) {
            if (this.comparer && this.comparer(current, items[i])) {
                index = i;
                break;
            }
        }
    }
    return index;
}
ComboManager.prototype.setPopupClass = function (clazz) {
    this.popup.setPopupClass(clazz);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DynamicComboManager.js";

function DynamicComboManager() {
    ComboManager.call(this);
    this.bind("change", this.invalidateShowContentPreview, this.showContentCheckBox);
    this.invalidateShowContentPreview();
    //this.bind("keypress", this._handleKeyPress.bind(this), this.termInput);
    this.bind("input", this.search, this.termInput);
    this.bind("change", this.search, this.termInput);

    this.bind("p:PopupShown", function () {
        this.termInput.value = "";
        this.termInput.focus();
        Dom.addClass(this.contentBox, "Active");
        Dom.addClass(this.list, "Active");
        Dom.addClass(this.popup.popupContainer, "Shown");
        this.searchImpl(typeof (this.source.getSelectedItem()) === "undefined");
    }, this.popup);
    this.bind("p:PopupHidden", function (ev) {
        Dom.removeClass(this.contentBox, "Active");
        Dom.removeClass(this.list, "Active");
        Dom.removeClass(this.popup.popupContainer, "Shown");
        delete this._searchTask;
    }, this.popup);
    this.popup.setPopupClass("DynamicComboManagerPopup");
    this.bind("p:ItemSelected", function() {
        this.showPreviewIfNeeded();
    }, this.node());
}
__extend(ComboManager, DynamicComboManager);

DynamicComboManager.prototype.focusControl = function() {
    return this.termInput;
}

DynamicComboManager.prototype.selectItem = function (item, fromUserAction) {
    ComboManager.prototype.selectItem.call(this, item, fromUserAction, !fromUserAction && this.popup.isVisible() ? "yes" : undefined);
}

DynamicComboManager.prototype.showPreviewIfNeeded = function() {
    var item = this.getSelectedItem();
    var isPreview = item && this._preview && this._previewItem && this.comparer && this.comparer(item, this._previewItem);
    if (isPreview) {
        return;
    }
    this.contentPreview.innerHTML = "";
    if (!this.showContentCheckBox.checked
        || !this.popup.isVisible() || !this.source || !this.source.getPreviewContent) {
        delete this._previewItem;
        delete this._preview;
        return;
    }
    if (this._previewTask) window.clearTimeout(this._previewTask);
    var thiz = this;
    this._previewTask = window.setTimeout(function(){
        delete thiz._previewTask;
        var pv = thiz.source.getPreviewContent(item);
        if (!pv) {
            delete thiz._previewItem;
            delete thiz._preview;
            return;
        }
        pv.into(thiz.contentPreview);
        thiz._previewItem = item;
        thiz._preview = pv;
    }, 300);



}
DynamicComboManager.prototype.setSource = function(source) {
    this.source = source;
    if (!this.popup.isVisible()) {
        this.searchImpl(typeof (this.source.getSelectedItem()) === "undefined");
    }
}

DynamicComboManager.prototype.search = function() {
    if (!this.source) return;
    var thiz = this;
    if (thiz._searchTask) {
        window.clearTimeout(thiz._searchTask);
    }
    this._searchTask = window.setTimeout(function () {
        thiz.searchImpl();
    }, 250);
}
DynamicComboManager.prototype.searchImpl = function(forceSelectFirst) {
    var thiz = this;
    var term = thiz.termInput.value.trim();
    if (!this.source.getItems) return;
    this.source.getItems(term, function(items) {
        var selected = thiz.source.getSelectedItem();
        if (forceSelectFirst || !selected) {
            thiz.setItems(items);
        } else {
            thiz.setItems(items, "noSelectFirst");
        }
        var index = thiz.getIndex(selected, items);
        if (index >= 0) {
            thiz.selectItemIfContains(selected);
        } else {
            thiz.selectItem((forceSelectFirst && items && items.length > 0) ? items[0] : undefined, false);
        }
    });
}

DynamicComboManager.prototype.invalidateShowContentPreview = function() {
    var show = this.showContentCheckBox.checked;
    if (show) {
        Dom.addClass(this.contentPreview, "Active");
        Dom.addClass(this.list, "PreviewMode");
    } else {
        Dom.removeClass(this.contentPreview, "Active");
        Dom.removeClass(this.list, "PreviewMode");
    }
    if (show) {
        this.showPreviewIfNeeded();
    }
    if (this.popup.isVisible()) {
        this.popup.setMinWidth(this.getMinimumWidth());
        this.popup.invalidatePosition();
    }
    this.termInput.focus();
}
DynamicComboManager.prototype.getMinimumWidth = function() {
    var show = this.showContentCheckBox.checked;
    return show ? this.button.offsetWidth * 1.3 : this.button.offsetWidth;
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/Tree.js";

var Tree = function() {
    function treeClickHandler(event) {
        var target = Dom.getTarget(event);
        var chevron = Dom.findUpward(target, {
            eval: function(n) {
                return Dom.hasClass(n, "Chevron");
            }
        });

        var itemObject = Dom.findUpward(target, {
            eval: function(n) {
                return n._item;
            }
        });

        console.log("itemObject", itemObject);

        // check for click on leaf, wth?
        if (itemObject) {
            var treeContainer = Dom.findUpward(target, {
                eval: function(n) {
                    return n._tree;
                }
            });


            if (!treeContainer) return;

            var selectable = false;

            var tree = treeContainer._tree;
            if (tree.options.isItemSelectable) {
                selectable = tree.options.isItemSelectable(itemObject._item);
            } else {
                selectable = (!itemObject._item.children || itemObject._item.children.length == 0);
            }

            if (selectable) {
                if (/* tree.listener && */Dom.findParentWithClass(target, "ItemText")) {
                    var allItemText = tree.container.getElementsByClassName("ItemText");
                    var itemText = itemObject.getElementsByClassName("ItemText")[0];
                    if (!Dom.hasClass(itemText, "Disabled")) {
                        for ( var i = 0; i < allItemText.length; i++) {
                            Dom.removeClass(allItemText[i], "Selected");
                        }

                        if (itemText) {
                            Dom.addClass(itemText, "Selected");
                        }

                        tree.emitChangeEvent();
                    }
                    if (tree.listener) tree.listener(itemObject._item);
                }
            }
        }

        if (!chevron) {
            return;
        }

        var treeContainer = Dom.findUpward(target, {
            eval: function(n) {
                return n._tree;
            }
        });

        if (!treeContainer) return;

        var tree = treeContainer._tree;
        if (chevron) {
            var itemNode = Dom.findParentWithClass(chevron, "Item");
            //console.log("EXPANDING: itemNode", itemNode);
            var isExpanded = Dom.hasClass(itemNode, "Expanded");
            //console.log("EXPANDING: isExpanded", isExpanded);

            if (!isExpanded) {
                var item = itemNode._item;
                //console.log("EXPANDING: itemNode", itemNode);
                if (!itemNode.childLoaded) {
                    tree.loadChildren(item, getChildrenContainerFromItemNode(itemNode));
                    itemNode.childLoaded = true;
                }
            }

            setExpandedClasses(itemNode, !isExpanded);
        }
    }
    
    function treeDoubleClickHandler(event) {
        var item = Dom.findUpwardForData(event.target, "_item");
        if (!item) return;
        
        var tree = Dom.findUpwardForData(event.target, "_tree");
        if (!tree) return;
        
        Dom.cancelEvent(event);
        
        Dom.emitEvent("p:ItemDoubleClicked", tree.node(), {item: item});
    }

    function treeCheckBoxListener(event) {
        var target = Dom.getTarget(event);
        if (!target || !Dom.hasClass(target, "Checkbox") || target.nodeName.toLowerCase() != "input") return;
        if (target.disabled) return;

        var treeContainer = Dom.findUpward(target, {
            eval: function(n) {
                return n._tree;
            }
        });

        if (!treeContainer) return;

        var tree = treeContainer._tree;
        if ((target.checked && tree.options.propagateCheckActionDownwards)
                || (!target.checked && tree.options.propagateUncheckActionDownwards)) {
            var itemNode = target.parentNode.parentNode;
            setItemsCheckedRecursivelyFromNodes(getChildrenContainerFromItemNode(itemNode).childNodes, target.checked);
        }

        Dom.emitEvent("blur", treeContainer, {});

    }

    function setItemsCheckedRecursivelyFromNodes(nodes, checked) {
        for ( var i = 0; i < nodes.length; i++) {
            var node = nodes[i];
            node.childNodes[0].childNodes[1].checked = checked;
            var childContainer = getChildrenContainerFromItemNode(node);
            if (node.childLoaded) {
                setItemsCheckedRecursivelyFromNodes(childContainer.childNodes, checked);
            }
        }
    }
    function getChildrenContainerFromItemNode(itemNode) {
        return itemNode.childNodes[1];
    }

    function setExpandedClasses(itemNode, expanded) {
        Dom.removeClass(itemNode, expanded ? "Collapsed" : "Expanded");
        Dom.addClass(itemNode, !expanded ? "Collapsed" : "Expanded");

        Dom.removeClass(itemNode._titleElement, expanded ? "CollapsedTitle" : "ExpandedTitle");
        Dom.addClass(itemNode._titleElement, !expanded ? "CollapsedTitle" : "ExpandedTitle");

        Dom.removeClass(itemNode._childContainerElement, expanded ? "CollapsedChildren" : "ExpandedChildren");
        Dom.addClass(itemNode._childContainerElement, !expanded ? "CollapsedChildren" : "ExpandedChildren");
    }

    function Tree() {
        BaseWidget.call(this);
        this.container = this.node();

        this.container._tree = this;

        Dom.registerEvent(this.container, "click", treeClickHandler, false);
        Dom.registerEvent(this.container, "dblclick", treeDoubleClickHandler, false);
        Dom.registerEvent(this.container, "click", treeCheckBoxListener, false);
    }
    __extend(BaseWidget, Tree);

    Tree.prototype.setup = function (source, renderer, options) {
        this.source = source;
        this.renderer = renderer;
        this.options = options || {};

        this.onInitializing = true;
        this.init();
    };
    Tree.prototype.same = function(a, b) {
        if (this.options.same) return this.options.same(a, b);
        return a == b;
    };
    Tree.prototype.init = function(__callback) {
        Dom.addClass(this.container, "Tree");
        if (this.options.checkable) {
            Dom.addClass(this.container, "CheckableTree");
        }
        var fakeTitle = document.createElement("div");
        fakeTitle.style.display = "none";
        this.container.appendChild(fakeTitle);

        var div = document.createElement("div");
        Dom.addClass(div, "Children RootChildren");
        this.container.appendChild(div);
        this.rootChildrenContainer = div;
        this.uniqueName = "tree" + widget.random();

        var thiz = this;
        this.loadChildren(null, div, function() {
            if (thiz.options.expandedAll) {
                thiz.walk(function(item, node) {
                    thiz.ensureNodeExpanded(node);
                    return true;
                });
            }
            if (thiz.onInitializing) {
                thiz.onInitializing = false;
                if (thiz.options.onInitialized) thiz.options.onInitialized(thiz);
            }
            if (__callback) __callback();
        });
    };
    Tree.prototype.refresh = function(__callback) {
        var checkedItems = this.getCheckedItemsSync();
        var selectedItem = this.getSelectedItem();

        this.container.innerHTML = "";
        this.init(function () {
            this.setSelectedItem(selectedItem);
            this.setCheckedItems(checkedItems);
            if (__callback) __callback();
        }.bind(this));
    };


    Tree.prototype.rebuildItemNodeUI = function(oldItemNode, item) {
        var itemNode = this.buildItemNode(item);
        itemNode._item = item;
        var expanded = Dom.hasClass(oldItemNode, "Expanded");

        oldItemNode.parentNode.replaceChild(itemNode, oldItemNode);
        if (expanded) {
            this.loadChildren(item, getChildrenContainerFromItemNode(itemNode));
            itemNode.childLoaded = true;
            this.ensureNodeExpanded(itemNode);
        }
    };

    /*
    Tree.prototype.sort = function(item) {
        if (item.sort) return;
        if (item.children && item.children.length > 0) {
            item.children.sort(sortNameByAsc);

            for (var i = 0; i < item.children.length; i++) {
                if (item.children[i].children && item.children[i].children.length > 0) {
                    this.sort(item.children[i]);
                }
            }
        }
    };
    */

    Tree.prototype.loadChildren = function(parentItem, childrenContainer, callback) {
        Dom.addClass(childrenContainer, "Loading");
        var thiz = this;

        this.source(parentItem, function(children) {
            childrenContainer.innerHTML = "";
            if (!children) children = [];
            for ( var i = 0; i < children.length; i++) {
                var item = children[i];
                var itemNode = thiz.buildItemNode(item);
                childrenContainer.appendChild(itemNode);
                itemNode._item = item;

                if (i == children.length - 1) {
                    Dom.addClass(itemNode, "LastChild");
                    Dom.addClass(itemNode._titleElement, "LastChildTitle");
                }
            }

            if (children.length == 0) {
                var title = childrenContainer.parentNode.firstChild;
                if (title && Dom.hasClass(title, "Title")) {
                    Dom.addClass(title, "NoChild");
                }
            }

            Dom.removeClass(childrenContainer, "Loading");
            childrenContainer._items = children;

            if (callback) {
                callback(parentItem, childrenContainer, children);
            }
        });
    };

    function appendArray(source, dest) {
        for ( var i = 0; i < source.length; i++)
            dest.push(source[i]);
    }
    Tree.prototype.walk = function(visitor, tryRemaining) {
        var queue = [];
        appendArray(this.rootChildrenContainer.childNodes, queue);

        var thiz = this;
        var next = function() {
            if (queue.length <= 0) return;

            var node = queue.shift();
            var item = node._item;
            if (!visitor(item, node)) {
                if (tryRemaining) next();
                return;
            }

            var childContainer = getChildrenContainerFromItemNode(node);
            if (node.childLoaded) {
                appendArray(childContainer.childNodes, queue);
                next();
            } else {
                thiz.loadChildren(item, childContainer, function() {
                    node.childLoaded = true;
                    appendArray(childContainer.childNodes, queue);
                    next();
                });
            }
        };

        next();
    };

    Tree.prototype.setNodeAsChecked = function(itemNode, checked) {
        var checkbox = itemNode.childNodes[0].childNodes[1];
        checkbox.checked = checked;
    };
    Tree.prototype.setExpandedClasses = function(itemNode) {
        setExpandedClasses(itemNode, true);
    };
    Tree.prototype.ensureNodeExpanded = function(itemNode) {
        while (itemNode.parentNode && itemNode.parentNode.parentNode) {
            var p = itemNode.parentNode.parentNode;
            if (p.lastChild.tagName === "undefined") p.removeChild(p.lastChild);
            setExpandedClasses(p, true);
            itemNode = p;
            if (p._tree) break;
        }
    };

    Tree.prototype.setCheckedItems = function(items) {
        var remaining = items.slice(0);
        var thiz = this;

        this.walk(function(item, node) {
            var checkable = !thiz.options.isItemCheckable || thiz.options.isItemCheckable(item);
            var match = null;
            var index = -1;
            if (checkable) {
                for ( var i = 0; i < remaining.length; i++) {
                    if (thiz.same(item, remaining[i])) {
                        match = remaining[i];
                        index = i;
                        break;
                    }
                }
            }

            if (match != null) {
                thiz.setNodeAsChecked(node, true);
                thiz.ensureNodeExpanded(node);

                remaining.splice(index, 1);
            } else {
                thiz.setNodeAsChecked(node, false);
            }

            return true;
            // return remaining.length > 0;
        });
    };

    Tree.prototype.getCheckedItems = function(callback) {
        var checkedItems = [];
        var queue = [];
        appendArray(this.rootChildrenContainer.childNodes, queue);

        var thiz = this;
        var next = function() {
            if (queue.length <= 0) return;
            var node = queue.shift();
            var item = node._item;
            if (node.childNodes[0].childNodes[1].checked) checkedItems.push(item);

            var childContainer = getChildrenContainerFromItemNode(node);
            if (node.childLoaded) {
                appendArray(childContainer.childNodes, queue);
                next();
            }
        };

        next();
        if (callback) callback(checkedItems);
    };
    Tree.prototype.getCheckedItemsFromNodes = function(nodes) {
        var checkedItems = [];
        for ( var i = 0; i < nodes.length; i++) {
            var node = nodes[i];
            if (node.childNodes[0].childNodes[1].checked) checkedItems.push(node._item);

            var childContainer = getChildrenContainerFromItemNode(node);
            if (node.childLoaded) {
                checkedItems = checkedItems.concat(this.getCheckedItemsFromNodes(childContainer.childNodes));
            }
        }

        return checkedItems;

    };
    Tree.prototype.getCheckedItemsSync = function() {
        return this.getCheckedItemsFromNodes(this.rootChildrenContainer.childNodes);
    };

    Tree.prototype.buildItemNode = function(item) {
        var thiz = this;
        var id = "item" + widget.random();
        var className = "ItemText";
        var badgeValue = "";
        var isDisabled = true;
        if (this.options.badge && item.children.length == 0) {
            var badge = this.options.badge;
            for ( var i = 0; i < badge.length; i++) {
                if (badge[i].areaId == item.id) {
                    badgeValue = " (" + badge[i].number + ")";
                    isDisabled = false;
                    break;
                }
            }

            if (this.options.selectedAreaId && this.options.selectedAreaId == item.id) {
                className += " Selected";
            }

            if (isDisabled) {
                className += " Disabled";
            }
        }

        if (this.options.isItemSelectable && this.options.isItemSelectable(item)) {
            className += " SelectableItem";
        }

        var itemClass = "Item Collapsed";
        var holder = {};

        var itemNode = Dom.newDOMElement({
            _name: "div",
            "class": itemClass,
            _children: [ {
                _name: "hbox",
                "class": "Title CollapsedTitle",
                _id: "titleElement",
                _children: [ {
                    _name: "span",
                    "class": "Chevron",
                    _children: [ {
                        _name: "icon",
                        "class": "menu-right",
                    }]
                }, {
                    _name: "input",
                    "class": "Checkbox",
                    type: this.options.exclusive ? "radio" : "checkbox",
                    name: this.uniqueName,
                    id: id,
                }, {
                    _name: "div",
                    "class": className,
                    _html: "<label for=\"" + id + "\">" + this.renderer(item) + badgeValue + "</label>",
                } ]
            }, {
                _name: "div",
                "class": "Children CollapsedChildren",
                _id: "childContainerElement"
            } ]
        }, document, holder);

        itemNode._titleElement = holder.titleElement;
        itemNode._childContainerElement = holder.childContainerElement;

        var checkbox = itemNode._titleElement.firstChild.nextSibling;
        if (this.options.isItemCheckable) {
            if (!this.options.isItemCheckable(item)) {
                checkbox.setAttribute("disabled", "true");
            }
        }
        if (this.options.isForcedChecked && this.options.isForcedChecked(item)) {
            checkbox.setAttribute("checked", "true");
            checkbox.setAttribute("disabled", "true");
            Dom.addClass(checkbox, "ForcedChecked");
        }

        if (this.options.onItemNodeCreated) {
            this.options.onItemNodeCreated(itemNode, item);
        }

        return itemNode;
    };

    Tree.prototype.setOnItemClickListener = function(listener) {
        this.listener = listener;
        return this;
    };

    Tree.prototype.findParentItem = function (contextNode) {
        var thiz = this;
        var node = Dom.findUpward(contextNode, {
            eval: function (n) {
                return n._item || n == thiz.container;
            }
        });

        if (!node || !node._item) return null;

        node = Dom.findUpward(node.parentNode, {
            eval: function (n) {
                return n._item || n == thiz.container;
            }
        });

        if (node && node._item) return node._item;
        return null;
    };

    Tree.prototype.setSelectedItem = function(selectedItem) {
        var list = this.container.getElementsByClassName("ItemText");
        for ( var i = 0; i < list.length; i++) {
            var itemObject = Dom.findUpward(list[i], {
                eval: function(n) {
                    return n._item;
                }
            });

            if (itemObject && itemObject._item && this.options.same(itemObject._item, selectedItem)) {

                var itemText = itemObject.getElementsByClassName("ItemText")[0];
                if (itemText) {
                    Dom.addClass(itemText, "Selected");
                }

                if (this.listener) this.listener(itemObject._item);
            } else {
                Dom.removeClass(list[i], "Selected");
            }
        }
        this.emitChangeEvent();
    };

    Tree.prototype.emitChangeEvent = function () {
        Dom.emitEvent("p:SelectionChanged", this.container, {});
    };

    Tree.prototype.getSelectedItem = function() {
        var list = this.container.getElementsByClassName("ItemText");
        for ( var i = 0; i < list.length; i++) {
            var itemObject = Dom.findUpward(list[i], {
                eval: function(n) {
                    return n._item;
                }
            });

            if (itemObject && itemObject._item) {
                var itemText = itemObject.getElementsByClassName("ItemText")[0];
                if (itemText && Dom.hasClass(itemText, "Selected")) {
                    return itemObject._item;
                }
            }
        }
        return null;
    };

    Tree.prototype.refreshItemDisplay = function(validate, all) {
        var list = this.container.getElementsByClassName("ItemText");
        for ( var i = 0; i < list.length; i++) {
            var itemObject = Dom.findUpward(list[i], {
                eval: function(n) {
                    return n._item;
                }
            });

            if (!itemObject) continue;
            var item = itemObject._item;
            if (!validate(item)) continue;
            var label = Dom.findChild(list[i], {
                eval: function(n) {
                    return Dom.isTag(n, "label");
                }
            });

            if (label) {
                label.innerHTML = this.renderer(item);
            }

            if (!all) break;
        }
    };

    return Tree;
}();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/RepeaterView.js";

function RepeaterView(definitionNode) {
    BaseWidget.call(this, definitionNode);
    this.fakeItemCount = Dom.getAttributeAsInt(definitionNode, "fake-item-count", 0);
    this.itemTemplateMap = {};
}
__extend(BaseWidget, RepeaterView);

RepeaterView.prototype.buildDOMNode = function (definitionNode) {
    var nodeName = "hbox";
    if (definitionNode) {
        nodeName = definitionNode.getAttribute("tag") || nodeName;
    }

    return document.createElement(nodeName);
};
RepeaterView.prototype.setContentFragment = function (fragment) {
    var index = 1;
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node.getAttribute) continue;

        var role = node.getAttribute("role");
        if (role == "header") {
            this.headerTemplate = node;
        } else if (role == "footer") {
            this.footerTemplate = node;
        } else if (role == "empty") {
            this.emptyTemplate = node;
        } else {
            this.itemTemplate = node;
            this.itemTemplateMap[role] = node;
        }
    }
};

RepeaterView.prototype.onAttached = function () {
    Dom.emitEvent("p:onAttached", this.node());
};

RepeaterView.prototype.createBinding = function (container) {
    container._binding = {};
    container._binding._node = container;
    widget.Util.performAutoBinding(container, container._binding, null, "forced");

    Dom.doOnChildRecursively(container, {
        eval: function(n) {
            return n.getAttribute && n.getAttribute("anon-id");
        }
    }, function(n) {
        var id = n.getAttribute("anon-id");

        if (container._binding) {
            container._binding[id] = n;
        }
        n.removeAttribute("anon-id");

        var newId = id + widget.random();
        n.setAttribute("id", newId);
        n.id = newId;
        Dom.addClass(n, "AnonId_" + id);
    });
}


RepeaterView.prototype.generate = function (container, templateNode, data, index) {
    var node = templateNode.cloneNode(true);
    this.createBinding(node);

    container.appendChild(node);

    if (this.populator && typeof(data) != "undefined") this.populator(data, node._binding, node, index);
    node.setAttribute("data-index", index);

    node._repeaterData = data;

    return node;
};
RepeaterView.prototype.getItems = function() {
    return this.items;
}
RepeaterView.prototype.setItems = function (items, doneCallback) {
    this._prepareView();

    if (!items || items.length <= 0) {
        if (this.emptyTemplate) {
            Dom.empty(this.node());
            this._itemContainerNode = null;
            this.node().appendChild(this.generate(this.node(), this.emptyTemplate));
        }

        if (doneCallback && typeof(doneCallback) == "function") doneCallback.apply(this);
        return;
    }
    var container = this.node();
    if (this["content-wrapper-tag"]) {
        container = document.createElement(this["content-wrapper-tag"]);
        Dom.addClass(container, "ContentWrapper");

        this.node().appendChild(container);
    }

    this._itemContainerNode = container;

    this.appendItems(items);


    if (this.footerTemplate) {
        this.generate(this.node(), this.footerTemplate);
    }

    if (doneCallback && typeof(doneCallback) == "function") doneCallback.apply(this);
};

/* Renderer API - this is to support pagination via either standard or infinite scroll paginators*/
RepeaterView.prototype.withItemComparer = function (comparer) {};
RepeaterView.prototype.invalidateSelectionInfo = function () {};
RepeaterView.prototype.markAppending = function (appending) {
    Dom.toggleClass(this.node(), "RepeaterViewAppending", appending);
};
RepeaterView.prototype.withItemComparer = function () {};

RepeaterView.prototype.addListener = function (listener) {
    if (!this._listeners) {
        this._listeners = [];

        var thiz = this;
        function onScrolled() {
            var dy = thiz.getDistanceToEnd();
            thiz._listeners.forEach(function (listener) {
                if (typeof(listener.onVerticalScrolled) == "function") {
                    listener.onVerticalScrolled(dy);
                }
            })
        };
        this.node().addEventListener("scroll", onScrolled, false);
        if (this.scrollView && typeof(this.scrollView.node) == "function") {
            this.scrollView.node().addEventListener("p:VerticalScrolled", onScrolled, false);
        }
    }
    this._listeners.push(listener);
};
RepeaterView.prototype._prepareView = function () {
    this.items = [];
    Dom.empty(this.node());

    if (this.headerTemplate) {
        this.generate(this.node(), this.headerTemplate);
    }

    var container = this.node();
    if (this["content-wrapper-tag"]) {
        container = document.createElement(this["content-wrapper-tag"]);
        Dom.addClass(container, "ContentWrapper");

        this.node().appendChild(container);

        if (this.footerTemplate) {
            this.generate(this.node(), this.footerTemplate);
        }
    }

    this._itemContainerNode = container;
    // console.log("  _prepareView with container = ", container);
};
RepeaterView.prototype.appendItems = function (items) {
    // console.log("appendItems() called", this._itemContainerNode);
    if (this.onBeforeAppending) this.onBeforeAppending();

    var startIndex = this.items ? this.items.length : 0;
    this.items = (this.items || []).concat(items);

    if (!this._itemContainerNode) this._prepareView();
    var container = this._itemContainerNode;

    while (container.lastChild && container.lastChild._repeaterData && container.lastChild._repeaterData._fake) {
        container.removeChild(container.lastChild);
    }
    
    if (this.itemTemplate) {
        for (var i = 0; i < items.length; i ++) {
            var template = this.itemTemplate;
            if (this.getTemplateRoleForData) {
                var role = this.getTemplateRoleForData(items[i], startIndex + i);
                if (role && this.itemTemplateMap[role]) template = this.itemTemplateMap[role];
            }
            
            this.generate(container, template, items[i], startIndex + i);
        }

        if (this.fakeItemCount) {
            for (var i = 0; i < this.fakeItemCount; i ++) {
                var fakeData = {_fake: true};
                
                var template = this.itemTemplate;
                if (this.getTemplateRoleForData) {
                    var role = this.getTemplateRoleForData(fakeData, startIndex + items.length + i);
                    if (role && this.itemTemplateMap[role]) template = this.itemTemplateMap[role];
                }
                
                this.generate(container, template, fakeData, startIndex + items.length + i);
            }
        }
    }
    if (this.onAfterAppending) this.onAfterAppending();
};

RepeaterView.prototype.isNearEnd = function () {
    var dy = this.getDistanceToEnd();
    return dy < (this._nearEndGap || (20 * Util.em()));
};

RepeaterView.prototype.getDistanceToEnd = function () {
    if (this.scrollView && this.scrollView.getDistanceToEnd) {
        return this.scrollView.getDistanceToEnd();
    }
    
    var scrollPane = this.node();
    return Math.max(0, scrollPane.scrollHeight - (scrollPane.scrollTop + scrollPane.clientHeight));
};

RepeaterView.prototype.setScrollControl = function (scrollView) {
    this.scrollView = scrollView;
}

RepeaterView.prototype.reset = function (items) {
    // console.trace();
    // console.log("reset() called");
    this._prepareView();
    // console.log("   _prepareView() done.");
};


RepeaterView.prototype.deleteRow = function(contextNode) {
    var nodeContext = RepeaterView._getNodeContext(contextNode);
    if (!nodeContext) return null;

    if (this != nodeContext.instance) return;
    var next = nodeContext.row.nextElementSibling;
    while (next) {
        if (next.hasAttribute("data-index")) {
            var index = parseInt(next.getAttribute("data-index"), 10);
            next.setAttribute("data-index", index - 1);
        }

        next = next.nextElementSibling;
    }
    this.items.splice(nodeContext.index, 1);
    nodeContext.row.parentNode.removeChild(nodeContext.row);
};
RepeaterView._getNodeContext = function (node) {
    var repeater = RepeaterView.findInstanceFromNode(node);
    if (!repeater) return null;

    var row = Dom.findUpward(node, {
        eval: function (n) {
            return n.getAttribute && n.getAttribute("role") == "item";
        }
    });

    if (!row) return null;

    var index = parseInt(row.getAttribute("data-index"), 10);
    var data = repeater.items[index];

    return {
        instance: repeater,
        index: index,
        row: row,
        data: data
    };
};
RepeaterView.findInstanceFromNode = function (target) {
    var repeater = Dom.findUpward(target, {
        eval: function (n) {
            return n.__widget;
        }
    });

    if (!repeater) return null;

    return repeater.__widget;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DateTimePicker.js";

function DateTimePicker(n) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.withTimeInput = Dom.getAttributeAsBoolean(n, "with-time", false);
    this.useEndOfDay = Dom.getAttributeAsBoolean(n, "use-end-of-day", false);
    this.timezoneProviderName = Dom.getAttributeAsString(n, "timezone-provider", "local");
    this.useMonthYearMode = Dom.getAttributeAsBoolean(n, "use-month-year-mode", false);

    var formatName = Dom.getAttributeAsString(n, "format-name", this.withTimeInput ? "datetime_standard" :
    this.useMonthYearMode ? "monthyear" : "date_standard");
    this.format = Dom.getAttributeAsString(n, "format", DATE_FORMATS[formatName].format);

    this.showTimezone = Dom.getAttributeAsBoolean(n, "show-timezone", undefined);
    this.multiSelect = Dom.getAttributeAsBoolean(n, "multi-select", false);
    this.useExplicitCommitActions = Dom.getAttributeAsBoolean(n, "explicit-commit", false);
    Dom.setInnerText(this.commitButton, Dom.getAttributeAsString(n, "explicit-commit-action", "Select"));

    this.selectedDates = [];

    this.timezoneProvider = TimezoneProviders[this.timezoneProviderName] || TimezoneProviders.auto;

    this.pickerPopup.setPopupClass("DateTimePickerPopup" + (this.useMonthYearMode ? " InMonthYearMode" : "") + (this.useExplicitCommitActions ? " WithExplicitCommitActions" : "") + (Util.linux ? " LinuxOS" : ""));

    Dom.toggleClass(this.timezoneInfoPane, "ExplicitTimezone", !this._shouldShowTimezone());

    this._popupAnchor = this.node();
    if (n) {
        this._popupAnchor = n.popupAnchor || n.pickerUIElement || this._popupAnchor;
    }

    this.bind("click", this._showPicker, (n && n.pickerUIElement) ? n.pickerUIElement : this.pickerButton);

    this.bind("click", function () {
        var m = this.month - 1;
        var y = this.year;
        if (m < 0) {
            m = 11;
            y --;
        }

        this.gotoMonth(m, y);
    }, this.prevMonthButton);
    this.bind("click", function () {
        var m = this.month + 1;
        var y = this.year;
        if (m > 11) {
            m = 0;
            y ++;
        }

        this.gotoMonth(m, y);
    }, this.nextMonthButton);
    this.bind("click", function (event) {
        var n = Dom.findUpwardForNodeWithData(event.target, "_data");
        var m = this._getMomentFromData(n._data);

        if (!this.isInRange(m)) return;
        if (this.isMultiSelect()) {
            this._toggleMoment(m, "fromUserInput");
        } else {
            if (this.withTime() || this.useExplicitCommitActions) {
                this.lastSelectedData = n._data;
                this.invalidate();
                this.updateTimezoneLabel();
            } else {
                this._setMoment(m, "fromUserInput");
                this.pickerPopup.hide();
            }
        }
    }, this.dayGrid);


    this.bind("p:PopupShown", function () {
        this.header.setAttribute("active", true);
    }, this.monthInput);
    this.bind("p:PopupHidden", function () {
        this.header.removeAttribute("active");
    }, this.monthInput);

    this.bind("focus", function () {
        this.header.setAttribute("focused", true);
    }, this.yearInput);
    this.bind("blur", function () {
        this.header.removeAttribute("focused");
    }, this.yearInput);


    this.bind("focus", function () {
        this.header.setAttribute("focused", true);
    }, this.monthInput.node());
    this.bind("blur", function () {
        this.header.removeAttribute("focused");
    }, this.monthInput.node());

    this.bind("keypress", function (event) {
        if (this.pendingYearInputTimeout) window.clearTimeout(this.pendingYearInputTimeout);
        this.pendingYearInputTimeout = window.setTimeout(function () {
            this.gotoMonth(this.month, parseInt(this.yearInput.value, 10));
        }.bind(this), 300);
    }, this.yearInput);

    this.monthInput.comparer = Util.sameRelax;
    this.monthInput.renderer = function (m) {
        return moment.months()[m];
    };
    var months = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
    this.monthInput.setItems(months);

    if (this.useMonthYearMode) {

        this.monthGrid.innerHTML = "";
        var row = undefined;
        this.monthElements = [];
        for (var i = 0; i < months.length; i ++) {
            if (!row || i % 3 == 0) {
                row = document.createElement("hbox");
                this.monthGrid.appendChild(row);
            }
            var monthName = (i + 1);
            var span = document.createElement("span");
            span.setAttribute("title", moment.months()[i]);
            span._month = i;
            span.innerHTML = Dom.htmlEncode(monthName);
            this.monthElements.push(span);
            row.appendChild(span);
        }

        this.bind("click", function (event) {
            var n = Dom.findUpwardForNodeWithData(event.target, "_month");
            if (!n) return;
            var selectedMonth = n._month;

            var m = this._getLastSelectedMoment() || this._getDefaultMoment();
            var year = parseInt(this.yearInput.value, 10);
            m.set("month", selectedMonth);
            m.set("date", 1);

            if (year && !isNaN(year)) {
                m.set("year", year);
            }
            this._setMoment(m, "fromUserInput");
            this.pickerPopup.hide();
        }, this.monthGrid);

        this.bind("click", function () {
            var m = this.month;
            var y = this.year -1;
            if (y < 0) y = 0;
            this.gotoMonth(m, y);

            var m = this._getLastSelectedMoment() || this._getDefaultMoment();
            m.set("year", y);
            this._setMoment(m, "fromUserInput");

        }, this.prevYearButton);
        this.bind("click", function () {
            var m = this.month;
            var y = this.year + 1;
            this.gotoMonth(m, y);

            var m = this._getLastSelectedMoment() || this._getDefaultMoment();
            m.set("year", y);
            this._setMoment(m, "fromUserInput");

        }, this.nextYearButton);

    }
    this.bind("p:ItemSelected", function (ev) {
        if (!ev.fromUser) return;
        this.gotoMonth(this.monthInput.getSelectedItem(), this.year);
        // this.monthInput.node().focus();
    }, this.monthInput);

    this.firstWeekDay = 0;

    for (var i = 0; i < 7; i ++) {
        var wd = (i + this.firstWeekDay) % 7;
        var span = document.createElement("span");
        span.innerHTML = Dom.htmlEncode(moment.weekdaysShort(wd));
        this.weakDayRow.appendChild(span);
        span.setAttribute("flex", "1");
        span.setAttribute("wd", "" + wd);
        span._weekDay = wd;
    }

    this.days = [];
    for (var k = 0; k < 6; k ++) {
        var row = document.createElement("hbox");
        this.dayGrid.appendChild(row);
        for (var i = 0; i < 7; i ++) {
            var wd = (i + this.firstWeekDay) % 7;

            var span = document.createElement("span");
            span.innerHTML = "" + (k * 7 + i + 1);
            span.setAttribute("flex", "1");
            span._weekDay = i;
            span._dayIndex = k * 7 + i;
            span.setAttribute("wd", "" + wd);
            row.appendChild(span);

            this.days.push(span);
        }
    }

    this.amInput.renderer = function (s) {
        return s.toUpperCase();
    };
    this.amInput.comparer = Util.sameRelax;
    this.amInput.setItems(["am", "pm"]);

    var commitChange = function () {
        var m = this._getLastSelectedMoment();
        if (!this.isInRange(m)) return;

        this._setMoment(m, "fromUserInput");
        this.pickerPopup.hide();
    };

    this.bind("click", commitChange, this.selectButton);
    this.bind("click", commitChange, this.commitButton);
    this.bind("click", function () {
        this.pickerPopup.hide();
    }, this.cancelButton);

    this.bind("input", function () {
        this.updateTimezoneLabel();
    }, this.timeRow);
    this.bind("p:ItemSelected", function () {
        this.updateTimezoneLabel();
    }, this.timeRow);
    this.bind("p:Input", function () {
        this.updateTimezoneLabel();
    }, this.timeRow);
    this.validationRules = this.getValidationRuleSet();
    this.bind("keyup", this._handleInputKeyupEvent, this.input);
    this.bind("change", function () {
        console.log("!@# value change");
        Dom.emitEvent("p:ValueUpdated", this.node(), {});
    }, this.input);
}

__extend(BaseTemplatedWidget, DateTimePicker);

DateTimePicker.prototype.getValidationUITarget = function () {
    return this.input;
};
DateTimePicker.prototype.getFocusNode = function () {
    return this.input;
};

DateTimePicker.prototype._getDefaultMoment = function () {
    return moment.tz(this.getTZID());
};

DateTimePicker.prototype._showPicker = function () {
    var m = this._getMoment() || this._getDefaultMoment();
    if (this.isMultiSelect()) {
        this.selectedDates = this._getMoments();
        if (this.selectedDates && this.selectedDates.length > 0) {
            m = this.selectedDates[0];
        } else {
            this.selectedDates = [];
        }
    }

    this.lastSelectedData = this._getMoment() ? {
        year: m.year(),
        month: m.month(),
        date: m.date()
    } : null;
    this.gotoMonth(m.month(), m.year());

    if (this.withTime()) {
        this.hourInput.value = m.format(this.use24h() ? "HH" : "hh");
        this.minuteInput.value = m.format("mm");
        this.secondInput.value = m.format("ss");
        if (!this.use24h()) {
            this.amInput.selectItem(m.format("a"));
        }
    }

    Dom.toggleClass(this.timeRow, "Disabled", !this.withTime());
    Dom.toggleClass(this.timeRow, "WithoutMinute", !this.withMinute());
    Dom.toggleClass(this.timeRow, "WithoutSecond", !this.withSecond());
    Dom.toggleClass(this.timeRow, "Use24H", this.use24h());

    if (!this.inputConfigured) {
        Util.enforceNumberInput(this.hourInput, true, 0, this.use24h() ? 23 : 12, 2);
        Util.enforceNumberInput(this.minuteInput, true, 0, 59, 2);
        Util.enforceNumberInput(this.secondInput, true, 0, 59, 2);
        Util.enforceNumberInput(this.yearInput, true, 0, 5000, 4);
        this.inputConfigured = true;
    }

    this.updateTimezoneLabel();
    this.invalidate();
    this.pickerPopup.toggle(this._popupAnchor, "left-inside", "bottom", 0, 5, "autoFlip");
};

DateTimePicker.prototype.getTZID = function () {
    return this.timezoneProvider.getTimezoneId();
};
DateTimePicker.prototype._shouldShowTimezone = function () {
    if (typeof(this.showTimezone) == "undefined") {
        return !this.timezoneProvider.isImplicit || !this.timezoneProvider.isImplicit();
    } else {
        return this.showTimezone;
    }
};
DateTimePicker.prototype.onDetached = function() {
    if (this.pickerPopup) {
        this.pickerPopup.kill();
    }
};
DateTimePicker.prototype.updateTimezoneLabel = function () {
    this.timezoneLabel.innerHTML = this.getTimezoneTextInfo();
};
DateTimePicker.prototype.getTimezoneTextInfo = function () {
    var m = null;
    if (this.lastSelectedData) {
        m = this._getMomentFromData(this.lastSelectedData);
    }

    var zone = moment.tz.zone(this.getTZID());
    var offset = Math.round((0 - zone.offset(m || this.getDate() || new Date())) / 60);
    if (offset > 0) {
        offset = " (GMT<strong>+" + offset + "</strong>)";
    } else if (offset < 0) {
        offset = " (GMT<strong>" + offset + "</strong>)";
    } else {
        offset = "";
    }
    return Dom.htmlEncode(this.timezoneProvider.getName()) + ": " + (zone.name + offset);

};
DateTimePicker.prototype.focus = function () {
    this.input.focus();
};
DateTimePicker.prototype.withTime = function () {
    return this.withTimeInput;
};
DateTimePicker.prototype.use24h = function () {
    return this.getFormat().indexOf("H") >= 0;
};
DateTimePicker.prototype.withMinute = function () {
    return this.getFormat().indexOf("m") >= 0;
};
DateTimePicker.prototype.withSecond = function () {
    return this.getFormat().indexOf("s") >= 0;
};

DateTimePicker.prototype.gotoMonth = function (month, year) {
    this.month = month;
    this.year = year;
    this.invalidate();
};
DateTimePicker.prototype.getFormat = function () {
    var javaFormat = this.format || DateTimePicker.GLOBAL_FORMAT || (this.withTime() ? DateTimePicker.DEFAULT_DATE_TIME_FORMAT :
    (this.useMonthYearMode ? DateTimePicker.DEFAULT_MONTH_YEAR_FORMAT : DateTimePicker.DEFAULT_DATE_FORMAT));
    var momentFormat = FormatUtil.javaToMomentFormat(javaFormat);

    return momentFormat;
};
DateTimePicker.prototype._handleInputKeyupEvent = function (event) {
    ValidationManager.run(this.validationRules);
    if (event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN) {
        var m = this._getMoment();
        if (m)  {
            Dom.emitEvent("p:ValueUpdated", this.node(), {});
        }
    }
};
DateTimePicker.prototype._getMoment = function (s) {
    if (this._valueTarget) {
        return moment.tz(this._valueTarget.getDate(), this.getTZID());
    }

    var dateString = this.input.value;
    if(s) dateString = s;
    var format = this.getFormat();
    var m = moment.tz(dateString, format, this.getTZID());
    if (!m.isValid()) return null;
    if (this.withTime()) return m;
    return this.useEndOfDay ? m.endOf("day") : m.startOf("day");
};
DateTimePicker.prototype.getDate = function () {
    var m = this._getMoment();
    if (!m || !this.isInRange(m)) return null;
    return m.toDate();
};
DateTimePicker.prototype._getMomentFromData = function (data) {
    var spec = null;

    if (this.withTime()) {
        var hour = parseInt(this.hourInput.value, 10);
        if (!this.use24h()) {
            if (hour < 0 || hour > 12) hour = 0;
            if (this.amInput.getSelectedItem() == "pm") {
                if (hour < 12) hour += 12;  //12:30 PM --> 12:30
            } else {
                if (hour >= 12) hour -= 12; // 12:30 AM --> 00:30
            }
        }

        spec = {
            year: data.year,
            month: data.month,
            date: data.date,
            hour: hour,
            minute: this.withMinute() ? parseInt(this.minuteInput.value, 10) % 60 : 0,
            second: this.withSecond() ? parseInt(this.secondInput.value, 10) % 60 : 0,
            milisecond: 0
        };

    } else {
        spec = {
            year: data.year,
            month: data.month,
            date: data.date,
            hour: this.useEndOfDay ? 23 : 0,
            minute: this.useEndOfDay ? 59 : 0,
            second: this.useEndOfDay ? 59 : 0,
            milisecond: this.useEndOfDay ? 999 : 0
        };
    }

    return moment.tz(
        spec,
        this.getTZID());
};
DateTimePicker.prototype._getLastSelectedMoment = function () {
    if (!this.lastSelectedData) return null;

    return this._getMomentFromData(this.lastSelectedData);
};
DateTimePicker.prototype.invalidate = function () {
    if (this.invalidating) return;
    this.invalidating = true;

    var m = moment.tz({year: this.year, month: this.month, date: 1, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    var padding = (m.day() - this.firstWeekDay + 7) % 7;
    m.subtract(padding, "days");

    var current = this._getLastSelectedMoment() || this._getMoment();
    var today = moment.tz(this.getTZID());
    var currentMonth = m.month();
    if (!this.useMonthYearMode) {
        for (var i = 0; i < this.days.length; i ++) {
            var span = this.days[i];
            span.innerHTML = m.date();
            span._data = {
                year: m.year(),
                month: m.month(),
                date: m.date()
            };

            Dom.toggleClass(span, "Inactive", m.month() != this.month);
            var isCurrent = current != null && current.isSame(m, "day");
            Dom.toggleClass(span, "Current", isCurrent);
            Dom.toggleClass(span, "Today", today.isSame(m, "day"));
            Dom.toggleClass(span, "OutOfRange", !this.isInRange(m));
            if (this.isMultiSelect()) {
                var index = this._getIndexOfDateInArray(this.selectedDates, m);
                if (index >= 0) {
                    Dom.addClass(span, "Current");
                } else {
                    Dom.removeClass(span, "Current");
                }
            }
            m = m.add(1, "days");
        }
    }
    this.monthInput.selectItem(this.month);
    this.monthDisplay.innerHTML = Dom.htmlEncode(this.monthInput.renderer(this.month)) + " " + this.year;

    this.yearInput.value = "" + this.year;

    if (this.useMonthYearMode) {
        for (var i = 0; i < this.monthElements.length; i ++) {
            var span = this.monthElements[i];
            Dom.toggleClass(span, "Selected", span._month == this.month);
        }
    }
    this.invalidating = false;
};
DateTimePicker.prototype.isInRange = function(momentDate) {
    if (!momentDate) return false;
    var disabledDate = this.getDisabledDate();
    
    if (disabledDate && disabledDate[momentDate.valueOf()]) return false;
    
    
    var inRange = false;
    if (!this._minDate && !this._maxDate) {
        inRange = true;
    } else if (this._minDate && this._maxDate) {
        inRange = momentDate.valueOf() >= this._minDate.valueOf() && momentDate.valueOf() <= this._maxDate.valueOf();
    } else if (this._minDate) {
        inRange = momentDate.valueOf() >= this._minDate.valueOf();
    } else {
        inRange = momentDate.valueOf() <= this._maxDate.valueOf();
    }
    return inRange;
}
DateTimePicker.prototype.setDate = function (date) {
    if (date) {
        this.input.value = moment.tz(date, this.getTZID()).format(this.getFormat());
    } else {
        this.input.value = "";
    }

    try {
        ValidationManager.run(this.validationRules);
    } catch (e) {}
};
DateTimePicker.prototype.setDates = function (dates) {
    if (dates && dates.length > 0) {
        var s = [];
        for (var i = 0; i < dates.length; i ++) {
            s.push(moment.tz(dates[i], this.getTZID()).format(this.getFormat()))
        }
        this.input.value = s.join(", ");
    } else {
        this.input.value = "";
    }
};
DateTimePicker.prototype.setEnabled = function(enable) {
    Dom.setEnabled(enable, this.input);
    Dom.setEnabled(enable, this.pickerButton);
}
DateTimePicker.prototype.setMinDate = function(date) {
    if (!date){
        delete this._minDate;
        this.invalidate();
        return;
    }
    this._minDate = moment(date);
    this.invalidate();
}
DateTimePicker.prototype.setMaxDate = function(date) {
    if (!date) {
        delete this._maxDate;
        this.invalidate();
        return;
    }
    this._maxDate = moment(date);
    this.invalidate();
}
DateTimePicker.prototype._setMoment = function (m, fromUserInput) {

    if (this._valueTarget) {
        this._valueTarget.setDate(m ? m.toDate() : null);
        return;
    }

    if (m) {
        this.input.value = m.format(this.getFormat());
    } else {
        this.input.value = "";
    }
    if (fromUserInput) Dom.emitEvent("p:ValueUpdated", this.node(), {});
    ValidationManager.run(this.validationRules);
};

DateTimePicker.DEFAULT_DATE_FORMAT = "MM/DD/YYYY";
DateTimePicker.DEFAULT_DATE_TIME_FORMAT = "MM/DD/YYYY HH:mm";
DateTimePicker.DEFAULT_MONTH_YEAR_FORMAT = "MM/YYYY";

DateTimePicker.getDateFormat = function () {
    return (window.LOCALE && window.LOCALE.DATE_FORMAT) || window.DATE_FORMAT || DateTimePicker.DEFAULT_DATE_FORMAT;
};
DateTimePicker.getDateTimeFormat = function () {
    return (window.LOCALE && window.LOCALE.DATETIME_FORMAT) || window.DATETIME_FORMAT || DateTimePicker.DEFAULT_DATE_TIME_FORMAT;
};
DateTimePicker.getMonthYearFormat = function () {
    return (window.LOCALE && window.LOCALE.MONTH_YEAR_FORMAT) || window.MONTH_YEAR_FORMAT || DateTimePicker.MONTH_YEAR_FORMAT;
};
DateTimePicker.prototype.setCustomTimezoneProvider = function (provider) {
    this.timezoneProvider = provider;
    Dom.toggleClass(this.timezoneInfoPane, "ExplicitTimezone", !this._shouldShowTimezone());
};
DateTimePicker.prototype.isMultiSelect = function () {
    return this.multiSelect;
};
DateTimePicker.prototype._toggleMoment = function (m, fromUserInput) {
    if (m) {
        var index = this._getIndexOfDateInArray(this.selectedDates, m);
        if (index < 0) {
            this.selectedDates.push(m);
        } else {
            this.selectedDates.splice(index, 1);
        }
        var names = [];
        if (this.selectedDates.length > 0) {
            for (var i = 0; i < this.selectedDates.length; i++) {
                names.push(this.selectedDates[i].format(this.getFormat()))
            }
        }
        this.input.value = names.join(",");
        this.gotoMonth(m.month(), m.year());
    }
    if (fromUserInput) Dom.emitEvent("p:ValueUpdated", this.node(), {});
};
DateTimePicker.prototype._getMoments = function () {
    if(!this.input.value) return;
    var s = this.input.value.trim().split(",");
    if(s.length == 0) return;
    var format = this.getFormat();
    var res = [];
    for(var i = 0; i < s.length; i ++) {
        if (!s[i]) continue;
        var m = this._getMoment(s[i]);
        if (m) res.push(m);
    }
    return res;
};

DateTimePicker.prototype._getIndexOfDateInArray = function(arr, m) {
    if(!arr) return -1;
    if(arr.length == 0) return -1;
    var index = -1;
    for(var i = 0; i < arr.length; i++) {
        if(m.isSame(arr[i], "day")) {
            index = i;
            break;
        }
    }
    return index;
};

DateTimePicker.prototype.getDates = function () {
    var res = [];
    if (this.isMultiSelect()) {
        var m = this._getMoments();
        if (m && m.length > 0) {
            for (var i = 0; i < m.length; i++) {
                res.push(m[i].toDate());
            }
        }
    }
    return res;
};

DateTimePicker.prototype.getValidationRuleSet = function () {
    var thiz = this;
    return new RuleSet()
        .live(true)
        .rule(new GenericRule(this.input, function () {
            var format = thiz.getFormat();
            if (thiz._valueTarget) {
                var m = moment(thiz._valueTarget.getDate(), format, true).tz(thiz.getTZID());
                return m && m.isValid();
            }

            function isDateStringValid(dateString, format) {
                if (dateString.length == 0) return true;
                var m = moment(dateString, format, true).tz(thiz.getTZID());
                return m && m.isValid();
            };

            if (thiz.isMultiSelect()) {
                var s = thiz.input.value.trim().split(",");
                if (s.length == 0) return true;
                for (var i = 0; i < s.length; i ++) {
                    if (!isDateStringValid(s[i].trim(), format)) return false;
                }
            } else {
                return isDateStringValid(thiz.input.value.trim(), format);
            }

            return true;

        }, "Please select a valid " + (this.useMonthYearMode ? "month year." : "date.")));
};

DateTimePicker.prototype.getDisabledDate = function () {
    return null;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/NamedDateTimePicker.js";

function NamedDateTimePicker(n) {
    DateTimePicker.call(this, n);
    this._specificDateLabel = Dom.getAttributeAsString(n, "specific-date-label", "Specific Date:");

    this.pickerPopup.setPopupClass("NamedDateTimePickerPopup");

    var _radioGroupName = "NamedDateTimePicker_Radio_" + Util.newUUID();
    this.optionRepeaterView.populator = function (data, binding, node, index) {
        binding._node._data = data;
        Dom.setInnerText(binding.optionLabel, data.label);
        binding.radio.setAttribute("name", _radioGroupName);
    };

    this.bind("click", this._handleOptionClick, this.optionRepeaterView);
}

__extend(DateTimePicker, NamedDateTimePicker);
NamedDateTimePicker.prototype.setNamedOptions = function (namedOptions) {
    this.namedOptions = namedOptions || [];

    var options = this.namedOptions.concat({
        name: null,
        label: this._specificDateLabel
    });

    this.optionRepeaterView.setItems(options);
};

NamedDateTimePicker.prototype._showPicker = function () {
    DateTimePicker.prototype._showPicker.call(this);
};

NamedDateTimePicker.prototype._handleOptionClick = function (e) {
    if (!e.target.nodeName || e.target.nodeName.toLowerCase() != "input") return;
    var option = Dom.findUpwardForData(e.target, "_data");
    if (!option) return;

    Dom.toggleClass(this.pickerPopup.popupContainer, "WithSpecificDate", option.name ? false : true);

    var date = option.name ? null : new Date();

    DateTimePicker.prototype.setDate.call(this, date);

    this.lastSelectedData = null;
    
    if (date) {
        var m = moment.tz(date, this.getTZID());
        this.lastSelectedData = {
            year: m.year(),
            month: m.month(),
            date: m.date()
        };
    }
    
    this._lastSelectedOptionName = option.name;
    this.invalidate();
    if (!date) {
        this.input.value = option.label;
        this.pickerPopup.hide();
    }
    Dom.emitEvent("p:ValueUpdated", this.node(), {});
};
NamedDateTimePicker.prototype.getDate = function () {
    if (this._lastSelectedOptionName != null) return this._lastSelectedOptionName;

    return DateTimePicker.prototype.getDate.call(this);
};
NamedDateTimePicker.prototype.setDate = function (date) {
    var thiz = this;
    if (!date || (typeof(date) == "object" && typeof(date.getTime) == "function")) {
        this._lastSelectedOptionName = null;
        DateTimePicker.prototype.setDate.call(this, date);
        Array.prototype.forEach.call(this.optionRepeaterView.node().querySelectorAll("label.Item"), function (label) {
            if (label._data && !label._data.name) {
                label.querySelector("input").checked = true;
            }
        });
        Dom.addClass(thiz.pickerPopup.popupContainer, "WithSpecificDate");
    } else if (typeof(date) == "string") {
        var found = false;
        Array.prototype.forEach.call(this.optionRepeaterView.node().querySelectorAll("label.Item"), function (label) {
            if (label._data && label._data.name == date) {
                found = true;
                console.log("Setting as null");
                thiz.lastSelectedData = null;
                thiz._lastSelectedOptionName = label._data.name;
                thiz.invalidate();

                label.querySelector("input").checked = true;
                thiz.input.value = label._data.label;
                Dom.removeClass(thiz.pickerPopup.popupContainer, "WithSpecificDate");
            }
        });

        if (!found) throw new Error("Invalid option name: " + date);
    } else {
        throw new Error("Invalidae date " + date);
    }
};

NamedDateTimePicker.prototype._setMoment = function (m, fromUserInput) {
    if (fromUserInput) {
        Array.prototype.forEach.call(this.optionRepeaterView.node().querySelectorAll("label.Item"), function (label) {
            if (label._data && !label._data.name) {
                label.querySelector("input").checked = true;
            }
        });

        this._lastSelectedOptionName = null;
    }
    DateTimePicker.prototype._setMoment.call(this, m, fromUserInput);
};
NamedDateTimePicker.prototype._getMoment = function () {
    return this._lastSelectedOptionName ? null : DateTimePicker.prototype._getMoment.call(this);
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DateTimeRangePicker.js";

function DateTimeRangePicker(n) {
    ComboManager.call(this);

    this.popup.setPopupClass("DateRangePickerPopup");

    this._node = n;
    this.withTimeInput = Dom.getAttributeAsBoolean(n, "with-time", false);
    this.useEndOfDay = Dom.getAttributeAsBoolean(n, "use-end-of-day", false);
    this.timezoneProviderName = Dom.getAttributeAsString(n, "timezone-provider", "local");
    this.useMonthYearMode = Dom.getAttributeAsBoolean(n, "use-month-year-mode", false);
    this.multiRangeMode = Dom.getAttributeAsBoolean(n, "multi-range-mode", false);

    Dom.toggleClass(this.rangeModeSelectionContainer, "Enabled", this.multiRangeMode);
    if (this.multiRangeMode && this.useMonthYearMode) this.monthYearModeCheckbox.checked = true;

    var thiz = this;
    this.renderer = function (item) {
        if (item) return thiz.customTitle ? `${thiz.customTitle} ${item.title}` : item.title;

        var from = thiz.fromDatePicker.getDate();
        var to = thiz.toDatePicker.getDate();

        if (from && to) {
            return moment.tz(from, thiz.fromDatePicker.getTZID()).format(thiz.fromDatePicker.getFormat()) + " - "
             + moment.tz(to, thiz.toDatePicker.getTZID()).format(thiz.toDatePicker.getFormat());
        } else if (from) {
            return "from " + moment.tz(from, thiz.fromDatePicker.getTZID()).format(thiz.fromDatePicker.getFormat());
        } else if (to) {
            return "to " + moment.tz(to, thiz.toDatePicker.getTZID()).format(thiz.toDatePicker.getFormat());
        }

        return "Custom Range...";
    };
    this.comparer = function (a, b) {
        return (!a && !b) || a.key == b.key;
    };

    this.setItems(DateTimeRangePicker.OPTIONS);

    this._setupCustomRange();

    this.updateTimezoneLabel();

    this.bind("click", function (e) {
        if (!ValidationManager.run(this.getValidationRuleSet())) return;

        this.from = this.fromDatePicker.getDate();
        this.to = this.toDatePicker.getDate();
        if (this.multiRangeMode && this.monthYearModeCheckbox.checked) {
            if (this.from) this.from = moment.tz(this.from, this.fromDatePicker.getTZID()).startOf('month');
            if (this.to) this.to = moment.tz(this.to, this.toDatePicker.getTZID()).endOf('month');
        }

        if (this.from || this.to) {
            this.selectItem(null, true);
        } else {
            this.selectItemByKey("key", "all", true);
        }

        this.popup.hide();
        Dom.emitEvent("p:ValueUpdated", this.node(), {});
    }, this.goButton);

    this.bind("click", function () {
        this.useMonthYearMode = this.monthYearModeCheckbox.checked;
        var from = this.fromDatePicker.getDate();
        var to = this.toDatePicker.getDate();
        this._setupCustomRange();
        if (from) this.fromDatePicker.setDate(from);
        if (to) this.toDatePicker.setDate(to);
    }, this.rangeModeSelectionContainer);
}

__extend(ComboManager, DateTimeRangePicker);

DateTimeRangePicker.OPTIONS_ALL_TIME_KEY = "all";
DateTimeRangePicker.OPTIONS_TODAY_KEY = "today";
DateTimeRangePicker.OPTIONS_LAST_7_DAYS = "last7Days";
DateTimeRangePicker.OPTIONS_THIS_MONTH_KEY = "thisMonth";
DateTimeRangePicker.OPTIONS_LAST_MONTH = "lastMonth";
DateTimeRangePicker.OPTIONS_LAST_1_MONTH = "last1Month";
DateTimeRangePicker.OPTIONS_LAST_3_MONTHS = "last3Months";
DateTimeRangePicker.OPTIONS_THIS_YEAR = "thisYear";
DateTimeRangePicker.OPTIONS_NEXT_7_DAYS = "next7Days";
DateTimeRangePicker.OPTIONS_NEXT_MONTH = "nextMonth";
DateTimeRangePicker.OPTIONS_NEXT_1_MONTH = "next1Month";

DateTimeRangePicker.OPTIONS_MAP = {};

[
    {key: DateTimeRangePicker.OPTIONS_TODAY_KEY, title: "Today"},
    {key: DateTimeRangePicker.OPTIONS_LAST_7_DAYS, title: "Last 7 Days"},
    {key: DateTimeRangePicker.OPTIONS_THIS_MONTH_KEY, title: "This Month"},
    {key: DateTimeRangePicker.OPTIONS_LAST_MONTH, title: "Last Month"},
    {key: DateTimeRangePicker.OPTIONS_LAST_1_MONTH, title: "Last 30 Days"},
    {key: DateTimeRangePicker.OPTIONS_LAST_3_MONTHS, title: "Last 90 Days"},
    {key: DateTimeRangePicker.OPTIONS_THIS_YEAR, title: "This Year"},
    {key: DateTimeRangePicker.OPTIONS_NEXT_7_DAYS, title: "Next 7 Days"},
    {key: DateTimeRangePicker.OPTIONS_NEXT_MONTH, title: "Next Month"},
    {key: DateTimeRangePicker.OPTIONS_NEXT_1_MONTH, title: "Next 30 Days"},
    {key: DateTimeRangePicker.OPTIONS_ALL_TIME_KEY, title: "Lifetime"}
].forEach((option, i) => {
    DateTimeRangePicker.OPTIONS_MAP[option.key] = option;
});

DateTimeRangePicker.getDateTimeOptionsByKeys = function (keys) {
    var options = [];
    keys.forEach((key, i) => {
        var o = DateTimeRangePicker.OPTIONS_MAP[key];
        if (o) options.push(o);
    });
    
    return options;
};

DateTimeRangePicker.OPTIONS = DateTimeRangePicker.getDateTimeOptionsByKeys([
    DateTimeRangePicker.OPTIONS_TODAY_KEY,
    DateTimeRangePicker.OPTIONS_LAST_7_DAYS,
    DateTimeRangePicker.OPTIONS_THIS_MONTH_KEY,
    DateTimeRangePicker.OPTIONS_LAST_MONTH,
    DateTimeRangePicker.OPTIONS_LAST_1_MONTH,
    DateTimeRangePicker.OPTIONS_LAST_3_MONTHS,
    DateTimeRangePicker.OPTIONS_THIS_YEAR,
    DateTimeRangePicker.OPTIONS_ALL_TIME_KEY
]);

DateTimeRangePicker.prototype._setupCustomRange = function () {
    var formatName = Dom.getAttributeAsString(this._node, "format-name", this.withTimeInput ? "datetime_standard" :
    this.useMonthYearMode ? "monthyear" : "date_standard");
    this.format = Dom.getAttributeAsString(this._node, "format", DATE_FORMATS[formatName].format);
    this.providedFormatName = formatName;

    this.fromDatePickerContainer.innerHTML = "";
    this.fromDatePicker = new DateTimePicker({
        "with-time": false,
        "use-end-of-day": false,
        "timezone-provider": this.timezoneProviderName,
        "format-name": this.providedFormatName,
        "use-month-year-mode": this.useMonthYearMode
    }).into(this.fromDatePickerContainer);

    this.toDatePickerContainer.innerHTML = "";
    this.toDatePicker = new DateTimePicker({
        "with-time": false,
        "use-end-of-day": this.useEndOfDay,
        "timezone-provider": this.timezoneProviderName,
        "format-name": this.providedFormatName,
        "use-month-year-mode": this.useMonthYearMode
    }).into(this.toDatePickerContainer);
};

DateTimeRangePicker.prototype.updateTimezoneLabel = function () {
    this.timezoneLabel.innerHTML = this.fromDatePicker.getTimezoneTextInfo();
};

DateTimeRangePicker.prototype.invalidateSelectItem = function () {
    ComboManager.prototype.invalidateSelectItem.call(this);

    Dom.toggleClass(this.popupContent, "UseCustomRange", this.getSelectedItem() == null);
};

DateTimeRangePicker.prototype.setCustomTimezoneProvider = function (provider) {
    this.fromDatePicker.setCustomTimezoneProvider(provider);
    this.toDatePicker.setCustomTimezoneProvider(provider);
    this.updateTimezoneLabel();
};
DateTimeRangePicker.prototype.setUseToDateEOD = function (useEOD) {
    this.toDatePicker.useEndOfDay = useEOD;
};
DateTimeRangePicker.prototype.setRange = function (range, fromUserAction) {
    if (!range || range.name || (!range.from && !range.to)) {
        this.selectItemByKey("key", (range ? range.name : "") || "all", fromUserAction);
        this.from = null;
        this.to = null;
    } else {
        this.from = range.from;
        this.to = range.to;

        this.fromDatePicker.setDate(range.from);
        this.toDatePicker.setDate(range.to);
        this.selectItem(null, fromUserAction);
    }
    if (fromUserAction) Dom.emitEvent("p:ValueUpdated", this.node(), {});
};
DateTimeRangePicker.prototype.getRange = function () {
    var item = this.getSelectedItem();
    return {
        name: item ? item.key : null,
        from: item ? null : this.from,
        to: item ? null : this.to
    };
};


DateTimeRangePicker.prototype.getValidationRuleSet = function () {
    var thiz = this;
    var rs = new RuleSet()
        .live(true);
        rs.set(this.fromDatePicker.getValidationRuleSet());
        rs.set(this.toDatePicker.getValidationRuleSet());
        rs.rule(new GenericRule(this.toDatePicker, function () {
            var from = thiz.fromDatePicker.getDate();
            var to = thiz.toDatePicker.getDate();
            if (from && to) {
                return to.getTime() >= from.getTime();
            }
            return true;
        }, "End date must be greater than or equal start date."));

    return rs;
};

DateTimeRangePicker.prototype.setCustomDateTimeOptionsByKeys = function (keys) {
    var options = DateTimeRangePicker.getDateTimeOptionsByKeys(keys);
    this.setItems(options);
};

DateTimeRangePicker.prototype.setCustomDateTimeTitle = function (title) {
    this.customTitle = title;
    this.setItems(DateTimeRangePicker.OPTIONS);
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ColorPicker.js";

function ColorPicker() {
    BaseTemplatedWidget.call(this);

    this.bind("click", function () {
        this.popup.show(this.node(), "left-inside", "bottom", 0, 5, "autoFlip");
    });

    this.bind("p:PopupShown", function () {
        if (this.color) {
            this.setColorInternal(this.color);
            if (this.color.a == 0) {
                this.transparencyCleared = false;
            }
        }
    }, this.popup.node());
    var thiz = this;
    this.bind("click", function () {
        var color = thiz._defaultColor ? this._defaultColor : ColorPicker.BLANK_COLOR;
        if (JSON.stringify(color) != JSON.stringify(this.color)) {
            this.setColorInternal(color);
            Dom.emitEvent("p:ValueChanged", this.node(), {});
        }
        this.popup.hide();
    }, this.clearButton);

    this.popup.setPopupClass("ColorPickerPopup");
    this.generateRecentColors();

    this.contributors = [];
    var thiz = this;

    this.setupScale(this.hueValueGrid,
        function (value) {
            return {
                x: value.x - Math.round(this._pin.offsetWidth / 2),
                y: value.y - Math.round(this._pin.offsetHeight / 2)
            }
        },
        function (value) {
            value.x = Math.max(0, Math.min(this.offsetWidth - 1, value.x));
            value.y = Math.max(0, Math.min(this.offsetHeight - 1, value.y));
        }, function (color, value) {
            return {
                h: Math.max(0, Math.min(359, Math.round(359 * value.x / (this.offsetWidth - 1)))),
                s: color.s,
                v: Math.max(0, Math.min(100, Math.round(100 * (1 - value.y / (this.offsetHeight - 1))))),
                a: color.a
            };
        }, function (color) {
            return {
                x: Math.round((this.offsetWidth - 1) * color.h / 359),
                y: (this.offsetHeight - 1) - Math.round((this.offsetHeight - 1) * color.v / 100)
            };
        });

    this.setupScale(this.satScale,
        function (value) {
            var border = 2;
            var height = this._pin.offsetHeight;

            var y = value.y - Math.round(height / 2);

            return {
                x: 0 - border,
                y: Math.max(0 - border, Math.min(this.offsetHeight - height, y))
            }
        },
        function (value) {
            value.x = 0;
            value.y = Math.max(0, Math.min(this.offsetHeight - 1, value.y));
        }, function (color, value) {
            return {
                h: color.h,
                s: Math.max(0, Math.min(100, Math.round(100 * (1 - value.y / (this.offsetHeight - 1))))),
                v: color.v,
                a: color.a
            }
        }, function (color) {
            var from = Color.fromHSV(color.h, 0, color.v).toRGBString();
            var to = Color.fromHSV(color.h, 100, color.v).toRGBString();

            ColorPicker.setGradientBackground(this, from, to);

            return {
                x: 0,
                y: (this.offsetHeight - 1) - Math.round((this.offsetHeight - 1) * color.s / 100)
            };
        });

    this.setupScale(this.opacityScale,
        function (value) {
            var border = 2;
            var height = this._pin.offsetHeight;

            var y = value.y - Math.round(height / 2);

            return {
                x: 0 - border,
                y: Math.max(0 - border, Math.min(this.offsetHeight - height, y))
            }
        },
        function (value) {
            value.x = 0;
            value.y = Math.max(0, Math.min(this.offsetHeight - 1, value.y));
        }, function (color, value) {
            return {
                h: color.h,
                s: color.s,
                v: color.v,
                a: Math.max(0, Math.min(1, 1 - value.y / (this.offsetHeight - 1)))
            };
        }, function (color) {
            var c = Color.fromHSV(color.h, color.s, color.v);
            c.a = 0;
            var from = c.toRGBAString();

            c.a = 1;
            var to = c.toRGBAString();

            ColorPicker.setGradientBackground(thiz.opacityBackground, from, to);

            return {
                x: 0,
                y: (this.offsetHeight - 1) - Math.round((this.offsetHeight - 1) * color.a)
            };
        });

    Dom.registerEvent(document, "mousemove", ColorPicker.handleGlobalMouseMove, false);
    Dom.registerEvent(document, "mouseup", ColorPicker.handleGlobalMouseUp, false);

    this.contributors.push({
        node: this.hexInput,
        output: function (color) {
            var c = Color.fromString(thiz.hexInput.value).getHSV();

            return {
                h: c.hue,
                s: c.saturation,
                v: c.value,
                a: color.a
            };
        },
        input: function (color) {
            thiz.hexInput.value = color.blank ? "" : Color.fromHSV(color.h, color.s, color.v).toRGBString();
        },
        event: "input"
    });
    this.contributors.push({
        node: this.opacityInput,
        output: function (color) {
            if (thiz.opacityInput.value.match(/^[\s]*([0-9]+)%[\s]*$/)) {
                return {
                    h: color.h,
                    s: color.s,
                    v: color.v,
                    a: Math.max(0, Math.min(100, parseInt(RegExp.$1, 10))) / 100
                };
            } else {
                return color;
            }
        },
        input: function (color) {
            thiz.opacityInput.value = Math.max(0, Math.min(100, Math.round(color.a * 100))) + "%";
        },
        event: "input"
    });


    this.bindContributors();
    this.setDefaultColor("#FFFFFF")
}
__extend(BaseTemplatedWidget, ColorPicker);

ColorPicker.PALETTE = ["#5FA5DC", "#7EC658", "#FCD836", "#FD9015", "#F86968", "#EB1D06", "#7E26DE", "#303030", "#FFFFFF"];
ColorPicker.BLANK_COLOR = {
    h: 0,
    s: 100,
    v: 100,
    a: 1,
    blank: true
};
ColorPicker.TRANSPARENT_COLOR = {
    h: 0,
    s: 100,
    v: 100,
    a: 0,
    blank: true
};

ColorPicker.prototype.onDetached = function() {
    if (this.popup) {
        this.popup.kill();
    }
}

ColorPicker.prototype.setDefaultColor = function (rgbaHex) {
    this._defaultColor = this.toColor(rgbaHex);
    this.setColorInternal(this._defaultColor);
}
ColorPicker.prototype.setInfoWhenDefaultColorSelected = function (msg) {
    this.infoWhenDefaultColorSelected = msg;
}
ColorPicker.prototype.generateRecentColors = function() {
    for (var i = 0; i < ColorPicker.PALETTE.length; i ++) {
        var color = ColorPicker.PALETTE[i];
        var div = this.node().ownerDocument.createElement("div");
        div.style.background = color;
        div._hex = color;
        this.recentColorsPane.appendChild(div);
    }

    this.bind("click", function (event) {
        var hex = Dom.findUpwardForData(event.target, "_hex");
        if (!hex) return;

        if (JSON.stringify(this.toColor(hex)) != JSON.stringify(this.color)) {
            this.setRGBAHexColorString(hex);
            Dom.emitEvent("p:ValueChanged", this.node(), {});
        }
    }, this.recentColorsPane);
};
ColorPicker.handleGlobalMouseMove = function (event) {
    if (!ColorPicker._heldInstance) return;
    Dom.cancelEvent(event);

    if (ColorPicker._heldScale) {
        ColorPicker.updateScaleValueFromEvent(ColorPicker._heldScale, event);
        Dom.emitEvent("p:ScaleValueChanged", ColorPicker._heldScale, {});
    }
};
ColorPicker.handleGlobalMouseUp = function (event) {
    ColorPicker._heldInstance = null;
};
ColorPicker.updateScaleValueFromEvent = function(scale, event) {
    var rect = scale.getBoundingClientRect();
    var value = {
        x: event.clientX - rect.left,
        y: event.clientY - rect.top
    };

    ColorPicker.setScaleValue(scale, value);

    return value;
};
ColorPicker.setScaleValue = function(scale, value) {
    scale._valueNormalizer(value);
    var position = scale._positionMapper(value);

    scale._value = value;
    scale._pin.style.left = position.x + "px";
    scale._pin.style.top = position.y + "px";
};
ColorPicker.setGradientBackground = function (element, from, to) {
    var css = "background-repeat: no-repeat; background-image: -webkit-linear-gradient(90deg, _from, _to); background-image: -moz-linear-gradient(90deg, _from, _to); background-image: -ms-linear-gradient(90deg, _from, _to); background-image: -o-linear-gradient(90deg, _from, _to); background-image: linear-gradient(0deg, _from, _to);";
    css = css.replace(/_from/g, from).replace(/_to/g, to);
    element.setAttribute("style", css);
};
ColorPicker.prototype.setupScale = function (scale, positionMapper, valueNormalizer, output, input) {
    var pin = scale.getElementsByClassName("Pin")[0];
    scale._positionMapper = positionMapper;
    scale._valueNormalizer = valueNormalizer;
    scale._output = output;
    scale._input = input;
    scale._pin = pin;

    var thiz = this;
    Dom.registerEvent(scale, "mousedown", function (event) {
        Dom.cancelEvent(event);
        ColorPicker._heldInstance = thiz;
        ColorPicker._heldScale = scale;

        var value = ColorPicker.updateScaleValueFromEvent(scale, event);
        Dom.emitEvent("p:ScaleValueChanged", scale, {});
    }, false);

    this.contributors.push({
        node: scale,
        output: function (color) {
            return scale._output(color, scale._value);
        },
        input: function (color) {
            var value = scale._input(color);
            ColorPicker.setScaleValue(scale, value);
        },
        event: "p:ScaleValueChanged"
    });
};
ColorPicker.prototype.bindContributors = function () {
    for (var i = 0; i < this.contributors.length; i ++) {
        this.bindOneContributor(this.contributors[i]);
    }
};

ColorPicker.prototype.setColor = function (color) {
    if (!color) {
        this.setColorInternal(ColorPicker.BLANK_COLOR);
        return;
    }
    if (typeof color == "string") {
        if (color == "transparent") {
            this.setColorInternal(ColorPicker.TRANSPARENT_COLOR);
        } else {
            this.setRGBAHexColorString(color);
        }
    } else if (typeof color.r != "undefined") {
        this.setRGBAColor(color);
    }
};
ColorPicker.prototype.setRGBAColor = function (rgba) {
    var hsv = Color.RGB2HSV(rgba);

    var color = {
        h: hsv.hue,
        s: hsv.saturation,
        v: hsv.value,
        a: rgba.a || 1
    };

    this.setColorInternal(color);
};
ColorPicker.prototype.setRGBAHexColorString = function (hex) {
    this.setColorInternal(this.toColor(hex));
};
ColorPicker.prototype.toColor = function(hex) {
    var rgba = Color.fromString(hex);
    var hsv = Color.RGB2HSV(rgba);
    var color = {
        h: hsv.hue,
        s: hsv.saturation,
        v: hsv.value,
        a: typeof(rgba.a) == "undefined" ? 1 : rgba.a
    };
    return color;
}
ColorPicker.prototype.getRGBAHexColorString = function () {
    if (!this.color) return null;
    if (this.color.blank) return Color.fromHSVA(ColorPicker.TRANSPARENT_COLOR.h, ColorPicker.TRANSPARENT_COLOR.s, ColorPicker.TRANSPARENT_COLOR.v, ColorPicker.TRANSPARENT_COLOR.a).toString();
    var c = Color.fromHSVA(this.color.h, this.color.s, this.color.v, this.color.a);
    return c.toString();
};
ColorPicker.prototype.getRGBAColorString = function () {
    if (!this.color) return null;
    if (this.color.blank) return Color.fromHSVA(ColorPicker.TRANSPARENT_COLOR.h, ColorPicker.TRANSPARENT_COLOR.s, ColorPicker.TRANSPARENT_COLOR.v, ColorPicker.TRANSPARENT_COLOR.a).toRGBAString();
    var c = Color.fromHSVA(this.color.h, this.color.s, this.color.v, this.color.a);
    return c.toRGBAString();
};
ColorPicker.prototype.getRGBColorString = function () {
    if (!this.color) return null;
    if (this.color.blank) return Color.fromHSVA(ColorPicker.TRANSPARENT_COLOR.h, ColorPicker.TRANSPARENT_COLOR.s, ColorPicker.TRANSPARENT_COLOR.v, ColorPicker.TRANSPARENT_COLOR.a).toRGBString();
    var c = Color.fromHSVA(this.color.h, this.color.s, this.color.v, this.color.a);
    return c.toRGBString();
};
ColorPicker.prototype.getColor = function () {
    if (!this.color || this.color.blank) return null;
    return this.color;
};

ColorPicker.prototype.setColorInternal = function (color, fromContributor) {
    if (color.a == 0 && fromContributor && fromContributor != this.opacityScale && !this.transparencyCleared) {
        color.a = 1;
        this.transparencyCleared = true;
    }
    
    var c = Color.fromHSVA(color.h, color.s, color.v, color.a);
    this.colorDisplayInner.style.background = color.blank ? "transparent" : c.toRGBAString();

    var sameDefaultColor = typeof(this._defaultColor) != "undefined" && this._defaultColor.h == color.h
    && this._defaultColor.s == color.s && this._defaultColor.v == color.v && this._defaultColor.a == color.a;
    if (sameDefaultColor) {
        Dom.addClass(this.node(), "DefaultColor");
        this.infoText.innerHTML = this.infoWhenDefaultColorSelected || "";
        Dom.addClass(this.infoText, "WithInfo");
    } else {
        Dom.removeClass(this.node(), "DefaultColor");
        this.infoText.innerHTML = "&#160;";
        Dom.removeClass(this.infoText, "WithInfo");
    }

    for (var i = 0; i < this.contributors.length; i ++) {
        var contributor = this.contributors[i];
        if (contributor != fromContributor) contributor.input(color);
    }

    this.color = color;

    //fire both user-action-result event and api-result event
    if (fromContributor) Dom.emitEvent("p:ValueChanged", this.node(), {});
    Dom.emitEvent("p:ValueUpdated", this.node(), {});
};

ColorPicker.prototype.bindOneContributor = function (contributor) {
    var thiz = this;
    Dom.registerEvent(contributor.node, contributor.event, function (event) {
        var color = contributor.output(thiz.color);
        thiz.setColorInternal(color, contributor);
    }, false);
};

ColorPicker.prototype.setEnable = function (enable) {
    this.node().disabled = !enable;
};
ColorPicker.prototype.isEnable = function () {
    return !this.node().disabled;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/RichTextEditor.js";

function RichTextEditor(node) {
    if(node !== undefined && node.hasAttribute("data-personal-tags")) {
        var json = node.getAttribute("data-personal-tags");
        this.personalTagsList = [];
        try {
            this.personalTagsList = JSON.parse(json);
        } catch(err) {
            console.log("Error when parse Personal Tags", err);
        }
    }

    if (typeof(CKEDITOR) != "undefined") RichTextEditor.installCKEditorPlugins();
    BaseWidget.call(this);

    var id = "richTextEditor" + (new Date().getTime());
    this.initialized = false;
    this.pendingData = null;
    this.editorEventHandlers = {};
    this.contentCSS = "";
    RichTextEditor.instance = this;
    this.bind("click", this.onSourceButtonClicked, this.editSourceButton);
    this.customStyleSheetEnabled = Dom.getAttributeAsBoolean(node, "custom-stylesheet-enabled", false);
    this._providedFloatingToolbarEnabled = Dom.getAttributeAsBoolean(node, "floating-toolbar-enabled", true);
    this._toolbarMode = Dom.getAttributeAsString(node, "toolbar-mode", "");
    this._minContentHeight = Dom.getAttributeAsInt(node, "min-content-height", 0);
    
    this.TOOLBAR_MODE_MINI = "mini";
}

__extend(BaseTemplatedWidget, RichTextEditor);

RichTextEditor.prototype.onAttached = function () {
    if (typeof(CKEDITOR) != "undefined") {
        this.installEditor();
    } else {
        // in some situations where the editor is used outside of the admin console, CKEDITOR may not be available by default
        var thiz = this;
        widget.__loadScript("/js/ckeditor4.4.5/ckeditor.js", function () {
            widget.__loadScript("/js/ckfinder2.6.2.1/ckfinder.js", function () {
                RichTextEditor.installCKEditorPlugins();
                thiz.installEditor();
            });
        });
    }
};
RichTextEditor.prototype.installEditor = function () {
    var thiz = this;
    var alias = typeof(ADMIN_CONTEXT) != "undefined" ? ADMIN_CONTEXT.teamAlias :
        typeof (g_teamAlias) != "undefined" ? g_teamAlias :
        typeof (TEAM_INFO) != "undefined" ? TEAM_INFO.teamAlias : "";
    var connectorPath = "/team/" + alias + "/controller/ckconnector/command";
    var disableSpellChecker = this.spellcheck ? !this.spellcheck : true;
    var extraPlugins = ["cms-youtube"];
    if (this.personaltags) {
        extraPlugins.push("cms-personaltags");
    }
    
    var basicToolbar = [{ name: 'basicstyles', groups: [ 'styles', 'basicstyles', 'colors', 'cleanup' ] },
                        { name: 'paragraph', groups: [ 'list', 'indent', 'blocks', 'align' ] }];
    
    var extraToolbar = [{ name: 'links', groups: [ 'links' ] },
            { name: 'insert', groups: [ 'insert' ] },
            { name: 'clipboard', groups: [ 'undo','clipboard' ] },
            { name: 'editing', groups: [ 'find', 'selection', 'editing' ] },
            { name: 'extra', groups: [ 'extra' ] }];
                        
    var toolbarGroups = [];
    if (this.TOOLBAR_MODE_MINI == this._toolbarMode) {
        toolbarGroups = basicToolbar;
        Dom.hide(this.editSourceButton);
        if (this.personaltags) toolbarGroups[toolbarGroups.length - 1].groups.push('extra');
    } else {
        toolbarGroups = basicToolbar.concat(['/']).concat(extraToolbar);
    }
    var config = {
        toolbarGroups: toolbarGroups,
        removeButtons: 'Source,Styles,SelectAll,Cut,Copy,Paste,Flash,Smiley,SpecialChar,PageBreak,Iframe',
        //skin: 'moono-lisa',
        removePlugins: "elementspath,resize,magicline,iframe,wsc",
        extraPlugins: extraPlugins.join(","),
        allowedContent: true,
        disableNativeSpellChecker : disableSpellChecker,
        entities_latin: false,
        entities_greek: false,
        contentsCss: ["/framework/webui/framework/js/widget/RichTextEditor-content.less?t=" + new Date().getTime()],
        filebrowserUploadUrl: connectorPath + "?command=QuickUpload&type=Images",
        filebrowserImageUploadUrl: connectorPath + "?command=QuickUpload&type=Images",
        _last: true,
        fillEmptyBlocks: true,
        personalTagsList: this.personalTagsList,
        mini: this.TOOLBAR_MODE_MINI == this._toolbarMode
    };
    console.log("*** Editor config", config);
    this.editor = CKEDITOR.replace(this.contentInput, config);

    CKFinder.setupCKEditor( this.editor, {
        basePath : "/js/ckfinder2.6.2.1",
        connectorPath: connectorPath
    });


    this.editor.on("instanceReady", function() {
        var editable = thiz.editor.editable();
        if (thiz._readOnly) {
            thiz.editor.setReadOnly(thiz._readOnly);
            delete thiz._readOnly;
        }
        editable.attachListener(editable, "input", function () {
            thiz.onSizeChanged();
        });

        editable.attachListener(editable, "keyup", function(event) {
            if (event.data.$.keyCode == DOM_VK_ESCAPE) {
                BaseWidget.handleClosableEscapeKey(event.data.$);
                return;
            }

            thiz.onSizeChanged();
        });

        window.setTimeout(function () {
            thiz.editSourceButton.parentNode.removeChild(thiz.editSourceButton);
            thiz.getEditorToolbar().appendChild(thiz.editSourceButton);

            thiz.initialized = true;

            if (thiz.pendingData) {
                thiz.setContent(thiz.pendingData.content, thiz.pendingData.callback);
                thiz.clearPendingData();
            }

            window.setTimeout(function () {
                Dom.addClass(thiz.node(), "Initialized");
                Dom.emitEvent(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, thiz.node(), {});

                thiz.editor.on("change", function () {
                    Dom.emitEvent(RichTextEditor.TEXT_CHANGE_EVENT_NAME, thiz.node(), {});
                });
                thiz.editor.on("insertElement", function (e) {
                    //if an image is inserted with the natural size, consider them as unset
                    if (!e || !e.data || !e.data.$) return;
                    var node = e.data.$;
                    if (!node.nodeName || node.nodeName.toLowerCase() != "img") return;

                    if (node.style.width == node.naturalWidth + "px"
                        && node.style.height == node.naturalHeight + "px") {
                        node.style.maxWidth = "100%";
                        node.style.height = "auto";
                    }
                });
                thiz.resetUndo();
                thiz.floatingToolbarEnabled = thiz._providedFloatingToolbarEnabled;
            }, 100);
        }, 100);
    });

    Dom.addClass(this.node(), "ScrollerInstalled");

    function heightWatcher() {
        try {
            if (!document.body.contains(thiz.node())) return;
            thiz.onSizeChanged();
        } finally {
            window.setTimeout(heightWatcher, 1000);
        }
    }

    window.setTimeout(heightWatcher, 500);

};
RichTextEditor.prototype.setReadOnly = function(readOnly) {
    this._readOnly = readOnly;
    this.editSourceButton.disabled = readOnly;

    if (this.editor && this.editor.editable()) {
        this.editor.setReadOnly(this._readOnly);
        delete this._readOnly;
    }
}
RichTextEditor.prototype.getFocusNode = function () {
    return this.editor.container;
};
RichTextEditor.prototype.clearPendingData = function () {
    if (!this.pendingData) return;
    delete this.pendingData.content;
    delete this.pendingData.callback;
    delete this.pendingData;
};
RichTextEditor.prototype.setContent = function (content, callback) {
    if (!content) content = "";
    if (this.initialized) {
        this.clearPendingData();
        this.editor.setData(content.html ? content.html : content, callback);
        this.contentCSS = content.css || "";
        try {
            this.applyCSS(this.contentCSS);
        } catch (e) {
            console.error("Error when applying css", e);
        }
        try {
            this.onSizeChanged();
        } catch (e) { }
    } else {
        this.pendingData = { content: content, callback: callback };
    }
};
RichTextEditor.prototype.getContent = function () {
    return this.editor.getData().trim();
};
RichTextEditor.prototype.getContentStylesheet = function () {
    return this.contentCSS;
};
RichTextEditor.prototype.getTextContent = function () {
    return this.getContent().replace(/<[^>]*>/g, "");
};
RichTextEditor.prototype.onIframeInitialized = function (editor) {
    this.editor = editor;
    this.onSizeChanged(this.editor);
    this.initialized = true;
    Dom.emitEvent(RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME, this.node(), {});

    var thiz = this;
    this.editor.on(RichTextEditor.TEXT_CHANGE_EVENT_NAME, function () {
        Dom.emitEvent(RichTextEditor.TEXT_CHANGE_EVENT_NAME, thiz.node(), {});
    });
};
RichTextEditor.prototype.getEditorFrame = function () {
    return this.node().querySelector(":scope iframe");
};
RichTextEditor.prototype.getEditorToolbar = function () {
    return this.node().querySelector(":scope .cke_top");
};
RichTextEditor.prototype.onSizeChanged = function () {
    if (!this.initialized) return;
    var iframe = this.getEditorFrame();
    var size = this.editor ? {
        width: this.editor.document && this.editor.document.$ ? this.editor.document.$.body.offsetWidth : 0,
        height:  this.editor.document && this.editor.document.$ ? this.editor.document.$.body.offsetHeight + 30 : 0
    } : {width: 0, height: 0};

    if (size.height != 0 && iframe && size.height != this.lastContentHeight) {
        iframe.parentNode.style.height = Math.max(size.height, this._minContentHeight || 200) + "px";
        this.updateScrolling();

        this.lastContentHeight = size.height;
    }
};
RichTextEditor.prototype.getSelectionBoundingRect = function (dy) {
    try {
        var iframe = this.getEditorFrame();
        var selection = iframe.contentWindow.getSelection();
        var range = selection.getRangeAt(0);
        if (range.getClientRects().length > 0) {
            return range.getBoundingClientRect();
        } else {
            return range.startContainer.getBoundingClientRect();
        }
    } catch (e) {
        return null;
    }
};
RichTextEditor.CLASS_TOOLBAR_SHIFTED = "ToolbarShifted";
RichTextEditor.prototype.shiftToolbar = function (d, scrollPane) {

    var toolbar = this.getEditorToolbar();

    this.toolbarPadding.style.height = (toolbar.offsetHeight + 5) + "px";
    if (d > 0) {
        if (!Dom.hasClass(this.node(), RichTextEditor.CLASS_TOOLBAR_SHIFTED)) {
            var rect = scrollPane.getBoundingClientRect();
            var thisRect = this.node().getBoundingClientRect();
            var bodyRect = document.body.getBoundingClientRect();

            Dom.addClass(this.node(), RichTextEditor.CLASS_TOOLBAR_SHIFTED);
            toolbar.style.top = rect.top + "px";
            toolbar.style.left = (thisRect.left) + "px";
            toolbar.style.right = (bodyRect.width - thisRect.right) + "px";
        }
    } else {
        Dom.removeClass(this.node(), RichTextEditor.CLASS_TOOLBAR_SHIFTED);
        toolbar.style.top = "0px";
        toolbar.style.width = "auto";
    }
};
RichTextEditor.prototype.updateScrolling = function (bringSelectionIntoView) {
    if (!this.floatingToolbarEnabled) return;
    var scrollPane = Dom.findUpward(this.node(), function (n) {
        return n.scrollHeight > n.offsetHeight;
    });

    if (!scrollPane) {
        this.shiftToolbar(0);
        return;
    }

    var r1 = this.node().getBoundingClientRect();
    var r2 = scrollPane.getBoundingClientRect();

    if (bringSelectionIntoView) {
        var sr = this.getSelectionBoundingRect();
        if (sr) {
            var safeCaretHeight = Util.em() * 3;

            var caretTop = sr.top + this.getEditorFrame().getBoundingClientRect().top;

            var d = caretTop + safeCaretHeight - (r2.top + r2.height);
            if (d > 0) {
                scrollPane.scrollTop += d;
            } else {
                d = r2.top + this.getEditorToolbar().offsetHeight - caretTop + safeCaretHeight;
                if (d > 0) {
                    scrollPane.scrollTop -= d;
                }
            }

            r1 = this.node().getBoundingClientRect();
        }
    }

    var dy = r2.top - r1.top;
    this.shiftToolbar(Math.max(dy - 1, 0), scrollPane);

    if (!this.scrollPaneWatched) {
        Dom.registerEvent(scrollPane, "scroll", function () {
            this.updateScrolling();
        }.bind(this), false);
        this.scrollPaneWatched = true;
    }
};
RichTextEditor.prototype.applyCSS = function (css) {
    if (this.styleNode) this.styleNode.parentNode.removeChild(this.styleNode);

    var doc = this.editor.document.$;

    var head = doc.head || doc.getElementsByTagName("head")[0];

    var style = doc.createElement("style");
    style.type = "text/css";

    if (style.styleSheet) {
        style.styleSheet.cssText = "";
    }

    head.appendChild(style);
    style.appendChild(doc.createTextNode(css));

    this.styleNode = style;
};
RichTextEditor.prototype.onSourceButtonClicked = function () {

    new RichTextEditorAdvancedDialog().callback(function (content) {
        if (content) {
            this.setContent(content);
            Dom.emitEvent(RichTextEditor.TEXT_CHANGE_EVENT_NAME, this.node(), {});
        }
    }.bind(this)).open({
        html: this.getContent(),
        css: this.getContentStylesheet(),
        customStyleSheetEnabled: this.customStyleSheetEnabled
    });
};
RichTextEditor.installCKEditorPlugins = function () {
    if (RichTextEditor._CKEditorPluginsInstalled) return;

    function toYoutubeHTML(video) {
        var json = JSON.stringify(video);
        var width = video.width || 640;
        var height = video.height || 360;
        var url = "https://www.youtube.com/embed/" + video.id;
        return "<iframe allowfullscreen=\"\" frameborder=\"0\""
                    + " width=\"" + width + "\""
                    + " height=\"" + height + "\""
                    + " src=\"" + url + "\""
                    + "></iframe>";
    }
    CKEDITOR.plugins.add("cms-youtube", {
        //lang: [ "en"],
        init: function (editor) {
            console.log("Plugin init called.");
            editor.addCommand("cms-youtube", {
                exec: function (editor) {
                    new RichTextEditorYoutubeDetailDialog().callback(function (video) {
                        if (video) editor.insertHtml(toYoutubeHTML(video));
                    }).open();
                }
            });

            editor.ui.addButton("Youtube", {
                label : "Youtube",
                toolbar : "insert",
                command : "cms-youtube",
                icon : "/framework/webui/framework/images/toolbar-youtube.png"
            });

            editor.on("doubleclick", function (event) {
                var element = event.data.element;
                if (!element) return;
                var json = element.getAttribute("data-json");
                if (!json) return;
                json = atob(json);
                var video = JSON.parse(json);
                new RichTextEditorYoutubeDetailDialog().callback(function (v) {
                    if (v) {
                        editor.insertHtml(toYoutubeHTML(v));
                        element.parentNode.removeChild(element);
                    }
                }).open(video);
            });
        }
    });
    
    CKEDITOR.plugins.add('cms-personaltags', {
        requires: ['richcombo'],
        init: function(editor) {
            editor.filter.allow('span(ck-personal-tags-block)[contenteditable, data-key, data-display]'); // Allow specific span with attributes in the content.
            var keyValue = new Map();
            // Add a rich combo (dropdown) button to the editor's UI.
            editor.ui.addRichCombo('personalTags', {
                label: editor.config.mini ? "Tag..." : 'Personalization Tag...',
                title: 'Select Personalization Tag',
                className: 'cke_personaltags_format',
                toolbar : "extra",
                
                // Configuration for the dropdown panel itself.
                panel: {
                    css: [CKEDITOR.skin.getPath('editor')].concat(editor.config.contentsCss),
                    multiSelect: false,
                    attributes: { 'aria-label': 'Personalization Tag' } // Accessibility attribute.
                },

                init: function() {
                    var list = editor.config.personalTagsList || [
                        { 'key': 'FullName', 'display': 'Full Name', 'title': 'Insert Full Name' },
                        { 'key': 'Email', 'display': 'email@address', 'title': 'Insert Email Address' },
                        { 'key': 'FirstName', 'display': 'First Name', 'title': 'Insert First Name' },
                        { 'key': 'LastName', 'display': 'Last Name', 'title': 'Insert Last Name' }
                    ];

                    for (var i = 0; i < list.length; i++) {
                        var item = list[i];
                        keyValue.set(item.display, item.key);
                        this.add(item.display, item.display, (item.title ? item.title : "Insert " + item.display));
                    }
                },

                getContent: function(value) {
                    var key = keyValue.has(value) ? keyValue.get(value) : value;
                    return '<span class="ck-personal-tags-block" contenteditable="false" data-key="' + key + '" data-display="' + value + '">&#160;</span> '
                },

                onClick: function(value) {
                    editor.focus();
                    // Fire 'saveSnapshot' before and after insertion for undo/redo functionality.
                    editor.fire('saveSnapshot');
                    editor.insertHtml(this.getContent(value));
                    editor.fire('saveSnapshot');
                }
            });

        }
    });

    console.log("Plugin installed");

    RichTextEditor._CKEditorPluginsInstalled = true;
};

RichTextEditor.TEXT_CHANGE_EVENT_NAME = "text-change";
RichTextEditor.EDITOR_INITIALIZED_EVENT_NAME = "p:ItemInitialized";
RichTextEditor.prototype.resetUndo = function () {
    this.editor.resetUndo();
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/RichTextEditorAdvancedDialog.js";

function RichTextEditorAdvancedDialog() {
    this.grabHeight = true;
    Dialog.call(this);

    this.title = "Advance Content Edit";

    this.bind("e:TabChange", function () {
        if (this.mainTab.getActiveTabPane() == this.cssTab && !this.cssCodeEditor) {

            if (typeof(CodeMirror) != "undefined") {
                this.cssCodeEditor = CodeMirror.fromTextArea(this.cssInput, {
                    lineNumbers: true,
                    mode: { name: "css" },
                    extraKeys: {"Ctrl-Space": "autocomplete"},
                    indentUnit: 4
                });
            }
        }
    }, this.mainTab.node());

    this.bind("click", this.handleTemplateItemClick, this.templateSuiteList);
}
__extend(Dialog, RichTextEditorAdvancedDialog);

RichTextEditorAdvancedDialog.prototype.setup = function (options) {
    this.customStyleSheetEnabled = (options && options.customStyleSheetEnabled) || false;
    if (options) {
        this.htmlInput.value = options.html || "";
        this.cssInput.value = options.css || "";
    }
    console.log("customStyleSheetEnabled: ", this.customStyleSheetEnabled);
};

RichTextEditorAdvancedDialog.prototype.onShown = function () {
    Dom.toggleClass(this.mainTab.node(), "CustomStyleSheetDisabled", !this.customStyleSheetEnabled);
    if (typeof(CodeMirror) != "undefined") {
        this.htmlCodeEditor = CodeMirror.fromTextArea(this.htmlInput, {
            lineNumbers: true,
            mode: "htmlmixed",
            extraKeys: {"Ctrl-Space": "autocomplete"},
            indentUnit: 4,
            lineWrapping: true,
        });
    }
    // var charWidth = this.htmlCodeEditor.defaultCharWidth(), basePadding = 4;
    // this.htmlCodeEditor.on("renderLine", function(cm, line, elt) {
    //     var off = CodeMirror.countColumn(line.text, null, cm.getOption("tabSize")) * charWidth;
    //     elt.style.textIndent = "-" + off + "px";
    //     elt.style.paddingLeft = (basePadding + off) + "px";
    // });
};


RichTextEditorAdvancedDialog.prototype.save = function () {
    if (this.htmlCodeEditor) this.htmlCodeEditor.save();
    if (this.cssCodeEditor) this.cssCodeEditor.save();

    this.close({
        html: this.htmlInput.value,
        css: this.cssInput.value
    });

};
RichTextEditorAdvancedDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Update",
            run: function () { this.save(); return false; }
        }
    ]
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/RichTextEditorYoutubeDetailDialog.js";

function RichTextEditorYoutubeDetailDialog() {
    Dialog.call(this);

    this.title = "Insert Youtube Video";
    this.videoSizeSelector.renderer = function (size) {
        return size.w + " x " + size.h;
    };
    this.videoSizeSelector.comparer = Util.sameId;
    this.videoSizeSelector.setItems(RichTextEditorYoutubeDetailDialog.SIZES);
}
__extend(Dialog, RichTextEditorYoutubeDetailDialog);

RichTextEditorYoutubeDetailDialog.SIZES = [
    {id: "426x240", w: 426, h: 240},
    {id: "640x360", w: 640, h: 360},
    {id: "854x480", w: 854, h: 480},
    {id: "1280x720", w: 1280, h: 720},
]
RichTextEditorYoutubeDetailDialog.prototype.onShown = function () {
    this.youtubeIdInput.focus();
};
RichTextEditorYoutubeDetailDialog.prototype.setup = function (video) {
    if (video) {
        this.youtubeIdInput.value = video.id;
        var sizeId = video.width + "x" + video.height;
        this.videoSizeSelector.selectItemByKey("id", sizeId);
    } else {
        this.videoSizeSelector.selectItemByKey("id", "640x360");
    }
};


RichTextEditorYoutubeDetailDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "OK",
            run: function () { this.onAccept(); return false; }
        }
    ]
};
RichTextEditorYoutubeDetailDialog.prototype.onAccept = function () {
    var id = RichTextEditorYoutubeDetailDialog.parseId(this.youtubeIdInput.value) || this.youtubeIdInput.value;
    if (!id) {
        Dialog.error("Invalid video", "Please enter a valid Youtube video URL or ID.", function () {
            this.youtubeIdInput.focus();
        }.bind(this));
        return;
    }
    
    var size = this.videoSizeSelector.getSelectedItem();
    
    this.close({
        id: id,
        width: size.w,
        height: size.h
    });
};

RichTextEditorYoutubeDetailDialog.parseId = function (url) {
    var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
    return (url.match(p)) ? RegExp.$1 : null;
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/InfoTip.js";

function InfoTip() {
    Popup.call(this);

    //avoid auto close
    this.skipStack = true;
    this.forceInside = false;
    this.useZIndex = false;
    this.popupOpacity = 0.999999;

    // this.bind("click", function () {
    //     this.hide();
    // }, this.tipClose);

    this.bind("p:PopupShown", this.handlePopupShown);
    this.bind("p:PopupHidden", this.handlePopupHidden);

    this.bind("click", function () {
        if (this.skipStack) this.close();
    }, this.popupContainer);

}
__extend(Popup, InfoTip);


InfoTip.prototype.setContentFragment = function (fragment) {
    this.contentHolder.appendChild(fragment);
};
InfoTip.prototype.setExplicitClose = function (explicitClose) {
    this.skipStack = explicitClose;
    Dom.toggleClass(this.popupContainer, "WithClose", explicitClose);
};
InfoTip.prototype.setType = function (type) {
    this.popupContainer.setAttribute("type", type || "");
};
InfoTip.prototype.handlePopupShown = function () {
    var thiz = this;
    (function tracker() {
        thiz.anchorTrackTimer = null;
        if (!thiz.lastShowOptions.anchor || !document.body.contains(thiz.lastShowOptions.anchor) || !thiz.lastShowOptions.anchor.offsetParent) {
            thiz.close();
            return;
        }
        try {
            thiz.invalidatePosition();
        } finally {
            thiz.anchorTrackTimer = window.setTimeout(tracker, 20);
        }
    })();
};
InfoTip.prototype.handlePopupHidden = function () {
    if (this.anchorTrackTimer) window.clearTimeout(this.anchorTrackTimer);
    this.anchorTrackTimer = null;
};

InfoTip.prototype.onBeforeVisible = function (x, y, hAlign, vAlign) {
    this.popupContainer.setAttribute("valign", vAlign);

    var scaleX = hAlign.indexOf("right") >= 0 ? -1 : 1;
    var scaleY = vAlign == "bottom" ? -1 : 1;
    this.balloon.onSizeChanged();
    this.balloon.svg.style.transform = "scale(" + scaleX + "," + scaleY + ")";
};
InfoTip.show = function (anchor, message, explicitClose, onClose, type, hAlign, offsetX, offsetY) {
    if (anchor.__tip && anchor.__tip.isVisible()) {
        anchor.__tip.hide();
        return;
    }
    var tip = new InfoTip();
    tip.setExplicitClose(explicitClose ? true : false);
    tip.setType(type);

    var contentNode = null;
    if (typeof(message) == "string") {
        contentNode = Dom.newDOMFragment([{_name: "div", "_html": message.split(/[\r\n]/g).map(function (line) {return Dom.htmlEncode(line);}).join("<br/>")}]);
    } else if (message.getAttribute) {
        contentNode = message;
    } else if (message.forEach) {
        contentNode = Dom.newDOMFragment(message);
    } else {
        contentNode = Dom.newDOMElement(message);
    }

    tip.setContentFragment(contentNode);

    if (onClose) Dom.registerEvent(tip.node(), "p:PopupHidden", onClose, false);
    var hPadding = typeof(offsetX) == "undefined" ? -5 : offsetX;
    var vPadding = typeof(offsetY) == "undefined" ? -7 : offsetY;
    tip.show(anchor, hAlign ? hAlign : "left-inside", "top", hPadding, vPadding, "autoFlip");
    tip.onHide = function() {
        delete anchor.__tip;
    };
    tip.shouldCloseOnBlur = function(event) {
        var found = Dom.findUpward(event.target, function (node) {
            return node == anchor;
        });
        return !found;
    };
    anchor.__tip = tip;

    return tip;
};

InfoTip.install = function (container, provider) {
    var currentTarget = null;
    var outTimer = null;
    var tip = null;

    container.addEventListener("mouseover", function (event) {
        var target = Dom.findUpward(event.target, provider.match);
        if (!target) {
            return;
        }

        if (outTimer) {
            window.clearTimeout(outTimer);
            outTimer = null;
        }

        if (currentTarget == target) {
            return;
        }
        if (tip != null) {
            tip.kill();
        }
        if (target.__tip) {
            try {
                target.__tip.kill();
            } catch (e) {
            }

            target.__tip = null;
        }
        var popupType = provider.type;
        if (typeof(provider.getType) == "function") {
            popupType = provider.getType(target);
        }
        tip = InfoTip.show(target, provider.getMessage(target), false, null, popupType, provider.hAlign, provider.offsetX || -20, provider.offsetY || -5);
        currentTarget = target;
    });
    container.addEventListener("mouseout", function (event) {
        if (!currentTarget || outTimer) return;
        if (outTimer) {
            window.clearTimeout(outTimer);
        }
        outTimer = window.setTimeout(function () {
            tip.kill();
            tip = null;
            currentTarget.__tip = null;
            currentTarget = null;
        }, 500);
    });
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/HelpLink.js";

function HelpLink(node) {
    BaseTemplatedWidget.call(this);
    
    var customLabel = Dom.getAttributeAsString(node, "text-label", "");
    this.helpId = Dom.getAttributeAsInt(node, "help-id", 0);
    
    if (customLabel) Dom.setInnerText(this.labelText, customLabel);
    
    this.bind("click", function () {
        var elev = window._elev;
        if (!elev) {
            var current = window;
            while (current.parent != current) {
                current = current.parent;
                if (current._elev) {
                    elev = current._elev;
                    break;
                }
            }
        }
        
        if (!elev) {
            console.error("No Elevio found");
            return;
        }
        
        elev.openArticle(this.helpId);
    });
}
__extend(BaseTemplatedWidget, HelpLink);

HelpLink.prototype.setContentFragment = function(fragment) {
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/InfiniteListView.js";

function InfiniteListView(node) {
    BaseTemplatedWidget.call(this);

    this.selectorId = node ? node.getAttribute("selector-id") : null;

    this.bind("scroll", this.handleScrolling, this.scrollPane);
    this.bind("click", this.handleClick);
    this.nodePool = [];

    this.chunkSize = 30;
}
__extend(BaseTemplatedWidget, InfiniteListView);

InfiniteListView.prototype.setSource = function (source) {
    if (document.body.contains(this.node())) {
        this._setSourceImpl(source);
    } else {
        this._pendingSource = source;
    }
};

InfiniteListView.prototype.onAttached = function () {
    if (this._pendingSource) {
        this._setSourceImpl(this._pendingSource);
        this._pendingSource = null;
    }
};
InfiniteListView.prototype._setSourceImpl = function (source) {
    this.source = source;
    this.reload();
};
InfiniteListView.prototype.reload = function () {
    this.items = [];
    this.averageItemHeight = -1;
    this.start = 0;
    this.end = -1;
    this.sourceDataCount = -1;
    this.initialized = false;

    this.initialize();
};
InfiniteListView.prototype.handleClick = function (event) {
    if (this.selectorId) {
        var selector = Dom.findUpwardForNodeWithData(event.target, "_isSelector");
        if (selector) {
            var itemView = Dom.findUpwardForNodeWithData(event.target, "_item");
            if (!itemView) return;
            var item = itemView._item;
            if (!item) return;
            var checked = event.target.checked;
            item.options.checked = checked;

            this.emitSelectionEvent();
        }
    }
};

InfiniteListView.prototype.handleScrolling = function () {
    // if (this.scrollHandlingTimeout) window.clearTimeout(this.scrollHandlingTimeout);
    //
    // this.scrollHandlingTimeout = window.setTimeout(this.handleScrollingImpl.bind(this), 30);
    this.handleScrollingImpl();
};
InfiniteListView.prototype.handleScrollingImpl = function () {
    this.scrollHandlingTimeout = null;
    if (!this.initialized) return;

    var H = this.scrollPane.scrollHeight;
    var h = this.scrollPane.clientHeight;
    var offset = this.scrollPane.scrollTop;

    var thiz = this;

    if (this.mayHaveMoreData()) {
        if (H - (offset + h) < h && !this.filling) {
            this.filling = true;
            this.fillNextDataChunk(function () {
                thiz.filling = false;
                thiz.handleScrollingImpl();
            });
        }
    }

    var y0 = offset - h;
    var y1 = y0 + 3 * h;

    var c = Math.max(Math.floor(y0 / this.averageItemHeight), 0);
    var d = Math.min(Math.ceil(y1 / this.averageItemHeight) + 1, this.items.length - 1);
    this._updateDisplaySegment(c, d);
};
InfiniteListView.prototype._updateDisplaySegment = function (c, d) {
    var a = this.start;
    var b = this.end;

    if (b > d) this._remove(Math.max(a, d + 1), false);
    if (c > a) this._remove(Math.min(c - 1, b), true);

    if (b < d) this._add(Math.max(c, b + 1), d, false);
    if (c < a) this._add(c, Math.min(a - 1, d), true);

    this.leadingPane.style.height = (Math.max(0, c) * this.averageItemHeight) + "px";
    this.trailingPane.style.height = (Math.max(0, this.items.length - d - 1) * this.averageItemHeight) + "px";

    this.start = c;
    this.end = d;
};
InfiniteListView.prototype._add = function (from, to, leading) {
    if (from > to) return;

    var fragment = this.contentPane.ownerDocument.createDocumentFragment();
    for (var i = from; i <= to; i ++) {
        var item = this.items[i];
        var itemNode = this.makeNewItemView(item);
        itemNode._data = item.data;
        itemNode._item = item;
        itemNode._index = i;
        fragment.appendChild(itemNode);

        if (this.selectorId) {
            var selector = itemNode._binding[this.selectorId];
            if (selector) selector.checked = item.options.checked ? true : false;
            selector._isSelector = true;
        }
    }

    if (leading && this.contentPane.firstChild) {
        this.contentPane.insertBefore(fragment, this.contentPane.firstChild);
    } else {
        this.contentPane.appendChild(fragment);
    }
};
InfiniteListView.prototype._remove = function (index, leading) {
    if (leading) {
        index = Math.min(index, this.end);

        if (index < this.start) return;
        for (var count = this.start; count <= index; count ++) {
            this.removeItemView(this.contentPane.firstChild);
        }
    } else {
        index = Math.max(index, this.start);

        if (index > this.end) return;
        for (var count = index; count <= this.end; count ++) {
            var i = count - this.start;
            this.removeItemView(this.contentPane.childNodes[index - this.start]);
        }
    }
};
InfiniteListView.prototype.fillNextDataChunk = function (callback) {
    Dom.addClass(this.node(), "FillingData");
    this.source.loadPage(this.items.length, this.chunkSize, function (result, count) {
        try {
            this.sourceDataCount = count;
            if (result) this.items = this.items.concat(result.map(function (item) { return {data: item, options: {}}; }));
            callback(result, count);
        } finally {
            Dom.removeClass(this.node(), "FillingData");
        }
    }.bind(this), function () {
        Dom.removeClass(this.node(), "FillingData");
    });
};
InfiniteListView.prototype.mayHaveMoreData = function () {
    return this.sourceDataCount < 0 || this.sourceDataCount > this.items.length;
};
InfiniteListView.prototype.initialize = function (callback) {
    var height = this.scrollPane.clientHeight;

    var thiz = this;
    this.contentPane.innerHTML = "";

    function postLoadingHandler() {
        thiz.start = 0;
        thiz.end = thiz.items.length;
        thiz.averageItemHeight = thiz.items.length ? Math.round(thiz.contentPane.clientHeight / thiz.items.length) : 0;
        thiz.scrollPane.scrollTop = 0;
        thiz.initialized = true;
        thiz.handleScrollingImpl();
        thiz.emitSelectionEvent();
        if (callback) callback();
    }

    var filledCount = 0;
    function next() {

        if (!thiz.mayHaveMoreData() || thiz.contentPane.offsetHeight >= 2 * height) {
            postLoadingHandler();
            return;
        }

        thiz.fillNextDataChunk(function (result, count) {
            for (var i = filledCount; i < thiz.items.length; i ++) {
                var item = thiz.items[i];
                var itemNode = thiz.makeNewItemView(item);
                itemNode._data = item.data;
                itemNode._item = item;
                itemNode._index = i;
                thiz.contentPane.appendChild(itemNode);
            }

            filledCount = thiz.items.length;

            next();
        });
    };

    next();
};
InfiniteListView.prototype.removeItemView = function (node) {
    if (!node) return;
    if (node.parentNode) node.parentNode.removeChild(node);
    this.nodePool.push(node);
};
InfiniteListView.prototype.makeNewItemView = function (item) {
    var node = this.generate(null, this.itemTemplate, item.data);
    if (this.selectorId) {
        var selector = node._binding[this.selectorId];
        selector._isSelector = true;
    }
    return node;
};
InfiniteListView.prototype.setContentFragment = function (fragment) {
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node || node.nodeType != Node.ELEMENT_NODE) continue;
        var role = node.getAttribute("role");

        if (role == "item") {
            this.itemTemplate = node;
        }
    }
};

InfiniteListView.prototype.createBinding = function (container) {
    container._binding = {};
    container._binding._node = container;
    widget.Util.performAutoBinding(container, container._binding, null, "forced");

    Dom.doOnChildRecursively(container, {
        eval: function(n) {
            return n.getAttribute && n.getAttribute("anon-id");
        }
    }, function(n) {
        var id = n.getAttribute("anon-id");

        if (container._binding) {
            container._binding[id] = n;
        }
        n.removeAttribute("anon-id");

        var newId = id + widget.random();
        n.setAttribute("id", newId);
        n.id = newId;
        Dom.addClass(n, "AnonId_" + id);
    });
};
InfiniteListView.prototype.generate = function (container, templateNode, data) {
    var node = null;
    if (this.nodePool.length > 0) {
        node = this.nodePool.shift();
    } else {
        node = templateNode.cloneNode(true);
        this.createBinding(node);
    }

    if (container) container.appendChild(node);

    if (this.populator && typeof(data) != "undefined") this.populator(data, node._binding, node);

    return node;
};
InfiniteListView.prototype.emitSelectionEvent = function () {
    Dom.emitEvent("p:SelectionChanged", this.node());
};
InfiniteListView.prototype.getSelectedItems = function () {
    var selectedItems = [];
    if (this.items) {
        this.items.forEach(function (item) {
            if (item.options.checked) selectedItems.push(item.data);
        });
    }

    return selectedItems;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/AutoCompleteText.js";

function AutoCompleteText() {
    BaseWidget.call(this);
    var css = "body .AutoCompleteTextPopup {padding: 0.5em 0em; }\nbody .AutoCompleteTextPopup .AnonId_list .Item {padding: 0.3em 0.8em; }\nbody .AutoCompleteTextPopup .AnonId_list .Item.Selected {background: #FFD40B; color: #000;}";
    widget.Util.insertGlobalStyleSheet(css, "AutoCompleteText");
    this._setup = false;
}

__extend(BaseTemplatedWidget, AutoCompleteText);
AutoCompleteText.prototype.onAttached = function() {
    if (this._setup) return;
    this.popup = new Popup().into(document.body);
    this.popup.setPopupClass("AutoCompleteTextPopup");

    this.list = document.createElement("div");
    this.popup.setContentFragment(this.list);
    Dom.addClass(this.list, "AnonId_list");

    this.bind("mouseover", this.handleMouseOver, this.list);
    this.bind("click", this.handleItemClick, this.list);
    this._setup = true;
}

AutoCompleteText.prototype.onDetached = function() {
    if (this.popup) {
        this.popup.kill(true);
    }
}

AutoCompleteText.prototype.buildDOMNode = function () {
    var input = document.createElement("input");
    input.setAttribute("type", "text");
    input.setAttribute("autocomplete", "off");

    return input;
};

AutoCompleteText.prototype.setup = function (source, renderer, builder) {
    this.source = source;
    this.renderer = renderer || function (object) { return "" + object; };
    this.builder = builder || function (object) { return "" + object; };

    this.bind("keyup", this.handleKeyUp);
    this.bind("keydown", this.handleKeyPress);
};
AutoCompleteText.prototype.handleKeyPress = function (event) {
    if (event.keyCode == DOM_VK_DOWN) {
        this.selectNext(1);
        Dom.cancelEvent(event);
        return;
    }
    if (event.keyCode == DOM_VK_UP) {
        this.selectNext(-1);
        Dom.cancelEvent(event);
        return;
    }
};
AutoCompleteText.prototype.handleMouseOver = function (event) {
    var data = Dom.findUpwardForData(event.target, "_data");
    if (!data) return;
    var index = this.items.indexOf(data);
    if (index < 0) return;

    this.selectItemAt(index);
};
AutoCompleteText.prototype.handleItemClick = function (event) {
    var data = Dom.findUpwardForData(event.target, "_data");
    if (!data) return;

    this.node().value = this.builder(data);
    this.node().select();
    this.selectedData = data;

    this.focusedData = null;
    this.popup.hide();
    this.node().focus();
    Dom.emitEvent("p:ItemSelected", this.node(), {__target: Dom.getTarget(event)});

    Dom.cancelEvent(event);
};
AutoCompleteText.prototype.handleKeyUp = function (event) {
    if (this.pendingTimer) window.clearTimeout(this.pendingTimer);
    if (this.currentLoader) this.currentLoader.cancel();

    if (event.keyCode == DOM_VK_ESCAPE) return;
    if (event.keyCode == DOM_VK_DOWN) return;
    if (event.keyCode == DOM_VK_UP) return;

    if (this.isSelectItemEvent(event)) {
        if (this.focusedData) {
            this.node().value = this.builder(this.focusedData);
            this.node().select();
            this.selectedData = this.focusedData;

            this.focusedData = null;
            this.popup.hide();
            this.node().focus();
            Dom.emitEvent("p:ItemSelected", this.node(), {});
        }
        Dom.cancelEvent(event);
        return;
    }

    this.pendingTimer = null;
    this.currentLoader = null;

    var thiz = this;
    var text = this.node().value.replace(/^[ \t]+/, "").replace(/[ \t]+$/, "");
    if (!text && !this.suggestOnBlank) {
        this.popup.closeUpward();
        return;
    }
    this.pendingTimer = window.setTimeout(function () {
        thiz.pendingTimer = null;
        if (thiz.currentLoader) thiz.currentLoader.cancel();
        thiz.currentLoader = new AutoCompleteTextLoader(thiz);
        thiz.currentLoader.start(text, thiz.source);
    }, this.timeout || 500);
};

AutoCompleteText.prototype.autoCompleteNow = function () {
    var text = this.node().value.replace(/^[ \t]+/, "").replace(/[ \t]+$/, "");

    if (this.pendingTimer) window.clearTimeout(this.pendingTimer);
    if (this.currentLoader) this.currentLoader.cancel();
    this.pendingTimer = null;

    this.currentLoader = new AutoCompleteTextLoader(this);
    this.currentLoader.start(text, this.source);
}

AutoCompleteText.prototype.selectNext = function (delta) {
    var index = this.selectedIndex + delta;
    if (index < 0) index = this.items.length - 1;
    if (index >= this.items.length) index = 0;

    this.selectItemAt(index, "focus");
};
AutoCompleteText.prototype.isSelectItemEvent = function(event) {
    return event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN;
}
AutoCompleteText.prototype.selectItemAt = function (index, focusItem) {
    if (index < 0 || index > this.items.length - 1) return;

    var data = this.items[index];
    var itemNode = null;
    this.selectedIndex = -1;
    this.focusedData = null;
    for (var i = 0; i < this.list.childNodes.length; i ++) {
        var node = this.list.childNodes[i];
        if (node._data == data) {
            itemNode = node;
            Dom.addClass(node, "Selected");
            this.selectedIndex = index;
            this.focusedData = data;
            if (focusItem) {
                try {
                    node.focus()
                } catch (e) {}
            }
        } else {
            Dom.removeClass(node, "Selected");
        }
    }
    if (focusItem) {
        var thiz = this;
        window.setTimeout(function () {
            thiz.focus();
        }, 5);
    } else {
        this.focus();
    }
};

AutoCompleteText.prototype.onFound = function (query, items) {
    this.currentLoader = null;
    if (items && items.length > 0) {
        this.setupItems(items);
        this.popup.show(this.node(), "left-inside", "bottom", 0, 5);
        this.focus();
    } else {
        this.popup.closeUpward();
    }
};
AutoCompleteText.prototype.setupItems = function (items) {
    var first = null;
    this.items = items;
    this.list.innerHTML = "";
    if (!this.items) return;
    for (var i = 0; i < this.items.length; i++) {
        var item = this.items[i];
        var element = this.renderer(item);
        var node = null;
        if (element.getAttribute) {
            node = Dom.newDOMElement({
                _name: "div",
                "class": "Item",
                "tabindex": "0"
            });
            node.appendChild(element);
        } else {
            var spec = {
                _name: "div",
                "class": "Item",
                "tabindex": "0",
                _text: element
            };

            spec[this.useHtml ? "_html" : "_text"] = element;
            node = Dom.newDOMElement(spec);
        }
        if (this.decorator) this.decorator(node, item);
        node._data = item;
        this.list.appendChild(node);
        if (!first) first = item;
    }

    if (this.items.length > 0) {
        this.selectItemAt(0);
        if (this.node().value == this.builder(first)) {
            this.selectedData = first;
        }
    }
    //this.selectItem(first);
};

AutoCompleteText.prototype.getSelectedData = function () {
    return this.selectedData;
};
AutoCompleteText.prototype.setSelectedData = function (data) {
    this.selectedData = data;
    this.node().value = data ? this.builder(data) : "";
};

AutoCompleteText.prototype.getText = function () {
    return this.node().value;
};

AutoCompleteText.prototype.focus = function () {
    return this.node().focus();
};

function AutoCompleteTextLoader(owner) {
    this.canceled = false;
    this.owner = owner;
}

AutoCompleteTextLoader.prototype.cancel = function () {
    this.canceled = true;
    this.owner = null;
};
AutoCompleteTextLoader.prototype.start = function (query, source) {
    var thiz = this;
    source(query, function (items) {
        if (thiz.canceled) return;
        thiz.owner.onFound(query, items);
    });
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/QuickDataSelectorInput.js";

function QuickDataSelectorInput(node) {
    BaseTemplatedWidget.call(this);
    this._setup = false;
    
    this.autoFlipPopup = Dom.getAttributeAsBoolean(node, "auto-flip", true);
    var extraPopupClass = Dom.getAttributeAsString(node, "popup-class");
    if (extraPopupClass) this.popup.setPopupClass(extraPopupClass);
    
    this.input.setAttribute("placeholder", Dom.getAttributeAsString(node, "input-placeholder", ""));
    Dom.setInnerText(this.popupTitle, Dom.getAttributeAsString(node, "popup-title", "Select Items"));
    
    // this.bind("focus", this._showPopup, this.input);
    // this.bind("click", this._showPopup, this.input);
    
    this.bind("click", this._handleCheckboxClick, this.list);
    this.bind("click", this._handleSelectClick, this.selectButton);

    this.bind("keyup", this.handleKeyUp);
    this.bind("keypress", this.handleKeyPress);
    
    var thiz = this;
    this.popup.shouldCloseOnBlur = function (e) {
        return (thiz.input != e.target);
    };
}

__extend(BaseTemplatedWidget, QuickDataSelectorInput);
QuickDataSelectorInput.prototype.onAttached = function() {
    if (this._setup) return;
    this._setup = true;
}

QuickDataSelectorInput.prototype.onDetached = function() {
    if (this.popup) {
        this.popup.kill(true);
    }
}
QuickDataSelectorInput.prototype._showPopup = function() {
    if (this.popup.isVisible()) return;
    this.popup.show(this.input, "left-inside", "bottom", 0, Math.round(0.5 * Util.em()), this.autoFlipPopup);
};
QuickDataSelectorInput.prototype._handleSelectClick = function() {
    if (!this.onAdd) return;
    var items = this.getSelectedDataItems();
    if (!items || items.length == 0) return;
    
    this.onAdd(items);
    
    //this.input.value = "";
    this.popup.close();
};
QuickDataSelectorInput.prototype.clear = function () {
    this.input.value = "";
    this.popup.close();
    
    this.list.innerHTML = "";
    this._invalidateSelectionCount();
};
QuickDataSelectorInput.prototype._handleCheckboxClick = function(e) {
    if (!Dom.isTag(e.target, "input") || !e.target.getAttribute || e.target.getAttribute("type") != "checkbox") return;
    
    var item = Dom.findParentWithClass(e.target, "Item");
    var checked = e.target.checked;
    
    var children = item.nextSibling;
    if (children && Dom.hasClass(children, "Children")) {
        var inputs = children.querySelectorAll(".Item > input[type=\"checkbox\"]");
        Array.prototype.forEach.call(inputs, function (checkbox) {
            checkbox.checked = checked;
        });
    }
    
    this._invalidateParentCheckedStatus(item);
    
    this._invalidateSelectionCount();
};

QuickDataSelectorInput.prototype._invalidateParentCheckedStatus = function (currentItem) {
    var parentChildren = Dom.findParentWithClass(currentItem, "Children");
    if (!parentChildren) return;
    
    var parentItem = parentChildren.previousSibling;
    if (!parentItem) return;
    
    var allChecked = true;
    var inputs = parentChildren.querySelectorAll(".Item > input[type=\"checkbox\"]");
    Array.prototype.forEach.call(inputs, function (checkbox) {
        if (!checkbox.checked) allChecked = false;
    });
    
    parentItem.querySelector(":scope > input[type=\"checkbox\"]").checked = allChecked;
    
    this._invalidateParentCheckedStatus(parentItem);
};
QuickDataSelectorInput.prototype._invalidateSelectionCount = function () {
    var count = this.getSelectedDataItems().length;
    Dom.toggleClass(this.popupContentBox, "HasSelection", count > 0);
    Dom.setInnerText(this.selectionCountLabel, "" + count);
};

QuickDataSelectorInput.prototype.shouldIncludeInSelection = function (data) {
    return true;
};
QuickDataSelectorInput.prototype.getSelectedDataItems = function () {
    var dataList = [];
    
    var thiz = this;
    
    var inputs = this.list.querySelectorAll(".Item > input[type=\"checkbox\"]");
    Array.prototype.forEach.call(inputs, function (checkbox) {
        if (!checkbox.checked) return;
        var item = Dom.findParentWithClass(checkbox, "Item");
        if (item && item._data && thiz.shouldIncludeInSelection(item._data)) dataList.push(item._data);
    });
    
    return dataList;
};
QuickDataSelectorInput.prototype.setup = function (source, renderer, builder) {
    this.source = source;
    this.renderer = renderer || function (object) { return "" + object; };
    this.builder = builder || function (object) { return "" + object; };
    this.clear();
};
QuickDataSelectorInput.prototype.handleKeyPress = function (event) {
    if (event.keyCode == DOM_VK_DOWN) {
        this.selectNext(1);
        Dom.cancelEvent(event);
        return;
    }
    if (event.keyCode == DOM_VK_UP) {
        this.selectNext(-1);
        Dom.cancelEvent(event);
        return;
    }
};
QuickDataSelectorInput.prototype.handleMouseOver = function (event) {
    var data = Dom.findUpwardForData(event.target, "_data");
    if (!data) return;
    var index = this.items.indexOf(data);
    if (index < 0) return;

    this.selectItemAt(index);
};
QuickDataSelectorInput.prototype.handleItemClick = function (event) {
    var data = Dom.findUpwardForData(event.target, "_data");
    if (!data) return;

    this.input.value = this.builder(data);
    this.input.select();
    this.selectedData = data;

    this.focusedData = null;
    this.popup.hide();
    this.input.focus();
    Dom.emitEvent("p:ItemSelected", this.node(), {__target: Dom.getTarget(event)});

    Dom.cancelEvent(event);
};
QuickDataSelectorInput.prototype.handleKeyUp = function (event) {
    if (this.pendingTimer) window.clearTimeout(this.pendingTimer);
    if (this.currentLoader) this.currentLoader.cancel();

    if (event.keyCode == DOM_VK_ESCAPE) return;
    if (event.keyCode == DOM_VK_DOWN) return;
    if (event.keyCode == DOM_VK_UP) return;

    if (this.isSelectItemEvent(event)) {
        if (this.focusedData) {
            this.input.value = this.builder(this.focusedData);
            this.input.select();
            this.selectedData = this.focusedData;

            this.focusedData = null;
            this.popup.hide();
            this.input.focus();
            Dom.emitEvent("p:ItemSelected", this.node(), {});
        }
        Dom.cancelEvent(event);
        return;
    }

    this.pendingTimer = null;
    this.currentLoader = null;

    var thiz = this;
    var text = this.input.value.replace(/^[ \t]+/, "").replace(/[ \t]+$/, "");
    if (!text && !this.suggestOnBlank) {
        this.popup.closeUpward();
        return;
    }
    this.pendingTimer = window.setTimeout(function () {
        thiz.pendingTimer = null;
        if (thiz.currentLoader) thiz.currentLoader.cancel();
        thiz.currentLoader = new QuickDataSelectorInputLoader(thiz);
        thiz.currentLoader.start(text, thiz.source);
    }, this.timeout || 500);
};

QuickDataSelectorInput.prototype.autoCompleteNow = function () {
    var text = this.input.value.replace(/^[ \t]+/, "").replace(/[ \t]+$/, "");

    if (this.pendingTimer) window.clearTimeout(this.pendingTimer);
    if (this.currentLoader) this.currentLoader.cancel();
    this.pendingTimer = null;

    this.currentLoader = new QuickDataSelectorInputLoader(this);
    this.currentLoader.start(text, this.source);
}

QuickDataSelectorInput.prototype.selectNext = function (delta) {
    var index = this.selectedIndex + delta;
    if (index < 0) index = this.items.length - 1;
    if (index >= this.items.length) index = 0;

    this.selectItemAt(index);
};
QuickDataSelectorInput.prototype.isSelectItemEvent = function(event) {
    return event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN;
}
QuickDataSelectorInput.prototype.selectItemAt = function (index) {
    if (index < 0 || index > this.items.length - 1) return;

    var data = this.items[index];
    var itemNode = null;
    this.selectedIndex = -1;
    this.focusedData = null;
    for (var i = 0; i < this.list.childNodes.length; i ++) {
        var node = this.list.childNodes[i];
        if (node._data == data) {
            itemNode = node;
            Dom.addClass(node, "Selected");
            this.selectedIndex = index;
            this.focusedData = data;
        } else {
            Dom.removeClass(node, "Selected");
        }
    }
    this.focus();
};

QuickDataSelectorInput.prototype.onFound = function (query, items) {
    this.currentLoader = null;
    if (items && items.length > 0) {
        this.setupItems(items);
        this.popup.show(this.node(), "left-inside", "bottom", 0, 5);
        this.input.focus();
    } else {
        this.popup.closeUpward();
    }
};
QuickDataSelectorInput.prototype.setupItems = function (items) {
    var first = null;
    this.items = items;
    this.list.innerHTML = "";
    this._invalidateSelectionCount();
    if (!this.items) return;
    
    this._appendItemsToContainer(this.list, items, 0);
    // 
    // if (this.items.length > 0) {
    //     this.selectItemAt(0);
    //     if (this.node().value == this.builder(first)) {
    //         this.selectedData = first;
    //     }
    // }
    //this.selectItem(first);
};

QuickDataSelectorInput.prototype._appendItemsToContainer = function (container, items, level) {
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var element = this.renderer(item);
        var node = null;
        if (element.getAttribute) {
            node = Dom.newDOMElement(Dom.hbox("Item ItemL" + level, {_name: "input", type: "checkbox"}));
            Dom.addClass(element, "RenderedContent");
            node.appendChild(element);
        } else {
            var spec = {
                _name: "div",
                "class": "Item ItemL" + level,
                _text: element
            };

            spec[this.useHtml ? "_html" : "_text"] = element;
            node = Dom.newDOMElement(spec);
        }
        if (this.decorator) this.decorator(node, item);
        node._data = item;
        container.appendChild(node);
        
        if (item.children && item.children.length > 0) {
            var vbox = Dom.newDOMElement(Dom.vbox("Children ChildrenL" + level));
            container.appendChild(vbox);
            
            this._appendItemsToContainer(vbox, item.children, level + 1);
        }
    }

};

QuickDataSelectorInput.prototype.getSelectedData = function () {
    return this.selectedData;
};
QuickDataSelectorInput.prototype.setSelectedData = function (data) {
    this.selectedData = data;
    this.input.value = data ? this.builder(data) : "";
};

QuickDataSelectorInput.prototype.getText = function () {
    return this.input.value;
};

QuickDataSelectorInput.prototype.focus = function () {
    return this.input.focus();
};

function QuickDataSelectorInputLoader(owner) {
    this.canceled = false;
    this.owner = owner;
}

QuickDataSelectorInputLoader.prototype.cancel = function () {
    this.canceled = true;
    this.owner = null;
};
QuickDataSelectorInputLoader.prototype.start = function (query, source) {
    var thiz = this;
    source(query, function (items) {
        if (thiz.canceled) return;
        thiz.owner.onFound(query, items);
    });
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ChipList.js";

function ChipList(node) {
    BaseTemplatedWidget.call(this);
    this.items = [];

    var hint = Util.getProperty(node, "placeholder", "");
    this.autoCompleteInput.setAttribute("placeholder", hint);
    this.bind("p:ItemSelected", function (event) {
        var item = this.autoCompleteInput.getSelectedData();
        if (!item) return;
        if (!this.onItemSelected(item, event.__target)) {
            this.add(item, "fromUser");
        }
        this.autoCompleteInput.setSelectedData(null);
    }, this.autoCompleteInput);
    this.bind("keydown", this.handleKeyDown);
    this.bind("click", this.handleClick);
    this.bind("paste", this.handlePaste, this.autoCompleteInput.node());
    
    this.setEnabled(true);
}

__extend(BaseTemplatedWidget, ChipList);
ChipList.prototype.getValidationUITarget = function () {
    return this.autoCompleteInput.node();
};
ChipList.prototype.onItemSelected = function(item, target) {
    return false;
}
ChipList.prototype.isSelectItemEvent = function(event) {
    return event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN;
}
ChipList.prototype.setup = function (source, renderer) {
    this.source = source;
    this.renderer = renderer;

    this.autoCompleteInput.setup(source, renderer, renderer);
    this.autoCompleteInput.timeout = 50;
    // this.autoCompleteInput.suggestOnBlank = true;
    if (this.placeholder) this.autoCompleteInput.node().setAttribute("placeholder", this.placeholder);
    this.autoCompleteInput.isSelectItemEvent =  this.isSelectItemEvent;
};

ChipList.prototype.add = function (item, fromUserAction) {
    var view = this.createChipView(item);
    view._data = item;
    this.node().insertBefore(view, this.autoCompleteInput.node());
    Dom.emitEvent("p:ItemSelected", this.node(), {fromUser: fromUserAction ? true : false});
    if (fromUserAction) {
        Dom.emitEvent("p:ValueChanged", this.node(), {fromUser: true});
    }
};
ChipList.prototype.focus = function () {
    this.autoCompleteInput.focus();
};
ChipList.prototype.createChipView = function (item) {
    return Dom.newDOMElement({
        _name: "hbox",
        "class": "Item",
        tabindex: 0,
        _children: [
            {_name: "span", _text: this.renderer(item, true)},
            {_name: "icon", "class": "close-circle CloseIcon"}
        ]
    });
};
ChipList.prototype.getItems = function () {
    var items = [];
    for (var i = 0; i < this.node().childNodes.length; i ++) {
        var node = this.node().childNodes[i];
        if (node._data) items.push(node._data);
    }

    return items;
};
ChipList.prototype.setItems = function (items) {
    var chips = [];
    for (var i = 0; i < this.node().childNodes.length; i ++) {
        var node = this.node().childNodes[i];
        if (!node._data || !Dom.hasClass(node, "Item")) continue;
        chips.push(node);
    }
    for (var i = 0; i < chips.length; i ++) this.node().removeChild(chips[i]);
    for (var i = 0; i < items.length; i ++) this.add(items[i]);
};
ChipList.prototype.handleKeyDown = function (event) {
    if ("false" == this.node().getAttribute("active")) return;

    if (event.target == this.autoCompleteInput.node()) {
        if (event.keyCode == DOM_VK_BACK_SPACE || event.keyCode == DOM_VK_LEFT) {
            if (this.autoCompleteInput.getText() != "") return;
            Dom.cancelEvent(event);
            var prev = this.autoCompleteInput.node().previousSibling;
            if (prev && prev.focus) prev.focus();
            return;
        }

        if (event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN) {
            Dom.cancelEvent(event);
            return;
        }

    } else {
        var chip = Dom.findUpwardForNodeWithData(event.target, "_data");
        if (!chip || !Dom.hasClass(chip, "Item")) return;

        if (event.keyCode == DOM_VK_DELETE || event.keyCode == DOM_VK_BACK_SPACE) {
            chip.parentNode.removeChild(chip);
            this.autoCompleteInput.node().focus();
            Dom.emitEvent("p:ValueChanged", this.node(), {fromUser: true});
            return;
        }
        if (event.keyCode == DOM_VK_LEFT) {
            var prev = chip.previousSibling;
            if (prev && prev._data) prev.focus();
            return;
        }
        if (event.keyCode == DOM_VK_RIGHT) {
            var next = chip.nextSibling;
            if (next) next.focus()
            return;
        }
    }
};

ChipList.prototype.setEnabled = function(enable) {
    Dom.setEnabled(enable, this.autoCompleteInput);
    this.node().setAttribute("active", enable);
}

ChipList.prototype.handleClick = function (event) {
    if ("false" == this.node().getAttribute("active")) return;

    if (event.target == this.autoCompleteInput.node()) {
        this.autoCompleteInput.autoCompleteNow();
    } else {
        var icon = Dom.findParentWithClass(event.target, "CloseIcon");
        if (!icon) return;
        var chip = Dom.findUpwardForNodeWithData(event.target, "_data");
        if (!chip || !Dom.hasClass(chip, "Item")) return;

        chip.parentNode.removeChild(chip);
        Dom.emitEvent("p:ValueChanged", this.node(), {fromUser: true});
        this.autoCompleteInput.node().focus();
    }
};
ChipList.prototype.autoCompleteNow = function() {
    this.autoCompleteInput.autoCompleteNow();
}
ChipList.prototype.handlePaste = function(event) {
    if (!this.externalDataParser) return;
    var thiz = this;
    window.setTimeout(function () {
        var value = thiz.autoCompleteInput.node().value;
        if (!value) return;
        
        thiz.externalDataParser(value, function (items, remaining) {
            if (items && items.length > 0) {
                items.forEach(function (item) {
                    thiz.add(item, "fromUser");
                });
            }
            
            thiz.autoCompleteInput.node().value = remaining || "";
        });
    }, 10);
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/SnackBar.js";

function SnackBar() {
    BaseTemplatedWidget.call(this);
    this.items = [];

    this.bind("click", this.close, this.closeButton);
    this.bind("click", this.onActionClick, this.actionButton);
}

__extend(BaseTemplatedWidget, SnackBar);

SnackBar.prototype.setup = function (message, actionTitle, actionHandler, icon, extraMessage, closable) {
    Dom.addClass(this.icon, icon || "checkbox-marked-circle");
    Dom.setInnerText(this.message, message);

    Dom.toggleClass(this.node(), "WithExtraMessage", extraMessage ? true : false);
    Dom.setInnerText(this.extraMessage, extraMessage || "");

    Dom.toggleClass(this.node(), "WithAction", actionTitle ? true : false);
    Dom.setInnerText(this.actionButton, actionTitle);
    this.actionHandler = actionHandler;

    Dom.toggleClass(this.node(), "Closable", closable ? true : false);
    this.closable = closable;
};
SnackBar.prototype.onActionClick = function () {
    if (!this.actionHandler) return;
    this.close();
    this.actionHandler();
};
SnackBar.prototype.close = function () {
    window.clearTimeout(this.closeTimeout);

    var node = this.node();
    node.style.top = "-" + Math.ceil(node.offsetHeight / Util.em()) + "em";
    node.style.opacity = "0";
    window.setTimeout(function () {
        node.parentNode && node.parentNode.removeChild(node);
    }, 350);
};
SnackBar.show = function (message, action, actionHandler, icon, extraMessage, closable) {
    var snackBar = new SnackBar();
    snackBar.setup(message, action, actionHandler, icon, extraMessage, closable);
    Dom.addClass(snackBar.node(), "Floating");
    snackBar.node().style.position = "fixed";
    snackBar.node().style.opacity = "0";
    snackBar.node().style.visibility = "hidden";
    snackBar.node().style.transition = "top 0.3s ease, opacity 0.3s ease";
    snackBar.into(document.body);

    var height = Math.ceil(snackBar.node().offsetHeight / Util.em());
    var width = snackBar.node().offsetWidth;
    snackBar.node().style.top = "-" + height + "em";
    snackBar.node().style.left = Math.round((document.body.offsetWidth - width) / 2) + "px";
    window.setTimeout(function () {
        var header = typeof(MobileHeader) != "undefined" && typeof(MobileHeader.instance) != "undefined";
        var isMobileUI = header && Util.isMobileUI();
        var isTabletUI = header && Util.isTabletUI();
        snackBar.node().style.visibility = "visible";
        snackBar.node().style.top = isMobileUI || isTabletUI ? "5em" : "1em";
        snackBar.node().style.opacity = "1";

        snackBar.closeTimeout = window.setTimeout(function () {
            snackBar.close();
        }, action ? 7000 : 5000);
    }, 10);

    return snackBar;
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/TextView.js";

function TextView() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, TextView);
TextView.prototype.onAttached = function() {
}
TextView.prototype.setText = function(text) {
    Dom.setInnerText(this.label, text);
    var h = Dom.getOffsetHeight(this.label);
    var w = Dom.getOffsetWidth(this.label);
    
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ScrollbarlessScrollView.js";

function ScrollbarlessScrollView () {
    BaseTemplatedWidget.call(this);
    
    this.bind("scroll", this._invalidateScrollbar, this.container);

    var thiz = this;
    
    Dom.onResize(this.container, function () { thiz._invalidateScrollbar(); });
    Dom.onResize(this.container, function () { thiz._invalidateScrollbar(); }, true);
    
    this.bind("mousedown", function (e) {
        ScrollbarlessScrollView._heldInstance = thiz;
        ScrollbarlessScrollView._lastY = e.screenY;
        ScrollbarlessScrollView._lastOffset = Math.round(thiz.container.scrollTop);
        ScrollbarlessScrollView._lastFactor = thiz.container.scrollHeight / thiz.container.offsetHeight;
        Dom.addClass(thiz.node(), "ThumbHeld");
        Dom.cancelEvent(e);
        thiz.fireVerticalScrolledEvent();
    }, this.thumb);
    
    if (!ScrollbarlessScrollView._globalListenersInstalled) {
        document.addEventListener("mousemove", ScrollbarlessScrollView._handleMouseMove, false);
        document.addEventListener("mouseup", function () {
            if (ScrollbarlessScrollView._heldInstance) {
                Dom.removeClass(ScrollbarlessScrollView._heldInstance.node(), "ThumbHeld");
            }
            ScrollbarlessScrollView._heldInstance = null;
        }, false);

        ScrollbarlessScrollView._globalListenersInstalled = true;
    }
}

__extend(BaseTemplatedWidget, ScrollbarlessScrollView);
ScrollbarlessScrollView._handleMouseMove = function (event) {
    if (!ScrollbarlessScrollView._heldInstance) return;
    
    Dom.cancelEvent(event);
    
    var thiz = ScrollbarlessScrollView._heldInstance;
    var dy = event.screenY - ScrollbarlessScrollView._lastY;
    var maxOffset = thiz.container.scrollHeight - thiz.container.offsetHeight;
    var offset = ScrollbarlessScrollView._lastOffset + dy * ScrollbarlessScrollView._lastFactor;
    offset = Math.max(0, Math.min(maxOffset, offset));
    
    thiz.container.scrollTop = offset;
    
    thiz.fireVerticalScrolledEvent();
};
ScrollbarlessScrollView.prototype.setContentFragment = function (fragment) {
    this.container.appendChild(fragment);
};

ScrollbarlessScrollView.prototype._invalidateScrollbar = function () {
    var h = Math.round(this.container.offsetHeight);
    var H = Math.round(this.container.scrollHeight);
    var offset = Math.round(this.container.scrollTop);
    
    var isVertcalOverflowed = H > h;
    Dom.toggleClass(this.node(), "VerticalOverflowed", isVertcalOverflowed);
    if (isVertcalOverflowed) {
        this.thumb.style.top = (100 * offset / H) + "%";
        this.thumb.style.height = (100 * h / H) + "%";
        this.fireVerticalScrolledEvent();
    }
};

ScrollbarlessScrollView.prototype.setUnscrollabled = function (unscollabled) {
    Dom.toggleClass(this.node(), "Unscrollabled", unscollabled);
};
ScrollbarlessScrollView.prototype.getDistanceToEnd = function () {
    var scrollPane = this.container;
    return Math.max(0, scrollPane.scrollHeight - (scrollPane.scrollTop + scrollPane.clientHeight));
};
ScrollbarlessScrollView.prototype.fireVerticalScrolledEvent = function () {
    Dom.emitEvent("p:VerticalScrolled", this.node());
};

if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/NPatchScalableView.js";

function NPatchScalableView(n) {
    BaseTemplatedWidget.call(this);

    this.originalSize = {
        w: parseInt(n.getAttribute("width"), 10),
        h: parseInt(n.getAttribute("height"), 10)
    };

    var d = n.getAttribute("d");
    this.model = NPatchScalableView.parsePathData(d);

    this.xCells = NPatchScalableView.parseCellString(n.getAttribute("xcells"));
    this.yCells = NPatchScalableView.parseCellString(n.getAttribute("ycells"));
    
    this.withShadow = Dom.getAttributeAsBoolean(n, "shadow", false);
    
    if (!this.withShadow) this.shadowPath.setAttribute("style", "display: none;");

    this.pathPadding = n.hasAttribute("padding") ? parseInt(n.getAttribute("padding"), 10) : (this.withShadow ? 10 : 0);
}
__extend(BaseTemplatedWidget, NPatchScalableView);

NPatchScalableView.prototype.onSizeChanged = function () {
    var w = this.node().offsetWidth;
    var h = this.node().offsetHeight;

    var stroke = Math.ceil(parseFloat(window.getComputedStyle(this.path).strokeWidth));
    if (stroke % 2 == 1) stroke ++;

    this.svg.setAttribute("width", w);
    this.svg.setAttribute("height", h);

    w -= stroke + 2 * this.pathPadding;
    h -= stroke + 2 * this.pathPadding;

    var delta = this.translateDelta || (stroke / 2 + this.pathPadding);
    if (isNaN(delta)) delta = 0;

    var model = JSON.parse(JSON.stringify(this.model));
    var d = NPatchScalableView.scalePathData(model, this.xCells, this.yCells, this.originalSize, {w: w, h: h});
    if (!d || d.indexOf("NaN") >= 0) d = "M0 0";
    this.path.setAttribute("d", d);
    this.path.setAttribute("transform", "translate(" + delta + ", " + delta + ")");
    
    if (this.withShadow) {
        this.shadowPath.setAttribute("d", d);
        this.shadowPath.setAttribute("transform", "translate(" + delta + ", " + delta + ")");
        
        this.shadowPath.setAttribute("style", "fill:#000000;stroke:none;fill-opacity:0.67353457;filter:url(#" + this.shadowFilter.getAttribute("id") + ")");
    }
};

NPatchScalableView.buildNPatchModel = function (cells, originalSize, newSize) {
    var totalScaleSize = 0;
    for (var i = 0; i < cells.length; i ++) {
        var cell = cells[i];
        totalScaleSize += (cell.to - cell.from);
    }

    var r = (newSize - (originalSize - totalScaleSize)) / totalScaleSize;

    var models = [];
    var total = 0;
    var scaledTotal = 0;
    var last = false;

    //add a sentinel
    cells = cells.concat([{from: originalSize, to: originalSize + 1}]);

    for (var i = 0; i < cells.length; i ++) {
        var cell = cells[i];
        if (cell.from == cell.to) continue;

        var last = (i == cell.length - 2);

        var model = null;
        if (cell.from > total) {
            model = {
                start: total,
                size: cell.from - total,
                scaledStart: scaledTotal,
                scale: false
            };

            models.push(model);
            total = cell.from;
            scaledTotal += model.size;
        }

        if (cell.from >= originalSize) break;

        var scaledSize = (last ? (newSize - (originalSize - cell.to) - scaledTotal) : (r * (cell.to - cell.from)));

        model = {
            start: total,
            size: cell.to - cell.from,
            scaledStart: scaledTotal,
            scaledSize: scaledSize,
            scale: true
        };

        model.r = model.scaledSize / model.size;

        models.push(model);
        total = cell.to;
        scaledTotal += model.scaledSize;
    }

    return models;
};

NPatchScalableView.parsePathData = function (pathDataLiteral) {
    function normalize(pin) {
        // pin.x = Math.round(pin.x);
        // if (typeof(pin.y) == "number") pin.y = Math.round(pin.y);
    }
    function normalizeAll(pins) {
        // for (var pin of pins) normalize(pin);
    }

    function processMultiPoints(points, current, chunk, relative) {
        var count = Math.ceil(points.length / chunk);
        for (var i = 0; i < count; i ++) {
            var pin = points[i * chunk + (chunk - 1)];

            for (var j = 0; j < (chunk - 1); j ++) {
                var p = points[i * chunk + j];
                if (relative) {
                    p.x += current.x;
                    p.y += current.y;
                }

                p.fixed = true;
            }

            normalize(pin);

            if (relative) {
                pin.x += current.x;
                pin.y += current.y;
            }
            current = pin;
        }

        return current;
    }

    //parse the original data
    var RE = /([A-Z])([^A-DF-Z]*)/gi;
    var commands = [];
    var result = null;
    var current = {x: 0, y: 0};
    while ((result = RE.exec(pathDataLiteral))) {
        var c = result[1];
        var command = {
            command: c.toUpperCase()
        };
        var data = result[2].trim();
        if (data) {
            var DATA_RE = /(\-?[0-9\.eE\-]+)(\,(\-?[0-9\.eE\-]+))?/g;
            var points = [];
            var result2 = null;
            while ((result2 = DATA_RE.exec(data))) {
                var x = parseFloat(result2[1]);
                var y = result2[3];
                if (y) y = parseFloat(y);
                points.push({
                    x: x,
                    y: y
                });
            }

            if (c == "M" || c == "L" || c == "T") {
                normalizeAll(points);
                command.points = points;
                current = points[points.length - 1];
            } else if (c == "m" || c == "l" || c == "t") {
                for (var i = 0; i < points.length; i ++) {
                    var p = points[i];
                    p.x += current.x;
                    p.y += current.y;

                    current = p;
                }
                normalizeAll(points);
                command.points = points;
            } else if (c == "H") {
                for (var i = 0; i < points.length; i ++) {
                    var p = points[i];
                    p.y = current.y;
                    current = p;
                }
                normalizeAll(points);
                command.points = points;
                command.command = "L";
            } else if (c == "h") {
                for (var i = 0; i < points.length; i ++) {
                    var p = points[i];
                    p.x += current.x;
                    p.y = current.y;
                    current = p;
                }
                normalizeAll(points);
                command.points = points;
                command.command = "L";
            } else if (c == "V") {
                for (var i = 0; i < points.length; i ++) {
                    var p = points[i];
                    p.y = p.x;
                    p.x = current.x;
                    current = p;
                }
                normalizeAll(points);
                command.points = points;
                command.command = "L";
            } else if (c == "v") {
                for (var i = 0; i < points.length; i ++) {
                    var p = points[i];
                    p.y = p.x + current.y;
                    p.x = current.x;
                    current = p;
                }
                normalizeAll(points);
                command.points = points;
                command.command = "L";
            } else if (c == "c" || c == "C") {
                current = processMultiPoints(points, current, 3, c == "c");
                command.points = points;
            } else if (c == "s" || c == "S") {
                current = processMultiPoints(points, current, 2, c == "s");

                command.points = points;
            } else if (c == "q" || c == "Q") {
                current = processMultiPoints(points, current, 2, c == "q");
                command.points = points;
            } else if ((c == "a" || c == "A") && points.length == 5) {
                for (var i = 0; i < points.length; i ++) {
                    var p = points[i];
                    p.fixed = true;
                    p.noRelativeRecalcuate = true;
                }
                var pin = points[4];
                pin.fixed = false;
                pin.noRelativeRecalcuate = false;
                if (c == "a") {
                    pin.x += current.y;
                    pin.y += current.y;
                }
                current = pin;

                normalizeAll(points);
                command.points = points;
                command.command = "A";
            }
        }

        commands.push(command);
    }

    return commands;

};

NPatchScalableView.calculateScaledPosition = function (value, models) {
    if (!models || models.length == 0) return value;
    var m = null;

    if (value < models[0].start) {
        m = models[0];
    } else {
        for (var i = 0; i < models.length; i ++) {
            var model = models[i];
            if (model.start <= value && value < (model.start + model.size)) {
                m = model;
                break;
            }
        }

        if (!m) m = models[models.length - 1];
    }

    if (m) {
        var d = value - m.start;

        if (m.scale) d *= m.r;

        return d + m.scaledStart;
    }

    return value;
};


NPatchScalableView.scalePathData = function (pathCommands, xCells, yCells, originalSize, newSize) {
    xCells = xCells || [];
    yCells = yCells || [];

    var xModel = NPatchScalableView.buildNPatchModel(xCells, originalSize.w, newSize.w);
    var yModel = NPatchScalableView.buildNPatchModel(yCells, originalSize.h, newSize.h);

    var newData = "";

    for (var k = 0; k < pathCommands.length; k ++) {
        var command = pathCommands[k];
        if (command.points) {
            var last = -1;
            for (var i = 0; i < command.points.length; i ++) {
                var pin = command.points[i];
                if (pin.fixed) {
                    continue;
                }

                var x = NPatchScalableView.calculateScaledPosition(pin.x, xModel);
                var y = NPatchScalableView.calculateScaledPosition(pin.y, yModel);

                for (var j = last + 1; j < i; j ++) {
                    if (command.points[j].noRelativeRecalcuate) continue;
                    command.points[j].x = x + command.points[j].x - pin.x;
                    if (typeof(command.points[j].y) == "number") command.points[j].y = y + command.points[j].y - pin.y;
                }

                pin.x = x;
                pin.y = y;
                last = i;
            }
        }

        if (newData) newData += " ";
        newData += command.command;
        if (command.points) {
            for (var i = 0; i < command.points.length; i ++) {
                var y = command.points[i].y;
                newData += (i > 0 ? " " : "") + command.points[i].x + (typeof(y) == "number" ? ("," + y) : "");
            }
        }
    }

    return newData;
};
NPatchScalableView.generatePathDOM = function (model, xCells, yCells, originalSize, size, style) {
    var specs = [];
    var d = NPatchScalableView.scalePathData(model, xCells, yCells, originalSize, size);
    specs.push({
        _name: "path",
        _uri: "http://www.w3.org/2000/svg",
        d: d,
        "stroke-linecap": "square",
        style: style ? style : ""
    });

    return Dom.newDOMFragment(specs);
};

NPatchScalableView.parseCellString = function (literal) {
    var cells = [];
    var blocks = literal.split(/[ ]+/);
    for (var i = 0; i < blocks.length; i ++) {
        var block = blocks[i];
        if (block.match(/^[ ]*([0-9]+)[ ]*\-[ ]*([0-9]+)[ ]*$/)) {
            cells.push({
                from: parseInt(RegExp.$1, 10),
                to: parseInt(RegExp.$2, 10)
            })
        }
    }

    return cells;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/MediaCollectionView.js";

function MediaCollectionView() {
    BaseTemplatedWidget.call(this);
    this.items = [];

    var thiz = this;
    this.mediaGrid = new MediaCollectionView.Impl.MediaGrid(this.node(),
                        {
                            spacing: 2,
                            onItemClicked: function (item) {
                                thiz.startSlideShowAt(thiz.items.indexOf(item), true);
                            },
                            onMoreClicked: function () {
                                thiz.startSlideShowAt(thiz.mediaGrid.moreIndex);
                            }
                        });

    this.closable = {
        close: function () {
            Dom.removeClass(thiz.fullscreenView, "Active");
        }
    };
    this.bind("click", function () {
        this.closable.close();
        BaseWidget.unregisterClosable(this.closable);
    }, this.closeButton);

    this.bind("click", function () {
        this.gotoMedia(this.currentIndex - 1);
    }, this.prevButton);
    this.bind("click", function () {
        this.gotoMedia(this.currentIndex + 1);
    }, this.nextButton);
}

__extend(BaseTemplatedWidget, MediaCollectionView);

MediaCollectionView.prototype.onAttached = function () {
    if (this.fullscreenView) {
        this.reparent();
    }
    Dom.removeClass(this.fullscreenView, "Active");
};
MediaCollectionView.prototype.setIndicator = function(indicator) {
    this._indicator = indicator;
}
MediaCollectionView.prototype.startSlideShowAt = function (index, play) {
    this.reparent();
    BaseWidget.registerClosable(this.closable);
    Dom.addClass(this.fullscreenView, "Active");
    this.gotoMedia(index, play);
};

MediaCollectionView.prototype.reparent = function() {
    if (!this.fullscreenView.parentNode || (this.fullscreenView.parentNode != this.node().ownerDocument.body)) {
        if (this.fullscreenView.parentNode) {
            this.fullscreenView.parentNode.removeChild(this.fullscreenView);
        }
        this.node().ownerDocument.body.appendChild(this.fullscreenView);
    }
}
MediaCollectionView.prototype.kill = function() {
    if (this.fullscreenView && this.fullscreenView.parentNode == this.node().ownerDocument.body) {
        this.fullscreenView.parentNode.removeChild(this.fullscreenView);
    }
}
MediaCollectionView.prototype.onDetached = function() {
    this.kill();
}
MediaCollectionView.prototype.gotoMedia = function (index, forcePlay) {
    if (index >= this.items.length || index < 0) return;
    this.currentIndex = index;
    var item = this.items[index];
    if (item.video) {
        Dom.addClass(this.fullscreenView, "ViewingVideo");
        this.fullscreenVideoView.setVideo({id: item.video, type: "wistia", autoPlay: forcePlay ? true : false});
    } else {
        Dom.removeClass(this.fullscreenView, "ViewingVideo");
        this.fullscreenImageView.setIndicator(this._indicator);
        this.fullscreenImageView.setUrl(item.fullUrl || item.src);
    }
    Dom.toggleClass(this.fullscreenView, "HasNext", this.items.length > this.currentIndex + 1);
    Dom.toggleClass(this.fullscreenView, "HasPrev", this.currentIndex > 0);
    Dom.setInnerText(this.mediaInfoLabel, ("Item " + (this.currentIndex + 1) + " of " + this.items.length + " items").toUpperCase());
};
MediaCollectionView.prototype.handleMoreClicked = function () {
};

MediaCollectionView.prototype.setContentFragment = function (fragment) {
    var urls = [];
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node || !node.getAttribute) continue;
        var src = node.getAttribute("src");
        var videoId = node.getAttribute("video-id");
        urls.push({url: src ? src : "", video: videoId});
    }
    if (urls && urls.length > 0) this.setUrls(urls);
};
MediaCollectionView.prototype.setUrls = function (urls, callback) {
    var items = [];
    var index = -1;

    var thiz = this;
    function next() {
        index ++;
        if (index >= urls.length) {
            thiz.setItems(items);
            if (callback) callback();
            Dom.addClass(thiz.node(), "Initialized");
            var showMediaInfo = Dom.getAttributeAsBoolean(thiz.node(), "show-media-info-on-fullscreen", false);
            if (showMediaInfo) {
                Dom.addClass(thiz.fullscreenView, "MediaInfo");
            } else {
                Dom.removeClass(thiz.fullscreenView, "MediaInfo");
            }
            var startAt = Dom.getAttributeAsInt(thiz.node(), "start-slide-show-at", -1);
            if (startAt >= 0) {
                thiz.startSlideShowAt(startAt);
            }
            return;
        }
        var url = urls[index];
        var videoId = "";
        if (typeof(url) == "object") {
            videoId = url.video || "";
            url = url.url || "";
        }
        var m = typeof(url) == "string" ? url.match("^((.+)\\-([tsmlh]+))\\-[a-z]+\\.(jpg|png)") : undefined;
        var thumb = url;
        if (m && m.length == 5) {
            var specs = m[3];
            thumb = m[1] + "-" + (specs && specs.indexOf("s") >= 0 ? "small" : "thumb")
            //Extension
            + "." + m[4];
        }
        var item = {
            src: url,
            fullUrl: url,
            video: videoId,
            thumbSrc: thumb
        };
        items.push(item);

        var image = new Image();
        var retried = false;
        image.onload = function () {
            item.width = image.naturalWidth;
            item.height = image.naturalHeight;
            item.src = image.src;
            next();
        };
        image.onerror = function () {
            if (retried || item.src == item.thumbSrc) {
                item.width = 10;
                item.height = 10;
                next();
            } else {
                image.src = item.src;
                retried = true;
            }
        };
        image.src = (item.thumbSrc && item.thumbSrc.length > 0) ? item.thumbSrc : item.src;
    }

    next();
};
MediaCollectionView.prototype.setItems = function (items) {
    this.items = items;
    this.mediaGrid.setItems(items);
};

MediaCollectionView.Impl = {};

(function (context) {
    "use strict";
    function fallback(value, defaultValue) {
        return typeof(value) != "undefined" ? value : defaultValue;
    }
    function _getSize(view) {
        return {w: view.offsetWidth, h: view.offsetHeight};
    }
    function getTop(view) {
        return (view.offsetParent ? getTop(view.offsetParent) : 0) + view.offsetTop;
    }
    function findTopForClass(node, className) {
        if (node.classList && node.classList.contains(className)) return node;
        if (node.parentNode) return findTopForClass(node.parentNode, className);
        return null;
    }

    var SPECS = {
        "1L": {
            layout: "<hbox>{0}</hbox>",
            height: function () {
                var item = this.items[0];
                return item.w ? Math.round(this.W * item.height / item.width) : 0;
            }
        },
        "1P": {
            layout: "<hbox>{0}</hbox>",
            height: function () {
                var item = this.items[0];
                return item.w ? Math.round(this.W * Math.min(1.5, item.height / item.width)) : 0;
            }
        },
        "1S": {
            layout: "<hbox>{0}</hbox>",
            height: function () {
                return this.W;
            }
        },
        "2S": {
            layout: "<hbox>{0}{1}</hbox>",
            height: function () {
                return Math.round((this.W - this.spacing) / 2);
            }
        },
        "2PP": {
            layout: "<hbox>{0}{1}</hbox>",
            height: function () {
                return this.W;
            }
        },
        "2LL": {
            layout: "<vbox>{0}{1}</vbox>",
            height: function () {
                return this.W;
            }
        },
        "2LP": "2S",
        "2PL": "2S",
        "2LS": "2S",
        "2PS": "2S",
        "3L": {
            layout: "<vbox>{0}<hbox>{1}{2}</hbox></vbox>",
            height: function () {
                return this.W;
            }
        },
        "3P": {
            layout: "<hbox>{0}<vbox>{1}{2}</vbox></hbox>",
            height: function () {
                return this.W;
            }
        },
        "3S": {
            layout: "<hbox>{0}{1}{2}</hbox>",
            height: function () {
                return Math.round((this.W - 2 * this.spacing) / 3);
            }
        },
        "4L": {
            layout: "<vbox>{0:2}<hbox>{1}{2}{3}</hbox></vbox>",
            height: function () {
                return this.W;
            }
        },
        "4P": {
            layout: "<hbox>{0:2}<vbox>{1}{2}{3}</vbox></hbox>",
            height: function () {
                return this.W;
            }
        },
        "4S": {
            layout: "<vbox><hbox>{0}{1}</hbox><hbox>{2}{3}</hbox></vbox>",
            height: function () {
                return this.W;
            }
        }
    };

    var MAX_DEFINED = 4;
    var SQUARE_THRESHOLD = 0.1;

    function getOrientation(item) {
        if (item.height == 0 || item.width == 0) return "S";
        var r = item.width / item.height;
        var o = r < (1 - SQUARE_THRESHOLD) ? "P" : (r > (1 + SQUARE_THRESHOLD) ? "L" : "S");
        return (o == "P" && item.video) ? "S" : o;
    }
    function findSpec(items) {
        var count = Math.min(items.length, MAX_DEFINED);
        var name = "" + count + getOrientation(items[0]) + (items.length > 1 ? getOrientation(items[1]) : "#");
        for (var spName in SPECS) {
            if (name.indexOf(spName) == 0) {
                var spec = SPECS[spName];
                while (typeof(spec) == "string") spec = SPECS[spec];
                return spec;
            }
        }

        return null;
    }

    function MediaGrid(providedContainer, optionalOptions) {
        var options = optionalOptions || {};

        this.options = {
            spacing: options.spacing || 2,
            onItemClicked: options.onItemClicked || null,
            onMoreClicked: options.onMoreClicked || null
        };

        this.container = providedContainer;
        this.uniqueClassName = "MediaGridInstance" + (new Date().getTime());

        var thiz = this;

        this.container.addEventListener("click", function (e) {
            var view = findTopForClass(e.target, "ItemView");
            if (view) {
                var viewMore = findTopForClass(e.target, "ItemViewSeeMore");
                if (viewMore) {
                    if (thiz.options.onMoreClicked) thiz.options.onMoreClicked();
                    return;
                }

                if (thiz.options.onItemClicked && view._item) thiz.options.onItemClicked(view._item);
            }
        }, false);
    }

    function generateCSS() {
        var css = "";
        var prefix = "." + this.uniqueClassName + " ";
        css += prefix + "hbox, " + prefix + "vbox {display: -webkit-box; display: -webkit-flex; display: -ms-flexbox; display: flex; overflow: hidden;}\n";
        css += prefix + "hbox {-webkit-flex-direction: row; flex-direction: row; -webkit-flex-wrap: nowrap; flex-wrap: nowrap;}\n";
        css += prefix + "vbox {-webkit-flex-direction: column; flex-direction: column; -webkit-flex-wrap: nowrap; flex-wrap: nowrap;}\n";
        css += prefix + "*[flex='1'] {flex: 1 1 1em;}\n";
        css += prefix + "*[flex='2'] {flex: 2 1 1em;}\n";
        css += prefix + "*[flex='3'] {flex: 3 1 1em;}\n";
        css += prefix + "*[flex='4'] {flex: 4 1 1em;}\n";
        css += prefix + "hbox > * + * {margin-left: " + this.options.spacing + "px;}\n";
        css += prefix + "vbox > * + * {margin-top: " + this.options.spacing + "px;}\n";
        css += prefix + "*[item] {position: relative; overflow: hidden;}\n";
        css += prefix + "*[media-type='video'] {background: #333;}\n";
        css += prefix + "*[item] > .ItemViewSeeMore {position: absolute; background: rgba(0, 0, 0, 0.5); top: 0px; left: 0px; right: 0px; bottom: 0px; display: -webkit-box; display: -webkit-flex; display: -ms-flexbox; display: flex; overflow: hidden; -webkit-flex-direction: row; flex-direction: row; -webkit-flex-wrap: nowrap; flex-wrap: nowrap; align-items: flex-center; align-items: center;}\n";
        css += prefix + "*[item] > .ItemViewSeeMore > span {font-size: 2em; color: #FFF; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.4); display: block; flex: 1 1 1em; text-align: center;}\n";
        css += prefix + "*[item] > .ItemOverlay:hover > span {opacity: 1;}\n";

        var head = this.container.ownerDocument.head || this.container.ownerDocument.getElementsByTagName("head")[0];
        var style = document.createElement("style");
        style.type = "text/css";

        if (style.styleSheet) {
            style.styleSheet.cssText = "";
        }

        head.appendChild(style);
        style.appendChild(document.createTextNode(css));
    }

    function createItemView(item, container, index) {
        //center crop
        var ps = _getSize(container);
        if (ps.w == 0 || ps.h == 0) {
            if (ps.w <= 0 && item.width > 0) {
                ps.w = Math.min(item.width, Dom.getOffsetWidth(document.body));
            }
            if (ps.h <= 0 && item.height > 0) {
                ps.h = Math.min(item.height, Dom.getOffsetHeight(document.body));
            }
        }
        if (ps.w == 0 || ps.h == 0) return;

        var o = getOrientation(item);
        var r = (item.video && o != "L") ? Math.max(item.width / ps.w, item.height / ps.h) : Math.min(item.width / ps.w, item.height / ps.h);

        var img = container.ownerDocument.createElement("img");
        var w = Math.round(item.width / r);
        var h = Math.round(item.height / r);
        var ml = Math.round((ps.w - w) / 2);
        var mt = Math.round((ps.h - h) / 2);

        img.setAttribute("style", "width: " + w + "px; height: " + h + "px; margin-left: " + ml + "px; margin-top: " + mt + "px;");
        var src = item.thumbSrc;
        if (w > item.width || h > item.height) src = item.src;

        img.src = src;
        container.appendChild(img);
        container.setAttribute("media-type", item.video ? "video" : "photo");

        if (item.video) {
            var overlay = container.ownerDocument.createElement("div");
            overlay.setAttribute("class", "ItemOverlay");
            overlay.className = "ItemOverlay";
            var i = container.ownerDocument.createElement("icon");
            i.setAttribute("class", "play PlayButton");
            overlay.appendChild(i);
            container.appendChild(overlay);
        }
    }

    function populateMediaItems(container, items) {
        if (!container || !container.childNodes) return;

        this.lastPopulatedItemView = null;
        this.lastPopulatedItemIndex = -1;
        for (var i = 0; i < container.childNodes.length; i ++) {
            var child = container.childNodes[i];
            if (!child.getAttribute) continue;

            var index = child.getAttribute("item");
            if (index) {
                index = parseInt(index, 10);
                var item = items[index];
                if (!item) continue;

                if (index > this.lastPopulatedItemIndex) {
                    this.lastPopulatedItemIndex = index;
                    this.lastPopulatedItemView = child;
                }

                createItemView.call(this, item, child, index);
                child._item = item;
            } else {
                populateMediaItems.call(this, child, items);
            }
        }
    }

    MediaGrid.prototype.setItems = function (items, callback) {
        this.items = items;
        this.moreIndex = 0;

        var context = {
            items: items,
            W: _getSize(this.container).w,
            spacing: this.options.spacing
        };

        var spec = findSpec(items);
        console.log(spec);
        var html = spec.layout;
        html = html.replace(/\{([0-9]+)(:([0-9]))?\}/g, function (full, index, x, flex) {
            var f = flex || "1";
            return "<div item=\"" + index + "\" flex=\"" + f + "\" class=\"ItemView\"></div>";
        });
        html = html.replace(/box>/g, function (full) {
            return "box flex=\"1\">";
        });

        var grid = this.container.ownerDocument.createElement("div");
        grid.innerHTML = html;
        var box = grid.firstChild;

        var height = spec.height.call(context);
        console.log("Height:" , height);

        this.container.innerHTML = "";
        this.container.appendChild(grid);

        box.style.width = context.W + "px";
        if (height > 0) {
            box.style.height = height + "px";
        }
        grid.style.width = context.W + "px";
        if (height > 0) {
            grid.style.height = height + "px";
        }
        grid.style.overflow = "hidden";

        grid.setAttribute("class", "MediaGrid " + this.uniqueClassName);
        grid.className = "MediaGrid " + this.uniqueClassName;

        generateCSS.call(this);
        this.grid = grid;

        var thiz = this;
        window.setTimeout(function() {
            populateMediaItems.call(thiz, grid, items);

            if (items.length > MAX_DEFINED) {
                var remaining = items.length - MAX_DEFINED;
                var overlay = thiz.container.ownerDocument.createElement("div");
                overlay.setAttribute("class", "ItemViewSeeMore");
                overlay.className = "ItemViewSeeMore";
                var span = thiz.container.ownerDocument.createElement("span");
                span.innerHTML = "+" + remaining;

                overlay.appendChild(span);
                thiz.lastPopulatedItemView.appendChild(overlay);
                thiz.moreIndex = MAX_DEFINED;
            }
        }, 10);
    };


    context.MediaGrid = MediaGrid;
}(MediaCollectionView.Impl));


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataView.js";

function DataViewWidget(node) {
    BaseTemplatedWidget.call(this);
    this.actionAdapter = new DataViewActionAdapter();
    Dom.addClass(this.node(), "widget_DataView");

    var thiz = this;
    this.specId = Util.getProperty(node, "spec-id", null);
    this.useSeparateFilterView = (Util.getProperty(node, "use-separate-filter-row", null) == "true");
    this.useInfiniteScroll = (Util.getProperty(node, "use-infinite-scroll", null) == "true");
    this.useFloatingToolbar = (Util.getProperty(node, "floating-toolbar", "true") == "true");
    this.searchBarProminented = (Util.getProperty(node, "search-bar-prominented", "false") == "true");
    Dom.toggleClass(this.node(), "SearchBarProminented", this.searchBarProminented);
    this.lazyInit = (Util.getProperty(node, "lazy-init", "false") == "true");
    this.isSelectable = (Util.getProperty(node, "isSelectable", "true") == "true");
    this.exclusive = (Util.getProperty(node, "exclusive", "true") == "fasle");
    this._disableCheckboxWhenCheckAll = Dom.getAttributeAsBoolean(node, "disable-checkbox-checkall", false);

    this.modernView = (Util.getProperty(node, "modern-view", "false") == "true");
    Dom.toggleClass(this.node(), "ModernView", this.modernView);

    this.emptyMessage = Util.getProperty(node, "empty-message", "");
    this.bodySection.setAttribute("empty-message", this.emptyMessage);
    this.fullScreenParentClass = Util.getProperty(node, "fullscreen-parent-class", "");
    this.explicitFilterAction = Util.getProperty(node, "explicit-filter-action", "");
    this.isExplicitFilterAction = this.explicitFilterAction ? true : false;
    if (this.isExplicitFilterAction) {
        Dom.setInnerText(this.applyFilterChangeButton.lastChild, this.explicitFilterAction);
        this.explicitFilterActionMessage = Util.getProperty(node, "explicit-filter-action-message", "");
    } else {
        Dom.addClass(this.applyFilterChangeButton, "Unused");
    }
    
    this.useActionBarScroll = (Util.getProperty(node, "use-action-bar-scroll", "false") == "true");
    Dom.toggleClass(this.node(), "UseActionBarScroll", this.useActionBarScroll);
    
    var filterEnricher = {
        enrich: function (filter, valueMap) {
            thiz.enrichFilter(filter, valueMap);
        }
    };

    this.filterEnricherMap = {};

    this.filterView = this.useSeparateFilterView ? this.separateFilterView : (this.searchBarProminented ? this.searchBarView : this.inlineFilterView);
    this.filterView.filterEnricher = filterEnricher;

    if (this.useInfiniteScroll) {
        Dom.addClass(this.node(), "InfiniteScroll");
        this.paginator = new InfiniteScrollPaginator();
    }

    this.customColumRendererMap = {};
    this.actions = [];

    function onFilterChanged(filterView, filterValueMap, event, updateSpec, callback, ctx) {
        $dataViewService.refreshFilters(thiz.specId, filterValueMap, function (freshFilters) {
            if (updateSpec) thiz.spec.filters = freshFilters;
            thiz.savedFilterCombo.updateFilters(freshFilters);
            filterView.onValueProviderChanged(event, freshFilters);

            if (callback) callback.call(ctx);
        });
    };
    this.bind("click", function () {
        function getSelectedValueMap(valueMap) {
            var newValueMap = {};
            thiz.spec.filters.map(function (filter) {
                if ((filter.visible && filter.instantFilterOnly) || filter.system) {
                    newValueMap[filter.fieldName] = thiz.savedView.valueMap[filter.fieldName];
                }
            });

            for (var name in valueMap) {
                newValueMap[name] = valueMap[name];
            }

            return newValueMap;
        };

        var filterDialog = new DataViewFilterDialog();
        filterDialog.callback(function (valueMap, filterList) {
            if (typeof(valueMap) == "undefined") return;

            // Update filtered values for dynamic filters.
            if (Array.isArray(filterList)) {
                for (var i = 0; i < thiz.spec.filters.length; i++) {
                    if (!Array.isArray(thiz.spec.filters[i].valueProviders)) continue;

                    for (var j = 0; j < filterList.length; j++) {
                        if (thiz.spec.filters[i].fieldName == filterList[j].fieldName) {
                            thiz.spec.filters[i].values = filterList[j].values;
                        }
                    }
                }
            }

            var newValueMap = getSelectedValueMap(valueMap);

            thiz.savedView.valueMap = newValueMap;
            thiz._applySavedView();
        }).open({
            spec: thiz.spec,
            filterEnricher: filterEnricher,
            valueMap: thiz.savedView && thiz.savedView.valueMap || {}
        });

        this.bind("p:PropertyValueChanged", function (event) {
            if (filterDialog.filterView.isFromValueProvider(event)) {
                var valueMap = filterDialog.filterView.getValueMap();
                if (typeof(valueMap) == "undefined") return;

                var newValueMap = getSelectedValueMap(valueMap);
                onFilterChanged(filterDialog.filterView, newValueMap, event);
            }
        }, filterDialog.filterView);

    }, this.editFilterButton);

    this.bind("p:ItemSelected", function (event) {
        function callback() {
            if (thiz.mustInvalidateColumnsOnFilterChanged()) {
                thiz._updateViewImpl(function () {
                    thiz.refreshColumns(true, function () {
                        thiz._updateDataTableView();
                        thiz._fireFilterChanged();
                    });
                });
            } else {
                thiz._updateView();
                thiz._fireFilterChanged();
            }
        };

        thiz.invalidateFiltersOnSavedViewChanged(callback, thiz);
    }, this.savedFilterCombo);

    var updateSavedViewValue = function () {
        var valueMap = this.filterView.getValueMap();
        for (var name in valueMap) {
            this.savedView.valueMap[name] = valueMap[name];
        }

        this._updateSavedView();
        this._fireFilterChanged();

    }.bind(this);

    var applyFilterChange = function(event) {
        function callback() {
            this.applyFilterChangeTimer = null;
            updateSavedViewValue();
            if (this.isExplicitFilterAction) {
                this.showInlineFilterChangedHint();
            } else {
                if (this.mustInvalidateColumnsOnFilterChanged(this.filterView.getFilterNameFromEvent(event))) {
                    this.refreshColumns();
                } else {
                    this._updateDataTableView();
                }
            }
        };

        if (this.filterView.isFromValueProvider(event)) {
            onFilterChanged(this.filterView, this.filterView.getValueMap(), event, true, callback, this);
        } else {
            callback.call(this);
        }
    }.bind(this);

    this.bind("p:PropertyValueChanged", function (event) {
        if (this.applyFilterChangeTimer) window.clearTimeout(this.applyFilterChangeTimer);
        this.applyFilterChangeTimer = window.setTimeout(function () { applyFilterChange (event); }, 1000);
    }, this.filterView);

    this.bind("click", function (event) {
        if (!this.savedView.sortedBy) {
            this.savedView.sortedBy = {
                name: this.dataListSource.order.propertyName || "name",
                asc: this.dataListSource.order.asc || true
            }
        }
        if (!this.savedView.columns) this.savedView.columns = this.dataTable.getVisibleColumnIds();
        if (!this.savedView.specId) this.savedView.specId = this.specId;

        new DataViewSavedViewUpdateDialog().callback(function (savedView) {
            if (!savedView) return;
            this.savedFilterCombo.reload(function () {
                this.savedFilterCombo.setSelectedSavedView(savedView);
                //this._updateView();
                this.originalSavedView = this.savedFilterCombo.getSelectedSavedView();
                this.savedView = DataViewWidget._clone(this.originalSavedView || this.savedFilterCombo._getNullDefaultView());

                this.saveButton.disabled = true;
            }.bind(this));

        }.bind(this)).open({savedView: this.savedView});
    }, this.saveButton);

    this.bind("click", function () {
        if (this.isExplicitFilterAction && this.explicitFilterChangeClickHandler) {
            this.explicitFilterChangeClickHandler();
        } else {
            updateSavedViewValue();
            this._updateDataTableView();
        }
    }, this.applyFilterChangeButton);

    this.comparerFunction = function (a, b) {
        return (thiz.comparer || Util.sameId)(a, b);
    };
    this.dataTable.comparer = this.paginator.comparer = this.comparerFunction;
    this.dataTable.showBusy = null;

    var defaultItemUniqueIdFunc = this.dataTable.getItemUniqueId;
    this.getItemUniqueIdFunction = function (item) {
        return (thiz.getItemUniqueId || defaultItemUniqueIdFunc)(item);
    };
    this.dataTable.getItemUniqueId = this.getItemUniqueIdFunction;
}

__extend(BaseTemplatedWidget, DataViewWidget);
DataViewWidget.prototype.getTemplatePath = function () {
    return this.getTemplatePrefix() + "DataView.xhtml";
};
DataViewWidget._cloneJSONReplacer = function (key, value) {
    if (!value || !(this[key] instanceof Date)) return value;
    return "date(" + this[key].getTime() + ")";
};
DataViewWidget._clone = function (sv) {
    return JSON.parse(JSON.stringify(sv, DataViewWidget._cloneJSONReplacer), _globalJSONReviver);
};

DataViewWidget.prototype.setContentFragment = function (fragment) {
    var withActionHeader = false;
    var withActionFooter = false;
    var withActionTrailing = false;
    var withFilterLeading = false;
    var withFilterTrailing = false;
    var withSummary = false;

    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node.nodeName || !node.getAttribute) continue;

        var role = node.getAttribute("role");
        if (role == "action-header") {
            this.actionHeaderContainer.appendChild(node);
            withActionHeader = true;
        } else if (role == "action-trailing") {
            this.actionRow.appendChild(node);
            withActionTrailing = true;
        } else if (role == "action-middle") {
            this.actionMiddlePane.appendChild(node);
            withActionTrailing = true;
        } else if (role == "action-footer") {
            this.actionFooterContainer.appendChild(node);
            withActionFooter = true;
        } else if (role == "filter-leading") {
            this.separateFilterViewLeading.appendChild(node);
            withFilterLeading = true;
        } else if (role == "filter-trailing") {
            this.separateFilterViewTrailing.appendChild(node);
            withFilterTrailing = true;
        } else if (role == "summary") {
            this.contentDescription.appendChild(node);
            withSummary = true;
        }
    }

    if (!withActionHeader) Dom.addClass(this.actionHeaderContainer, "Unused");
    if (!withActionFooter) Dom.addClass(this.actionFooterContainer, "Unused");
    if (!withFilterLeading) Dom.addClass(this.separateFilterViewLeading, "Unused");
    if (!withFilterTrailing) Dom.addClass(this.separateFilterViewTrailing, "Unused");

    if (!withFilterLeading && !withFilterTrailing && !this.useSeparateFilterView) Dom.addClass(this.separateFilterViewTrailing.parentNode, "Unused");

    if (this.modernView) {
        this.filterViewWrapper.appendChild(this.actionRow);
        this.savedFilterContainer.insertBefore(this.editFilterButton, this.savedFilterContainer.firstChild);
    }
    if (this.useActionBarScroll) {
        this.separateFilterView.propertiesWidget.__savedFilterContainer = this.savedFilterContainer;
        var scrollableView = new ScrollableView();
        scrollableView.setContentFragment(this.filterViewWrapper);
        this.bodySection.insertBefore(scrollableView.node(), this.actionPane);
    }
};
DataViewWidget.prototype.setup = function (requestedSavedView) {
    var thiz = this;
    this.savedFilterCombo.init(this.spec, function () {
        if (requestedSavedView) thiz.savedFilterCombo.setSelectedSavedView(thiz._getExtendedDefaultSavedView(requestedSavedView));

        thiz.invalidateFiltersOnSavedViewChanged(thiz.setupImpl, thiz);
    });
};
DataViewWidget.prototype.invalidateFiltersOnSavedViewChanged = function (callback, ctx) {
    var thiz = this;
    var mustRefreshFilters = false;
    var selectedSavedView = thiz.savedFilterCombo.getSelectedSavedView() || this.savedFilterCombo._getNullDefaultView();
    var savedViewValueMap = selectedSavedView && selectedSavedView.valueMap;
    for (var i = 0, n = savedViewValueMap && this.spec.filters.length; i < n; i++) {
        var filter = thiz.spec.filters[i];
        if (filter.valueProviders) {
            if (savedViewValueMap[filter.fieldName]) {
                mustRefreshFilters = true;
                break;
            }

            filter.valueProviders.forEach(function (provider) {
                if (provider.match(/^\/.+/)) provider = provider.substring(1);
                if (savedViewValueMap[provider]) {
                    mustRefreshFilters = true;
                }
            });

            if (mustRefreshFilters) break;
        }

    }

    // If the saved view contains any filters that their values are dynamically loaded, refresh the list of filters
    if (mustRefreshFilters) {
        $dataViewService.refreshFilters(thiz.specId, savedViewValueMap, function (freshFilters) {
            thiz.spec.filters = freshFilters;
            thiz.savedFilterCombo.updateFilters(freshFilters);
            thiz.savedFilterCombo.setSelectedSavedView(thiz.savedFilterCombo.getSelectedSavedView(), false, null);
            if (callback) callback.call(ctx);
        });
    } else {
        if (callback) callback.call(ctx);
    }
};
DataViewWidget.prototype.setupImpl = function () {
    var thiz = this;
    this._initializeDataTable();

    this.paginator.setup({
        getTotalItemText: function(total) {
            return String.format("Total %d items", total);
        },
        showPaginator: true,
        withoutStatus: true,
        onPageStartLoading: function(page) {
            Dom.emitCustomEvent("p:PageStartLoading", thiz.node(), {
                page: page
            });
        },
        onPageLoaded: function (p, count) {
            thiz.refreshedAt = new Date().getTime();
            var start = p.currentPage * p.pageSize + 1;
            var end = start + count - 1;
            Dom.emitCustomEvent("p:PageLoaded", thiz.node(), {
                page: p.currentPage,
                totalPages: p.totalPages,
                totalItems: p.totalItems
            });
            if (p && (p.currentPage == 0 || p.lastLoadedIndex == 0)) {
                Dom.toggleClass(thiz.node(), "DataSourceEmpty", p.totalItems == 0);
            }

            // Dom.setInnerText(thiz.contentDescription, String.format("Showing items {0}-{1} of {2}", start, end, p.totalItems));
        },
        onPageLoadFailed: function (page) {
            Dom.emitCustomEvent("p:PageLoadFailed", thiz.node(), {
                page: page
            });
        },
        comparer: this.comparerFunction,
        useButtons: true,
        avoidPageSizeRecalculation: this.spec.fixedPageSize ? true : false
    });
    this.paginator.pageSize = this.getPageSize();
    this.paginator.control(this.dataTable);
    this.paginator.needCalculatePageSize = function () {
        return thiz.spec.fixedPageSize ? false : true;
    };

    var floatingPane = this.filterViewWrapper;
    if (!Dom.hasClass(this.node(), "ModernView")) {
        floatingPane = this.actionBar;
    }

    this.dataTable.addListener({
        onSelectionChanged: function (data, fromUserAction, data) {
            // if (!fromUserAction) return;
            var eventData = {
                count: thiz.getSelectedItemCount(),
                total: thiz.paginator.totalItems
            };

            if (data) {
                for (var name in data) eventData[name] = data[name];
            }

            if (fromUserAction) {
                Dom.emitCustomEvent("p:BeforeValidatingActionUserSelections", thiz.node(), eventData);
            }

            thiz._invalidateActions();

            Dom.emitCustomEvent("p:SelectionChanged", thiz.node(), eventData);
        },
        onHeaderFloatingStarted: function (dataTable, data) {
            if (!thiz.useFloatingToolbar) return;
            Dom.addClass(thiz.node(), "TableHeaderFloated");
            floatingPane.style.left = data.rect.left + "px";
            floatingPane.style.width = data.rect.width + "px";
            floatingPane.style.top = data.rect.top + "px";
        },
        onHeaderFloatingEnded: function (dataTable, data) {
            if (!thiz.useFloatingToolbar) return;
            Dom.removeClass(thiz.node(), "TableHeaderFloated");

            floatingPane.style.removeProperty("left");
            floatingPane.style.removeProperty("width");
            floatingPane.style.removeProperty("top");
        },
        onHeaderFloatingUpdated: function (dataTable, data) {
            if (!thiz.useFloatingToolbar) return;
            floatingPane.style.left = data.rect.left + "px";
            floatingPane.style.width = data.rect.width + "px";
            floatingPane.style.top = data.rect.top + "px";
         }
    });

    if (this.useFloatingToolbar) {
        this.dataTable._getFloatingHeaderTopPadding = function () {
            return floatingPane.offsetHeight + Util.em();
        }
    }

    this._setFilterListImpl();
    // this.showingFilters = [];
    // this.spec.filters.map(function (filter) {
    //     if (filter.visible) thiz.showingFilters.push(filter);
    // });
    //
    // this.filterView.setFilterList(this.showingFilters, undefined, this.spec);

    this.setupDone = true;
    Dom.addClass(this.node(), "Initialized");

    var handleSetupDone = function () {
        this._setupAndLoadDataDone = true;
        if (this.onSetupDone) this.onSetupDone();
    }.bind(this);

    if (this.mustInvalidateColumnsOnFilterChanged()) {
        this._updateViewImpl(function () {
            this.refreshColumns(false, handleSetupDone);
        }.bind(this));
    } else {
        this._updateView();
        handleSetupDone();
    }

};
DataViewWidget.prototype.getDiscoveredTotalItems = function () {
    return this.paginator.totalItems;
};
DataViewWidget.prototype.registerFilterEnricher = function (fieldName, fn) {
    this.filterEnricherMap[fieldName] = fn;
};

DataViewWidget.prototype.getPageSize = function() {
    return (this.spec && this.spec.fixedPageSize) || 20;
};

DataViewWidget.prototype.executeInBackground = function() {
    return this.spec ? this.spec.executeInBackground : false;
};

DataViewWidget.prototype.enrichFilter = function (filter, valueMap) {
    var enricher = this.filterEnricherMap[filter.fieldName];
    if (!enricher) return;
    enricher(filter, valueMap);
};
DataViewWidget.prototype.forceUpdateDataTableSize = function () {
    this.dataTable.invalidateSizing();
};
DataViewWidget.prototype._updateView = function () {
    this._updateViewImpl(this._updateDataTableView.bind(this));
};
DataViewWidget.prototype._updateViewImpl = function (callback) {
    this.originalSavedView = this.savedFilterCombo.getSelectedSavedView();
    if (!this.originalSavedView) this.originalSavedView = this.savedFilterCombo._getNullDefaultView();

    this.savedView = DataViewWidget._clone(this.originalSavedView || this.savedFilterCombo._getNullDefaultView());
    this.filterView.setValueMap(this.savedView.valueMap || {});
    this.saveButton.disabled = true;
    this._invalidateActions();
    if (callback) callback();
};
DataViewWidget.prototype.refreshFilters = function (filterValueMap, callback) {
    var selectedSavedView = this.savedFilterCombo.getSelectedSavedView() || this.savedFilterCombo._getNullDefaultView();
    var savedViewValueMap = selectedSavedView && selectedSavedView.valueMap;
    savedViewValueMap = Object.assign(savedViewValueMap, filterValueMap || {});

    var thiz = this;
    $dataViewService.refreshFilters(this.specId, savedViewValueMap, function (freshFilters) {
        thiz.spec.filters = freshFilters;
        thiz.savedFilterCombo.updateFilters(freshFilters);

        thiz.savedView.valueMap = savedViewValueMap;
        thiz._applySavedView();
        if (callback) callback.call();
    });
};

DataViewWidget.prototype.onAttached = function () {
    if (!this.lazyInit) this.boot();
};
DataViewWidget.prototype.boot = function (requestedSavedView) {
    if (this.booted) return;

    this.booted = true;
    var thiz = this;

    $dataViewService.getSpecification(this.specId, function (spec) {
        thiz.spec = spec;
        thiz.spec.__defineGetter__("displayTimeZoneProvider", function () {
            if (thiz.getCustomTimeZoneProvider) return thiz.getCustomTimeZoneProvider();
            return TimezoneProviders[(spec.displayTimezoneName || spec.inputTimezoneName || "local")];
        });

        thiz.spec.__defineGetter__("inputTimeZoneProvider", function () {
            if (thiz.getCustomTimeZoneProvider) return thiz.getCustomTimeZoneProvider();
            return TimezoneProviders[(spec.inputTimezoneName || "local")];
        });

        thiz.spec.id = thiz.specId;
        if (thiz.onSpecificationLoaded) thiz.onSpecificationLoaded(thiz.spec);
        thiz.setup(requestedSavedView);
    });
};

DataViewWidget.prototype.reloadOnlyFilterSchemas = function (callback) {
    this._reloadFilterSchemasImpl(callback);
};

DataViewWidget.prototype._reloadFilterSchemasImpl = function (callback) {
    var thiz = this;
    $dataViewService.getSpecification(this.specId, function (spec) {
        thiz.spec = spec;
        if (thiz.onSpecificationLoaded) thiz.onSpecificationLoaded(thiz.spec);
        thiz._setFilterListImpl();
        thiz.filterView.setValueMap(thiz.savedView && thiz.savedView.valueMap || {});
        if (callback) callback();
    });
};

DataViewWidget.prototype.reloadFiltersAndDataList = function () {
    this._reloadFilterSchemasImpl(function () {
        this.refreshDataList();
    }.bind(this));
};

DataViewWidget.prototype._setFilterListImpl = function () {
    var thiz = this;
    this.showingFilters = [];
    this.spec.filters.map(function (filter) {
        if (filter.visible) thiz.showingFilters.push(filter);
    });

    this.filterView.setFilterList(this.showingFilters, undefined, this.spec);
};

DataViewWidget.prototype._createDataSourceLoadPageFunction = function (independent, progressListener) {
    var thiz = this;
    return function (pageIndex, pageSize, handler, failed) {
        this.pendingHandler = handler;
        var excludedFieldNames = [];
        var reversedNullSide = false;
        var me = this;
        thiz.spec.columns.forEach(function (c) {
            if (c.fieldName == me.order.propertyName) {
                reversedNullSide = c.reversedNullSide;
            }

            if (thiz.savedView.columns) {
                if (thiz.savedView.columns.indexOf(c.fieldName) < 0) excludedFieldNames.push(c.fieldName);
            } else {
                if (!c.visible) excludedFieldNames.push(c.fieldName);
            }
        });

        if (thiz.spec.disabledColumns) excludedFieldNames = excludedFieldNames.concat(thiz.spec.disabledColumns);
        var nullSide = reversedNullSide ? this.order.asc : !this.order.asc;
        var filterValueMap = thiz.savedView.valueMap || {};
        var dymanicFilterValue = thiz.getDymanicFilterValue();
        if (dymanicFilterValue) {
            for (var key in dymanicFilterValue) {
                filterValueMap[key] = dymanicFilterValue[key];
            }
        }

        if (thiz._convertFilterMap) filterValueMap = thiz._convertFilterMap(filterValueMap);
        if (thiz.executeInBackground()) {
            $dataViewService.createListJob(thiz.specId, filterValueMap, pageIndex * pageSize, pageSize, [{name: this.order.propertyName, asc: this.order.asc, nullSide: nullSide}], excludedFieldNames, function (jobId) {
                thiz.waitForJob(jobId, thiz.dataTable, function(data, error) {
                    if (me.destroyed) {
                        return;
                    }
                    if (error) {
                        Dialog.error(error.message || "There was an error when fetching data list");
                    } else {
                        if (data.extra && !independent) {
                            thiz.lastResultExtra = data.extra;
                        }
                        handler(data.result, data.count);
                    }
                    me.pendingHandler = null;
                });
            }, progressListener);
        } else {
            $dataViewService.list(thiz.specId, filterValueMap, pageIndex * pageSize, pageSize, [{name: this.order.propertyName, asc: this.order.asc, nullSide: nullSide}], excludedFieldNames, function (data) {
                if (me.destroyed) {
                    return;
                }
                if (data.extra && !independent) {
                    thiz.lastResultExtra = data.extra;
                }
                handler(data.result, data.count);
                me.pendingHandler = null;
            }, progressListener);
        }
    };
};
DataViewWidget.prototype.waitForJob = function(jobId, progressListener, callback) {
    var thiz = this;
    progressListener.busy();
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        progressListener.done();
                        callback(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        progressListener.done();
                        callback(null, {message: (job && job.errorMessage) || "Job execution error"});
                    }
                } else {
                    progressListener.done();
                    callback(null, {message: "Job not found."});
                }
            }, function (error) {
                progressListener.done();
                callback(null, error);
            });
        }, thiz.requestTime || 500);
    })();
};
DataViewWidget.prototype._updateDataTableView = function () {
    this.hideFilterChangedHint();
    if (this.isExplicitFilterAction) {
        this._lastFilterMap = {};
        if (this.savedView && this.savedView.valueMap) {
            for (key in this.savedView.valueMap) {
                this._lastFilterMap[key] = this.savedView.valueMap[key];
            }
        }
    }

    // set visible columns
    if (this.savedView.columns) this.dataTable.setVisibleColumnIds(this.savedView.columns);

    if (this.isExplicitFilterAction && this.explicitFilterChangeClickHandler) {
        this.explicitFilterChangeClickHandler();
        return;
    }

    var thiz = this;

    var defaultOrder = {
        propertyName: "name",
        asc: true
    };

    if (this.savedView && this.savedView.sortedBy && this.savedView.sortedBy) {
        defaultOrder.propertyName = this.savedView.sortedBy.name || defaultOrder.propertyName;
        defaultOrder.asc = (typeof(this.savedView.sortedBy.asc) == "undefined") ? defaultOrder.asc : this.savedView.sortedBy.asc;
    } else {
        if (this.spec.defaultSortColumn) {
            defaultOrder.propertyName = this.spec.defaultSortColumn;
            defaultOrder.asc = (typeof(this.spec.defaultSortDirection) != "undefined") ? this.spec.defaultSortDirection : true;
        } else {
            var sortableColumn = null;
            for (var i = 0; i < this.spec.columns.length; i ++) {
                var c = this.spec.columns[i];
                if (c.sortable) {
                    sortableColumn = c;
                    break;
                }
            }

            if (sortableColumn) {
                defaultOrder.propertyName = sortableColumn.sortFieldName || sortableColumn.fieldName;
            }
        }
    }

    if (this.dataListSource && this.dataListSource) {
        this.dataListSource.destroy();
    }

    this.dataListSource = {
        order: defaultOrder,
        term: "",
        paramName: "name",

        loadPage: this._createDataSourceLoadPageFunction(false, this.dataTable),
        loadAllIds: function (handler, failed) {
            var reversedNullSide = false;
            var me = this;
            var nullSide = reversedNullSide ? this.order.asc : !this.order.asc;

            var filterValueMap = thiz.savedView.valueMap || {};
            if (thiz._convertFilterMap) filterValueMap = thiz._convertFilterMap(filterValueMap);
            if (thiz.executeInBackground()) {
                $dataViewService.createListAllIdsJob(thiz.specId, filterValueMap, [{name: this.order.propertyName, asc: this.order.asc, nullSide: nullSide}], function (jobId) {
                    thiz.waitForJob(jobId, thiz.dataTable, function(data, error) {
                        if (me.destroyed) {
                            return;
                        }
                        if (error) {
                            Dialog.error(error.message || "There was an error when fetching data list");
                        } else {
                            handler(data.result);
                        }
                    });
                });

            } else {
                $dataViewService.listAllIds(thiz.specId, filterValueMap, [{name: this.order.propertyName, asc: this.order.asc, nullSide: nullSide}], function (data) {
                    if (me.destroyed) {
                        return;
                    }
                    handler(data.result);
                }, thiz.dataTable);
            }
        },

        destroy: function () {
            try {
                if (this.pendingHandler) {
                    this.pendingHandler([], 0);
                    this.pendingHandler = null;
                }
            } catch (e) {}

            this.destroyed = true;
        },

        getOrder: function () {
            return this.order;
        },
        setOrder: function (order) {
            this.order = order;
        }
    };

    this.paginator.setSource(this.dataListSource);

    // window.setTimeout(function () {
    //
    //     // this.dataTable.invalidateSizing();
    // }.bind(this), 200);
};
DataViewWidget.ENUM_CODE_MAP = null;
DataViewWidget._ensureEnumCodeMap = function () {
    if (DataViewWidget.ENUM_CODE_MAP) return;

    DataViewWidget.ENUM_CODE_MAP = {};
    for (var name in Enums) {
        var enumMap = Enums[name];
        var codeMap = {};
        for (var n in enumMap) {
            var object = enumMap[n];
            if (object && typeof(object.code) != "undefined") {
                codeMap[object.code] = object;
            }
        }

        DataViewWidget.ENUM_CODE_MAP[name] = codeMap;
    }
};

DataViewWidget.RENDERER = {
    Date: function (data, value, columnSpec, spec) {
        var tzid = null;
        if (columnSpec.timezoneProviderName) {
            tzid = TimezoneProviders[columnSpec.timezoneProviderName].getTimezoneId();
        } else {
            tzid = spec.displayTimeZoneProvider.getTimezoneId();
        }

        var formatName = columnSpec.extra ? (columnSpec.extra.formatName || "date_standard") : "date_standard";

        var display = !value ? "" : FormatUtil.formatDateWithTZID(value, formatName, tzid);
        return { _name: "hbox",
        _children: [
            {_name: "span", _text: "" + (display || "")}
        ]};
    },
    Number: function (data, value) {
        return { _name: "hbox",
        _children: [
            {_name: "div", "class": "NumberValue", _text: "" + Util.formatNumber(value)}
        ]};
    },
    NumberAsCurrency: function (data, value) {
        return { _name: "hbox",
        _children: [
            {_name: "div", "class": "NumberValue", _text: "" + Util.toCurrency(value)}
        ]};
    },
    NumberAsBoolean: function (data, value) {
        return { _name: "hbox",
        _children: [
            {_name: "span", _text: (value == 1 ? "YES" : "NO")}
        ]};
    },
    String: function (data, value) {
        return { _name: "hbox",
        _children: [
            {_name: "span", _text: "" + (value || "")}
        ]};
    },
    Html: function (data, value) {
        return { _name: "hbox",
        _children: [
            {_name: "span", _html: "" + (value || "")}
        ]};
    },
    Enum: function (data, value, columnSpec) {
        DataViewWidget._ensureEnumCodeMap();

        var enumCodeMap = DataViewWidget.ENUM_CODE_MAP[columnSpec.extra.enumName];
        var enumValue = enumCodeMap[value];
        var displayName = enumValue ? enumValue.displayName : "";
        return { _name: "hbox",
            _children: [
                {_name: "span", _text: "" + (displayName || (columnSpec.extra.unspecifiedText  || (columnSpec.extra.enumName + ":" + value)))}
        ]};
    },
    "String[]": function (data, value) {
        return { _name: "hbox",
        _children: [
            {_name: "span", _text: "" + (value ? value.join("\n") : "")}
        ]};
    },
    "Html[]": function (data, value) {
        return {
            _name: "vbox",
            _html: (value ? (value.map(function (row) { return "<div><span>" + row + "</span></div>"; }).join("\n")) : "")
        };
    }
};

// This API supports two signature:
//   1. registerCustomRenderer(fieldName, renderer, groupKeyGenerator, pdfRenderer)
//   or
//   2. registerCustomRenderer(fieldName, {renderer: ..., groupKeyGenerator: ..., pdfRenderer: ...})
DataViewWidget.prototype.registerCustomRenderer = function (fieldName, arg1, arg2, arg3) {
    var customRenderer = (typeof(arg1) == "object") ? arg1 : { renderer: arg1, groupKeyGenerator: arg2, pdfRenderer: arg3 };

    this.customColumRendererMap[fieldName] = customRenderer;
};
DataViewWidget.prototype.isHiddenCell = function(data, value, spec) {
    return false;
}
DataViewWidget.prototype._installTableColumn = function (specCol) {
    var thiz = this;
    var customColumnHandler = thiz.customColumRendererMap[specCol.fieldName];

    var column = null;

    var getNestedValue = function (obj, keys) {
        if (!obj) return null;

        if (keys.length == 1) {
            return obj[keys[0]];
        }

        var prop = keys.shift();
        return getNestedValue(obj[prop], keys);
    };

    if (customColumnHandler && customColumnHandler.useDOMNode) {
        column = new DataTable.DomNodeColumn(specCol.title, function (data) {
            var columnValue = specCol.dynamicFieldName ? getNestedValue(data, specCol.dynamicFieldName.split(".")) : data[specCol.fieldName];
            var hidden = thiz.isHiddenCell ? thiz.isHiddenCell(data, columnValue, specCol) : false;
            if (hidden) return Dom.hbox(Dom.span("(Hidden)"), "Hidden");

            var renderer = (customColumnHandler ? customColumnHandler.renderer : null) || DataViewWidget.RENDERER[specCol.rendererType || specCol.type || "String"];
            return renderer(data, columnValue, specCol, thiz.spec);
        });
    } else {
        column = new DataTable.GenericDomColumn(specCol.title, function (data) {
            var columnValue = specCol.dynamicFieldName ? getNestedValue(data, specCol.dynamicFieldName.split(".")) : data[specCol.fieldName];
            var hidden = thiz.isHiddenCell ? thiz.isHiddenCell(data, columnValue, specCol) : false;
            if (hidden) return "<hbox class=\"Hidden\"><span>(Hidden)</span></hbox>";

            var renderer = (customColumnHandler ? customColumnHandler.renderer : null) || DataViewWidget.RENDERER[specCol.rendererType || specCol.type || "String"];
            return renderer(data, columnValue, specCol, thiz.spec);
        });
    }

    column = column.width(specCol.sizing, specCol.minWidth);

    column.id = specCol.fieldName;
    column.dataType = specCol.type || specCol.rendererType;
    if (specCol.sortable) column = column.sortable(specCol.sortFieldName || specCol.fieldName);
    if (!specCol.visible) column = column.hiddenByDefault();
    if (!specCol.removable) column = column.isUnremovable();

    if (customColumnHandler) {
        column.getGroupKey = customColumnHandler.groupKeyGenerator;
        column.pdfRenderer = customColumnHandler.pdfRenderer;
    }
    if (specCol.extra) column.extra = specCol.extra;

    this.dataTable.column(column);
};
DataViewWidget.prototype._initializeDataTable = function () {
    this.spec.columns.map(this._installTableColumn.bind(this));
    this.dataTable.configurable().selector(this.isSelectable, this.exclusive).withHeightControl(!this.useInfiniteScroll);
    if (this.isSelectable && this.itemSelectable) this.dataTable.selectable = this.itemSelectable;

    this.dataTable.useFloatingHeader = true;
    var thiz = this;

    this.dataTable.getSectionId = function (item) {
        return thiz.getSectionId ? thiz.getSectionId(item) : null;
    };

    if (this._disableCheckboxWhenCheckAll === false) this.dataTable.disabledCheckBoxWhenCheckAll(false);
    this.dataTable.setDefaultSelectionHandler({
        run: function (data, event) {
            var fieldName = null;
            var cell = Dom.findUpward(event.target, function (node) {
                return node.getAttribute && node.getAttribute("column-id");
            });

            if (cell) fieldName = cell.getAttribute("column-id");

            if (thiz.selectionHandler) {
                thiz.selectionHandler(data, fieldName, cell, event);
            }

            Dom.emitCustomEvent("p:ItemClicked", thiz.node(), {
                cell: cell,
                fieldName: fieldName
            });
        }
    });
    this.dataTable.addOrderRequestListener({
        changeOrder: function (order) {
            try {
                thiz.dataTable.selectNone();
            } catch (e) {
                console.error(e);
            }
            thiz.savedView.sortedBy = {
                name: order.propertyName,
                asc: !order.asc
            };
            thiz._updateSavedView();
        }
    });
    this.dataTable.addColumnSettingListener({
        changeColumnSetting: function (columnIds) {
            thiz.savedView.columns = columnIds;
            thiz._updateSavedView();
        }
    });
    this.dataTable.setColumnSettingHandler(function (table) {
        var dialog = new DataTableOrderingColumnSettingDialog();
        var options = {
            table: table
        };
        
        if (thiz.isSettingColumnApplicable) {
            options.isColumnApplicable = thiz.isSettingColumnApplicable;
        }
        
        if (thiz.mustInvalidateColumnsOnFilterChanged()) {
            options.isColumnApplicable = function (column) {
                return thiz.spec.columns.find(function (c) {
                    return c.fieldName == column.id;
                });
            };
            // options.isColumnUnremovable = function (column) {
            //         return column.unremovable || thiz.spec.columns.find(function (c) {
            //             return c.fieldName == column.id && thiz._isColumnDependedOnFilter(c);
            //         });
            //     };
        }

        dialog.callback(function (columnIds) {
            if (!columnIds || columnIds.length <= 0) return;

            thiz.savedView.columns = columnIds;
            thiz._updateSavedView();
            thiz._updateDataTableView();
        }).open(options);
    });

    this.bind("click", function () {
        this.dataTable.showColumnSettingDialog();
    }, this.customizeColumnLink);
    if (this.fullScreenParentClass) {

        this.bind("click", function () {
            this.toggleFullScreen();
        }, this.toggleFullScreenLink);

        var tabPane = Dom.findParentWithClass(this.node(), "widget_TabPane");
        if (tabPane) {
            this.bind("e:TabChange", function(){
                this.invalidateFullScreenStatus();
            }, tabPane);
        }
    }
    this.dataTable.setup();
    this.invalidateFullScreenStatus();
};

DataViewWidget.prototype.toggleFullScreen = function() {
    var fullScreenParent = this.fullScreenParentClass ? Dom.findParentWithClass(this.node(), this.fullScreenParentClass) : null;
    if (!fullScreenParent) return;
    var fullScreen = Dom.hasClass(fullScreenParent, "DataViewFullScreen");
    Dom.toggleClass(fullScreenParent, "DataViewFullScreen", !fullScreen);
    this.invalidateFullScreenStatus();
}
DataViewWidget.prototype.invalidateFullScreenStatus = function() {
    var fullScreenParent = this.fullScreenParentClass ? Dom.findParentWithClass(this.node(), this.fullScreenParentClass) : null;
    if (!fullScreenParent) {
        return;
    }
    Dom.addClass(this.extraUtilityBox, "Active");
    var fullScreen = Dom.hasClass(fullScreenParent, "DataViewFullScreen");
    this.toggleFullScreenLink.innerHTML = "<icon class=\"arrow-" + (fullScreen ? "collapse" : "expand") + "\"></icon>" + (fullScreen ? "Collapse" : "Expand");
}
DataViewWidget.prototype._invalidateActions = function () {
    if (!this.actions || !this.setupDone) return;
    this.actions.forEach(function (action) {
        action.invalidate();
    });
};
DataViewWidget.prototype._applySavedView = function() {
    this._updateSavedView();
    this.filterView.setValueMap(this.savedView.valueMap);
    this._fireFilterChanged();
    this._updateDataTableView();
};
DataViewWidget.prototype._updateSavedView = function () {
    // var v1 = this.originalSavedView && typeof(this.originalSavedView) == "object" ? JSON.stringify(this.originalSavedView) : this.originalSavedView;
    // var v2 = this.savedView && typeof(this.savedView) == "object" ? JSON.stringify(this.savedView) : this.savedView;
    // var modified = v1 != v2;

    var modified = this._isSavedViewModified();
    this.savedFilterCombo.setSelectedSavedView(this.savedView, modified, this.originalSavedView);
    this.saveButton.disabled = !modified;
};
DataViewWidget.prototype._isSavedViewModified = function() {
    if (!this.originalSavedView && !this.savedView) return false;
    if (!this.originalSavedView && this.savedView || this.originalSavedView && !this.savedView) return true;

    var poperties = ["valueMap", "columns", "sortedBy"];
    for (var p in poperties) {
        if (!this.originalSavedView[p] && this.savedView[p] || this.originalSavedView[p] && !this.savedView[p]) return true;
    }

    if (this.savedView.valueMap) {
        var modified = this._isFilterMapModified(this.savedView.valueMap, this.originalSavedView.valueMap);
        if (modified) return true;
    }

    if (this.savedView.columns) {
        if (this.savedView.columns.length != this.originalSavedView.columns.length) return true;
        for (var i in this.savedView.columns) {
            if (this.savedView.columns[i] != this.originalSavedView.columns[i]) return true;
        }
    }

    if (this.savedView.sortedBy) {
        if (this.savedView.sortedBy.name != this.originalSavedView.sortedBy.name
            || this.savedView.sortedBy.asc != this.originalSavedView.sortedBy.asc) return true;
    }
    return false;
};

DataViewWidget.prototype._isFilterMapModified = function (filterMap, originalFilterMap) {
    for (var key in filterMap) {
        if (!key) continue;
        var value = filterMap[key];
        var originalValue = originalFilterMap[key];

        if ((value === "" && originalValue === null) || (value === null && originalValue === "")) continue;

        if (Array.isArray(value)) {
             if (value.length == 0 && (!originalValue || Array.isArray(originalValue) && originalValue.length == 0)) continue;
             if (!originalValue || value.length != originalValue.length) return true;
             for (var i = 0; i < value.length; i++) {
                 if (originalValue.indexOf(value[i]) < 0) return true;
             }
             continue;
        }
        if ((value && typeof(value.getTime) == "function") || (originalValue && typeof(originalValue.getTime) == "function")) { // Date object?
            if (!value || !originalValue) return true;
            return value.getTime() - originalValue.getTime();
        }
        if (typeof(value) == "object") {
            if (value) {
                if (!originalValue) {
                    if ((typeof(value.from) == "undefined" || value.from == null || value.from === "")
                        && (typeof(value.to) == "undefined" || value.to == null || value.to === "")
                        && (typeof(value.name) == "undefined" || value.name == null || value.name === "")) continue;
                    return true;
                }
                var v1 = JSON.stringify({
                    from: typeof(value.from) != "undefined" && value.from != null ? value.from : null,
                    to: typeof(value.to) != "undefined" && value.to != null ? value.to : null,
                    name: typeof(value.name) != "undefined" && value.name != null ? value.name : null
                });
                var v2 = JSON.stringify({
                    from: typeof(originalValue.from) != "undefined" && originalValue.from != null ? originalValue.from : null,
                    to: typeof(originalValue.to) != "undefined" && originalValue.to != null ? originalValue.to : null,
                    name: typeof(originalValue.name) != "undefined" && originalValue.name != null ? originalValue.name : null
                });
                if (v1 != v2) return true;
            } else {
                if (typeof(originalValue) != "undefined" && originalValue != null) return true;
            }
            continue;
        }

        if (value != originalValue) return true;
    }

    return false;
}

DataViewWidget.prototype.showInlineFilterChangedHint = function () {
    var storageKey = "dataView:" + this.specId + "_hideFilterChangedHint";
    if (window.localStorage.getItem(storageKey) == "true") return;
    if (!this._isFilterMapModified(this.savedView.valueMap || {}, this._lastFilterMap || {})) {
        this.hideFilterChangedHint();
        return;
    }
    if (this._filterActionTips && this._filterActionTips.isVisible()) {
        return;
    }
    this.hideFilterChangedHint();
    this._filterActionTips = InfoTip.show(this.applyFilterChangeButton, this.explicitFilterActionMessage, true, null, "tooltip", "left-inside");
    this._filterActionTips.popupContainer.addEventListener("click", function () {
        window.localStorage.setItem(storageKey, true);
    }, false);
};
DataViewWidget.prototype.hideFilterChangedHint = function () {
    if (this._filterActionTips) {
        this._filterActionTips.hide();
        this._filterActionTips.kill();
        this._filterActionTips = null;
    }
};

DataViewWidget.prototype._fireFilterChanged = function () {
    if (this.filterChangedListener) this.filterChangedListener(this.savedView.valueMap);
};
DataViewWidget.prototype.setDefaultSelectionHandler = function (handler) {
    this.selectionHandler = handler;
};
DataViewWidget.prototype.setFilterChangedListener = function (listener) {
   this.filterChangedListener = listener;
};
DataViewWidget.prototype.createActionBarAction = function (action) {
    var thiz = this;
    return {
        isVisible: function () {
            if (typeof(action.visible) == "undefined") {
                return true;
            } else {
                if (typeof(action.visible) == "function") return action.visible(thiz.getSelectedItemCount(), thiz);
                return action.visible;
            }
        },
        isApplicable: function () {
            if (typeof(action.applicable) == "undefined") {
                if (action.selectionIndependent) return true;
                return thiz.getSelectedItemCount() > 0;
            } else {
                if (typeof(action.applicable) == "function") return action.applicable(thiz.getSelectedItemCount(), thiz);
                return action.applicable;
            }
        },
        getIcon: function () {
            return typeof action.icon == "function" ? action.icon() : action.icon;
        },
        getTitle: function () {
            return (typeof action.title == "function" ? action.title() : action.title);
        },
        run: function (event) {
            thiz._lastActionEventInfo = {
                alternative: event.shiftKey
            };
            if (action.runOnIds) {
                thiz.getSelectedItemIds(action.runOnIds, true);
            } else {
                if (action.selectionIndependent) {
                    action.run();
                } else {
                    thiz.getSelectedItems(action.run, true);
                }
            }
        },
        getGroup: function () {
            return (typeof action.group == "function" ? action.group() : action.group) || "No group";
        },
        id: action.id
    };
};
DataViewWidget.prototype.createActionMenuAction = function (action) {
    var thiz = this;
    return {
        title: action.title,
        icon: action.icon,
        run: function (event) {
            thiz._lastActionEventInfo = {
                alternative: event.shiftKey
            };

            if (action.runOnIds) {
                thiz.getSelectedItemIds(action.runOnIds, true);
            } else {
                if (action.selectionIndependent) {
                    action.run();
                } else {
                    thiz.getSelectedItems(action.run, true);
                }
            }
        },
        applicable: function () {
            if (typeof(action.applicable) == "undefined") {
                if (action.selectionIndependent) return true;
                return thiz.getSelectedItemCount() > 0;
            } else {
                if (typeof(action.applicable) == "function") return action.applicable(thiz.getSelectedItemCount(), thiz);
                return action.applicable;
            }
        },
        visible: function () {
            if (typeof(action.visible) == "undefined") {
                return true;
            } else {
                if (typeof(action.visible) == "function") return action.visible(thiz.getSelectedItemCount(), thiz);
                return action.visible;
            }
        },
        group: action.group
    };
};
DataViewWidget.prototype.isWithAlternativeHint = function () {
    return this._lastActionEventInfo && this._lastActionEventInfo.alternative;
};

DataViewWidget.prototype.registerActions = function (actions, title, icon) {
    var config = {
        "title": title,
        "icon": icon
    }
    this.registerActionsByConfig(actions, config);
};

DataViewWidget.prototype.registerActionsByConfig = function (actions, holderConfig) {
    var actionItem = {
        "title": holderConfig ? holderConfig.title : undefined,
        "icon": holderConfig ? holderConfig.icon : undefined,
        "menuKey": holderConfig ? holderConfig.menuKey : undefined,
        "actions": actions
    };
    this.actionAdapter.add(actionItem);
    this.buildActions();
};

DataViewWidget.prototype.buildActions = function() {
    var actions = this.actions || [];
    var actionBar = this.actionBar;
    actions.forEach(function(action) {
        if (action instanceof ActionMenu || action instanceof ActionBar) {
            actionBar.removeChild(action.node());
        }
    })

    var thiz = this;
    this.actions = [];
    var actionItems = this.actionAdapter.getActions() || [];
    actionItems.forEach(function(aItem) {
        var actions = aItem.actions;
        var actionMenu;
        var actionBar;
        for (var i = 0; i < actions.length; i++) {
            var action = actions[i];
            if (action.important) {
                if (!actionBar) actionBar = new ActionBar();
                actionBar.register(thiz.createActionBarAction(action));
            } else {
                if (!actionMenu) {
                    actionMenu = new ActionMenu();
                    actionMenu.setTitle({label: aItem.title || "Action", icon: aItem.icon});
                }
                actionMenu.register(thiz.createActionMenuAction(action));
            }
        };
        if (actionMenu) {
            thiz.actions.push(actionMenu);
            thiz.actionBar.appendChild(actionMenu.node());
        }
        if (actionBar) {
            thiz.actions.push(actionBar);
            thiz.actionBar.appendChild(actionBar.node());
        }
    });
    this._invalidateActions();
}

DataViewWidget.prototype.getSelectedItems = function (callback) {
    return this.paginator.getSelectedItems(callback);
};
DataViewWidget.prototype.getSelectedItemIds = function (callback) {
    return this.paginator.getSelectedItemIds(callback);
};
DataViewWidget.prototype.getSelectedItemCount = function () {
    return this.paginator.getSelectionCount();
};
DataViewWidget.prototype.getSelectedItems = function (callback) {
    return this.paginator.getSelectedItems(callback);
};
DataViewWidget.prototype.isSelectAllMarked = function () {
    return this.dataTable.isSelectAll();
};
DataViewWidget.prototype.refreshDataList = function (keepSelection) {
    if (!keepSelection) this.paginator.clearSelection();
    this.paginator.refresh();
    this._invalidateActions();
};
DataViewWidget.prototype._getExtendedDefaultSavedView = function (providedSavedView) {
    var savedView = this.savedFilterCombo._getNullDefaultView();
    savedView.name = providedSavedView.name || savedView.name;
    for (var name in providedSavedView.valueMap) {
        savedView.valueMap[name] = providedSavedView.valueMap[name];
    }

    if (providedSavedView.sortedBy) savedView.sortedBy = providedSavedView.sortedBy;

    savedView._provided = true;

    return savedView;
};
DataViewWidget.prototype.setProvidedSavedView = function (providedSavedView, applyAfterSetupDone) {
    if (applyAfterSetupDone) {
        var thiz = this;
        function handler() {
            thiz.savedView = thiz._getExtendedDefaultSavedView(providedSavedView);
            thiz._applySavedView();
        }

        if (thiz._setupAndLoadDataDone) {
            handler();
        } else {
            var savedViewUpdater = window.setInterval(function () {
                if (thiz._setupAndLoadDataDone) {
                    if (savedViewUpdater) window.clearInterval(savedViewUpdater);
                    handler();
                }
            }, 100);
        }
    } else {
        var savedView = this._getExtendedDefaultSavedView(providedSavedView);
        this.savedFilterCombo.setSelectedSavedView(savedView);
        this._updateView();
        this._fireFilterChanged();
    }
};

DataViewWidget.prototype.createActionColumnHandler = function () {
    var thiz = this;

    var args = [];
    for (var i = 0; i < arguments.length; i ++ ) {
        var arg = arguments[i];
        args.push(arg);
    }

    return this.dataTable.createActionColumnHandler.apply(this.dataTable, args);
};
DataViewWidget.prototype.disabledSelectAll = function (disabled) {
    this.dataTable.disabledSelectAll(disabled);
};

DataViewWidget.prototype.getFilterEditor = function (filterName) {
    return this.filterView.getEditorFromFilterName(filterName);
};
DataViewWidget.prototype.mustInvalidateColumnsOnFilterChanged = function (filterName) {
    var thiz = this;
    if (typeof(this._mustInvalidateColumns) == "undefined") {
        var filterDependencies = [];
        this.spec.columns.forEach(function (column) {
            if (column.extra && column.extra.dependentOnFilters) {
                var filters = (column.extra.dependentOnFilters.split(",")).filter(function (f) { return filterDependencies.indexOf(f) < 0; });
                if (filters.length) filterDependencies = filterDependencies.concat(filters);
            }
        });

        this._mustInvalidateColumns = filterDependencies.length > 0;
        this._columnFilterDependencies = filterDependencies;
    }

    return this._mustInvalidateColumns && (typeof(filterName) == "undefined" || this._columnFilterDependencies.indexOf(filterName) >= 0);
};

DataViewWidget.prototype._isColumnDependedOnFilter = function (column) {
    return column && column.extra && column.extra.dependentOnFilters;
};

DataViewWidget.prototype.refreshColumns = function (onlyUpdateSpecColumns, callback) {
    var thiz = this;
    var valueMap = this.savedView.valueMap;
    $dataViewService.refreshColumns(this.specId, valueMap, function (freshColumns) {
        this.spec.columns = freshColumns;
        if (!onlyUpdateSpecColumns) {
            var newColumns = freshColumns.filter(function (c) { return thiz._isColumnDependedOnFilter(c) || thiz.savedView.columns.indexOf(c.fieldName) >= 0;});

            var findSpecIndex = function (c) {
                return thiz.spec.columns.findIndex(function (item) { return item.fieldName == c.fieldName; });
            };
            var findSavedViewColumnIndex = function (c) {
                return thiz.savedView.columns.indexOf(c.fieldName);
            };
            newColumns.sort(function (a, b) {
                var aIndex = findSavedViewColumnIndex(a);
                var bIndex = findSavedViewColumnIndex(b);
                if (aIndex >= 0 && bIndex >= 0) return aIndex - bIndex;
                return findSpecIndex(a) - findSpecIndex(a);
            });
            this.savedView.columns = newColumns.map(function (c) { return c.fieldName; });
            this._updateDataTableView();
        }

        if (callback) callback();

    }.bind(this));
};

DataViewWidget.prototype.exportPDF = function (callback, askForOptions) {
    var thiz = this;
    widget.__ensureNamespaceLoaded("print", function (print) {
        if (typeof (askForOptions) == "undefined") {
            if (thiz.isWithAlternativeHint()) askForOptions = true;
        }

        print.PDFExportOptionsDialog.getOptions("dataView:" + thiz.specId, askForOptions, function (pageOptions) {
            if (!pageOptions) return;
            thiz.getPDFExportParamBuilder = function () {
                return {
                    getPageOrientation: function () {
                        if (!pageOptions || (typeof(pageOptions.portrait) == "undefined") || pageOptions.portrait) {
                            return "portrait";
                        } else {
                            return "landscape";
                        }
                    },
                    getPageSize : function () {
                        return pageOptions.size || null;
                    }
                };
            };
            thiz.generatePDFExportTemplate(function (template) {
                new print.PDFExportDialog().open({
                    template: template,
                    data: {
                    },
                    jobName: "PDF"
                });
            });
        });
    });

};

DataViewWidget.prototype.generatePDFExportTemplate = function(callback) {
    var thiz = this;
    var param = this.getPDFExportParamBuilder ? this.getPDFExportParamBuilder() : {};

    var logoURL = "/" + APP_INFO.SE_DEFAULT_APP_LOGO_PATH;
    var copyrightText = APP_INFO.COPYRIGHT_SM;

    var summary = this.savedFilterCombo.generateFilterDescription(this.savedView);

    var div = document.createElement("div");
    div.appendChild(summary);
    var childrens = div.childNodes;
    for (var i = 0; i < childrens.length - 1; i++) {
        var spacing = Dom.newDOMElement({
            _name: "span",
            _text: "; "
        });
        childrens[i].appendChild(spacing);
    }

    var template = {
        pageSize: param.getPageSize ?  param.getPageSize() : "A4",
        pageOrientation: param.getPageOrientation ? param.getPageOrientation() : "portrait",
        pageMargins: param.getPageMargins ? param.getPageMargins() : [40, 96, 40, 80],
        "content": [
            {
                "text": (param.getTitle ? param.getTitle() : "") || this.spec.displayName || this.specId,
                "style": "header"
            },
            {
                "text": Dom.htmlStrip(div.innerHTML),
                "style": "subheader"
            },
            {
                "style": "tableStyle",
                "table": {
                    "headerRows": 1,
                    dontBreakRows: true,
                    "widths": [],
                    "body": []
                },
                layout: {
                    hLineWidth: "0.5",
                    vLineWidth: "0.5",
                    hLineColor: "'black'",
                    vLineColor: "'black'",
                    hLineStyle: "null",
                    vLineStyle: "null",
                }
            }
        ],
        header: {
            table: {
                widths: [200, "*"],
                body: [
                    [
                        {
                            image: "${image(\"" + ADMIN_CONTEXT.teamLogoUrl + "\")}",
                            fit: [80, 60],
                            border: [false, false, false, true]
                        },
                        {
                            text: ADMIN_CONTEXT.teamName,
                            alignment: "right",
                            margin: [0, 8, 0, 0],
                            bold: true,
                            fontSize: 13,
                            border: [false, false, false, true]
                        }
                    ]
                ]
            },
            margin: [40, 20, 40, 0]
        },
        footer: {
            columns: [
              {
                  image: "${image(\"" + logoURL + "\")}",
                  fit: [80, 40]
              },
              { text: copyrightText, alignment: "right", margin: [0, 10, 0, 0], color: "gray" }
            ],
            margin: [40, 20, 40, 0]
        },
        "styles": {
            "name": {
                bold: true,
                "margin": [4, 4, 4, 4]
            },
            "cell": {
                "margin": [4, 4, 4, 4]
            },
            "tableHeader": {
                "bold": true,
                "margin": [4, 4, 4, 4]
            },
            "header": {
                "fontSize": 20,
                "bold": true,
                "margin": [0, 0, 0, 0]
            },
            "subheader": {
                "bold": false,
                "margin": [0, 5, 0, 5]
            },
            "tableStyle": {
                "margin": [0, 5, 0, 15]
            }
        },
        "defaultStyle": {
            fontSize: 8
        },
        images: {
        }
    };
    var columns = [];
    var columnData = {};
    this.dataTable.getVisibleColumns().forEach(function (column) {
        if (thiz.shouldExpportColumn && !this.shouldExpportColumn(column)) return;
        if (column instanceof DataTable.SelectorColumn) return;
        if (column.title == "Actions" || column._actions) return;

        columns.push(column);
        columnData[column.id] = {};
    });

    var table = template.content[2].table;

    //generate table column sizing and names
    table.widths = [];
    columns.forEach(function (column) {
        if (column.pdfRenderer && column.pdfRenderer.subColumnWidths) {
            Array.prototype.push.apply(table.widths, column.pdfRenderer.subColumnWidths);
        } else {
            var w = "*";
            if (!column.preferredWidth) {
                w = 50
            } else if (column.preferredWidth.match(/^([0-9\.]+)em$/)) {
                w = Math.round(parseFloat(RegExp.$1) * 5);
            } else if (column.preferredWidth.match(/^([0-9\.]+)px$/)) {
                w = Math.round(parseFloat(RegExp.$1) * 0.7);
            }

            table.widths.push(w);
        }
    });

    table.body[0] = [];
    columns.forEach(function (column) {
        var cell = {
            text: column.title,
            style: "tableHeader"
        };
        table.body[0].push(cell);

        if (column.pdfRenderer && column.pdfRenderer.subColumnWidths) {
            cell.colSpan = column.pdfRenderer.subColumnWidths.length;
            for (var i = 1; i < column.pdfRenderer.subColumnWidths.length; i ++) table.body[0].push("");
        }
    })

    var ds = null;

    var selectedItemCount = this.getSelectedItemCount();

    if (selectedItemCount <= 0) {
        ds = {
            order: this.dataListSource.order,
            loadPage: this._createDataSourceLoadPageFunction(true, "Loading...")
        };
    } else {
        ds = {
            loadPage: function (pageIndex, pageSize, callback) {
                if (pageIndex > 0) {
                    callback([], selectedItemCount);
                } else {
                    thiz.getSelectedItems(function (items) {
                        callback(items, selectedItemCount);
                    });
                }
            }
        };
    }

    var pageIndex = -1;
    var pageSize = 50;
    var rowIndex = 0;

    function specToText(spec) {
        if (!spec) return "";
        if (spec._name == "br") return "\n";
        if (typeof(spec._text) != "undefined") {
            if (spec._name == "strong") {
                return {text: spec._text, bold: true};
            } else {
                return spec._text;
            }
        }
        if (typeof(spec._html) != "undefined") return Dom.htmlStrip(spec._html);
        if (spec._children) {
            var array = [];
            var delim = (spec._name == "vbox") ? "\n" : " ";
            spec._children.forEach(function (c) {
                if (array.length > 0 && delim) array.push(delim);
                var text = specToText(c);
                if (typeof(text) == "string" && text) {
                    array.push(text);
                } else if (typeof(text) == "object") {
                    if (text.splice) {
                        array = array.concat(text);
                    } else if (text.text) {
                        array.push(text);
                    }
                }
            });

            return array;
        }

        return "";
    }

    (function next() {
        pageIndex ++;
        ds.loadPage(pageIndex, pageSize, function (items, count) {
            if (!items || items.length == 0) {
                callback(template);
            } else {
                try {
                    items.forEach(function (item) {
                        var row = [];

                        columns.forEach(function (column, colIndex) {
                            var data = columnData[column.id];
                            var cellCount = (column.pdfRenderer && column.pdfRenderer.subColumnWidths) ? column.pdfRenderer.subColumnWidths.length : 1;
                            if (column.getGroupKey) {
                                var groupKey = column.getGroupKey(item, rowIndex, colIndex);

                                if (groupKey == data.lastGroupKey) {
                                    data.lastCells.forEach(function (lastCell) {
                                        lastCell.rowSpan = (lastCell.rowSpan || 1) + 1;
                                    });
                                    for (var i = 0; i < cellCount; i ++) row.push("");
                                    return;
                                } else {
                                    data.lastGroupKey = groupKey;
                                }
                            }

                            var cells = [];
                            if (column.pdfRenderer) {
                                cells = column.pdfRenderer.render(item, rowIndex, colIndex);
                                if (cellCount > 1) {
                                    if (cells.length != cellCount) throw new Error("Invalid cell count returned by pdfRender of " + column.id);

                                    Array.prototype.push.apply(row, cells);
                                } else {
                                    row.push(cells)
                                    cells = [cells]; // return value is not an array, so wrap it.
                                }
                            } else {
                                var text = "";
                                if (column instanceof DataTable.PlainTextColumn) {
                                    text = column.getter(item, rowIndex, colIndex);
                                } else if (column instanceof DataTable.GenericDomColumn) {
                                    text = specToText(column.renderer(item, rowIndex, colIndex));
                                }

                                var cell = {
                                    text: text,
                                    style: "cell",
                                    alignment: column.extra.pdfTextAlignment || "left"
                                };
                                row.push(cell)

                                cells = [cell];
                            }

                            if (column.getGroupKey) data.lastCells = cells;
                        });

                        table.body.push(row);

                        rowIndex ++;
                    });
                } catch (e) {
                    console.error(e);
                } finally {
                    next();
                }
            }
        }, function (e) {
            callback(null, e);
        })
    })();
};

DataViewWidget.prototype._buildParamsForExport = function () {
    var fieldNames = [];
    var reversedNullSide = false;

    var order = this.dataListSource.order;

    if (this.savedView.columns) {
        fieldNames = this.savedView.columns;
    }

    var thiz = this;
    this.spec.columns.forEach(function (c) {
        if (c.fieldName == order.propertyName) {
            reversedNullSide = c.reversedNullSide;
        }

        if (!thiz.savedView.columns && c.visible) {
            fieldNames.push(c.fieldName);
        }
    });

    var nullSide = reversedNullSide ? order.asc : !order.asc;
    var valueMap = this.savedView.valueMap || {};
    if (thiz._convertFilterMap) valueMap = thiz._convertFilterMap(valueMap);
    return {
        valueMap: valueMap,
        orders: [{name: order.propertyName, asc: order.asc, nullSide: nullSide}],
        fieldNames: fieldNames
    }
};

DataViewWidget.prototype.export = function (outputFormat, ids, askForOptions) {
    var paramData = this._buildParamsForExport();
    var thiz = this;
    var extraInfos = {};
    if (ids && ids.length) extraInfos.ids = ids;
    var serviceCaller = function (pageOptions) {
        if (pageOptions) {
            extraInfos.pageOption = {
                pageSizeName: pageOptions.size,
                portrait: pageOptions.portrait
            };
        }
        $dataViewService.export(this.specId, paramData.valueMap, paramData.orders, paramData.fieldNames, outputFormat, extraInfos, function (jobId) {
            thiz._onExportFile(outputFormat, jobId);
        }, "Exporting...");
    }.bind(this);

    if (outputFormat == "PDF") {
        widget.__ensureNamespaceLoaded("print", function (print) {
            if (typeof (askForOptions) == "undefined") {
                if (thiz.isWithAlternativeHint()) askForOptions = true;
            }

            print.PDFExportOptionsDialog.getOptions("dataView:" + thiz.specId, askForOptions, function (pageOptions) {
                if (!pageOptions) return;
                serviceCaller(pageOptions);
            });
        });
    } else {
        serviceCaller();
    }
};

DataViewWidget.prototype._onExportFile = function (outputFormat, jobId) {
    var thiz = this;
    thiz._onExportJobExcuted(jobId, function (fileUrl) {
        if (outputFormat == "PDF") {
            widget.__ensureNamespaceLoaded("print", function (m) {
                new m.PDFExportResultDialog().open({dataURI: fileUrl});
            });
        } else {
            Util.initiateDownload(fileUrl);
        }
    });
};

DataViewWidget.prototype._onExportJobExcuted = function(jobId, callback, message) {
    if (!jobId || jobId.length == 0) return;
    var thiz = this;
    var busyIndicator = new Spinner(message || "Export To File...");
    busyIndicator.busy();
    var thiz = this;
    var onFailed = function (error) {
        Dialog.error(error && error.message || "Error when exporting.");
    };
    (function checker() {
        var timeoutTask = window.setTimeout(function(){
            $jobService.getJobExecutionResult(jobId, function (job) {
                if (job) {
                    if (job.status == "Done") {
                        busyIndicator.done();
                        callback(job.data);
                    } else if (job.status == "Running") {
                        checker();
                    } else {
                        busyIndicator.done();
                        console.log(job);
                        onFailed({message: (job && job.errorMessage) || "Job execution error."});
                    }
                } else {
                    busyIndicator.done();
                    onFailed(null, {message: "Job not found."});
                }
            }, function (error) {
                busyIndicator.done();
                onFailed(error);
            });
        }, 1500);
    })();
};

DataViewWidget.prototype.getDymanicFilterValue = function () {
    return null;
};

var SystemDataView = window.DataView;
widget.registerAliases("DataViewWidget", ["DataView"]);
//var DataView = DataViewWidget;


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataViewActionAdapter.js";

function DataViewActionAdapter() {
    this.actionItems = [];
    this._actionKeyGetter = function(action) {
        if (typeof(action.id) == "undefined") return action.key;
        return action.id;
    }
    this.actionMenuItemComparer = function(a, b) {
        if (!this._actionKeyGetter(a) || !this._actionKeyGetter(b)) return false;
        return this._actionKeyGetter(a) == this._actionKeyGetter(b);
    }.bind(this);
}

DataViewActionAdapter.prototype.combineActions = function(orgItems, targetItems) {
    orgItems = orgItems || [];
    targetItems = targetItems || [];
    var combineItems = orgItems.length ? [].concat(orgItems) : [];
    targetItems.forEach(function(tItem) {
        var isRegNew = true;
        if (this._actionKeyGetter(tItem)) {
            var i = Util.findItemByComparer(orgItems, tItem, this.actionMenuItemComparer);
            if (i > -1) {
                isRegNew = false;
                combineItems[i] = tItem;
            }
        }
        if (isRegNew) combineItems.push(tItem);
    }.bind(this));
    return combineItems;
}

DataViewActionAdapter.prototype.add = function(action) {
    var isRegNew = true;
    if (action.menuKey) {
        this.actionItems.forEach(function(item) {
            if (item.menuKey && item.menuKey == action.menuKey) {
                isRegNew = false;
                if (action.icon) item.icon = action.icon;
                var combineActions = this.combineActions(item.actions, action.actions);
                item.actions = combineActions;
            }
        }.bind(this));
    }
    if (isRegNew) this.actionItems.push(action);
}

DataViewActionAdapter.prototype.getActions = function() {
    return this.actionItems;
}

if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataViewSavedViewSelector.js";

function DataViewSavedViewSelector(node) {
    BaseTemplatedWidget.call(this);
    var thiz = this;

    this.itemRepeaterView.populator = function (data, binding, node) {
        if (!data) {
            Dom.setInnerText(binding.itemNameLabel, thiz.spec.defaultViewFromDefaultValues ? "Default View" : "View All");
            binding.itemDescriptionLabel.innerHTML = "";
            binding.itemDescriptionLabel.appendChild(thiz.generateFilterDescription(thiz._getNullDefaultView()));
            Dom.addClass(binding._node, "Null");

            Dom.toggleClass(binding._node, "DefaultView", thiz.defaultSavedView ? false : true);
            binding.makeDefaultButton.setAttribute("title", "Use this unfiltered view by default");
        } else {
            Dom.setInnerText(binding.itemNameLabel, data.name);
            binding.itemDescriptionLabel.innerHTML = "";
            binding.itemDescriptionLabel.appendChild(thiz.generateFilterDescription(data));

            Dom.toggleClass(binding._node, "DefaultView", data.isDefault);
            var mine = (data.accountId == ACCOUNT_INFO.id);
            var sharable = mine && PermissionUtils.isAccountWithAllPermissions(ACCOUNT_INFO, PERMISSION_KEY.OrgTool_SavedView_Share);

            Dom.toggleClass(binding._node, "Mine", mine);
            Dom.toggleClass(binding._node, "Sharable", sharable);
            Dom.toggleClass(binding._node, "Shared", data.sharingMode && data.sharingMode != "NONE");

            if (!mine) {
                binding._node.setAttribute("account-name", data.accountFullName);
                binding.itemSharingInfoLabel.innerHTML = "";
                binding.itemSharingInfoLabel.appendChild(document.createTextNode("Shared by " + data.accountFullName));
            }

            binding.makeDefaultButton.setAttribute("title", "Mark this saved view as default");
        }

        var text = thiz._buildDescriptionText(binding.itemDescriptionLabel);
        node.setAttribute("title", text);

        binding._node._savedView = data;
    };

    this.popup.setPopupClass("DataViewSavedViewSelectorPopup");

    this.bind("p:PopupShown", function () {
        if (this.dnd) return;
        this._setupReordering();
    }, this.popup);
    this.bind("p:PopupHidden", function () {
        this._lastPopupHiddenAt = new Date().getTime();
    }, this.popup);

    this.bind("click", this._showPopup);
    this.bind("click", this._handleMenuClick, this.itemRepeaterView.node());
}
__extend(BaseTemplatedWidget, DataViewSavedViewSelector);

DataViewSavedViewSelector.prototype.onDetached = function() {
    if (this.popup) {
        this.popup.kill();
    }
}
DataViewSavedViewSelector.prototype.updateFilters = function (filters) {
    if (typeof this.filterMap !== "object") {
        this.filterMap = {};
        for (var i = 0; i < filters.length; i ++) {
            var filter = filters[i];
            this.filterMap[filter.fieldName] = filter;
        }
    } else {
        for (var i = 0; i < filters.length; i ++) {
            var filter = filters[i];
            if (this._needCheckToUpdateFilterValues(filter)) {
                var keptFilter = this.filterMap[filter.fieldName];
                if (!keptFilter) {
                    keptFilter = Util.clone(filter);
                } else {
                    if (Array.isArray(filter.values) && filter.values.length) {
                        var currentValueArr = [];
                        var valueIndexMap = {};
                        if (keptFilter && Array.isArray(keptFilter.values) && keptFilter.values.length) {
                           currentValueArr = keptFilter.values;
                            currentValueArr.map(function (item, index) {
                                var k = item.key || Util.newUUID();
                               valueIndexMap[k] = index;
                            });
                        }
                        var newValueArr = [];
                        for (var j = 0; j < filter.values.length; j++) {
                            var newValue = filter.values[j];
                            if (!newValue) continue;
                            var key = newValue.key || Util.newUUID();
                            if (Object.prototype.hasOwnProperty.call(valueIndexMap, key)) {
                                var index = valueIndexMap[key];
                                currentValueArr[index] = newValue;
                            } else {
                                newValueArr.push(newValue);
                            }
                        }
                        if (newValueArr.length) currentValueArr = currentValueArr.concat(newValueArr);
                        keptFilter.values = currentValueArr;
                    }
                }
                this.filterMap[filter.fieldName] = keptFilter;
            }
        }
        // TODO update the current item or add a new one but keep the order of data unchanged
    }
};
DataViewSavedViewSelector.prototype.init = function (spec, callback) {
    this.spec = spec;
    this.originalSpecColumns = DataViewWidget._clone(this.spec.columns);
    this.updateFilters(this.spec.filters);

    var thiz = this;
    $dataViewService.getAllSavedViewsBySpecification(this.spec.id, function (paginatedList) {
        var defaultSavedView = paginatedList.result.find(function (item) {
            return item.isDefault;
        });
        thiz.defaultSavedView = defaultSavedView;

        thiz._updateFilterValuesAndRender(paginatedList);

        thiz.setSelectedSavedView(defaultSavedView ? defaultSavedView : null, false, null);

        if (callback) callback();
    });
};

DataViewSavedViewSelector.prototype._getNullDefaultView = function () {
    var savedView = {
        name: this.spec.defaultViewFromDefaultValues ? "Default View" : "View All",
        valueMap: {},
        columns: [],
        sortedBy: {
            name: "name",
            asc: true
        }
    };

    this.originalSpecColumns.forEach(function (column) {
        if (column.visible) savedView.columns.push(column.fieldName);
    });
    if (this.spec.defaultSortColumn) {
        savedView.sortedBy.name = this.spec.defaultSortColumn;
        savedView.sortedBy.asc = typeof(this.spec.defaultSortDirection) != undefined ? this.spec.defaultSortDirection : true;
    } else {
        var sortableColumn = null;
        for (var i = 0; i < this.spec.columns.length; i ++) {
            var c = this.spec.columns[i];
            if (c.sortable) {
                sortableColumn = c;
                break;
            }
        }

        if (sortableColumn) {
            savedView.sortedBy.name = sortableColumn.sortFieldName || sortableColumn.fieldName;
        }
    }

    if (this.spec.defaultViewFromDefaultValues) {
        var thiz = this;
        this.spec.filters.forEach(function (filter) {
            if (filter.extra
                && (typeof(filter.extra.defaultValue) != "undefined"
                    || typeof(filter.extra.defaultFrom) != "undefined"
                    || typeof(filter.extra.defaultTo) != "undefined")) {
                if (typeof(filter.extra.defaultFrom) != "undefined" || typeof(filter.extra.defaultTo) != "undefined") {
                    if (filter.filterType == "Range") {
                        savedView.valueMap[filter.fieldName] = {from: filter.extra.defaultFrom, to: filter.extra.defaultTo};
                    } else {
                        savedView.valueMap[filter.fieldName] = filter.extra.defaultFrom || filter.extra.defaultTo;
                    }
                } else {
                    savedView.valueMap[filter.fieldName] = filter.extra.defaultValue;
                }
            } else {
                if (filter.filterType == "ExclusiveList") {
                    if (filter.extra && filter.extra.noExtraBlank === true) {
                        if (filter.values && filter.values[0] && filter.values[0].key) {
                            savedView.valueMap[filter.fieldName] = filter.values[0].key;
                        }
                    }
                }
            }
        });
    }

    return savedView;
};

DataViewSavedViewSelector.FILTER_TO_DESCRIPTION_CONVERTER = {
    Date: function(filter, value) {
        var valueText = "";
        if (!value) return null;
        var time = filter.extra && filter.extra.withTime;

        var dateObject = null;
        if (value instanceof Date) {
            dateObject = value;
        } else if (value && typeof(value) == "string") {
            dateObject = moment(value).toDate();
        }

        if (dateObject) {
            valueText = moment(dateObject).format(time ? DateTimePicker.getDateTimeFormat() : DateTimePicker.getDateFormat());
        }

        return {
            _name: "span",
            _children: [
                {
                    _name: "span",
                    "class": "Name",
                    _text: filter.title + ": "
                },
                {
                    _name: "span",
                    "class": "Value",
                    _text: valueText
                }
            ]
        };
    },
    Range: function (filter, value, instance) {
        var valueText = "";

        if (!value || ((typeof(value.from) == "undefined" || value.from === null)
                    && (typeof(value.to) == "undefined" || value.to === null))
                    && (typeof(value.name) == "undefined" || value.name === null)) {
            return null;
        }

        if  (filter.extra.dataType == "Date" && filter.extra.useFriendlyRangeName && value && value.name) {
            if (value.name == DateTimeRangePicker.OPTIONS_ALL_TIME_KEY) return;
            var timeRange = DateTimeRangePicker.OPTIONS_MAP[value.name];

            if (timeRange) {
                valueText = timeRange.title;
            }
        }

        var time = filter.extra && filter.extra.withTime;
        var tzid = instance.spec.displayTimeZoneProvider.getTimezoneId();
        var formatName = time ? "datetime_standard" : "date_standard";

        if (value.from !== null && value.from !== undefined) {
            var s = value.from;
            if (filter.extra && filter.extra.dataType == "Date") {
                var dateObject = null;
                if (value.from instanceof Date) {
                    dateObject = value.from;
                } else if (value.from && typeof(value.from) == "string") {
                    dateObject = moment(value.from).toDate();
                }

                if (dateObject) {
                    s = FormatUtil.formatDateWithTZID(dateObject, formatName, tzid);
                }
            }

            valueText = "from " + s;
        }
        if (value.to !== null && value.to !== undefined) {
            var s = value.to;
            if (filter.extra && filter.extra.dataType == "Date") {
                var dateObject = null;
                if (value.to instanceof Date) {
                    dateObject = value.to;
                } else if (value.to && typeof(value.to) == "string") {
                    dateObject = moment(value.to).toDate();
                }

                if (dateObject) {
                    s = FormatUtil.formatDateWithTZID(dateObject, formatName, tzid);
                }
            }

            valueText += " to " + s;
        }

        return {
            _name: "span",
            _children: [
                {
                    _name: "span",
                    "class": "Name",
                    _text: filter.title + ": "
                },
                {
                    _name: "span",
                    "class": "Value",
                    _text: valueText
                }
            ]
        };
    },
    List: function (filter, value) {
        if (!value) return null;
        var childs = [];
        var names = [];
        for (var i = 0, n = filter.values && filter.values.length ; i < n; i++) {
            var item = filter.values[i];
            if ((!value.indexOf && value == item.key) || (value.indexOf && value.indexOf(item.key) >= 0)) names.push(item.shortName || item.value);
            childs.push({key: item.key, value: item.value || ""})
        }

        if (names.length == 0) return null;

        return {
            _name: "span",
            _children: [
                {
                    _name: "span",
                    "class": "Name",
                    _text: filter.title + ": "
                },
                {
                    _name: "span",
                    "class": "Value",
                    _text: names.join(", ")
                }
            ]
        };
    },
    ExclusiveList: function (filter, value) {
        if (!value) return null;
        var childs = [];
        var names = [];
        for (var i = 0 ; i < filter.values.length; i++) {
            var item = filter.values[i];
            if (value == item.key) names.push(item.shortName || item.value);
            childs.push({key: item.key, value: item.value || ""})
        }

        if (names.length == 0) return null;

        return {
            _name: "span",
            _children: [
                {
                    _name: "span",
                    "class": "Name",
                    _text: filter.title + ": "
                },
                {
                    _name: "span",
                    "class": "Value",
                    _text: names.join(", ")
                }
            ]
        };
    },
    Text: function (filter, value) {
        if (!value) return null;
        return {
            _name: "span",
            _children: [
                {
                    _name: "span",
                    "class": "Name",
                    _text: filter.title + ": "
                },
                {
                    _name: "span",
                    "class": "Value",
                    _text: value
                }
            ]
        };
    },
    Boolean: function (filter, value) {
        if (!value) return;
    }
};

DataViewSavedViewSelector.prototype.generateFilterDescription = function (savedView, shouldUpdateFilterValues, callback) {
    var generator = function () {
        var filters = [];
        if (savedView && savedView.valueMap) {
            for (var name in savedView.valueMap) {
                var value = savedView.valueMap[name];
                var filter = this.filterMap[name];

                if (!filter || filter.system) continue;
                var node = DataViewSavedViewSelector.FILTER_TO_DESCRIPTION_CONVERTER[filter.filterType](filter, value, this);
                if (!node) continue;
                filters.push(node);
            }

            if (filters.length > 0) {
                return Dom.newDOMFragment(filters);
            }
        }
        return document.createTextNode("No filter applied");
    }.bind(this);

    if (shouldUpdateFilterValues) {
        if (this.shouldGetFilterValueItems(savedView)) {
            $dataViewService.getFilterValueItems(savedView.valueMap, this.spec.id, function (filterValues) {
                if (filterValues) this._updateFilterValueItems(filterValues);
                if (callback) callback(generator());
            }.bind(this));
        } else {
            if (callback) callback(generator());
        }
    } else {
        if (callback) {
            callback(generator());
        } else {
            return generator();
        }
    }
};

DataViewSavedViewSelector.prototype._updateFilterValueItems = function (filterValueItemsMap) {
    if (!filterValueItemsMap) return;
    var fieldNames = Object.keys(filterValueItemsMap);

    for (var i = 0; i < fieldNames.length; i ++) {
        var fieldName = fieldNames[i];
        var valueItems = filterValueItemsMap[fieldName];
        if ((typeof valueItems) == "undefined" || valueItems == null) continue;

        var filter = this.filterMap[fieldName];
        if (this._needCheckToUpdateFilterValues(filter)) {
            if (Array.isArray(filter.values) && filter.values.length) {
                var currentValueArr = filter.values;
                var valueIndexMap = {};
                currentValueArr.map(function (item, index) {
                    var k = item.key || Util.newUUID();
                   valueIndexMap[k] = index;
                });
                var newValueArr = [];
                for (var j = 0; j < valueItems.length; j++) {
                    var newValue = valueItems[j];
                    if (!newValue) continue;
                    var key = newValue.key || Util.newUUID();
                    if (Object.prototype.hasOwnProperty.call(valueIndexMap, key)) {
                        var index = valueIndexMap[key];
                        currentValueArr[index] = newValue;
                    } else {
                        newValueArr.push(newValue);
                    }
                }
                if (newValueArr.length) currentValueArr = currentValueArr.concat(newValueArr);
                filter.values = currentValueArr;
            } else {
                filter.values = valueItems;
            }
        }
    }
}

DataViewSavedViewSelector.prototype._needCheckToUpdateFilterValues = function (filter) {
    return filter && !filter.system && (filter.filterType == "List" || filter.filterType == "ExclusiveList") && (filter.valueProviders || filter.searchable);
}
DataViewSavedViewSelector.prototype.shouldGetFilterValueItems = function (savedView) {
    if (savedView && savedView.valueMap) {
        for (var name in savedView.valueMap) {
            var value = savedView.valueMap[name];
            var filter = this.filterMap[name];

            if (this._needCheckToUpdateFilterValues(filter)) {
                if (!filter.values || !filter.values.length) return true;
                if (Array.isArray(value)) {
                    var foundItems = filter.values.filter(function (item) {
                        return value.indexOf(item.key) >= 0;
                    });
                    if (foundItems.length < value.length) return true;
                } else {
                    var found = false;
                    for (var i = 0 ; i < filter.values.length; i++) {
                        var item = filter.values[i];
                        if (value == item.key) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) return true;
                }
            }
        }
    }

    return false;
};
DataViewSavedViewSelector.prototype.setSelectedSavedView = function (savedView, modified, originalSavedView) {
    if (!savedView) {
        Dom.setInnerText(this.nameLabel, this.spec.defaultViewFromDefaultValues ? "Default View" : "View All");
        this.descriptionLabel.innerHTML = "";
        this.generateFilterDescription(this._getNullDefaultView(), true, function (node) {
            this.descriptionLabel.innerHTML = "";
            this.descriptionLabel.appendChild(node);
        }.bind(this));
        Dom.addClass(this.displayBox, "Null");
        Dom.removeClass(this.displayBox, "DefaultView");
    } else {
        if (!modified) {
            Dom.setInnerText(this.nameLabel, savedView.name);
        } else {
            if (originalSavedView) {
                Dom.setInnerText(this.nameLabel, savedView.name + " (modified)");
            } else {
                Dom.setInnerText(this.nameLabel, "Unsaved View");
            }
        }

        this.descriptionLabel.innerHTML = "";
        this.generateFilterDescription(savedView, true, function (node) {
            this.descriptionLabel.innerHTML = "";
            this.descriptionLabel.appendChild(node);
        }.bind(this));

        Dom.removeClass(this.displayBox, "Null");
        Dom.toggleClass(this.displayBox, "DefaultView", savedView.isDefault);

        var mine = (savedView.accountId == ACCOUNT_INFO.id);
        this.sharingInfoLabel.innerHTML = "";
        if (!mine && savedView.id) {
            this.sharingInfoLabel.appendChild(document.createTextNode("Shared by " + savedView.accountFullName));
        }
    }

    var text = this._buildDescriptionText(this.descriptionLabel);
    this.node().setAttribute("title", text);

    Dom.toggleClass(this.displayBox, "Modified", modified ? true : false);

    this.selectedSavedView = savedView;
    this.modified = modified;
    this.originalSavedView = originalSavedView;

    this._markAsSelected(this.selectedSavedView);
};
DataViewSavedViewSelector.prototype._buildDescriptionText = function (node) {
    return Dom.htmlStrip(node.innerHTML.replace(/<\/span><span><span class="Name">/g, `</span> - <span><span class="Name">`));

};
DataViewSavedViewSelector.prototype.getSelectedSavedView = function () {
    return this.selectedSavedView;
};

DataViewSavedViewSelector.prototype._markAsSelected = function (savedView) {
    Dom.doOnSelector(this.itemRepeaterView.node(), ".SavedViewItem", function (view) {
        var selected = false;
        if (!view._savedView) {
            selected = !savedView;
        } else {
            selected = savedView && savedView.id == view._savedView.id;
        }

        Dom.toggleClass(view, "Selected", selected);
    });
};
DataViewSavedViewSelector.prototype._showPopup = function () {
    var now = new Date().getTime();
    console.log(this._lastPopupHiddenAt, now);
    if (this.popup != null && (this.popup.isVisible() || (this._lastPopupHiddenAt && this._lastPopupHiddenAt >= now - 100))) {
        this.popup.hide();
        return;
    }
    var dataView = this.findUpward(DataViewWidget);
    if (dataView) {
        this.list.style.maxWidth = dataView.node().offsetWidth + "px";
    }
    this.popup.setMinWidth(this.node().offsetWidth);
    this.popup.show(this.node(), "left-inside", "bottom", 0, 5, "autoFlip");
};
DataViewSavedViewSelector.prototype.reload = function (callback) {
    var thiz = this;
    $dataViewService.getAllSavedViewsBySpecification(this.spec.id, function (paginatedList) {
        thiz._updateFilterValuesAndRender(paginatedList);
        if (callback) callback();
    });
};

DataViewSavedViewSelector.prototype._updateFilterValuesAndRender = function (paginatedList) {
    if (paginatedList.extra && paginatedList.extra.filterListItems) this._updateFilterValueItems(paginatedList.extra.filterListItems);
    this._render(paginatedList.result);
};

DataViewSavedViewSelector.prototype._render = function (list) {
    var actualList = [null].concat(list);

    this.itemRepeaterView.setItems(actualList);
};
DataViewSavedViewSelector.prototype._handleMenuClick = function (event) {
    var item = Dom.findParentWithClass(event.target, "SavedViewItem");
    if (!item) return;

    if (Dom.findParentWithClass(event.target, "AnonId_makeDefaultButton")) {
        this._makeDefault(item._savedView);
        return;
    }
    if (Dom.findParentWithClass(event.target, "AnonId_deleteButton")) {
        this._delete(item._savedView);
        return;
    }

    if (Dom.findParentWithClass(event.target, "AnonId_shareButton")) {
        this._editSharing(item._savedView);
        return;
    }

    this.setSelectedSavedView(item._savedView, false, null);
    this.popup.hide();
    Dom.emitEvent("p:ItemSelected", this.node(), {});
};

DataViewSavedViewSelector.prototype._setupReordering = function () {
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (target && target.element) {
            if (Dom.hasClass(target.element, "Null") && target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
                return null;
            }
            if (!Dom.hasClass(target.element, "Mine")) {
                if (target.mode == DragAndDropManager.DROP_NEXT_SIBLING) {
                    return null;
                }

                var n = target.element.previousElementSibling;
                while (n && !Dom.hasClass(n, "SavedViewItem")) {
                    n = n.previousElementSibling;
                }

                if (!n || !Dom.hasClass(n, "Mine")) {
                    return null;
                }
            }
        }
        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
    .source(this.itemRepeaterView.node())
    .anchor(function (node) {
        return Dom.hasClass(node, "ItemDragger");
    })
    .itemInfo(function (anchor) {
        var item = Dom.findParentWithClass(anchor, "SavedViewItem");
        if (!item) return null;
        return {
            element: item,
            data: item._savedView
        };
    })
    .destination(this.itemRepeaterView.node())
    .canDrop(function (data) {
        return data ? true : false;
    }
    .bind(this))
    .dropAt(dropTargetFinderFunction)
    .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "SavedViewItemDragImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        Dom.addClass(draggable, "JustDropped");

        window.setTimeout(function () {
            Dom.removeClass(draggable, "JustDropped");
        }, 100);

        this._saveOrdersLater();
    }.bind(this);
};

DataViewSavedViewSelector.prototype._saveOrdersLater = function () {
    if (this._orderSavingTimeout) window.clearTimeout(this._orderSavingTimeout);
    var thiz = this;
    this._orderSavingTimeout = window.setTimeout(function () {
        thiz._saveOrders();
        thiz._orderSavingTimeout = null;
    }, 1000);
};
DataViewSavedViewSelector.prototype._saveOrders = function () {
    var ids = [];
    Dom.doOnSelector(this.itemRepeaterView.node(), ".SavedViewItem", function (view) {
        if (view._savedView) ids.push(view._savedView.id);
    });

    $dataViewService.updateSavedViewOrders(this.spec.id, ids, function () {
        SnackBar.show("Saved view orders were saved successfully.");
    });
};
DataViewSavedViewSelector.prototype._makeDefault = function (savedView) {
    var thiz = this;

    $dataViewService.makeSavedViewAsDefault(savedView ? savedView.id : 0, this.spec.id, function () {
        var message = savedView ? ("'" + savedView.name + "' was successfully marked as default.") : "Unfiltered view was marked to be used by default.";
        SnackBar.show(message);
        $dataViewService.getAllSavedViewsBySpecification(thiz.spec.id, function (paginatedList) {
            var defaultSavedView = paginatedList.result.find(function (item) {
                return item.isDefault;
            });
            thiz.defaultSavedView = defaultSavedView;

            thiz._updateFilterValuesAndRender(paginatedList);
            thiz._markAsSelected(thiz.selectedSavedView);
        });
    });
};
DataViewSavedViewSelector.prototype._editSharing = function (savedView) {
    var thiz = this;
    new DataViewSavedViewSharingDetailDialog().callback(function (updated) {
        $dataViewService.getAllSavedViewsBySpecification(thiz.spec.id, function (paginatedList) {
            thiz._updateFilterValuesAndRender(paginatedList);
        });
    }).open(savedView);
};
DataViewSavedViewSelector.prototype._delete = function (savedView) {
    var thiz = this;
    Dialog.confirm("Are you sure you want to delete this saved view?",
        "This operation cannot be rolled back. Deleted save view cannot be restored.",
        "Delete", function () {
            $dataViewService.deleteSavedView(savedView.id, function () {
                $dataViewService.getAllSavedViewsBySpecification(thiz.spec.id, function (paginatedList) {
                    thiz._updateFilterValuesAndRender(paginatedList);

                    // var defaultSavedView = paginatedList.result.find(function (item) {
                    //     return item.isDefault;
                    // });
                    //
                    // thiz.setSelectedSavedView(defaultSavedView ? defaultSavedView : null, false, null);
                    //
                    // if (callback) callback();
                });
            });
        },
        "Cancel", function () {
    });
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataViewFilterView.js";

function DataViewFilterView(node) {
    BaseTemplatedWidget.call(this);

    this.propertiesWidget.onValueChanged = this.onValueChanged.bind(this);
    this.propertiesWidget.ignoreValueIfDependencyUnsatisfied(true);

    this.renderGroup = Dom.getAttributeAsBoolean(node, "show-group-name", false);
}
__extend(BaseTemplatedWidget, DataViewFilterView);
DataViewFilterView.NOT_FILTERED_MARKER_VALUE = "@!__not_filtered";
DataViewFilterView.FILTER_TO_SCHEMA_CONVERTER = {
    Date: function (filter, value, spec) {
        var schema = {
            displayName: filter.title,
            name: filter.fieldName,
            type: "Date",
            minValue: filter.minValue,
            maxValue: filter.maxValue,
            decimal: filter.extra && filter.extra.decimal,
            //defaultValue: filter.extra && filter.extra.defaultValue || filter.extra && filter.extra.defaultFrom,
            withTime: filter.extra && filter.extra.withTime,
            useEndOfDay: filter.extra && filter.extra.useEndOfDay,
            blankValue: null,
            timezoneProvider: spec.inputTimeZoneProvider
        };
        return schema;
    },
    Range: function (filter, value, spec) {
        if  (filter.extra.dataType == "Date" && filter.extra.useFriendlyRangeName) {
            var schema = {
                displayName: filter.title,
                name: filter.fieldName,
                description: filter.description,
                type: "DateRange",
                useEndDateEOD: filter.extra.useEndDateEOD,
                timezoneProvider: spec.inputTimeZoneProvider,
                namedRangekeys: filter.extra.namedRangekeys,
                customExtraTitle: filter.extra.customExtraTitle
            };

            return schema;
        }
        var schema = {
            displayName: filter.title,
            name: filter.fieldName,
            description: filter.description,
            type: "Complex",
            schemas: [
                {
                    displayName: filter.title + " from",
                    name: "from",
                    type: filter.extra.dataType == "Date" ? "Date" : "Number",
                    minValue: filter.extra && filter.extra.minValue,
                    maxValue: filter.extra && filter.extra.maxValue,
                    decimal: filter.extra && filter.extra.decimal,
                    //defaultValue: filter.extra && filter.extra.defaultFrom || filter.extra && filter.extra.defaultValue && filter.extra.defaultValue.from,
                    withTime: filter.extra && filter.extra.withTime,
                    blankValue: null,
                    timezoneProvider: spec.inputTimeZoneProvider
                },
                {
                    displayName: filter.title + " to",
                    name: "to",
                    type: filter.extra.dataType == "Date" ? "Date" : "Number",
                    minValue: filter.extra && filter.extra.minValue,
                    maxValue: filter.extra && filter.extra.maxValue,
                    decimal: filter.extra && filter.extra.decimal,
                    //defaultValue: filter.extra && filter.extra.defaultTo || filter.extra && filter.extra.defaultValue && filter.extra.defaultValue.to,
                    blankValue: null,
                    withTime: filter.extra && filter.extra.withTime,
                    useEndOfDay: filter.extra && filter.extra.useEndDateEOD,
                    timezoneProvider: spec.inputTimeZoneProvider
                }
            ]
        };

        return schema;
    },
    List: function (filter, value, spec) {
        if (!filter.searchable) {
            var childs = [];
            for (var i = 0, n = filter.values && filter.values.length; i < n; i++) {
                var item = filter.values[i];
                var child = {key: item.key, value: item.value || ""};                
                if (item.extraAttributes) {
                    child.extraAttributes = item.extraAttributes;
                }
                childs.push(child);
            }
            var schema = {
                displayName: filter.title,
                name: filter.fieldName,
                description: filter.description,
                //defaultValue: filter.extra.defaultValue || [],
                allIndicationValue: filter.extra.allIndicationValue,
                useActualValuesForAll: filter.extra.noAllSelection,
                noneSelectionText: filter.extra.noneSelectionText,
                autoSwitchToCheckbox: filter.extra.autoSwitchToCheckbox,
                checkboxDisplayType: filter.extra.checkboxDisplayType,
                listItemDisplayType: filter.extra.listItemDisplayType,
                filterBox: !!filter.extra.filterable,
                filterHintText: filter.extra.filterable ? filter.extra.filterHintText : "",
                type: "Enum",
                exclusive: false,
                items: childs
            };

            return schema;
        } else {
            var schema = {
                displayName: filter.title,
                name: filter.fieldName,
                description: filter.description,
                //defaultValue: filter.extra.defaultValue || [],
                allIndicationValue: filter.extra.allIndicationValue,
                useActualValuesForAll: filter.extra.noAllSelection,
                noneSelectionText: filter.extra.noneSelectionText,
                type: "SearchableEnum",
                provider: function (keys, term, editor, callback) {
                    var filterView = BaseWidget.findUpward(editor.node(), DataViewFilterView);
                    $dataViewService.findFilterListItems(spec.id, filter.fieldName, filterView.getValueMap(), keys, term, callback);
                }
            };

            return schema;

        }
    },
    ExclusiveList: function (filter, value, spec) {
        var extras = [];
        if (!filter.extra.noExtraBlank) {
            extras = [{key: null, value:  (filter.extra.blankDisplayValue || "\u00A0\u00A0\u00A0\u00A0")}];
        }
        var actualValues = extras.concat(filter.values);
        var schema = {
            displayName: filter.title,
            name: filter.fieldName,
            description: filter.description,
            type: "Enum",
            exclusive: true,
            //defaultValue: filter.extra.defaultValue || 0,
            items: actualValues
        };

        return schema;
    },
    Text: function (filter, value, spec) {
        var schema = {
            displayName: filter.title,
            name: filter.fieldName,
            //defaultValue: filter.extra.defaultValue || "",
            type: "String",
            placeHolder: filter.description
        };

        return schema;
    },
    Boolean: function (filter, value, spec) {
        var schema = {
            displayName: filter.title,
            name: filter.fieldName,
            type: "Boolean",
            placeHolder: filter.description,
            autoSwitchToCheckbox: filter.extra.autoSwitchToCheckbox,
            icon: filter.extra.icon
        };

        return schema;
    }
};

DataViewFilterView.prototype.setFilterList = function (filters, valueMap, spec) {
    this.defaultValueMap = {};
    this.spec = spec;
    if (spec.defaultViewFromDefaultValues) {
        this.valueMap = this.addDefaultValueMap(valueMap, filters);
    } else {
        this.valueMap = valueMap || {};
    }
    this.filters = filters;
    this.latestFilters = filters;

    this.dynamicFilters = [];
    this.dependentFiltersByProviderMap = {};
    var schemas = [];
    for (var i = 0; i < this.filters.length; i ++) {
        var filter = this.filters[i];
        if (filter.system) continue;
        schemas.push(this.filterToSchema(filter));

        if (filter.extra && filter.extra.dynamic) this.dynamicFilters.push(filter);

        if (Array.isArray(filter.valueProviders)) {
            for (var j = 0; j < filter.valueProviders.length; j++) {
                var path = filter.valueProviders[j];
                var providers = this.dependentFiltersByProviderMap[path];
                if (!providers) providers = [];
                providers.push(filter);
                this.dependentFiltersByProviderMap[path] = providers;
            }
        }
    }

    this.propertiesWidget.setSchemas(schemas);
    this.propertiesWidget.setValue(this.valueMap);
    this.propertiesWidget.setup();
    var scrollableView = this.findUpward(ScrollableView);
    if (scrollableView) {
        window.setTimeout(function () {
            scrollableView.invalidate();
        }, 100);
    }
};
DataViewFilterView.prototype.addDefaultValueMap = function (valueMap, filters) {
    if (!valueMap) valueMap = {};
    var thiz = this;
    filters.forEach(function(filter) {
        if (filter.extra && typeof(filter.extra.defaultValue) != "undefined") {
            if (typeof(valueMap[filter.fieldName]) == "undefined") {
                valueMap[filter.fieldName] = filter.extra.defaultValue;
            }
            thiz.defaultValueMap[filter.fieldName] = filter.extra.defaultValue;
        }
    });
    return valueMap;
};
DataViewFilterView.prototype.filterToSchema = function (filter) {
    if (filter.dynamic && this.filterEnricher) {
        this.filterEnricher.enrich(filter, this.valueMap || this.getValueMap() || {});
    }

    var schema = this._convertFilter(filter);
    return schema;
};

DataViewFilterView.prototype._convertFilter = function (filter) {
    var converter = DataViewFilterView.FILTER_TO_SCHEMA_CONVERTER[filter.filterType];
    var schema = converter(filter, this.valueMap[filter.fieldName], this.spec);
    if (filter.dependencies && filter.dependencies.length > 0) {
        schema.depends = [];
        filter.dependencies.map(function (d) {
            schema.depends.push({
                path: "/" + d.path,
                op: d.condition,
                values: d.values
            });
        });
    }

    if (this.renderGroup && filter.groupName) schema.groupName = filter.groupName;
    return schema;
};
DataViewFilterView.prototype.setValueMap = function (valueMap) {
    this.valueMap = valueMap;
    this.propertiesWidget.setValue(valueMap);
    this.propertiesWidget.setup();

    for (var i = 0; i < this.dynamicFilters.length; i ++) {
        var filter = this.dynamicFilters[i];
        this.filterEnricher.enrich(filter, valueMap);
        var schema = this._convertFilter(filter);
        this.propertiesWidget.changeTopLevelSchema("/" + filter.fieldName, schema);
    }
};
DataViewFilterView.prototype.getValueMap = function () {
    return this.propertiesWidget.getValue();
};
DataViewFilterView.prototype.onValueChanged = function (event) {
    var editor = Dom.findUpwardForData(event.target, "_editor");
    Dom.emitEvent("p:PropertyValueChanged", this.node(), { targetEditor: editor });

    for (var i = 0; i < this.dynamicFilters.length; i ++) {
        var filter = this.dynamicFilters[i];
        var triggerIsNotValueProvider = filter.extra.triggers && filter.extra.triggers.indexOf(editor.path) >= 0
                                    && !(filter.valueProviders && filter.valueProviders.indexOf(editor.path) >= 0);
        if (!filter.extra.triggers || triggerIsNotValueProvider) {
            this.filterEnricher.enrich(filter, this.getValueMap());
            var schema = this._convertFilter(filter);
            this.propertiesWidget.changeTopLevelSchema("/" + filter.fieldName, schema);
        }
        // Dynamic filters that are triggered by the same one as the value provider will be updated by onValueProviderChanged
    }
};
DataViewFilterView.prototype.clearFilters = function () {
    this.propertiesWidget.setValue(this.defaultValueMap || {});
    this.propertiesWidget.setup(true);
}
DataViewFilterView.prototype.getValidationRuleSet = function () {
    return this.propertiesWidget.getValidationRuleSet();
};
DataViewFilterView.prototype.isFromValueProvider = function (event) {
    var editor = event && event.targetEditor;
    return editor && this.dependentFiltersByProviderMap[editor.path];
};
DataViewFilterView.prototype.getFilterNameFromEvent = function (event) {
    var editor = event && event.targetEditor;
    return editor && editor._schema && editor._schema.name || "";
};
DataViewFilterView.prototype.getEditorFromFilterName = function (filterName) {
    var path = "/" + filterName;
    return this.propertiesWidget.getEditorByPath(path);
};
DataViewFilterView.prototype.onValueProviderChanged = function (event, freshFilters) {
    var targetEditor = event && event.targetEditor;
    var dependentFilters = targetEditor && this.dependentFiltersByProviderMap[targetEditor.path];
    if (!dependentFilters) return;

    this.latestFilters = freshFilters;

    var editorByPathMap = {};
    for (var i = 0; i < dependentFilters.length; i ++) {
        var filter = dependentFilters[i];
        var schema = this._convertFilter(filter);
        var path = "/" + schema.name;
        var depEditor = this.propertiesWidget.getEditorByPath(path);
        if (depEditor) editorByPathMap[path] = depEditor;
    }

    this.propertiesWidget.setValue(this.propertiesWidget.getValue());
    for (var i = 0; i < freshFilters.length; i ++) {
        var filter = freshFilters[i];
        this.filterEnricher.enrich(filter, this.getValueMap());
        var schema = this._convertFilter(filter);
        var path = "/" + schema.name;
        if (editorByPathMap[path]) {
            this.propertiesWidget.changeTopLevelSchema(path, schema);
        }
    }
};
DataViewFilterView.prototype.getConceptualFilterList = function () {
    return this.filters;
};
DataViewFilterView.prototype.getActualFilterList = function () {
    return this.latestFilters;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataViewFilterDialog.js";

function DataViewFilterDialog() {
    Dialog.call(this);
    this.title = "Customize" + " Filters";
}

__extend(Dialog, DataViewFilterDialog);

DataViewFilterDialog.prototype.setup = function (options) {
    this.filterView.filterEnricher = options.filterEnricher;

    this.filterView.setFilterList(options.spec.filters.filter(function (f) {
        return !f.instantFilterOnly;
    }), options.valueMap, options.spec);
};

DataViewFilterDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Apply",
            run: function () { this.apply(); return false; }
        }, {
            type: "extra1", title: "Clear Filters",
            run: function () {
                this.filterView.clearFilters();
            }
        }
    ]
};

DataViewFilterDialog.prototype.apply = function () {
    var rs = this.filterView.getValidationRuleSet();
    if (rs && !ValidationManager.run(rs)) return;

    this.close(this.filterView.getValueMap(), this.filterView.getActualFilterList());
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataViewSavedViewSharingDetailDialog.js";

function DataViewSavedViewSharingDetailDialog() {
    Dialog.call(this);
    this.title = "Share Saved View";
    var thiz = this;
    
    this.radioGroup = new RadioGroup(this.noneRadioInput, this.usersRadioInput, this.publicRadioInput, {
        onValueChanged: function (value) {
            var isInUserMode = (value == "USERS");
            thiz.userChipList.setEnabled(isInUserMode);
            thiz.notifyUserCheckbox.disabled = !isInUserMode;
        }
    });
    
    this.userChipList.setup(function (term, callback) {
        if (!term || term.trim().length == 0) {
            callback([]);
        } else {
            $dataViewService.searchUsersForSavedViewSharing(term, [], 20, function (data) {
                callback(data.result)
            });
        }
    }, function (account, selected) {
        return account.first_name + " " + account.last_name;
    });
    
    this.bind("p:ValueChanged", function () {
        thiz.invalidateSizing();
    }, this.userChipList);
}

__extend(Dialog, DataViewSavedViewSharingDetailDialog);

DataViewSavedViewSharingDetailDialog.prototype.asyncSetup = function (args, callback) {
    this.args = args;
    var thiz = this;
    $dataViewService.getSavedViewSharingInfo(this.args.id, function (options) {
        thiz.radioGroup.setValue(options.mode);
        var userMode = options.mode == "USERS";
        thiz.userChipList.setEnabled(userMode);
        thiz.notifyUserCheckbox.disabled = !userMode;
        if (userMode) {
            thiz.userChipList.setItems(options.sharedUsers || []);
        }
        
        callback();
    }, "Loading");
};

DataViewSavedViewSharingDetailDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Save",
            run: function () { this.save(); return false; }
        }
    ]
};

DataViewSavedViewSharingDetailDialog.prototype.save = function () {
    var mode = this.radioGroup.getValue();
    var userIds = [];
    var thiz = this;
    var notifyUsers = false;
    
    if (mode == "USERS") {
        userIds = this.userChipList.getItems().map(function (u) { return u.id; });
        if (userIds.length == 0) {
            Dialog.error("Please specify at least a user.", "", function () {
                thiz.userChipList.focus();
            });
            return;
        }
        
        notifyUsers = this.notifyUserCheckbox.checked;
    }
    
    $dataViewService.updateSavedViewSharingOptions(this.args.id, mode, userIds, notifyUsers, function (callback) {
        thiz.close(true);
    }, "Updating...");
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DataViewSavedViewUpdateDialog.js";

function DataViewSavedViewUpdateDialog() {
    Dialog.call(this);
    this.title = "Save current view";

    this.bind("click", function () {
        this.nameInput.disabled = true;
    }, this.updateRadio);
    this.bind("click", function () {
        this.nameInput.disabled = false;
        this.nameInput.focus();
    }, this.createRadio);
}

__extend(Dialog, DataViewSavedViewUpdateDialog);

DataViewSavedViewUpdateDialog.prototype.setup = function (options) {
    this.savedView = options.savedView;
    var updatable = this._canUpdateSavedView();;
    
    if (this.savedView.id && this.savedView.id > 0 && updatable) {
        this.updateViewLabel.innerHTML = "Update '" + this.savedView.name + "'";
        this.updateRadio.checked = true;
        this.nameInput.disabled = true;
    } else {
        this.updateContainer.style.display = "none";
        this.createRadio.style.display = "none";
        this.createRadio.checked = true;
        this.newViewLabel.innerHTML = "Saved View Name:";
        this.nameInput.focus();
    }
};

DataViewSavedViewUpdateDialog.prototype._canUpdateSavedView = function () {
    var mine = (this.savedView.accountId == ACCOUNT_INFO.id);
    return mine || PermissionUtils.hasAllPermissions(PERMISSION_KEY.OrgTool_SavedView_EditSharedItem);
};

DataViewSavedViewUpdateDialog.prototype.onShown = function () {
    if (this.createRadio.checked) {
        this.nameInput.focus();
    }
};

DataViewSavedViewUpdateDialog.prototype.getDialogActions = function () {
    return [
        {
            type: "cancel", title: "Cancel",
            isCloseHandler: true,
            run: function () { return true; }
        },
        {
            type: "accept", title: "Save",
            run: function () { this.save(); return false; }
        }
    ]
};

DataViewSavedViewUpdateDialog.prototype.save = function () {
    var createNew = this.createRadio.checked;
    var thiz = this;
    if (createNew) {
        var viewName = this.nameInput.value;
        if (viewName == null || viewName.trim() == "") {
            Dialog.error("Please enter the saved view name.");
            return;
        }
        this.savedView.id = 0;
        this.savedView.name = viewName.trim();
        this.savedView.isDefault = false;

        $dataViewService.createSavedView(this.savedView, function (savedView) {
            thiz.close(savedView);
        });

    } else {
        $dataViewService.updateSavedView(this.savedView, function (savedView) {
            thiz.close(savedView);
        });
    }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/SelectBox.js";

function SelectBox(node) {
    var thiz = this;
    this.name = "selectBox";
    this.mode = SelectBox.MODE_CHECK;
    this.direction = SelectBox.DIRECTION_ROW;
    this.multipleSelect = false;
    this.displayStatus = SelectBox.DISPLAY_STATUS_JOINTEXT;
    this.optionSelectAll = false;
    this.optionSelectAllText = "Select All";
    this.filterBox = false;
    this.filterHintText = "input keyword";
    this.filterDateRange = false;
    this.filterDateRangeConfig = {};
    this.useExplicitSelectLinks = false;
    this.noneSelectionText = "(0) item is selected";
    this._enabled = true;
    this._filterTimer = 0;
    this.shouldFocusOnMouseEnter = true;
    /**
    // this.getConfig = function() {
    //     return {
    //         name: "name_string",
    //         mode: SelectBox.MODE_DROPDOWN,               // "dropdown" | "check",
    //         direction: SelectBox.DIRECTION_ROW,          // "row" | "column",
    //         multipleSelect: true,                        // true | false,
    //         displayStatus: SelectBox.DISPLAY_STATUS_JOINTEXT,      // "join_text" | "total"
    //         optionSelectAll: true,                       // true | false,
    //         optionSelectAllText: "Select All",
    //         filterBox: true,                             // true | false
    //         filterHintText: "input keyword",
    //         noneSelectionText: "-- select --"
    //     };
    // }
    // this.getData = function() {
    //     return [
    //         {id: 1, name: "ABC", description: "description", active: true},
    //         {id: 2, name: "MOKA", description: "descript", active: false},
    //         {id: 3, name: "LATTE", description: "Latte Coffee", active: false}
    //     ]
    // }
    // this.parseData = function(object) {
    //     return {
    //         value: object.id,
    //         text: object.name,
    //         checked: true,      // true | false,
    //         role: "",           // "option" | "handle",
    //         type: "",           // "selectall" | "seperator"
    //     }
    // }
    // this.getName = function() { return "name_string"; }
    // this.getMultipleSelect = function() { return true; }
    // this.getMode = function() { return "dropdown" || "check" }
    // this.filter = function(data, keyword) { if (data.name.startsWith(keyword)) return true; else return false; }
    */
    BaseTemplatedWidget.call(this);

    this.popupContainer.onHide = function() {
        if (thiz.mode == SelectBox.MODE_DROPDOWN) {
            thiz._setSelectedStatus();
        }
    }
    this.bind("click", function(e) {
        if (thiz.popupContainer.isVisible()) {
            thiz.popupContainer.hide();
            return;
        }
        Dom.cancelEvent(e);
        thiz.popupContainer.setMinWidth(this.statusItem.offsetWidth);
        thiz.popupContainer.show(thiz.statusBox, "left-inside", "bottom", 0, 5, "autoFlip");
        setTimeout(function() {
            thiz._focusElement(Dom.findFirstChildWithClass(thiz.optionBox, "OptionContainer"));
        }, 20);
    }, this.statusBox);
    this.maximumItemsSelected = Dom.getAttributeAsInt(node, "maximum-items-selected", -1);
}
__extend(BaseTemplatedWidget, SelectBox);

SelectBox.MODE_DROPDOWN = "dropdown";
SelectBox.MODE_CHECK = "check";
SelectBox.DIRECTION_ROW = "row";
SelectBox.DIRECTION_COLUMN = "column";
SelectBox.DISPLAY_STATUS_JOINTEXT = "join_text";
SelectBox.DISPLAY_STATUS_TOTAL = "total";
SelectBox.OPTION_ROLE_OPTION = "option";
SelectBox.OPTION_ROLE_HANDLE = "handle";
SelectBox.HANDLE_TYPE_SELECTALL = "selectall";
SelectBox.HANDLE_TYPE_SEPERATOR = "seperator";
SelectBox.HORIZONTAL_BUTTON = "HorizontalButton";
SelectBox.LIST_ITEM_DISPLAY_TYPE_RADIO = "Radio";

SelectBox.prototype.setContentFragment = function(fragment) {
    var options = [];
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node || node.nodeType != Node.ELEMENT_NODE) continue;
        var role = node.localName;
        if (role == "option") {
            options.push(node);
        }
    }
    this.options = this._parseOptions(options);
    this.setup();
}

SelectBox.prototype.setup = function() {
    var thiz = this;
    this.data = this.getData ? this.getData() : [];
    if (this.parseData) this.options = this._parseData(this.data);    
    // this.options = this.parseData ? this._parseData(this.data) : this._parseOptions(options);
    this.name = Dom.getAttributeAsString(this.node(), "anon-id", this.name + widget.random());
    // Read config from attributes
    this.multipleSelect = Dom.getAttributeAsBoolean(this.node(), "multiple-select", this.multipleSelect);
    this.displayStatus = Dom.getAttributeAsString(this.node(), "display-status", this.displayStatus);
    this.mode = Dom.getAttributeAsString(this.node(), "mode", (this.options.length > 3 ? SelectBox.MODE_DROPDOWN : this.mode));
    this.direction = this.mode == SelectBox.MODE_DROPDOWN ? SelectBox.DIRECTION_COLUMN : Dom.getAttributeAsString(this.node(), "direction", this.direction);
    if (this.getConfigs) {
        var config = this.getConfigs();
        if (config.name) this.name = config.name;
        if (config.mode) this.mode = config.mode;
        if (config.direction) this.direction = config.direction;
        if (config.multipleSelect) this.multipleSelect = config.multipleSelect;
        if (config.displayStatus) this.displayStatus = config.displayStatus;
        if (config.optionSelectAll) this.optionSelectAll = config.optionSelectAll;
        if (config.optionSelectAllText) this.optionSelectAllText = config.optionSelectAllText;
        if (config.filterBox) this.filterBox = config.filterBox;
        if (config.filterHintText) this.filterHintText = config.filterHintText;
        if (config.filterDateRange) this.filterDateRange = config.filterDateRange;
        if (config.filterDateRangeConfig) this.filterDateRangeConfig = config.filterDateRangeConfig;
        if (config.useExplicitSelectLinks) this.useExplicitSelectLinks = config.useExplicitSelectLinks;
        if (config.noneSelectionText) this.noneSelectionText = config.noneSelectionText;
        if (typeof config.shouldFocusOnMouseEnter !== "undefined") this.shouldFocusOnMouseEnter = config.shouldFocusOnMouseEnter;
    }
    if (this.getName) this.name = this.getName();
    if (this.getMultipleSelect) this.multipleSelect = this.getMultipleSelect();
    // if (this.getDisplayStatus) this.displayStatus = this.getDisplayStatus();
    if (this.getMode) this.mode = this.getMode();
    if (this.mode == SelectBox.MODE_DROPDOWN) {
        this.bind("click", function(event) {
            if (thiz.multipleSelect == false &&
                event.target.tagName &&
                event.target.tagName.toUpperCase() == "INPUT") {
                thiz.onSelectionChanged(true);
                thiz.popupContainer.close();
            }
            if (thiz.multipleSelect == true &&
                event.target.tagName && event.target.tagName.toUpperCase() == "INPUT") {
                var optionAll = Dom.findChild(thiz.optionBox, {eval: function(node) {
                        return (Dom.getAttributeAsString(node, "role") == SelectBox.OPTION_ROLE_HANDLE) && (Dom.getAttributeAsString(node, "handle") == SelectBox.HANDLE_TYPE_SELECTALL)
                    }
                }, true);
                if (event.target === optionAll) {
                    thiz.setAllOptionSelected(optionAll.checked);
                } else if (optionAll) {
                    // event.target.checked
                    var c = thiz.countSelectedOption();
                    optionAll.checked = (c == thiz.options.length);
                }
                thiz._setSelectedStatus();
                thiz.onSelectionChanged(true);
            }
        }, this.optionBox);
    } else {
        this.bind("change", function(event) {
            var target = Dom.getTarget(event);
            if (target && target.tagName && target.tagName.toUpperCase() == "INPUT" && thiz.maximumItemsSelected > 0 && thiz.countSelectedOption() > thiz.maximumItemsSelected) {
                Dom.cancelEvent(event);
                target.checked = false;
                return;
            }
            thiz.onSelectionChanged(true);
        }, this.optionBox);
    }
    this._install();
}

SelectBox.prototype.setItems = function(items) {
    this.data = items;
    if (!this.parseData && typeof this.parseData != "function") {
        console.error("this.parseData is not a function or is undefined");
        return;
    }
    this.options = this._parseData(this.data);
    this._install();
}

SelectBox.prototype.setPopupClass = function (clazz) {
    this.popupContainer.setPopupClass(clazz);
}

SelectBox.prototype._install = function() {
    Dom.addClass(this.optionBox, this.direction == SelectBox.DIRECTION_ROW ? "HBox" : "VBox");
    Dom.addClass(this.node(), this.mode);
    this.optionBox.innerHTML = "";
    
    if(this.filterBox || this.filterDateRange) {
        var container = document.createElement("hbox");
        Dom.addClass(container, "FilterContainer");
        
        if (this.filterBox) {
            var filterBox = this._createFilterBox();
            this.bind("input", this._onKeywordInput.bind(this), filterBox);
            Dom.append(filterBox, container);
        }
        
        if(this.filterDateRange) {
            var filterDateRangeContainer = this._createDateRangeFilterBox();
            Dom.append(filterDateRangeContainer, container);
        }
        
        Dom.append(container, this.optionBox);
        Dom.append(this._createSeperator(), this.optionBox);
    }
    
    if (this.optionSelectAll) {
        Dom.append(this._createOptionSelectAll(), this.optionBox);
        Dom.append(this._createSeperator(), this.optionBox);
    }
    
    for (var i = 0; i < this.options.length; i++) {
        var option = this.options[i];
        if (option.role == SelectBox.OPTION_ROLE_HANDLE) {
            if (option.type == SelectBox.HANDLE_TYPE_SELECTALL) {
                if (this.multipleSelect) {
                    var container = this._createOptionElement(option, "checkbox");
                    if (this.shouldFocusOnMouseEnter) this.bind("mouseenter", this._handleMouseEnter, container);
                    Dom.append(container, this.optionBox);
                }
            } else if (option.type == SelectBox.HANDLE_TYPE_SEPERATOR) {
                Dom.append(this._createSeperator(), this.optionBox);
            }
        } else {
            var container = this._createOptionElement(option, this.multipleSelect ? "checkbox" : "radio");
            if (this.shouldFocusOnMouseEnter) this.bind("mouseenter", this._handleMouseEnter, container);
            Dom.append(container, this.optionBox);
        }
    }
    if (this.mode == SelectBox.MODE_DROPDOWN) {
        var content = this.optionBox;

        if (this.useExplicitSelectLinks) {
            content = document.createElement("vbox");
            content.setAttribute("flex", "1");
            Dom.addClass(content, "SelectBoxContentWrapper");

            content.appendChild(Dom.newDOMElement({
                _name: "hbox",
                "class": "PopupActionHeader",
                _children: [
                    {_name: "span", "class": "Action", _id: "selectAllLink", _text: "Select All"},
                    {_name: "span", "class": "Action", _id: "clearSelectionLink", _text: "Clear"},
                ]
            }, document, this));
            content.appendChild(this.optionBox);

            this.bind("click", function () {
                this.setAllOptionSelected(true);
                this.onSelectionChanged(true);
            }, this.selectAllLink);
            this.bind("click", function () {
                this.setAllOptionSelected(false);
                this.onSelectionChanged(true);
                this.resetFilterBox();
            }, this.clearSelectionLink);
        }
        this.popupContainer.popupContainer.innerHTML = "";
        this.popupContainer.setContentFragment(content);
        this.bind("keypress", this._handleKeyPress.bind(this), content);
        this._setSelectedStatus();
    }
}

SelectBox.prototype.setEnabled = function(enabled) {
    this._enabled = enabled;
    this.statusBox.disabled = !this._enabled;
}

SelectBox.prototype.onSelectionChanged = function(fromUserAction) {
    var selectedValues = this.getValues() || [];
    Dom.emitEvent("p:SelectionChanged", this.node(), {
        fromUserAction: fromUserAction,
        values: selectedValues
    });
    if (this._options && this._options.onSelectionChanged) {
        this._options.onSelectionChanged(fromUserAction);
    }
    if (this.getConfigs) {
        var config = this.getConfigs();
        if (config.checkboxDisplayType == SelectBox.HORIZONTAL_BUTTON) {        
            var inputs = this.optionBox.getElementsByTagName("input");
            if (!inputs || inputs.length == 0) return;
            for (var i = 0; i < inputs.length; i ++) {
                if (inputs[i].checked) {
                    Dom.addClass(inputs[i].parentNode, "Selected");
                } else {
                    Dom.removeClass(inputs[i].parentNode, "Selected");
                }
            }
        }
    }    
}

SelectBox.prototype.setAllOptionSelected = function(selected) {
    var options = Dom.findChildrenByTagName(this.optionBox, "input", true);
    for (var i = 0; i < options.length; i++) {
        options[i].checked = selected;
    }
    this._setSelectedStatus();
}

SelectBox.prototype.resetFilterBox = function() {
    if(this.filterBox) {
        var filterBoxes = Dom.findChildrenWithClass(this.optionBox, "FilterBox", true);
        if(filterBoxes.length > 0) {
            filterBoxes[0].value = "";
        }

        this._filterOptionsWithKeyword("");
    }
}

SelectBox.prototype.isAllOptionSelected = function() {
    var options = this.optionBox.querySelectorAll("input[type=checkbox]");
    var checkedCount = 0;
    var hasSelectAllOption = false;
    for (var i = 0; i < options.length; i++) {
        var opt = options[i];
        var allHandle = Dom.getAttributeAsString(opt, "role") == SelectBox.OPTION_ROLE_HANDLE;
        if (allHandle) {
            hasSelectAllOption = true;
            if (opt.checked) {
                return true;
            }
        }
        if (opt.checked && !allHandle) {
            checkedCount++;
        }
    }
    return options.length > 0 && checkedCount == (options.length - (hasSelectAllOption ? 1 : 0));
}

SelectBox.prototype.countSelectedOption = function() {
    return Dom.findChildren(this.optionBox, {
        eval: function(node) {
            return (node.tagName && node.tagName.toUpperCase() == "INPUT") && (Dom.getAttributeAsString(node, "role") != SelectBox.OPTION_ROLE_HANDLE) && node.checked;
        }
    }, true).length;
}

SelectBox.prototype.getValues = function() {
    if (!this._enabled) return [];
    var options = Dom.getTags("input", this.optionBox);
    var result = [];
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (option.checked == true && (Dom.getAttributeAsString(option, "role") != SelectBox.OPTION_ROLE_HANDLE)) result.push(option.value);
    }
    return result;
}

SelectBox.prototype.getValue = function() {
    if (!this._enabled) return null;
    var options = Dom.getTags("input", this.optionBox);
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (option.checked == true && (Dom.getAttributeAsString(option, "role") != SelectBox.OPTION_ROLE_HANDLE)) return option.value;
    }
    return null;
}

SelectBox.prototype.getSelectedData = function() {
    if (!this._enabled) return [];
    var options = Dom.getTags("input", this.optionBox);
    var result = [];
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (option.checked == true && (Dom.getAttributeAsString(option, "role") != SelectBox.OPTION_ROLE_HANDLE)) result.push(option._data);
    }
    return result;
}

SelectBox.prototype.getSelectedOptionText = function() {
    var options = Dom.getTags("input", this.optionBox);
    var result = [];
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (option.checked == true && (Dom.getAttributeAsString(option, "role") != SelectBox.OPTION_ROLE_HANDLE)) result.push(option.nextSibling.textContent);
    }
    return result;
}

SelectBox.prototype.setValueSelected = function(value, selected) {
    var options = Dom.getTags("input", this.optionBox);
    if (!this.multipleSelect) {
        for (var i in options) {
            options[i].checked = false;
        }
    }
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (option.value == value) {
            option.checked = selected;
            break;
        }
    }
    this._setSelectedStatus();
}

SelectBox.prototype.setValuesSelected = function(values, selected) {
    if (!values || values.length == 0) return;
    var options = Dom.getTags("input", this.optionBox);
    if (!this.multipleSelect) {
        for (var i in options) {
            options[i].checked = false;
        }
    }
    for (var i = 0; i < options.length; i++) {
        var finder = values.filter(function(val) {
            return val == options[i].value;
        });
        if (finder && finder.length > 0) {
            options[i].checked = selected;
        }
    }
    this._setSelectedStatus();
}

SelectBox.prototype.onDetached = function () {
    if (!this.popupContainer) return;

    var thiz = this;
    window.setTimeout(function () {
        if (!document.body.contains(thiz.node())) {
            if (thiz.popupContainer) thiz.popupContainer.kill();
        }
    }, 400);
}

SelectBox.prototype._setSelectedStatus = function() {
    var status = "";
    var selectedText = this.getSelectedOptionText();
    var optionAll = Dom.findChild(this.optionBox, {eval: function(node) {
            return (Dom.getAttributeAsString(node, "role") == SelectBox.OPTION_ROLE_HANDLE) && (Dom.getAttributeAsString(node, "handle") == SelectBox.HANDLE_TYPE_SELECTALL)
        }
    }, true);
    if (this.multipleSelect) {
        if (this.isAllOptionSelected() && optionAll) {
            optionAll.checked = true;
            var optionGroup = Dom.findParentWithClass(optionAll, "OptionContainer");
            var label = Dom.getTag("label", optionGroup);
            status = label.textContent;
        } else if (this.displayStatus == SelectBox.DISPLAY_STATUS_TOTAL) {
            if (optionAll) optionAll.checked = false;
            if (selectedText > 1) status = String.format("{0} items are selected", selectedText.length);
            else status = String.format("{0} item is selected", selectedText.length);
        } else { // this.diplayStatus == SelectBox.DISPLAY_STATUS_JOINTEXT
            if (optionAll) optionAll.checked = false;
            status = (optionAll && optionAll.checked) ? optionAll.nextSibling.textContent : (selectedText.length ? selectedText.join(", ") : this.noneSelectionText);
            this.statusBox.title = status;
        }
    } else {
        status = selectedText.length ? selectedText[0] : this.noneSelectionText;
    }

    this.statusItem.textContent = status;
}

SelectBox.prototype._parseData = function(data) {
    var options = [];
    for (var i = 0; i < data.length; i++) {
        var item = this.parseData(data[i], i);
        item._data = data[i];
        options.push(item);
    }
    return options;
}

SelectBox.prototype._parseOptions = function(domArray) {
    var options = [];
    for (var i = 0; i < domArray.length; i++) {
        var element = domArray[i];
        var opt = {};
        opt.value = element.value;
        opt.text = Dom.getAttributeAsString(element, "text", "");
        opt.checked = Dom.getAttributeAsBoolean(element, "checked", false);
        opt.role = Dom.getAttributeAsString(element, "role", "option");
        opt.type = Dom.getAttributeAsString(element, "type", "");
        opt._data = element;
        options.push(opt);
    }
    return options;
}

SelectBox.prototype._createOptionElement = function(option, type) {
    var container = document.createElement("hbox");
    Dom.addClass(container, "OptionContainer Item");
    var selectItem = document.createElement("input");
    selectItem.type = type;
    selectItem.value = option.value;
    selectItem.checked = option.checked;
    selectItem.id = this.name + "_" + widget.random();
    selectItem.name = this.name;
    selectItem.setAttribute("role", option.role || SelectBox.OPTION_ROLE_OPTION);
    selectItem.setAttribute("handle", option.type || "");
    selectItem._data = option._data;
    var label = document.createElement("label");    
    label.setAttribute("for", selectItem.id);
    if (option._data.extraAttributes && option._data.extraAttributes.icon) {
        var icon = document.createElement("icon");
        Dom.addClass(icon, option._data.extraAttributes.icon);
        var span = document.createElement("span");
        span.textContent = option.text;
        span.title = option.text;
        Dom.append(icon, label);
        Dom.append(span, label);
    } else {
        label.textContent = option.text;
        label.title = option.text;
    }
    if (this.getConfigs) {
        var config = this.getConfigs();
        if (config.checkboxDisplayType == SelectBox.HORIZONTAL_BUTTON && option.checked) {
            Dom.addClass(container, "Selected");
        }
    }    
    Dom.append(selectItem, container);
    Dom.append(label, container);
    if (this.decorator) this.decorator(container, option, selectItem, label);
    return container;
}

SelectBox.prototype._createFilterBox = function() {
    //var container = document.createElement("hbox");
    //Dom.addClass(container, "FilterContainer");
    this.filterTextElementId = this.name + "_" + widget.random();
    var inputItem = Dom.newDOMElement({
        _name: "input",
        type: "text",
        id: this.filterTextElementId,
        placeholder: this.filterHintText,
        class: "FilterBox" + (this.filterDateRange ? " FilterTextBox" : ""),
        role: "handle",
        handle: "filter"
    });
    /*var icon = Dom.newDOMElement({
        _name: "icon",
        class: "magnify"
    })*/
    //Dom.append(inputItem, container);
    //Dom.append(icon, container);

    //return container;
    return inputItem;
}

SelectBox.prototype._createDateRangeFilterBox = function() {
    this.dateRangePicker = new DateTimeRangePicker();
    if(this.filterDateRangeConfig.timezoneProvider) {
        this.dateRangePicker.setCustomTimezoneProvider(this.filterDateRangeConfig.timezoneProvider);
    }
    if(this.filterDateRangeConfig.rangeName) {
        this.dateRangePicker.setRange({name: this.filterDateRangeConfig.rangeName});
    }
    if(this.filterDateRangeConfig.useEndOfDay) {
        this.dateRangePicker.setUseToDateEOD(this.filterDateRangeConfig.useEndOfDay);
    }
    
    Dom.addClass(this.dateRangePicker.node(), "FilterDateRange");
    
    return this.dateRangePicker.node();
}

SelectBox.prototype._createOptionSelectAll = function() {
    var container = document.createElement("hbox");
    Dom.addClass(container, "OptionContainer Item");
    var selectItem = document.createElement("input");
    selectItem.type = "checkbox";
    selectItem.value = "";
    selectItem.checked = false;
    selectItem.id = this.name + "_" + widget.random();
    selectItem.name = this.name;
    selectItem.setAttribute("role", SelectBox.OPTION_ROLE_HANDLE);
    selectItem.setAttribute("handle", SelectBox.HANDLE_TYPE_SELECTALL);
    var label = document.createElement("label");
    label.textContent = this.optionSelectAllText || "Select All";
    label.setAttribute("for", selectItem.id);
    label.setAttribute("flex", 1);
    Dom.append(selectItem, container);
    Dom.append(label, container);
    return container;
}

SelectBox.prototype._createSeperator = function() {
    var hr = Dom.newDOMElement({
        _name: "hr",
        class: (this.filterDateRange ? "FilterDateRangeBox" : ""),
        disabled: true
    });
    return hr;
}

SelectBox.prototype._findByData = function(node, keyword) {
    return this.filter(node._data, keyword);
}

SelectBox.prototype._findByOptionText = function(node, keyword) {
    if (keyword) keyword = keyword.toLowerCase();
    var label = Dom.getTag("label", node);
    return label.textContent.toLowerCase().indexOf(keyword);
}

SelectBox.prototype._onKeywordInput = function(event) {
    var keyword = event.target.value.trim();
    this._filterOptionsWithKeyword(keyword);
}

SelectBox.prototype._filterOptionsWithKeyword = function(keyword) {
    var options = Dom.findChildrenWithClass(this.optionBox, "OptionContainer", false);
    for (var i = 0; i < options.length; i++) {
        var option = options[i];
        if (Dom.getAttributeAsString(option, "role") != SelectBox.OPTION_ROLE_HANDLE) {
            if (this.filter) {
                if (!this._findByData(option, keyword)) Dom.addClass(option, "Hidden");
            } else if (this._findByOptionText(option, keyword) == -1) {
                Dom.addClass(option, "Hidden");
            } else {
                Dom.removeClass(option, "Hidden");
            }
        }
    }
    
    //Display scrollbar when clear filter keyword
    if (this.filterDateRange && this.popupContainer.isVisible()) {
        var thiz = this;
        clearTimeout(this._filterTimer);
        this._filterTimer = setTimeout(function() {
            //thiz.popupContainer.show(thiz.statusBox, "left-inside", "bottom", 0, 5, "autoFlip");
            thiz.popupContainer.invalidatePosition();
            setTimeout(function() {
                thiz._focusElement(Dom.findFirstChildWithClass(thiz.optionBox, "OptionContainer"));
                document.getElementById(thiz.filterTextElementId).focus();
            }, 20);
        }, 800);
    }
}

SelectBox.prototype._handleMouseEnter = function(event) {
    var node = event.target;
    var currentFocus = Dom.findChildWithClass(parent, "Focus");
    if (node != currentFocus) {
        this._focusElement(node);
    }
};

SelectBox.prototype.focus = function () {
    this.statusBox.focus();
};

SelectBox.prototype._handleKeyPress = function(event) {
    var currentFocus = Dom.findChildWithClass(this.optionBox, "Focus");
    switch (event.keyCode) {
        case DOM_VK_SPACE:
        case 0:
            // var element = Dom.getTag("input", currentFocus);
            // element.checked = !element.checked;
        break;
        case DOM_VK_UP:
            var nextFocus = currentFocus ? currentFocus.previousSibling : Dom.findFirstChildWithClass(this.optionBox, "OptionContainer");
            if (nextFocus) {
                Dom.cancelEvent(event);
                this._focusElement(nextFocus);
            }
        break;
        case DOM_VK_DOWN:
            var nextFocus = currentFocus ? currentFocus.nextSibling : Dom.findFirstChildWithClass(this.optionBox, "OptionContainer");
            if (nextFocus) {
                Dom.cancelEvent(event);
                this._focusElement(nextFocus);
            }
        break;
        default:
        break;
    }
}

SelectBox.prototype._focusElement = function(element) {
    var currentFocus = Dom.findChildWithClass(this.optionBox, "Focus");
    if (currentFocus) {
        Dom.removeClass(currentFocus, "Focus");
    }
    Dom.addClass(element, "Focus");
    Dom.getTag("input", element).focus();
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/BoldDialog.js";

function BoldDialog() {
    Dialog.call(this);
    this.bannerImageUrl = "/cms/admin/data/bold-dialog-default.jpg";
}
__extend(Dialog, BoldDialog);

BoldDialog.prototype.getDialogOverlayExtraClass = function () {
    return "BoldDialogOverlay";
};

BoldDialog.prototype.getFrameTemplate = function () {
    return BoldDialog.prototype.__pathPrefix + "BoldDialog.xhtml";
};
BoldDialog.prototype.getBannerImageUrl = function () {
    return this.bannerImageUrl;
};
BoldDialog.prototype.invalidateElements = function () {
    Dialog.prototype.invalidateElements.call(this);
    
    this.titleImage.src = this.getBannerImageUrl();
};
BoldDialog.prototype.getFrameOverflowStyle = function () {
    return "hidden";
};

if (window) window.__currentScriptPath = "/framework/webui/framework/js/dialog/IFrameContentDialog.js";

function IFrameContentDialog(options) {
    this.grabHeight = true;
    Dialog.call(this);
    this.options = options || {};
    this.title = this.options.title || "";
    Dom.addClass(this.dialogFrame, "IFrameContentDialog " + (this.options.extraClass ? this.options.extraClass : ""));
}
__extend(Dialog, IFrameContentDialog);

IFrameContentDialog.open = function(event) {
    var link = IFrameContentDialog.getLinkProperties(event);
    if (!link || !link.src || link.target != "_blank") return;
    Dom.cancelEvent(event);
    new IFrameContentDialog(link).open();
};

IFrameContentDialog.getLinkProperties = function(event) {
    var target = Dom.getTarget(event);
    if (!target || target.tagName.toUpperCase() != "A") return null;
    var src = Dom.getAttributeAsString(target, "href", "");
    var targetMode = Dom.getAttributeAsString(target, "target", "");
    if (!src || src.length == 0) return {src: ""};
    var title = Dom.getAttributeAsString(target, "title", "");
    return {src: src, title: title, target: targetMode};
};

IFrameContentDialog.prototype.setup = function() {
    var thiz = this;
    this.indicator = new Spinner("Loading...");
    this.indicator.busy();
    this.bind("load", function () {
        thiz.indicator.done();
    }, this.iframe);
    var src = this.options.src || "";
    this.iframe.src = src;
}
IFrameContentDialog.prototype.onHide = function() {
    if (this.indicator) this.indicator.done();
}
IFrameContentDialog.prototype.getDialogActions = function() {
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }
    ]
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/FileUploadAudioPreviewer.js";

function FileUploadAudioPreviewer() {
    BaseTemplatedWidget.call(this);

}
__extend(BaseTemplatedWidget, FileUploadAudioPreviewer);


FileUploadAudioPreviewer.prototype.setFileInfo = function (fileInfo) {
    this.fileInfo = fileInfo;
    if (this.fileInfo.url) {
        this.audio.setAttribute("src", this.fileInfo.url);
    } else if (this.fileInfo.file) {
        var reader = new FileReader();
        var thiz = this;
        reader.onload = function (e) {
            thiz.audio.setAttribute("src", e.target.result);
        };
        reader.readAsDataURL(this.fileInfo.file);
    }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/FileUploadDefaultPreviewer.js";

function FileUploadDefaultPreviewer() {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, FileUploadDefaultPreviewer);


FileUploadDefaultPreviewer.prototype.setFileInfo = function (fileInfo) {
    this.fileInfo = fileInfo;
    var image = fileInfo.contentType.match(/^image\/.*$/);
    var video = (fileInfo.contentType.match(/^video\/.*$/) && fileInfo.url && fileInfo.url.length > 0 && fileInfo.id && fileInfo.id.length > 0);
    if (image || video) {
        if (video) {
            Dom.addClass(this.node(), "Video");
        } else {
            Dom.removeClass(this.node(), "Video");
        }
        this.setupImageView();
    } else {
        Dom.removeClass(this.node(), "Video");
        this.setupRegularFileView();
    }
};

FileUploadDefaultPreviewer.prototype.setupImageView = function () {
    Dom.addClass(this.node(), "UseImage");

    if (typeof(this.fileInfo.centerCrop) != void 0) this.imageView.setCenterCrop(this.fileInfo.centerCrop);
    if (typeof(this.fileInfo.notUpscale) != void 0) this.imageView.setNotUpscale(this.fileInfo.notUpscale);

    if (this.fileInfo.url || this.fileInfo.storageLocation) {
        var actualURL = this.fileInfo.url || this.fileInfo.storageLocation;
        if (this.forceCacheInvalidation) {
            actualURL += (actualURL.indexOf("?") > 0 ? "&" : "?") + "__ptoken=" + (new Date().getTime());
        }
        this.imageView.setUrl(actualURL, this.fileInfo.fallbackUrl || "/v2/images/video-not-found.png");
    } else if (this.fileInfo.file) {
        var reader = new FileReader();
        var thiz = this;
        reader.onload = function (e) {
            thiz.imageView.setUrl(e.target.result);
        };
        reader.readAsDataURL(this.fileInfo.file);
    }
};
FileUploadDefaultPreviewer.prototype.setupRegularFileView = function () {
    Dom.removeClass(this.node(), "UseImage");
    Dom.setInnerText(this.fileName, this.fileInfo.name);
    Dom.setInnerText(this.fileType, "Type: " + this.fileInfo.contentType);
    this.fileIcon.setAttribute("class", "file");
};
FileUploadDefaultPreviewer.prototype.getImageSize = function () {
    return this.imageView.getImageSize();
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/FileUploadView.js";

function FileUploadView(node) {
    BaseTemplatedWidget.call(this);

    this.maxFiles = Dom.getAttributeAsInt(node, "max", 5);
    this.showSize = Dom.getAttributeAsBoolean(node, "show-size", true) && this.maxFiles == 1;
    this.maxSize = Dom.getAttributeAsString(node, "max-size", "MED");
    var maxSizeInMB = Dom.getAttributeAsInt(node, "max-file-size", -1);
    this.maxFileSize = maxSizeInMB * 1024 * 1024;
    this.keepOriginal = Dom.getAttributeAsBoolean(node, "keep-original", false);
    this.doResize = Dom.getAttributeAsBoolean(node, "do-resize", true);
    this.forceCacheInvalidation = Dom.getAttributeAsBoolean(node, "force-no-cache", false);
    this.isAutoSetupOrdering = Dom.getAttributeAsBoolean(node, "auto-setup-ordering", true);

    this.acceptedExtensions = Dom.getAttributeAsString(node, "accept", "").toLowerCase().split(",");
    this.previewerConfig = {
        name: window[Dom.getAttributeAsString(node, "previewer", "FileUploadDefaultPreviewer")],
        image : {
            centerCrop: true,
            notUpscale: true
        }
    };
    this.directUploadMode = Dom.getAttributeAsBoolean(node, "direct-upload-mode", true);
    var thiz = this;

    this.bind("drop", this.handleDrop);
    this.bind("dragover", this.handleDragOver);
    this.bind("dragend", this.handleDragEnd);

    this.bind("contextmenu", function (event) {event.preventDefault()});

    if (this.showSize) {
        this.bind("p:ImageSizeAvailable", function () {
            var size = this.getFirstImageSize();
            var text = "" + size.w + " x " + size.h;
            this.sizeText.innerHTML = text;
            this.sizeText.setAttribute("title", "Actual image size: " + text + " pixels.");
        });
        Dom.addClass(this.node(), "WithSizeInfo");
    } else {
        this.sizeText.innerHTML = "";
        this.sizeText.setAttribute("title", "");
    }

    if (!window.Clipboard) {
        this.pasteReceiver = this.node().ownerDocument.createElement("div");
        this.pasteReceiver.setAttribute("style", "position: absolute; top: 0px; left: 0px; width: 1px; height: 1px; opacity: 0; color: transparent; overflow: hidden;");
        this.pasteReceiver.setAttribute("contenteditable", "true");

        this.node().appendChild(this.pasteReceiver);

        this.pasteReceiver.addEventListener("focus", function () {
            Dom.addClass(thiz.node(), "PasteReceiverFocused");
        }, false);
        this.pasteReceiver.addEventListener("blur", function () {
            Dom.removeClass(thiz.node(), "PasteReceiverFocused");
        }, false);

        this.bind("focus", function() {
            this.pasteReceiver.innerHTML = "";
            this.pasteReceiver.focus();
        });

        this.pasteReceiver.addEventListener("paste", function (event) {
            window.setTimeout(function () {
                try {
                    var images = thiz.pasteReceiver.getElementsByTagName("img");
                    if (images && images.length > 0) {
                        var image = images[0];
                        var src = image.src;
                        if (src.substring(0, 5) != "data:") return;

                        var blob = Util.dataURIToBlob(src);
                        var name = "PastedImage" + Math.round(Math.random() * 1000000);
                        name += "." + (FileUploadView.MIME_REVERSED_MAP[blob.type] || "dat");
                        blob.name = name;

                        var added = thiz.addFile(blob, src);
                        if (added) {
                            thiz.invalidateStatus();
                            thiz.fireFileModified();
                        }
                    }
                } finally {
                    thiz.pasteReceiver.innerHTML = "";
                }
            }, 10);
        }, false);
    }

    this.bind("dragenter", function (e) {
        try {
            if (this.isFileDragging(e) && this.fileInfoList.length < this.maxFiles) {
                Dom.addClass(this.node(), "DragOver");
            }
            if (this.node().contains(e.target)) this.lastChildEnter = (new Date().getTime());

        } catch (e) {
            console.error(e);
        }
    });

    this.bind("dragleave", function (e) {
        try {
            if (this.lastChildEnter) {
                var delta = (new Date().getTime()) - this.lastChildEnter;
                if (delta < 50) return;
            }
            Dom.removeClass(this.node(), "DragOver");
        } catch (e) {
            console.error(e);
        }
    });

    this.bind("click", function (ev) {
        this.doSelectFile(ev);
    }, this.messagePane);

    this.bind("click", function (ev) {
        this.doSelectFile(ev);
    }, this.addMoreButton);

    this.bind("change", function () {
        var files = this.fileInput.files;
        if (!files) return;
        var added = false;
        for (var i = 0; i < files.length; i ++) {
            var ok = this.addFile(files[i]);
            if (ok) {
                added = true;
            }
        }
        if (added) {
            this.invalidateStatus();
            this.fireFileModified();
        }
    }, this.fileInput);

    this.bind("click", function (event) {
        console.log("Click: ", event);

        var fileInfoWrapper = Dom.findUpwardForNodeWithData(event.target, "_fileInfo");
        console.log("Click: ", fileInfoWrapper);
        if (!fileInfoWrapper) return;

        var fileInfo = fileInfoWrapper._fileInfo;
        var isPlay = Dom.findUpwardForData(event.target, "_isPlayIcon");
        if (isPlay) {
            var video = (fileInfo.contentType.match(/^video\/.*$/) && fileInfo.id && fileInfo.id.length > 0);
            if (!video) return;
            new VideoDialog({title: "Video Preview", id: fileInfo.id, autoPlay: true}).open();
            return;
        }
        var isDelete = Dom.findUpwardForData(event.target, "_isDeleteIcon");
        if (!isDelete) return;
        Dialog.confirm("Are you sure you want to remove this item?", "", "Remove", function () {
            fileInfoWrapper.parentNode.removeChild(fileInfoWrapper);
            this.rebuildFileInfoList();
            this.invalidateStatus();
            this.fireFileModified();
        }.bind(this), "Cancel");
    }.bind(this), this.PreviewWrapper);


    if (this.isAutoSetupOrdering) this.setupReordering();

    this.fileInfoList = [];
    this.externalFiles = [];
    this.externalFilesMap = {};
    this.invalidateStatus();

}
__extend(BaseTemplatedWidget, FileUploadView);

FileUploadView.MIME_FILE_INFO = "text/plain";
FileUploadView.UUID_PREFIX = "fileinfo:";
FileUploadView.MIME_MAP = {
    "png": "image/png",
    "jpg": "image/jpeg",
    "jpeg": "image/jpeg",
    "gif": "image/gif"
};
FileUploadView.MIME_REVERSED_MAP = {
    "image/png": "png",
    "image/jpeg": "jpg",
    "image/gif": "gif"
};
FileUploadView.prototype.setFilePicker = function(filePicker) {
    this.filePicker = filePicker;
}
FileUploadView.prototype.addExternalFiles = function(files) {
    var changed = false;
    for (var index in files) {
        var file = files[index];
        var id = file.wistia_id ? (file.wistia_id.value || "") : "";
        if (this.externalFilesMap["" + id] || id.length <= 0) {
            console.log("Has selected ", file);
            continue;
        }
        var fileInfo = {
            file: null,
            contentType: "video/mp4",
            size: 0,
            name: "",
            url: file.thumbnail ? (file.thumbnail.value || "") : "",
            id: file.wistia_id ? (file.wistia_id.value || "") : "",
            storageLocation: "",
            uuid: file.id
        };
        this.externalFiles.push(fileInfo);
        this.externalFilesMap[id] = fileInfo;

        this.addFileInfo(fileInfo, "false");

        changed = true;
    }
    if (changed) {
        this.invalidateStatus();
        this.fireFileModified();
    }

}
FileUploadView.prototype.getExternalFiles = function() {
    return this.externalFiles;
}
FileUploadView.prototype.doSelectFile = function(event) {
    var thiz = this;
    if (this.filePicker == null || typeof(this.filePicker) == "undefined") {
        this.fileInput.click();
    } else {
        if (this.selectFileMenu) {
            this.selectFileMenu.close();
        }
        this.selectFileMenu = new Menu();
        this.selectFileMenu.setPopupClass("FileSelectPopupMenu");
        this.selectFileMenu.register({
            icon: "upload",
            label: "File From Your Device...",
            isAvailable: function () {
                return true;
            },
            run: function () {
                thiz.fileInput.click();
            }
        });
        this.selectFileMenu.register({
            icon: thiz.filePicker.icon || "cloud",
            label: thiz.filePicker.title || "File From Your Library...",
            isAvailable: function () {
                return true;
            },
            run: function () {
                thiz.filePicker.pick(function(files){
                    if (!files || files.length == 0) return;
                    thiz.addExternalFiles(files);
                });
            }
        });
        this.selectFileMenu.showMenu(this.node(), "center", "top-inside", 0, window.top != window ? (-(event.clientY - window.top.scrollTop)) : 0, "auto-flip");
    }
}

FileUploadView.prototype.setContentFragment = function (fragment) {
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node || node.nodeType != Node.ELEMENT_NODE) continue;

        var role = node.getAttribute("role") || node.localName;
        if (role == "empty-message") {
            this.messagePane.innerHTML = "";
            this.messagePane.appendChild(node);
        } else if (role == "add-more-button-text") {
            this.addMoreText.innerHTML = "";
            this.addMoreText.appendChild(node);
        } else if (role == "add-more-message") {
            this.addMoreMessageText.innerHTML = "";
            this.addMoreMessageText.appendChild(node);
        } else if (role == "limit-reached-message") {
            this.limitReachedMessageText.innerHTML = "";
            this.limitReachedMessageText.appendChild(node);
        } else if (role == "previewer") {
            this.setupPreviewer(node);
        }
    }
};
FileUploadView.prototype.setupPreviewer = function (element) {
    var val = element.getAttribute("name");
    if (val && val.length > 0) this.previewerConfig.name = window[val];

    for (var i = 0; i < element.childNodes.length; i ++) {
        var node = element.childNodes[i];
        if (!node || node.nodeType != Node.ELEMENT_NODE) continue;

        var role = node.getAttribute("role") || node.localName;
        if (role == "img") {
            val = node.getAttribute("centerCrop");
            if (val == "false") this.previewerConfig.image.centerCrop = false;
            val = node.getAttribute("notUpscale");
            if (val == "false") this.previewerConfig.image.notUpscale = false;
        }
    }
};
FileUploadView.prototype.setupReordering = function () {
    if (this.maxFiles <= 1) return;

    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER("horizontal");
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            target.mode = DragAndDropManager.DROP_PREV_SIBLING;
            target.element = this.addMoreButton;
        }

        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
                .source(this.previewContainer)
                .anchor(function (node) {
                    if (Dom.findUpwardForData(node, "_isDeleteIcon")) throw "Stop dragging when clicking on delete";
                    if (Dom.findUpwardForData(node, "_isPlayIcon")) throw "Stop dragging when clicking on play";
                    return node._fileInfo && Dom.hasClass(node, "PreviewWrapper");
                })
                .itemInfo(function (previewAnchor) {
                    return {
                        element: previewAnchor,
                        data: previewAnchor._fileInfo
                    };
                })
                .destination(this.previewContainer)
                .canDrop(function (data) {
                    return this.isFileInfoAccepted(data) && this.isFileSizeAccepted(data);
                }.bind(this))
                .dropAt(dropTargetFinderFunction)
                .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "FileUploadViewDragImage"
        });

        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";

        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }

        this.rebuildFileInfoList();
    }.bind(this);
};
FileUploadView.prototype.rebuildFileInfoList = function () {
    this.fileInfoList = [];
    this.externalFiles = [];
    this.externalFilesMap = [];
    for (var i = 0; i < this.previewContainer.childNodes.length; i ++) {
        var child = this.previewContainer.childNodes[i];
        if (child._fileInfo) {
            if (child._fileInfo.id && !child._fileInfo.file) {
                this.externalFiles.push(child._fileInfo);
                this.externalFilesMap[child._fileInfo.id] = child._fileInfo;
            } else {
                this.fileInfoList.push(child._fileInfo);
            }
        }
    }
};
FileUploadView.prototype.getPreviewerList = function () {
    var previewerList = [];
    for (var i = 0; i < this.previewContainer.childNodes.length; i ++) {
        var child = this.previewContainer.childNodes[i];
        if (child._fileInfo && child._previewer) previewerList.push(child._previewer);
    }

    return previewerList;
};
FileUploadView.prototype.getFirstImageSize = function () {
    var previewer = this.getPreviewerList()[0];
    if (!previewer) return null;

    if (!previewer.getImageSize) throw "Previewer does not support getImageSize()";
    return previewer.getImageSize();
};

FileUploadView.prototype.getCommaSeparatedStoragePaths = function () {
    var paths = [];
    for (var i = 0; i < this.fileInfoList.length; i ++) {
        var fileInfo = this.fileInfoList[i];
        if (fileInfo.storageLocation) paths.push(fileInfo.storageLocation);
    }

    return paths.join(",");
};
FileUploadView.prototype.setCommaSeparatedStoragePaths = function (paths) {
    var pathList = paths ? paths.split(",") : [];
    this.fileInfoList = [];
    while (this.previewContainer.firstChild && this.previewContainer.firstChild != this.addMoreButton) {
        this.previewContainer.removeChild(this.previewContainer.firstChild);
    }
    for (var i = 0; i < pathList.length; i ++) {
        var path = pathList[i];

        if (!path.match(/^.*\/([^\/]+\.([a-z0-9]+))(#[a-z_]+)?$/)) continue;
        var mime = FileUploadView.MIME_MAP[RegExp.$2] || "image/unknown";

        var fileInfo = {
            file: null,
            contentType: mime,
            size: 1,
            name: RegExp.$1,
            url: path,
            id: null,
            storageLocation: path,
            uuid: FileUploadView.UUID_PREFIX + Util.newUUID()
        };
        if (!this.isFileInfoAccepted(fileInfo)) continue;
        if (!this.isFileSizeAccepted(fileInfo)) continue;

        this.addFileInfo(fileInfo);
    }

    this.invalidateStatus();
};
FileUploadView.prototype.onAttached = function () {
    if (!FileUploadView._preventDefaultInstalled) {
        document.body.addEventListener("dragover", function (event) {
            event.preventDefault();
        }, false);
        document.body.addEventListener("drop", function (event) {
            event.preventDefault();
        }, false);

        FileUploadView._preventDefaultInstalled = true;
    }
};

FileUploadView.prototype.findFileInfo = function (uuid) {
    for (var i = 0; i < this.fileInfoList.length; i ++) {
        var fileInfo = this.fileInfoList[i];
        if (fileInfo.uuid == uuid) return fileInfo;
    }

    return null;
};
FileUploadView.prototype.handleDrop = function (event) {
    try {
        this.handleDropImpl(event);
    } catch (e) {
        console.error(e);
    }
};
FileUploadView.prototype.handleDropImpl = function (event) {
    Dom.removeClass(this.node(), "DragOver");
    event.preventDefault();
    var files = null;

    if (event.dataTransfer.items) {
        files = [];
        for (var i = 0; i < event.dataTransfer.items.length; i ++) {
            if (event.dataTransfer.items[i].kind == "file") {
                files.push(event.dataTransfer.items[i].getAsFile());
            }
        }
    } else if (event.dataTransfer.files) {
        files = event.dataTransfer.files;
    }

    if (!files) return;
    var added = false;
    for (var i = 0; i < files.length; i ++) {
        var ok = this.addFile(files[i]);
        if (ok) {
            added = true;
        }
    }
    if (added) {
        this.fireFileModified();
        this.invalidateStatus();
    }
};
FileUploadView.prototype.invalidateStatus = function () {
    Dom.toggleClass(this.node(), "HasFiles", this.fileInfoList.length > 0 || this.externalFiles.length > 0);
    Dom.toggleClass(this.node(), "LimitReached", this.fileInfoList.length >= this.maxFiles);
};
FileUploadView.prototype.isFileDragging = function (event) {
    var dt = event.dataTransfer;
    if (!dt) return false;

    if (dt.files) {
        if (dt.files.length > 0) return true;
    }

    if (dt.items) {
        if (dt.items.length > 0 && dt.items[0].kind == "file") return true;
    }

    return false;
}
FileUploadView.prototype.handleDragOver = function (event) {
    try {
        if (this.isFileDragging(event) && this.fileInfoList.length < this.maxFiles) {
            Dom.addClass(this.node(), "DragOver");
        }
    } catch (e) {
        console.error(e);
    }
};
FileUploadView.prototype.handleDragEnd = function (event) {
};
FileUploadView.prototype.isFileInfoAccepted = function (fileInfo) {
    if (fileInfo.id && fileInfo.id.length > 0 && !fileInfo.file) return true;

    if (!fileInfo.name || !fileInfo.name.match(/.*\.([a-z0-9]+)$/i)) return false;
    if (this.acceptedExtensions.indexOf("*") >= 0) return true;
    var ext = ("" + RegExp.$1).toLowerCase();
    if (this.acceptedExtensions.indexOf(ext) < 0) return false;

    return true;
};

FileUploadView.prototype.isFileSizeAccepted = function (fileInfo) {
    if (fileInfo.id && fileInfo.id.length > 0 && !fileInfo.file) return true;
    if (this.maxFileSize < 0) return true;
    return fileInfo && fileInfo.size <= this.maxFileSize && this.maxFileSize > 0;
};

FileUploadView.prototype.addFile = function (file, dataURL) {
    if (this.fileInfoList.length >= this.maxFiles) return false;

    var fileInfo = {
        file: file,
        contentType: file.type,
        size: file.size,
        name: file.name,
        url: dataURL ? dataURL : null,
        id: null,
        uuid: FileUploadView.UUID_PREFIX + Util.newUUID()
    };
    if (!this.isFileInfoAccepted(fileInfo)) {
        Dialog.error("Only " +  this.acceptedExtensions.join(", ").toUpperCase() + " are allowed.");
        return false;
    }
    if (!this.isFileSizeAccepted(fileInfo)) {
        var msg = "You have exceed the file upload limit of " +  Math.round(this.maxFileSize / (1024 * 1024)) + "MB.";
        Dialog.error(msg);
        return false;
    }
    this.addFileInfo(fileInfo);
    return true;
};
FileUploadView.prototype.addFileInfo = function (fileInfo, push) {
    var views = {};
    var wrapper = Dom.newDOMElement({
        _name: "hbox",
        "class": "PreviewWrapper",
        draggable: true,
        _children: [
            {_name: "hbox", _id: "_previewerHolder", flex: "1", "class": "Holder", draggable: true},
            {
                _name: "vbox", _id: "_progressPane", "class": "ProgressPane",
                _children: [
                    {_name: "span", _id: "_progressDisplay", "class": "ProgressDisplay"},
                    {
                        _name: "hbox", _id: "_progressTotal",
                        "class": "ProgressTotal",
                        _children: [
                            {_name: "div", _id: "_progressUploaded", "class": "ProgressUploaded"}
                        ]
                    },
                ]
            },
            {_name: "icon", _id: "_deleteIcon", "class": "close-circle RemoveItem"},
            {_name: "vbox", _id: "_playBox", "class": "PlayBox", _children: fileInfo.id && fileInfo.id.length > 0 ? [
                {_name: "icon", _id: "_playButton", "class": "play PlayButton"}
            ] : []}
        ]
    }, document, views);
    wrapper._views = views;
    views._deleteIcon._isDeleteIcon = true;
    if (views._playButton) {
        views._playButton._isPlayIcon = true;
    }
    this.previewContainer.insertBefore(wrapper, this.addMoreButton);

    if (fileInfo.centerCrop === void 0) {
        fileInfo.centerCrop = this.previewerConfig.image.centerCrop;
    }
    if (fileInfo.notUpscale === void 0) {
        fileInfo.notUpscale = this.previewerConfig.image.notUpscale;
    }

    var clazz = this.previewerConfig.name;
    var previewer = new clazz().into(wrapper._views._previewerHolder);
    previewer.forceCacheInvalidation = this.forceCacheInvalidation ? true : false;
    previewer.setFileInfo(fileInfo);
    wrapper._fileInfo = fileInfo;
    wrapper._previewer = previewer;

    if (typeof(push) == "undefined") {
        this.fileInfoList.push(fileInfo);
    }
    var thiz = this;

    if (fileInfo.file) {
        Dom.setInnerText(wrapper._views._progressDisplay, "Waiting...");
        wrapper._views._progressUploaded.style.width = "0%";

        Dom.addClass(wrapper, "Uploading");
        var callback = function (result) {
            Dom.removeClass(wrapper, "Uploading");
            fileInfo.storageLocation = result.storageLocation;
            previewer.imageView.setUrl(fileInfo.storageLocation);
            fileInfo._resource = result;
            //TODO: mark fileInfo as uploaded
            thiz.fireFileModified();
        };
        callback._uploadProgressed = function (uploaded, total) {
            var percent = Math.round(100 * uploaded / total) + "%";
            Dom.setInnerText(wrapper._views._progressDisplay, percent);
            wrapper._views._progressUploaded.style.width = percent;
        };

        if (!this.directUploadMode)  {
            callback._uploadProgressed(100, 100);
            callback({storageLocation: fileInfo.storageLocation});
            return;
        }
        $teamResourceManager.uploadResource(fileInfo.file, {
            dataUUID: this.dataUUID,
            dataType: this.dataType || "sample",
            description: this.dataDescription || "Description of the resource",
            title: fileInfo.name,
            maxSize: this.maxSize || "MED",
            keepOriginal: this.keepOriginal ? true : false,
            doResize: this.doResize ? true : false
        }, callback);
    }

    return previewer;
};

FileUploadView.FILE_CHANGE_EVENT_NAME = "p:FileModified";
FileUploadView.prototype.fireFileModified = function () {
    Dom.emitEvent(FileUploadView.FILE_CHANGE_EVENT_NAME, this.node());
};

FileUploadView.prototype.getSelectedLocalFiles = function () {
    var files = [];
    this.fileInfoList.forEach(function (fi) {
        if (fi.file) files.push(fi.file);
    });

    return files;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/HintBox.js";

function HintBox(node) {
    BaseTemplatedWidget.call(this);
    var doneHandler = function() {
        this._assertLocalStorage();
        window.localStorage.setItem(this.key, Date.now());
        this._removeMe();
        this.done();
    };
    this.bind("click", doneHandler, this.doneButton);
    this.key = node.getAttribute("hintKey") || "";
    if (this.key.length) this.key = "_-_#tu_@storage_cms_hint_-_" + this.key;
}
__extend(BaseTemplatedWidget, HintBox);

HintBox.prototype.setContentFragment = function(fragment) {
    if (this.hasAlreadyShown()) {
        this._removeMe();
        return;
    }

    var node = Dom.findChildTag(fragment, "label") || fragment;
    this.message.appendChild(node);

    node = Dom.findChildTag(fragment, "button");
    var text = (node && node.textContent) || "Got it!";
    this.doneLabel.textContent = text;
};
HintBox.prototype.getMessage = function() {
    return Dom.getInnerText(this.message);
}
HintBox.prototype.setMessage = function(text) {
    this.message.innerHTML = text;
}
HintBox.prototype._assertLocalStorage = function() {
    if (!window.localStorage) throw "Local Storage is not supported!";
};

HintBox.prototype._removeMe = function() {
    this.node().parentNode.removeChild(this.node());
};

HintBox.prototype.hasAlreadyShown = function() {
    this._assertLocalStorage();
    return !!window.localStorage.getItem(this.key);
};

HintBox.prototype.done = function() {
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/BaseAngularControllerWidget.js";

function BaseAngularControllerWidget(node) {
    BaseTemplatedWidget.call(this);
    if (this._decorateAppContainer) this._decorateAppContainer(this.ngAppContainer);
    this.ngAppContainer._ngWrapperInstance = this;

    this._namePrefix = "ngwrapper_" + this.constructor.name + "_";

    this._dynamicModuleName = this._namePrefix + "NGModule";
    this._dynamicControllerName = "ngwrapper" + this.constructor.name + "NGController";
    if (!this._lazyInit) this._init();
}
__extend(BaseTemplatedWidget, BaseAngularControllerWidget);

BaseAngularControllerWidget._initializedModules = {};
BaseAngularControllerWidget._loadedNGPacks = {};

BaseAngularControllerWidget._ensureNGPackLoaded = function (ns, callback) {
    if (BaseAngularControllerWidget._loadedNGPacks[ns]) {
        callback();
        return;
    }

    window.defaultIndicator.busy("Loading...");
    var devTag = window.IS_DEV_MODE ? ("&token=" + new Date().getTime()) : "";
    var params = "?lang=" + ((LOCALE.language || "").replace("-", "_")) + "&b=" + BUILD_ID + devTag;
    widget.__loadScript("/" + ns + "-js.pack.js" + params, function () {
        widget.__loadStylesheet("/" + ns + "-style.pack.css" + params, function () {
            window.defaultIndicator.done();
            BaseAngularControllerWidget._loadedNGPacks[ns] = true;
            callback();
        });
    });
}
BaseAngularControllerWidget.prototype._init = function (callback) {
    var bundles = this._requiredNGPackNames || [];
    var index = -1;
    var thiz = this;
    function next() {
        index ++;
        if (index >= bundles.length) {
            thiz._loadExternalResources(callback);
            return;
        }

        BaseAngularControllerWidget._ensureNGPackLoaded(bundles[index], next);
    }

    next();
};
BaseAngularControllerWidget.prototype._loadExternalResources = function (callback) {
    var urls = this._requiredExternalURLs || [];
    var index = -1;
    var thiz = this;
    function next() {
        index ++;
        if (index >= urls.length) {
            thiz._initAfterLoading(callback);
            return;
        }
        var url = urls[index];
        var type = url.indexOf(".js") > 0 ? "js" : "css";
        widget.__ensureExternalResourceLoaded(url, type, next);
    }

    next();
};
BaseAngularControllerWidget.prototype._handleControllerLoad = function (callback) {
    this._enhanceScopeAndTemplate();
    var template = this.buildDirectiveTemplate();
    var content = angular.element(template);
    this.$compile(content)(this.$scope);
    var e = content[0];
    this.ngAppContainer.appendChild(e);

    if (callback) callback();
};
BaseAngularControllerWidget.prototype._enhanceScopeAndTemplate = function() {
    if (this._enhanceScope)  {
        this._enhanceScope(this.$rootScope, this.$scope);
    }
    if (this._enhanceTemplateCache) {
        this._enhanceTemplateCache(this.$templateCache);
    }
}
BaseAngularControllerWidget.prototype._fireInstanceLoaded = function(callback) {
    var instance = Dom.findUpwardForData(this.$element[0], "_ngWrapperInstance");
    if (!instance) {
        return;
    }
    instance._handleControllerLoad(function () {
        if (callback) callback();
    });
}
BaseAngularControllerWidget.prototype.extraElements = function(){
    return ["$templateCache"];
}
BaseAngularControllerWidget.prototype._initAfterLoading = function (callback) {
    var objects = ["$scope", "$rootScope", "$filter", "$timeout", "$compile",  "$element" , "$document", "$interpolate"].concat(this.extraElements());
    var thiz = this;
    var load = !BaseAngularControllerWidget._initializedModules[this._dynamicModuleName];
    if (load) {
        angular.module(
            this._dynamicModuleName,
            this._angularJSDependencies || [])
            .controller(this._dynamicControllerName,
                objects.concat([
                function () {
                    for (var index in arguments) {
                        var v = arguments[index];
                        thiz[objects[index]] = v;
                    }
                    thiz._fireInstanceLoaded(callback);
                }]));
        BaseAngularControllerWidget._initializedModules[this._dynamicModuleName] = true;
    }
    this._fakeControllerNode = document.createElement("div");
    this._fakeControllerNode.setAttribute("ng-controller", this._dynamicControllerName);

    this.ngAppContainer.appendChild(this._fakeControllerNode);
    angular.bootstrap(this.ngAppContainer, [this._dynamicModuleName]);
};
BaseAngularControllerWidget.prototype.onDetached = function() {
    this.destroy();
}
BaseAngularControllerWidget.prototype.destroy = function (callback) {
    if (this.ngAppContainer) {
        if (this.ngAppContainer.parentNode) {
            this.ngAppContainer.parentNode.removeChild(this.ngAppContainer);
        }
        this.ngAppContainer = null;
    }
    delete BaseAngularControllerWidget._initializedModules[this._dynamicModuleName];
    if (this.node().parentNode) {
        this.node().parentNode.removeChild(this.node());
    }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/VideoView.js";

function VideoView(node) {
    BaseTemplatedWidget.call(this);

    var id = Dom.getAttributeAsString(node, "video-id", null);

    if (id) {
        var video = {
            id: id,
            type: Dom.getAttributeAsString(node, "video-type", null)
        };

        this.setVideo(video);
    }
}
__extend(BaseTemplatedWidget, VideoView);

VideoView.prototype.onAttached = function() {
    if (this._attached) return;
    this._attached = true;

    if (this._pendingVideo) {
        this._loadVideo(this._pendingVideo, this._pendingCallback);
        this._pendingVideo = null;
        this._pendingCallback = null;
    }
};

VideoView.prototype.setVideo = function(video, callback) {
    if (this._attached) {
        this._loadVideo(video, callback);
    } else {
        this._pendingVideo = video;
        this._pendingCallback = callback;
    }
};

VideoView.prototype._loadVideo = function(video, callback) {
    if (!video) {
        if (callback) callback("Invalid video");
        return;
    }
    this.video = video;
    var thiz = this;
    if (this.video.type == "wistia") {
        var htmlText = "<iframe src=\"//fast.wistia.net/embed/iframe/" + this.video.id + "\" allowtransparency=\"true\" frameborder=\"0\" scrolling=\"no\" class=\"wistia_embed\" name=\"wistia_embed\" allowfullscreen mozallowfullscreen webkitallowfullscreen oallowfullscreen msallowfullscreen width=\"100%\" height=\"100%\"></iframe>";
        this.videoContainer.innerHTML = htmlText;
        widget.__ensureExternalResourceLoaded("https://fast.wistia.com/assets/external/E-v1.js", "js", function () {
                if (callback) callback();
                window._wq = window._wq || [];
                _wq.push({ id: thiz.video.id, onReady: function(v) {
                    if (v._hashedId == thiz.video.id && thiz.video.autoPlay) {
                        v.play();
                    }
                }});
        });
    } else {
        callback("Unsupported video type: ", this.video.type);
    }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/VideoDialog.js";

function VideoDialog(options) {
    Dialog.call(this);
    this.grabHeight = true;
    this.title = options.title || "Video";
    var video = {
        id: options.id || "",
        type: "wistia",
        autoPlay: options.autoPlay || false
    };
    this.video = video;
}
__extend(Dialog, VideoDialog);

VideoDialog.prototype.onShown = function() {
    this.videoView.setVideo(this.video, function(){
        console.log("Load video done");
    });
}
VideoDialog.prototype.getDialogActions = function() {
    return [
        {
            type: "cancel", title: "Close",
            isCloseHandler: true,
            run: function () { return true; }
        }]
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/RichTextView.js";

function RichTextView() {
    BaseTemplatedWidget.call(this);
    
    this.bind("click", this._handleClick, this.contentPane);
}
__extend(BaseTemplatedWidget, RichTextView);

RichTextView.prototype.setHTML = function (html) {
    this.contentPane.innerHTML = html;
};

RichTextView.prototype._handleClick = function (event) {
    var link = Dom.findParentByTagName(event.target, "a");
    if (link) {
        window.open(link.href, "_blank");
        Dom.cancelEvent(event);
        return;
    }
};

if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/BaseEditor.js";

function BaseEditor() {
    BaseTemplatedWidget.call(this);
    this.dependenciesEditors = [];
    this.enable = true;
    this.dependencySatisfied = true;

    this.node()._editor = this;
}
__extend(BaseTemplatedWidget, BaseEditor);

BaseEditor.prototype.getValue = function () {
    return {};
};

BaseEditor.prototype.setEnable = function (enable) {
    this.enable = enable;
    this.invalidateEnableStatus();
};

BaseEditor.prototype._updateUIEnable = function (enable) {
};

BaseEditor.prototype.invalidateEnableStatus = function () {
    var enable = this.enable && this.dependencySatisfied;
    this._updateUIEnable(enable);
    Dom.toggleClass(this.node(), "Disabled", !enable);
};

BaseEditor.prototype.setValue = function(value) {
    this._value = value;
}
BaseEditor.prototype.setRefSchema = function(schema) {
    this._schema = schema;
    Dom.addClass(this.node(), "SchemaName_" + schema.name);
    if (this._schema.description) this.node().setAttribute("title", this._schema.description || "");
    Dom.addClass(this.node(), "EditorBox");
    Dom.toggleClass(this.node(), "DraggAble", this._schema.draggAble ? true : false);
    Dom.toggleClass(this.node(), "Hidden", this._schema.hidden ? true : false);
    if (this._schema && typeof(this._schema.displayName) == "string" && this._schema.displayName.length) this._schema.displayName = unescape(this._schema.displayName);
}

BaseEditor.prototype.onAttached = function () {
}
BaseEditor.prototype.onRenderFinished = function () {

}
BaseEditor.prototype.onDetached = function () {

}
BaseEditor.prototype.render = function() {
    this.installDependencyValidation();
    this.onRenderFinished();
}
BaseEditor.prototype.getEditor = function(name) {
    return this._schema && this._schema.name == name ? this : null;
}
BaseEditor.prototype.fireChangeEvent = function (fromUser) {
    this.modified = true;
    Dom.emitEvent("p:ValueChanged", this.node(), {fromUser: fromUser ? true : false, editor: this});
};

BaseEditor.prototype.setContext = function (context, path) {
    this.context = context;
    this.path = path;
};

BaseEditor.prototype.installDependencyValidation = function () {
    var depends = null;
    if (this._schema.depends) {
        depends = this._schema.depends.slice ? this._schema.depends : [this._schema.depends];
    }

    if (!depends || depends.length == 0) return;

    this.depends = [];
    for (var i = 0; i < depends.length; i ++) {
        var depend = this.normalizeDependency(depends[i]);
        this.depends.push(depend);
    }

    var thiz = this;
    Dom.registerEvent(this.context.getPropertyEditingEventNode(), "p:ValueChanged", function (event) {
        thiz._handleContextValueChanged(event);
    });

};
BaseEditor.prototype.normalizeDependency = function (depend) {
    var path = null;
    if (depend.path.substring(0, 1) == "/") {
        path = depend.path;
    } else {
        path = this.path;

        var parts = depend.path.split(/\//);
        for (var i = 0; i < parts.length; i++) {
            var part = parts[i];
            if (part == ".") continue;
            if (part == "..") {
                var index = path.lastIndexOf("/");
                if (index <= 0) throw "Invalid path reference: " + depend.path + " from " + this.path;
                path = path.substring(0, index);
            } else {
                path += "/" + part;
            }
        }
    }

    return {
        path: path,
        op: depend.op,
        values: depend.values
    };
};

BaseEditor.prototype.validateAllDependencies = function () {
    if (!this.depends || this.depends.length == 0) {
        this.dependencySatisfied = true;
        this.invalidateEnableStatus();
        return;
    }

    var ok = true;
    for (var i = 0; i < this.depends.length; i++) {
        var depend = this.depends[i];
        var target = this.context._editorsPathMap[depend.path];
        if (!target) continue;
        var args = [target.getValue()].concat(depend.values);
        var resolver = ConditionResolvers[depend.op];

        var result = resolver.apply(this, args);
        if (!result) {
            ok = false;
            break;
        }
    }

    this.dependencySatisfied = ok;
    this.invalidateEnableStatus();
};

BaseEditor.prototype._handleContextValueChanged = function (event) {
    if (!event.editor) return;

    var related = false;
    for (var i = 0; i < this.depends.length; i++) {
        var depend = this.depends[i];

        if (event.editor.path.indexOf(depend.path) != 0) continue;
        if (event.editor.path != depend.path && event.editor.path.substring(depend.path.length, depend.path.length + 1) != "/") continue;

        related = true;
        break;
    }

    if (!related) return;

    this.validateAllDependencies();
};
BaseEditor.prototype.getValidationRuleSet = function () {
    return null;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/BooleanEditor.js";

function BooleanEditor() {
    BaseEditor.call(this);
    this.bind("change", this.fireChangeEvent, this.checkBox);
}
__extend(BaseEditor, BooleanEditor);
BooleanEditor.prototype.render = function() {
    this.booleanTitle.innerHTML = this._schema === null ? "Boolean: " : this._schema.displayName + ":";
    var checked = typeof(this._value) != "undefined" ? this._value : false;
    this.checkBox.checked = checked;
    var autoSwitchToCheckbox = typeof(this._schema.autoSwitchToCheckbox) == "undefined" ? false : this._schema.autoSwitchToCheckbox;
    if (autoSwitchToCheckbox) {        
        this.checkBox.removeAttribute("mode");
        Dom.addClass(this.node(), "CheckboxMode");
        var iconClass = typeof(this._schema.icon) == "undefined" ? false : this._schema.icon;
        if (iconClass) {
            var icon = Dom.newDOMElement({
                _name: "icon",
                "class": iconClass
            });
            this.checkboxLabel.appendChild(icon);
        }
        var span = Dom.newDOMElement({
            _name: "span",
            _text: this._schema.displayName
        });
        this.checkboxLabel.appendChild(span); 
    }
    
    this.__base().render.apply(this);
};

BooleanEditor.prototype.getValue = function() {
    return this.checkBox.checked;
};

BooleanEditor.prototype.isValid = function() {
    return this.getValue() && this.checkBox.disabled == false;
};

BooleanEditor.prototype._updateUIEnable = function(enable) {
    Dom.setEnabled(enable, this.checkBox);
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/ColorEditor.js";

function ColorEditor() {
    BaseEditor.call(this);
    this.bind("p:ValueChanged", this.fireChangeEvent, this.colorPicker);
}
__extend(BaseEditor, ColorEditor);

ColorEditor.prototype.onDetached = function () {
    //document.body.removeChild(this.colorPicker.popup.popupContainer);
}

ColorEditor.prototype.render = function() {
    this.colorTitle.innerHTML = this._schema === null ? "Colors: " : this._schema.displayName + ":";
    this.colorPicker.setInfoWhenDefaultColorSelected("");
    this.colorPicker.setDefaultColor("#FFFFFF00");

    this.colorPicker.setRGBAHexColorString(this._value);
    this.__base().render.apply(this);
}
ColorEditor.prototype.getValue = function() {
    return this.colorPicker.getRGBAHexColorString();
}
ColorEditor.prototype._updateUIEnable = function(enable) {
    Dom.setEnabled(enable, this.colorPicker);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/ComplexEditor.js";

function ComplexEditor() {
    BaseEditor.call(this);
    this._editors = [];
    this._editorsMap = [];
}
__extend(BaseEditor, ComplexEditor);
ComplexEditor.prototype.render = function() {
    this._editors = [];
    this._editorsMap = [];
    this.editorsContainer.innerHTML = "";
    var thiz = this;
    var subSchema = this._schema.schemas || [];
    if (subSchema.length > 0) {
        Dom.addClass(this.node(), "Active");
    }

    for (var i = 0; i < subSchema.length; i++) {
        var schema = subSchema[i];
        var f = PropertySchema.editorsMap[schema.type];
        if (!f) continue;
        var e = new f();
        var v = this._value ? this._value[schema.name] : void 0;
        if (v === void 0) {
            v = schema.defaultValue;
        }
        e.setRefSchema(schema);
        e._schemaIndex = i;

        e.setValue(v);

        var path = this.path + "/" + schema.name;
        e.setContext(this.context, path);

        e.into(this.editorsContainer);
        this._editors.push(e);
        this._editorsMap[schema.name] = e;
        this.context._editorsPathMap[path] = e;

        e.render();
    }

    this.__base().render.apply(this);
};
ComplexEditor.prototype.validateAllDependencies = function(name) {
    this.__base().validateAllDependencies.apply(this);

    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        editor.validateAllDependencies();
    }
};
ComplexEditor.prototype.getEditor = function(name) {
    return this._editorsMap[name];
}
ComplexEditor.prototype.isValid = function() {
    var e = this._editorsMap[this._schema.name];
    return e && e.isValid();
}
ComplexEditor.prototype.getValue = function() {
    var value = {};
    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        if (this.context.isIgnoreValueIfDependencyUnsatisfied && this.context.isIgnoreValueIfDependencyUnsatisfied() && !editor.dependencySatisfied) continue;
        var v = editor.getValue();
        value[editor._schema.name] = v;
    }
    return value;
}
ComplexEditor.prototype.getValidationRuleSet = function() {
    var rs = new RuleSet();
    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        var set = editor.getValidationRuleSet();
        if (set) rs.set(set);
    }
    
    return rs;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/ConditionResolvers.js";

var ConditionResolvers = {
    "==": function (a, b) {
        return a == b;
    },

    ">": function (a, b) {
        return a > b;
    },

    ">=": function (a, b) {
        return a >= b;
    },

    "<": function (a, b) {
        return a < b;
    },

    "<=": function (a, b) {
        return a <= b;
    },

    "!=": function (a, b) {
        return a != b;
    },

    "===": function (a, b) {
        return a === b;
    },

    "!==": function (a, b) {
        return a !== b;
    },

    "contains": function (a, b) {
        return a && a.indexOf && a.indexOf(b) >= 0;
    },

    "matches": function (a, b) {
        return a && a.match && a.match(b);
    },

    "notEmpty": function (a) {
        if (!a) return false;
        if (Array.isArray(a)) return a.length > 0;
        if (typeof a === 'object') return Object.keys(a).length > 0;
        return false;
    },

    "disabled": function () {
        return false;
    }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/CustomEnumEditor.js";

function CustomEnumEditor() {
    BaseEditor.call(this);
    var thiz = this;
}
__extend(BaseEditor, CustomEnumEditor);
CustomEnumEditor.prototype.render = function() {
    var thiz = this;
    this.enumTitle.innerHTML = this._schema === null ? "Enum: " : (typeof(this._schema.getDisplayTitle) == "function" ? this._schema.getDisplayTitle() : this._schema.displayName + ":");
    Dom.empty(this.selectionInput);

    this.usedKey = this._schema.items && this._schema.items.length > 0 && typeof(this._schema.items[0].key) != "undefined";
    var autoSwitchToRadioButton = typeof(this._schema.autoSwitchToRadioButton) == "undefined" ? false : this._schema.autoSwitchToRadioButton;
    var autoSwitchToCheckbox = typeof(this._schema.autoSwitchToCheckbox) == "undefined" ? false : this._schema.autoSwitchToCheckbox;    
    var checkboxDisplayType = typeof(this._schema.checkboxDisplayType) == "undefined" ? false : this._schema.checkboxDisplayType;
    var listItemDisplayType = typeof(this._schema.listItemDisplayType) == "undefined" ? false : this._schema.listItemDisplayType;
    var useCombo = this._schema.exclusive && (!autoSwitchToRadioButton && !autoSwitchToCheckbox || this._schema.useComboMode);
    if (useCombo) {
        Dom.addClass(this.node(), "UseCombo");
        Dom.removeClass(this.node(), "UseSelectBox");
        this.comboManager = new ComboManager();
        this.comboManager.renderer = function(item) {
            return (item && (typeof(item.value) != "undefined")) ? item.value : item;
        };
        this.comboManager.comparer = function(selected, item) {
            return selected.key == item.key;
        };
        this.comboManager.setItems(this._schema.items || []);
        this.comboManager.options =  {
            onItemSelected: function(fromUserAction) {
                var item = thiz.comboManager.getSelectedItem();
                thiz.node().setAttribute("selectedItem", item ? (thiz.usedKey ? item.key : "") : "None");
                thiz._updateUIForNullSelection();
                if (!fromUserAction) return;
                thiz.fireChangeEvent(true);

            },
        };
        this.comboManager.setPopupClass("Enum_Combo_Popup_" + thiz._schema.name);
        this.comboManager.into(this.selectionInput);
        this.comboManager.node().setAttribute("flex", 1);
        if (this._value) {
            this.comboManager.selectItem(this.usedKey ? Util.find(this._schema.items, function(item) {
                if (item.key == thiz._value) return item;
                return null;
            }) : this._value);
        }
    } else {
        //Dom.removeClass(this.selectionInput, "EditorInput");
        Dom.addClass(this.node(), "UseSelectBox");
        Dom.removeClass(this.node(), "UseCombo");

        this.selectBox = new SelectBox();
        var allItemSelectedText = this._schema.allItemSelectedText && this._schema.allItemSelectedText.length > 0 ?
        this._schema.allItemSelectedText : "All";
        
        var exclusive = this._schema.exclusive;
        Dom.toggleClass(this.node(), "Exclusive", exclusive);
        var autoAll = !exclusive && !thiz._schema.useActualValuesForAll;
        this.selectBoxMode = exclusive ? SelectBox.LIST_ITEM_DISPLAY_TYPE_RADIO : SelectBox.MODE_CHECK;
        var maxSupportedItemButton = this._schema.maxSupportedItemButton || 5;
        if (this._schema.items.length > maxSupportedItemButton) {
            this.selectBoxMode = SelectBox.MODE_DROPDOWN;
        }
        var shouldFocusOnMouseEnter = this.selectBoxMode != SelectBox.LIST_ITEM_DISPLAY_TYPE_RADIO && this.selectBoxMode != SelectBox.MODE_CHECK;
        var direction = this._schema.direction || (exclusive ? SelectBox.DIRECTION_ROW : SelectBox.DIRECTION_COLUMN);
        
        var configs = {
            name: "selectBox_" + widget.random(),
            mode: this.selectBoxMode,
            direction: direction,
            multipleSelect: !exclusive,
            optionSelectAll: autoAll,
            optionSelectAllText: (!exclusive && !thiz._schema.useActualValuesForAll) ? allItemSelectedText : undefined,
            noneSelectionText: thiz._schema.noneSelectionText || "",
            useExplicitSelectLinks: thiz._schema.items.length > 4,
            filterBox: !!thiz._schema.filterBox,
            filterHintText: thiz._schema.filterBox && thiz._schema.filterHintText || "",
            shouldFocusOnMouseEnter: shouldFocusOnMouseEnter
        };
        
        // if (autoSwitchToCheckbox) configs.mode = SelectBox.MODE_CHECK;
        if (checkboxDisplayType && checkboxDisplayType == SelectBox.HORIZONTAL_BUTTON) {
            configs.direction = SelectBox.DIRECTION_ROW;
            configs.checkboxDisplayType = SelectBox.HORIZONTAL_BUTTON;
        }
        
        this.selectBox.getConfigs = function() {
            return configs;
        };
        this.selectBox.setPopupClass("Enum_SelectBox_Popup_" + thiz._schema.name);
        this.selectBox.getData = function() {
            return thiz._schema.items || [];
        };
        var isAllOptionSelected = false;

        if (this._schema.allIndicationValue) {
            isAllOptionSelected = this._value && this._value.length == 1 && this._value[0] == this._schema.allIndicationValue;
        } else {
            isAllOptionSelected = autoAll && (typeof(this._value) == "undefined" || this._value == null || this._value.length == 0 || (this._value.indexOf && this._value.indexOf(0) >= 0));
        }
        this.selectBox.parseData = function(object) {
            return {
                    value: object.key,
                    text: object.value,
                    checked: isAllOptionSelected ? true : thiz._value && thiz._value.indexOf && thiz._value.indexOf(object.key) >= 0
                };
        }
        this.selectBox.into(this.selectionInput);
        this.selectBox.node().setAttribute("flex", 1);
        this.selectBox._options =  {
            onSelectionChanged: function(fromUserAction) {
                thiz._updateUIForNullSelection();
                if (!fromUserAction) return;
                thiz.fireChangeEvent(true);
            },
        };
        this.selectBox.setup();
        if (autoSwitchToCheckbox && checkboxDisplayType) Dom.addClass(this.selectBox.node(), checkboxDisplayType);
    }

    this.__base().render.apply(this);
    this._updateUIForNullSelection();
}
CustomEnumEditor.prototype._updateUIForNullSelection = function(enable) {
    var isNull = false;
    if (this.comboManager) {
        var item = this.comboManager.getSelectedItem();
        isNull = (!item || !item.key);
    } else {
        var items = this.selectBox.getSelectedData();
        isNull = !items || items.length == 0;
    }

    Dom.toggleClass(this.node(), "NULLValueSelected", isNull);
};
CustomEnumEditor.prototype._updateUIEnable = function(enable) {
    if (Dom.hasClass(this.node(), "UseCombo")) {
        this.comboManager.setEnable(enable);
    } else if (this.selectBox) {
        if (this.selectBoxMode != SelectBox.MODE_DROPDOWN) {
            var inputNodes = this.selectBox.node().querySelectorAll(":scope .OptionBox .OptionContainer input");
            if (inputNodes && inputNodes.length) {
                inputNodes.forEach((input, i) => {
                    Dom.setEnabled(enable, input);
                });
            }
        } else {
            Dom.setEnabled(enable, this.selectBox.statusBox);
        }
    }
    Dom.toggleClass(this.node(), "Disabled", !enable);
}
CustomEnumEditor.prototype.getValue = function() {
    if (Dom.hasClass(this.node(), "UseCombo")) {
        var item = this.comboManager.getSelectedItem();
        if (item == null) return null;
        return typeof(item.key) != "undefined" && this.usedKey ? item.key : item;
    } else {
        var items = this.selectBox.getSelectedData();
        if (!items
            || (this.selectBox.isAllOptionSelected() && !this._schema.useActualValuesForAll && !this._schema.allIndicationValue)
            || items.length == 0) {
            return [];
        }

        if (this.selectBox.isAllOptionSelected() && this._schema.allIndicationValue) {
            return [this._schema.allIndicationValue];
        }

        if (Dom.hasClass(this.node(), "Exclusive")) {
            return this.usedKey ? items[0].key : items[0];
        }
        if (this.usedKey) {
            var keys = [];
            for (var i = 0; i < items.length; i++) {
                var v = items[i];
                if (v == null || !v.key) continue;
                keys.push(v.key);
            }
            return keys;
        }
        return items;
    }
}
CustomEnumEditor.prototype.getSelectBoxValue = function() {
    var items = this.selectBox.getSelectedData();
    if (!items
        || (this.selectBox.isAllOptionSelected() && !this._schema.useActualValuesForAll && !this._schema.allIndicationValue)
        || items.length == 0) {
        return [];
    }

    if (this.selectBox.isAllOptionSelected() && this._schema.allIndicationValue) {
        return [this._schema.allIndicationValue];
    }

    if (Dom.hasClass(this.node(), "Exclusive")) {
        return this.usedKey ? items[0].key : items[0];
    }
    if (this.usedKey) {
        var keys = [];
        for (var i = 0; i < items.length; i++) {
            var v = items[i];
            if (v == null || !v.key) continue;
            keys.push(v.key);
        }
        return keys;
    }
    return items;
};

CustomEnumEditor.prototype.getValidationRuleSet = function() {
    var rs = new RuleSet().live();
    if (this._schema.requireValue) {
        var thiz = this;
        rs.custom(new GenericRule(this.selectionInput,
                    function() {
                        var value = thiz.getValue();
                        return value instanceof Array ? value.length : value != null;
                    },
                    function () {
                        return "Please select a value";
                    }));
    }
    return rs;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/DateEditor.js";

function DateEditor() {
    BaseEditor.call(this);
    this.bind("p:ValueUpdated", function() {
        this.fireChangeEvent();
    }, this.dateInput);
    var thiz = this;
    this.dateInput.withTime = function() {
        return thiz._schema && thiz._schema.withTime;
    }
}
__extend(BaseEditor, DateEditor);

DateEditor.prototype.render = function() {
    this.dateInput.useEndOfDay = this._schema && this._schema.useEndOfDay;

    this.dateTitle.innerHTML = this._schema === null ? "Date: " : this._schema.displayName + ":";
    if (this._schema.minDate) {
        this.dateInput.setMinDate(this._schema.minDate);
    }
    if (this._schema.maxDate) {
        this.dateInput.setMaxDate(this._schema.maxDate);
    }
    var timezoneProvider = this._schema.timezoneProvider || TimezoneProviders[this._schema.timezoneProviderName || "local"] || TimezoneProviders.local;
    this.dateInput.setCustomTimezoneProvider(timezoneProvider);

    this.dateInput.setDate(this._value || this._schema.defaultValue);
    this.__base().render.apply(this);
}

DateEditor.prototype.getValue = function() {
    return this.dateInput.getDate();
}
DateEditor.prototype._updateUIEnable = function(enable) {
    this.dateInput.setEnabled(enable);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/DateRangeEditor.js";

function DateRangeEditor() {
    BaseEditor.call(this);
    this.bind("p:ValueUpdated", function() {
        this.fireChangeEvent();
    }, this.dateRangeInput.node());
    this.bind("p:ItemSelected", function(e) {
        if (e.fromUser) this.fireChangeEvent();
    });
}
__extend(BaseEditor, DateRangeEditor);

DateRangeEditor.prototype.render = function() {
    this.dateRangeInput.setUseToDateEOD(this._schema && this._schema.useEndDateEOD);

    this.dateTitle.innerHTML = this._schema === null ? "Date Range: " : this._schema.displayName + ":";
    var timezoneProvider = this._schema.timezoneProvider || TimezoneProviders[this._schema.timezoneProviderName || "local"] || TimezoneProviders.local;
    this.dateRangeInput.setCustomTimezoneProvider(timezoneProvider);
    if (this._schema.namedRangekeys && this._schema.namedRangekeys.length) {
        this.dateRangeInput.setCustomDateTimeOptionsByKeys(this._schema.namedRangekeys);
    }
    
    if (this._schema.customExtraTitle) {
        this.dateRangeInput.setCustomDateTimeTitle(this._schema.customExtraTitle);
    }

    this.dateRangeInput.setRange(this._value || this._schema.defaultValue);
    this.__base().render.apply(this);
}

DateRangeEditor.prototype.getValue = function() {
    return this.dateRangeInput.getRange();
}
DateRangeEditor.prototype._updateUIEnable = function(enable) {
    this.dateRangeInput.setEnable(enable);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/EnumEditor.js";

function EnumEditor() {
    BaseEditor.call(this);
    var thiz = this;
}
__extend(BaseEditor, EnumEditor);
EnumEditor.prototype.render = function() {
    var thiz = this;
    this.enumTitle.innerHTML = this._schema === null ? "Enum: " : this._schema.displayName + ":";
    Dom.empty(this.selectionInput);

    this.usedKey = this._schema.items && this._schema.items.length > 0 && typeof(this._schema.items[0].key) != "undefined";
    var autoSwitchToRadioButton = typeof(this._schema.autoSwitchToRadioButton) == "undefined" ? false : this._schema.autoSwitchToRadioButton;
    var autoSwitchToCheckbox = typeof(this._schema.autoSwitchToCheckbox) == "undefined" ? false : this._schema.autoSwitchToCheckbox;    
    var checkboxDisplayType = typeof(this._schema.checkboxDisplayType) == "undefined" ? false : this._schema.checkboxDisplayType;
    var listItemDisplayType = typeof(this._schema.listItemDisplayType) == "undefined" ? false : this._schema.listItemDisplayType;
    var useCombo = this._schema.exclusive && !autoSwitchToRadioButton && !autoSwitchToCheckbox;
    if (useCombo) {
        Dom.addClass(this.node(), "UseCombo");
        Dom.removeClass(this.node(), "UseSelectBox");
        this.comboManager = new ComboManager();
        this.comboManager.renderer = function(item) {
            return (item && (typeof(item.value) != "undefined")) ? item.value : item;
        };
        this.comboManager.comparer = function(selected, item) {
            return selected.key == item.key;
        };
        this.comboManager.setItems(this._schema.items || []);
        this.comboManager.options =  {
            onItemSelected: function(fromUserAction) {
                var item = thiz.comboManager.getSelectedItem();
                thiz.node().setAttribute("selectedItem", item ? (thiz.usedKey ? item.key : "") : "None");
                thiz._updateUIForNullSelection();
                if (!fromUserAction) return;
                thiz.fireChangeEvent(true);

            },
        };
        this.comboManager.setPopupClass("Enum_Combo_Popup_" + thiz._schema.name);
        this.comboManager.into(this.selectionInput);
        this.comboManager.node().setAttribute("flex", 1);
        if (this._value) {
            this.comboManager.selectItem(this.usedKey ? Util.find(this._schema.items, function(item) {
                if (item.key == thiz._value) return item;
                return null;
            }) : this._value);
        }
    } else {
        //Dom.removeClass(this.selectionInput, "EditorInput");
        Dom.addClass(this.node(), "UseSelectBox");
        Dom.removeClass(this.node(), "UseCombo");

        this.selectBox = new SelectBox();
        var allItemSelectedText = this._schema.allItemSelectedText && this._schema.allItemSelectedText.length > 0 ?
        this._schema.allItemSelectedText : "All";

        var exclusive = (this._schema.exclusive && autoSwitchToRadioButton && this._schema.items.length <= 3);
        Dom.toggleClass(this.node(), "Exclusive", exclusive);
        var autoAll = !exclusive && !thiz._schema.useActualValuesForAll;
        
        var configs = {
            name: "selectBox_" + widget.random(),
            mode: exclusive ? SelectBox.MODE_CHECK : SelectBox.MODE_DROPDOWN,
            direction: exclusive ? SelectBox.DIRECTION_ROW : SelectBox.DIRECTION_COLUMN,
            multipleSelect: !exclusive,
            optionSelectAll: autoAll,
            optionSelectAllText: (!exclusive && !thiz._schema.useActualValuesForAll) ? allItemSelectedText : undefined,
            noneSelectionText: thiz._schema.noneSelectionText || "",
            useExplicitSelectLinks: thiz._schema.items.length > 4,
            filterBox: !!thiz._schema.filterBox,
            filterHintText: thiz._schema.filterBox && thiz._schema.filterHintText || ""            
        };
        
        if (autoSwitchToCheckbox) configs.mode = SelectBox.MODE_CHECK;
        if (checkboxDisplayType && checkboxDisplayType == SelectBox.HORIZONTAL_BUTTON) {
            configs.direction = SelectBox.DIRECTION_ROW;
            configs.checkboxDisplayType = SelectBox.HORIZONTAL_BUTTON;
        }
        
        if (listItemDisplayType == SelectBox.LIST_ITEM_DISPLAY_TYPE_RADIO) {
            configs.multipleSelect = false;
        }
        
        this.selectBox.getConfigs = function() {
            return configs;
        };
        this.selectBox.setPopupClass("Enum_SelectBox_Popup_" + thiz._schema.name);
        this.selectBox.getData = function() {
            return thiz._schema.items || [];
        };
        var isAllOptionSelected = false;

        if (this._schema.allIndicationValue) {
            isAllOptionSelected = this._value && this._value.length == 1 && this._value[0] == this._schema.allIndicationValue;
        } else {
            isAllOptionSelected = autoAll && (typeof(this._value) == "undefined" || this._value == null || this._value.length == 0 || (this._value.indexOf && this._value.indexOf(0) >= 0));
        }
        this.selectBox.parseData = function(object) {
            return {
                    value: object.key,
                    text: object.value,
                    checked: isAllOptionSelected ? true : thiz._value && thiz._value.indexOf && thiz._value.indexOf(object.key) >= 0
                };
        }
        this.selectBox.into(this.selectionInput);
        this.selectBox.node().setAttribute("flex", 1);
        this.selectBox._options =  {
            onSelectionChanged: function(fromUserAction) {
                thiz._updateUIForNullSelection();
                if (!fromUserAction) return;
                thiz.fireChangeEvent(true);
            },
        };
        this.selectBox.setup();
        if (autoSwitchToCheckbox && checkboxDisplayType) Dom.addClass(this.selectBox.node(), checkboxDisplayType);
    }

    this.__base().render.apply(this);
    this._updateUIForNullSelection();
}
EnumEditor.prototype._updateUIForNullSelection = function(enable) {
    var isNull = false;
    if (this.comboManager) {
        var item = this.comboManager.getSelectedItem();
        isNull = (!item || !item.key);
    } else {
        var items = this.selectBox.getSelectedData();
        isNull = !items || items.length == 0;
    }

    Dom.toggleClass(this.node(), "NULLValueSelected", isNull);
};
EnumEditor.prototype._updateUIEnable = function(enable) {
    if (Dom.hasClass(this.node(), "UseCombo")) {
        this.comboManager.setEnable(enable);
    } else {
        Dom.setEnabled(enable, this.selectBox.statusBox);
    }
    Dom.toggleClass(this.node(), "Disabled", !enable);
}
EnumEditor.prototype.getValue = function() {
    if (Dom.hasClass(this.node(), "UseCombo")) {
        var item = this.comboManager.getSelectedItem();
        if (item == null) return null;
        return typeof(item.key) != "undefined" && this.usedKey ? item.key : item;
    } else {
        var items = this.selectBox.getSelectedData();
        if (!items
            || (this.selectBox.isAllOptionSelected() && !this._schema.useActualValuesForAll && !this._schema.allIndicationValue)
            || items.length == 0) {
            return [];
        }

        if (this.selectBox.isAllOptionSelected() && this._schema.allIndicationValue) {
            return [this._schema.allIndicationValue];
        }

        if (Dom.hasClass(this.node(), "Exclusive")) {
            return this.usedKey ? items[0].key : items[0];
        }
        if (this.usedKey) {
            var keys = [];
            for (var i = 0; i < items.length; i++) {
                var v = items[i];
                if (v == null || !v.key) continue;
                keys.push(v.key);
            }
            return keys;
        }
        return items;
    }
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/FileUploadEditor.js";

function FileUploadEditor() {
    BaseEditor.call(this);
}
__extend(BaseEditor, FileUploadEditor);

FileUploadEditor.prototype.render = function() {
    this.fileTitle.innerHTML = this._schema === null ? "File: " : this._schema.displayName + ":";
    this.fileUploadView.dataType = "upload";
    var exts = this._schema.extensions || "jpg,jpeg,png,gif";
    this.fileUploadView.acceptedExtensions = exts.toLowerCase().split(",");
    this.fileUploadView.dataUUID = Util.newUUID();
    this.fileUploadView.keepOriginal = this._schema.keepOriginal || true;
    this.fileUploadView.doResize = this._schema.doResize || false;
    this.fileUploadView.maxSize = this._schema.maxSize || "HUGE";
    this.fileUploadView.setCommaSeparatedStoragePaths(this._value || "");
    this.__base().render.apply(this);
}
FileUploadEditor.prototype.getValue = function() {
    return this.fileUploadView.getCommaSeparatedStoragePaths();
}
FileUploadEditor.prototype._updateUIEnable = function(enable) {
    Dom.setEnabled(enable, this.fileUploadView);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/HtmlEditor.js";

function HtmlEditor() {
    BaseEditor.call(this);

    this.bind(RichTextEditor.TEXT_CHANGE_EVENT_NAME, function() {
        this.fireChangeEvent();
    }, this.richTextEditor.node());
}
__extend(BaseEditor, HtmlEditor);

HtmlEditor.prototype.render = function() {
    this.textTitle.innerHTML = this._schema === null ? "Text: " : this._schema.displayName + ":";
    var v = "";
    if (typeof(this._value) == "string") {
        v = this._value;
    } else {
        v = this._schema.defaultValue || "";
    }
    this.richTextEditor.setContent(v);
    this.__base().render.apply(this);
}

HtmlEditor.prototype.getValue = function() {
    return this.richTextEditor.getContent();
}
HtmlEditor.prototype._updateUIEnable = function(enable) {
    this.richTextEditor.setReadOnly(!enable);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/ListEditor.js";

function ListEditor() {
    BaseEditor.call(this);
    this._editors = [];
    this.bind("click", function(){
        this.createNewEditor();
    }, this.addMoreButton);

    this.bind("click", function(event){
        var item = Dom.findUpwardForNodeWithData(event.target, "_attachedEditor");
        if (!item) return;

        if (Dom.hasClass(event.target, "Remove")) {
            this.removeEditor(item._attachedEditor);
        }
    }, this.listEditorsContainer);

}
__extend(BaseEditor, ListEditor);

ListEditor.prototype.render = function() {
    this.listTitle.innerHTML = this._schema === null ? "List: " : this._schema.displayName + ":";
    this._editors = [];
    this.listEditorsContainer.innerHTML = "";
    var editorMin = Math.max(this._schema.minItem, (this._value && this._value.length ? this._value.length : 1));
    for (var i = 0; i < editorMin; i++) {
        this.rendererNewItem(i);
    }
    this.__base().render.apply(this);
}

ListEditor.prototype.removeEditor = function(editor) {
    if (this._editors.length <= this._schema.minItem) {
        Dialog.alert("Info", "Minimum " + this._schema.minItem + " " + this._schema.displayName  + "s allowed!");
        return;
    }
    var thiz = this;
    Dom.doOnChildRecursively(this.listEditorsContainer, {
        eval : function(node) {
            return node._attachedEditor != null;
        }
    }, function(node) {
        if (node._attachedEditor == editor) {
            thiz.listEditorsContainer.removeChild(node);
            thiz._editors.splice(thiz._editors.indexOf(editor), 1);
            thiz.updateItems();
        }
    });
}
ListEditor.prototype.updateItems = function() {
    var index = 0;
    var thiz = this;
    Dom.doOnChildRecursively(this.listEditorsContainer, {
        eval : function(node) {
            return node._attachedEditor != null;
        }
    }, function(node) {
        var editor = node._attachedEditor;
        var ref = {displayName : thiz._schema.displayName + " " + (index +1), type: thiz._schema.type};
        editor.setRefSchema(ref);
        editor.render();
        index ++;
    });
}
ListEditor.prototype.rendererNewItem = function(index) {
    var f = PropertySchema.editorsMap[this._schema.elementType];
    if (f == null) {
        return;
    }
    var e = new f();
    var ref = {displayName : this._schema.displayName + " " + (index +1), type: this._schema.type};
    e.setRefSchema(ref);
    var values = this._value || [];
    var v = index >= 0 && index < values.length ? values[index] : null;
    e.setValue(v);
    var container = Dom.newDOMElement({_name: "hbox", class: "ListItemEditor"});
    e.into(container);
    e.node().setAttribute("flex", 1);
    e.render();

    var iconButton = Dom.newDOMElement({_name: "button", class: "ListItemAction Remove"});
    var removeIcon = Dom.newDOMElement({_name: "icon", class: "close RemoveAction"});
    iconButton.appendChild(removeIcon);

    container._attachedEditor = e;
    container.appendChild(iconButton);

    this.listEditorsContainer.appendChild(container);
    this._editors.push(e);
}
ListEditor.prototype.createNewEditor = function () {
    var created = this._editors.length;
    if (created >= this._schema.maxItem && this._schema.maxItem > 0) {
        Dialog.alert("Info", "Only " + this._schema.maxItem + " " + this._schema.displayName  + "s allowed!");
        return;
    }
    this.rendererNewItem(this._editors.length);
}
ListEditor.prototype.getValue = function() {
    var items = [];
    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        if (this.context.isIgnoreValueIfDependencyUnsatisfied && this.context.isIgnoreValueIfDependencyUnsatisfied() && !editor.dependencySatisfied) continue;
        var v = editor.getValue();
        if (v == null) continue;
        items.push(v)
    }
    return items;
}
ListEditor.prototype.validateAllDependencies = function(name) {
    this.__base().validateAllDependencies.apply(this);

    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        editor.validateAllDependencies();
    }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/NumberEditor.js";

function NumberEditor() {
    BaseEditor.call(this);

    this.bind("input", function() {
        this.fireChangeEvent();
    }, this.numberInput);

    this.bind("change", function() {
        this.fireChangeEvent();
    }, this.numberInput);
}
__extend(BaseEditor, NumberEditor);

NumberEditor.prototype.render = function() {
    this.numberTitle.innerHTML = this._schema === null ? "Number: " : this._schema.displayName + ":";
    this.numberInput.value = typeof(this._value) == "number" ? this._value : "";
    this.numberInput.min = this._schema.minValue || 0;
    this.numberInput.max = this._schema.maxValue || 10000;
    this.numberInput.step = this._schema.step || (this._schema.decimal ? Math.pow(10, 0 - (this._schema.decimalPlaces || 1)) : 1);

    this.__base().render.apply(this);
}

NumberEditor.prototype.getValue = function() {
    var text = this.numberInput.value;

    if (text.trim().length == 0) {
        return typeof(this._schema.blankValue) == "undefined" ? 0 : this._schema.blankValue;
    }

    var v = text.trim().length == 0 ? 0 : text.trim()
    return this._schema.decimal ? parseFloat(v, 10) : parseInt(v, 10);
}
NumberEditor.prototype._updateUIEnable = function(enable) {
    Dom.setEnabled(enable, this.numberInput);
}
NumberEditor.prototype.getValidationRuleSet = function() {
    var rs = new RuleSet();
    if (typeof(this._schema.minValue) != "undefined") {
        rs.min(this.numberInput,
            this._schema.minValue,
            false,
            "Please select a value that is no less than " + this._schema.minValue,
            Condition.notEmpty(this.numberInput));
    }
    if (typeof(this._schema.maxValue) != "undefined") {
        rs.max(this.numberInput,
            this._schema.maxValue,
            false,
            "Please select a value that is no more than " + this._schema.maxValue,
            Condition.notEmpty(this.numberInput));
    }

    return rs;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/PropertiesPage.js";

function PropertiesPage() {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.bind("click", function (){
            thiz.dumpValue();
    }, this.getValueButton);
}
__extend(BaseTemplatedWidget, PropertiesPage);
PropertiesPage.prototype.dumpValue = function() {
    var map = {};

    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        map[editor._schema.name] = editor.getValue();
    }
    console.log(map);
}
PropertiesPage.prototype.onAttached = function() {
    //console.log("onAttached called");
    //console.trace();
    var schemas = PropertySchema.schemas;
    Dom.empty(this.editorsContainer);

    var valuesMap = {
        "backgroundColor": "#336699FF",
        "padding": 2.3,
        "description": "Long description text here",
        "border": {
            "color": "#456544FF",
            "width": 3,
        },
        "palette": ["#223344FF", "#000011FF"],
        "default": false,
        "for": "All"
    };
    this._editors = [];
    this._editorsPathMap = {};
    for (var i = 0; i < schemas.length; i++) {
        var schema = schemas[i];
        var f = PropertySchema.editorsMap[schema.type];
        if (!f) {
            console.log("Impl of " + schema.type + " not found");
            continue;
        }
        //console.log("Editor " +f);
        var editor = new f();
        var valueForEditor = valuesMap[schema.name];
        var v = this.valuesMap ? this.valuesMap[schema.name] : undefined;
        if (v === undefined) {
            v = schema.defaultValue;
        }
        editor.setRefSchema(schema);
        editor.setValue(v);
        editor.into(this.editorsContainer);
        var path = "/" + schema.name;
        editor.setContext(this, path);
        if (i < schemas.length -1) {
            this.editorsContainer.appendChild(Dom.newDOMElement({_name: "div", class: "Separator"}));
        }
        editor.render();
        this._editors.push(editor);
        this._editorsPathMap[path] = editor;
    }

}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/PropertiesWidget.js";

function PropertiesWidget() {
    BaseTemplatedWidget.call(this);
    this._editors = [];
    this._editorsMap = {};
    this._editorPreparer = null;
    this._ignoreValueIfDependencyUnsatisfied = false;
}
__extend(BaseTemplatedWidget, PropertiesWidget);

PropertiesWidget.prototype.ignoreValueIfDependencyUnsatisfied = function(ignore) {
    this._ignoreValueIfDependencyUnsatisfied = ignore;
}
PropertiesWidget.prototype.isIgnoreValueIfDependencyUnsatisfied = function() {
    return this._ignoreValueIfDependencyUnsatisfied;
}
PropertiesWidget.prototype.getValue = function() {
    var map = {};
    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        if (this._ignoreValueIfDependencyUnsatisfied && !editor.dependencySatisfied) continue;
        map[editor._schema.name] = editor.getValue();

    }
    return map;
};
PropertiesWidget.prototype.setSchemas = function(schemas) {
    this.schemas = schemas;
};
PropertiesWidget.prototype.setValue = function(valueMap) {
    this.valuesMap = valueMap;
};
PropertiesWidget.prototype.setEditorPreparer = function(modifier) {
    this._editorPreparer = modifier;
};
PropertiesWidget.prototype.changeTopLevelSchema = function(path, schema) {
    var editor = this._editorsPathMap[path];
    if (!editor) return;

    var index = editor._schemaIndex;
    var editorIndex = this._editors.indexOf(editor);

    if (editor.destroy) editor.destroy();

    var oldNode = editor.node();

    var f = PropertySchema.editorsMap[schema.type];
    if (!f) {
        throw ("Impl of " + schema.type + " not found");
    }

    editor = new f();
    var v = this.valuesMap ? this.valuesMap[schema.name] : undefined;
    if (v === undefined) {
        v = schema.defaultValue;
    }

    editor.setRefSchema(schema);
    editor.setValue(v);
    var path = "/" + schema.name;
    editor.setContext(this, path);
    editor._schemaIndex = index;

    if (this._editorPreparer) this._editorPreparer.call(this, editor, schema);
    editor.into(this.editorsContainer, oldNode);
    this.editorsContainer.removeChild(oldNode);

    if (schema.groupName) editor.node().setAttribute("group-name", schema.groupName);

    if (editorIndex >= 0) {
        this._editors[editorIndex] = editor;
    } else {
        this._editors.push(editor);
    }
    this._editorsMap[schema.name] = editor;
    this._editorsPathMap[path] = editor;

    editor.render();
    editor.validateAllDependencies();
};
PropertiesWidget.prototype.setup = function(clearValue) {
    Dom.empty(this.editorsContainer);
    if (this.schemas.length == 0) {
         return;
    }
    this._editors = [];
    this._editorsMap = {};
    this._editorsPathMap = {};
    var c = 0;
    var thiz = this;

    for (var i = 0; i < this.schemas.length; i++) {
        var schema = this.schemas[i];
        var f = PropertySchema.editorsMap[schema.type];
        if (!f) {
            console.log("Impl of " + schema.type + " not found");
            continue;
        }
        var editor = new f();
        var v = this.valuesMap ? this.valuesMap[schema.name] : undefined;
        if (!clearValue && v === undefined) {
            v = schema.defaultValue;
        }

        editor.setRefSchema(schema);
        editor.setValue(v);
        var path = "/" + schema.name;
        editor.setContext(this, path);
        editor._schemaIndex = i;

        if (this._editorPreparer) this._editorPreparer.call(this, editor, schema);
        if (schema.type === "String" && this.__savedFilterContainer) {
            editor.fireChangeEvent = function (e) {
                thiz.onValueChanged(e);
            };
            var editorNode = editor.node();
            if (this.__savedFilterContainer.__addEditor) {
                this.__savedFilterContainer.removeChild(this.__savedFilterContainer.__addEditor);
            }
            this.__savedFilterContainer.prepend(editorNode);
            this.__savedFilterContainer.__addEditor = editorNode;
        } else {
            editor.into(this.editorsContainer);
            if (i < this.schemas.length -1) {
                this.editorsContainer.appendChild(Dom.newDOMElement({_name: "div", class: "Separator"}));
            }
        }
        if (schema.groupName) editor.node().setAttribute("group-name", schema.groupName);
        this._editors.push(editor);
        this._editorsMap[schema.name] = editor;
        this._editorsPathMap[path] = editor;

        editor.render();
    }

    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        editor.validateAllDependencies();
    }

    this.bind("p:ValueChanged", this.onValueChanged, this.editorsContainer);

    this.setupReordering();
    this.onRenderEditorFinished();
}
PropertiesWidget.prototype.onAttached = function() {
    if (!this.schemas) {
        return;
    }
    var thiz = this;
    if (this._setup) {
        return;
    }
    this._setup = true;
    this.setup();
};
PropertiesWidget.prototype.onRenderEditorFinished = function() {
    this._setup = true;
}
PropertiesWidget.prototype.onValueChanged = function(data) {
};
PropertiesWidget.prototype.getPropertyEditingEventNode = function() {
    return this.node();
};
PropertiesWidget.prototype.setupReordering = function () {
    var thiz = this;
    var baseFunction = DragAndDropManager.DROP_AT_CONTAINER(false);
    var dropTargetFinderFunction = function (event, manager) {
        var target = baseFunction(event, manager);
        if (!target || !(Dom.hasClass(target.element, "DraggAble") || target.mode == DragAndDropManager.DROP_APPEND)) return null;
        return target;
    }.bind(this);
    this.dnd = new DragAndDropManager()
    .source(this.editorsContainer)
    .anchor(function (node) {
        return Dom.hasClass(node, "DragButton");
    })
    .itemInfo(function (anchor) {
        var item = Dom.findParentWithClass(anchor, "DraggAble");
        if (!item) return null;
        return {
            element: item,
            data: item._schema
        };
    })
    .destination(this.editorsContainer)
    .canDrop(function (data) {
        return true;
    }
    .bind(this))
    .dropAt(dropTargetFinderFunction)
    .setup();

    this.dnd.createDragImageNode = function () {
        var node = Dom.newDOMElement({
            _name: "div",
            "class": "EditorDragImage"
        });
        node.style.width = Dom.getOffsetWidth(DragAndDropManager.draggable) + "px";
        node.style.height = Dom.getOffsetHeight(DragAndDropManager.draggable) + "px";
        node.style.backgroundColor = "rgba(0, 0, 0, 0.3)";
        return node;
    };
    this.dnd.createDropHintNode = function () {
        return Dom.newDOMElement({
            _name: "div",
            "class": "DropHint"
        });
    };
    this.dnd.onDrop = function (draggable, draggedData, target) {
        if (!draggable || !target) return;
        if (target.mode == DragAndDropManager.DROP_APPEND) {
            if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
            target.element.appendChild(draggable);
        } else if (target.mode == DragAndDropManager.DROP_PREV_SIBLING) {
            if (target.element != draggable) {
                var container = target.element.parentNode;
                if (draggable.parentNode) draggable.parentNode.removeChild(draggable);
                container.insertBefore(draggable, target.element);
            }
        }
        var orders = this.getSettingOrders();
        this.setSettingOrders(orders);
    }.bind(this);
};

PropertiesWidget.prototype.getSettingOrders = function () {
    var orders = [];
    Dom.doOnSelector(this.editorsContainer, ":scope > .EditorBox.DraggAble", function(node) {
        var schema = node.__widget ? node.__widget._schema : undefined;
        if (!schema) return;
        orders.push(schema.name);
    });
    return orders;
}

PropertiesWidget.prototype.setSettingOrders = function (orders) {
    var orderEditor = this._editorsMap["orders"] || undefined;
    if (!orderEditor) return;
    var originalValue = this.valuesMap["orders"] || undefined;
    orderEditor.setValue(orders);
    orderEditor.onRenderFinished = function() {
        orderEditor.setValue(originalValue);
        orderEditor.fireChangeEvent(true);
    };
    orderEditor.render();
}
PropertiesWidget.prototype.getValidationRuleSet = function () {
    var rs = new RuleSet().live(true);

    for (var i = 0; i < this._editors.length; i++) {
        var editor = this._editors[i];
        if (!editor.dependencySatisfied) continue;
        var set = editor.getValidationRuleSet();
        if (set) rs.set(set);
    }

    return rs;
};
PropertiesWidget.prototype.getEditorByPath = function (path) {
    return this._editorsPathMap && this._editorsPathMap[path];
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/SearchableEnumEditor.js";

function SearchableEnumEditor() {
    BaseEditor.call(this);

    // this.bind("input", function() {
    //     this.fireChangeEvent();
    // }, this.chipList);

    this.bind("p:ValueChanged", function() {
        this.fireChangeEvent();
    }, this.chipList);
}
__extend(BaseEditor, SearchableEnumEditor);

SearchableEnumEditor.prototype.render = function() {
    Dom.setInnerText(this.textTitle, this._schema === null ? "Items:" : (this._schema.displayName + ":"))
    
    var thiz = this;

    if (!this._source) {
        this._source = function (term, callback) {
            if (!term || term.trim().length == 0) {
                callback([]);
            } else {
                thiz._schema.provider(null, term, thiz, callback);
            }
        };
        
        this._renderer = function (item, selected) {
            if (selected) return item.shortName || item.value;
            return item.longName || item.value;
        };
    }
    this.chipList.placeHolder = this._schema.description;
    this.chipList.autoCompleteInput.useHtml = false;
    this.chipList.setup(this._source, this._renderer);
    
    var isAllOptionSelected = false;

    if (this._schema.allIndicationValue) {
        isAllOptionSelected = this._value && this._value.length == 1 && this._value[0] == this._schema.allIndicationValue;
    } else {
        isAllOptionSelected = (typeof(this._value) == "undefined" || this._value == null || this._value.length == 0 || (this._value.indexOf && this._value.indexOf(0) >= 0));
    }
    
    if (this._value && this._value.length > 0) {
        this._itemResolved = false;
        
        thiz._schema.provider(this._value, null, thiz, function (items) {
            var map = {};
            items.forEach(function (item) { map[item.key] = item; });
            thiz._value.forEach(function (v) {
                var item = map[v];
                if (item) thiz.chipList.add(item, false);
            });
            
            this._itemResolved = true;
        });
    } else {
        this._itemResolved = true;
    }
    
    this.__base().render.apply(this);
}

SearchableEnumEditor.prototype.getValue = function() {
    return this.chipList.getItems().map(function (item) { return item.key; });
}
SearchableEnumEditor.prototype._updateUIEnable = function(enable) {
    Dom.setEnabled(enable, this.chipList);
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/property-editor/TextEditor.js";

function TextEditor() {
    BaseEditor.call(this);

    this.bind("input", function(e) {
        this.fireChangeEvent(e);
    }, this.textInput);

    this.bind("input", function(e) {
        this.fireChangeEvent(e);
    }, this.multilineTextInput);
}
__extend(BaseEditor, TextEditor);

TextEditor.prototype.render = function() {
    this.textTitle.innerHTML = this._schema === null ? "Text: " : (typeof(this._schema.getDisplayTitle) == "function" ? this._schema.getDisplayTitle() : this._schema.displayName + ":");

    var v = "";
    if (typeof(this._value) == "string") {
        v = this._value;
    } else {
        v = this._schema.defaultValue || "";
    }
    var maxLength = this._schema.maxLength || 0;
    if (this._schema.multiLine) {
        Dom.removeClass(this.textInput.node(), "Active");
        Dom.addClass(this.multilineTextInput, "Active");
        this.multilineTextInput.value = v;
        if (maxLength > 0) {
            this.multilineTextInput.maxLength = maxLength;
        }
        this.multilineTextInput.setAttribute("placeholder", this._schema.placeHolder || "");
    } else {
        Dom.addClass(this.textInput.node(), "Active");
        Dom.removeClass(this.multilineTextInput, "Active");
        this.textInput.node().value = v;
        if (maxLength > 0) {
            this.textInput.node().maxLength = maxLength;
        }
        this.textInput.node().setAttribute("placeholder", this._schema.placeHolder || "");

        if (this._schema.items && this._schema.items.length > 0) {
            var thiz = this;
            var renderer = function (item) {
                return thiz._schema.itemDisplayProperty ? item[thiz._schema.itemDisplayProperty] : item.toString();
            };

            this.bind("p:ItemSelected", function () {
                var item = this.textInput.getSelectedData();
                if (!item) return;
                this.textInput.setSelectedData(null);
                this.textInput.node().value = renderer(item);
            }, this.textInput);

            this.bind("click", function(e) {
                if (e.target == thiz.textInput.node()) {
                    thiz.textInput.autoCompleteNow();
                }
            }, this.textInput);
            var searchProperty = thiz._schema.itemSearchProperty || "";
            var source = function (term, callback) {
                window.setTimeout(function () {
                    var matchedItems = thiz._schema.items.filter(function (obj) {
                        if (searchProperty.length == 0) return obj.toString().toLowerCase().indexOf(term.toLowerCase()) >= 0;
                        return obj[searchProperty] && obj[searchProperty].toString().toLowerCase().indexOf(term.toLowerCase()) >= 0;
                    });
                    callback(matchedItems);
                }, 100);
            };
            this.textInput.setup(source, renderer, renderer);
            this.textInput.timeout = 150;
            this.textInput.suggestOnBlank = true;
        }

    }

    this.__base().render.apply(this);
}

TextEditor.prototype.getValue = function() {
    var text = this._schema.multiLine ? this.multilineTextInput.value : this.textInput.getText();
    var value = text.trim();
    if (value.length == 0) {
        return typeof(this._schema.blankValue) == "undefined" ? null : this._schema.blankValue;
    }
    return value;
}
TextEditor.prototype._updateUIEnable = function(enable) {
    var text = this._schema.multiLine ? this.multilineTextInput : this.textInput;
    Dom.setEnabled(enable, text);
}
TextEditor.prototype.getValidationRuleSet = function() {
    var rs = new RuleSet();
    var thiz = this;
    if (this._schema.requireValue) {
        rs.custom(new GenericRule(this._schema.multiLine ? this.multilineTextInput : this.textInput,
                    function() {
                        var value = thiz.getValue();
                        return value || thiz._schema.acceptedValues && thiz._schema.acceptedValues.includes(value);
                    },
                    function () {
                        return "Please input a value.";
                    }));
    }
    return rs;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/PropertySchema.js";

var PropertySchema = (function () {
    var thiz = {
        schemas: [],
        editorsMap: {}
    };
    function register(schema) {
        thiz.schemas.push(schema);
    }
    function registerEditor(type, editor) {
        var t = "" + type;
        thiz.editorsMap[t] = editor;
    }
    register({
        "name": "backgroundColor",
        "displayName": "Background Color",
        "type": "Color",
        "defaultValue": "#000000"
    });

    register({
        "name": "padding",
        "displayName": "Padding",
        "type": "Number",
        "defaultValue": 1.5,
        "minValue": 0,
        "maxValue": 30,
        "units": "em,px"
    });
    register({
        "name": "description",
        "displayName": "Description",
        "type": "String",
        "defaultValue": "",
        "maxLength": 255,
        "multiLine": true
    });
    register({
        "name": "for",
        "displayName": "Enum",
        "type": "Enum",
        "defaultValue": "List",
        "items": [{key: "List", value: "List"}, {key: "Item", value: "Item"}, {key: "All", value: "All"}]
    });

    register({
        "name": "default",
        "displayName": "Boolean",
        "type": "Boolean",
        "defaultValue": false,
    });
    register({
        "name": "border",
        "displayName": "Border Style",
        "type": "Complex",
        "schemas": [
            {
                "name": "color",
                "displayName": "Border Color",
                "type": "Color",
                "defaultValue": "#FF0000"
            },
            {
                "name": "width",
                "displayName": "Border Width",
                "type": "Number",
                "defaultValue": 0.5,
                "units": "em,px"
            }
        ]
    });
    register({
        "name": "palette",
        "displayName": "Color Palette",
        "type": "Collection",
        "elementType": "Color",
        "minItem": 2,
        "maxItem": 5,
        "defaultValue": ["#223344", "#000011"]
    });

    register({
        "name": "file",
        "displayName": "Logo",
        "type": "FileUpload",
        "defaultValue": ""
    });

    registerEditor("Color", ColorEditor);

    registerEditor("String", TextEditor);
    
    registerEditor("Html", HtmlEditor);

    registerEditor("Number", NumberEditor);

    registerEditor("Enum", EnumEditor);
    registerEditor("SearchableEnum", SearchableEnumEditor);
    registerEditor("CustomEnum", CustomEnumEditor);

    registerEditor("Collection", ListEditor);

    registerEditor("Boolean", BooleanEditor);

    registerEditor("Complex", ComplexEditor);

    registerEditor("FileUpload", FileUploadEditor);

    registerEditor("Date", DateEditor);

    registerEditor("DateRange", DateRangeEditor);

    return thiz;
})();


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/CalendarView.js";

function CalendarView(n) {
    BaseTemplatedWidget.call(this);
    this.selectedDate = new Date();
    
    this.firstWeekDay = Dom.getAttributeAsInt(n, "first-week-day", 0);
    this.itemDateKey = Dom.getAttributeAsString(n, "item-date-key", "");    
    this.timezoneProviderName = Dom.getAttributeAsString(n, "timezone-provider", "local");
    this.timezoneProvider = TimezoneProviders[this.timezoneProviderName] || TimezoneProviders.auto;
    this.viewType = "month";    
    
    this.bind("click", this.prevButtonClickedHandler, this.prevButton);
    this.bind("click", this.nextButtonClickedHandler, this.nextButton);
    
    this.bind("p:ValueUpdated", this.dateChangedHandler, this.dateSelector);
    this.bind("change", this.changedHandler, this.calendarContent);
    
    this.selectedDataIds = [];
    
}
__extend(BaseTemplatedWidget, CalendarView);

CalendarView.prototype.setContentFragment = function (fragment) {
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node.getAttribute) continue;
    
        var role = node.getAttribute("role");
        if (role == "item") {
            this.itemTemplate = node;
        } else if (role == "filters") {
            this.filtersWrapper.appendChild(node);
        }
    }
};

CalendarView.prototype.onAttached = function () {
    Dom.emitEvent("p:onAttached", this.node());
    //this.reloadCalendar();
    
};

CalendarView.prototype.reloadCalendar = function () {
    var thiz = this;
    this._year = this.selectedDate.getFullYear();
    this._month = this.selectedDate.getMonth();
    this._date = this.selectedDate.getDate();
    var params = this.getDateRange();    
    this.dataSource(function (res) {
        thiz.setItems(res);
    });
};

CalendarView.prototype.getDateRange = function () {
    var startDate, endDate;
    var m = moment.tz({year: this._year, month: this._month, date: this._date, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    
    switch (this.viewType) {
        case "month":
            m.date(1);
            startDate = m.toDate();
            m.add(1, "months");
            m.add(-1, "s");
            endDate = m.toDate();
            break;
        default:
            break;
    }
    
    return {
        startDate: startDate,
        endDate: endDate
    }
};

CalendarView.prototype.setItems = function (items, doneCallback) {
    this.items = items;
    Dom.empty(this.calendarContent);
    this.renderMonthView(this.calendarContent, items);
    if (doneCallback) doneCallback.apply(this);
};

// CalendarView.prototype.setDate = function (date) {
//     this.selectedDate = date;
// };

CalendarView.prototype.getTZID = function () {
    return this.timezoneProvider.getTimezoneId();
};

CalendarView.prototype._getObjectDateKey = function (date) {
    return date.month() + "_" + date.date();
};

CalendarView.prototype.renderMonthView = function (container, items) {
    this.itemObject = {};
    var today = moment.tz(new Date(), this.getTZID());
    if (items && items.length > 0) {
        for (var i = 0; i < items.length; i ++) {
            var item = items[i];
            if (!item[this.itemDateKey]) continue;
            if (!(item[this.itemDateKey] instanceof Date)) continue;
            var dateKey = moment(item[this.itemDateKey]);
            dateKey.tz(this.getTZID());
            var itemObjectKey = this._getObjectDateKey(dateKey);
            if (!this.itemObject[itemObjectKey]) this.itemObject[itemObjectKey] = [];
            this.itemObject[itemObjectKey].push(item);
        }
    }
    this.displayedDate.innerHTML = FormatUtil.formatDate(this.selectedDate, "monthyear_named", this.timezoneProviderName);
    
    var monthTable = document.createElement("table"),
        thead = document.createElement("thead"),
        tbody = document.createElement("tbody"),
        headerRow = document.createElement("tr");
        
    Dom.addClass(headerRow, "Header");
    var mobileView = window.innerWidth <= BaseWidget.RESPONSIVE_BREAKPOINTS.md;
    var weekdays = moment.weekdays;
    if (mobileView) weekdays = moment.weekdaysShort;
    for (var i = 0; i < 7; i ++) {
        var wd = (i + this.firstWeekDay) % 7;
        var cell = document.createElement("th");
        cell.innerHTML = Dom.htmlEncode(weekdays(wd));
        headerRow.appendChild(cell);
    }
    thead.appendChild(headerRow);
    monthTable.appendChild(thead);
    
    var m = moment.tz({year: this._year, month: this._month, date: 1, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    var padding = (m.day() - this.firstWeekDay + 7) % 7;
    m = m.subtract(padding, "days");
    
    var index = 0, row;
    while ((m.month() <= this._month && m.year() <= this._year) || (m.month() > this._month && m.year() < this._year)) {
        if (index % 7 == 0) {
            row = document.createElement("tr");
            tbody.appendChild(row);
        }
        this._renderBodyCell(row, m, today);
        m = m.add(1, "days");
        index ++;
    }
    
    while (m.weekday() != this.firstWeekDay) {
        this._renderBodyCell(row, m, today);
        m = m.add(1, "days");
    }
    monthTable.appendChild(tbody);
    container.appendChild(monthTable);    
};

CalendarView.prototype._renderBodyCell = function (row, m, today) {
    var cell = document.createElement("td"),
        cellWrapper = document.createElement("div");
        
    if(today.isSame(m, "day")) Dom.addClass(cell, "Current");
    cell._year = m.year();
    cell._month = m.month();
    cell._date = m.date();
    
    if (m.month() != this._month) Dom.addClass(cell, "Inactive");
    
    Dom.addClass(cellWrapper, "CellWrapper");
    var dateWrapper  = document.createElement("div");
    Dom.addClass(dateWrapper, "DateWrapper");
    dateWrapper.innerHTML = "<span>" + m.date() + "</span>";
    cellWrapper.appendChild(dateWrapper);
    
    if (this.itemTemplate) {
        var key = this._getObjectDateKey(m);
        if (this.itemObject[key] && this.itemObject[key].length > 0) {
            var itemWrapper = document.createElement("div");
            Dom.addClass(itemWrapper, "ItemWrapper");
            cellWrapper.appendChild(itemWrapper);
            for (var i = 0; i < this.itemObject[key].length; i ++) {
                var newNode = this.itemTemplate.cloneNode(true);
                this.createBinding(newNode);
                itemWrapper.appendChild(newNode);
                if (this.populator && typeof(this.itemObject[key][i]) != "undefined") {
                    this.populator(this.itemObject[key][i], newNode._binding, newNode);    
                }
            }
        }
        
    }
    
    cell.appendChild(cellWrapper);
    row.appendChild(cell);
};

CalendarView.prototype.createBinding = function (container) {
    container._binding = {};
    container._binding._node = container;
    widget.Util.performAutoBinding(container, container._binding, null, "forced");

    Dom.doOnChildRecursively(container, {
        eval: function(n) {
            return n.getAttribute && n.getAttribute("anon-id");
        }
    }, function(n) {
        var id = n.getAttribute("anon-id");
        if (container._binding) {
            container._binding[id] = n;
        }
        n.removeAttribute("anon-id");
        var newId = id + widget.random();
        n.setAttribute("id", newId);
        n.id = newId;
        Dom.addClass(n, "AnonId_" + id);
    });
};

CalendarView.prototype.prevButtonClickedHandler = function () {
    var m = moment(this.selectedDate);
    switch (this.viewType) {
        case "month":
            m.subtract(1, "months");
        default:
            break;
    }
    this.selectedDate = m.toDate();
    this.dateSelector.setDate(this.selectedDate);
    this.reloadCalendar();
};

CalendarView.prototype.nextButtonClickedHandler = function () {
    var m = moment(this.selectedDate);
    switch (this.viewType) {
        case "month":
            m.add(1, "months");
        default:
            break;
    }
    this.selectedDate = m.toDate();
    this.dateSelector.setDate(this.selectedDate);
    this.reloadCalendar();
};

CalendarView.prototype.dateChangedHandler = function () {
    this.selectedDate = this.dateSelector.getDate();
    this.reloadCalendar();
};

CalendarView.prototype.changedHandler = function (event) {
    if (Dom.hasClass(event.target, "ItemCheck")) {
        var selectedValue = event.target.value;
        if (isNaN(selectedValue)) return;
        var val = parseInt(selectedValue);
        if (event.target.checked) {
            this.selectedDataIds.push(val);
            Dom.addClass(Dom.findParentWithClass(event.target, "Item"), "Active");
        } else {
            var index = this.selectedDataIds.indexOf(val);
            if (index >= 0) {
                this.selectedDataIds.splice(index, 1);
                Dom.removeClass(Dom.findParentWithClass(event.target, "Item"), "Active");
            }
        }
        if (typeof(this.onSelectionChanged) == "function") {
            this.onSelectionChanged();
        }
    }
};

CalendarView.prototype.getSelectedDataIds = function () {
    return this.selectedDataIds;
};




if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/CurrencyInput.js";

function CurrencyInput(node) {
    BaseTemplatedWidget.call(this);
    var readOnly = Dom.getAttributeAsBoolean(node, "read-only", false);
    if (readOnly) this.currencyInput.readOnly = true;

    this.valueTitle = Dom.getAttributeAsString(node, "title", "value");
    this.min = Dom.getAttributeAsFloat(node, "min", 0);

    this.bind("click", this.amountIconTypeClickedHandler, this.amountIconType);
    this.bind("click", this.switchToDollarMode, this.amountTypeDollar);
    this.bind("click", this.switchToPercentMode, this.amountTypePercent);

    this.AMOUNT_TYPE_DOLLAR = "dollar";
    this.AMOUNT_TYPE_PERCENT = "percent";
    this.amountType = Dom.getAttributeAsString(node, "amount-type", this.AMOUNT_TYPE_DOLLAR);
    this.defaultValue = Dom.getAttributeAsString(node, "default-value", "");
    this.onlyPositive = Dom.getAttributeAsString(node, "only-positive", false);
    
    var currencyIcon = "currency-" + Util.getCurrencyCode().toLowerCase();
    this.amountTypeDollar.innerHTML = (window.LOCALE && window.LOCALE.currencySign) || "$";
    Dom.removeClass(this.amountIconTypeCurrencyIcon, "currency-usd");
    Dom.addClass(this.amountIconTypeCurrencyIcon, currencyIcon);
    
    this.inputDisplayRenderer = function(inputVal) {
        if (typeof(inputVal) == "undefined" || inputVal.length == 0 || isNaN(inputVal)) {
            if (this.currencyInput._lastGoodValue) {
                return Util.toCurrency(CurrencyInput.parseInput(this.currencyInput._lastGoodValue), {noSymbol: true});
            }
            return this.defaultValue;
        }
        return Util.toCurrency(CurrencyInput.parseInput(inputVal), {noSymbol: true});
    }

    this.bind("input", function (event) {
        this._modifiedByUser = true;
        var isSkipValidate = this.currencyInput.value.match(/^[-+]$/g);
        if (isSkipValidate) return;
        var number = CurrencyInput.parseInput(this.currencyInput.value);
        var isInvalidInput = isNaN(number) || (this.onlyPositive && number < 0);
        if (isInvalidInput) {
            event.target.value = this.currencyInput._lastGoodValue || "";
            this._modifiedByUser = false;
        } else {
            this.currencyInput._lastGoodValue = this.currencyInput.value;
            this._fireValueChangedEvent();
        }
    }, this.currencyInput);

    this.bind("blur", function (event) {
        if (this._modifiedByUser) {
            var inputVal = this.currencyInput.value;
            var displayVal = this.inputDisplayRenderer(inputVal);

            this.currencyInput.value = displayVal;
            this.currencyInput._lastGoodValue = displayVal;
        }
        this._modifiedByUser = false;
    }, this.currencyInput);
}

__extend(BaseTemplatedWidget, CurrencyInput);

CurrencyInput.parseInput = function(input) {
    return Number((input || "0").replace(/\,/g, ""));
};
CurrencyInput.prototype.onAttached = function() {
    if (this.amountType == this.AMOUNT_TYPE_DOLLAR) {
        Dom.addClass(this.node(), "AmountTypeDollar");
        Dom.removeClass(this.node(), "AmountTypePercent");
    } else if (this.amountType == this.AMOUNT_TYPE_PERCENT) {
        Dom.removeClass(this.node(), "AmountTypeDollar");
        Dom.addClass(this.node(), "AmountTypePercent");
    }
};

CurrencyInput.prototype._fireValueChangedEvent = function () {
    Dom.emitEvent("p:CurrencyValueChanged", this.node(), {value: this.getValue()});
};

CurrencyInput.prototype.setValue = function (value) {
    this._setCurrencyInputValue(value);
};

CurrencyInput.prototype.getValue = function () {
    return Util.getInputValueAsFloatNumber(this.currencyInput.value, 0);
};

CurrencyInput.prototype._setCurrencyInputValue = function (value) {
    if (typeof(value) == "undefined") {
        this.currencyInput.value = this.defaultValue;
        this.currencyInput._lastGoodValue = this.defaultValue;
        this._modifiedByUser = false;
        return;
    }
    if (this.amountType == this.AMOUNT_TYPE_PERCENT) {
        this.currencyInput.value = value;
        this.currencyInput._lastGoodValue = value;
    } else {
        this.currencyInput.value = Util.toCurrency(value, {noSymbol: true});
        this.currencyInput._lastGoodValue = Util.toCurrency(value, {noSymbol: true});
    }

    this._modifiedByUser = false;
};

CurrencyInput.prototype.getValidationRuleSet = function () {
    var message =  "Please enter a valid " + this.valueTitle;
    if (!isNaN(this.min) && !isNaN(this.max)) {
        message += " (" + this.min + " to " + this.max + ")";
    } else if (!isNaN(this.min)){
        message += " (min: " + this.min + ")";
    } else if (!isNaN(this.max)) {
        message += " (max: " + this.max + ")";
    }

    message += ".";

    return new RuleSet()
        .live(true)
        .number(this.currencyInput, {min: this.min, max: this.max, required: true}, message);
};

CurrencyInput.prototype.setEnable = function (enable) {
    this.currencyInput.disabled = !enable;
    Dom.toggleClass(this.node(), "Disabled", !enable);
};

CurrencyInput.prototype.setEnableSwitchMode = function (enable) {
    this.enabledSwicthMode = enable;
    Dom.toggleClass(this.node(), "EnabledSwitchMode", enable);
};

CurrencyInput.prototype.amountIconTypeClickedHandler = function () {
    if (!this.enabledSwicthMode) return;
    if (this.currencyInput.readOnly) return;
    if (this.currencyInput.disabled) return;
    this.amountTypePopup.show(this.amountIconType, "left-inside", "bottom", 0, 0, true);
};

CurrencyInput.prototype.switchToDollarMode = function () {
    this.amountTypePopup.hide();
    if (this.amountType == this.AMOUNT_TYPE_DOLLAR) return;
    this.amountType = this.AMOUNT_TYPE_DOLLAR;
    Dom.addClass(this.node(), "AmountTypeDollar");
    Dom.removeClass(this.node(), "AmountTypePercent");
    Dom.emitEvent("p:CurrencyTypeChanged", this.node());
};

CurrencyInput.prototype.switchToPercentMode = function () {
    this.amountTypePopup.hide();
    if (this.amountType == this.AMOUNT_TYPE_PERCENT) return;
    this.amountType = this.AMOUNT_TYPE_PERCENT;
    Dom.removeClass(this.node(), "AmountTypeDollar");
    Dom.addClass(this.node(), "AmountTypePercent");
    Dom.emitEvent("p:CurrencyTypeChanged", this.node());
};

CurrencyInput.prototype.isPercentMode = function () {
    return this.amountType == this.AMOUNT_TYPE_PERCENT;
};

CurrencyInput.prototype.setPlaceHolder = function (text) {
    this.currencyInput.setAttribute("placeholder", Util.toCurrency(text, {noSymbol: true}));
};

CurrencyInput.prototype.getFocusNode = function () {
    return this.currencyInput;
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/QuantityInput.js";

function QuantityInput(option) {
    BaseTemplatedWidget.call(this);

    this.setOption(option);

    this.bind("click", this._handleChangeQuantity.bind(this, false), this.decreaseQuantityButton);
    this.bind("click", this._handleChangeQuantity.bind(this, true), this.increaseQuantityButton);
    this.bind("input", function (event) {
        this._invalidateQuantityButtonWith(this.quantityInput.value);
        if (!ValidationManager.run(this.getValidationRuleSet())) return;
        var value = parseInt(this.quantityInput.value, 10);
        if (isNaN(value)) return;
        this._fireValueChangedEvent();
    }, this.quantityInput);
}

__extend(BaseTemplatedWidget, QuantityInput);

QuantityInput.prototype._handleChangeQuantity = function (isIncrease) {
    var value = parseInt(this.quantityInput.value, 10);
    if (isNaN(value)) return;
    value = value + (isIncrease ? 1 : -1);
    if ((!isNaN(this.min) && value < this.min && !isIncrease) || (!isNaN(this.max) && value > this.max && isIncrease)) return;
    this._setQuantityInputValue(value);
    if (ValidationManager.run(this.getValidationRuleSet())) {
        this._fireValueChangedEvent();
    };
};

QuantityInput.prototype._fireValueChangedEvent = function () {
    Dom.emitEvent("p:QuantityValueChanged", this.node(), {value: this.getValue()});
};

QuantityInput.prototype.setOption = function (option) {
    if (!option) return;
    this.max = option.max;
    this.min = option.min;
};

QuantityInput.prototype.focus = function () {
    this.quantityInput.focus();
};
QuantityInput.prototype.getValidationUITarget = function () {
    return this.quantityInput;
};

QuantityInput.prototype.setEnable = function (enable) {
    this.quantityInput.disabled = !enable;
    Dom.toggleClass(this.node(), "Disabled", !enable);
    Dom.toggleClass(this.increaseQuantityButton, "Disabled", !enable);
    Dom.toggleClass(this.decreaseQuantityButton, "Disabled", !enable);
};

QuantityInput.prototype.setValue = function (value) {
    this._setQuantityInputValue(value);

};

QuantityInput.prototype.getValue = function () {
    return Util.getInputValueAsIntNumber(this.quantityInput.value, 0);
};

QuantityInput.prototype._setQuantityInputValue = function (value) {
    this.quantityInput.value = value;
    this._invalidateQuantityButtonWith(value);
};

QuantityInput.prototype.getValidationRuleSet = function () {
    var message =  "Please enter a valid quantity";
    if (!isNaN(this.min) && !isNaN(this.max)) {
        message += " (" + (this.min >= this.max ? ("max: " + this.max) : (this.min + " to " + this.max)) + ")";
    } else if (!isNaN(this.min)){
        message += " (min: " + this.min + ")";
    } else if (!isNaN(this.max)) {
        message += " (max: " + this.max + ")";
    }

    message += ".";

    return new RuleSet()
        .live(true)
        .number(this.quantityInput, {min: this.min, max: this.max, required: true, isInteger: true}, message);
};

QuantityInput.prototype._invalidateQuantityButtonWith = function (value) {
    var invalidValue = isNaN(value) || isNaN(parseInt(value));
    Dom.toggleClass(this.decreaseQuantityButton, "Disabled", invalidValue || !isNaN(this.min) && (value <= this.min || !isNaN(this.max) && value <= Math.min(this.min, this.max)));
    Dom.toggleClass(this.increaseQuantityButton, "Disabled", invalidValue || !isNaN(this.max) && value >= this.max);
};

if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/BarChartView.js";

function BarChartView(n) {
    BaseTemplatedWidget.call(this);
}
__extend(BaseTemplatedWidget, BarChartView);


BarChartView.prototype.onAttached = function (firstAttached) {
    if (!firstAttached) return;
    this.init();
};

BarChartView.prototype.init = function () {
    // set the dimensions and margins of the graph
    var margin = {top: 30, right: 30, bottom: 70, left: 60},
        width = this.node().offsetWidth - margin.left - margin.right,
        height = this.node().offsetHeight - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select(this.chartContainer)
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
              
    var data = [
        {
            name: "United States",
            value: 12394,
            count: 100
        },
        {
            name: "Russia",
            value: 6148,
            count: 77
        },
        {
            name: "Germany (FRG)",
            value: 1653,
            count: 6
        },
        {
            name: "France",
            value: 2162,
            count: 214
        },
        {
            name: "United Kingdom",
            value: 1214,
            count: 54
        },
        {
            name: "China",
            value: 1131,
            count: 12
        },
        {
            name: "Spain",
            value: 814,
            count: 199
        },
        {
            name: "Netherlands",
            value: 1167,
            count: 34
        },
        {
            name: "Italy",
            value: 660,
            count: 10
        },
        {
            name: "Israel",
            value: 1263,
            count: 160
        }
    ];
    
    
    // X axis
    var x = d3.scaleBand()
      .range([ 0, width ])
      .domain(data.map(function(d) { return d.name; }))
      .padding(0.2);
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
        // .attr("transform", "translate(0,0)rotate(-90)")
        // .style("text-anchor", "end");

    // Add Y axis
    var y1 = d3.scaleLinear()
      .domain([0, 1.1 * d3.max(data.map(function(d) { return d.value; }))])
      .range([ height, 0]);
      
    svg.append("g")
      .call(d3.axisLeft(y1));
      
    var y2 = d3.scaleLinear()
        .domain([0, 1.1 * d3.max(data.map(function(d) { return d.count; }))])
        .range([ height, 0]);
        
    // svg.append("g")
    //   .call(d3.axisLeft(y2));
        
    // Bars 1
    svg.selectAll(":scope")
        .data(data)
        .enter()
        .append("g")
            .attr("class", "Group")
            .append("rect")
                .attr("x", function(d) { return x(d.name); })
                .attr("y", function(d) { return y1(d.value); })
                .attr("width", x.bandwidth())
                .attr("height", function(d) { return height - y1(d.value); })
                .attr("fill", "#69b3a2")
                .select(function() { return this.parentNode; })
            .append("rect")
                .attr("x", function(d) { return x(d.name) + (x.bandwidth() * 0.2); })
                .attr("y", function(d) { return y2(d.count); })
                .attr("width", x.bandwidth() * 0.6)
                .attr("height", function(d) { return height - y2(d.count); })
                .attr("fill", "#FF0000CC")
                .select(function() { return this.parentNode; })
            .append("text")
                .attr("x", function(d) { return x(d.name) + x.bandwidth() / 2; })
                .attr("y", function(d) { return y1(d.value) - 2; })
                .text(function(d) { return d.value; })
                .style("text-anchor", "middle")
                .select(function() { return this.parentNode; })
            .append("text")
                .attr("x", function(d) { return x(d.name) + x.bandwidth() / 2; })
                .attr("y", function(d) { return y2(d.count) - 2; })
                .text(function(d) { return d.count; })
                .style("text-anchor", "middle")
                .select(function() { return this.parentNode; })
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/BaseActionAdapter.js";

function BaseActionAdapter() {
    this.actionItems = [];
    this._actionKeyGetter = function(action) {
        if (typeof(action.id) == "undefined") return action.key;
        return action.id;
    }
    this.actionMenuItemComparer = function(a, b) {
        if (!this._actionKeyGetter(a) || !this._actionKeyGetter(b)) return false;
        return this._actionKeyGetter(a) == this._actionKeyGetter(b);
    }.bind(this);
}

BaseActionAdapter.prototype.combineActions = function(orgItems, targetItems) {
    orgItems = orgItems || [];
    targetItems = targetItems || [];
    var combineItems = orgItems.length ? [].concat(orgItems) : [];
    targetItems.forEach(function(tItem) {
        var isRegNew = true;
        if (this._actionKeyGetter(tItem)) {
            var i = Util.findItemByComparer(orgItems, tItem, this.actionMenuItemComparer);
            if (i > -1) {
                isRegNew = false;
                combineItems[i] = tItem;
            }
        }
        if (isRegNew) combineItems.push(tItem);
    }.bind(this));
    return combineItems;
}

BaseActionAdapter.prototype.add = function(action) {
    var isRegNew = true;
    if (action.menuKey) {
        this.actionItems.forEach(function(item) {
            if (item.menuKey && item.menuKey == action.menuKey) {
                isRegNew = false;
                if (action.icon) item.icon = action.icon;
                var combineActions = this.combineActions(item.actions, action.actions);
                item.actions = combineActions;
            }
        }.bind(this));
    }
    if (isRegNew) this.actionItems.push(action);
}

BaseActionAdapter.prototype.getActions = function() {
    return this.actionItems;
}


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/DateTimeWidget.js";

function DateTimeWidget(n) {
    BaseTemplatedWidget.call(this);
    var thiz = this;
    this.withTimeInput = Dom.getAttributeAsBoolean(n, "with-time", false);
    this.useEndOfDay = Dom.getAttributeAsBoolean(n, "use-end-of-day", false);
    this.timezoneProviderName = Dom.getAttributeAsString(n, "timezone-provider", "local");
    this.useMonthYearMode = Dom.getAttributeAsBoolean(n, "use-month-year-mode", false);

    var formatName = Dom.getAttributeAsString(n, "format-name", this.withTimeInput ? "datetime_standard" :
    this.useMonthYearMode ? "monthyear" : "date_standard");
    this.format = Dom.getAttributeAsString(n, "format", DATE_FORMATS[formatName].format);

    this.showTimezone = Dom.getAttributeAsBoolean(n, "show-timezone", undefined);
    this.multiSelect = Dom.getAttributeAsBoolean(n, "multi-select", false);
    this.useExplicitCommitActions = Dom.getAttributeAsBoolean(n, "explicit-commit", false);
    Dom.setInnerText(this.commitButton, Dom.getAttributeAsString(n, "explicit-commit-action", "Select"));
    
    this.lazyInit = Dom.getAttributeAsBoolean(n, "lazy-init", false);

    this.selectedDates = [];

    this.timezoneProvider = TimezoneProviders[this.timezoneProviderName] || TimezoneProviders.auto;
    
    
    Dom.toggleClass(this.dateTimeBox, "InMonthYearMode", this.useMonthYearMode);
    Dom.toggleClass(this.dateTimeBox, "WithExplicitCommitActions", this.useExplicitCommitActions);
    Dom.toggleClass(this.dateTimeBox, "LinuxOS", Util.linux);

    Dom.toggleClass(this.timezoneInfoPane, "ExplicitTimezone", !this._shouldShowTimezone());
    
    if (!this.input) {
        this.input = document.createElement("input");
    }

    this.bind("click", function () {
        var m = this.month - 1;
        var y = this.year;
        if (m < 0) {
            m = 11;
            y --;
        }

        this.gotoMonth(m, y);
    }, this.prevMonthButton);
    this.bind("click", function () {
        var m = this.month + 1;
        var y = this.year;
        if (m > 11) {
            m = 0;
            y ++;
        }

        this.gotoMonth(m, y);
    }, this.nextMonthButton);
    this.bind("click", function (event) {
        var n = Dom.findUpwardForNodeWithData(event.target, "_data");
        if (!n) return;
        var m = this._getMomentFromData(n._data);

        if (!this.isInRange(m)) return;
        if (!this.isDateSelectable(this.getDateFromMomemt(m))) return;
        if (this.isMultiSelect()) {
            this._toggleMoment(m, "fromUserInput");
        } else {
            if (this.withTime() || this.useExplicitCommitActions) {
                this.lastSelectedData = n._data;
                this.invalidate();
                this.updateTimezoneLabel();
            } else {
                this._setMoment(m, "fromUserInput");
            }
        }
    }, this.dayGrid);


    this.bind("p:PopupShown", function () {
        this.header.setAttribute("active", true);
    }, this.monthInput);
    this.bind("p:PopupHidden", function () {
        this.header.removeAttribute("active");
    }, this.monthInput);

    this.bind("focus", function () {
        this.header.setAttribute("focused", true);
    }, this.yearInput);
    this.bind("blur", function () {
        this.header.removeAttribute("focused");
    }, this.yearInput);


    this.bind("focus", function () {
        this.header.setAttribute("focused", true);
    }, this.monthInput.node());
    this.bind("blur", function () {
        this.header.removeAttribute("focused");
    }, this.monthInput.node());

    this.bind("keypress", function (event) {
        if (this.pendingYearInputTimeout) window.clearTimeout(this.pendingYearInputTimeout);
        this.pendingYearInputTimeout = window.setTimeout(function () {
            this.gotoMonth(this.month, parseInt(this.yearInput.value, 10));
        }.bind(this), 300);
    }, this.yearInput);

    this.monthInput.comparer = Util.sameRelax;
    this.monthInput.renderer = function (m) {
        return moment.months()[m];
    };
    var months = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
    this.monthInput.setItems(months);

    if (this.useMonthYearMode) {

        this.monthGrid.innerHTML = "";
        var row = undefined;
        this.monthElements = [];
        for (var i = 0; i < months.length; i ++) {
            if (!row || i % 3 == 0) {
                row = document.createElement("hbox");
                this.monthGrid.appendChild(row);
            }
            var monthName = (i + 1);
            var span = document.createElement("span");
            span.setAttribute("title", moment.months()[i]);
            span._month = i;
            span.innerHTML = Dom.htmlEncode(monthName);
            this.monthElements.push(span);
            row.appendChild(span);
        }

        this.bind("click", function (event) {
            var n = Dom.findUpwardForNodeWithData(event.target, "_month");
            if (!n) return;
            var selectedMonth = n._month;

            var m = this._getLastSelectedMoment() || this._getDefaultMoment();
            var year = parseInt(this.yearInput.value, 10);
            m.set("month", selectedMonth);
            m.set("date", 1);

            if (year && !isNaN(year)) {
                m.set("year", year);
            }
            this._setMoment(m, "fromUserInput");
        }, this.monthGrid);

        this.bind("click", function () {
            var m = this.month;
            var y = this.year -1;
            if (y < 0) y = 0;
            this.gotoMonth(m, y);

            var m = this._getLastSelectedMoment() || this._getDefaultMoment();
            m.set("year", y);
            this._setMoment(m, "fromUserInput");

        }, this.prevYearButton);
        this.bind("click", function () {
            var m = this.month;
            var y = this.year + 1;
            this.gotoMonth(m, y);

            var m = this._getLastSelectedMoment() || this._getDefaultMoment();
            m.set("year", y);
            this._setMoment(m, "fromUserInput");

        }, this.nextYearButton);

    }
    this.bind("p:ItemSelected", function (ev) {
        if (!ev.fromUser) return;
        this.gotoMonth(this.monthInput.getSelectedItem(), this.year);
        // this.monthInput.node().focus();
    }, this.monthInput);

    this.firstWeekDay = 0;

    for (var i = 0; i < 7; i ++) {
        var wd = (i + this.firstWeekDay) % 7;
        var span = document.createElement("span");
        span.innerHTML = Dom.htmlEncode(moment.weekdaysShort(wd));
        this.weakDayRow.appendChild(span);
        span.setAttribute("flex", "1");
        span.setAttribute("wd", "" + wd);
        span._weekDay = wd;
    }

    this.days = [];
    for (var k = 0; k < 6; k ++) {
        var row = document.createElement("hbox");
        this.dayGrid.appendChild(row);
        for (var i = 0; i < 7; i ++) {
            var wd = (i + this.firstWeekDay) % 7;

            var span = document.createElement("span");
            span.innerHTML = "" + (k * 7 + i + 1);
            span.setAttribute("flex", "1");
            span._weekDay = i;
            span._dayIndex = k * 7 + i;
            span._rowIndex = k;
            span.setAttribute("wd", "" + wd);
            row.appendChild(span);
            this.days.push(span);
        }
    }

    this.amInput.renderer = function (s) {
        return s.toUpperCase();
    };
    this.amInput.comparer = Util.sameRelax;
    this.amInput.setItems(["am", "pm"]);

    var commitChange = function () {
        var m = this._getLastSelectedMoment();
        if (!this.isInRange(m)) return;

        this._setMoment(m, "fromUserInput");
    };

    this.bind("click", commitChange, this.selectButton);
    this.bind("click", commitChange, this.commitButton);
    this.bind("click", function () {
    }, this.cancelButton);

    this.bind("input", function () {
        this.updateTimezoneLabel();
    }, this.timeRow);
    this.bind("p:ItemSelected", function () {
        this.updateTimezoneLabel();
    }, this.timeRow);
    this.bind("p:Input", function () {
        this.updateTimezoneLabel();
    }, this.timeRow);
    this.validationRules = this.getValidationRuleSet();
    this.bind("keyup", this._handleInputKeyupEvent, this.input);
    this.bind("change", function () {
        console.log("!@# value change");
        Dom.emitEvent("_setSelectedDateUpdated", this.node(), {});
    }, this.input);
    
    if (!this.lazyInit) this._updateView();
}

__extend(BaseTemplatedWidget, DateTimeWidget);

DateTimeWidget.prototype.onAttached = function () {
};
DateTimeWidget.prototype.getValidationUITarget = function () {
    return this.input;
};
DateTimeWidget.prototype.getFocusNode = function () {
    return this.input;
};

DateTimeWidget.prototype.boot = function () {
    if (this._boot) return;
    this._updateView();
    this._boot = true;
};

DateTimeWidget.prototype._getDefaultMoment = function () {
    return moment.tz(this.getTZID());
};

DateTimeWidget.prototype._updateView = function () {
    var m = this._getMoment() || this._getDefaultMoment();
    if (this.isMultiSelect()) {
        this.selectedDates = this._getMoments();
        if (this.selectedDates && this.selectedDates.length > 0) {
            m = this.selectedDates[0];
        } else {
            this.selectedDates = [];
        }
    }
    
    this.lastSelectedData = this._getMoment() ? {
        year: m.year(),
        month: m.month(),
        date: m.date()
    } : null;
    
    this.gotoMonth(m.month(), m.year());

    if (this.withTime()) {
        this.hourInput.value = m.format(this.use24h() ? "HH" : "hh");
        this.minuteInput.value = m.format("mm");
        this.secondInput.value = m.format("ss");
        if (!this.use24h()) {
            this.amInput.selectItem(m.format("a"));
        }
    }

    Dom.toggleClass(this.timeRow, "Disabled", !this.withTime());
    Dom.toggleClass(this.timeRow, "WithoutMinute", !this.withMinute());
    Dom.toggleClass(this.timeRow, "WithoutSecond", !this.withSecond());
    Dom.toggleClass(this.timeRow, "Use24H", this.use24h());

    if (!this.inputConfigured) {
        Util.enforceNumberInput(this.hourInput, true, 0, this.use24h() ? 23 : 12, 2);
        Util.enforceNumberInput(this.minuteInput, true, 0, 59, 2);
        Util.enforceNumberInput(this.secondInput, true, 0, 59, 2);
        Util.enforceNumberInput(this.yearInput, true, 0, 5000, 4);
        this.inputConfigured = true;
    }

    this.updateTimezoneLabel();
    this.invalidate();
};

DateTimeWidget.prototype.getTZID = function () {
    return this.timezoneProvider.getTimezoneId();
};
DateTimeWidget.prototype._shouldShowTimezone = function () {
    if (typeof(this.showTimezone) == "undefined") {
        return !this.timezoneProvider.isImplicit || !this.timezoneProvider.isImplicit();
    } else {
        return this.showTimezone;
    }
};
DateTimeWidget.prototype.onDetached = function() {
};
DateTimeWidget.prototype.updateTimezoneLabel = function () {
    this.timezoneLabel.innerHTML = this.getTimezoneTextInfo();
};
DateTimeWidget.prototype.getTimezoneTextInfo = function () {
    var m = null;
    if (this.lastSelectedData) {
        m = this._getMomentFromData(this.lastSelectedData);
    }

    var zone = moment.tz.zone(this.getTZID());
    var offset = Math.round((0 - zone.offset(m || this.getDate() || new Date())) / 60);
    if (offset > 0) {
        offset = " (GMT<strong>+" + offset + "</strong>)";
    } else if (offset < 0) {
        offset = " (GMT<strong>" + offset + "</strong>)";
    } else {
        offset = "";
    }
    return Dom.htmlEncode(this.timezoneProvider.getName()) + ": " + (zone.name + offset);

};
DateTimeWidget.prototype.focus = function () {
    this.input.focus();
};
DateTimeWidget.prototype.withTime = function () {
    return this.withTimeInput;
};
DateTimeWidget.prototype.use24h = function () {
    return this.getFormat().indexOf("H") >= 0;
};
DateTimeWidget.prototype.withMinute = function () {
    return this.getFormat().indexOf("m") >= 0;
};
DateTimeWidget.prototype.withSecond = function () {
    return this.getFormat().indexOf("s") >= 0;
};

DateTimeWidget.prototype.gotoMonth = function (month, year) {
    this.month = month;
    this.year = year;
    var timeRange = this._getTimeRange(month, year);
    var next = () => {
        this.invalidate();
        if (this.onMonthChanged) {
            this.onMonthChanged(timeRange.startDate, timeRange.endDate, month, year);
        }
    }
    if (this.onBeforeMonthChanged) {
        this.onBeforeMonthChanged(timeRange.startDate, timeRange.endDate, month, year, next);
    } else {
        next();
    }
};
DateTimeWidget.prototype._getTimeRange = function (month, year) {
    var m = moment.tz({year: year, month: month, date: 1, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    
    var padding = (m.day() - this.firstWeekDay + 7) % 7;
    m.subtract(padding, "days");
    var startDate = this.getDateFromMomemt(m.startOf('day'));
    
    m.add(this.days.length, "days");
    var endDate = this.getDateFromMomemt(m.endOf('day'));
    return {
        startDate: startDate,
        endDate: endDate
    };
};
DateTimeWidget.prototype.getDateFromMomemt = function (m) {
    return new Date(m.toDate().getTime());
};
DateTimeWidget.prototype.getCurrentTimeRange = function () {
    return this._getTimeRange(this.month, this.year);
};
DateTimeWidget.prototype.getFormat = function () {
    var javaFormat = this.format || DateTimeWidget.GLOBAL_FORMAT || (this.withTime() ? DateTimeWidget.DEFAULT_DATE_TIME_FORMAT :
    (this.useMonthYearMode ? DateTimeWidget.DEFAULT_MONTH_YEAR_FORMAT : DateTimeWidget.DEFAULT_DATE_FORMAT));
    var momentFormat = FormatUtil.javaToMomentFormat(javaFormat);

    return momentFormat;
};
DateTimeWidget.prototype._handleInputKeyupEvent = function (event) {
    ValidationManager.run(this.validationRules);
    if (event.keyCode == DOM_VK_ENTER || event.keyCode == DOM_VK_RETURN) {
        var m = this._getMoment();
        if (m)  {
            Dom.emitEvent("_setSelectedDateUpdated", this.node(), {});
        }
    }
};
DateTimeWidget.prototype._getMoment = function (s) {
    if (this._valueTarget) {
        return moment.tz(this._valueTarget.getDate(), this.getTZID());
    }

    var dateString = this.input && this.input.value || "";
    if(s) dateString = s;
    var format = this.getFormat();
    var m = moment.tz(dateString, format, this.getTZID());
    if (!m.isValid()) return null;
    if (this.withTime()) return m;
    return this.useEndOfDay ? m.endOf("day") : m.startOf("day");
};
DateTimeWidget.prototype.getDate = function () {
    var m = this._getMoment();
    if (!m || !this.isInRange(m)) return null;
    return this.getDateFromMomemt(m);
};
DateTimeWidget.prototype._getMomentFromData = function (data) {
    var spec = null;

    if (this.withTime()) {
        var hour = parseInt(this.hourInput.value, 10);
        if (!this.use24h()) {
            if (hour < 0 || hour > 12) hour = 0;
            if (this.amInput.getSelectedItem() == "pm") {
                if (hour < 12) hour += 12;  //12:30 PM --> 12:30
            } else {
                if (hour >= 12) hour -= 12; // 12:30 AM --> 00:30
            }
        }

        spec = {
            year: data.year,
            month: data.month,
            date: data.date,
            hour: hour,
            minute: this.withMinute() ? parseInt(this.minuteInput.value, 10) % 60 : 0,
            second: this.withSecond() ? parseInt(this.secondInput.value, 10) % 60 : 0,
            milisecond: 0
        };

    } else {
        spec = {
            year: data.year,
            month: data.month,
            date: data.date,
            hour: this.useEndOfDay ? 23 : 0,
            minute: this.useEndOfDay ? 59 : 0,
            second: this.useEndOfDay ? 59 : 0,
            milisecond: this.useEndOfDay ? 999 : 0
        };
    }

    return moment.tz(
        spec,
        this.getTZID());
};
DateTimeWidget.prototype._getLastSelectedMoment = function () {
    if (!this.lastSelectedData) return null;

    return this._getMomentFromData(this.lastSelectedData);
};
DateTimeWidget.prototype.invalidate = function () {
    if (this.invalidating) return;
    this.invalidating = true;
    
    var m = moment.tz({year: this.year, month: this.month, date: 1, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    var padding = (m.day() - this.firstWeekDay + 7) % 7;
    m.subtract(padding, "days");

    var current = this._getLastSelectedMoment() || this._getMoment();
    var today = moment.tz(this.getTZID());
    var currentMonth = m.month();
    var startInSelectedRangeMoment = this._selectedRange && this._selectedRange.startDate && moment.tz(this._selectedRange.startDate, this.getTZID());
    var endInSelectedRangeMoment = this._selectedRange && this._selectedRange.endDate && moment.tz(this._selectedRange.endDate, this.getTZID());
    var selectedRangeInMultipleRows = [];
    if (!this.useMonthYearMode) {
        for (var i = 0; i < this.days.length; i ++) {
            var span = this.days[i];
            span.innerHTML = "<label>" + m.date() + "</label>";
            span._data = {
                year: m.year(),
                month: m.month(),
                date: m.date()
            };
            if (this.dateDecorator) {
                this.dateDecorator(span, this.getDateFromMomemt(m));
            }
            
            Dom.toggleClass(span, "Inactive", m.month() != this.month);
            var isCurrent = current != null && current.isSame(m, "day");
            Dom.toggleClass(span, "Current", isCurrent);
            Dom.toggleClass(span, "Today", today.isSame(m, "day"));
            Dom.toggleClass(span, "OutOfRange", !this.isInRange(m));
            Dom.toggleClass(span, "Disabled", !this.isDateSelectable(this.getDateFromMomemt(m)));
            if (this.isMultiSelect()) {
                var index = this._getIndexOfDateInArray(this.selectedDates, m);
                if (index >= 0) {
                    Dom.addClass(span, "Current");
                } else {
                    Dom.removeClass(span, "Current");
                }
            } else if (this._selectedRange){
                var isInSelectedRange = this.isInSelectedRange(m);
                Dom.toggleClass(span, "Current", isInSelectedRange ? true : false);
                Dom.toggleClass(span, "Start", startInSelectedRangeMoment && startInSelectedRangeMoment.isSame(m, "day"));
                Dom.toggleClass(span, "End", endInSelectedRangeMoment && endInSelectedRangeMoment.isSame(m, "day"));
                if (isInSelectedRange) {
                    var rowIndex = span._rowIndex;
                    if (selectedRangeInMultipleRows.indexOf(rowIndex) < 0) selectedRangeInMultipleRows.push(rowIndex);
                }
            }
            m = m.add(1, "days");
        }
    }
    Dom.toggleClass(this.dayGrid, "SelectedRangeInSingleRow", selectedRangeInMultipleRows.length == 1);
    this.monthInput.selectItem(this.month);
    this.monthDisplay.innerHTML = Dom.htmlEncode(this.monthInput.renderer(this.month)) + " " + this.year;

    this.yearInput.value = "" + this.year;

    if (this.useMonthYearMode) {
        for (var i = 0; i < this.monthElements.length; i ++) {
            var span = this.monthElements[i];
            Dom.toggleClass(span, "Selected", span._month == this.month);
        }
    }
    this.invalidating = false;
};
DateTimeWidget.prototype.isInRange = function(momentDate) {
    return this._isInTimeRange(momentDate, this._minDate, this._maxDate);
}
DateTimeWidget.prototype.isInSelectedRange = function(momentDate) {
    return this._selectedRange && this._isInTimeRange(momentDate, this._selectedRange.startDate, this._selectedRange.endDate);
};
DateTimeWidget.prototype._isInTimeRange = function(momentDate, startDate, endDate) {
    if (!momentDate) return false;

    var inRange = false;
    var minDate = startDate;
    var maxDate = endDate;
    if (!minDate && !maxDate) {
        inRange = true;
    } else if (minDate && maxDate) {
        inRange = momentDate.valueOf() >= minDate.valueOf() && momentDate.valueOf() <= maxDate.valueOf();
    } else if (minDate) {
        inRange = momentDate.valueOf() >= minDate.valueOf();
    } else {
        inRange = momentDate.valueOf() <= maxDate.valueOf();
    }
    return inRange;
}

DateTimeWidget.prototype.isDateSelectable = function(date) {
    if (!date) return false;
    return true;
};
DateTimeWidget.prototype.setDate = function (date) {
    if (date) {
        this.input.value = moment.tz(date, this.getTZID()).format(this.getFormat());
    } else {
        this.input.value = "";
    }

    try {
        ValidationManager.run(this.validationRules);
    } catch (e) {}
};
DateTimeWidget.prototype.gotoDate = function (date) {
    this.setDate(date);
    var m = moment.tz(date, this.getTZID());
    this.lastSelectedData = {year: m.year(), month: m.month(), date: m.date()};
    if (m.month() == this.month && m.year() == this.year) {
        this.invalidate();
    } else {
        this.gotoMonth(m.month(), m.year());
    }
};
DateTimeWidget.prototype.setDates = function (dates) {
    if (dates && dates.length > 0) {
        var s = [];
        for (var i = 0; i < dates.length; i ++) {
            s.push(moment.tz(dates[i], this.getTZID()).format(this.getFormat()))
        }
        this.input.value = s.join(", ");
    } else {
        this.input.value = "";
    }
};
DateTimeWidget.prototype.setEnabled = function(enable) {
    Dom.setEnabled(enable, this.input);
    Dom.setEnabled(enable, this.pickerButton);
}
DateTimeWidget.prototype.setMinDate = function(date) {
    if (!date){
        delete this._minDate;
        this.invalidate();
        return;
    }
    this._minDate = moment(date);
    this.invalidate();
}
DateTimeWidget.prototype.setMaxDate = function(date) {
    if (!date) {
        delete this._maxDate;
        this.invalidate();
        return;
    }
    this._maxDate = moment(date);
    this.invalidate();
}
DateTimeWidget.prototype.setSelectedRange = function(selectedRange) {
    if (selectedRange) {
        this._selectedRange = selectedRange;
    } else {
        delete this._selectedRange;
    }
    this.invalidate();
}
DateTimeWidget.prototype._setMoment = function (m, fromUserInput) {

    if (this._valueTarget) {
        this._valueTarget.setDate(m ? this.getDateFromMomemt(m) : null);
        return;
    }

    if (m) {
        this.input.value = m.format(this.getFormat());
    } else {
        this.input.value = "";
    }
    if (fromUserInput) Dom.emitEvent("p:ValueUpdated", this.node(), {});
    ValidationManager.run(this.validationRules);
};

DateTimeWidget.DEFAULT_DATE_FORMAT = "MM/DD/YYYY";
DateTimeWidget.DEFAULT_DATE_TIME_FORMAT = "MM/DD/YYYY HH:mm";
DateTimeWidget.DEFAULT_MONTH_YEAR_FORMAT = "MM/YYYY";

DateTimeWidget.getDateFormat = function () {
    return (window.LOCALE && window.LOCALE.DATE_FORMAT) || window.DATE_FORMAT || DateTimeWidget.DEFAULT_DATE_FORMAT;
};
DateTimeWidget.getDateTimeFormat = function () {
    return (window.LOCALE && window.LOCALE.DATETIME_FORMAT) || window.DATETIME_FORMAT || DateTimeWidget.DEFAULT_DATE_TIME_FORMAT;
};
DateTimeWidget.getMonthYearFormat = function () {
    return (window.LOCALE && window.LOCALE.MONTH_YEAR_FORMAT) || window.MONTH_YEAR_FORMAT || DateTimeWidget.MONTH_YEAR_FORMAT;
};
DateTimeWidget.prototype.setCustomTimezoneProvider = function (provider) {
    this.timezoneProvider = provider;
    Dom.toggleClass(this.timezoneInfoPane, "ExplicitTimezone", !this._shouldShowTimezone());
};
DateTimeWidget.prototype.isMultiSelect = function () {
    return this.multiSelect;
};
DateTimeWidget.prototype._toggleMoment = function (m, fromUserInput) {
    if (m) {
        var index = this._getIndexOfDateInArray(this.selectedDates, m);
        if (index < 0) {
            this.selectedDates.push(m);
        } else {
            this.selectedDates.splice(index, 1);
        }
        var names = [];
        if (this.selectedDates.length > 0) {
            for (var i = 0; i < this.selectedDates.length; i++) {
                names.push(this.selectedDates[i].format(this.getFormat()))
            }
        }
        this.input.value = names.join(",");
        this.gotoMonth(m.month(), m.year());
    }
    if (fromUserInput) Dom.emitEvent("p:ValueUpdated", this.node(), {});
};
DateTimeWidget.prototype._getMoments = function () {
    if(!this.input.value) return;
    var s = this.input.value.trim().split(",");
    if(s.length == 0) return;
    var format = this.getFormat();
    var res = [];
    for(var i = 0; i < s.length; i ++) {
        if (!s[i]) continue;
        var m = this._getMoment(s[i]);
        if (m) res.push(m);
    }
    return res;
};

DateTimeWidget.prototype._getIndexOfDateInArray = function(arr, m) {
    if(!arr) return -1;
    if(arr.length == 0) return -1;
    var index = -1;
    for(var i = 0; i < arr.length; i++) {
        if(m.isSame(arr[i], "day")) {
            index = i;
            break;
        }
    }
    return index;
};

DateTimeWidget.prototype.getDates = function () {
    var res = [];
    if (this.isMultiSelect()) {
        var m = this._getMoments();
        if (m && m.length > 0) {
            for (var i = 0; i < m.length; i++) {
                res.push(this.getDateFromMomemt(m[i]));
            }
        }
    }
    return res;
};

DateTimeWidget.prototype.getValidationRuleSet = function () {
    var thiz = this;
    return new RuleSet()
        .live(true)
        .rule(new GenericRule(this.input, function () {
            var format = thiz.getFormat();
            if (thiz._valueTarget) {
                var m = moment(thiz._valueTarget.getDate(), format, true).tz(thiz.getTZID());
                return m && m.isValid();
            }

            function isDateStringValid(dateString, format) {
                if (dateString.length == 0) return true;
                var m = moment(dateString, format, true).tz(thiz.getTZID());
                return m && m.isValid();
            };

            if (thiz.isMultiSelect()) {
                var s = thiz.input.value.trim().split(",");
                if (s.length == 0) return true;
                for (var i = 0; i < s.length; i ++) {
                    if (!isDateStringValid(s[i].trim(), format)) return false;
                }
            } else {
                return isDateStringValid(thiz.input.value.trim(), format);
            }

            return true;

        }, "Please select a valid " + (this.useMonthYearMode ? "month year." : "date.")));
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/CalendarWidget.js";

function CalendarWidget(n) {
    BaseTemplatedWidget.call(this);
    this.actionAdapter = new BaseActionAdapter();
    this.selectedDate = new Date();
    
    this.firstWeekDay = Dom.getAttributeAsInt(n, "first-week-day", 0);
    this.itemDateKey = Dom.getAttributeAsString(n, "item-date-key", "");
    this.timezoneProviderName = Dom.getAttributeAsString(n, "timezone-provider", "local");
    this.timezoneProvider = TimezoneProviders[this.timezoneProviderName] || TimezoneProviders.auto;
    this.emptyMessage = Util.getProperty(n, "empty-message", "");
    if (this.emptyMessage) {
        this.emptyMessageWrapper.appendChild(Dom.newDOMElement({_name: "span", _text: this.emptyMessage}));
    }
    
    this.currentViewMode = Dom.getAttributeAsString(n, "fixed-view-mode", "");
    this.isViewModeFixed = this.currentViewMode ? true : false;
    Dom.toggleClass(this.viewModeActionContainer, "Inapplicabled", this.isViewModeFixed);
    if (!this.currentViewMode) {
        this.currentViewMode = Dom.getAttributeAsString(n, "default-view-mode", "day");
    }
    
    this.sidebarDisabled = Dom.getAttributeAsBoolean(n, "sidebar-disabled", false);
    Dom.toggleClass(this.node(), "SidebarDiabled", this.sidebarDisabled);
    
    this.sidebarTogglabled = Dom.getAttributeAsBoolean(n, "sidebar-togglabled", true);
    Dom.toggleClass(this.node(), "SidebarTogglabled", this.sidebarTogglabled);
    
    this.sidebarFullRangeSelected = !this.sidebarDisabled && Dom.getAttributeAsBoolean(n, "sidebar-full-range-selected", false);
    Dom.toggleClass(this.node(), "SidebarFullRangeSelected", this.sidebarFullRangeSelected);
    
    this.todayActionDisabled = Dom.getAttributeAsBoolean(n, "today-action-disabled", false);
    Dom.toggleClass(this.node(), "TodayAcionDisabled", this.todayActionDisabled);
    
    this.ignoreMonthSelectionIndicator = Dom.getAttributeAsBoolean(n, "ignore-month-selection-indicator", false);
    Dom.toggleClass(this.calendarContent, "MonthSelectionIndicatorIngored", this.ignoreMonthSelectionIndicator);


    this.maxItemsShowingOnMonthCell = Dom.getAttributeAsInt(n, "max-items-showing-on-month-cell", 0);
    
    this.bind("click", this.prevButtonClickedHandler, this.prevButton);
    this.bind("click", this.nextButtonClickedHandler, this.nextButton);
    
    this.bind("p:ValueUpdated", this.dateChangedHandler, this.dateSelector);
    this.bind("change", this.changedHandler, this.calendarContent);
    this.bind("click", this.handleChangeViewMode, this.viewModeActionContainer);
    this.bind("click", function (event) {
        var target = event.target;
        var collapseExpandActionNode = Dom.findParentWithClass(target, "ListCollapseExpandAction");
        if (collapseExpandActionNode) {
            this.handleListExpandCollapse(collapseExpandActionNode);
        }
    }, this.calendarContentActionPane);
    this.bind("click", function (event) {
        var target = event.target;
        var collapseExpandActionNode = Dom.findParentWithClass(target, "ListCollapseExpandAction");
        if (collapseExpandActionNode) {
            this.handleListExpandCollapse(collapseExpandActionNode);
        }
        
        var itemGroupNode = Dom.findParentWithClass(target, "ItemGroup");
        if (itemGroupNode) {
            this._showItemDetailInfoPopup(itemGroupNode, event, {forShowingOnPopup: true});
        }
        var slotItemNode = Dom.findParentWithClass(target, "SlotItem");
        if (this.currentViewMode == CalendarViewMode.MONTH && slotItemNode) {
            this._showItemDetailInfoPopup(slotItemNode, event, {forShowingOnPopup: true, onlyShowingSlotItem: true});
        }
    }, this.calendarContent);
    
    if (!this.sidebarDisabled) {
        this.bind("click", this.handleToggleSidebar.bind(this, true), this.collapseSidebarButton);
        this.bind("click", this.handleToggleSidebar.bind(this, false), this.expandSidebarButton);
    }
    
    this.bind("click", this.handleTodayAction, this.todayButton);
    this.bind("p:ItemSelected", this.handleExtraDatePickerChanged, this.extraDatePickerContainer);
    this.bind("p:ValueUpdated", this.handleExtraDatePickerChanged, this.extraDatePickerContainer);
    
    this.selectedDataIds = [];
    this.dateToItems = {};
    this.items = [];
    this._currentDateRange = {};
    
    this._registerViewModeHandlers();
    this._initItemDetailInfoPopup();
}
__extend(BaseTemplatedWidget, CalendarWidget);

const CalendarViewMode = {
    DAY: "day",
    WEEK: "week",
    MONTH: "month",
    LIST: "list"
};
const CALENDAR_DATE_FORMATS = {
    date_named_full_weekday: "dddd, MMMM DD, YYYY",
    date_month_only_named: "MMM DD",
    monthyear_named: "MMMM, YYYY",
    date_named: "MMM DD, YYYY",
    date_month_only: "MM/DD",
    datetime_standard_with_zone: "MM/DD/YYYY hh:mm a z"
};

CalendarWidget.prototype.setContentFragment = function (fragment) {
    this.viewTemplates = {};
    for (var i = 0; i < fragment.childNodes.length; i ++) {
        var node = fragment.childNodes[i];
        if (!node.getAttribute) continue;
    
        var role = node.getAttribute("role");
        if (role == "item") {
            this.viewTemplates[role] = node;
        } else if (role == "filters") {
            this.filtersWrapper.appendChild(node);
            this.withFilter = true;
        } else if (role == "sidebar-header-leading") {
            this.leadingSidebarHeader.appendChild(node);
        } else if (role == "sidebar-header-action-trailing") {
            this.trailingSidebarHeaderAction.appendChild(node);
        } else if (role == "action-leading") {
            this.leadingActionPane.appendChild(node);
        } else if (role == "action-trailing") {
            this.trailingActionPane.appendChild(node);
            Dom.removeClass(this.leadingSidebarHeader, "Inapplicabled");
        } else if (role == "summary") {
            this.summaryContentPane.appendChild(node);
            this.withSummaryContent = true;
        } else {
            this.viewTemplates[role] = node;
        }
    }
    if (this.withFilter) Dom.addClass(this.node(), "WithFilter");
    this._invalidateCalendarContentHeader();
};

CalendarWidget.prototype.onAttached = function () {
    Dom.emitEvent("p:onAttached", this.node());
    //this.reloadCalendar();
    
};

CalendarWidget.prototype.setup = function (options) {
    
    this.options = options || {};
    if (this.options.onBeforeSidebarMonthChanged) this.dateSelector.onBeforeMonthChanged = this.options.onBeforeSidebarMonthChanged;
    if (this.options.onSidebarMonthChanged) this.dateSelector.onMonthChanged = this.options.onSidebarMonthChanged;
    if (this.options.sidebarDateDecorator) this.dateSelector.dateDecorator = this.options.sidebarDateDecorator;
    if (this.options.isSidebarDateSelectable) this.dateSelector.isDateSelectable = this.options.isSidebarDateSelectable;
    if (this.options.selectedDate) this.selectedDate = this.options.selectedDate;
    if (this.options.customMonthViewDataGrouping) this.customMonthViewDataGrouping = this.options.customMonthViewDataGrouping;
    this.dateSelector.setDate(this.selectedDate);
    this.dateSelector.boot();
    if (this.options.setupItemInfoPopup) this.options.setupItemInfoPopup(this.itemDetailInfoContainer);
    this.setupDone = true;
    this._lastDayMonthCache = {};
};
CalendarWidget.prototype.setCustomTimezoneProvider = function (timezoneProvider) {
    this.timezoneProvider = timezoneProvider;
    this.dateSelector.setCustomTimezoneProvider(timezoneProvider);
    if (this.listTimeRangePicker) this.listTimeRangePicker.setCustomTimezoneProvider(timezoneProvider);
};

CalendarWidget.prototype.boot = function (onBooted) {
    if (this._boot) return;
    this.updateWithViewMode(onBooted);
    this._boot = true;
};
CalendarWidget.prototype._registerViewModeHandlers = function () {
    this.viewModeHandler = {};
    var thiz = this;
    function register(viewMode, dateRenderer, displayedDateRenderer, initExtraDateTimePicker) {
        thiz.viewModeHandler[viewMode] = {
            dateRenderer: dateRenderer.bind(thiz),
            displayedDateRenderer: displayedDateRenderer.bind(thiz),
            initExtraDateTimePicker: initExtraDateTimePicker ? initExtraDateTimePicker.bind(thiz) : null
        };
    }
    
    register(CalendarViewMode.DAY, this._renderDayView, () => { return this.formatDate(this.selectedDate, "date_named_full_weekday"); });
    register(CalendarViewMode.WEEK, this._renderWeekView, () => {
        return this.formatDate(this._currentDateRange.startDate, "date_month_only_named") + " - " + this.formatDate(this._currentDateRange.endDate, "date_named");
    });
    register(CalendarViewMode.MONTH, this._renderMonthView, () => {
        return this.formatDate(this.selectedDate, "monthyear_named");
    }, function (extraDatePickerContainer) {
        if (!this.sidebarDisabled) return;
        this.monthPicker = new DateTimePicker({
            "with-time": false,
            "use-end-of-day": false,
            "timezone-provider": this.timezoneProviderName,
            "show-timezone": true
        });

        this.monthPicker.setCustomTimezoneProvider(this.timezoneProvider);
        this.monthPicker.into(this.extraDatePickerContainer);
    });
    register(CalendarViewMode.LIST, this._renderListView, () => {
        return this.formatDate(this._currentDateRange.startDate, "date_month_only_named") + " - " + this.formatDate(this._currentDateRange.endDate, "date_named");
    }, function (extraDatePickerContainer) {
        if (!this.listTimeRangePicker) {
            this.listTimeRangePicker = new DateTimeRangePicker({
                "with-time": false,
                "use-end-of-day": false,
                "timezone-provider": this.timezoneProviderName
            });
            
            this.listTimeRangePicker.setCustomTimezoneProvider(thiz.timezoneProvider);
            var optionKeys = [
                DateTimeRangePicker.OPTIONS_TODAY_KEY,
                DateTimeRangePicker.OPTIONS_LAST_7_DAYS,
                DateTimeRangePicker.OPTIONS_NEXT_7_DAYS,
                DateTimeRangePicker.OPTIONS_THIS_MONTH_KEY,
                DateTimeRangePicker.OPTIONS_LAST_MONTH,
                DateTimeRangePicker.OPTIONS_NEXT_MONTH
            ];
            this.listTimeRangePicker.setCustomDateTimeOptionsByKeys(optionKeys);
            Dom.addClass(this.listTimeRangePicker.node(), "ListDateTimePicker");
            this.listTimeRangePicker.into(extraDatePickerContainer);
        }
    });
    
    this._initExtraDateTimePicker();
};

CalendarWidget.prototype._initExtraDateTimePicker = function () {
    Dom.empty(this.extraDatePickerContainer);
    Object.keys(this.viewModeHandler).forEach((viewMode, i) => {
        var initExtraDateTimePicker = this.viewModeHandler[viewMode].initExtraDateTimePicker;
        if (initExtraDateTimePicker) {
            var node = Dom.newDOMElement({ _name: "hbox", "class": "ExtraDateTimePicker " + viewMode});
            node._viewMode = viewMode;
            this.extraDatePickerContainer.appendChild(node);
            initExtraDateTimePicker(node);
        }
    });
};
CalendarWidget.prototype._initItemDetailInfoPopup = function () {
    this.itemDetailInfoPopup.shouldCloseOnBlur = function () { return true; };
    this.itemDetailInfoPopupOpened = false;
    this.bind("p:PopupHidden", function (e) {
        if (this.itemDetailInfoPopup._contentWrapperNode) {
            Dom.removeClass(this.itemDetailInfoPopup._contentWrapperNode, "ShowDetailInfo");
            var slotItemNode = Dom.findChildWithClass(this.itemDetailInfoPopup._contentWrapperNode, "SlotItem");
            var groupItemNode = Dom.findChildWithClass(this.itemDetailInfoPopup._contentWrapperNode, "ItemGroup");
            Dom.removeClass(slotItemNode, "ShownItem");
            Dom.removeClass(groupItemNode, "ShownItem");
        }
    }.bind(this), this.itemDetailInfoPopup);
};
CalendarWidget.prototype.setItemDetailInfoPopupClass = function (className) {
    this.itemDetailInfoPopup.setPopupClass(className);
};

CalendarWidget.prototype._showItemDetailInfoPopup = function (anchor, event, options) {
    var dateContainer = Dom.findParentWithClass(event.target, "DateContainer");
    this._showItemDetailInfoPopupImpl(dateContainer, event, options);
};
CalendarWidget.prototype._showItemDetailInfoPopupImpl = function (dateContainer, event, options) {
    if (!dateContainer) return;
    
    if (this.itemDetailInfoPopup.isVisible()) {
        this.itemDetailInfoPopup.close();
    }
    
    var contentWrapperNode = dateContainer.querySelector(".DateContentWrapper");
    if (!contentWrapperNode) return;

    var date = dateContainer._date;
    var items = this._getItemsFromDate(date);
    if (!items || !items.length) return;
    
    this.itemDetailInfoHeader.innerHTML = "";
    this.itemDetailInfoContentWrapper.innerHTML = "";
    
    if (this.options.itemPopupDecorator) this.options.itemPopupDecorator(this.itemDetailInfoContainer, date, items);
    var renderItems = items;
    var anchor = contentWrapperNode;
    if (options && options.onlyShowingSlotItem) {
        var slotItemNode = event ? Dom.findParentWithClass(event.target, "SlotItem") : null;
        if (slotItemNode) {
            anchor = slotItemNode;
            Dom.addClass(slotItemNode, "ShownItem");
        }
        renderItems = items.slice(0, this.maxItemsShowingOnMonthCell);
    } else {
        var groupItemNode = event ? Dom.findParentWithClass(event.target, "ItemGroup") : null;
        if (!groupItemNode) groupItemNode = Dom.findChildWithClass(dateContainer, "ItemGroup");
        if (groupItemNode) Dom.addClass(groupItemNode, "ShownItem");
        renderItems = items.slice(this.maxItemsShowingOnMonthCell, items.length);
    }
    this._renderItemView(this.currentViewMode, this.itemDetailInfoContentWrapper, renderItems, options);
    this.itemDetailInfoPopup.show(anchor, "right", "bottom", -Dom.getOffsetWidth(anchor), Math.round(Util.em() * 0.3), "autoFlip");
    Dom.addClass(contentWrapperNode, "ShowDetailInfo");
    this.itemDetailInfoPopup._contentWrapperNode = contentWrapperNode;
    this.itemDetailInfoPopup._date = date;
};
CalendarWidget.prototype.showItemDetailInfoPopupOnDate = function (date) {
    var dateKey = this._getDateKeyFromDate(date);
    if (!dateKey) return;
    var dateContainer = this.calendarContent.querySelector(".DateContainer[date-key='" + dateKey + "']");
    if (!dateContainer) return;
    this._showItemDetailInfoPopupImpl(dateContainer);
};

CalendarWidget.prototype.formatDate = function (date, formatName) {
    return moment.tz(date, this.getTZID()).format(this.getFormat(formatName));
};

CalendarWidget.prototype.getFormat = function (formatName) {
    var format = DATE_FORMATS[formatName];
    var javaFormat = format && DATE_FORMATS[formatName].format || null;
    var momentFormat = javaFormat && FormatUtil.javaToMomentFormat(javaFormat) || CALENDAR_DATE_FORMATS[formatName];
    return momentFormat;
};

CalendarWidget.prototype._formatDateTest = function (date) {
    return this.formatDate(date, "datetime_standard_with_zone");
};
CalendarWidget.prototype.updateWithViewMode = function (callback) {
    this.viewModeActionContainer.querySelectorAll("button").forEach((button, i) => {
        Dom.toggleClass(button, "Selected", button.getAttribute("mode") == this.currentViewMode);
    });
    this.calendarContent.setAttribute("view-mode", this.currentViewMode);
    this.mainPane.setAttribute("view-mode", this.currentViewMode);
    this._invalidateCalendarContentHeader(this.currentViewMode == CalendarViewMode.LIST);
    this.reloadCalendar(callback);
    
};
CalendarWidget.prototype._invalidateTodayAction = function () {
    var todayMoment = this._getTodayMoment();
    var selectedDate = this._getDateMoment(this.selectedDate);
    var active = todayMoment.isSame(selectedDate, "day");
    Dom.toggleClass(this.todayButton, "Active", active);
};
CalendarWidget.prototype._invalidateCalendarContentHeader = function (enabled) {
    Dom.toggleClass(this.calendarContentHeader, "Inapplicabled", !(this.withSummaryContent || enabled));
};
CalendarWidget.prototype.reloadCalendar = function (callback) {
    var thiz = this;
    if (thiz.options.onBeforeCalendarContentChanged) {
        var lastSelectedDate = this._year && this.getDateFromMomemt(moment.tz({year: this._year, month: this._month, date: this._date}, this.getTZID())) || null;
        thiz.options.onBeforeCalendarContentChanged(this.selectedDate, lastSelectedDate);
    }
    var m = this._getDateMoment(this.selectedDate);
    this._year = m.year();
    this._month = m.month();
    this._date = m.date();
    this._currentDateRange = this._getDateRange();
    
    this._invalidateSidebarDateSelectorRange();
    
    this.reloadCalendarData(function () {
        thiz.renderCalendarContentView();
        if (thiz.options.onCalendarContentChanged) thiz.options.onCalendarContentChanged();
        if (callback) callback();
    });
    
    this._invalidateTodayAction();
};
CalendarWidget.prototype._invalidateSidebarDateSelectorRange = function () {
    if (this.sidebarDisabled || !this.sidebarFullRangeSelected) {
        this.dateSelector.setSelectedRange(null);
        return;
    };
    var startDate = this._currentDateRange.startDate;
    var endDate = this._currentDateRange.endDate;
    if (this.currentViewMode == CalendarViewMode.MONTH) {
        var m = moment.tz({year: this._year, month: this._month, date: 1}, this.getTZID());
        startDate = this.getDateFromMomemt(m);
        endDate = this.getDateFromMomemt(m.endOf("month"));
    }
    this.dateSelector.setSelectedRange({startDate: startDate, endDate: endDate});
};
CalendarWidget.prototype.reloadCalendarData = function (callback) {
    var thiz = this;
    this._loadData(this._currentDateRange.startDate, this._currentDateRange.endDate, function () {
        thiz.renderCalendarContentView();
        if (thiz.options.onCalendarContentChanged) thiz.options.onCalendarContentChanged();
        
        thiz._invalidateActions();
        if (callback) callback();
    });
};
CalendarWidget.prototype._loadData = function (startDate, endDate, callback) {
    if (!this.options.loadData) {
        callback();
        return;
    }
    var thiz = this;
    this.options.loadData(startDate, endDate, function (results, totalItems) {
        // console.log("***loadData: " + thiz._formatDateTest(startDate), "-" ,thiz._formatDateTest(endDate));
        thiz.items = results || [];
        thiz.totalItems = totalItems || thiz.items.length;
        thiz._groupItemsByDate(thiz.items);
        if (thiz.options && thiz.options.onDataLoaded) {
            thiz.options.onDataLoaded(results, thiz.totalItems);
        }
        callback();
    }, function (error) {
        if (thiz.options && thiz.options.onDataLoadFailed) {
            thiz.options.onDataLoadFailed(startDate, endDate);
        }
        callback();
    });
};

CalendarWidget.prototype._getDateRange = function () {
    var startDate, endDate;
    var m = moment.tz({year: this._year, month: this._month, date: this._date, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    switch (this.currentViewMode) {
        case CalendarViewMode.MONTH:
            var range = this._getMonthViewTimeRange(this._month, this._year);
            startDate = range.startDate;
            endDate = range.endDate;
            break;
        case CalendarViewMode.WEEK:
            startDate = this.getDateFromMomemt(m.startOf('week'));
            endDate = this.getDateFromMomemt(m.endOf('week'));
            break;
        case CalendarViewMode.DAY:
            startDate = this.getDateFromMomemt(m);
            endDate = this.getDateFromMomemt(m);
            break;
        case CalendarViewMode.LIST:
            startDate = this._currentDateRange.startDate || this.getDateFromMomemt(m);
            endDate = this._currentDateRange.endDate || this.getDateFromMomemt(m);
            break;
        default:
            break;
    }
    
    startDate = this.getDateFromMomemt(this._getDateMoment(startDate).startOf("day"));
    endDate = this.getDateFromMomemt(this._getDateMoment(endDate).endOf("day"));
    
    console.log("time range:", this._formatDateTest(startDate), "-", this._formatDateTest(endDate));
    return {
        startDate: startDate,
        endDate: endDate
    }
};
CalendarWidget.prototype.getDateFromMomemt = function (m) {
    return new Date(m.toDate().getTime());
};

CalendarWidget.prototype.setItems = function (items, doneCallback) {
    this.items = items;
    Dom.empty(this.calendarContent);
    this.renderMonthView(this.calendarContent, items);
    if (doneCallback) doneCallback.apply(this);
};

CalendarWidget.prototype.setDate = function (date) {
    this._setSelectedDate(date);
};
CalendarWidget.prototype.getViewMode = function () {
    return this.currentViewMode;
};
CalendarWidget.prototype.getCurrentDateRange = function () {
    return this._currentDateRange;
};
CalendarWidget.prototype.getSelectedDate = function () {
    return this.selectedDate;
};
CalendarWidget.prototype.getTZID = function () {
    return this.timezoneProvider.getTimezoneId();
};
CalendarWidget.prototype._getDateMoment = function (date) {
    return moment.tz(date, this.getTZID());
};
CalendarWidget.prototype._getTodayMoment = function () {
    return this._getDateMoment(new Date());
};
CalendarWidget.prototype._getDateFromItem = function (item) {
    if (this.itemDateKey) {
        var d = item[this.itemDateKey];
        return d instanceof Date ? d : null;
    }
    return null;
};

CalendarWidget.prototype._getDateKeyFromItem = function (item) {
    var date = this._getDateFromItem(item);
    return this._getDateKeyFromDate(date);
};
CalendarWidget.prototype._getDateKeyFromDate = function (date) {
    if (!date || !(date instanceof Date)) return null;
    m = this._getDateMoment(date);
    return m.year() + "_" + m.month() + "_" + m.date();
};

CalendarWidget.prototype._groupItemsByDate = function (items) {
    this.dateToItems = {};
    items.forEach((item, i) => {
        var dateKey = this._getDateKeyFromItem(item);
        if (!dateKey) return;
        if (typeof(this.dateToItems[dateKey]) == "undefined") this.dateToItems[dateKey] = [];
        this.dateToItems[dateKey].push(item);
    });
};
CalendarWidget.prototype.getItemsFromDate = function (date) {
    return this._getItemsFromDate(date);
};
CalendarWidget.prototype._getItemsFromDate = function (date) {
    var dateKey = this._getDateKeyFromDate(date);
    return dateKey && this.dateToItems[dateKey] || null;
};
CalendarWidget.prototype.renderCalendarContentView = function () {
    Dom.empty(this.calendarContent);
    var viewModeHandler = this.viewModeHandler[this.currentViewMode].dateRenderer;
    if (!viewModeHandler) return;
    viewModeHandler = viewModeHandler.bind(this);
    viewModeHandler(this.calendarContent);
    this._invalidateDisplayedDate();
        
    this.extraDatePickerContainer.querySelectorAll(".ExtraDateTimePicker").forEach((node, i) => {
        Dom.toggleClass(node, "Inapplicabled", node._viewMode != this.currentViewMode);
    });
    Dom.toggleClass(this.calendarContentPane, "WithEmptyData", !(this.items && this.items.length));
};
CalendarWidget.prototype._invalidateDisplayedDate = function () {
    var displayedDateRenderer = this.customDisplayedDateRenderer || this.getDefaultDisplayedDateRenderer();
    var content = displayedDateRenderer(this.currentViewMode, this.selectedDate, this._cloneCurrentDateRange(), this.getTZID()) || "";
    Dom.setInnerText(this.displayedDate, content);
};
CalendarWidget.prototype.getDefaultDisplayedDateRenderer = function () {
    return this.viewModeHandler[this.currentViewMode].displayedDateRenderer;
};

CalendarWidget.prototype._getLastDayOfMonth = function (dateMoment) {
    var key = dateMoment.month() + "@" + dateMoment.year();
    var lastDayOfMonth = this._lastDayMonthCache[key];
    if (!lastDayOfMonth) {
        var date = this.getDateFromMomemt(dateMoment);
        lastDayOfMonth = this._getDateMoment(date).endOf("month").date();
        this._lastDayMonthCache[key] = lastDayOfMonth;
    }
    return lastDayOfMonth;
};

CalendarWidget.prototype._renderDateItemsView = function (container, dateMoment, today, selectedDateMoment, innerOptions) {
    var viewMode = this.currentViewMode;
    var date = this.getDateFromMomemt(dateMoment);
    
    var dateContainerNode = Dom.newDOMElement({ _name: innerOptions && innerOptions.dateContainerTagName || "vbox", flex: "1", "date-key": this._getDateKeyFromDate(date)});
    Dom.addClass(dateContainerNode, "DateContainer");
    if (today.isSame(dateMoment, "day")) Dom.addClass(dateContainerNode, "Today");
    if (selectedDateMoment.isSame(dateMoment, "day")) Dom.addClass(dateContainerNode, "Selected");
    if (dateMoment.month() != this._month) Dom.addClass(dateContainerNode, "Inactive");
    if (today.isAfter(dateMoment, "day")) Dom.addClass(dateContainerNode, "InPast");
    var lastDayOfMonth = this._getLastDayOfMonth(dateMoment);
    if (dateMoment.date() == lastDayOfMonth) Dom.addClass(dateContainerNode, "LastDayOfMonth");
    
    dateContainerNode._date = this.getDateFromMomemt(m);
    container.appendChild(dateContainerNode);
    
    if (innerOptions && innerOptions.dateContainerDecorator) {
        innerOptions.dateContainerDecorator(dateContainerNode, date);
    }
    
    var nodeWrapper = dateContainerNode;
    if (innerOptions && innerOptions.appendChildDateWrapper) {
        nodeWrapper = innerOptions.appendChildDateWrapper(dateContainerNode, date);
    }
    var headerNode = Dom.newDOMElement({ _name: "hbox", "class": "DateTitleWrapper"});
    if (innerOptions && innerOptions.headerPopulator) {
        innerOptions.headerPopulator(headerNode, date);
    }
    nodeWrapper.appendChild(headerNode);
    
    var contentBox = Dom.newDOMElement({ _name: "vbox", "class": "DateContentWrapper " + viewMode.toUpperCase(), flex: "1" });
    nodeWrapper.appendChild(contentBox);
    
    var items = this._getItemsFromDate(date);
    
    if (this.options.dateDecorator) this.options.dateDecorator(dateContainerNode, viewMode, date, items);
    
    if (!items || !items.length) return;
    
    Dom.addClass(contentBox, "WithData");
    
    if (CalendarViewMode.MONTH == viewMode) {
        if (this.customMonthViewDataGrouping) {
            var customData = this.customMonthViewDataGrouping(items);
            this._renderItemView(viewMode, contentBox, customData);
        } else {
            if (this.maxItemsShowingOnMonthCell) {
                var showItems = items.slice(0, this.maxItemsShowingOnMonthCell);
                this._renderItemView(viewMode, contentBox, showItems);
            }
            var groupedItemCount = items.length - this.maxItemsShowingOnMonthCell;
            if (groupedItemCount) {
                var groupNode = Dom.newDOMElement({
                        _name: "hbox", "class": "ItemGroup", flex: 1,
                        _children: [
                            { _name: "span", _text: groupedItemCount < items.length ? ("+" + groupedItemCount) : groupedItemCount, "class": "TotalValue"},
                            { _name: "span", _text: this._getItemGroupDisplayTitle(groupedItemCount), flex: 1, "class": "Label"},
                            { _name: "icon", "class": "play r90"}
                        ]
                    });
                contentBox.appendChild(groupNode);
            }
        }
        
    } else {
        this._renderItemView(viewMode, contentBox, items);
    }
};
CalendarWidget.prototype._getViewModeItemTemplate = function (viewMode) {
    var roleName = viewMode + "-item";
    return this.viewTemplates[roleName] || this.viewTemplates["item"];
};
CalendarWidget.prototype._renderItemView = function (viewMode, container, items, options) {
    var itemTemplate = this._getViewModeItemTemplate(viewMode);
    if (itemTemplate && this.populator) {
        items.forEach((item, i) => {
            var newNode = itemTemplate.cloneNode(true);
            this.createBinding(newNode);
            container.appendChild(newNode);
            this.populator(item, newNode._binding, newNode, viewMode, options);
            newNode._item = item;
            Dom.addClass(newNode, "Item");
            if (this.options.getDataKey) newNode.setAttribute("data-key", this.options.getDataKey(item));
        });
    }
};
CalendarWidget.prototype._renderDayView = function (container) {
    var thiz = this;
    var m = this._getDateMoment(this.selectedDate);
    this._renderDateItemsView(container, m, this._getTodayMoment(), m, {
        headerPopulator: function (headerNode) {
            var dayHeaderTemplate = thiz.viewTemplates["day-header"];
            if (dayHeaderTemplate) {
                headerNode.appendChild(dayHeaderTemplate.cloneNode(true));
            }
            Dom.toggleClass(headerNode, "Inapplicabled", dayHeaderTemplate ? false : true);
        }
    });
};
CalendarWidget.prototype._renderWeekView = function (container) {
    var weekDayToDates = {};
    var m = this._getDateMoment(this._currentDateRange.startDate);
    var endMoment =this._getDateMoment(this._currentDateRange.endDate);
    while (!m.isAfter(endMoment, "day")) {
        weekDayToDates[m.weekday()] = this.getDateFromMomemt(m);
        m = m.add(1, "days");
    }
    
    var today = this._getTodayMoment();
    var selectedDateMoment = this._getDateMoment(this.selectedDate);
    var weekdayContentNodes = {};
    
    var thiz = this;
    for (var i = 0; i < 7; i ++) {
        var wd = (i + this.firstWeekDay) % 7;
        var date = weekDayToDates[wd];
        m = this._getDateMoment(date);
        
        this._renderDateItemsView(container, m, today, selectedDateMoment, {
            headerPopulator: function (headerNode) {
                headerNode.appendChild(Dom.newDOMElement({ _name: "span", _text: moment.weekdaysShort(wd) + " " + thiz.formatDate(date, "date_month_only")}));
            }
        });
    }
};
CalendarWidget.prototype._renderListView = function (container) {
    var dateKeys = Object.keys(this.dateToItems);
    this.calendarContentActionPane.innerHTML = "";
    var hasData = dateKeys && dateKeys.length;
    var dateItems = {};
    if (hasData) {
        var m = this._getDateMoment(this._currentDateRange.startDate);
        var endMoment = this._getDateMoment(this._currentDateRange.endDate);
        while (!m.isAfter(endMoment, "day")) {
            var date = this.getDateFromMomemt(m);
            var items = this._getItemsFromDate(date);
            if (items && items.length) {
                var dateKey = this._getDateKeyFromDate(date);
                dateItems[dateKey] = {date: date, items: items};
            }
            m = m.add(1, "days");
        }
        hasData = Object.keys(dateItems).length;
    }
    this._invalidateCalendarContentHeader(hasData);
    
    if (this.listTimeRangePicker) {
        this.listTimeRangePicker.setRange({from: this._currentDateRange.startDate, to: this._currentDateRange.endDate});
    }
    
    if (!hasData) return;
    
    var today = this._getTodayMoment();
    var selectedDateMoment = this._getDateMoment(this.selectedDate);
    var thiz = this;
    
    Object.keys(dateItems).forEach((dateKey, i) => {
        var date = dateItems[dateKey].date;
        this._renderDateItemsView(container, this._getDateMoment(date), today, selectedDateMoment, {
            dateContainerDecorator: function (dateContainerNode) {
                Dom.addClass(dateContainerNode, "CollapseExpandWrapper CollapseMode");
            },
            headerPopulator: function (headerNode) {
                headerNode.appendChild(Dom.newDOMElement({ _name: "hbox", "class": "ListDateTitleWrapper ListCollapseExpandAction", flex: "1",
                    _children: [
                        {_name: "icon", "class": "chevron-right Expand ListCollapseExpandAction"},
                        {_name: "icon", "class": "chevron-down Collapse ListCollapseExpandAction"},
                        { _name: "div", flex: 1, _text: thiz.formatDate(date, "date_named_full_weekday")}
                    ]}
                ));
            }
        });
    });
    
    var expandAllButton = Dom.newDOMElement({
        _name: "button", "class": "ListCollapseExpandAction All Expand",
        _children: [
            {_name: "icon", "class": "plus"},
            {_name: "span", _text: "Expand"},
        ],
    });
    var collapseAllButton = Dom.newDOMElement({
        _name: "button", "class": "ListCollapseExpandAction All Collapse ",
        _children: [
            {_name: "icon", "class": "minus"},
            {_name: "span", _text: "Collapse"},
        ],
    });
    var hbox = Dom.newDOMElement({ _name: "hbox", "class": "CollapseExpandWrapper All CollapseExpandActionContainer CollapseMode"});
    hbox.appendChild(expandAllButton);
    hbox.appendChild(collapseAllButton);
    this.calendarContentActionPane.appendChild(hbox);
    
    if (Object.keys(dateItems).length == 1) {
        this._handleListExpandCollapseImpl(true, true);
    }
};

CalendarWidget.prototype._getItemGroupDisplayTitle = function (totalItems) {
    if (this.options.getItemGroupDisplayText) return this.options.getItemGroupDisplayText(totalItems);
    return "item(s)";
};

CalendarWidget.prototype._renderMonthView = function (container) {
    var today = this._getTodayMoment();
    var selectedDateMoment = this._getDateMoment(this.selectedDate);
    
    var monthTable = document.createElement("table"),
        thead = document.createElement("thead"),
        tbody = document.createElement("tbody"),
        headerRow = document.createElement("tr");
        
    Dom.addClass(headerRow, "Header");
    var mobileView = window.innerWidth <= BaseWidget.RESPONSIVE_BREAKPOINTS.md;
    var weekdays = moment.weekdays;
    if (mobileView) weekdays = moment.weekdaysShort;
    for (var i = 0; i < 7; i ++) {
        var wd = (i + this.firstWeekDay) % 7;
        var cell = document.createElement("th");
        cell.innerHTML = Dom.htmlEncode(weekdays(wd));
        headerRow.appendChild(cell);
    }
    thead.appendChild(headerRow);
    monthTable.appendChild(thead);
    
    var m = moment.tz({year: this._year, month: this._month, date: 1, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    var padding = (m.day() - this.firstWeekDay + 7) % 7;
    m = m.subtract(padding, "days");
    
    var index = 0, row;
    while ((m.month() <= this._month && m.year() <= this._year) || (m.month() > this._month && m.year() < this._year)) {
        if (index % 7 == 0) {
            row = document.createElement("tr");
            tbody.appendChild(row);
        }
        this._renderMonthBodyCell(row, m, today, selectedDateMoment);
        m = m.add(1, "days");
        index ++;
    }
    
    while (m.weekday() != this.firstWeekDay) {
        this._renderMonthBodyCell(row, m, today, selectedDateMoment);
        m = m.add(1, "days");
    }
    monthTable.appendChild(tbody);
    container.appendChild(monthTable);
};

CalendarWidget.prototype._renderMonthBodyCell = function (row, m, today, selectedDateMoment) {
    this._renderDateItemsView(row, m, today, selectedDateMoment, {
        dateContainerTagName: "td",
        appendChildDateWrapper: function (dateContainerNode) {
            var cellWrapper = Dom.newDOMElement({ _name: "div", "class": "CellWrapper"});
            dateContainerNode.appendChild(cellWrapper);
            return cellWrapper;
        },
        headerPopulator: function (headerNode) {
            headerNode.appendChild(Dom.newDOMElement({ _name: "div", flex: 1, _text: m.date()}));
        }
    });
};

CalendarWidget.prototype.createBinding = function (container) {
    container._binding = {};
    container._binding._node = container;
    widget.Util.performAutoBinding(container, container._binding, null, "forced");

    Dom.doOnChildRecursively(container, {
        eval: function(n) {
            return n.getAttribute && n.getAttribute("anon-id");
        }
    }, function(n) {
        var id = n.getAttribute("anon-id");
        if (container._binding) {
            container._binding[id] = n;
        }
        n.removeAttribute("anon-id");
        var newId = id + widget.random();
        n.setAttribute("id", newId);
        n.id = newId;
        Dom.addClass(n, "AnonId_" + id);
    });
};

CalendarWidget.prototype.prevButtonClickedHandler = function () {
    this._handleForDateNavigationAction();
};
CalendarWidget.prototype.getPrevDate = function () {
    var m = moment(this.selectedDate);
    switch (this.currentViewMode) {
        case CalendarViewMode.MONTH:
            m.subtract(1, "months");
            console.log("month", this.getDateFromMomemt(m));
            break;
        case CalendarViewMode.DAY:
            m.subtract(1, "days");
            break;
        case CalendarViewMode.WEEK:
            m.subtract(1, "weeks");
            break;
        default:
            break;
    }
    return this.getDateFromMomemt(m);
};

CalendarWidget.prototype._getMonthViewTimeRange = function (month, year) {
    var m = moment.tz({year: year, month: month, date: 1, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    var startPadding = (m.day() - this.firstWeekDay + 7) % 7;
    m.subtract(startPadding, "days");
    var startDate = this.getDateFromMomemt(m.startOf('day'));
    
    m = moment.tz({year: year, month: month, date: 1, hour: 0, minute: 0, second: 0, milisecond: 0}, this.getTZID());
    var endDateOfMonth = this.getDateFromMomemt(m.endOf('month'));
    
    var endPadding = 7 - ((m.day() + 1) - this.firstWeekDay + 7) % 7;
    if (endPadding > 0 && endPadding < 7) m.add(endPadding, "days");
    var endDate = this.getDateFromMomemt(m.endOf('day'));
    
    return {
        startDate: startDate,
        endDate: endDate
    };
};

CalendarWidget.prototype.nextButtonClickedHandler = function () {
    this._handleForDateNavigationAction("next");
};
CalendarWidget.prototype.getNextDate = function () {
    var m = moment(this.selectedDate);
    switch (this.currentViewMode) {
        case CalendarViewMode.MONTH:
            m.add(1, "months");
            break;
        case CalendarViewMode.DAY:
            m.add(1, "days");
            break;
        case CalendarViewMode.WEEK:
            m.add(1, "weeks");
            break;
        default:
            break;
    }
    return this.getDateFromMomemt(m);
};

CalendarWidget.prototype._handleForDateNavigationAction = function (forNextAction) {
    var next = (date) => {
        if (!date) return;
        this._setSelectedDate(date);
    }
    if (this.getCustomDateForNavigationAction) {
        this.getCustomDateForNavigationAction(forNextAction, this.selectedDate, this._cloneCurrentDateRange(), this.currentViewMode, (date) => {
            next(date);
        });
    } else {
        var date = this.getDateForNavigationAction(forNextAction);
        next(date);
    }
};
CalendarWidget.prototype._cloneCurrentDateRange = function () {
    return Object.assign({}, this._currentDateRange);
};
CalendarWidget.prototype.getDateForNavigationAction = function (forNextAction) {
    return forNextAction ? this.getNextDate() : this.getPrevDate();
};
CalendarWidget.prototype._setSelectedDate = function (date, withoutReloadCalendar) {
    this.selectedDate = date;
    this.dateSelector.gotoDate(this.selectedDate);
    if (!withoutReloadCalendar) this.reloadCalendar();
    if (this.onDateSelectedListener) this.onDateSelectedListener(this.selectedDate);
};

CalendarWidget.prototype.setDateSelectedListener = function(listener) {
    this.onDateSelectedListener = listener;
}
CalendarWidget.prototype.dateChangedHandler = function () {
    if (this.currentViewMode == CalendarViewMode.LIST) {
        this.currentViewMode = CalendarViewMode.DAY;
        this._setSelectedDate(this.dateSelector.getDate(), true);
        this.updateWithViewMode();
    } else {
        this._setSelectedDate(this.dateSelector.getDate());
    }
};

CalendarWidget.prototype.changedHandler = function (event) {
    if (Dom.hasClass(event.target, "ItemCheck")) {
        var selectedValue = event.target.value;
        if (isNaN(selectedValue)) return;
        var val = parseInt(selectedValue);
        if (event.target.checked) {
            this.selectedDataIds.push(val);
            Dom.addClass(Dom.findParentWithClass(event.target, "Item"), "Active");
        } else {
            var index = this.selectedDataIds.indexOf(val);
            if (index >= 0) {
                this.selectedDataIds.splice(index, 1);
                Dom.removeClass(Dom.findParentWithClass(event.target, "Item"), "Active");
            }
        }
        if (typeof(this.onSelectionChanged) == "function") {
            this.onSelectionChanged();
        }
    }
};

CalendarWidget.prototype.getSelectedDataIds = function () {
    return this.selectedDataIds;
};

CalendarWidget.prototype.handleChangeViewMode = function (event) {
    if (this.isViewModeFixed) return;
    
    var targetNode = event.target;
    var viewMode = targetNode.getAttribute("mode");
    if (!viewMode) return;
    this.currentViewMode = viewMode;
    this.updateWithViewMode();
};

CalendarWidget.prototype.handleListExpandCollapse = function (actionNode) {
    var wrapperNode = Dom.findParentWithClass(actionNode, "CollapseExpandWrapper");
    var isExpandAction = Dom.hasClass(wrapperNode, "CollapseMode");
    var appliedAll = Dom.hasClass(actionNode, "All");
    this._handleListExpandCollapseImpl(isExpandAction, appliedAll, actionNode);
};
CalendarWidget.prototype._handleListExpandCollapseImpl = function (isExpandAction, appliedAll, actionNode) {
    function handle(node) {
        Dom.toggleClass(node, "CollapseMode", !isExpandAction);
    }
    if (appliedAll) {
        this.calendarContent.querySelectorAll(".CollapseExpandWrapper").forEach((node, i) => {
            handle(node);
        });
        this.calendarContentActionPane.querySelectorAll(".CollapseExpandWrapper").forEach((node, i) => {
            handle(node);
        });
        
    } else {
        var parentNode = Dom.findParentWithClass(actionNode, "CollapseExpandWrapper");
        handle(parentNode);
    }
};

CalendarWidget.prototype.handleToggleSidebar = function (collapse) {
    Dom.toggleClass(this.node(), "WithoutSidebar", collapse);
};

CalendarWidget.prototype.handleTodayAction = function () {
    var date = new Date();
    this._currentDateRange = {
        startDate: date,
        endDate: date
    };
    this._setSelectedDate(date);
};

CalendarWidget.prototype.handleExtraDatePickerChanged = function (event) {
    if (this.currentViewMode == CalendarViewMode.LIST && this.listTimeRangePicker && event.fromUser) {
        var timeRange = this._getTimeRangeListDatePicker();
        this._currentDateRange.startDate = timeRange.startDate;
        this._currentDateRange.endDate = timeRange.endDate;
        this._setSelectedDate(timeRange.startDate);
    } else if (this.currentViewMode == CalendarViewMode.MONTH && this.monthPicker) {
        this._setSelectedDate(this.monthPicker.getDate());
    }
};
CalendarWidget.prototype._getTimeRangeListDatePicker = function () {
    var range = this.listTimeRangePicker.getRange();
    var startDate, endDate;
    var selectedDate = new Date();
    var m = this._getDateMoment(new Date());
    if (range.name) {
        switch (range.name) {
            case "today":
                startDate = this.getDateFromMomemt(m);
                endDate = this.getDateFromMomemt(m);
                break;
            case "last7Days":
                endDate = this.getDateFromMomemt(m);
                m.subtract(7, "days");
                startDate = this.getDateFromMomemt(m);
                break;
            case "next7Days":
                startDate = this.getDateFromMomemt(m);
                m.add(7, "days");
                endDate = this.getDateFromMomemt(m);
                break;
            case "thisMonth":
                startDate = this.getDateFromMomemt(m.startOf("month"));
                endDate = this.getDateFromMomemt(m.endOf("month"));
                break;
            case "lastMonth":
                m.subtract(1, "months");
                startDate = this.getDateFromMomemt(m.startOf("month"));
                endDate = this.getDateFromMomemt(m.endOf("month"));
                break;
            case "nextMonth":
                m.add(1, "months");
                startDate = this.getDateFromMomemt(m.startOf("month"));
                endDate = this.getDateFromMomemt(m.endOf("month"));
                break;
            default:
        }
    } else {
        startDate = range.from;
        endDate = range.to;
    }
    
    return {
        startDate: startDate,
        endDate: endDate
    }
};
CalendarWidget.prototype.getItemCount = function () {
    return this.items && this.items.length || 0;
};
CalendarWidget.prototype.createActionBarAction = function (action) {
    var thiz = this;
    return {
        isVisible: function () {
            if (typeof(action.visible) == "undefined") {
                return true;
            } else {
                if (typeof(action.visible) == "function") return action.visible(thiz.getItemCount(), thiz);
                return action.visible;
            }
        },
        isApplicable: function () {
            if (typeof(action.applicable) == "undefined") {
                if (action.selectionIndependent) return true;
                return thiz.getSelectedItemCount() > 0;
            } else {
                if (typeof(action.applicable) == "function") return action.applicable(thiz.getItemCount(), thiz);
                return action.applicable;
            }
        },
        getIcon: function () {
            return typeof action.icon == "function" ? action.icon() : action.icon;
        },
        getTitle: function () {
            return (typeof action.title == "function" ? action.title() : action.title);
        },
        run: function (event) {
            thiz._lastActionEventInfo = {
                alternative: event.shiftKey
            };
            action.run(thiz.items);
        },
        getGroup: function () {
            return (typeof action.group == "function" ? action.group() : action.group) || "No group";
        },
        id: action.id
    };
};
CalendarWidget.prototype.createActionMenuAction = function (action) {
    var thiz = this;
    return {
        title: action.title,
        icon: action.icon,
        run: function (event) {
            thiz._lastActionEventInfo = {
                alternative: event.shiftKey
            };

            action.run(thiz.items);
        },
        applicable: function () {
            if (typeof(action.applicable) == "undefined") {
                if (action.selectionIndependent) return true;
                return thiz.getSelectedItemCount() > 0;
            } else {
                if (typeof(action.applicable) == "function") return action.applicable(thiz.getItemCount(), thiz);
                return action.applicable;
            }
        },
        visible: function () {
            if (typeof(action.visible) == "undefined") {
                return true;
            } else {
                if (typeof(action.visible) == "function") return action.visible(thiz.getItemCount(), thiz);
                return action.visible;
            }
        },
        group: action.group
    };
};
CalendarWidget.prototype.registerActions = function (actions, title, icon) {
    var config = {
        "title": title,
        "icon": icon
    }
    this.registerActionsByConfig(actions, config);
};

CalendarWidget.prototype.registerActionsByConfig = function (actions, holderConfig) {
    var actionItem = {
        "title": holderConfig ? holderConfig.title : undefined,
        "icon": holderConfig ? holderConfig.icon : undefined,
        "menuKey": holderConfig ? holderConfig.menuKey : undefined,
        "actions": actions
    };
    this.actionAdapter.add(actionItem);
    this.buildActions();
};

CalendarWidget.prototype.buildActions = function() {
    var actions = this.actions || [];
    var thiz = this;
    actions.forEach(function(action) {
        if (action instanceof ActionMenu || action instanceof ActionBar) {
            try {
                thiz.sidebarActionBar.removeChild(action.node());
            } catch (e) {
            }
            try {
                thiz.includedSidebarActionBar.removeChild(action.node());
            } catch (e) {
            }
            try {
                thiz.middleActionBar.removeChild(action.node());
            } catch (e) {
            }
        }
    })

    this.actions = [];
    var actionItems = this.actionAdapter.getActions() || [];
    
    function createActions(actions, actionBarContainer) {
        var actionMenu;
        var actionBar;
        for (var i = 0; i < actions.length; i++) {
            var action = actions[i];
            if (action.important) {
                if (!actionBar) {
                    actionBar = new ActionBar();
                }
                actionBar.register(thiz.createActionBarAction(action));
            } else {
                if (!actionMenu) {
                    actionMenu = new ActionMenu();
                    actionMenu.setTitle({label: aItem.title || "Action", icon: aItem.icon});
                }
                actionMenu.register(thiz.createActionMenuAction(action));
            }
        };
        if (actionMenu) {
            thiz.actions.push(actionMenu);
            actionBarContainer.appendChild(actionMenu.node());
        }
        if (actionBar) {
            thiz.actions.push(actionBar);
            actionBarContainer.appendChild(actionBar.node());
        }
    }
    
    actionItems.forEach(function(aItem) {
        var actions = aItem.actions;
        
        var sidebarActions = actions.filter(a => a.sidebarAction);
        var middleActions = actions.filter(a => !a.sidebarAction);
        
        if (sidebarActions && sidebarActions.length) {
            createActions(sidebarActions, thiz.sidebarActionBar);
            createActions(sidebarActions, thiz.includedSidebarActionBar);
        }
        
        if (middleActions && middleActions.length) {
            createActions(middleActions, thiz.middleActionBar);
        }
    });
    this._invalidateActions();
};
CalendarWidget.prototype._invalidateActions = function () {
    if (!this.actions || !this.setupDone) return;
    this.actions.forEach(function (action) {
        action.invalidate();
    });
};
CalendarWidget.prototype.getListCollapsedKeys = function () {
    if (this.currentViewMode != CalendarViewMode.LIST) return [];
    
    var collapsedKeys = [];
    this.calendarContentPane.querySelectorAll(".CollapseExpandWrapper").forEach((node, i) => {
        if (Dom.hasClass(node, "CollapseMode")) {
            var key = Dom.hasClass(node, "All") ? "all" : node.getAttribute("date-key");
            if (key) collapsedKeys.push(key);
        }
    });
    return collapsedKeys;
};
CalendarWidget.prototype.collapseListItemsWithKeys = function (collapsedKeys) {
    if (this.currentViewMode != CalendarViewMode.LIST) return;
    if (!collapsedKeys || !collapsedKeys.length) return;
    this.calendarContentPane.querySelectorAll(".CollapseExpandWrapper").forEach((node, i) => {
        var key = Dom.hasClass(node, "All") ? "all" : node.getAttribute("date-key");
        Dom.toggleClass(node, "CollapseMode", collapsedKeys.indexOf(key) >= 0);
    });
};
CalendarWidget.prototype.getShownDateOnPopup = function () {
    return this.itemDetailInfoPopup.isVisible() && this.itemDetailInfoPopup._date || null;
};
CalendarWidget.prototype.invalidateSidebarDateSelector = function (onBeforeInvalidated, onDone) {
    var next = () => {
        this.dateSelector.invalidate();
        if (onDone) onDone();
    }
    
    if (onBeforeInvalidated) {
        var timeRange = this.dateSelector.getCurrentTimeRange();
        onBeforeInvalidated(timeRange.startDate, timeRange.endDate, next);
    } else {
        next();
    }
};


if (window) window.__currentScriptPath = "/framework/webui/framework/js/widget/ScrollableView.js";

function ScrollableView () {
    BaseTemplatedWidget.call(this);
    this.offset = 0;

    this.invalidate();

    // this.bind("click", function () {
    //     this.offset += this.getStep();
    //     this.invalidate();
    // }, this.previousButton);

    // this.bind("click", function () {
    //     this.offset -= this.getStep();
    //     this.invalidate();
    // }, this.nextButton);

    var thiz = this;
    var startScroll = null;
    var stopScroll = function () {
        if(startScroll) {
            console.log("stopScroll");
            clearInterval(startScroll);
            startScroll = null;
        }
    };
    this.bind("mousedown", function() {
        if(startScroll) stopScroll();
        startScroll = setInterval(function() {
            thiz.offset += thiz.getStep();
            thiz.invalidate();
        } , 50);
    }, this.previousButton);

    this.previousButton.addEventListener("mouseup", function() {
        thiz.previousButton.blur();
    }, false);
    this.previousButton.addEventListener("mouseout", function() {
        thiz.previousButton.blur();
    }, false);
    this.previousButton.addEventListener("focusout", function() {
        stopScroll();
    }, false)

    this.bind("mousedown", function() {
        if(startScroll) stopScroll();
        startScroll = setInterval(function() {
            thiz.offset -= thiz.getStep();
            thiz.invalidate();
        } , 50);
    }, this.nextButton);

    this.nextButton.addEventListener("mouseup", function() {
        thiz.nextButton.blur();
    }, false)
    this.nextButton.addEventListener("mouseout", function() {
        thiz.nextButton.blur();
    }, false);
    this.nextButton.addEventListener("focusout", function() {
        stopScroll();
    }, false)
    window.addEventListener("resize", function(ev){
        thiz.invalidate();
    },false)
    this.wheelAllow = true;
    this.addWheelHandle();
}

__extend(BaseTemplatedWidget, ScrollableView);

ScrollableView.prototype.setWheelAllow = function (value) {
    this.wheelAllow = value;
}

ScrollableView.prototype.addWheelHandle = function() {
    this.wheelHandle = function(ev) {
        if (this.wheelAllow) {
            this.offset -= event.deltaY;
            this.invalidate();
        }
    }
    this.bind("wheel", this.wheelHandle, this.node());
}

ScrollableView.prototype.getStep = function () {
    return 80;
};

ScrollableView.prototype.setContentFragment = function (fragment) {
    this.contentWrapper.appendChild(fragment);
    window.setTimeout(this.invalidate.bind(this), 100);
};
ScrollableView.prototype.onAttached = function () {
    window.setTimeout(this.invalidate.bind(this), 100);
};

function logSizing(name, node) {
    console.log(name, {
        scrollWidth: node.scrollWidth,
        clientWidth: node.clientWidth,
        offsetWidth: node.offsetWidth,
        rect: node.getBoundingClientRect()
    })
}
ScrollableView.prototype.invalidate = function () {
    if (this.orient == "vertical") {
        this.invalidateVertical();
    } else {
        this.invalidateHorizontal();
    }
};
ScrollableView.prototype.invalidateHorizontal = function () {
    var contentSize = this.contentWrapper.scrollWidth;

    var size = this.node().clientWidth;
    var borderWidth = Math.round((this.node().offsetWidth - size) / 2);
    var buttonSize = this.previousButton.offsetWidth;

    this.node().style.height = (this.contentWrapper.offsetHeight) + "px";

    if (contentSize <= size) {
        this.offset = 0;
        this.previousButton.style.visibility = "hidden";
        this.nextButton.style.visibility = "hidden";

        this.contentWrapper.style.left = "0px";
    } else {
        this.previousButton.style.visibility = "inherit";
        this.nextButton.style.visibility = "inherit";

        var min = size - contentSize;
        this.offset = Math.min(Math.max(this.offset, min), 0);

        this.previousButton.disabled = (this.offset >= 0);
        this.nextButton.disabled = (this.offset <= min);

        this.contentWrapper.style.left = (this.offset - borderWidth) + "px";
    }

};
ScrollableView.prototype.invalidateVertical = function () {
    var contentSize = this.contentWrapper.scrollHeight;

    var size = this.node().clientHeight;
    var borderHeight = Math.round((this.node().offsetHeight - size) / 2);
    var buttonSize = this.previousButton.offsetHeight;

    this.node().style.width = (this.contentWrapper.offsetWidth) + "px";

    if (contentSize <= size) {
        this.offset = 0;
        this.previousButton.style.visibility = "hidden";
        this.nextButton.style.visibility = "hidden";

        this.contentWrapper.style.left = "0px";
    } else {
        this.previousButton.style.visibility = "inherit";
        this.nextButton.style.visibility = "inherit";

        var min = size - contentSize;
        this.offset = Math.min(Math.max(this.offset, min), 0);

        this.previousButton.disabled = (this.offset >= 0);
        this.nextButton.disabled = (this.offset <= min);

        this.contentWrapper.style.top = (this.offset - borderHeight) + "px";
    }
};
ScrollableView.prototype.moveTo = function (position) {
    this.offset = - position + this.getButtonSize() + this.getBorderSize() + 2 * Util.em();
    this.invalidate();
};
ScrollableView.prototype.getSize = function () {
    return this.orient == "vertical" ? this.node().clientHeight : this.node().clientWidth;
};
ScrollableView.prototype.getButtonSize = function () {
    return this.orient == "vertical" ? this.previousButton.offsetHeight : this.previousButton.offsetWidth;
};
ScrollableView.prototype.getBorderSize = function () {
    return this.orient == "vertical" ? Math.round((this.node().offsetHeight - this.getSize()) / 2) : Math.round((this.node().offsetWidth - this.getSize()) / 2);
};
ScrollableView.prototype.ensuareVisible = function (from, to) {
    var max = Math.abs(this.offset) + this.getSize() - this.getBorderSize() - this.getButtonSize();
    var min = Math.abs(this.offset) + this.getBorderSize() + this.getButtonSize();
    if (min < from && to < max) return;
    this.moveTo(from);
};

if (window) window.__currentScriptPath = null;
